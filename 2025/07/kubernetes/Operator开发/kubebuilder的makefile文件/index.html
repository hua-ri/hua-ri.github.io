<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="google-site-verification" content="TZE0rZyIqLl10trYu3BWBWa1Vmz6HFwhb2OcNEK4u-s" />
     <link rel="shortcut icon" href= /img/favicon.ico >
    <title>
        花日の博客
    </title>
    <meta name="description" content= 嘿，我是花日，这是我的博客。欢迎访问！ >
    <meta name="keywords" content=  >
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>
<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-home
 replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            kubebuilder的makefile文件
        </p>
        <hr>
    </div>
    <div class="post-content">
        <h1 id="1、Makefile简介"><a href="#1、Makefile简介" class="headerlink" title="1、Makefile简介"></a>1、Makefile简介</h1><p>Makefile 是一种用于自动化构建软件项目的文件。它通常用于管理和执行编译、链接、测试等一系列任务，以提高开发效率。</p>
<h2 id="1-1-目标与依赖"><a href="#1-1-目标与依赖" class="headerlink" title="1.1 目标与依赖"></a>1.1 目标与依赖</h2><h3 id="1-1-1目标（Targets）"><a href="#1-1-1目标（Targets）" class="headerlink" title="1.1.1目标（Targets）"></a>1.1.1目标（Targets）</h3><ul>
<li>代表一个任务或一个文件的生成结果。例如，编译生成的可执行文件、库文件等都可以是目标。</li>
<li>常见的目标有 “all”（表示构建整个项目）、“clean”（用于清理生成的文件）等。</li>
</ul>
<h3 id="1-1-2-依赖（Dependencies）"><a href="#1-1-2-依赖（Dependencies）" class="headerlink" title="1.1.2 依赖（Dependencies）"></a>1.1.2 依赖（Dependencies）</h3><ul>
<li>目标所依赖的其他文件或目标。只有当依赖发生变化时，才会重新执行生成目标的命令。</li>
<li>例如，一个可执行文件可能依赖于多个源文件和库文件。</li>
</ul>
<h2 id="1-2-规则与命令"><a href="#1-2-规则与命令" class="headerlink" title="1.2 规则与命令"></a>1.2 规则与命令</h2><h3 id="1-2-1-规则（Rules）"><a href="#1-2-1-规则（Rules）" class="headerlink" title="1.2.1 规则（Rules）"></a>1.2.1 规则（Rules）</h3><ul>
<li>描述了如何从依赖生成目标。通常由目标、依赖和命令三部分组成。</li>
<li>格式一般为：target: dependencies，接着是命令部分，每行命令前面必须以制表符（Tab）开头。</li>
</ul>
<h3 id="1-2-2-命令（Commands）"><a href="#1-2-2-命令（Commands）" class="headerlink" title="1.2.2 命令（Commands）"></a>1.2.2 命令（Commands）</h3><ul>
<li>用于执行生成目标的具体操作。可以是编译器命令、链接器命令、文件复制命令等。</li>
<li>例如，编译 C 语言源文件的命令可能是gcc -o target source.c。</li>
</ul>
<h2 id="1-3-变量与函数"><a href="#1-3-变量与函数" class="headerlink" title="1.3 变量与函数"></a>1.3 变量与函数</h2><h3 id="1-3-1-变量（Variables）"><a href="#1-3-1-变量（Variables）" class="headerlink" title="1.3.1 变量（Variables）"></a>1.3.1 变量（Variables）</h3><ul>
<li>可以定义和使用变量来存储常用的值，如编译器名称、编译选项、源文件列表等。</li>
<li>变量定义方式为VARIABLE &#x3D; value，使用时用$(VARIABLE)。</li>
</ul>
<h3 id="1-3-2-函数（Functions）"><a href="#1-3-2-函数（Functions）" class="headerlink" title="1.3.2 函数（Functions）"></a>1.3.2 函数（Functions）</h3><ul>
<li>Makefile 提供了一些内置函数，可以进行字符串处理、文件操作等。</li>
<li>例如，$(wildcard *.c)可以获取当前目录下所有的 C 语言源文件。</li>
</ul>
<h2 id="1-4-优势"><a href="#1-4-优势" class="headerlink" title="1.4 优势"></a>1.4 优势</h2><h3 id="1-4-1-自动化构建"><a href="#1-4-1-自动化构建" class="headerlink" title="1.4.1 自动化构建"></a>1.4.1 自动化构建</h3><ul>
<li>可以自动执行一系列构建步骤，减少手动操作和错误。</li>
<li>当源文件发生变化时，只重新构建受影响的部分，提高构建效率。</li>
</ul>
<h3 id="1-4-2-可重复性"><a href="#1-4-2-可重复性" class="headerlink" title="1.4.2 可重复性"></a>1.4.2 可重复性</h3><p>确保在不同的环境中都能以相同的方式构建项目。</p>
<h3 id="1-4-3-易于维护"><a href="#1-4-3-易于维护" class="headerlink" title="1.4.3 易于维护"></a>1.4.3 易于维护</h3><p>项目的构建过程集中在一个文件中，便于修改和管理。</p>
<h1 id="2、kubebuilder-makefile"><a href="#2、kubebuilder-makefile" class="headerlink" title="2、kubebuilder makefile"></a>2、kubebuilder makefile</h1><h2 id="2-1-kubebuilder-项目makefile"><a href="#2-1-kubebuilder-项目makefile" class="headerlink" title="2.1 kubebuilder 项目makefile"></a>2.1 kubebuilder 项目makefile</h2><p>一个kubebuilder创建的operator项目的makefile文件内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Image URL to use all building/pushing image targets</span></span><br><span class="line">IMG ?= controller:latest</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ENVTEST_K8S_VERSION refers to the version of kubebuilder assets to be downloaded by envtest binary.</span></span><br><span class="line">ENVTEST_K8S_VERSION = 1.31.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Get the currently used golang install path (<span class="keyword">in</span> GOPATH/bin, unless GOBIN is <span class="built_in">set</span>)</span></span><br><span class="line">ifeq (,$(shell go env GOBIN))</span><br><span class="line">GOBIN=$(shell go env GOPATH)/bin</span><br><span class="line">else</span><br><span class="line">GOBIN=$(shell go env GOBIN)</span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CONTAINER_TOOL defines the container tool to be used <span class="keyword">for</span> building images.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Be aware that the target commands are only tested with Docker <span class="built_in">which</span> is</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">scaffolded by default. However, you might want to replace it to use other</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tools. (i.e. podman)</span></span><br><span class="line">CONTAINER_TOOL ?= docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Setting SHELL to bash allows bash commands to be executed by recipes.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Options are <span class="built_in">set</span> to <span class="built_in">exit</span> when a recipe line exits non-zero or a piped <span class="built_in">command</span> fails.</span></span><br><span class="line">SHELL = /usr/bin/env bash -o pipefail</span><br><span class="line">.SHELLFLAGS = -ec</span><br><span class="line"></span><br><span class="line">.PHONY: all</span><br><span class="line">all: build</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#@ General</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The <span class="built_in">help</span> target prints out all targets with their descriptions organized</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">beneath their categories. The categories are represented by <span class="string">&#x27;##@&#x27;</span> and the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">target descriptions by <span class="string">&#x27;##&#x27;</span>. The awk <span class="built_in">command</span> is responsible <span class="keyword">for</span> reading the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">entire <span class="built_in">set</span> of makefiles included <span class="keyword">in</span> this invocation, looking <span class="keyword">for</span> lines of the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">file as xyz: <span class="comment">## something, and then pretty-format the target and help. Then,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">if</span> there<span class="string">&#x27;s a line with ##@ something, that gets pretty-printed as a category.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">More info on the usage of ANSI control characters for terminal formatting:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">https://en.wikipedia.org/wiki/ANSI_escape_code#SGR_parameters</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">More info on the awk command:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">http://linuxcommand.org/lc3_adv_awk.php</span></span></span><br><span class="line"></span><br><span class="line">.PHONY: help</span><br><span class="line">help: ## Display this help.</span><br><span class="line">        @awk &#x27;BEGIN &#123;FS = &quot;:.*##&quot;; printf &quot;\nUsage:\n  make \033[36m&lt;target&gt;\033[0m\n&quot;&#125; /^[a-zA-Z_0-9-]+:.*?##/ &#123; printf &quot;  \033[36m%-15s\033[0m %s\n&quot;, $$1, $$2 &#125; /^##@/ &#123; printf &quot;\n\033[1m%s\033[0m\n&quot;, substr($$0, 5) &#125; &#x27; $(MAKEFILE_LIST)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">#@ Development</span></span></span><br><span class="line"></span><br><span class="line">.PHONY: manifests</span><br><span class="line">manifests: controller-gen ## Generate WebhookConfiguration, ClusterRole and CustomResourceDefinition objects.</span><br><span class="line">        $(CONTROLLER_GEN) rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br><span class="line"></span><br><span class="line">.PHONY: generate</span><br><span class="line">generate: controller-gen ## Generate code containing DeepCopy, DeepCopyInto, and DeepCopyObject method implementations.</span><br><span class="line">        $(CONTROLLER_GEN) object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;</span><br><span class="line"></span><br><span class="line">.PHONY: fmt</span><br><span class="line">fmt: ## Run go fmt against code.</span><br><span class="line">        go fmt ./...</span><br><span class="line"></span><br><span class="line">.PHONY: vet</span><br><span class="line">vet: ## Run go vet against code.</span><br><span class="line">        go vet ./...</span><br><span class="line"></span><br><span class="line">.PHONY: test</span><br><span class="line">test: manifests generate fmt vet envtest ## Run tests.</span><br><span class="line">        KUBEBUILDER_ASSETS=&quot;$(shell $(ENVTEST) use $(ENVTEST_K8S_VERSION) --bin-dir $(LOCALBIN) -p path)&quot; go test $$(go list ./... | grep -v /e2e) -coverprofile cover.out</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Utilize Kind or modify the e2e tests to load the image locally, enabling compatibility with other vendors.</span></span></span><br><span class="line">.PHONY: test-e2e  # Run the e2e tests against a Kind k8s instance that is spun up.</span><br><span class="line">test-e2e:</span><br><span class="line">        go test ./test/e2e/ -v -ginkgo.v</span><br><span class="line"></span><br><span class="line">.PHONY: lint</span><br><span class="line">lint: golangci-lint ## Run golangci-lint linter</span><br><span class="line">        $(GOLANGCI_LINT) run</span><br><span class="line"></span><br><span class="line">.PHONY: lint-fix</span><br><span class="line">lint-fix: golangci-lint ## Run golangci-lint linter and perform fixes</span><br><span class="line">        $(GOLANGCI_LINT) run --fix</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">#@ Build</span></span></span><br><span class="line"></span><br><span class="line">.PHONY: build</span><br><span class="line">build: manifests generate fmt vet ## Build manager binary.</span><br><span class="line">        go build -o bin/manager cmd/main.go</span><br><span class="line"></span><br><span class="line">.PHONY: run</span><br><span class="line">run: manifests generate fmt vet ## Run a controller from your host.</span><br><span class="line">        go run ./cmd/main.go</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">If you wish to build the manager image targeting other platforms you can use the --platform flag.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">(i.e. docker build --platform linux/arm64). However, you must enable docker buildKit for it.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">More info: https://docs.docker.com/develop/develop-images/build_enhancements/</span></span></span><br><span class="line">.PHONY: docker-build</span><br><span class="line">docker-build: ## Build docker image with the manager.</span><br><span class="line">        $(CONTAINER_TOOL) build -t $&#123;IMG&#125; .</span><br><span class="line"></span><br><span class="line">.PHONY: docker-push</span><br><span class="line">docker-push: ## Push docker image with the manager.</span><br><span class="line">        $(CONTAINER_TOOL) push $&#123;IMG&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">PLATFORMS defines the target platforms for the manager image be built to provide support to multiple</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">architectures. (i.e. make docker-buildx IMG=myregistry/mypoperator:0.0.1). To use this option you need to:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">- be able to use docker buildx. More info: https://docs.docker.com/build/buildx/</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">- have enabled BuildKit. More info: https://docs.docker.com/develop/develop-images/build_enhancements/</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">- be able to push the image to your registry (i.e. if you do not set a valid value via IMG=&lt;myregistry/image:&lt;tag&gt;&gt; then the export will fail)</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">To adequately provide solutions that are compatible with multiple platforms, you should consider using this option.</span></span></span><br><span class="line">PLATFORMS ?= linux/arm64,linux/amd64,linux/s390x,linux/ppc64le</span><br><span class="line">.PHONY: docker-buildx</span><br><span class="line">docker-buildx: ## Build and push docker image for the manager for cross-platform support</span><br><span class="line">        # copy existing Dockerfile and insert --platform=$&#123;BUILDPLATFORM&#125; into Dockerfile.cross, and preserve the original Dockerfile</span><br><span class="line">        sed -e &#x27;1 s/\(^FROM\)/FROM --platform=\$$\&#123;BUILDPLATFORM\&#125;/; t&#x27; -e &#x27; 1,// s//FROM --platform=\$$\&#123;BUILDPLATFORM\&#125;/&#x27; Dockerfile &gt; Dockerfile.cross</span><br><span class="line">        - $(CONTAINER_TOOL) buildx create --name myapp-operator-builder</span><br><span class="line">        $(CONTAINER_TOOL) buildx use myapp-operator-builder</span><br><span class="line">        - $(CONTAINER_TOOL) buildx build --push --platform=$(PLATFORMS) --tag $&#123;IMG&#125; -f Dockerfile.cross .</span><br><span class="line">        - $(CONTAINER_TOOL) buildx rm myapp-operator-builder</span><br><span class="line">        rm Dockerfile.cross</span><br><span class="line"></span><br><span class="line">.PHONY: build-installer</span><br><span class="line">build-installer: manifests generate kustomize ## Generate a consolidated YAML with CRDs and deployment.</span><br><span class="line">        mkdir -p dist</span><br><span class="line">        cd config/manager &amp;&amp; $(KUSTOMIZE) edit set image controller=$&#123;IMG&#125;</span><br><span class="line">        $(KUSTOMIZE) build config/default &gt; dist/install.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">#@ Deployment</span></span></span><br><span class="line"></span><br><span class="line">ifndef ignore-not-found</span><br><span class="line">  ignore-not-found = false</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">.PHONY: install</span><br><span class="line">install: manifests kustomize ## Install CRDs into the K8s cluster specified in ~/.kube/config.</span><br><span class="line">        $(KUSTOMIZE) build config/crd | $(KUBECTL) apply -f -</span><br><span class="line"></span><br><span class="line">.PHONY: uninstall</span><br><span class="line">uninstall: manifests kustomize ## Uninstall CRDs from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.</span><br><span class="line">        $(KUSTOMIZE) build config/crd | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -</span><br><span class="line"></span><br><span class="line">.PHONY: deploy</span><br><span class="line">deploy: manifests kustomize ## Deploy controller to the K8s cluster specified in ~/.kube/config.</span><br><span class="line">        cd config/manager &amp;&amp; $(KUSTOMIZE) edit set image controller=$&#123;IMG&#125;</span><br><span class="line">        $(KUSTOMIZE) build config/default | $(KUBECTL) apply -f -</span><br><span class="line"></span><br><span class="line">.PHONY: undeploy</span><br><span class="line">undeploy: kustomize ## Undeploy controller from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.</span><br><span class="line">        $(KUSTOMIZE) build config/default | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">#@ Dependencies</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"># Location to install dependencies to</span></span></span><br><span class="line">LOCALBIN ?= $(shell pwd)/bin</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">(LOCALBIN):</span></span></span><br><span class="line">        mkdir -p $(LOCALBIN)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"># Tool Binaries</span></span></span><br><span class="line">KUBECTL ?= kubectl</span><br><span class="line">KUSTOMIZE ?= $(LOCALBIN)/kustomize</span><br><span class="line">CONTROLLER_GEN ?= $(LOCALBIN)/controller-gen</span><br><span class="line">ENVTEST ?= $(LOCALBIN)/setup-envtest</span><br><span class="line">GOLANGCI_LINT = $(LOCALBIN)/golangci-lint</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"># Tool Versions</span></span></span><br><span class="line">KUSTOMIZE_VERSION ?= v5.4.3</span><br><span class="line">CONTROLLER_TOOLS_VERSION ?= v0.16.1</span><br><span class="line">ENVTEST_VERSION ?= release-0.19</span><br><span class="line">GOLANGCI_LINT_VERSION ?= v1.59.1</span><br><span class="line"></span><br><span class="line">.PHONY: kustomize</span><br><span class="line">kustomize: $(KUSTOMIZE) ## Download kustomize locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">(KUSTOMIZE): $(LOCALBIN)</span></span></span><br><span class="line">        $(call go-install-tool,$(KUSTOMIZE),sigs.k8s.io/kustomize/kustomize/v5,$(KUSTOMIZE_VERSION))</span><br><span class="line"></span><br><span class="line">.PHONY: controller-gen</span><br><span class="line">controller-gen: $(CONTROLLER_GEN) ## Download controller-gen locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">(CONTROLLER_GEN): $(LOCALBIN)</span></span></span><br><span class="line">        $(call go-install-tool,$(CONTROLLER_GEN),sigs.k8s.io/controller-tools/cmd/controller-gen,$(CONTROLLER_TOOLS_VERSION))</span><br><span class="line"></span><br><span class="line">.PHONY: envtest</span><br><span class="line">envtest: $(ENVTEST) ## Download setup-envtest locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">(ENVTEST): $(LOCALBIN)</span></span></span><br><span class="line">        $(call go-install-tool,$(ENVTEST),sigs.k8s.io/controller-runtime/tools/setup-envtest,$(ENVTEST_VERSION))</span><br><span class="line"></span><br><span class="line">.PHONY: golangci-lint</span><br><span class="line">golangci-lint: $(GOLANGCI_LINT) ## Download golangci-lint locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">(GOLANGCI_LINT): $(LOCALBIN)</span></span></span><br><span class="line">        $(call go-install-tool,$(GOLANGCI_LINT),github.com/golangci/golangci-lint/cmd/golangci-lint,$(GOLANGCI_LINT_VERSION))</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">go-install-tool will &#x27;</span>go install<span class="string">&#x27; any package with custom target and name of binary, if it doesn&#x27;</span>t exist</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$1</span> - target path with name of binary</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$2</span> - package url <span class="built_in">which</span> can be installed</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$3</span> - specific version of package</span></span><br><span class="line">define go-install-tool</span><br><span class="line">@[ -f &quot;$(1)-$(3)&quot; ] || &#123; \</span><br><span class="line">set -e; \</span><br><span class="line">package=$(2)@$(3) ;\</span><br><span class="line">echo &quot;Downloading $$&#123;package&#125;&quot; ;\</span><br><span class="line">rm -f $(1) || true ;\</span><br><span class="line">GOBIN=$(LOCALBIN) go install $$&#123;package&#125; ;\</span><br><span class="line">mv $(1) $(1)-$(3) ;\</span><br><span class="line">&#125; ;\</span><br><span class="line">ln -sf $(1)-$(3) $(1)</span><br><span class="line">endef</span><br></pre></td></tr></table></figure>

<h2 id="2-2-变量定义部分"><a href="#2-2-变量定义部分" class="headerlink" title="2.2 变量定义部分"></a>2.2 变量定义部分</h2><h3 id="2-2-1-IMG（定义构建和推送Docker镜像的目标镜像URL）"><a href="#2-2-1-IMG（定义构建和推送Docker镜像的目标镜像URL）" class="headerlink" title="2.2.1 IMG（定义构建和推送Docker镜像的目标镜像URL）"></a>2.2.1 IMG（定义构建和推送Docker镜像的目标镜像URL）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Image URL to use all building/pushing image targets</span></span><br><span class="line">IMG ?= controller:latest</span><br></pre></td></tr></table></figure>
<p>作用：定义构建和推送Docker镜像的目标镜像URL<br>解释：如果没有在命令中指定IMG，则默认值为controller:latest</p>
<h3 id="2-2-2-ENVTEST-K8S-VERSION（定义envtest工具下载的Kubernetes资产版本）"><a href="#2-2-2-ENVTEST-K8S-VERSION（定义envtest工具下载的Kubernetes资产版本）" class="headerlink" title="2.2.2 ENVTEST_K8S_VERSION（定义envtest工具下载的Kubernetes资产版本）"></a>2.2.2 ENVTEST_K8S_VERSION（定义envtest工具下载的Kubernetes资产版本）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ENVTEST_K8S_VERSION refers to the version of kubebuilder assets to be downloaded by envtest binary.</span></span><br><span class="line">ENVTEST_K8S_VERSION = 1.31.0</span><br></pre></td></tr></table></figure>
<p>作用：定义envtest工具下载的Kubernetes资产版本<br>解释：envtest是一个用于测试的工具，这个变量制定了要下载的Kubernetes版本。</p>
<h3 id="2-2-3-GOBIN（当前使用的Go的安装路径）"><a href="#2-2-3-GOBIN（当前使用的Go的安装路径）" class="headerlink" title="2.2.3 GOBIN（当前使用的Go的安装路径）"></a>2.2.3 GOBIN（当前使用的Go的安装路径）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Get the currently used golang install path (<span class="keyword">in</span> GOPATH/bin, unless GOBIN is <span class="built_in">set</span>)</span></span><br><span class="line">ifeq (,$(shell go env GOBIN))</span><br><span class="line">GOBIN=$(shell go env GOPATH)/bin</span><br><span class="line">else</span><br><span class="line">GOBIN=$(shell go env GOBIN)</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>

<p>作用：获取当前使用的Go的安装路径<br>解释：如果GONBIN环境变量未设置，则使用GOPATCH&#x2F;bin作为默认路径；否则使用GOBIN的值。</p>
<h3 id="2-2-4-CONTAINER-TOOL（用于构建镜像的容器工具）"><a href="#2-2-4-CONTAINER-TOOL（用于构建镜像的容器工具）" class="headerlink" title="2.2.4 CONTAINER_TOOL（用于构建镜像的容器工具）"></a>2.2.4 CONTAINER_TOOL（用于构建镜像的容器工具）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CONTAINER_TOOL defines the container tool to be used <span class="keyword">for</span> building images.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Be aware that the target commands are only tested with Docker <span class="built_in">which</span> is</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">scaffolded by default. However, you might want to replace it to use other</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tools. (i.e. podman)</span></span><br><span class="line">CONTAINER_TOOL ?= docker</span><br></pre></td></tr></table></figure>

<p>作用：定义用于构建镜像的容器工具<br>解释：默认值为docker，但是可以替换为其他工具，例如podman</p>
<h3 id="2-2-5-SHELL-和-SHELLFLAGS（设置Makefile使用的shell和shell选项）"><a href="#2-2-5-SHELL-和-SHELLFLAGS（设置Makefile使用的shell和shell选项）" class="headerlink" title="2.2.5 SHELL 和 .SHELLFLAGS（设置Makefile使用的shell和shell选项）"></a>2.2.5 SHELL 和 .SHELLFLAGS（设置Makefile使用的shell和shell选项）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Setting SHELL to bash allows bash commands to be executed by recipes.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Options are <span class="built_in">set</span> to <span class="built_in">exit</span> when a recipe line exits non-zero or a piped <span class="built_in">command</span> fails.</span></span><br><span class="line">SHELL = /usr/bin/env bash -o pipefail</span><br><span class="line">.SHELLFLAGS = -ec</span><br></pre></td></tr></table></figure>

<p>作用：设置Makefile使用的shell和shell选项<br>解释：</p>
<ul>
<li>SHELL设置为&#x2F;usr&#x2F;bin&#x2F;env bash -o pipefail</li>
<li>.SHELLFLAGS 设置为-ec，表示shell应该立即退出并在任何命令失败时报告错误</li>
</ul>
<h2 id="2-3-目标定义部分"><a href="#2-3-目标定义部分" class="headerlink" title="2.3 目标定义部分"></a>2.3 目标定义部分</h2><h3 id="2-3-1-通用目标"><a href="#2-3-1-通用目标" class="headerlink" title="2.3.1 通用目标"></a>2.3.1 通用目标</h3><h4 id="2-3-1-1-all（定义默认目标，调用build目标）"><a href="#2-3-1-1-all（定义默认目标，调用build目标）" class="headerlink" title="2.3.1.1 all（定义默认目标，调用build目标）"></a>2.3.1.1 all（定义默认目标，调用build目标）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: all</span><br><span class="line">all: build</span><br></pre></td></tr></table></figure>
<p>作用：定义默认目标，调用build目标<br>解释：当运行make时，如果没有指定目标。默认会执行build目标。</p>
<h4 id="2-3-1-2-help（显示帮助信息）"><a href="#2-3-1-2-help（显示帮助信息）" class="headerlink" title="2.3.1.2 help（显示帮助信息）"></a>2.3.1.2 help（显示帮助信息）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: help</span><br><span class="line">help: ## Display this help.</span><br><span class="line">        @awk &#x27;BEGIN &#123;FS = &quot;:.*##&quot;; printf &quot;\nUsage:\n  make \033[36m&lt;target&gt;\033[0m\n&quot;&#125; /^[a-zA-Z_0-9-]+:.*?##/ &#123; printf &quot;  \033[36m%-15s\033[0m %s\n&quot;, $$1, $$2 &#125; /^##@/ &#123; printf &quot;\n\033[1m%s\033[0m\n&quot;, substr($$0, 5) &#125; &#x27; $(MAKEFILE_LIST)</span><br></pre></td></tr></table></figure>
<p>作用：显示帮助信息<br>解释：使用awk命令解析Makefile,提取每个目标的描述，并按类别组织显示。##@表示类别，##表示目标描述</p>
<h3 id="2-3-2-开发目标"><a href="#2-3-2-开发目标" class="headerlink" title="2.3.2 开发目标"></a>2.3.2 开发目标</h3><h4 id="2-3-2-1-manifests（生成WebhookConfiguration、ClusterRole和CustomResourceDefinition-对象）"><a href="#2-3-2-1-manifests（生成WebhookConfiguration、ClusterRole和CustomResourceDefinition-对象）" class="headerlink" title="2.3.2.1 manifests（生成WebhookConfiguration、ClusterRole和CustomResourceDefinition 对象）"></a>2.3.2.1 manifests（生成WebhookConfiguration、ClusterRole和CustomResourceDefinition 对象）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: manifests</span><br><span class="line">manifests: controller-gen ## Generate WebhookConfiguration, ClusterRole and CustomResourceDefinition objects.</span><br><span class="line">        $(CONTROLLER_GEN) rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br></pre></td></tr></table></figure>
<p>作用：生成WebhookConfiguration、ClusterRole和CustomResourceDefinition 对象<br>解释：使用controller-gen工具生成必要的Kubernetes资源文件，并保存到config&#x2F;crd&#x2F;bases目录</p>
<h4 id="2-3-2-2-generate（生成包含DeepCopy、DeepCopyInto-和DeepCopyObject方法实现的代码。）"><a href="#2-3-2-2-generate（生成包含DeepCopy、DeepCopyInto-和DeepCopyObject方法实现的代码。）" class="headerlink" title="2.3.2.2 generate（生成包含DeepCopy、DeepCopyInto, 和DeepCopyObject方法实现的代码。）"></a>2.3.2.2 generate（生成包含DeepCopy、DeepCopyInto, 和DeepCopyObject方法实现的代码。）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: generate</span><br><span class="line">generate: controller-gen ## Generate code containing DeepCopy, DeepCopyInto, and DeepCopyObject method implementations.</span><br><span class="line">        $(CONTROLLER_GEN) object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;</span><br></pre></td></tr></table></figure>
<p>作用：生成包含DeepCopy、DeepCopyInto, 和DeepCopyObject方法实现的代码。<br>解释：使用controller-gen工具生成GO代码，这些代码自动生成对象的深拷贝方法。</p>
<h4 id="2-3-2-3-fmt（格式化代码）"><a href="#2-3-2-3-fmt（格式化代码）" class="headerlink" title="2.3.2.3 fmt（格式化代码）"></a>2.3.2.3 fmt（格式化代码）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: fmt</span><br><span class="line">fmt: ## Run go fmt against code.</span><br><span class="line">        go fmt ./...</span><br></pre></td></tr></table></figure>
<p>作用：格式化代码<br>解释：使用go fmt命令格式化项目中的所有Go代码</p>
<h4 id="2-3-2-4-vet（检查代码中的潜在问题）"><a href="#2-3-2-4-vet（检查代码中的潜在问题）" class="headerlink" title="2.3.2.4 vet（检查代码中的潜在问题）"></a>2.3.2.4 vet（检查代码中的潜在问题）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: vet</span><br><span class="line">vet: ## Run go vet against code.</span><br><span class="line">        go vet ./...</span><br></pre></td></tr></table></figure>
<p>作用：检查代码中的潜在问题<br>解释：使用go vet命令检查项目中的所有Go代码，查找可能的问题。</p>
<h4 id="2-3-2-5-test（运行测试）"><a href="#2-3-2-5-test（运行测试）" class="headerlink" title="2.3.2.5 test（运行测试）"></a>2.3.2.5 test（运行测试）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: test</span><br><span class="line">test: manifests generate fmt vet envtest ## Run tests.</span><br><span class="line">        KUBEBUILDER_ASSETS=&quot;$(shell $(ENVTEST) use $(ENVTEST_K8S_VERSION) --bin-dir $(LOCALBIN) -p path)&quot; go test $$(go list ./... | grep -v /e2e) -coverprofile cover.out</span><br></pre></td></tr></table></figure>
<p>作用：运行测试<br>解释：</p>
<ul>
<li>先运行manifests、generate、fmt和vet目标</li>
<li>使用envtest工具设置环境变量KUBEBUILDER_ASSETS，然后运行项目中的所有测试(排除e2e测试)</li>
</ul>
<h4 id="2-3-2-6-test-e2e（运行端到端测试）"><a href="#2-3-2-6-test-e2e（运行端到端测试）" class="headerlink" title="2.3.2.6 test-e2e（运行端到端测试）"></a>2.3.2.6 test-e2e（运行端到端测试）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Utilize Kind or modify the e2e tests to load the image locally, enabling compatibility with other vendors.</span></span><br><span class="line">.PHONY: test-e2e  # Run the e2e tests against a Kind k8s instance that is spun up.</span><br><span class="line">test-e2e:</span><br><span class="line">        go test ./test/e2e/ -v -ginkgo.v</span><br></pre></td></tr></table></figure>
<p>作用：运行端到端测试<br>解释：使用go test命令运行test&#x2F;e2e目录中的端到端测试，并启动详细输出。</p>
<h4 id="2-3-2-7-lint（运行代码风格检查）"><a href="#2-3-2-7-lint（运行代码风格检查）" class="headerlink" title="2.3.2.7 lint（运行代码风格检查）"></a>2.3.2.7 lint（运行代码风格检查）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: lint</span><br><span class="line">lint: golangci-lint ## Run golangci-lint linter</span><br><span class="line">        $(GOLANGCI_LINT) run</span><br></pre></td></tr></table></figure>
<p>作用：运行代码风格检查<br>解释：使用golangci-lint工具运行代码风格检查</p>
<h4 id="2-3-2-8-lint-fix-（运行代码风格检查并自动修复问题）"><a href="#2-3-2-8-lint-fix-（运行代码风格检查并自动修复问题）" class="headerlink" title="2.3.2.8 lint-fix （运行代码风格检查并自动修复问题）"></a>2.3.2.8 lint-fix （运行代码风格检查并自动修复问题）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: lint-fix</span><br><span class="line">lint-fix: golangci-lint ## Run golangci-lint linter and perform fixes</span><br><span class="line">        $(GOLANGCI_LINT) run --fix</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>作用：运行代码风格检查并自动修复问题<br>解释：使用golangci-lint工具运行代码风格检查，并使用–fix选项自动修复发现的问题。</p>
<h3 id="2-3-3-构建目标"><a href="#2-3-3-构建目标" class="headerlink" title="2.3.3 构建目标"></a>2.3.3 构建目标</h3><h4 id="2-3-3-1-build（构建controller的二进制文件）"><a href="#2-3-3-1-build（构建controller的二进制文件）" class="headerlink" title="2.3.3.1 build（构建controller的二进制文件）"></a>2.3.3.1 build（构建controller的二进制文件）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: build</span><br><span class="line">build: manifests generate fmt vet ## Build manager binary.</span><br><span class="line">        go build -o bin/manager cmd/main.go</span><br></pre></td></tr></table></figure>
<p>作用：构建controller的二进制文件<br>解释：</p>
<ul>
<li>先运行manifests、generate、fmt和vet目标</li>
<li>使用go build命令编译cmd&#x2F;main.go文件，并将生成的二进制文件保存到bin&#x2F;manager。</li>
</ul>
<h4 id="2-3-3-2-run（在主机上运行controller）"><a href="#2-3-3-2-run（在主机上运行controller）" class="headerlink" title="2.3.3.2 run（在主机上运行controller）"></a>2.3.3.2 run（在主机上运行controller）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: run</span><br><span class="line">run: manifests generate fmt vet ## Run a controller from your host.</span><br><span class="line">        go run ./cmd/main.go</span><br></pre></td></tr></table></figure>
<p>作用：在主机上运行controller<br>解释：</p>
<ul>
<li>先运行manifests、generate、fmt和vet目标</li>
<li>使用go run命令运行cmd&#x2F;main.go文件</li>
</ul>
<h4 id="2-3-3-3-docker-build（构建Docker镜像）"><a href="#2-3-3-3-docker-build（构建Docker镜像）" class="headerlink" title="2.3.3.3 docker-build（构建Docker镜像）"></a>2.3.3.3 docker-build（构建Docker镜像）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">If you wish to build the manager image targeting other platforms you can use the --platform flag.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(i.e. docker build --platform linux/arm64). However, you must <span class="built_in">enable</span> docker buildKit <span class="keyword">for</span> it.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">More info: https://docs.docker.com/develop/develop-images/build_enhancements/</span></span><br><span class="line">.PHONY: docker-build</span><br><span class="line">docker-build: ## Build docker image with the manager.</span><br><span class="line">        $(CONTAINER_TOOL) build -t $&#123;IMG&#125; .</span><br></pre></td></tr></table></figure>
<p>作用：构建Docker镜像<br>解释：使用CONTAINER_TOOL(默认为docker)构建docker镜像，并使用IMG变量指定镜像名称和标签</p>
<h4 id="2-3-3-4-docker-push（推送Docker镜像）"><a href="#2-3-3-4-docker-push（推送Docker镜像）" class="headerlink" title="2.3.3.4 docker-push（推送Docker镜像）"></a>2.3.3.4 docker-push（推送Docker镜像）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: docker-push</span><br><span class="line">docker-push: ## Push docker image with the manager.</span><br><span class="line">        $(CONTAINER_TOOL) push $&#123;IMG&#125;</span><br></pre></td></tr></table></figure>
<p>作用：推送Docker镜像<br>解释：使用CONTAINER_TOOL(默认为docker)推送构建好的Docker镜像到指定的仓库</p>
<h4 id="2-3-3-5-docker-buildx（构建并推送多平台支持的Docker镜像）"><a href="#2-3-3-5-docker-buildx（构建并推送多平台支持的Docker镜像）" class="headerlink" title="2.3.3.5 docker-buildx（构建并推送多平台支持的Docker镜像）"></a>2.3.3.5 docker-buildx（构建并推送多平台支持的Docker镜像）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">PLATFORMS defines the target platforms <span class="keyword">for</span> the manager image be built to provide support to multiple</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">architectures. (i.e. make docker-buildx IMG=myregistry/mypoperator:0.0.1). To use this option you need to:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- be able to use docker buildx. More info: https://docs.docker.com/build/buildx/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- have enabled BuildKit. More info: https://docs.docker.com/develop/develop-images/build_enhancements/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- be able to push the image to your registry (i.e. <span class="keyword">if</span> you <span class="keyword">do</span> not <span class="built_in">set</span> a valid value via IMG=&lt;myregistry/image:&lt;tag&gt;&gt; <span class="keyword">then</span> the <span class="built_in">export</span> will fail)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">To adequately provide solutions that are compatible with multiple platforms, you should consider using this option.</span></span><br><span class="line">PLATFORMS ?= linux/arm64,linux/amd64,linux/s390x,linux/ppc64le</span><br><span class="line">.PHONY: docker-buildx</span><br><span class="line">docker-buildx: ## Build and push docker image for the manager for cross-platform support</span><br><span class="line">        # copy existing Dockerfile and insert --platform=$&#123;BUILDPLATFORM&#125; into Dockerfile.cross, and preserve the original Dockerfile</span><br><span class="line">        sed -e &#x27;1 s/\(^FROM\)/FROM --platform=\$$\&#123;BUILDPLATFORM\&#125;/; t&#x27; -e &#x27; 1,// s//FROM --platform=\$$\&#123;BUILDPLATFORM\&#125;/&#x27; Dockerfile &gt; Dockerfile.cross</span><br><span class="line">        - $(CONTAINER_TOOL) buildx create --name myapp-operator-builder</span><br><span class="line">        $(CONTAINER_TOOL) buildx use myapp-operator-builder</span><br><span class="line">        - $(CONTAINER_TOOL) buildx build --push --platform=$(PLATFORMS) --tag $&#123;IMG&#125; -f Dockerfile.cross .</span><br><span class="line">        - $(CONTAINER_TOOL) buildx rm myapp-operator-builder</span><br><span class="line">        rm Dockerfile.cross</span><br></pre></td></tr></table></figure>

<p>作用：构建并推送多平台支持的Docker镜像<br>解释：</p>
<ul>
<li>使用sed命令复制现有的Dockerfile并插入–platform&#x3D;${BUILDPLATFORM}选项,生成Dockerfile.cross</li>
<li>创建一个名为myapp-builder的构建器</li>
<li>使用buildx构建并推送多平台镜像</li>
<li>删除构建器和临时生成的Dockerfile.cross</li>
</ul>
<h4 id="2-3-3-6-docker-installer（生成包含CRDs和部署的合并YAML文件）"><a href="#2-3-3-6-docker-installer（生成包含CRDs和部署的合并YAML文件）" class="headerlink" title="2.3.3.6 docker-installer（生成包含CRDs和部署的合并YAML文件）"></a>2.3.3.6 docker-installer（生成包含CRDs和部署的合并YAML文件）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: build-installer</span><br><span class="line">build-installer: manifests generate kustomize ## Generate a consolidated YAML with CRDs and deployment.</span><br><span class="line">        mkdir -p dist</span><br><span class="line">        cd config/manager &amp;&amp; $(KUSTOMIZE) edit set image controller=$&#123;IMG&#125;</span><br><span class="line">        $(KUSTOMIZE) build config/default &gt; dist/install.yaml</span><br></pre></td></tr></table></figure>
<p>作用：生成包含CRDs和部署的合并YAML文件<br>解释：</p>
<ul>
<li>创建dist目录</li>
<li>使用kustomize工具设置controller镜像为IMG</li>
<li>使用kustomize构建config&#x2F;default目录中的资源，并保存到dist&#x2F;install.yaml</li>
</ul>
<h3 id="2-3-4-部署目标"><a href="#2-3-4-部署目标" class="headerlink" title="2.3.4 部署目标"></a>2.3.4 部署目标</h3><h4 id="2-3-4-1-install（安装CRDs到Kubernetes集群）"><a href="#2-3-4-1-install（安装CRDs到Kubernetes集群）" class="headerlink" title="2.3.4.1 install（安装CRDs到Kubernetes集群）"></a>2.3.4.1 install（安装CRDs到Kubernetes集群）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: install</span><br><span class="line">install: manifests kustomize ## Install CRDs into the K8s cluster specified in ~/.kube/config.</span><br><span class="line">        $(KUSTOMIZE) build config/crd | $(KUBECTL) apply -f -</span><br></pre></td></tr></table></figure>
<p>作用：安装CRDs到Kubernetes集群<br>解释：</p>
<ul>
<li>先运行manifests和kustomize目标</li>
<li>使用kustomize 构建config&#x2F;crd目录中的资源，并使用kubectl将其应用到集群。</li>
</ul>
<h4 id="2-3-4-2-uninstall（从Kubernetes集群卸载CRDs）"><a href="#2-3-4-2-uninstall（从Kubernetes集群卸载CRDs）" class="headerlink" title="2.3.4.2 uninstall（从Kubernetes集群卸载CRDs）"></a>2.3.4.2 uninstall（从Kubernetes集群卸载CRDs）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: uninstall</span><br><span class="line">uninstall: manifests kustomize ## Uninstall CRDs from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.</span><br><span class="line">        $(KUSTOMIZE) build config/crd | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -</span><br></pre></td></tr></table></figure>

<p>作用：从Kubernetes集群卸载CRDs<br>解释：</p>
<ul>
<li>先运行manifests和kustomize目标</li>
<li>使用kustomize 构建config&#x2F;crd目录中的资源，并使用kubectl将其从集群中删除，可以通过ignore-not-found&#x3D;true忽略资源未找到的错误</li>
</ul>
<h4 id="2-3-4-3-deploy（部署controller到Kubernetes集群）"><a href="#2-3-4-3-deploy（部署controller到Kubernetes集群）" class="headerlink" title="2.3.4.3 deploy（部署controller到Kubernetes集群）"></a>2.3.4.3 deploy（部署controller到Kubernetes集群）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: deploy</span><br><span class="line">deploy: manifests kustomize ## Deploy controller to the K8s cluster specified in ~/.kube/config.</span><br><span class="line">        cd config/manager &amp;&amp; $(KUSTOMIZE) edit set image controller=$&#123;IMG&#125;</span><br><span class="line">        $(KUSTOMIZE) build config/default | $(KUBECTL) apply -f -</span><br></pre></td></tr></table></figure>
<p>作用：部署controller到Kubernetes集群<br>解释：</p>
<ul>
<li>先运行manifests和kustomize目标</li>
<li>使用kustomize设置controller镜像为IMG</li>
<li>使用kustomize构建config&#x2F;default目录中的资源，并使用kubectl将其应用到集群</li>
</ul>
<h4 id="2-3-4-4-undeploy（从Kubernetes集群中卸载Controller）"><a href="#2-3-4-4-undeploy（从Kubernetes集群中卸载Controller）" class="headerlink" title="2.3.4.4 undeploy（从Kubernetes集群中卸载Controller）"></a>2.3.4.4 undeploy（从Kubernetes集群中卸载Controller）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: undeploy</span><br><span class="line">undeploy: kustomize ## Undeploy controller from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.</span><br><span class="line">        $(KUSTOMIZE) build config/default | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -</span><br></pre></td></tr></table></figure>
<p>作用：从Kubernetes集群中卸载Controller<br>解释：使用kustomize 构建config&#x2F;default目录中的资源，并使用kubectl将其从集群中删除。可以通过ignore-not-found&#x3D;true忽略资源未找到的错误</p>
<h3 id="2-3-5-依赖目标"><a href="#2-3-5-依赖目标" class="headerlink" title="2.3.5 依赖目标"></a>2.3.5 依赖目标</h3><h4 id="2-3-5-1-ignore-not-found（定义ignore-not-found变量，默认值为false）"><a href="#2-3-5-1-ignore-not-found（定义ignore-not-found变量，默认值为false）" class="headerlink" title="2.3.5.1 ignore-not-found（定义ignore-not-found变量，默认值为false）"></a>2.3.5.1 ignore-not-found（定义ignore-not-found变量，默认值为false）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ifndef ignore-not-found</span><br><span class="line">  ignore-not-found = false</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
<p>作用：定义ignore-not-found变量，默认值为false<br>解释：如果命令行中未指定ignore-not-found，则默认值为false</p>
<h4 id="2-3-5-2-LOCALBIN（定义本地二进制文件的安装目录）"><a href="#2-3-5-2-LOCALBIN（定义本地二进制文件的安装目录）" class="headerlink" title="2.3.5.2 LOCALBIN（定义本地二进制文件的安装目录）"></a>2.3.5.2 LOCALBIN（定义本地二进制文件的安装目录）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Location to install dependencies to</span></span></span><br><span class="line">LOCALBIN ?= $(shell pwd)/bin</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(LOCALBIN):</span></span><br><span class="line">        mkdir -p $(LOCALBIN)</span><br></pre></td></tr></table></figure>
<p>作用：定义本地二进制文件的安装目录，默认为当前目录下的bin目录<br>解释：如果LOCALBIN未设置，则默认为$(shell pwd)&#x2F;bin。如果LOCALBIN目录不存在，则创建它。</p>
<h4 id="2-3-5-3-工具二进制文件（定义各种工具的路径和默认值）"><a href="#2-3-5-3-工具二进制文件（定义各种工具的路径和默认值）" class="headerlink" title="2.3.5.3 工具二进制文件（定义各种工具的路径和默认值）"></a>2.3.5.3 工具二进制文件（定义各种工具的路径和默认值）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Tool Binaries</span></span></span><br><span class="line">KUBECTL ?= kubectl</span><br><span class="line">KUSTOMIZE ?= $(LOCALBIN)/kustomize</span><br><span class="line">CONTROLLER_GEN ?= $(LOCALBIN)/controller-gen</span><br><span class="line">ENVTEST ?= $(LOCALBIN)/setup-envtest</span><br><span class="line">GOLANGCI_LINT = $(LOCALBIN)/golangci-lint</span><br></pre></td></tr></table></figure>
<p>作用：定义各种工具的路径和默认值<br>解释：</p>
<ul>
<li>KUBECTL：默认为kubectl</li>
<li>KUSTOMIZE：默认为$(LOCALBIN)&#x2F;kustomize</li>
<li>CONTROLLER_GEN：默认为$(LOCALBIN)&#x2F;controller-gen</li>
<li>ENVTEST：默认为$(LOCALBIN)&#x2F;setup-envtest</li>
<li>GOLANGCI_LINT： 默认为$(LOCALBIN)&#x2F;golangci-lint</li>
</ul>
<h4 id="2-3-5-4-工具版本（定义各个工具的版本）"><a href="#2-3-5-4-工具版本（定义各个工具的版本）" class="headerlink" title="2.3.5.4 工具版本（定义各个工具的版本）"></a>2.3.5.4 工具版本（定义各个工具的版本）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Tool Versions</span></span></span><br><span class="line">KUSTOMIZE_VERSION ?= v5.4.3</span><br><span class="line">CONTROLLER_TOOLS_VERSION ?= v0.16.1</span><br><span class="line">ENVTEST_VERSION ?= release-0.19</span><br><span class="line">GOLANGCI_LINT_VERSION ?= v1.59.1</span><br></pre></td></tr></table></figure>
<p>作用：定义各个工具的版本<br>解释：</p>
<ul>
<li>KUSTOMIZE_VERSION：默认为v5.4.3</li>
<li>CONTROLLER_TOOLS_VERSION：默认为v0.16.1</li>
<li>ENVTEST_VERSION：默认为release-0.19</li>
<li>GOLANGCI_LINT_VERSION：默认为v1.59.1</li>
</ul>
<h4 id="2-3-5-5-kustomize（下载kustomize工具）"><a href="#2-3-5-5-kustomize（下载kustomize工具）" class="headerlink" title="2.3.5.5 kustomize（下载kustomize工具）"></a>2.3.5.5 kustomize（下载kustomize工具）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: kustomize</span><br><span class="line">kustomize: $(KUSTOMIZE) ## Download kustomize locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(KUSTOMIZE): $(LOCALBIN)</span></span><br><span class="line">        $(call go-install-tool,$(KUSTOMIZE),sigs.k8s.io/kustomize/kustomize/v5,$(KUSTOMIZE_VERSION))</span><br></pre></td></tr></table></figure>
<p>作用：下载kustomize工具(如有必要)<br>解释：如果kustomize文件不存在，则调用 go-install-tool函数下载kustomize工具</p>
<h4 id="2-3-5-6-controller-gen（下载controller-gen工具）"><a href="#2-3-5-6-controller-gen（下载controller-gen工具）" class="headerlink" title="2.3.5.6 controller-gen（下载controller-gen工具）"></a>2.3.5.6 controller-gen（下载controller-gen工具）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: controller-gen</span><br><span class="line">controller-gen: $(CONTROLLER_GEN) ## Download controller-gen locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(CONTROLLER_GEN): $(LOCALBIN)</span></span><br><span class="line">        $(call go-install-tool,$(CONTROLLER_GEN),sigs.k8s.io/controller-tools/cmd/controller-gen,$(CONTROLLER_TOOLS_VERSION))</span><br></pre></td></tr></table></figure>
<p>作用：下载controller-gen工具(如有必要)<br>解释：如果$(CONTROLLER_GEN)文件不存在，则调用 go-install-tool函数下载controller-gen工具</p>
<h4 id="2-3-5-7-envtest（下载setup-envtest工具）"><a href="#2-3-5-7-envtest（下载setup-envtest工具）" class="headerlink" title="2.3.5.7 envtest（下载setup-envtest工具）"></a>2.3.5.7 envtest（下载setup-envtest工具）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: envtest</span><br><span class="line">envtest: $(ENVTEST) ## Download setup-envtest locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(ENVTEST): $(LOCALBIN)</span></span><br><span class="line">        $(call go-install-tool,$(ENVTEST),sigs.k8s.io/controller-runtime/tools/setup-envtest,$(ENVTEST_VERSION))</span><br></pre></td></tr></table></figure>
<p>作用：下载setup-envtest工具(如有必要)<br>解释：如果$(ENVTEST)文件不存在，则调用go-install-tool函数下载setup-envtes工具</p>
<h4 id="2-3-5-8-golangci-lint（下载golangci-lint工具）"><a href="#2-3-5-8-golangci-lint（下载golangci-lint工具）" class="headerlink" title="2.3.5.8 golangci-lint（下载golangci-lint工具）"></a>2.3.5.8 golangci-lint（下载golangci-lint工具）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: golangci-lint</span><br><span class="line">golangci-lint: $(GOLANGCI_LINT) ## Download golangci-lint locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(GOLANGCI_LINT): $(LOCALBIN)</span></span><br><span class="line">        $(call go-install-tool,$(GOLANGCI_LINT),github.com/golangci/golangci-lint/cmd/golangci-lint,$(GOLANGCI_LINT_VERSION))</span><br></pre></td></tr></table></figure>
<p>作用：下载golangci-lint工具(如有必要)<br>解释：如果$(GOLANGCI_LINT)文件不存在，则调用go-install-tool函数下载golangci-lint工具。</p>
<h2 id="2-4-自定义函数"><a href="#2-4-自定义函数" class="headerlink" title="2.4 自定义函数"></a>2.4 自定义函数</h2><h3 id="2-4-1-go-install-tool（下载并安装指定的Go包）"><a href="#2-4-1-go-install-tool（下载并安装指定的Go包）" class="headerlink" title="2.4.1 go-install-tool（下载并安装指定的Go包）"></a>2.4.1 go-install-tool（下载并安装指定的Go包）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">go-install-tool will <span class="string">&#x27;go install&#x27;</span> any package with custom target and name of binary, <span class="keyword">if</span> it doesn<span class="string">&#x27;t exist</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">$1 - target path with name of binary</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">$2 - package url which can be installed</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">$3 - specific version of package</span></span></span><br><span class="line">define go-install-tool</span><br><span class="line">@[ -f &quot;$(1)-$(3)&quot; ] || &#123; \</span><br><span class="line">set -e; \</span><br><span class="line">package=$(2)@$(3) ;\</span><br><span class="line">echo &quot;Downloading $$&#123;package&#125;&quot; ;\</span><br><span class="line">rm -f $(1) || true ;\</span><br><span class="line">GOBIN=$(LOCALBIN) go install $$&#123;package&#125; ;\</span><br><span class="line">mv $(1) $(1)-$(3) ;\</span><br><span class="line">&#125; ;\</span><br><span class="line">ln -sf $(1)-$(3) $(1)</span><br><span class="line">endef</span><br></pre></td></tr></table></figure>
<p>作用：下载并安装指定的Go包<br>解释：</p>
<ul>
<li>$1：目标路径和二进制文件名</li>
<li>$2：包的URL</li>
<li>$3:包的具体版本</li>
<li>如果目标文件$(1)~$(3)不存在，则执行以下步骤</li>
<li>设置set -e，确保任何命令执行失败立即退出</li>
<li>设置package变量为包的URL和版本</li>
<li>输出下载信息</li>
<li>删除旧的二进制文件(如果存在)</li>
<li>使用go install命令安装包，并将二进制文件保存在LOCALBIN目录</li>
<li>将生成的二进制文件重命令为$(1)-$(3)</li>
<li>最后创建一个符号链接，指向$(1)-$(3)</li>
</ul>

    </div>

    
</div>
    <div class="footer" id="footer">
    <p><h4>版权所有 © 2020 | 作者: 花日 | 主题 By <a class="theme-author" target="_blank" rel="noopener" href="https://github.com/Xunzhuo/hexo-theme-coder" style="font-size:14px; color: #969696">Coder</a></h4>
    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <span id="busuanzi_container_site_pv">本站浏览总访问量: <span id="busuanzi_value_site_pv"></span></span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv">本站访问人数: <span id="busuanzi_value_site_uv"></span></span>
    
    <label class="el-switch el-switch-blue el-switch-sm" style="vertical-align: sub;">
        <input type="checkbox" name="switch" id="update_style">
        <span class="el-switch-style"></span>
    </label>

    <!--         <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
    document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script> -->
</p>
</div>

<input type="hidden" id="web_style" value="black">
<input type="hidden" id="valine_appid" value="ipUXLgJtbz1bF0aJdxHUCLp0-MdYXbMMI">
<input type="hidden" id="valine_appKey" value="7z2HlZVXXCRLYggFe4GvEqle">

<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>

<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>

<script src="/js/js.js"></script>

<style type="text/css">
.v * {
color: #698fca;
}
.v .vlist .vcard .vhead .vsys {
color: #3a3e4a;
}
.v .vlist .vcard .vh .vmeta .vat {
color: #638fd5;
}
.v .vlist .vcard .vhead .vnick {
color: #6ba1ff;
}
.v a {
color: #8696b1;
}
.v .vlist .vcard .vhead .vnick:hover {
color: #669bfc;
}
</style>
    <script type="text/javascript" color="173,174,173" opacity='1' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
</body>
</html>
