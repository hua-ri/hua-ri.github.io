<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    

    
<script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script>
    

<meta charset="utf-8" >

<title>ArgoRollout测试</title>
<meta name="keywords" content="ArgoRollout测试, 花日の博客">
<meta name="description" content="前置准备ArgoCD部署准备域名及SSL证书配置域名解析在&#x2F;etc&#x2F;hosts里增加配置，将argo-devops.hua-ri.cn解析到ingress的外部IP：
1x.x.x.x argo-devops.hua-r">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta property="og:title" content="ArgoRollout测试">
<meta property="og:description" content="前置准备ArgoCD部署准备域名及SSL证书配置域名解析在&#x2F;etc&#x2F;hosts里增加配置，将argo-devops.hua-ri.cn解析到ingress的外部IP：
1x.x.x.x argo-devops.hua-r">

<link rel="shortcut icon" href="/images/huari.ico">
<link rel="stylesheet" href="/style/main.css">

  <link rel="stylesheet" href="/style/simple-lightbox.min.css"><meta name="generator" content="Hexo 7.3.0"></head>
  <body>
    <div id="app" class="main">

<div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="http://hua-ri.cn">
        <img class="avatar" src="/images/huari-image.png" alt="logo" width="32px" height="32px">
      </a>
      <a href="http://hua-ri.cn">
        <h1 class="site-title">花日の博客</h1>
      </a>
    </div>
    <div class="right">
        <i class="icon menu-switch icon-menu-outline" ></i>
    </div>
  </div>
</div>

<div class="menu-container" style="height: 0;opacity: 0;">
<nav class="menu-list">
  
    
      <a href="/" class="menu purple-link">
        首页
      </a>
    
  
    
      <a href="/tags" class="menu purple-link">
        标签
      </a>
    
  
    
      <a href="/categories" class="menu purple-link">
        分类
      </a>
    
  
    
      <a href="/archives" class="menu purple-link">
        归档
      </a>
    
  
    
      <a href="/about" class="menu purple-link">
        关于
      </a>
    
  
</nav>
</div>



  <div class="content-container">
    <div class="post-detail">
      
      <h2 class="post-title">ArgoRollout测试</h2>
      <div class="post-info post-detail-info">
        <span><i class="icon icon-calendar-outline"></i> 2025-08-12</span>
        
          <span>
          <i class="icon icon-pricetags-outline"></i>
            
              <a href="/tags/devops/">
              devops
                
                  ，
                
              </a>
            
              <a href="/tags/argo/">
              argo
                
                  ，
                
              </a>
            
              <a href="/tags/ArgoRollout/">
              ArgoRollout
                
              </a>
            
          </span>
        
      </div>
      <div class="post-content-wrapper">
        <div class="post-content">
          <h1 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h1><h2 id="ArgoCD部署"><a href="#ArgoCD部署" class="headerlink" title="ArgoCD部署"></a>ArgoCD部署</h2><h3 id="准备域名及SSL证书"><a href="#准备域名及SSL证书" class="headerlink" title="准备域名及SSL证书"></a>准备域名及SSL证书</h3><h4 id="配置域名解析"><a href="#配置域名解析" class="headerlink" title="配置域名解析"></a>配置域名解析</h4><p>在&#x2F;etc&#x2F;hosts里增加配置，将argo-devops.hua-ri.cn解析到ingress的外部IP：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x.x.x.x argo-devops.hua-ri.cn</span><br></pre></td></tr></table></figure>

<h4 id="创建tls密钥"><a href="#创建tls密钥" class="headerlink" title="创建tls密钥"></a>创建tls密钥</h4><p>需要执行secret名，记得是因为helm模板里没有支持指定secret名：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace argo</span><br><span class="line"></span><br><span class="line">kubectl create secret tls argocd-server-tls -n argo --cert=/Users/king/hua-ri.cn.pem --key=/Users/king/hua-ri.cn.key</span><br></pre></td></tr></table></figure>

<p>然后，运行以下命令检查秘密是否已创建：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets -n argo</span><br></pre></td></tr></table></figure>

<h3 id="部署argocd"><a href="#部署argocd" class="headerlink" title="部署argocd"></a>部署argocd</h3><h4 id="获取ingressClassName"><a href="#获取ingressClassName" class="headerlink" title="获取ingressClassName"></a>获取ingressClassName</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ingressclass</span><br></pre></td></tr></table></figure>

<p>期望结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME        CONTROLLER                 PARAMETERS   AGE</span><br><span class="line">ack-nginx   k8s.io/ack-ingress-nginx   &lt;none&gt;       50d</span><br></pre></td></tr></table></figure>

<h4 id="customs-yaml"><a href="#customs-yaml" class="headerlink" title="customs.yaml"></a>customs.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Globally shared configuration</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="comment"># -- Default domain used by all components</span></span><br><span class="line">  <span class="comment">## Used for ingresses, certificates, SSO, notifications, etc.</span></span><br><span class="line">  <span class="attr">domain:</span> <span class="string">argo-devops.hua-ri.cn</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Server</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="comment"># -- The number of server pods to run</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Argo CD server ingress configuration</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">    <span class="comment"># -- Enable an ingress resource for the Argo CD server</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># -- Specific implementation for ingress controller. One of `generic`, `aws` or `gke`</span></span><br><span class="line">    <span class="comment">## Additional configuration might be required in related configuration sections</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="string">generic</span></span><br><span class="line">    <span class="comment"># -- Defines which ingress controller will implement the resource</span></span><br><span class="line">    <span class="attr">ingressClassName:</span> <span class="string">&quot;ack-nginx&quot;</span></span><br><span class="line">    <span class="comment"># -- Argo CD server hostname</span></span><br><span class="line">    <span class="comment"># @default -- `&quot;&quot;` (defaults to global.domain)</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">&quot;argo-devops.hua-ri.cn&quot;</span></span><br><span class="line">    <span class="comment"># -- The path to Argo CD server</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">    <span class="comment"># -- Ingress path type. One of `Exact`, `Prefix` or `ImplementationSpecific`</span></span><br><span class="line">    <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">    <span class="comment"># -- Additional ingress annotations</span></span><br><span class="line">    <span class="comment">## Ref: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#option-1-ssl-passthrough</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">nginx.ingress.kubernetes.io/backend-protocol:</span> <span class="string">&quot;HTTPS&quot;</span></span><br><span class="line">      <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">nginx.ingress.kubernetes.io/force-ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="comment"># -- Enable TLS configuration for the hostname defined at `server.ingress.hostname`</span></span><br><span class="line">    <span class="comment">## TLS certificate will be retrieved from a TLS secret `argocd-server-tls`</span></span><br><span class="line">    <span class="comment">## You can create this secret via `certificate` or `certificateSecret` option</span></span><br><span class="line">    <span class="attr">tls:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="helm部署argocd"><a href="#helm部署argocd" class="headerlink" title="helm部署argocd"></a>helm部署argocd</h4><p>使用Helm一键部署Argo-CD服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install argocd argo/argo-cd --version 7.3.5 \</span><br><span class="line">  --namespace argo \</span><br><span class="line">  --create-namespace \</span><br><span class="line">  -f customs.yaml</span><br></pre></td></tr></table></figure>

<h4 id="helm卸载argocd"><a href="#helm卸载argocd" class="headerlink" title="helm卸载argocd"></a>helm卸载argocd</h4><p>简单卸载：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm uninstall argocd --namespace argo</span><br></pre></td></tr></table></figure>

<h4 id="完全卸载："><a href="#完全卸载：" class="headerlink" title="完全卸载："></a>完全卸载：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">helm uninstall argocd --namespace argo</span><br><span class="line">kubectl delete namespace argo</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除 ClusterRole</span></span><br><span class="line">kubectl delete clusterrole argocd-server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除对应的 ClusterRoleBinding</span></span><br><span class="line">kubectl delete clusterrolebinding argocd-server</span><br><span class="line"></span><br><span class="line">kubectl delete clusterrole,clusterrolebinding -l app.kubernetes.io/instance=argocd</span><br><span class="line"></span><br><span class="line">kubectl delete crd applications.argoproj.io appprojects.argoproj.io applicationsets.argoproj.io</span><br></pre></td></tr></table></figure>

<h3 id="访问Argo-CD-Server服务"><a href="#访问Argo-CD-Server服务" class="headerlink" title="访问Argo-CD Server服务"></a>访问Argo-CD Server服务</h3><p>因为已经配置了域名解析，所以直接通过域名访问即可</p>
<h4 id="获取Argo-CD-Server的密码"><a href="#获取Argo-CD-Server的密码" class="headerlink" title="获取Argo-CD Server的密码"></a>获取Argo-CD Server的密码</h4><p>通过下面的命令可以查看初始密码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret -n argo argocd-initial-admin-secret -o jsonpath=&quot;&#123;.data.password&#125;&quot; | base64 -d</span><br></pre></td></tr></table></figure>

<h4 id="argocd命令行登录Argo-CD服务"><a href="#argocd命令行登录Argo-CD服务" class="headerlink" title="argocd命令行登录Argo-CD服务"></a>argocd命令行登录Argo-CD服务</h4><p>通过argocd命令行登录Argo-CD服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">argocd login argo-devops.hua-ri.cn</span></span><br><span class="line">WARN[0000] Failed to invoke grpc call. Use flag --grpc-web in grpc calls. To avoid this warning message, use flag --grpc-web. </span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">&#x27;admin:login&#x27; logged in successfully</span><br><span class="line">Context &#x27;argo-devops.hua-ri.cn&#x27; updated</span><br></pre></td></tr></table></figure>

<h2 id="Argo-Rollout部署"><a href="#Argo-Rollout部署" class="headerlink" title="Argo Rollout部署"></a>Argo Rollout部署</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace argo-rollouts</span><br><span class="line">kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml</span><br></pre></td></tr></table></figure>

<h2 id="应用测试仓库"><a href="#应用测试仓库" class="headerlink" title="应用测试仓库"></a>应用测试仓库</h2><p>可以构建一个测试用的仓库，具体内容参考下面的文件举例</p>
<h3 id="main-go"><a href="#main-go" class="headerlink" title="main.go"></a>main.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;bytes&quot;</span></span><br><span class="line">    <span class="string">&quot;compress/gzip&quot;</span></span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;crypto/tls&quot;</span></span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io&quot;</span></span><br><span class="line">    <span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http/httputil&quot;</span></span><br><span class="line">    <span class="string">&quot;net/url&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">    argocdclient <span class="string">&quot;github.com/argoproj/argo-cd/v2/pkg/apiclient&quot;</span></span><br><span class="line">    applicationpkg <span class="string">&quot;github.com/argoproj/argo-cd/v2/pkg/apiclient/application&quot;</span></span><br><span class="line">    argoio <span class="string">&quot;github.com/argoproj/argo-cd/v2/util/io&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/gin-contrib/cors&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    ARGOCD_HOST  = <span class="string">&quot;https://bkce7-dev.hua-ri.cn:8080/&quot;</span></span><br><span class="line">    ARGOCD_TOKEN = <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJhcmdvY2QiLCJzdWIiOiJxaXlhbjphcGlLZXkiLCJuYmYiOjE3NDU4Mzc1NjgsImlhdCI6MTc0NTgzNzU2OCwianRpIjoiNDM1NDgwY2ItNjliYy00Y2Q2LTk3NjYtMGU0ZDA0MzU5MWFhIn0.F-1ZZThXCqFnG_Kgxgy6z11Hmgl6g7mcEitaKQPyP8k&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> JSONResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">    Code   <span class="type">int</span>    <span class="string">`json:&quot;code&quot;`</span></span><br><span class="line">    Result <span class="type">bool</span>   <span class="string">`json:&quot;result&quot;`</span></span><br><span class="line">    Msg    <span class="type">string</span> <span class="string">`json:&quot;message&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> successResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">    JSONResponse</span><br><span class="line">    Data <span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;data&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ERRresponse <span class="keyword">struct</span> &#123;</span><br><span class="line">    Error <span class="type">string</span> <span class="string">`json:&quot;message&quot; example:&quot;message&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Error</span><span class="params">(message <span class="type">string</span>)</span></span> ERRresponse &#123;</span><br><span class="line">    <span class="keyword">return</span> ERRresponse&#123;Error: message&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ArgoCDErrorResponse</span><span class="params">(argocderr ArgoCDError)</span></span> ERRresponse &#123;</span><br><span class="line">    <span class="comment">// argocd的error默认加上2000，便于统一处理</span></span><br><span class="line">    <span class="keyword">return</span> ERRresponse&#123;Error: argocderr.Message&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ArgoCDError <span class="keyword">struct</span> &#123;</span><br><span class="line">    Error   <span class="type">error</span>  <span class="string">`json:&quot;error&quot;`</span></span><br><span class="line">    Message <span class="type">string</span> <span class="string">`json:&quot;message&quot;`</span></span><br><span class="line">    Code    <span class="type">int</span>    <span class="string">`json:&quot;code&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BuildArgoCDError</span><span class="params">(body []<span class="type">byte</span>)</span></span> (argocderr ArgoCDError, err <span class="type">error</span>) &#123;</span><br><span class="line">    err = json.Unmarshal(body, &amp;argocderr)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> ArgoCDError&#123;</span><br><span class="line">          Message: <span class="type">string</span>(body),</span><br><span class="line">       &#125;, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">wrapResponse</span><span class="params">(r *http.Response)</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> strings.Contains(r.Request.URL.Path, <span class="string">&quot;api/v1/secrets&quot;</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    body, err := readBody(r)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> r.StatusCode &#123;</span><br><span class="line">    <span class="keyword">case</span> http.StatusOK:</span><br><span class="line">       <span class="keyword">var</span> newbody <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">       err = json.Unmarshal(body, &amp;newbody)</span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">       &#125;</span><br><span class="line">       resp := successResponse&#123;</span><br><span class="line">          JSONResponse: JSONResponse&#123;</span><br><span class="line">             Code:   <span class="number">0</span>,</span><br><span class="line">             Result: <span class="literal">true</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          Data: newbody,</span><br><span class="line">       &#125;</span><br><span class="line">       err = writeBody(r, resp)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">       argocderr, err := BuildArgoCDError(body)</span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">          err = writeBody(r, Error(<span class="type">string</span>(body)))</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          err = writeBody(r, ArgoCDErrorResponse(argocderr))</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readBody</span><span class="params">(r *http.Response)</span></span> (body []<span class="type">byte</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> r.Header.Get(<span class="string">&quot;Content-Encoding&quot;</span>) == <span class="string">&quot;gzip&quot;</span> &#123;</span><br><span class="line">       reader, err := gzip.NewReader(r.Body)</span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">          log.Print(<span class="string">&quot;create reader content[gzip] failed&quot;</span>)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">defer</span> reader.Close()</span><br><span class="line">       <span class="comment">// Read the decompressed response body</span></span><br><span class="line">       body, err = io.ReadAll(reader)</span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">          fmt.Printf(<span class="string">&quot;read gzip body failed,status:%s,error:%s&quot;</span>, r.Status, err.Error())</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// Do something with the response body</span></span><br><span class="line">       r.Header.Del(<span class="string">&quot;Content-Encoding&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       body, err = ioutil.ReadAll(r.Body)</span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">          fmt.Printf(<span class="string">&quot;read body failed,status:%s,error:%s&quot;</span>, r.Status, err.Error())</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeBody</span><span class="params">(r *http.Response, res <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    updatedBody, err := json.Marshal(&amp;res)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       fmt.Printf(<span class="string">&quot;unmarshal new gitops response body failed,body:%v,error:%s&quot;</span>, res, err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    buf := bytes.NewBuffer(updatedBody)</span><br><span class="line">    r.Body = ioutil.NopCloser(buf)</span><br><span class="line">    r.Header[<span class="string">&quot;Content-Length&quot;</span>] = []<span class="type">string</span>&#123;fmt.Sprint(buf.Len())&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">argocdProxy</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    request := c.Request</span><br><span class="line">    writer := c.Writer</span><br><span class="line"></span><br><span class="line">    proxyURL, err := url.Parse(ARGOCD_HOST)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    proxyTarget := *proxyURL</span><br><span class="line">    <span class="comment">// 创建反向代理</span></span><br><span class="line">    proxy := httputil.NewSingleHostReverseProxy(proxyURL)</span><br><span class="line"></span><br><span class="line">    proxy.ModifyResponse = wrapResponse</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 确保Host和URL.Host指向正确的反向代理地址</span></span><br><span class="line">    request.Host = proxyTarget.Host</span><br><span class="line">    request.URL.Scheme = proxyTarget.Scheme</span><br><span class="line">    request.URL.Host = proxyTarget.Host</span><br><span class="line">    request.Header.Set(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span>+ARGOCD_TOKEN)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改请求路径，去掉 /gitops 前缀并解码 %2F</span></span><br><span class="line">    request.URL.Path = strings.Replace(request.URL.Path, <span class="string">&quot;/gitops&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    request.URL.RawPath = strings.Replace(request.URL.RawPath, <span class="string">&quot;/gitops&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移除CORS头部</span></span><br><span class="line">    <span class="comment">//writer.Header().Del(&quot;Access-Control-Allow-Origin&quot;)</span></span><br><span class="line">    <span class="comment">//writer.Header().Del(&quot;Access-Control-Allow-Credentials&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务HTTP请求</span></span><br><span class="line">    tr := &amp;http.Transport&#123;</span><br><span class="line">       TLSClientConfig: &amp;tls.Config&#123;InsecureSkipVerify: <span class="literal">true</span>&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    proxy.Transport = tr</span><br><span class="line">    proxy.ServeHTTP(writer, request)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testCall</span><span class="params">()</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">    ctx := context.Background()</span><br><span class="line">    clientOpts := argocdclient.ClientOptions&#123;</span><br><span class="line">       ServerAddr:      <span class="string">&quot;bkce7-dev.hua-ri.cn:8080&quot;</span>,</span><br><span class="line">       Insecure:        <span class="literal">true</span>,</span><br><span class="line">       GRPCWebRootPath: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">       Headers: []<span class="type">string</span>&#123;</span><br><span class="line">          <span class="string">&quot;Authorization: Bearer &quot;</span> + ARGOCD_TOKEN,</span><br><span class="line">          <span class="string">&quot;username: qiyan&quot;</span>,</span><br><span class="line">       &#125;,</span><br><span class="line">       AuthToken: ARGOCD_TOKEN,</span><br><span class="line">    &#125;</span><br><span class="line">    client, _ := argocdclient.NewClient(&amp;clientOpts)</span><br><span class="line"></span><br><span class="line">    conn, appIf := client.NewApplicationClientOrDie()</span><br><span class="line">    <span class="keyword">defer</span> argoio.Close(conn)</span><br><span class="line">    app, err := appIf.List(ctx, &amp;applicationpkg.ApplicationQuery&#123;</span><br><span class="line">       Projects: []<span class="type">string</span>&#123;<span class="string">&quot;default&quot;</span>&#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> err.Error()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    r := gin.Default()</span><br><span class="line">    r.GET(<span class="string">&quot;/api/check&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">       c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">          <span class="string">&quot;message&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">       &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    r.GET(<span class="string">&quot;/user&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">       c.JSON(http.StatusOK, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">          <span class="string">&quot;code&quot;</span>:   <span class="number">0</span>,</span><br><span class="line">          <span class="string">&quot;result&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="string">&quot;data&quot;</span>: <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line">             <span class="string">&quot;username&quot;</span>: <span class="string">&quot;qiyan&quot;</span>,</span><br><span class="line">             <span class="string">&quot;type&quot;</span>:     <span class="string">&quot;bk&quot;</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">       &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    r.GET(<span class="string">&quot;/argocd/applications&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">       c.JSON(http.StatusOK, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">          <span class="string">&quot;code&quot;</span>:   <span class="number">0</span>,</span><br><span class="line">          <span class="string">&quot;result&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="string">&quot;data&quot;</span>:   testCall(),</span><br><span class="line">       &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    gitopsrouter := r.Group(<span class="string">&quot;gitops&quot;</span>)</span><br><span class="line">    gitopsrouter.Use(cors.New(cors.Config&#123;</span><br><span class="line">       AllowOrigins:     []<span class="type">string</span>&#123;<span class="string">&quot;http://bkce7-dev.hua-ri.cn:8888&quot;</span>, <span class="string">&quot;http://power.hua-ri.cn:5000&quot;</span>&#125;,</span><br><span class="line">       AllowFiles:       <span class="literal">true</span>,</span><br><span class="line">       AllowWebSockets:  <span class="literal">true</span>,</span><br><span class="line">       AllowMethods:     []<span class="type">string</span>&#123;<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, <span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;DELETE&quot;</span>, <span class="string">&quot;OPTIONS&quot;</span>&#125;,</span><br><span class="line">       AllowHeaders:     []<span class="type">string</span>&#123;<span class="string">&quot;Origin&quot;</span>, <span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;x-token&quot;</span>, <span class="string">&quot;x-csrftoken&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>&#125;,</span><br><span class="line">       ExposeHeaders:    []<span class="type">string</span>&#123;<span class="string">&quot;Content-Length&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>&#125;,</span><br><span class="line">       AllowCredentials: <span class="literal">true</span>,</span><br><span class="line">       MaxAge:           <span class="number">12</span> * time.Hour,</span><br><span class="line">    &#125;))</span><br><span class="line">    gitopsrouter.Any(<span class="string">&quot;*subpath&quot;</span>, argocdProxy)</span><br><span class="line"></span><br><span class="line">    r.Run()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// listen and serve on 0.0.0.0:8080 (for windows &quot;localhost:8080&quot;)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要看这部分：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">r.GET(<span class="string">&quot;/api/check&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">   c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这个接口会在请求时返回{“message”: “v1”}。我们需要基于这个特性打两个镜像，v1版本返回{“message”: “v1”}，v2版本返回{“message”: “v2”}.</p>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># builder</span></span><br><span class="line"><span class="keyword">FROM</span> public-registry-vpc.cn-hangzhou.cr.aliyuncs.com/public/golang:v1.<span class="number">22.2</span>_20240416 AS builder</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> root</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> go <span class="built_in">env</span> -w GOPROXY=<span class="string">&quot;https://goproxy.cn,direct&quot;</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> go <span class="built_in">env</span> -w GOSUMDB=<span class="string">&quot;off&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> go mod download</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> go build -o demo main.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># runtime</span></span><br><span class="line"><span class="keyword">FROM</span> public-registry-vpc.cn-hangzhou.cr.aliyuncs.com/public/alpine:<span class="number">3.14</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> LANG en_US.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> TZ Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /src/demo /app/demo</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/app/demo&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Go parameters</span></span><br><span class="line">IMAGE_REPO=dev-registry-vpc.cn-hangzhou.cr.aliyuncs.com/ops/qiyan</span><br><span class="line">IMAGE_TAG=v1</span><br><span class="line"></span><br><span class="line"><span class="section">all:: server</span></span><br><span class="line"></span><br><span class="line"><span class="section">server::</span></span><br><span class="line">    go run main.go</span><br><span class="line"></span><br><span class="line"><span class="section">build::</span></span><br><span class="line">    go build main.go</span><br><span class="line"></span><br><span class="line"><span class="section">test::</span></span><br><span class="line">    go test ./...</span><br><span class="line"></span><br><span class="line"><span class="section">build-image:</span></span><br><span class="line">    docker build --platform=linux/amd64 -t $&#123;IMAGE_REPO&#125;:$&#123;IMAGE_TAG&#125; -f Dockerfile . --push</span><br></pre></td></tr></table></figure>

<p>分别修改IMAGE_TAG值为v1和v2并打两个镜像。</p>
<h3 id="打测试镜像"><a href="#打测试镜像" class="headerlink" title="打测试镜像"></a>打测试镜像</h3><h4 id="IMAGE-TAG-v1"><a href="#IMAGE-TAG-v1" class="headerlink" title="IMAGE_TAG&#x3D;v1"></a>IMAGE_TAG&#x3D;v1</h4><p>Makefile文件中IMAGE_TAG值设置为v1，main.go中亦是如此。</p>
<p>Makefile：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Go parameters</span></span><br><span class="line">IMAGE_REPO=dev-registry-vpc.cn-hangzhou.cr.aliyuncs.com/ops/qiyan</span><br><span class="line">IMAGE_TAG=v1</span><br></pre></td></tr></table></figure>

<p>main.go：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">r.GET(<span class="string">&quot;/api/check&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">   c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="IMAGE-TAG-v2"><a href="#IMAGE-TAG-v2" class="headerlink" title="IMAGE_TAG&#x3D;v2"></a>IMAGE_TAG&#x3D;v2</h4><p>Makefile文件中IMAGE_TAG值设置为v2，main.go中亦是如此。</p>
<p>Makefile：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Go parameters</span></span><br><span class="line">IMAGE_REPO=dev-registry-vpc.cn-hangzhou.cr.aliyuncs.com/ops/qiyan</span><br><span class="line">IMAGE_TAG=v2</span><br></pre></td></tr></table></figure>

<p>main.go：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">r.GET(<span class="string">&quot;/api/check&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">   c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span>: <span class="string">&quot;v2&quot;</span>,</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="yaml测试仓库"><a href="#yaml测试仓库" class="headerlink" title="yaml测试仓库"></a>yaml测试仓库</h2><p>同样的，也可以构建一个测试用的仓库，具体内容参考下面的文件举例</p>
<h3 id="values-yaml"><a href="#values-yaml" class="headerlink" title="values.yaml"></a>values.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ingress:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>Helm chart的顶级开关</p>
<h3 id="charts-ingress-values-yaml"><a href="#charts-ingress-values-yaml" class="headerlink" title="&#x2F;charts&#x2F;ingress&#x2F;values.yaml"></a>&#x2F;charts&#x2F;ingress&#x2F;values.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">lb:</span> <span class="string">lb-bp1r1dsywnqktp1hxih38</span></span><br><span class="line"><span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">image:</span> <span class="string">dev-registry-vpc.cn-hangzhou.cr.aliyuncs.com/ops/qiyan</span></span><br><span class="line"><span class="attr">imageTag:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">9999</span></span><br></pre></td></tr></table></figure>

<p>在这里通过imageTag控制要部署的镜像版本，我们在测试argo rollout时，就是反复通过修改该字段实现的。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imageTag:</span> <span class="string">v2</span></span><br></pre></td></tr></table></figure>

<h3 id="charts-ingress-Chart-yaml"><a href="#charts-ingress-Chart-yaml" class="headerlink" title="&#x2F;charts&#x2F;ingress&#x2F;Chart.yaml"></a>&#x2F;charts&#x2F;ingress&#x2F;Chart.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">ingress</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">A</span> <span class="string">Helm</span> <span class="string">chart</span> <span class="string">for</span> <span class="string">Kubernetes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A chart can be either an &#x27;application&#x27; or a &#x27;library&#x27; chart.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Application charts are a collection of templates that can be packaged into versioned archives</span></span><br><span class="line"><span class="comment"># to be deployed.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Library charts provide useful utilities or functions for the chart developer. They&#x27;re included as</span></span><br><span class="line"><span class="comment"># a dependency of application charts to inject those utilities and functions into the rendering</span></span><br><span class="line"><span class="comment"># pipeline. Library charts do not define any templates and therefore cannot be deployed.</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">application</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is the chart version. This version number should be incremented each time you make changes</span></span><br><span class="line"><span class="comment"># to the chart and its templates, including the app version.</span></span><br><span class="line"><span class="comment"># Versions are expected to follow Semantic Versioning (https://semver.org/)</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is the version number of the application being deployed. This version number should be</span></span><br><span class="line"><span class="comment"># incremented each time you make changes to the application. Versions are not expected to</span></span><br><span class="line"><span class="comment"># follow Semantic Versioning. They should reflect the version the application is using.</span></span><br><span class="line"><span class="comment"># It is recommended to use it with quotes.</span></span><br><span class="line"><span class="attr">appVersion:</span> <span class="string">&quot;1.16.0&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="charts-ingress-helmignore"><a href="#charts-ingress-helmignore" class="headerlink" title="&#x2F;charts&#x2F;ingress&#x2F;.helmignore"></a>&#x2F;charts&#x2F;ingress&#x2F;.helmignore</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Patterns to ignore when building packages.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This supports shell glob matching, relative path matching, and</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">negation (prefixed with !). Only one pattern per line.</span></span><br><span class="line">.DS_Store</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Common VCS <span class="built_in">dirs</span></span></span><br><span class="line">.git/</span><br><span class="line">.gitignore</span><br><span class="line">.bzr/</span><br><span class="line">.bzrignore</span><br><span class="line">.hg/</span><br><span class="line">.hgignore</span><br><span class="line">.svn/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Common backup files</span></span><br><span class="line">*.swp</span><br><span class="line">*.bak</span><br><span class="line">*.tmp</span><br><span class="line">*.orig</span><br><span class="line">*~</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Various IDEs</span></span><br><span class="line">.project</span><br><span class="line">.idea/</span><br><span class="line">*.tmproj</span><br><span class="line">.vscode/</span><br></pre></td></tr></table></figure>
<p>这里和.gitignore功能差不多，在本文的影响可忽略。</p>
<h3 id="charts-ingress-templates-ingress-yaml"><a href="#charts-ingress-templates-ingress-yaml" class="headerlink" title="&#x2F;charts&#x2F;ingress&#x2F;templates&#x2F;ingress.yaml"></a>&#x2F;charts&#x2F;ingress&#x2F;templates&#x2F;ingress.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.Values.enabled</span> &#125;&#125;</span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rollouts-demo-stable</span></span><br><span class="line">  <span class="attr">namespace:</span> &#123;&#123; <span class="string">.Release.Namespace</span> &#125;&#125;</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">ack-nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">bkce7-dev.hua-ri.cn</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">rollouts-demo-stable</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">9999</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>给稳定 Service 暴露外部 7 层入口。</p>
<ul>
<li>ingressClassName: ack-nginx     # 阿里云 ACK 托管 nginx ingress</li>
<li>host &#x2F; path                    # 访问域名 bkce7-dev.hua-ri.cn&#x2F;</li>
<li>backend port 必须等于 Service 的 port 字段（9999）</li>
</ul>
<h3 id="charts-ingress-templates-rollout-yaml"><a href="#charts-ingress-templates-rollout-yaml" class="headerlink" title="&#x2F;charts&#x2F;ingress&#x2F;templates&#x2F;rollout.yaml"></a>&#x2F;charts&#x2F;ingress&#x2F;templates&#x2F;rollout.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.Values.enabled</span> &#125;&#125;</span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">argoproj.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Rollout</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rollouts-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> &#123;&#123; <span class="string">.Release.Namespace</span> &#125;&#125;</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">canary:</span></span><br><span class="line">      <span class="attr">canaryService:</span> <span class="string">rollouts-demo-canary</span></span><br><span class="line">      <span class="attr">stableService:</span> <span class="string">rollouts-demo-stable</span></span><br><span class="line">      <span class="attr">trafficRouting:</span></span><br><span class="line">        <span class="attr">nginx:</span></span><br><span class="line">          <span class="attr">stableIngress:</span> <span class="string">rollouts-demo-stable</span></span><br><span class="line">          <span class="attr">additionalIngressAnnotations:</span>   <span class="comment"># optional</span></span><br><span class="line">            <span class="attr">canary-by-header:</span> <span class="string">X-Canary</span></span><br><span class="line">            <span class="attr">canary-by-header-value:</span> <span class="string">iwantsit</span></span><br><span class="line">      <span class="attr">steps:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">setCanaryScale:</span></span><br><span class="line">            <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">pause:</span> &#123; &#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">setWeight:</span> <span class="number">20</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">pause:</span> &#123; &#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">setWeight:</span> <span class="number">40</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">pause:</span> &#123; &#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">setWeight:</span> <span class="number">60</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">pause:</span> &#123; &#125;</span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">argocd-demo</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">argocd-demo</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rollouts-demo</span></span><br><span class="line">          <span class="attr">image:</span> &#123;&#123; <span class="string">.Values.image</span>&#125;&#125;<span class="string">:&#123;&#123;</span> <span class="string">.Values.imageTag</span> <span class="string">|</span> <span class="string">default</span> <span class="string">.Chart.AppVersion</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">32Mi</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">5m</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">          <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">      <span class="attr">securityContext:</span> &#123; &#125;</span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dev-registry</span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>Argo Rollouts CRD 的核心资源，功能等价于 Deployment + 渐进式发布策略。</p>
<p>重要字段说明：</p>
<ul>
<li>replicas: 5                    # 期望副本数（helm values 里的 replicaCount 被覆盖）</li>
<li>strategy.canary                # 使用金丝雀发布</li>
<li>canaryService &#x2F; stableService  # 对应上面两个 Service</li>
<li>trafficRouting.nginx           # 用 nginx-ingress 做流量拆分<br>stableIngress: rollouts-demo-stable   # 必须指向一个已经存在的 Ingress<br>additionalIngressAnnotations          # 灰度规则：带 X-Canary: iwantsit 的请求去 canary</li>
<li>steps                          # 分阶段<ol>
<li>setCanaryScale(replicas:1)  # 先扩 1 个新版本 Pod</li>
<li>pause{}                     # 人工卡点（Argo CLI 或 UI 点 promote）</li>
<li>setWeight(20)…              # 后续按 20→40→60% 权重逐渐切换</li>
</ol>
</li>
<li>image 引用方式<br>image: {{ .Values.image}}:{{ .Values.imageTag | default .Chart.AppVersion }}<br>如果 imageTag 为空，tag 等于 1.16.0</li>
</ul>
<h3 id="charts-ingress-templates-service-yaml"><a href="#charts-ingress-templates-service-yaml" class="headerlink" title="&#x2F;charts&#x2F;ingress&#x2F;templates&#x2F;service.yaml"></a>&#x2F;charts&#x2F;ingress&#x2F;templates&#x2F;service.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.Values.enabled</span> &#125;&#125;</span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rollouts-demo-stable</span></span><br><span class="line">  <span class="attr">namespace:</span> &#123;&#123; <span class="string">.Release.Namespace</span> &#125;&#125;</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcp</span></span><br><span class="line">    <span class="attr">port:</span> &#123;&#123; <span class="string">.Values.port</span> &#125;&#125;</span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">argocd-demo</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rollouts-demo-canary</span></span><br><span class="line">  <span class="attr">namespace:</span> &#123;&#123; <span class="string">.Release.Namespace</span> &#125;&#125;</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcp</span></span><br><span class="line">    <span class="attr">port:</span> &#123;&#123; <span class="string">.Values.port</span> &#125;&#125;</span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">argocd-demo</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过顶级开关决定是否开启渲染。</li>
<li>生成两个 ClusterIP Service<ul>
<li>rollouts-demo-stable  # 稳定版本（金丝雀结束后的流量终点）</li>
<li>rollouts-demo-canary   # 金丝雀版本（只接收按权重或 header 分流的流量）</li>
</ul>
</li>
</ul>
<p>关键字段：</p>
<ul>
<li>targetPort: 8080 必须与容器里 containerPort: 8080 一致</li>
<li>selector: app: argocd-demo 必须跟 rollout.yaml 里的 label 匹配，否则 endpoint 为空</li>
</ul>
<h3 id="详细分析rollout-yaml"><a href="#详细分析rollout-yaml" class="headerlink" title="详细分析rollout.yaml"></a>详细分析rollout.yaml</h3><p>下面把 rollout.yaml 拆成 4 个维度逐字段展开：</p>
<ol>
<li>最外层元数据 &amp; 选择器</li>
<li>Pod 模板（template）</li>
<li>金丝雀策略（strategy.canary）</li>
<li>灰度步骤（steps）与常见扩展</li>
</ol>
<h4 id="最外层元数据-选择器"><a href="#最外层元数据-选择器" class="headerlink" title="最外层元数据 &amp; 选择器"></a>最外层元数据 &amp; 选择器</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">argoproj.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Rollout</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rollouts-demo</span>          <span class="comment"># Rollout CR 的名字，kubectl get ro 看到的就是它</span></span><br><span class="line">  <span class="attr">namespace:</span> &#123;&#123; <span class="string">.Release.Namespace</span> &#125;&#125;</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">5</span>                  <span class="comment"># 期望副本数，区别于 Deployment 的 replicas</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">2</span>      <span class="comment"># 保留多少个 ReplicaSet 做回滚，默认 10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">argocd-demo</span>         <span class="comment"># 必须 &gt;= template.metadata.labels</span></span><br><span class="line">                               <span class="comment"># 也决定了 Service/Ingress 的 selector</span></span><br></pre></td></tr></table></figure>

<h4 id="Pod-模板（template）"><a href="#Pod-模板（template）" class="headerlink" title="Pod 模板（template）"></a>Pod 模板（template）</h4><p>这一块与 Deployment 的 spec.template 100 % 相同，字段不再赘述，只提示与 Rollout 相关的注意点：</p>
<ul>
<li>labels: app: argocd-demo 必须与 selector 完全一致，否则 Argo 会报 selector mismatch。</li>
<li>容器端口 8080 要与 Service 的 targetPort 对齐。</li>
<li>image 写法：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span> &#123;&#123; <span class="string">.Values.image</span> &#125;&#125;<span class="string">:&#123;&#123;</span> <span class="string">.Values.imageTag</span> <span class="string">|</span> <span class="string">default</span> <span class="string">.Chart.AppVersion</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果 .Values.imageTag 为空，则使用 Chart.AppVersion 作为 tag（示例中是 1.16.0）。</p>
<h4 id="金丝雀策略（strategy-canary）"><a href="#金丝雀策略（strategy-canary）" class="headerlink" title="金丝雀策略（strategy.canary）"></a>金丝雀策略（strategy.canary）</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">strategy:</span></span><br><span class="line">  <span class="attr">canary:</span></span><br><span class="line">    <span class="attr">canaryService:</span> <span class="string">rollouts-demo-canary</span>   <span class="comment"># 指向 Service（ClusterIP 即可）</span></span><br><span class="line">    <span class="attr">stableService:</span> <span class="string">rollouts-demo-stable</span>   <span class="comment"># 指向 Service（ClusterIP 即可）</span></span><br><span class="line">    <span class="attr">trafficRouting:</span>                       <span class="comment"># 指定谁来切流量</span></span><br><span class="line">      <span class="attr">nginx:</span>                              <span class="comment"># 使用 nginx-ingress</span></span><br><span class="line">        <span class="attr">stableIngress:</span> <span class="string">rollouts-demo-stable</span></span><br><span class="line">        <span class="attr">additionalIngressAnnotations:</span>     <span class="comment"># 写入 canary ingress 的注解</span></span><br><span class="line">          <span class="attr">nginx.ingress.kubernetes.io/canary-by-header:</span> <span class="string">&quot;X-Canary&quot;</span></span><br><span class="line">          <span class="attr">nginx.ingress.kubernetes.io/canary-by-header-value:</span> <span class="string">&quot;iwantsit&quot;</span></span><br></pre></td></tr></table></figure>

<p>字段解释:</p>
<ul>
<li>canaryService &#x2F; stableService<br>这两个 Service 的 selector 在发布过程中会被 Argo 动态修改：<ul>
<li>stableService → 旧版本 Pod</li>
<li>canaryService → 新版本 Pod</li>
</ul>
</li>
<li>trafficRouting 支持多种实现<ol>
<li>nginx（示例）</li>
<li>istio &#x2F; smi &#x2F; alb &#x2F; traefik &#x2F; apisix …<br>选了 nginx 就必须提供 stableIngress，Argo 会克隆该 Ingress 生成 rollouts-demo-stable-canary 并添加 canary 注解。</li>
</ol>
</li>
<li>additionalIngressAnnotations</li>
</ul>
<p>只对新生成的 canary-ingress 生效，用来实现“按 header 强制走灰度”或“按 cookie 灰度”等高级策略。</p>
<h4 id="灰度步骤（steps）"><a href="#灰度步骤（steps）" class="headerlink" title="灰度步骤（steps）"></a>灰度步骤（steps）</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">steps:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">setCanaryScale:</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span>         <span class="comment"># 第 1 步：只起 1 个新版本 Pod</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pause:</span> &#123;&#125;             <span class="comment"># 第 2 步：人工卡点（直到 kubectl argo rollouts promote）</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">setWeight:</span> <span class="number">20</span>         <span class="comment"># 第 3 步：20 % 流量到新版本</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pause:</span> &#123;&#125;             <span class="comment"># 第 4 步：人工卡点</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">setWeight:</span> <span class="number">40</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pause:</span> &#123;&#125;</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">setWeight:</span> <span class="number">60</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pause:</span> &#123;&#125;             <span class="comment"># 第 8 步：最后人工确认后 Argo 会把剩余 40 % 切过去</span></span><br></pre></td></tr></table></figure>

<p>字段扩展</p>
<ul>
<li>setCanaryScale 与 setWeight 可同时出现，互不冲突：<ul>
<li>setCanaryScale 控制 Pod 数量</li>
<li>setWeight 控制 流量比例</li>
</ul>
</li>
<li>pause 支持自动超时</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">pause:</span></span><br><span class="line">    <span class="attr">duration:</span> <span class="string">5m</span>        <span class="comment"># 5 分钟后自动 promote</span></span><br></pre></td></tr></table></figure>

<ul>
<li>支持 analysis &#x2F; experiment 步骤</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">analysis:</span></span><br><span class="line">    <span class="attr">templates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">templateName:</span> <span class="string">success-rate</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">service-name</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">rollouts-demo-canary</span></span><br></pre></td></tr></table></figure>

<h3 id="流量导向图"><a href="#流量导向图" class="headerlink" title="流量导向图"></a>流量导向图</h3><p><a class="simple-lightbox" href="/2025/08/devops/argo/argorollout-ce-shi/img.png"><img   src="/images/loading.svg" data-src="/2025/08/devops/argo/argorollout-ce-shi/img.png"  alt="img.png" lazyload></a></p>
<h1 id="Argo-Rollout测试"><a href="#Argo-Rollout测试" class="headerlink" title="Argo Rollout测试"></a>Argo Rollout测试</h1><h2 id="前置准备-1"><a href="#前置准备-1" class="headerlink" title="前置准备"></a>前置准备</h2><p>使用准备好的yaml仓库，分别创建Repositories和Application</p>
<p>原始部署的镜像版本是V2:<br><a class="simple-lightbox" href="/2025/08/devops/argo/argorollout-ce-shi/img_9.png"><img   src="/images/loading.svg" data-src="/2025/08/devops/argo/argorollout-ce-shi/img_9.png"  alt="img_9.png" lazyload></a></p>
<h2 id="变更镜像版本为v1"><a href="#变更镜像版本为v1" class="headerlink" title="变更镜像版本为v1"></a>变更镜像版本为v1</h2><p>将&#x2F;charts&#x2F;ingress&#x2F;values.yaml内的imageTag由v2，变更为v1，并推送到远端：</p>
<p>如果此时通过argoCD查看，会发现会新建一个rs，并且rs拉起了v1版本的pod。<br><a class="simple-lightbox" href="/2025/08/devops/argo/argorollout-ce-shi/img_10.png"><img   src="/images/loading.svg" data-src="/2025/08/devops/argo/argorollout-ce-shi/img_10.png"  alt="img_10.png" lazyload></a></p>
<p>查看此时的流量分布情况：<br><a class="simple-lightbox" href="/2025/08/devops/argo/argorollout-ce-shi/img_12.png"><img   src="/images/loading.svg" data-src="/2025/08/devops/argo/argorollout-ce-shi/img_12.png"  alt="img_12.png" lazyload></a></p>
<h3 id="灰度步骤一：只起一个新版本Pod，并且仅可以通过携带X-Canary头请求"><a href="#灰度步骤一：只起一个新版本Pod，并且仅可以通过携带X-Canary头请求" class="headerlink" title="灰度步骤一：只起一个新版本Pod，并且仅可以通过携带X-Canary头请求"></a>灰度步骤一：只起一个新版本Pod，并且仅可以通过携带X-Canary头请求</h3><p>在灰度步骤一时，我们仅起了一个新版本Pod，并且没有设置流量，但是在ArgoCD的网络视图里，</p>
<p>新旧两个ingress-&gt;两个对应svc-&gt;对应Pod副本都是存在流量的。</p>
<p>通过脚本进行测试：不带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check  ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现所有请求的结果，都是旧版本的v2：{“message”:”v2”}</p>
<p>通过脚本进行测试：带X-Canary:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check -H &#x27;X-Canary: iwantsit&#x27; ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现所有请求的结果，都是新版本的v1：{“message”:”v1”}</p>
<p>通过脚本进行测试：带错误X-Canary:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check -H &#x27;X-Canary: huari&#x27; ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现所有请求的结果，都是旧版本的v2：{“message”:”v2”}</p>
<h3 id="灰度步骤二：20-流量到新版本"><a href="#灰度步骤二：20-流量到新版本" class="headerlink" title="灰度步骤二：20 % 流量到新版本"></a>灰度步骤二：20 % 流量到新版本</h3><p>继续推进到灰度步骤二：此时Pod版本数量未变，但切了20%的流量过去。</p>
<p>通过脚本进行测试：不带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check  ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现新版本v1的占比是14&#x2F;50，与切20%的流量大致一致</p>
<p>通过脚本进行测试：带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check -H &#x27;X-Canary: iwantsit&#x27; ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现所有请求的结果，都是新版本的v1：{“message”:”v1”}，因为使用了指定了X-Canary请求头，所以都是新版本v1的流量。</p>
<h3 id="灰度步骤三：40-流量到新版本"><a href="#灰度步骤三：40-流量到新版本" class="headerlink" title="灰度步骤三：40% 流量到新版本"></a>灰度步骤三：40% 流量到新版本</h3><p>继续推进到灰度步骤三：<br><a class="simple-lightbox" href="/./ArgoRollout%E6%B5%8B%E8%AF%95/img_17.png"><img   src="/images/loading.svg" data-src="/./ArgoRollout%E6%B5%8B%E8%AF%95/img_17.png"  alt="img_17.png" lazyload></a></p>
<p>此时Pod版本数量未变，但理论上应该切了40%的流量过去。<br>通过脚本进行测试：不带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check  ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现新版本v1的占比是19&#x2F;50，与切40%的流量大致一致</p>
<p>通过脚本进行测试：带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check -H &#x27;X-Canary: iwantsit&#x27; ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现所有请求的结果，都是新版本的v1：{“message”:”v1”}，因为使用了指定了X-Canary请求头，所以都是新版本v1的流量。</p>
<h3 id="灰度步骤四：60-流量到新版本"><a href="#灰度步骤四：60-流量到新版本" class="headerlink" title="灰度步骤四：60% 流量到新版本"></a>灰度步骤四：60% 流量到新版本</h3><p>继续推进到灰度步骤四：<br><a class="simple-lightbox" href="/2025/08/devops/argo/argorollout-ce-shi/img_20.png"><img   src="/images/loading.svg" data-src="/2025/08/devops/argo/argorollout-ce-shi/img_20.png"  alt="img_20.png" lazyload></a></p>
<p>此时Pod版本数量未变，但理论上应该切了60%的流量过去。</p>
<p>通过脚本进行测试：不带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check  ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现新版本v1的占比是28&#x2F;50，与切60%的流量大致一致</p>
<p>通过脚本进行测试：带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check -H &#x27;X-Canary: iwantsit&#x27; ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现所有请求的结果，都是新版本的v1：{“message”:”v1”}，因为使用了指定了X-Canary请求头，所以都是新版本v1的流量。</p>
<h3 id="灰度步骤五：100-流量到新版本"><a href="#灰度步骤五：100-流量到新版本" class="headerlink" title="灰度步骤五：100% 流量到新版本"></a>灰度步骤五：100% 流量到新版本</h3><p>继续推进到灰度步骤四：发现新版本rs先拉起了5个新版本Pod，并最后将旧版本的5个旧版本Pod释放</p>
<p>通过脚本进行测试：不带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check  ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现新版本v1的占比是50&#x2F;50，已经旧版本的Pod已经没有实例了</p>
<p>通过脚本进行测试：带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check -H &#x27;X-Canary: iwantsit&#x27; ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现所有请求的结果，都是新版本的v1：{“message”:”v1”}，因为使用了指定了X-Canary请求头，所以都是新版本v1的流量。</p>
<h2 id="变更镜像版本为v2"><a href="#变更镜像版本为v2" class="headerlink" title="变更镜像版本为v2"></a>变更镜像版本为v2</h2><p>将&#x2F;charts&#x2F;ingress&#x2F;values.yaml内的imageTag由v1，变更为v2，并将steps.setCanaryScale.replicas设置为2，也就是步骤一起两个实例，最后推送到远端：</p>
<p>此时新建了一个rs，并且镜像版本变更为v2:<br><a class="simple-lightbox" href="/2025/08/devops/argo/argorollout-ce-shi/img_27.png"><img   src="/images/loading.svg" data-src="/2025/08/devops/argo/argorollout-ce-shi/img_27.png"  alt="img_27.png" lazyload></a></p>
<h3 id="灰度步骤一：只起一个新版本Pod，并且仅可以通过携带X-Canary头请求-1"><a href="#灰度步骤一：只起一个新版本Pod，并且仅可以通过携带X-Canary头请求-1" class="headerlink" title="灰度步骤一：只起一个新版本Pod，并且仅可以通过携带X-Canary头请求"></a>灰度步骤一：只起一个新版本Pod，并且仅可以通过携带X-Canary头请求</h3><p>在灰度步骤一时，我们仅起了两个新版本Pod，并且没有设置流量，但是在ArgoCD的网络视图里，新旧两个ingress-&gt;两个对应svc-&gt;对应Pod副本都是存在流量的。</p>
<p>通过脚本进行测试：不带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check  ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现所有请求的结果，都是旧版本的v1：{“message”:”v1”}</p>
<p>通过脚本进行测试：带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check -H &#x27;X-Canary: iwantsit&#x27; ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现所有请求的结果，都是新版本的v2：{“message”:”v2”}</p>
<p>通过脚本进行测试：带错误X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check -H &#x27;X-Canary: huari&#x27; ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现所有请求的结果，都是旧版本的v1：{“message”:”v1”}</p>
<h3 id="灰度步骤二：20-流量到新版本-1"><a href="#灰度步骤二：20-流量到新版本-1" class="headerlink" title="灰度步骤二：20 % 流量到新版本"></a>灰度步骤二：20 % 流量到新版本</h3><p>继续推进到灰度步骤二：此时Pod版本数量未变，但理论上应该切了20%的流量过去。</p>
<p>通过脚本进行测试：不带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check  ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现新版本v2的占比是9&#x2F;50，与切20%的流量大致一致</p>
<p>通过脚本进行测试：带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check -H &#x27;X-Canary: iwantsit&#x27; ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现所有请求的结果，都是新版本的v2：{“message”:”v2”}，因为使用了指定了X-Canary请求头，所以都是新版本v2的流量。</p>
<h3 id="灰度步骤三：40-流量到新版本-1"><a href="#灰度步骤三：40-流量到新版本-1" class="headerlink" title="灰度步骤三：40% 流量到新版本"></a>灰度步骤三：40% 流量到新版本</h3><p>继续推进到灰度步骤三：此时Pod版本数量未变，但理论上应该切了40%的流量过去。</p>
<p>通过脚本进行测试：不带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check  ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现新版本v2的占比是21&#x2F;50，与切40%的流量大致一致</p>
<p>通过脚本进行测试：带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check -H &#x27;X-Canary: iwantsit&#x27; ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现所有请求的结果，都是新版本的v2：{“message”:”v2”}，因为使用了指定了X-Canary请求头，所以都是新版本v2的流量。</p>
<h3 id="灰度步骤四：60-流量到新版本-1"><a href="#灰度步骤四：60-流量到新版本-1" class="headerlink" title="灰度步骤四：60% 流量到新版本"></a>灰度步骤四：60% 流量到新版本</h3><p>继续推进到灰度步骤四：<br><a class="simple-lightbox" href="/2025/08/devops/argo/argorollout-ce-shi/img_36.png"><img   src="/images/loading.svg" data-src="/2025/08/devops/argo/argorollout-ce-shi/img_36.png"  alt="img_36.png" lazyload></a></p>
<p>此时Pod版本数量未变，但理论上应该切了60%的流量过去。</p>
<p>通过脚本进行测试：不带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check  ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v1&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现新版本v2的占比是29&#x2F;50，与切60%的流量大致一致</p>
<p>通过脚本进行测试：带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check -H &#x27;X-Canary: iwantsit&#x27; ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现所有请求的结果，都是新版本的v2：{“message”:”v2”}，因为使用了指定了X-Canary请求头，所以都是新版本v2的流量。</p>
<h3 id="灰度步骤五：100-流量到新版本-1"><a href="#灰度步骤五：100-流量到新版本-1" class="headerlink" title="灰度步骤五：100% 流量到新版本"></a>灰度步骤五：100% 流量到新版本</h3><p>继续推进到灰度步骤四：<br><a class="simple-lightbox" href="/2025/08/devops/argo/argorollout-ce-shi/img_41.png"><img   src="/images/loading.svg" data-src="/2025/08/devops/argo/argorollout-ce-shi/img_41.png"  alt="img_41.png" lazyload></a></p>
<p>发现新版本rs先拉起了5个新版本Pod，并最后将旧版本的5个旧版本Pod释放</p>
<p>通过脚本进行测试：不带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check  ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现新版本v2的占比是50&#x2F;50，旧版本的Pod已经没有实例了</p>
<p>通过脚本进行测试：带X-Canary</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..50&#125;; do curl http://bkce7-dev.hua-ri.cn/api/check -H &#x27;X-Canary: iwantsit&#x27; ; done</span><br></pre></td></tr></table></figure>

<p>批量请求结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;&#123;&quot;message&quot;:&quot;v2&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>发现所有请求的结果，都是新版本的v2：{“message”:”v2”}，因为使用了指定了X-Canary请求头，所以都是新版本v2的流量。</p>

        </div>
          
        <div class="top-div">
          <ol class="top-box"><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#%E5%89%8D%E7%BD%AE%E5%87%86%E5%A4%87"><span class="top-box-text">前置准备</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#ArgoCD%E9%83%A8%E7%BD%B2"><span class="top-box-text">ArgoCD部署</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%87%86%E5%A4%87%E5%9F%9F%E5%90%8D%E5%8F%8ASSL%E8%AF%81%E4%B9%A6"><span class="top-box-text">准备域名及SSL证书</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E9%83%A8%E7%BD%B2argocd"><span class="top-box-text">部署argocd</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E8%AE%BF%E9%97%AEArgo-CD-Server%E6%9C%8D%E5%8A%A1"><span class="top-box-text">访问Argo-CD Server服务</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#Argo-Rollout%E9%83%A8%E7%BD%B2"><span class="top-box-text">Argo Rollout部署</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%BA%94%E7%94%A8%E6%B5%8B%E8%AF%95%E4%BB%93%E5%BA%93"><span class="top-box-text">应用测试仓库</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#main-go"><span class="top-box-text">main.go</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#Dockerfile"><span class="top-box-text">Dockerfile</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#Makefile"><span class="top-box-text">Makefile</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E6%89%93%E6%B5%8B%E8%AF%95%E9%95%9C%E5%83%8F"><span class="top-box-text">打测试镜像</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#yaml%E6%B5%8B%E8%AF%95%E4%BB%93%E5%BA%93"><span class="top-box-text">yaml测试仓库</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#values-yaml"><span class="top-box-text">values.yaml</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#charts-ingress-values-yaml"><span class="top-box-text">&#x2F;charts&#x2F;ingress&#x2F;values.yaml</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#charts-ingress-Chart-yaml"><span class="top-box-text">&#x2F;charts&#x2F;ingress&#x2F;Chart.yaml</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#charts-ingress-helmignore"><span class="top-box-text">&#x2F;charts&#x2F;ingress&#x2F;.helmignore</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#charts-ingress-templates-ingress-yaml"><span class="top-box-text">&#x2F;charts&#x2F;ingress&#x2F;templates&#x2F;ingress.yaml</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#charts-ingress-templates-rollout-yaml"><span class="top-box-text">&#x2F;charts&#x2F;ingress&#x2F;templates&#x2F;rollout.yaml</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#charts-ingress-templates-service-yaml"><span class="top-box-text">&#x2F;charts&#x2F;ingress&#x2F;templates&#x2F;service.yaml</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90rollout-yaml"><span class="top-box-text">详细分析rollout.yaml</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E6%B5%81%E9%87%8F%E5%AF%BC%E5%90%91%E5%9B%BE"><span class="top-box-text">流量导向图</span></a></li></ol></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#Argo-Rollout%E6%B5%8B%E8%AF%95"><span class="top-box-text">Argo Rollout测试</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%89%8D%E7%BD%AE%E5%87%86%E5%A4%87-1"><span class="top-box-text">前置准备</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%8F%98%E6%9B%B4%E9%95%9C%E5%83%8F%E7%89%88%E6%9C%AC%E4%B8%BAv1"><span class="top-box-text">变更镜像版本为v1</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E7%81%B0%E5%BA%A6%E6%AD%A5%E9%AA%A4%E4%B8%80%EF%BC%9A%E5%8F%AA%E8%B5%B7%E4%B8%80%E4%B8%AA%E6%96%B0%E7%89%88%E6%9C%ACPod%EF%BC%8C%E5%B9%B6%E4%B8%94%E4%BB%85%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E6%90%BA%E5%B8%A6X-Canary%E5%A4%B4%E8%AF%B7%E6%B1%82"><span class="top-box-text">灰度步骤一：只起一个新版本Pod，并且仅可以通过携带X-Canary头请求</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E7%81%B0%E5%BA%A6%E6%AD%A5%E9%AA%A4%E4%BA%8C%EF%BC%9A20-%E6%B5%81%E9%87%8F%E5%88%B0%E6%96%B0%E7%89%88%E6%9C%AC"><span class="top-box-text">灰度步骤二：20 % 流量到新版本</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E7%81%B0%E5%BA%A6%E6%AD%A5%E9%AA%A4%E4%B8%89%EF%BC%9A40-%E6%B5%81%E9%87%8F%E5%88%B0%E6%96%B0%E7%89%88%E6%9C%AC"><span class="top-box-text">灰度步骤三：40% 流量到新版本</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E7%81%B0%E5%BA%A6%E6%AD%A5%E9%AA%A4%E5%9B%9B%EF%BC%9A60-%E6%B5%81%E9%87%8F%E5%88%B0%E6%96%B0%E7%89%88%E6%9C%AC"><span class="top-box-text">灰度步骤四：60% 流量到新版本</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E7%81%B0%E5%BA%A6%E6%AD%A5%E9%AA%A4%E4%BA%94%EF%BC%9A100-%E6%B5%81%E9%87%8F%E5%88%B0%E6%96%B0%E7%89%88%E6%9C%AC"><span class="top-box-text">灰度步骤五：100% 流量到新版本</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%8F%98%E6%9B%B4%E9%95%9C%E5%83%8F%E7%89%88%E6%9C%AC%E4%B8%BAv2"><span class="top-box-text">变更镜像版本为v2</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E7%81%B0%E5%BA%A6%E6%AD%A5%E9%AA%A4%E4%B8%80%EF%BC%9A%E5%8F%AA%E8%B5%B7%E4%B8%80%E4%B8%AA%E6%96%B0%E7%89%88%E6%9C%ACPod%EF%BC%8C%E5%B9%B6%E4%B8%94%E4%BB%85%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E6%90%BA%E5%B8%A6X-Canary%E5%A4%B4%E8%AF%B7%E6%B1%82-1"><span class="top-box-text">灰度步骤一：只起一个新版本Pod，并且仅可以通过携带X-Canary头请求</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E7%81%B0%E5%BA%A6%E6%AD%A5%E9%AA%A4%E4%BA%8C%EF%BC%9A20-%E6%B5%81%E9%87%8F%E5%88%B0%E6%96%B0%E7%89%88%E6%9C%AC-1"><span class="top-box-text">灰度步骤二：20 % 流量到新版本</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E7%81%B0%E5%BA%A6%E6%AD%A5%E9%AA%A4%E4%B8%89%EF%BC%9A40-%E6%B5%81%E9%87%8F%E5%88%B0%E6%96%B0%E7%89%88%E6%9C%AC-1"><span class="top-box-text">灰度步骤三：40% 流量到新版本</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E7%81%B0%E5%BA%A6%E6%AD%A5%E9%AA%A4%E5%9B%9B%EF%BC%9A60-%E6%B5%81%E9%87%8F%E5%88%B0%E6%96%B0%E7%89%88%E6%9C%AC-1"><span class="top-box-text">灰度步骤四：60% 流量到新版本</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E7%81%B0%E5%BA%A6%E6%AD%A5%E9%AA%A4%E4%BA%94%EF%BC%9A100-%E6%B5%81%E9%87%8F%E5%88%B0%E6%96%B0%E7%89%88%E6%9C%AC-1"><span class="top-box-text">灰度步骤五：100% 流量到新版本</span></a></li></ol></li></ol></li></ol>
        </div>
          
      </div>
    </div>

    
      <div class="next-post">
        <a class="purple-link" href="/2025/08/llm/coze/dockercompose-bu-shu-coze/">
          <h3 class="post-title">
            
            下一篇：DockerCompose部署Coze
          </h3>
        </a>
      </div>
    
  </div>










<footer>
<div class="site-footer">
  <div class="social-container">
    
      
        <a aria-label="跳转至github" href="https://github.com/f-dong" target="_blank">
          <i class="icon icon-github"></i>
        </a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  </div>
  
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a>
  
  
  
  
  
  
</div>
</footer>


      </div>
    </div>
    
<script id="hexo-configurations"> window.theme_config = {"image":{"lazyload_enable":true,"lazyload_placeholder":null,"photo_zoom":"simple-lightbox"},"search":{"enable":true,"type":"json","placeholder":"输入关键词搜索...","algolia":{"appID":"","apiKey":"","indexName":""}},"language":"zh-Hans"}; window.is_post = true; </script>

<script src="/js/main.js"></script>






  <script src="/js/simple-lightbox.min.js"></script><script>document.addEventListener('DOMContentLoaded', function() {new SimpleLightbox('.post-detail .simple-lightbox', {fileExt: false,captionsData:'alt'});});</script></body>
</html>

