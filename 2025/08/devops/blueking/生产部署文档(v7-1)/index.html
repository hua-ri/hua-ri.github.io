<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="google-site-verification" content="TZE0rZyIqLl10trYu3BWBWa1Vmz6HFwhb2OcNEK4u-s" />
     <link rel="shortcut icon" href= /img/favicon.ico >
    <title>
        花日の博客
    </title>
    <meta name="description" content= 嘿，我是花日，这是我的博客。欢迎访问！ >
    <meta name="keywords" content=  >
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>
<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-home
 replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            生产部署文档(v7-1)
        </p>
        <hr>
    </div>
    <div class="post-content">
        <h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>需要先准备一台中控机，在中控机安装 kubectl、helm、helmfile 等工具，以及蓝鲸安装脚本。然后部署基础套餐，最后再部署持续集成套餐（蓝盾）。</p>
<p>简单来说就是三个步骤：</p>
<ul>
<li><code>1.准备环境</code> </li>
<li><code>2.部署基础服务</code> </li>
<li><code>3.部署蓝盾</code></li>
</ul>
<h1 id="2-准备中控机"><a href="#2-准备中控机" class="headerlink" title="2. 准备中控机"></a>2. 准备中控机</h1><p>按照<a target="_blank" rel="noopener" href="https://bk.tencent.com/docs/markdown/ZH/DeploymentGuides/7.1/prepare-bkctrl.md">官方文档</a>安装和配置即可。</p>
<h1 id="3-部署基础服务"><a href="#3-部署基础服务" class="headerlink" title="3. 部署基础服务"></a>3. 部署基础服务</h1><p>需要按照<a target="_blank" rel="noopener" href="https://bk.tencent.com/docs/markdown/ZH/DeploymentGuides/7.1/custom-values.md">官方文档</a>一步步部署。</p>
<h2 id="3-1-下载安装文件"><a href="#3-1-下载安装文件" class="headerlink" title="3.1 下载安装文件"></a>3.1 下载安装文件</h2><p>请在 中控机 使用下载脚本下载蓝鲸 helmfile 包及公共证书。（ helmfile相关value文件在git上维护）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bkdl-7.1-stable.sh -ur latest base demo</span><br></pre></td></tr></table></figure>

<p>这些文件默认放在了 ~&#x2F;bkce7.1-install&#x2F; 目录。</p>
<h2 id="3-2-配置-Helm-Chart-仓库"><a href="#3-2-配置-Helm-Chart-仓库" class="headerlink" title="3.2 配置 Helm Chart 仓库"></a>3.2 配置 Helm Chart 仓库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add blueking https://hub.bktencent.com/chartrepo/blueking</span><br><span class="line">helm repo update</span><br><span class="line">helm repo list</span><br></pre></td></tr></table></figure>

<h2 id="3-3-配置全局-custom-values"><a href="#3-3-配置全局-custom-values" class="headerlink" title="3.3 配置全局 custom-values"></a>3.3 配置全局 custom-values</h2><p>相关文件已经修改，在git上维护，配置访问域名。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BK_DOMAIN=bk.blazehu.com  # 请修改为你分配给蓝鲸平台的主域名 cd ~/bkce7.1-install/blueking/  # 进入工作目录# 可使用如下命令添加域名。如果文件已存在，请手动编辑。custom=environments/default/custom.yaml</span><br><span class="line">cat &gt;&gt; &quot;$custom&quot; &lt;&lt;EOF</span><br><span class="line">imageRegistry: $&#123;REGISTRY:-hub.bktencent.com&#125;</span><br><span class="line">domain:</span><br><span class="line">  bkDomain: $BK_DOMAIN</span><br><span class="line">  bkMainSiteDomain: $BK_DOMAIN</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="3-4-生成-values-文件"><a href="#3-4-生成-values-文件" class="headerlink" title="3.4 生成 values 文件"></a>3.4 生成 values 文件</h2><p>还有一些 values 文件随着部署环境的不同而变化，所以我们提供了脚本快速生成。</p>
<p><code>生成蓝鲸 app code 对应的 secret</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./scripts/generate_app_secret.sh ./environments/default/app_secret.yaml</span><br></pre></td></tr></table></figure>

<p><code>生成 apigw 所需的 keypair</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./scripts/generate_rsa_keypair.sh ./environments/default/bkapigateway_builtin_keypair.yaml</span><br></pre></td></tr></table></figure>

<p><code>生成 paas 所需的 clusterAdmin</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./scripts/create_k8s_cluster_admin_for_paas3.sh</span><br></pre></td></tr></table></figure>

<h2 id="3-5-安装入口网关"><a href="#3-5-安装入口网关" class="headerlink" title="3.5 安装入口网关"></a>3.5 安装入口网关</h2><h3 id="3-5-1-安装-ingress-controller"><a href="#3-5-1-安装-ingress-controller" class="headerlink" title="3.5.1 安装 ingress controller"></a>3.5.1 安装 ingress controller</h3><p>先检查你的环境是否已经部署了 ingress controller:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -A -l app.kubernetes.io/name=ingress-nginx</span><br></pre></td></tr></table></figure>

<p>如果没有，则使用如下命令创建：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helmfile -f 00-ingress-nginx.yaml.gotmpl sync</span><br><span class="line">kubectl get pods -A -l app.kubernetes.io/name=ingress-nginx  查看创建的pod</span><br></pre></td></tr></table></figure>

<p>pops集群相关标签如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -A -l app=ingress-nginx  # 查看创建的pod</span><br><span class="line">IP1=$(kubectl get svc -A -l app=nginx-ingress-lb -o jsonpath=&#x27;&#123;.items[0].status.loadBalancer.ingress[0].ip&#125;&#x27;)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IP1=$(kubectl get svc -A -l app.kubernetes.io/name=ingress-nginx -o jsonpath=<span class="string">&#x27;&#123;.items[0].status.loadBalancer.ingress[0].ip&#125;&#x27;</span>)</span></span><br></pre></td></tr></table></figure>

<h3 id="3-5-2-配置-coredns"><a href="#3-5-2-配置-coredns" class="headerlink" title="3.5.2 配置 coredns"></a>3.5.2 配置 coredns</h3><p>在部署过程中，会在容器内访问这些域名，所以需要提前配置 coredns，将蓝鲸域名解析到 service IP。</p>
<blockquote>
<p>注意: 当 service 被删除，重建后 clusterIP 会变动，此时需刷新 hosts 文件。</p>
</blockquote>
<p>因此需要注入 hosts 配置项到 <code>kube-system</code> namespace 下的 <code>coredns</code> 系列 pod</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  # 进入工作目录</span><br><span class="line">BK_DOMAIN=$(yq e &#x27;.domain.bkDomain&#x27; environments/default/custom.yaml)  # 从自定义配置中提取, 也可自行赋值</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">IP1=$(kubectl get svc -A -l app.kubernetes.io/instance=ingress-nginx -o jsonpath=<span class="string">&#x27;&#123;.items[0].spec.clusterIP&#125;&#x27;</span>)</span></span><br><span class="line">IP1=$(kubectl get svc -A -l app=nginx-ingress-lb -o jsonpath=&#x27;&#123;.items[0].status.loadBalancer.ingress[0].ip&#125;&#x27;)</span><br><span class="line">./scripts/control_coredns.sh update &quot;$IP1&quot; $BK_DOMAIN bkrepo.$BK_DOMAIN docker.$BK_DOMAIN bkapi.$BK_DOMAIN bkpaas.$BK_DOMAIN bkiam-api.$BK_DOMAIN bkiam.$BK_DOMAIN apps.$BK_DOMAIN bknodeman.$BK_DOMAIN job.$BK_DOMAIN jobapi.$BK_DOMAIN</span><br><span class="line">./scripts/control_coredns.sh update &quot;$IP1&quot; devops.$BK_DOMAIN</span><br><span class="line">./scripts/control_coredns.sh list  # 检查添加的记录。</span><br></pre></td></tr></table></figure>

<p>确认注入结果，执行如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  进入工作目录</span><br><span class="line">./scripts/control_coredns.sh list</span><br></pre></td></tr></table></figure>

<p>参考输出如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">172.27.124.109 bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkrepo.bkce.diezhi.net</span><br><span class="line">172.27.124.109 docker.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkapi.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkpaas.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkiam-api.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkiam.bkce.diezhi.net</span><br><span class="line">172.27.124.109 apps.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bknodeman.bkce.diezhi.net</span><br><span class="line">172.27.124.109 job.bkce.diezhi.net</span><br><span class="line">172.27.124.109 jobapi.bkce.diezhi.net</span><br><span class="line">172.27.124.109 devops.bkce.diezhi.net</span><br></pre></td></tr></table></figure>

<h2 id="3-6-部署或对接存储服务"><a href="#3-6-部署或对接存储服务" class="headerlink" title="3.6 部署或对接存储服务"></a>3.6 部署或对接存储服务</h2><h3 id="3-6-1-部署蓝鲸预置的存储服务"><a href="#3-6-1-部署蓝鲸预置的存储服务" class="headerlink" title="3.6.1 部署蓝鲸预置的存储服务"></a>3.6.1 部署蓝鲸预置的存储服务</h3><p>参考<a target="_blank" rel="noopener" href="https://bk.tencent.com/docs/markdown/ZH/DeploymentGuides/7.1/storage-services.md">官方文档</a>安装，相关helm配置已经放在<a target="_blank" rel="noopener" href="https://opsgit.papegames.com/infra/devops">gitlab仓库</a>上维护，可以直接简单执行以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helmfile -f base-storage.yaml.gotmpl sync</span><br></pre></td></tr></table></figure>

<h3 id="3-6-2-对接已有的存储服务"><a href="#3-6-2-对接已有的存储服务" class="headerlink" title="3.6.2 对接已有的存储服务"></a>3.6.2 对接已有的存储服务</h3><p>禁用蓝鲸内置服务，配置使用已有服务。helmfile 定义及 values 文件已经放在gitlab仓库上维护。</p>
<p>此处可直接跳过。</p>
<h2 id="3-7-部署基础套餐"><a href="#3-7-部署基础套餐" class="headerlink" title="3.7 部署基础套餐"></a>3.7 部署基础套餐</h2><p>通过helmfile安装 base-blueking.yaml.gotmpl ，按照顺序依次安装。具体每层安装的内容可以查看文件内容。<br>参考<a target="_blank" rel="noopener" href="https://bk.tencent.com/docs/markdown/ZH/DeploymentGuides/7.1/storage-services.md">官方文档</a>安装，相关helm配置已经放在gitlab仓库上维护，可以直接简单执行以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helmfile -f base-blueking.yaml.gotmpl -l seq=first sync</span><br><span class="line">helmfile -f base-blueking.yaml.gotmpl -l seq=second sync</span><br><span class="line">helmfile -f base-blueking.yaml.gotmpl -l seq=third sync</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">helmfile -f base-blueking.yaml.gotmpl -l <span class="built_in">seq</span>=fourth <span class="built_in">sync</span></span></span><br></pre></td></tr></table></figure>

<h2 id="3-8-访问蓝鲸桌面"><a href="#3-8-访问蓝鲸桌面" class="headerlink" title="3.8 访问蓝鲸桌面"></a>3.8 访问蓝鲸桌面</h2><p>在负载均衡器配置后端为 ingress-nginx pod 所在机器的内网 IP，端口为 80。详细信息参考<a target="_blank" rel="noopener" href="https://bk.tencent.com/docs/markdown/ZH/DeploymentGuides/7.1/manual-install-bkce.md">文档</a>。</p>
<h3 id="3-8-1-查找ingress-nginx-svc"><a href="#3-8-1-查找ingress-nginx-svc" class="headerlink" title="3.8.1 查找ingress nginx svc"></a>3.8.1 查找ingress nginx svc</h3><p>找到ingress nginx的svc</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pops</span></span><br><span class="line">kubectl get svc -n kube-system|grep ingress</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pops-dev</span></span><br><span class="line">kubectl get svc -n ingress-nginx|grep ingress</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pops</span></span><br><span class="line">ingress-nginx-controller-admission        ClusterIP      172.26.10.30    &lt;none&gt;          443/TCP                        3y69d</span><br><span class="line">nginx-ingress-lb                          LoadBalancer   172.26.1.155    10.212.14.158   80:30725/TCP,443:31357/TCP     3y69d</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pops-dev</span></span><br><span class="line">ingress-nginx-controller             NodePort    172.27.124.109   &lt;none&gt;        80:32080/TCP,443:32443/TCP   279d</span><br><span class="line">ingress-nginx-controller-admission   ClusterIP   172.27.123.38    &lt;none&gt;        443/TCP                      279d</span><br><span class="line">ingress-nginx-controller-metrics     ClusterIP   172.27.116.175   &lt;none&gt;        10254/TCP                    279d</span><br></pre></td></tr></table></figure>

<p>这里<code>nginx-ingress-lb</code>是目前<code>pops集群</code>的<code>ingress nginx svc</code>，而<code>ingress-nginx-controller</code>是目前<code>pops-dev集群</code>的<code>ingress nginx svc</code>。</p>
<h3 id="3-8-2-设置svc-type为LoadBalancer"><a href="#3-8-2-设置svc-type为LoadBalancer" class="headerlink" title="3.8.2 设置svc type为LoadBalancer"></a>3.8.2 设置svc type为LoadBalancer</h3><p>查看svc type：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看pops集群ingress nginx svc命令</span></span><br><span class="line">kubectl get svc/nginx-ingress-lb -n kube-system -oyaml|grep type</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看pops-dev集群ingress nginx svc命令</span></span><br><span class="line">kubectl get svc/ingress-nginx-controller -n ingress-nginx -oyaml|grep type</span><br></pre></td></tr></table></figure>

<p>若无<code>type: LoadBalancer</code>结果，则手动进行修改：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改pops集群ingress nginx svc命令</span></span><br><span class="line">kubectl edit svc/nginx-ingress-lb -n kube-system</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改pops-dev集群ingress nginx svc命令</span></span><br><span class="line">kubectl edit svc/ingress-nginx-controller -n ingress-nginx</span><br></pre></td></tr></table></figure>

<h3 id="3-8-3-负载均衡clb实例"><a href="#3-8-3-负载均衡clb实例" class="headerlink" title="3.8.3 负载均衡clb实例"></a>3.8.3 负载均衡clb实例</h3><p>查看svc yaml是否包含两个重要annotation：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看pops集群ingress nginx svc命令</span></span><br><span class="line">kubectl get svc/nginx-ingress-lb -n kube-system -oyaml|grep service.beta.kubernetes.io/alibaba-cloud-loadbalancer-force-override-listeners</span><br><span class="line">kubectl get svc/nginx-ingress-lb -n kube-system -oyaml|grep service.beta.kubernetes.io/alibaba-cloud-loadbalancer-id</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看pops-dev集群ingress nginx svc命令</span></span><br><span class="line">kubectl get svc/ingress-nginx-controller -n ingress-nginx -oyaml|grep service.beta.kubernetes.io/alibaba-cloud-loadbalancer-force-override-listeners</span><br><span class="line">kubectl get svc/ingress-nginx-controller -n ingress-nginx -oyaml|grep service.beta.kubernetes.io/alibaba-cloud-loadbalancer-id</span><br></pre></td></tr></table></figure>

<p>若这两个重要annotation缺失，则需进行设置。</p>
<p>负载均衡控制台地址：<a target="_blank" rel="noopener" href="https://slb.console.aliyun.com/overview">https://slb.console.aliyun.com/overview</a></p>
<p>找到<code>pops-dev</code>集群的clb：<code>pops-k8s-dev-ingress</code><br><img src="/img_12.png" alt="img_12.png"></p>
<p>找到<code>pops</code>集群的clb：<code>k8s-pops-ingress-slb</code><br><img src="/img_14.png" alt="img_14.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改pops集群ingress nginx svc命令</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pops集群clb名称：k8s-pops-ingress-slb</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pops集群clb <span class="built_in">id</span>：lb-bp1tt6vxctuzi38mqfkw0</span></span><br><span class="line">kubectl edit svc/nginx-ingress-lb -n kube-system</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改pops-dev集群ingress nginx svc命令</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pops-dev集群clb名称：pops-k8s-dev-ingress</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pops-dev集群clb <span class="built_in">id</span>：lb-bp1r1dsywnqktp1hxih38</span></span><br><span class="line">kubectl edit svc/ingress-nginx-controller -n ingress-nginx</span><br></pre></td></tr></table></figure>

<h3 id="3-8-4-访问地址"><a href="#3-8-4-访问地址" class="headerlink" title="3.8.4 访问地址"></a>3.8.4 访问地址</h3><p>查看浏览器访问地址：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  # 进入工作目录</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从自定义配置中提取</span></span><br><span class="line">BK_DOMAIN=$(yq e &#x27;.domain.bkDomain&#x27; environments/default/custom.yaml)  </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">普通登录地址(接入统一登录，且登录成功后会跳转蓝盾)</span></span><br><span class="line">echo &quot;http://$BK_DOMAIN&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">admin登录地址(接入统一登录后，可通过此方法适用admin登录)</span></span><br><span class="line">echo &quot;http://$&#123;BK_DOMAIN&#125;/login/origin/&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试环境一般结果为：http://bkce.diezhi.net/login/origin/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生产环境一般结果为：https://bk.diezhi.net/login/origin/</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看用户密码(预设原始密码)：</span></span><br><span class="line">kubectl get cm -n blueking bk-user-api-general-envs -o go-template=&#x27;user=&#123;&#123;.data.INITIAL_ADMIN_USERNAME&#125;&#125;&#123;&#123;&quot;\n&quot;&#125;&#125;password=&#123;&#123; .data.INITIAL_ADMIN_PASSWORD &#125;&#125;&#123;&#123;&quot;\n&quot;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="3-9-对接Ldap服务"><a href="#3-9-对接Ldap服务" class="headerlink" title="3.9 对接Ldap服务"></a>3.9 对接Ldap服务</h2><p>在用户中心里配置Ldap相关配置，然后更新 bk-user-api-web 服务的镜像。<br><img src="/img_22.png" alt="img_22.png"><br><img src="/img_23.png" alt="img_23.png"></p>
<h1 id="4-部署蓝盾"><a href="#4-部署蓝盾" class="headerlink" title="4. 部署蓝盾"></a>4. 部署蓝盾</h1><p>参考<a target="_blank" rel="noopener" href="https://bk.tencent.com/docs/markdown/ZH/DeploymentGuides/7.1/install-ci-suite.md">官方文档</a>部署，配置 custom values 的内容提前修改完成，执行类似部署基础服务的以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  # 进入工作目录</span><br><span class="line">helmfile -f 03-bkci.yaml.gotmpl sync  # 部署</span><br><span class="line">helmfile -f 03-bkci.yaml.gotmpl apply # 更新</span><br></pre></td></tr></table></figure>
<p>剩下的步骤参考官方文档执行即可，主要步骤有以下三个，其他的步骤可以不做。</p>
<h2 id="4-1-可选-注册默认构建镜像"><a href="#4-1-可选-注册默认构建镜像" class="headerlink" title="4.1 [可选]注册默认构建镜像"></a>4.1 [可选]注册默认构建镜像</h2><p>我们提供了 bkci&#x2F;ci 镜像用于提供构建环境。为了加速镜像下载过程，可以修改镜像地址为 hub.bktencent.com&#x2F;bkci&#x2F;ci，或者为你自己托管的内网 registry。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it -n blueking bk-ci-mysql-0 -- /bin/bash -c &#x27;MYSQL_PWD=&quot;$MYSQL_ROOT_PASSWORD&quot; mysql -u root -e &quot;USE devops_ci_store; SELECT IMAGE_NAME,IMAGE_CODE,IMAGE_REPO_NAME FROM T_IMAGE WHERE IMAGE_CODE = \&quot;bkci\&quot; ;&quot;&#x27;</span><br></pre></td></tr></table></figure>

<p>请根据结果进行操作：</p>
<ul>
<li><p>如果有显示镜像数据，可以修改镜像地址为蓝鲸国内仓库，也可改为你已经缓存在内网的镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it -n blueking bk-ci-mysql-0 -- /bin/bash -c &#x27;MYSQL_PWD=&quot;$MYSQL_ROOT_PASSWORD&quot; mysql -u root -e &quot;USE devops_ci_store; UPDATE  T_IMAGE SET IMAGE_REPO_NAME=\&quot;hub.bktencent.com/bkci/ci\&quot; WHERE IMAGE_CODE = \&quot;bkci\&quot; ;&quot;&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后重新查询数据库，可以看到 IMAGE_REPO_NAME 列已经更新。</p>
</li>
<li><p>如果没有镜像，可以新增：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -n blueking deploy/bk-ci-bk-ci-store -- \curl -vs http://bk-ci-bk-ci-store.blueking.svc.cluster.local/api/op/market/image/init -X POST \-H &#x27;X-DEVOPS-UID: admin&#x27; -H &#x27;Content-type: application/json&#x27; -d &#x27;&#123;&quot;imageCode&quot;:&quot;bkci&quot;,&quot;imageName&quot;:&quot;bkci&quot;,&quot;imageRepo&quot;:&quot;hub.bktencent.com/bkci/ci&quot;,&quot;projectCode&quot;:&quot;demo&quot;,&quot;userId&quot;:&quot;admin&quot;&#125;&#x27; | jq .</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<ul>
<li>提示</li>
<li>当你单独卸载蓝盾重装后，可能出现查询镜像为空，但是新增镜像时报错 { status: 400, message: “权限中心创建项目失败” } 的情况。这是因为权限中心存在蓝盾 demo 项目的数据所致，我们后续会优化蓝盾单独卸载的文档。请先手动新建项目，并修改上述代码中 projectCode 字段的值。</li>
</ul>
</blockquote>
<h3 id="4-1-1-解决权限中心创建项目失败"><a href="#4-1-1-解决权限中心创建项目失败" class="headerlink" title="4.1.1 解决权限中心创建项目失败"></a>4.1.1 解决权限中心创建项目失败</h3><p>在 中控机 执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  # 进入工作目录</span><br><span class="line">./scripts/control_coredns.sh list  # 检查添加的记录。</span><br></pre></td></tr></table></figure>

<p>会得到类似的结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">172.27.124.109 devops.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkrepo.bkce.diezhi.net</span><br><span class="line">172.27.124.109 docker.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkapi.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkpaas.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkiam-api.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkiam.bkce.diezhi.net</span><br><span class="line">172.27.124.109 apps.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bknodeman.bkce.diezhi.net</span><br><span class="line">172.27.124.109 job.bkce.diezhi.net</span><br><span class="line">172.27.124.109 jobapi.bkce.diezhi.net</span><br></pre></td></tr></table></figure>

<p>使用admin账号通过浏览器访问devops.bkce.diezhi.net，并创建项目：<br><img src="/img_15.png" alt="img_15.png"></p>
<p><img src="/img_16.png" alt="img_16.png"></p>
<p><img src="/img_17.png" alt="img_17.png"></p>
<p>此时重新新增：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -n blueking deploy/bk-ci-bk-ci-store -- \curl -vs http://bk-ci-bk-ci-store.blueking.svc.cluster.local/api/op/market/image/init -X POST \-H &#x27;X-DEVOPS-UID: admin&#x27; -H &#x27;Content-type: application/json&#x27; -d &#x27;&#123;&quot;imageCode&quot;:&quot;bkci&quot;,&quot;imageName&quot;:&quot;bkci&quot;,&quot;imageRepo&quot;:&quot;hub.bktencent.com/bkci/ci&quot;,&quot;projectCode&quot;:&quot;huari-demo&quot;,&quot;userId&quot;:&quot;admin&quot;&#125;&#x27; | jq .</span><br></pre></td></tr></table></figure>

<p>如新建项目遇见可授权人员范围加载不出来(白屏转圈圈)</p>
<p>需要确定跳转从蓝鲸跳转蓝盾是否是走了https，本文档是使用http部署，所以使用https会出现问题<br><img src="/img_18.png" alt="img_18.png"></p>
<h2 id="4-2-可跳过-对接制品库"><a href="#4-2-可跳过-对接制品库" class="headerlink" title="4.2 [可跳过]对接制品库"></a>4.2 [可跳过]对接制品库</h2><p>蓝盾依靠蓝鲸制品库来提供流水线仓库和自定义仓库，需要调整制品库的认证模式。</p>
<p>当 <code>bk-ci</code> release 成功启动后，我们开始配置蓝鲸制品库，并注册到蓝盾中。</p>
<h3 id="4-2-1-修改-bk-repo-custom-values"><a href="#4-2-1-修改-bk-repo-custom-values" class="headerlink" title="4.2.1 修改 bk-repo custom values"></a>4.2.1 修改 bk-repo custom values</h3><p>相关配置已经放在gitlab仓库上维护，可以直接跳过本步骤。</p>
<p>[可跳过]请在 中控机 执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  # 进入工作目录</span><br><span class="line">case $(yq e &#x27;.auth.config.realm&#x27; environments/default/bkrepo-custom-values.yaml.gotmpl 2&gt;/dev/null) in</span><br><span class="line">  null|&quot;&quot;)</span><br><span class="line">    tee -a environments/default/bkrepo-custom-values.yaml.gotmpl &lt;&lt;&lt; $&#x27;auth:\n  config:\n    realm: devops&#x27;</span><br><span class="line">  ;;</span><br><span class="line">  devops)</span><br><span class="line">    echo &quot;environments/default/bkrepo-custom-values.yaml.gotmpl 中配置了 .auth.config.realm=devops, 无需修改.&quot;</span><br><span class="line">  ;;</span><br><span class="line">  *)</span><br><span class="line">    echo &quot;environments/default/bkrepo-custom-values.yaml.gotmpl 中配置了 .auth.config.realm 为其他值, 请手动修改值为 devops.&quot;</span><br><span class="line">  ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<p>[可跳过]修改成功后，继续在工作目录执行如下命令使修改生效：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helmfile -f base-blueking.yaml.gotmpl -l name=bk-repo apply</span><br></pre></td></tr></table></figure>

<h3 id="4-2-2-检查配置是否生效"><a href="#4-2-2-检查配置是否生效" class="headerlink" title="4.2.2 检查配置是否生效"></a>4.2.2 检查配置是否生效</h3><p>检查 release 生效的 values 和 configmap 是否重新渲染。</p>
<p>[可跳过]请在 中控机 执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm get values -n blueking bk-repo | yq e &#x27;.auth.config.realm&#x27;</span><br><span class="line">kubectl get cm -n blueking bk-repo-bkrepo-auth -o json | jq -r &#x27;.data.&quot;application.yml&quot;&#x27; | yq e &#x27;.auth.realm&#x27; -</span><br></pre></td></tr></table></figure>

<h3 id="4-2-3-重启-bk-repo-auth-微服务"><a href="#4-2-3-重启-bk-repo-auth-微服务" class="headerlink" title="4.2.3 重启 bk-repo auth 微服务"></a>4.2.3 重启 bk-repo auth 微服务</h3><p>因为对接制品库的相关信息已经在gitlab仓库上维护了，所以此处不用进行重启。</p>
<p>[可跳过]因为 deployment 没有变动，所以不会自动重启，此处需要单独重启：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout restart deployment -n blueking bk-repo-bkrepo-auth</span><br></pre></td></tr></table></figure>

<h3 id="4-2-4-在蓝盾中注册制品库"><a href="#4-2-4-在蓝盾中注册制品库" class="headerlink" title="4.2.4 在蓝盾中注册制品库"></a>4.2.4 在蓝盾中注册制品库</h3><p>[可跳过]请在 中控机 执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  # 进入工作目录</span><br><span class="line">BK_DOMAIN=$(yq e &#x27;.domain.bkDomain&#x27; environments/default/custom.yaml)  # 从自定义配置中提取, 也可自行赋值# 向project微服务注册制品库</span><br><span class="line">kubectl exec -i -n blueking deploy/bk-ci-bk-ci-project -- curl -sS -X PUT -H &#x27;Content-Type: application/json&#x27; -H &#x27;Accept: application/json&#x27; -H &#x27;X-DEVOPS-UID: admin&#x27; -d &quot;&#123;\&quot;showProjectList\&quot;:true,\&quot;showNav\&quot;:true,\&quot;status\&quot;:\&quot;ok\&quot;,\&quot;deleted\&quot;:false,\&quot;iframeUrl\&quot;:\&quot;//bkrepo.$BK_DOMAIN/ui/\&quot;&#125;&quot; &quot;http://bk-ci-bk-ci-project.blueking.svc.cluster.local/api/op/services/update/Repo&quot;</span><br></pre></td></tr></table></figure>

<h2 id="4-3-可选-下载和上传插件"><a href="#4-3-可选-下载和上传插件" class="headerlink" title="4.3 [可选]下载和上传插件"></a>4.3 [可选]下载和上传插件</h2><h3 id="4-3-1-下载插件"><a href="#4-3-1-下载插件" class="headerlink" title="4.3.1 下载插件"></a>4.3.1 下载插件</h3><p>请在 中控机 执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bkdl-7.1-stable.sh -ur latest ci-plugins</span><br></pre></td></tr></table></figure>

<h3 id="4-3-2-上传插件"><a href="#4-3-2-上传插件" class="headerlink" title="4.3.2 上传插件"></a>4.3.2 上传插件</h3><p>此操作只能新建插件，每个插件只能上传一次。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  # 进入工作目录</span><br><span class="line">for f in ../ci-plugins/*.zip; do</span><br><span class="line">    atom=&quot;$&#123;f##*/&#125;&quot;</span><br><span class="line">    atom=$&#123;atom%.zip&#125;</span><br><span class="line">    echo &gt;&amp;2 &quot;upload $atom from $f&quot;</span><br><span class="line">    kubectl exec -i -n blueking deploy/bk-ci-bk-ci-store -- \</span><br><span class="line">      curl -s \</span><br><span class="line">      http://bk-ci-bk-ci-store.blueking.svc.cluster.local/api/op/pipeline/atom/deploy/&quot;?publisher=admin&quot; \</span><br><span class="line">      -H &#x27;X-DEVOPS-UID: admin&#x27; -F atomCode=$atom -F file=@- &lt; &quot;$f&quot; | jq .</span><br><span class="line">      # 设置为默认插件，全部项目可见。</span><br><span class="line">    kubectl exec -n blueking deploy/bk-ci-bk-ci-store -- \</span><br><span class="line">    curl -s http://bk-ci-bk-ci-store.blueking.svc.cluster.local/api/op/pipeline/atom/default/atomCodes/$atom \-H &#x27;X-DEVOPS-UID: admin&#x27; -X POST | jq .</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="4-3-3-问题及解决方案"><a href="#4-3-3-问题及解决方案" class="headerlink" title="4.3.3 问题及解决方案"></a>4.3.3 问题及解决方案</h3><p><code>这个问题已经在蓝盾的helm charts里面进行了优化</code></p>
<p>上传插件时会碰到这个问题：<br><img src="/img_19.png" alt="img_19.png"></p>
<p>蓝盾官方文档说法是：<br><img src="/img_20.png" alt="img_20.png"></p>
<p>实际原因是：HTTP请求报了 413 Request Entity Too Large</p>
<p>具体解决方式详见：<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/1001630">Ingress 域名方式导致413 Request Entity Too Large-阿里云开发者社区</a></p>
<p>造成这个问题的主要原因是nginx-ingress的默认配置中proxy-body-size的数值太小<br><img src="/img_21.png" alt="img_21.png"></p>
<h1 id="5-支持https"><a href="#5-支持https" class="headerlink" title="5. 支持https"></a>5. 支持https</h1><p>如果开始就准备好了相关证书，那么可以将该步骤提前，在部署基础服务和蓝盾之前就先修改好相关的yaml，将需要创建的Secret和要更新的Ingress配置都提前修改好，然后直接部署即可。</p>
<h2 id="5-1-购买相关证书"><a href="#5-1-购买相关证书" class="headerlink" title="5.1 购买相关证书"></a>5.1 购买相关证书</h2><p>涉及的域名：bk.blazehu.com、*.bk.blazehu.com（如devops.bk.blazehu.com）。需购买泛域名证书。</p>
<h2 id="5-2-创建相关Secret（用于存储TLS证书和私钥）"><a href="#5-2-创建相关Secret（用于存储TLS证书和私钥）" class="headerlink" title="5.2 创建相关Secret（用于存储TLS证书和私钥）"></a>5.2 创建相关Secret（用于存储TLS证书和私钥）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建Secret</span></span><br><span class="line">BK_DOMAIN=$(yq e &#x27;.domain.bkDomain&#x27; environments/default/custom.yaml)</span><br><span class="line">cd $HOME/$BK_DOMAIN</span><br><span class="line">kubectl create secret tls $BK_DOMAIN -n blueking --cert=$HOME/$BK_DOMAIN/$BK_DOMAIN.pem --key=$HOME/$BK_DOMAIN/$BK_DOMAIN.key</span><br><span class="line">————————————————</span><br><span class="line">本文链接：https://blazehu.com/2024/05/24/devops/landun_install/</span><br><span class="line">版权声明： 本博客所有文章除特别声明外，均采用 CC BY 4.0 CN协议 许可协议。转载请注明出处！</span><br></pre></td></tr></table></figure>

<h2 id="5-3-更新-Ingress-TLS"><a href="#5-3-更新-Ingress-TLS" class="headerlink" title="5.3 更新 Ingress TLS"></a>5.3 更新 Ingress TLS</h2><p>在证书及证书secret准备好之后，需要变更蓝鲸系列ingress开启tls的支持，执行对应的脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置变量</span></span><br><span class="line">NAMESPACE=&quot;blueking&quot;</span><br><span class="line">DOMAIN_FILE=&quot;environments/default/custom.yaml&quot;</span><br><span class="line">BK_DOMAIN=$(yq e &#x27;.domain.bkDomain&#x27; &quot;$DOMAIN_FILE&quot;)  # 从配置文件中读取域名</span><br><span class="line">TLS_HOST=&quot;*.$BK_DOMAIN&quot;  # 泛域名</span><br><span class="line">TLS_SECRET=&quot;$BK_DOMAIN&quot;  # Secret 名称与域名一致</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查域名和 Secret 是否正确</span></span><br><span class="line">if [[ -z &quot;$BK_DOMAIN&quot; ]]; then</span><br><span class="line">  echo &quot;Error: BK_DOMAIN is not set in $DOMAIN_FILE.&quot;</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取命名空间中的所有 Ingress 资源</span></span><br><span class="line">ingresses=$(kubectl get ingress -n &quot;$NAMESPACE&quot; -o jsonpath=&#x27;&#123;.items[*].metadata.name&#125;&#x27;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">遍历所有 Ingress 资源并更新 TLS 配置</span></span><br><span class="line">for ingress in $ingresses; do</span><br><span class="line">  echo &quot;Updating Ingress: $ingress in namespace: $NAMESPACE&quot;</span><br><span class="line">  </span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">检查 Ingress 是否已存在 TLS 配置</span></span><br><span class="line">  if kubectl get ingress &quot;$ingress&quot; -n &quot;$NAMESPACE&quot; -o jsonpath=&#x27;&#123;.spec.tls&#125;&#x27; | grep -q &quot;$TLS_HOST&quot;; then</span><br><span class="line">    echo &quot;TLS configuration for $TLS_HOST already exists in Ingress $ingress. Skipping.&quot;</span><br><span class="line">    continue</span><br><span class="line">  fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">更新 Ingress 的 TLS 配置</span></span><br><span class="line">  kubectl patch ingress &quot;$ingress&quot; -n &quot;$NAMESPACE&quot; --type=json -p=&#x27;[</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;op&quot;: &quot;add&quot;,</span><br><span class="line">      &quot;path&quot;: &quot;/spec/tls&quot;,</span><br><span class="line">      &quot;value&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;hosts&quot;: [&quot;&#x27;&quot;$TLS_HOST&quot;&#x27;&quot;],</span><br><span class="line">          &quot;secretName&quot;: &quot;&#x27;&quot;$TLS_SECRET&quot;&#x27;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]&#x27; || &#123; echo &quot;Failed to update Ingress $ingress&quot;; exit 1; &#125;</span><br><span class="line"></span><br><span class="line">  echo &quot;Updated Ingress $ingress with TLS configuration for $TLS_HOST.&quot;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo &quot;All Ingress resources in namespace $NAMESPACE have been updated with TLS configuration for $TLS_HOST.&quot;</span><br></pre></td></tr></table></figure>

<h2 id="5-4-配置蓝鲸启用HTTPS"><a href="#5-4-配置蓝鲸启用HTTPS" class="headerlink" title="5.4 配置蓝鲸启用HTTPS"></a>5.4 配置蓝鲸启用HTTPS</h2><p>在git仓库维护，主要有两个变更：</p>
<p>environments&#x2F;default&#x2F;custom.yaml: .bkDomainScheme 值设置为 https<br>environments&#x2F;default&#x2F;bkci&#x2F;bkci-custom-values.yaml.gotmpl: .config.bkHttpSchema 值设置为 https</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yq -i &#x27;.bkDomainScheme = &quot;https&quot;&#x27; environments/default/custom.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将bkHttpSchema: https替换为bkHttpSchema: http</span></span><br><span class="line">sed -i &#x27;s|bkHttpSchema: http|bkHttpSchema: https|&#x27; environments/default/bkci/bkci-custom-values.yaml.gotmpl</span><br></pre></td></tr></table></figure>

<h2 id="5-5-构建机Agent配置变更及重启"><a href="#5-5-构建机Agent配置变更及重启" class="headerlink" title="5.5 构建机Agent配置变更及重启"></a>5.5 构建机Agent配置变更及重启</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止agent服务</span></span><br><span class="line">./stop.sh</span><br><span class="line"></span><br><span class="line">BK_DOMAIN=&quot;deveops.bk.blazehu.com&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改.agent.properties文件，开启https</span></span><br><span class="line">sed -i &#x27;&#x27; &#x27;s|http://$BK_DOMAIN|https://$BK_DOMAIN|g&#x27; .agent.properties</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改telegraf.conf文件，开启https</span></span><br><span class="line">sed -i &#x27;&#x27; &#x27;s|http://$BK_DOMAIN|https://$BK_DOMAIN|g&#x27; telegraf.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动agent</span></span><br><span class="line">./start.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里需要注意，仔细查看.agent.properties里devops.agent.user， 这里是哪个用户就用哪个用户启动agent</span></span><br></pre></td></tr></table></figure>
    </div>

    
</div>
    <div class="footer" id="footer">
    <p><h4>版权所有 © 2020 | 作者: 花日 | 主题 By <a class="theme-author" target="_blank" rel="noopener" href="https://github.com/Xunzhuo/hexo-theme-coder" style="font-size:14px; color: #969696">Coder</a></h4>
    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <span id="busuanzi_container_site_pv">本站浏览总访问量: <span id="busuanzi_value_site_pv"></span></span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv">本站访问人数: <span id="busuanzi_value_site_uv"></span></span>
    
    <label class="el-switch el-switch-blue el-switch-sm" style="vertical-align: sub;">
        <input type="checkbox" name="switch" id="update_style">
        <span class="el-switch-style"></span>
    </label>

    <!--         <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
    document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script> -->
</p>
</div>

<input type="hidden" id="web_style" value="black">
<input type="hidden" id="valine_appid" value="ipUXLgJtbz1bF0aJdxHUCLp0-MdYXbMMI">
<input type="hidden" id="valine_appKey" value="7z2HlZVXXCRLYggFe4GvEqle">

<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>

<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>

<script src="/js/js.js"></script>

<style type="text/css">
.v * {
color: #698fca;
}
.v .vlist .vcard .vhead .vsys {
color: #3a3e4a;
}
.v .vlist .vcard .vh .vmeta .vat {
color: #638fd5;
}
.v .vlist .vcard .vhead .vnick {
color: #6ba1ff;
}
.v a {
color: #8696b1;
}
.v .vlist .vcard .vhead .vnick:hover {
color: #669bfc;
}
</style>
    <script type="text/javascript" color="173,174,173" opacity='1' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
</body>
</html>
