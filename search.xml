<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hello World</title>
    <url>/2025/07/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>Kindæ­å»ºæµ‹è¯•é›†ç¾¤</title>
    <url>/2025/07/kubernetes/Kind%E6%90%AD%E5%BB%BA%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4/</url>
    <content><![CDATA[<h1 id="Kindå·¥å…·ä»‹ç»"><a href="#Kindå·¥å…·ä»‹ç»" class="headerlink" title="Kindå·¥å…·ä»‹ç»"></a>Kindå·¥å…·ä»‹ç»</h1>]]></content>
  </entry>
  <entry>
    <title>kubectlå¸¸ç”¨å‘½ä»¤</title>
    <url>/2025/07/kubernetes/kubectl%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h1 id="ç™»å½•å‘½ä»¤"><a href="#ç™»å½•å‘½ä»¤" class="headerlink" title="ç™»å½•å‘½ä»¤"></a>ç™»å½•å‘½ä»¤</h1><p>æ ¹æ®æœºå™¨ipä½¿ç”¨kubectlç™»å½•æœºå™¨(field-selector):</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">export targetIp=&quot;6.0.90.240&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">alias</span> kubectl=<span class="string">&#x27;kubectl&#x27;</span></span></span><br><span class="line">alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;</span><br><span class="line"></span><br><span class="line">podinfo=`kubectl get pod --all-namespaces --field-selector=status.podIP=&quot;$targetIp&quot; -o wide | grep -v NAME | head -n 1 `</span><br><span class="line">ns=`echo $&#123;podinfo&#125; | awk &#x27;&#123;print $1&#125;&#x27;`</span><br><span class="line">pod=`echo $&#123;podinfo&#125; | awk &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line"></span><br><span class="line">echo &quot;$kubectl exec -it -n $&#123;ns&#125; $&#123;pod&#125; -- su - root&quot;</span><br><span class="line">kubectl exec -it -n $&#123;ns&#125; $&#123;pod&#125; -- su - root</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®æœºå™¨ipä½¿ç”¨kubectlç™»å½•æœºå™¨(label):</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">export targetIp=&quot;6.3.144.241&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">alias</span> kubectl=<span class="string">&#x27;kubectl&#x27;</span></span></span><br><span class="line">alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;</span><br><span class="line"></span><br><span class="line">podinfo=`kubectl get pod --all-namespaces -l sigma.ali/ip=&quot;$targetIp&quot; -o wide | grep -v NAMESPACE`</span><br><span class="line">ns=`echo $&#123;podinfo&#125; | awk &#x27;&#123;print $1&#125;&#x27;`</span><br><span class="line">pod=`echo $&#123;podinfo&#125; | awk &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line"></span><br><span class="line">echo &quot;$kubectl exec -it -n $&#123;ns&#125; $&#123;pod&#125; -- su - root&quot;</span><br><span class="line">kubectl exec -it -n $&#123;ns&#125; $&#123;pod&#125; -- su - root</span><br></pre></td></tr></table></figure>

<p>æ›´æ™ºèƒ½ç‰ˆæœ¬çš„kubectlç™»å½•å‘½ä»¤ï¼š</p>
<ul>
<li>æŸ¥çœ‹KUBECONFIG_DIRç›®å½•ä¸‹æœ‰å“ªäº›kubeconfigå¯ä»¥ç”¨</li>
<li>æ ¡éªŒç›®æ ‡ç™»å½•çš„ipæ ¼å¼</li>
<li>æŸ¥è¯¢å¹¶è§£æpodä¿¡æ¯</li>
<li>æŸ¥è¯¢è¯¥podæœ‰å“ªäº›å®¹å™¨å¹¶å±•ç¤º</li>
<li>æŸ¥è¯¢é€‰å®šçš„å®¹å™¨æœ‰å“ªäº›ç”¨æˆ·(ä¸user_arrayåšäº¤é›†)ï¼Œæ”¯æŒè‡ªå®šä¹‰è¾“å…¥ç”¨æˆ·</li>
<li>æ ¹æ®ä»¥ä¸Šä¿¡æ¯ç™»å½•ç›®æ ‡ipå¯¹åº”podçš„é€‰å®šå®¹å™¨<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ ç‰¹å®šç”¨æˆ·</span></span><br><span class="line">user_array=(&quot;root&quot; &quot;admin&quot; &quot;log&quot;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä»æŒ‡å®šç›®å½•è·å–æ‰€æœ‰ kubeconfig æ–‡ä»¶</span></span><br><span class="line">KUBECONFIG_DIR=&quot;/Users/king/.kube&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆå§‹åŒ– kubectl å‘½ä»¤å‰ç¼€</span></span><br><span class="line">KUBECTL_CMD=&quot;kubectl&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¡®ä¿å°†ä¿¡æ¯æ‰“å°åˆ°ç»ˆç«¯é‡Œï¼Œå³ä½¿åœ¨å‡½æ•°ä¹‹é—´$(...)è°ƒç”¨çš„åœºæ™¯</span></span><br><span class="line">function print_to_console() &#123;</span><br><span class="line">    printf &quot;%s\n&quot; &quot;$1&quot; &gt;&amp;2</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥IPåœ°å€æ˜¯å¦ç¬¦åˆæ­£ç¡®çš„æ ¼å¼</span></span><br><span class="line">function is_valid_ip() &#123;</span><br><span class="line">    local ip=$1</span><br><span class="line">    local valid_regex=&#x27;^([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;$&#x27;</span><br><span class="line"></span><br><span class="line">    if [[ $ip =~ $valid_regex ]]; then</span><br><span class="line">        # ç¡®ä¿æ¯ä¸ªæ•°å­—éƒ¨åˆ†å°äºç­‰äº255</span><br><span class="line">        IFS=&#x27;.&#x27; read -r -a octets &lt;&lt;&lt; &quot;$ip&quot;</span><br><span class="line">        for octet in &quot;$&#123;octets[@]&#125;&quot;; do</span><br><span class="line">            if ((octet &gt; 255)); then</span><br><span class="line">                return 1</span><br><span class="line">            fi</span><br><span class="line">        done</span><br><span class="line">        return 0</span><br><span class="line">    fi</span><br><span class="line">    return 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">KUBECONFIGS=($(find $KUBECONFIG_DIR -maxdepth 1 -name &quot;*.config&quot; -print))</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥æ˜¯å¦æ‰¾åˆ° kubeconfig æ–‡ä»¶</span></span><br><span class="line">if [ $&#123;#KUBECONFIGS[@]&#125; -eq 0 ]; then</span><br><span class="line">    print_to_console &quot;æ²¡æœ‰æ‰¾åˆ°ä»»ä½• kubeconfig æ–‡ä»¶åœ¨ç›®å½•: $KUBECONFIG_DIR&quot;</span><br><span class="line">else</span><br><span class="line">    # æä¾›ç»™ç”¨æˆ·é€‰æ‹©çš„èœå•ï¼ŒåŠ¨æ€ç”Ÿæˆé€‰é¡¹èŒƒå›´æç¤º</span><br><span class="line">    cat &lt;&lt; EOF</span><br><span class="line">    ----------------------------------------------</span><br><span class="line">    |*******Please Enter Your Choice:[1-$&#123;#KUBECONFIGS[@]&#125;]*******|</span><br><span class="line">    ----------------------------------------------</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    # è¾“å‡ºå¯ä¾›é€‰æ‹©çš„é…ç½®æ–‡ä»¶é€‰é¡¹</span><br><span class="line">    for i in &quot;$&#123;!KUBECONFIGS[@]&#125;&quot;; do</span><br><span class="line">        print_to_console &quot;*     $(($i + 1)) $&#123;KUBECONFIGS[$i]&#125;&quot;</span><br><span class="line">    done</span><br><span class="line"></span><br><span class="line">    # æ•è·ç”¨æˆ·è¾“å…¥å¹¶ç¡®ä¿åœ¨åˆæ³•èŒƒå›´å†…</span><br><span class="line">    while true; do</span><br><span class="line">        read -p &quot;please input your choice [1-$&#123;#KUBECONFIGS[@]&#125;] (or press Enter to skip): &quot; num</span><br><span class="line">        if [[ -z &quot;$num&quot; ]]; then</span><br><span class="line">            break</span><br><span class="line">        elif [[ &quot;$num&quot; =~ ^[0-9]+$ ]] &amp;&amp; [ &quot;$num&quot; -ge 1 ] &amp;&amp; [ &quot;$num&quot; -le $&#123;#KUBECONFIGS[@]&#125; ]; then</span><br><span class="line">            selected_config=&quot;$&#123;KUBECONFIGS[$((num - 1))]&#125;&quot;</span><br><span class="line">            KUBECTL_CMD=&quot;kubectl --kubeconfig=$selected_config&quot;</span><br><span class="line">            print_to_console &quot;Using configuration file: $selected_config&quot;</span><br><span class="line">            break</span><br><span class="line">        else</span><br><span class="line">            print_to_console &quot;Invalid choice. Please try again.&quot;</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¾“å‡ºç”¨æˆ·é€‰æ‹©çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line">selected_config=&quot;$&#123;KUBECONFIGS[$((num - 1))]&#125;&quot;</span><br><span class="line">print_to_console &quot;You selected: $selected_config&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ•è·ç”¨æˆ·è¾“å…¥çš„targetIP</span></span><br><span class="line">while true; do</span><br><span class="line">    read -p &quot;please input your target ip: &quot; targetIP</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸ºç©ºå’Œæ ¼å¼æœ‰æ•ˆæ€§</span><br><span class="line">    if [[ -z &quot;$targetIP&quot; ]]; then</span><br><span class="line">        print_to_console &quot;IP åœ°å€ä¸èƒ½ä¸ºç©ºï¼Œè¯·é‡æ–°è¾“å…¥ã€‚&quot;</span><br><span class="line">    elif ! is_valid_ip &quot;$targetIP&quot;; then</span><br><span class="line">        print_to_console &quot;æ— æ•ˆçš„IPæ ¼å¼ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„IPåœ°å€ã€‚&quot;</span><br><span class="line">    else</span><br><span class="line">        print_to_console &quot;æ‚¨è¾“å…¥çš„IPåœ°å€æ˜¯: $targetIP&quot;</span><br><span class="line">        break</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å– Pod ä¿¡æ¯</span></span><br><span class="line">podinfo=$($KUBECTL_CMD get pod --all-namespaces --field-selector=status.podIP=&quot;$targetIP&quot; -o wide | grep -v NAME | head -n 1)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥ podinfo æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">if [[ -z &quot;$podinfo&quot; ]]; then</span><br><span class="line">    print_to_console &quot;æœªèƒ½è·å–åˆ°å¯¹åº” IP çš„ Pod ä¿¡æ¯ï¼Œé€€å‡ºè„šæœ¬ã€‚&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æå–å‘½åç©ºé—´å’Œ Pod åç§°</span></span><br><span class="line">ns=$(echo &quot;$&#123;podinfo&#125;&quot; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">pod=$(echo &quot;$&#123;podinfo&#125;&quot; | awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥ ns å’Œ pod æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">if [[ -z &quot;$ns&quot; || -z &quot;$pod&quot; ]]; then</span><br><span class="line">    print_to_console &quot;æœªèƒ½æå–åˆ°å‘½åç©ºé—´æˆ– Pod åç§°ï¼Œé€€å‡ºè„šæœ¬ã€‚&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">print_to_console &quot;Namespace: $ns, Pod: $pod&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–å®¹å™¨åˆ—è¡¨</span></span><br><span class="line">containers=($($KUBECTL_CMD get pod $pod -n $ns -o jsonpath=&#x27;&#123;.spec.containers[*].name&#125;&#x27;))</span><br><span class="line">selected_container=&quot;&quot;</span><br><span class="line">if [ $&#123;#containers[@]&#125; -gt 0 ]; then</span><br><span class="line">    print_to_console &quot;è¯·é€‰æ‹©ä¸€ä¸ªå®¹å™¨ (æˆ–ç›´æ¥æŒ‰ Enter è·³è¿‡ä½¿ç”¨é»˜è®¤å®¹å™¨):&quot;</span><br><span class="line">    for i in &quot;$&#123;!containers[@]&#125;&quot;; do</span><br><span class="line">        print_to_console &quot;*      $(($i + 1)) $&#123;containers[$i]&#125;&quot;</span><br><span class="line">    done</span><br><span class="line"></span><br><span class="line">    while true; do</span><br><span class="line">        read -p &quot;please input your choice [1-$&#123;#containers[@]&#125;] (or press Enter to skip): &quot; container_num</span><br><span class="line">        if [[ -z &quot;$container_num&quot; ]]; then</span><br><span class="line">            break</span><br><span class="line">        elif [[ &quot;$container_num&quot; =~ ^[0-9]+$ ]] &amp;&amp; [ &quot;$container_num&quot; -ge 1 ] &amp;&amp; [ &quot;$container_num&quot; -le $&#123;#containers[@]&#125; ]; then</span><br><span class="line">            selected_container=&quot;$&#123;containers[$((container_num - 1))]&#125;&quot;</span><br><span class="line">            print_to_console &quot;Selected container: $selected_container&quot;</span><br><span class="line">            break</span><br><span class="line">        else</span><br><span class="line">            print_to_console &quot;Invalid choice. Please try again.&quot;</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è§£æå®¹å™¨ä¸­çš„ç”¨æˆ·å¹¶æ·»åŠ åˆ°ç”¨æˆ·æ•°ç»„ä¸­</span></span><br><span class="line">while IFS=: read -r username _ uid _; do</span><br><span class="line">    if [[ $uid -ge 1000 &amp;&amp; $username != &quot;nobody&quot; ]]; then</span><br><span class="line">        user_array+=(&quot;$username&quot;)</span><br><span class="line">    fi</span><br><span class="line">done &lt;&lt;&lt; &quot;$user_list&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ˜¾ç¤ºå¯ä¾›é€‰æ‹©çš„ç”¨æˆ·åˆ—è¡¨</span></span><br><span class="line">print_to_console &quot;è¯·é€‰æ‹©ä¸€ä¸ªç”¨æˆ· (æˆ–è‡ªå®šä¹‰è¾“å…¥):&quot;</span><br><span class="line">for i in &quot;$&#123;!user_array[@]&#125;&quot;; do</span><br><span class="line">    print_to_console &quot;*      $(($i + 1)) $&#123;user_array[$i]&#125;&quot;</span><br><span class="line">done</span><br><span class="line">print_to_console &quot;*      $(( $&#123;#user_array[@]&#125; + 1 )) è‡ªå®šä¹‰è¾“å…¥ &quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ•è·ç”¨æˆ·é€‰æ‹©çš„ç”¨æˆ·</span></span><br><span class="line">while true; do</span><br><span class="line">    read -p &quot;please input your choice [1-$(( $&#123;#user_array[@]&#125; + 1 ))]: &quot; user_num</span><br><span class="line">    if [[ &quot;$user_num&quot; =~ ^[0-9]+$ ]] &amp;&amp; [ &quot;$user_num&quot; -ge 1 ] &amp;&amp; [ &quot;$user_num&quot; -le $(( $&#123;#user_array[@]&#125; + 1 )) ]; then</span><br><span class="line">        if [ &quot;$user_num&quot; -eq $(( $&#123;#user_array[@]&#125; + 1 )) ]; then</span><br><span class="line">            read -p &quot;è¯·è¾“å…¥è‡ªå®šä¹‰ç”¨æˆ·å: &quot; targetUser</span><br><span class="line">        else</span><br><span class="line">            targetUser=&quot;$&#123;user_array[$((user_num - 1))]&#125;&quot;</span><br><span class="line">        fi</span><br><span class="line">        print_to_console &quot;Selected user: $targetUser&quot;</span><br><span class="line">        break</span><br><span class="line">    else</span><br><span class="line">        print_to_console &quot;Invalid choice. Please try again.&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">if [[ -n &quot;$selected_container&quot; ]]; then</span><br><span class="line">    print_to_console &quot;$KUBECTL_CMD exec -it -n $&#123;ns&#125; $&#123;pod&#125; -c $&#123;selected_container&#125; -- su - $targetUser&quot;</span><br><span class="line">    $KUBECTL_CMD exec -it -n $&#123;ns&#125; $&#123;pod&#125; -c $&#123;selected_container&#125; -- su - $targetUser</span><br><span class="line">else</span><br><span class="line">    print_to_console &quot;$KUBECTL_CMD exec -it -n $&#123;ns&#125; $&#123;pod&#125; -- su - $targetUser&quot;</span><br><span class="line">    $KUBECTL_CMD exec -it -n $&#123;ns&#125; $&#123;pod&#125; -- su - $targetUser</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="æŸ¥è¯¢å‘½ä»¤"><a href="#æŸ¥è¯¢å‘½ä»¤" class="headerlink" title="æŸ¥è¯¢å‘½ä»¤"></a>æŸ¥è¯¢å‘½ä»¤</h1><p>æ ¹æ®æœºå™¨ip(field-selector)æŸ¥è¯¢pod:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">export fieldKEY=&quot;status.podIP&quot;</span><br><span class="line">export fieldVALUE=&quot;6.0.90.240&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">alias</span> kubectl=<span class="string">&#x27;kubectl&#x27;</span></span></span><br><span class="line">alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;</span><br><span class="line"></span><br><span class="line">kubectl get pod --all-namespaces --field-selector=$fieldKEY=$fieldVALUE -o wide</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®labelæŸ¥è¯¢pod:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">export labelKEY=&quot;sigma.ali/ip&quot;</span><br><span class="line">export labelVALUE=&quot;6.0.90.240&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">alias</span> kubectl=<span class="string">&#x27;kubectl&#x27;</span></span></span><br><span class="line">alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;</span><br><span class="line"></span><br><span class="line">kubectl get pod --all-namespaces -l $labelKEY=$labelVALUE -o wide</span><br></pre></td></tr></table></figure>

<h1 id="å¯¼å‡ºyaml"><a href="#å¯¼å‡ºyaml" class="headerlink" title="å¯¼å‡ºyaml"></a>å¯¼å‡ºyaml</h1><p>æ ¹æ®æœºå™¨ipä½¿ç”¨kubectlå¯¼å‡ºæœºå™¨yaml:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">local podName=&quot;&quot;</span><br><span class="line">local namespace=&quot;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">alias</span> kubectl=<span class="string">&#x27;kubectl&#x27;</span></span></span><br><span class="line">alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;</span><br><span class="line"></span><br><span class="line">kubectl get pod/$podName -n $&#123;namespace&#125; -oyaml</span><br></pre></td></tr></table></figure>

<h1 id="describe"><a href="#describe" class="headerlink" title="describe"></a>describe</h1><p>æ ¹æ®namespaceå’ŒpodNameè¿›è¡Œdescribe</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">local namespace=&quot;longtermbase&quot;</span><br><span class="line">local podName=&quot;inplaceset-antcodebuild-tn1oimjfl-gz00b-0&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">alias</span> kubectl=<span class="string">&#x27;kubectl&#x27;</span></span></span><br><span class="line">alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;</span><br><span class="line"></span><br><span class="line">kubectl describe pod $podName -n $namespace</span><br></pre></td></tr></table></figure>

<h1 id="æ¸…ç†terminatingçš„pod"><a href="#æ¸…ç†terminatingçš„pod" class="headerlink" title="æ¸…ç†terminatingçš„pod"></a>æ¸…ç†terminatingçš„pod</h1><p>é€šè¿‡æ¸…ç†finalizerså®ç°</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">local namespace=&quot;&quot;</span><br><span class="line">local podName=&quot;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">alias</span> kubectl=<span class="string">&#x27;kubectl&#x27;</span></span></span><br><span class="line">alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;</span><br><span class="line"></span><br><span class="line">kubectl patch pod/$podName -n $namespace -p &#x27;&#123;&quot;metadata&quot;:&#123;&quot;finalizers&quot;:null&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>å¼ºåˆ¶åˆ é™¤</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">local namespace=&quot;&quot;</span><br><span class="line">local podName=&quot;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">alias</span> kubectl=<span class="string">&#x27;kubectl&#x27;</span></span></span><br><span class="line">alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;</span><br><span class="line"></span><br><span class="line">k delete pod/$podName -n $namespace --force --grace-period=0</span><br></pre></td></tr></table></figure>

<h1 id="å¤åˆ¶æ–‡ä»¶åˆ°podå®¹å™¨"><a href="#å¤åˆ¶æ–‡ä»¶åˆ°podå®¹å™¨" class="headerlink" title="å¤åˆ¶æ–‡ä»¶åˆ°podå®¹å™¨"></a>å¤åˆ¶æ–‡ä»¶åˆ°podå®¹å™¨</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">local namespace=&quot;&quot;</span><br><span class="line">local podName=&quot;&quot;</span><br><span class="line">local sourceDir=&quot;&quot;</span><br><span class="line">local sourceFile=&quot;&quot;</span><br><span class="line">local targetDir=&quot;&quot;</span><br><span class="line">local targetFile=&quot;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">alias</span> kubectl=<span class="string">&#x27;kubectl&#x27;</span></span></span><br><span class="line">alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;</span><br><span class="line"></span><br><span class="line">kubectl cp -n linkw $sourceDir/$sourceFile $podName:/targetDir/targetFile</span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>åŠ é€Ÿä»£ç†</title>
    <url>/2025/07/kubernetes/%E5%8A%A0%E9%80%9F%E4%BB%A3%E7%90%86/</url>
    <content><![CDATA[<h1 id="1-å‹æƒ…é“¾æ¥"><a href="#1-å‹æƒ…é“¾æ¥" class="headerlink" title="1 å‹æƒ…é“¾æ¥"></a>1 å‹æƒ…é“¾æ¥</h1><ul>
<li>é•œåƒåŠ é€Ÿï¼š<a href="https://github.com/DaoCloud/public-image-mirror">https://github.com/DaoCloud/public-image-mirror</a></li>
<li>äºŒè¿›åˆ¶æ–‡ä»¶åŠ é€Ÿï¼š<a href="https://github.com/DaoCloud/public-binary-files-mirror">https://github.com/DaoCloud/public-binary-files-mirror</a></li>
<li>Helm åŠ é€Ÿï¼š<a href="https://github.com/DaoCloud/public-helm-charts-mirror">https://github.com/DaoCloud/public-helm-charts-mirror</a></li>
</ul>
<h1 id="2-äºŒè¿›åˆ¶æ–‡ä»¶åŠ é€Ÿ"><a href="#2-äºŒè¿›åˆ¶æ–‡ä»¶åŠ é€Ÿ" class="headerlink" title="2 äºŒè¿›åˆ¶æ–‡ä»¶åŠ é€Ÿ"></a>2 äºŒè¿›åˆ¶æ–‡ä»¶åŠ é€Ÿ</h1><h2 id="2-1-ä½¿ç”¨æ–¹æ³•"><a href="#2-1-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="2.1 ä½¿ç”¨æ–¹æ³•"></a>2.1 ä½¿ç”¨æ–¹æ³•</h2><p>åœ¨åŸå§‹ URL ä¸Šé¢åŠ å…¥ files.m.daocloud.io çš„ å‰ç¼€ å°±å¯ä»¥ä½¿ç”¨ã€‚æ¯”å¦‚ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Helm ä¸‹è½½åŸå§‹URL</span></span><br><span class="line">wget https://get.helm.sh/helm-v3.9.1-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åŠ é€Ÿåçš„ URL</span></span><br><span class="line">wget https://files.m.daocloud.io/get.helm.sh/helm-v3.9.1-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<h2 id="2-2-å®‰è£…-Helm"><a href="#2-2-å®‰è£…-Helm" class="headerlink" title="2.2 å®‰è£… Helm"></a>2.2 å®‰è£… Helm</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /tmp</span><br><span class="line">export HELM_VERSION=&quot;v3.9.3&quot;</span><br><span class="line"></span><br><span class="line">wget &quot;https://files.m.daocloud.io/get.helm.sh/helm-$&#123;HELM_VERSION&#125;-linux-amd64.tar.gz&quot;</span><br><span class="line">tar -zxvf helm-$&#123;HELM_VERSION&#125;-linux-amd64.tar.gz</span><br><span class="line">mv linux-amd64/helm /usr/local/bin/helm</span><br><span class="line">helm version</span><br></pre></td></tr></table></figure>

<h2 id="2-3-å®‰è£…-KIND"><a href="#2-3-å®‰è£…-KIND" class="headerlink" title="2.3 å®‰è£… KIND"></a>2.3 å®‰è£… KIND</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /tmp</span><br><span class="line">export KIND_VERSION=&quot;v0.22.0&quot;</span><br><span class="line"></span><br><span class="line">curl -Lo ./kind https://files.m.daocloud.io/github.com/kubernetes-sigs/kind/releases/download/$&#123;KIND_VERSION&#125;/kind-linux-amd64</span><br><span class="line">chmod +x ./kind</span><br><span class="line">mv ./kind /usr/bin/kind</span><br><span class="line">kind version</span><br></pre></td></tr></table></figure>

<h2 id="2-4-å®‰è£…-istio"><a href="#2-4-å®‰è£…-istio" class="headerlink" title="2.4 å®‰è£… istio"></a>2.4 å®‰è£… istio</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /tmp</span><br><span class="line">export ISTIO_VERSION=&quot;1.14.3&quot;</span><br><span class="line"></span><br><span class="line">wget &quot;https://files.m.daocloud.io/github.com/istio/istio/releases/download/$&#123;ISTIO_VERSION&#125;/istio-$&#123;ISTIO_VERSION&#125;-linux-amd64.tar.gz&quot;</span><br><span class="line">tar -zxvf istio-$&#123;ISTIO_VERSION&#125;-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Do follow the istio docs to install istio</span></span><br></pre></td></tr></table></figure>

<h2 id="2-5-å®‰è£…-nerdctl-ï¼ˆä»£æ›¿-docker-å·¥å…·ï¼‰"><a href="#2-5-å®‰è£…-nerdctl-ï¼ˆä»£æ›¿-docker-å·¥å…·ï¼‰" class="headerlink" title="2.5 å®‰è£… nerdctl ï¼ˆä»£æ›¿ docker å·¥å…·ï¼‰"></a>2.5 å®‰è£… nerdctl ï¼ˆä»£æ›¿ docker å·¥å…·ï¼‰</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export NERDCTL_VERSION=&quot;1.7.6&quot;</span><br><span class="line">mkdir -p nerdctl ;cd nerdctl</span><br><span class="line">wget https://files.m.daocloud.io/github.com/containerd/nerdctl/releases/download/v$&#123;NERDCTL_VERSION&#125;/nerdctl-full-$&#123;NERDCTL_VERSION&#125;-linux-amd64.tar.gz</span><br><span class="line">tar -zvxf nerdctl-full-$&#123;NERDCTL_VERSION&#125;-linux-amd64.tar.gz</span><br><span class="line">mkdir -p /opt/cni/bin ;cp -f libexec/cni/* /opt/cni/bin/ ;cp bin/* /usr/local/bin/ ;cp lib/systemd/system/*.service /usr/lib/systemd/system/</span><br><span class="line">systemctl enable containerd ;systemctl start containerd --now</span><br><span class="line">systemctl enable buildkit;systemctl start buildkit --now</span><br></pre></td></tr></table></figure>

<h1 id="3-dockeré•œåƒåŠ é€Ÿ"><a href="#3-dockeré•œåƒåŠ é€Ÿ" class="headerlink" title="3 dockeré•œåƒåŠ é€Ÿ"></a>3 dockeré•œåƒåŠ é€Ÿ</h1><h2 id="3-1-ä½¿ç”¨æ–¹æ³•"><a href="#3-1-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="3.1 ä½¿ç”¨æ–¹æ³•"></a>3.1 ä½¿ç”¨æ–¹æ³•</h2><p>å¢åŠ å‰ç¼€ (æ¨èæ–¹å¼)ã€‚æ¯”å¦‚ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">              docker.io/library/busybox</span><br><span class="line">                 |</span><br><span class="line">                 V</span><br><span class="line">m.daocloud.io/docker.io/library/busybox</span><br></pre></td></tr></table></figure>

<p>æˆ–è€… æ”¯æŒçš„é•œåƒä»“åº“ çš„ å‰ç¼€æ›¿æ¢ å°±å¯ä»¥ä½¿ç”¨ã€‚æ¯”å¦‚ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">           docker.io/library/busybox</span><br><span class="line">             |</span><br><span class="line">             V</span><br><span class="line">docker.m.daocloud.io/library/busybox</span><br></pre></td></tr></table></figure>

<h2 id="3-2-é€šè¿‡-åŠ é€Ÿ-å®‰è£…-kubeadm"><a href="#3-2-é€šè¿‡-åŠ é€Ÿ-å®‰è£…-kubeadm" class="headerlink" title="3.2 é€šè¿‡ åŠ é€Ÿ å®‰è£… kubeadm"></a>3.2 é€šè¿‡ åŠ é€Ÿ å®‰è£… kubeadm</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubeadm config images pull --image-repository k8s-gcr.m.daocloud.io</span><br></pre></td></tr></table></figure>

<h2 id="3-3-é€šè¿‡-åŠ é€Ÿ-å®‰è£…-kind"><a href="#3-3-é€šè¿‡-åŠ é€Ÿ-å®‰è£…-kind" class="headerlink" title="3.3 é€šè¿‡ åŠ é€Ÿ å®‰è£… kind"></a>3.3 é€šè¿‡ åŠ é€Ÿ å®‰è£… kind</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kind create cluster --name kind --image m.daocloud.io/docker.io/kindest/node:v1.22.1</span><br></pre></td></tr></table></figure>

<h2 id="3-4-é€šè¿‡-åŠ é€Ÿ-éƒ¨ç½²-åº”ç”¨-è¿™é‡Œä»¥-Ingress-ä¸ºä¾‹"><a href="#3-4-é€šè¿‡-åŠ é€Ÿ-éƒ¨ç½²-åº”ç”¨-è¿™é‡Œä»¥-Ingress-ä¸ºä¾‹" class="headerlink" title="3.4 é€šè¿‡ åŠ é€Ÿ éƒ¨ç½² åº”ç”¨(è¿™é‡Œä»¥ Ingress ä¸ºä¾‹)"></a>3.4 é€šè¿‡ åŠ é€Ÿ éƒ¨ç½² åº”ç”¨(è¿™é‡Œä»¥ Ingress ä¸ºä¾‹)</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget -O image-filter.sh https://github.com/DaoCloud/public-image-mirror/raw/main/hack/image-filter.sh &amp;&amp; chmod +x image-filter.sh</span><br><span class="line"></span><br><span class="line">wget -O deploy.yaml https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.0/deploy/static/provider/baremetal/deploy.yaml</span><br><span class="line"></span><br><span class="line">cat ./deploy.yaml | ./image-filter.sh | kubectl apply -f -</span><br></pre></td></tr></table></figure>

<h2 id="3-5-Docker-åŠ é€Ÿ"><a href="#3-5-Docker-åŠ é€Ÿ" class="headerlink" title="3.5 Docker åŠ é€Ÿ"></a>3.5 Docker åŠ é€Ÿ</h2><p>æ·»åŠ åˆ° &#x2F;etc&#x2F;docker&#x2F;daemon.json</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [</span><br><span class="line">    &quot;https://docker.m.daocloud.io&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-helm-åŠ é€Ÿ"><a href="#4-helm-åŠ é€Ÿ" class="headerlink" title="4 helm åŠ é€Ÿ"></a>4 helm åŠ é€Ÿ</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm repo add community https://release.daocloud.io/chartrepo/community </span><br></pre></td></tr></table></figure>


]]></content>
  </entry>
  <entry>
    <title>BKCI ç®€ä»‹</title>
    <url>/2025/07/devops/blueking/BKCI%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h1 id="æ–‡æ¡£"><a href="#æ–‡æ¡£" class="headerlink" title="æ–‡æ¡£"></a>æ–‡æ¡£</h1><p>BK-CIå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/intro/README.md">https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/intro/README.md</a><br>githubä»“åº“åœ°å€ï¼š<a href="https://github.com/TencentBlueKing/bk-ci">https://github.com/TencentBlueKing/bk-ci</a></p>
<h1 id="å¯¼èˆª"><a href="#å¯¼èˆª" class="headerlink" title="å¯¼èˆª"></a>å¯¼èˆª</h1><table>
<thead>
<tr>
<th>ğŸ¤ äº†è§£åŸºæœ¬æ¦‚å¿µ</th>
<th>ğŸ‘‰ ä½¿ç”¨ BKCI</th>
<th>ğŸš€ éƒ¨ç½² BKCI</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/intro/bkci.md">BKCI æ˜¯ä»€ä¹ˆï¼Ÿ</a></td>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Quickstarts/Create-your-first-pipeline.md">åˆ›å»ºä½ çš„ç¬¬ä¸€æ¡æµæ°´çº¿</a></td>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Setup/system-requirements/hardware.md">BKCI ç¡¬ä»¶è§„æ ¼æŒ‡å—</a></td>
</tr>
<tr>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/intro/terminology/components.md">BKCI ç»„ä»¶</a></td>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Quickstarts/Link-your-first-repo.md">å…³è”ä½ çš„ç¬¬ä¸€ä¸ªä»£ç åº“</a></td>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Setup/system-requirements/system.md">BKCI ç³»ç»Ÿè¦æ±‚</a></td>
</tr>
<tr>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/intro/terminology/Learn-pipeline-in-5min.md">å¿«é€Ÿç†Ÿæ‚‰æµæ°´çº¿</a></td>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Quickstarts/Enable-ci.md">ä¸ºä½ çš„Gitå·¥ç¨‹å¼€å¯CI</a></td>
<td></td>
</tr>
<tr>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/intro/terminology/Learn-pipeline-in-5min.md">æœ¯è¯­è§£é‡Š</a></td>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Quickstarts/Case/Examples/vars-usage.md">ç¤ºä¾‹</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Developer/rest-api/read-before-use.md">APIæ¥å£</a></td>
<td></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>ğŸ“” äº§å“åŠŸèƒ½</th>
<th>ğŸª ç ”å‘å•†åº—</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Services/Pipeline/pipeline-list.md">æµæ°´çº¿</a></td>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Services/Store/home.md">æµè§ˆç ”å‘å•†åº—</a></td>
</tr>
<tr>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Services/Console/Console.md">æ§åˆ¶å°</a></td>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Services/Store/start-new-task.md">å¼€å‘ä¸€ä¸ªæµæ°´çº¿æ’ä»¶</a></td>
</tr>
<tr>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Services/Ticket/ticket.md">å‡­è¯ç®¡ç†</a></td>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Services/Store/upload-new-task.md">åœ¨ BKCI é‡Œä½¿ç”¨å•†åº—æ’ä»¶</a></td>
</tr>
<tr>
<td><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Services/Pools/host-to-bkci.md">æ„å»ºèµ„æº</a></td>
<td></td>
</tr>
</tbody></table>
<h1 id="ç›¸å…³æ–‡æ¡£"><a href="#ç›¸å…³æ–‡æ¡£" class="headerlink" title="ç›¸å…³æ–‡æ¡£"></a>ç›¸å…³æ–‡æ¡£</h1><p>è“é²¸å­¦ä¹ ç¤¾åŒºï¼š<a href="https://bk.tencent.com/s-mart/communities">https://bk.tencent.com/s-mart/communities</a><br>è“é²¸å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://bk.tencent.com/docs/">https://bk.tencent.com/docs/</a></p>
<p><strong>è“é²¸ä½“ç³»</strong><br>è“é²¸ç®€ä»‹ï¼š<a href="https://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/intro.md">https://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/intro.md</a><br>æ ¸å¿ƒä¼˜åŠ¿ï¼š<a href="https://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/advantages.md">https://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/advantages.md</a><br>ä½“ç³»æ¶æ„ï¼š<a href="https://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/Solution/solution.md">https://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/Solution/solution.md</a><br>CIé¢†åŸŸï¼š<a href="https://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/Solution/ci_intro.md">https://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/Solution/ci_intro.md</a><br>CDé¢†åŸŸï¼š<a href="https://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/Solution/cd_intro.md">https://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/Solution/cd_intro.md</a><br>COé¢†åŸŸï¼š<a href="https://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/Solution/co_intro.md">https://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/Solution/co_intro.md</a></p>
]]></content>
  </entry>
  <entry>
    <title>ç”Ÿäº§éƒ¨ç½²æ–‡æ¡£(v7-1)</title>
    <url>/2025/08/devops/blueking/%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E6%96%87%E6%A1%A3(v7-1)/</url>
    <content><![CDATA[<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>éœ€è¦å…ˆå‡†å¤‡ä¸€å°ä¸­æ§æœºï¼Œåœ¨ä¸­æ§æœºå®‰è£… kubectlã€helmã€helmfile ç­‰å·¥å…·ï¼Œä»¥åŠè“é²¸å®‰è£…è„šæœ¬ã€‚ç„¶åéƒ¨ç½²åŸºç¡€å¥—é¤ï¼Œæœ€åå†éƒ¨ç½²æŒç»­é›†æˆå¥—é¤ï¼ˆè“ç›¾ï¼‰ã€‚</p>
<p>ç®€å•æ¥è¯´å°±æ˜¯ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li><code>1.å‡†å¤‡ç¯å¢ƒ</code> </li>
<li><code>2.éƒ¨ç½²åŸºç¡€æœåŠ¡</code> </li>
<li><code>3.éƒ¨ç½²è“ç›¾</code></li>
</ul>
<h1 id="2-å‡†å¤‡ä¸­æ§æœº"><a href="#2-å‡†å¤‡ä¸­æ§æœº" class="headerlink" title="2. å‡†å¤‡ä¸­æ§æœº"></a>2. å‡†å¤‡ä¸­æ§æœº</h1><p>æŒ‰ç…§<a href="https://bk.tencent.com/docs/markdown/ZH/DeploymentGuides/7.1/prepare-bkctrl.md">å®˜æ–¹æ–‡æ¡£</a>å®‰è£…å’Œé…ç½®å³å¯ã€‚</p>
<h1 id="3-éƒ¨ç½²åŸºç¡€æœåŠ¡"><a href="#3-éƒ¨ç½²åŸºç¡€æœåŠ¡" class="headerlink" title="3. éƒ¨ç½²åŸºç¡€æœåŠ¡"></a>3. éƒ¨ç½²åŸºç¡€æœåŠ¡</h1><p>éœ€è¦æŒ‰ç…§<a href="https://bk.tencent.com/docs/markdown/ZH/DeploymentGuides/7.1/custom-values.md">å®˜æ–¹æ–‡æ¡£</a>ä¸€æ­¥æ­¥éƒ¨ç½²ã€‚</p>
<h2 id="3-1-ä¸‹è½½å®‰è£…æ–‡ä»¶"><a href="#3-1-ä¸‹è½½å®‰è£…æ–‡ä»¶" class="headerlink" title="3.1 ä¸‹è½½å®‰è£…æ–‡ä»¶"></a>3.1 ä¸‹è½½å®‰è£…æ–‡ä»¶</h2><p>è¯·åœ¨ ä¸­æ§æœº ä½¿ç”¨ä¸‹è½½è„šæœ¬ä¸‹è½½è“é²¸ helmfile åŒ…åŠå…¬å…±è¯ä¹¦ã€‚ï¼ˆ helmfileç›¸å…³valueæ–‡ä»¶åœ¨gitä¸Šç»´æŠ¤ï¼‰</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bkdl-7.1-stable.sh -ur latest base demo</span><br></pre></td></tr></table></figure>

<p>è¿™äº›æ–‡ä»¶é»˜è®¤æ”¾åœ¨äº† ~&#x2F;bkce7.1-install&#x2F; ç›®å½•ã€‚</p>
<h2 id="3-2-é…ç½®-Helm-Chart-ä»“åº“"><a href="#3-2-é…ç½®-Helm-Chart-ä»“åº“" class="headerlink" title="3.2 é…ç½® Helm Chart ä»“åº“"></a>3.2 é…ç½® Helm Chart ä»“åº“</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm repo add blueking https://hub.bktencent.com/chartrepo/blueking</span><br><span class="line">helm repo update</span><br><span class="line">helm repo list</span><br></pre></td></tr></table></figure>

<h2 id="3-3-é…ç½®å…¨å±€-custom-values"><a href="#3-3-é…ç½®å…¨å±€-custom-values" class="headerlink" title="3.3 é…ç½®å…¨å±€ custom-values"></a>3.3 é…ç½®å…¨å±€ custom-values</h2><p>ç›¸å…³æ–‡ä»¶å·²ç»ä¿®æ”¹ï¼Œåœ¨gitä¸Šç»´æŠ¤ï¼Œé…ç½®è®¿é—®åŸŸåã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">BK_DOMAIN=bk.blazehu.com  # è¯·ä¿®æ”¹ä¸ºä½ åˆ†é…ç»™è“é²¸å¹³å°çš„ä¸»åŸŸå cd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•# å¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ·»åŠ åŸŸåã€‚å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨ç¼–è¾‘ã€‚custom=environments/default/custom.yaml</span><br><span class="line">cat &gt;&gt; &quot;$custom&quot; &lt;&lt;EOF</span><br><span class="line">imageRegistry: $&#123;REGISTRY:-hub.bktencent.com&#125;</span><br><span class="line">domain:</span><br><span class="line">  bkDomain: $BK_DOMAIN</span><br><span class="line">  bkMainSiteDomain: $BK_DOMAIN</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="3-4-ç”Ÿæˆ-values-æ–‡ä»¶"><a href="#3-4-ç”Ÿæˆ-values-æ–‡ä»¶" class="headerlink" title="3.4 ç”Ÿæˆ values æ–‡ä»¶"></a>3.4 ç”Ÿæˆ values æ–‡ä»¶</h2><p>è¿˜æœ‰ä¸€äº› values æ–‡ä»¶éšç€éƒ¨ç½²ç¯å¢ƒçš„ä¸åŒè€Œå˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬æä¾›äº†è„šæœ¬å¿«é€Ÿç”Ÿæˆã€‚</p>
<p><code>ç”Ÿæˆè“é²¸ app code å¯¹åº”çš„ secret</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./scripts/generate_app_secret.sh ./environments/default/app_secret.yaml</span><br></pre></td></tr></table></figure>

<p><code>ç”Ÿæˆ apigw æ‰€éœ€çš„ keypair</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./scripts/generate_rsa_keypair.sh ./environments/default/bkapigateway_builtin_keypair.yaml</span><br></pre></td></tr></table></figure>

<p><code>ç”Ÿæˆ paas æ‰€éœ€çš„ clusterAdmin</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./scripts/create_k8s_cluster_admin_for_paas3.sh</span><br></pre></td></tr></table></figure>

<h2 id="3-5-å®‰è£…å…¥å£ç½‘å…³"><a href="#3-5-å®‰è£…å…¥å£ç½‘å…³" class="headerlink" title="3.5 å®‰è£…å…¥å£ç½‘å…³"></a>3.5 å®‰è£…å…¥å£ç½‘å…³</h2><h3 id="3-5-1-å®‰è£…-ingress-controller"><a href="#3-5-1-å®‰è£…-ingress-controller" class="headerlink" title="3.5.1 å®‰è£… ingress controller"></a>3.5.1 å®‰è£… ingress controller</h3><p>å…ˆæ£€æŸ¥ä½ çš„ç¯å¢ƒæ˜¯å¦å·²ç»éƒ¨ç½²äº† ingress controller:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl get pods -A -l app.kubernetes.io/name=ingress-nginx</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åˆ›å»ºï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helmfile -f 00-ingress-nginx.yaml.gotmpl sync</span><br><span class="line">kubectl get pods -A -l app.kubernetes.io/name=ingress-nginx  æŸ¥çœ‹åˆ›å»ºçš„pod</span><br></pre></td></tr></table></figure>

<p>popsé›†ç¾¤ç›¸å…³æ ‡ç­¾å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl get pods -A -l app=ingress-nginx  # æŸ¥çœ‹åˆ›å»ºçš„pod</span><br><span class="line">IP1=$(kubectl get svc -A -l app=nginx-ingress-lb -o jsonpath=&#x27;&#123;.items[0].status.loadBalancer.ingress[0].ip&#125;&#x27;)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IP1=$(kubectl get svc -A -l app.kubernetes.io/name=ingress-nginx -o jsonpath=<span class="string">&#x27;&#123;.items[0].status.loadBalancer.ingress[0].ip&#125;&#x27;</span>)</span></span><br></pre></td></tr></table></figure>

<h3 id="3-5-2-é…ç½®-coredns"><a href="#3-5-2-é…ç½®-coredns" class="headerlink" title="3.5.2 é…ç½® coredns"></a>3.5.2 é…ç½® coredns</h3><p>åœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­ï¼Œä¼šåœ¨å®¹å™¨å†…è®¿é—®è¿™äº›åŸŸåï¼Œæ‰€ä»¥éœ€è¦æå‰é…ç½® corednsï¼Œå°†è“é²¸åŸŸåè§£æåˆ° service IPã€‚</p>
<blockquote>
<p>æ³¨æ„: å½“ service è¢«åˆ é™¤ï¼Œé‡å»ºå clusterIP ä¼šå˜åŠ¨ï¼Œæ­¤æ—¶éœ€åˆ·æ–° hosts æ–‡ä»¶ã€‚</p>
</blockquote>
<p>å› æ­¤éœ€è¦æ³¨å…¥ hosts é…ç½®é¡¹åˆ° <code>kube-system</code> namespace ä¸‹çš„ <code>coredns</code> ç³»åˆ— pod</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•</span><br><span class="line">BK_DOMAIN=$(yq e &#x27;.domain.bkDomain&#x27; environments/default/custom.yaml)  # ä»è‡ªå®šä¹‰é…ç½®ä¸­æå–, ä¹Ÿå¯è‡ªè¡Œèµ‹å€¼</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">IP1=$(kubectl get svc -A -l app.kubernetes.io/instance=ingress-nginx -o jsonpath=<span class="string">&#x27;&#123;.items[0].spec.clusterIP&#125;&#x27;</span>)</span></span><br><span class="line">IP1=$(kubectl get svc -A -l app=nginx-ingress-lb -o jsonpath=&#x27;&#123;.items[0].status.loadBalancer.ingress[0].ip&#125;&#x27;)</span><br><span class="line">./scripts/control_coredns.sh update &quot;$IP1&quot; $BK_DOMAIN bkrepo.$BK_DOMAIN docker.$BK_DOMAIN bkapi.$BK_DOMAIN bkpaas.$BK_DOMAIN bkiam-api.$BK_DOMAIN bkiam.$BK_DOMAIN apps.$BK_DOMAIN bknodeman.$BK_DOMAIN job.$BK_DOMAIN jobapi.$BK_DOMAIN</span><br><span class="line">./scripts/control_coredns.sh update &quot;$IP1&quot; devops.$BK_DOMAIN</span><br><span class="line">./scripts/control_coredns.sh list  # æ£€æŸ¥æ·»åŠ çš„è®°å½•ã€‚</span><br></pre></td></tr></table></figure>

<p>ç¡®è®¤æ³¨å…¥ç»“æœï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  è¿›å…¥å·¥ä½œç›®å½•</span><br><span class="line">./scripts/control_coredns.sh list</span><br></pre></td></tr></table></figure>

<p>å‚è€ƒè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">172.27.124.109 bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkrepo.bkce.diezhi.net</span><br><span class="line">172.27.124.109 docker.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkapi.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkpaas.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkiam-api.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkiam.bkce.diezhi.net</span><br><span class="line">172.27.124.109 apps.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bknodeman.bkce.diezhi.net</span><br><span class="line">172.27.124.109 job.bkce.diezhi.net</span><br><span class="line">172.27.124.109 jobapi.bkce.diezhi.net</span><br><span class="line">172.27.124.109 devops.bkce.diezhi.net</span><br></pre></td></tr></table></figure>

<h2 id="3-6-éƒ¨ç½²æˆ–å¯¹æ¥å­˜å‚¨æœåŠ¡"><a href="#3-6-éƒ¨ç½²æˆ–å¯¹æ¥å­˜å‚¨æœåŠ¡" class="headerlink" title="3.6 éƒ¨ç½²æˆ–å¯¹æ¥å­˜å‚¨æœåŠ¡"></a>3.6 éƒ¨ç½²æˆ–å¯¹æ¥å­˜å‚¨æœåŠ¡</h2><h3 id="3-6-1-éƒ¨ç½²è“é²¸é¢„ç½®çš„å­˜å‚¨æœåŠ¡"><a href="#3-6-1-éƒ¨ç½²è“é²¸é¢„ç½®çš„å­˜å‚¨æœåŠ¡" class="headerlink" title="3.6.1 éƒ¨ç½²è“é²¸é¢„ç½®çš„å­˜å‚¨æœåŠ¡"></a>3.6.1 éƒ¨ç½²è“é²¸é¢„ç½®çš„å­˜å‚¨æœåŠ¡</h3><p>å‚è€ƒ<a href="https://bk.tencent.com/docs/markdown/ZH/DeploymentGuides/7.1/storage-services.md">å®˜æ–¹æ–‡æ¡£</a>å®‰è£…ï¼Œç›¸å…³helmé…ç½®å·²ç»æ”¾åœ¨<a href="https://opsgit.papegames.com/infra/devops">gitlabä»“åº“</a>ä¸Šç»´æŠ¤ï¼Œå¯ä»¥ç›´æ¥ç®€å•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helmfile -f base-storage.yaml.gotmpl sync</span><br></pre></td></tr></table></figure>

<h3 id="3-6-2-å¯¹æ¥å·²æœ‰çš„å­˜å‚¨æœåŠ¡"><a href="#3-6-2-å¯¹æ¥å·²æœ‰çš„å­˜å‚¨æœåŠ¡" class="headerlink" title="3.6.2 å¯¹æ¥å·²æœ‰çš„å­˜å‚¨æœåŠ¡"></a>3.6.2 å¯¹æ¥å·²æœ‰çš„å­˜å‚¨æœåŠ¡</h3><p>ç¦ç”¨è“é²¸å†…ç½®æœåŠ¡ï¼Œé…ç½®ä½¿ç”¨å·²æœ‰æœåŠ¡ã€‚helmfile å®šä¹‰åŠ values æ–‡ä»¶å·²ç»æ”¾åœ¨gitlabä»“åº“ä¸Šç»´æŠ¤ã€‚</p>
<p>æ­¤å¤„å¯ç›´æ¥è·³è¿‡ã€‚</p>
<h2 id="3-7-éƒ¨ç½²åŸºç¡€å¥—é¤"><a href="#3-7-éƒ¨ç½²åŸºç¡€å¥—é¤" class="headerlink" title="3.7 éƒ¨ç½²åŸºç¡€å¥—é¤"></a>3.7 éƒ¨ç½²åŸºç¡€å¥—é¤</h2><p>é€šè¿‡helmfileå®‰è£… base-blueking.yaml.gotmpl ï¼ŒæŒ‰ç…§é¡ºåºä¾æ¬¡å®‰è£…ã€‚å…·ä½“æ¯å±‚å®‰è£…çš„å†…å®¹å¯ä»¥æŸ¥çœ‹æ–‡ä»¶å†…å®¹ã€‚<br>å‚è€ƒ<a href="https://bk.tencent.com/docs/markdown/ZH/DeploymentGuides/7.1/storage-services.md">å®˜æ–¹æ–‡æ¡£</a>å®‰è£…ï¼Œç›¸å…³helmé…ç½®å·²ç»æ”¾åœ¨gitlabä»“åº“ä¸Šç»´æŠ¤ï¼Œå¯ä»¥ç›´æ¥ç®€å•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helmfile -f base-blueking.yaml.gotmpl -l seq=first sync</span><br><span class="line">helmfile -f base-blueking.yaml.gotmpl -l seq=second sync</span><br><span class="line">helmfile -f base-blueking.yaml.gotmpl -l seq=third sync</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">helmfile -f base-blueking.yaml.gotmpl -l <span class="built_in">seq</span>=fourth <span class="built_in">sync</span></span></span><br></pre></td></tr></table></figure>

<h2 id="3-8-è®¿é—®è“é²¸æ¡Œé¢"><a href="#3-8-è®¿é—®è“é²¸æ¡Œé¢" class="headerlink" title="3.8 è®¿é—®è“é²¸æ¡Œé¢"></a>3.8 è®¿é—®è“é²¸æ¡Œé¢</h2><p>åœ¨è´Ÿè½½å‡è¡¡å™¨é…ç½®åç«¯ä¸º ingress-nginx pod æ‰€åœ¨æœºå™¨çš„å†…ç½‘ IPï¼Œç«¯å£ä¸º 80ã€‚è¯¦ç»†ä¿¡æ¯å‚è€ƒ<a href="https://bk.tencent.com/docs/markdown/ZH/DeploymentGuides/7.1/manual-install-bkce.md">æ–‡æ¡£</a>ã€‚</p>
<h3 id="3-8-1-æŸ¥æ‰¾ingress-nginx-svc"><a href="#3-8-1-æŸ¥æ‰¾ingress-nginx-svc" class="headerlink" title="3.8.1 æŸ¥æ‰¾ingress nginx svc"></a>3.8.1 æŸ¥æ‰¾ingress nginx svc</h3><p>æ‰¾åˆ°ingress nginxçš„svc</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pops</span></span><br><span class="line">kubectl get svc -n kube-system|grep ingress</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pops-dev</span></span><br><span class="line">kubectl get svc -n ingress-nginx|grep ingress</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pops</span></span><br><span class="line">ingress-nginx-controller-admission        ClusterIP      172.26.10.30    &lt;none&gt;          443/TCP                        3y69d</span><br><span class="line">nginx-ingress-lb                          LoadBalancer   172.26.1.155    10.212.14.158   80:30725/TCP,443:31357/TCP     3y69d</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pops-dev</span></span><br><span class="line">ingress-nginx-controller             NodePort    172.27.124.109   &lt;none&gt;        80:32080/TCP,443:32443/TCP   279d</span><br><span class="line">ingress-nginx-controller-admission   ClusterIP   172.27.123.38    &lt;none&gt;        443/TCP                      279d</span><br><span class="line">ingress-nginx-controller-metrics     ClusterIP   172.27.116.175   &lt;none&gt;        10254/TCP                    279d</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>nginx-ingress-lb</code>æ˜¯ç›®å‰<code>popsé›†ç¾¤</code>çš„<code>ingress nginx svc</code>ï¼Œè€Œ<code>ingress-nginx-controller</code>æ˜¯ç›®å‰<code>pops-devé›†ç¾¤</code>çš„<code>ingress nginx svc</code>ã€‚</p>
<h3 id="3-8-2-è®¾ç½®svc-typeä¸ºLoadBalancer"><a href="#3-8-2-è®¾ç½®svc-typeä¸ºLoadBalancer" class="headerlink" title="3.8.2 è®¾ç½®svc typeä¸ºLoadBalancer"></a>3.8.2 è®¾ç½®svc typeä¸ºLoadBalancer</h3><p>æŸ¥çœ‹svc typeï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹popsé›†ç¾¤ingress nginx svcå‘½ä»¤</span></span><br><span class="line">kubectl get svc/nginx-ingress-lb -n kube-system -oyaml|grep type</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹pops-devé›†ç¾¤ingress nginx svcå‘½ä»¤</span></span><br><span class="line">kubectl get svc/ingress-nginx-controller -n ingress-nginx -oyaml|grep type</span><br></pre></td></tr></table></figure>

<p>è‹¥æ— <code>type: LoadBalancer</code>ç»“æœï¼Œåˆ™æ‰‹åŠ¨è¿›è¡Œä¿®æ”¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹popsé›†ç¾¤ingress nginx svcå‘½ä»¤</span></span><br><span class="line">kubectl edit svc/nginx-ingress-lb -n kube-system</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹pops-devé›†ç¾¤ingress nginx svcå‘½ä»¤</span></span><br><span class="line">kubectl edit svc/ingress-nginx-controller -n ingress-nginx</span><br></pre></td></tr></table></figure>

<h3 id="3-8-3-è´Ÿè½½å‡è¡¡clbå®ä¾‹"><a href="#3-8-3-è´Ÿè½½å‡è¡¡clbå®ä¾‹" class="headerlink" title="3.8.3 è´Ÿè½½å‡è¡¡clbå®ä¾‹"></a>3.8.3 è´Ÿè½½å‡è¡¡clbå®ä¾‹</h3><p>æŸ¥çœ‹svc yamlæ˜¯å¦åŒ…å«ä¸¤ä¸ªé‡è¦annotationï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹popsé›†ç¾¤ingress nginx svcå‘½ä»¤</span></span><br><span class="line">kubectl get svc/nginx-ingress-lb -n kube-system -oyaml|grep service.beta.kubernetes.io/alibaba-cloud-loadbalancer-force-override-listeners</span><br><span class="line">kubectl get svc/nginx-ingress-lb -n kube-system -oyaml|grep service.beta.kubernetes.io/alibaba-cloud-loadbalancer-id</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹pops-devé›†ç¾¤ingress nginx svcå‘½ä»¤</span></span><br><span class="line">kubectl get svc/ingress-nginx-controller -n ingress-nginx -oyaml|grep service.beta.kubernetes.io/alibaba-cloud-loadbalancer-force-override-listeners</span><br><span class="line">kubectl get svc/ingress-nginx-controller -n ingress-nginx -oyaml|grep service.beta.kubernetes.io/alibaba-cloud-loadbalancer-id</span><br></pre></td></tr></table></figure>

<p>è‹¥è¿™ä¸¤ä¸ªé‡è¦annotationç¼ºå¤±ï¼Œåˆ™éœ€è¿›è¡Œè®¾ç½®ã€‚</p>
<p>è´Ÿè½½å‡è¡¡æ§åˆ¶å°åœ°å€ï¼š<a href="https://slb.console.aliyun.com/overview">https://slb.console.aliyun.com/overview</a></p>
<p>æ‰¾åˆ°<code>pops-dev</code>é›†ç¾¤çš„clbï¼š<code>pops-k8s-dev-ingress</code><br><img src="/img_12.png" alt="img_12.png"></p>
<p>æ‰¾åˆ°<code>pops</code>é›†ç¾¤çš„clbï¼š<code>k8s-pops-ingress-slb</code><br><img src="/img_14.png" alt="img_14.png"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹popsé›†ç¾¤ingress nginx svcå‘½ä»¤</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">popsé›†ç¾¤clbåç§°ï¼šk8s-pops-ingress-slb</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">popsé›†ç¾¤clb <span class="built_in">id</span>ï¼šlb-bp1tt6vxctuzi38mqfkw0</span></span><br><span class="line">kubectl edit svc/nginx-ingress-lb -n kube-system</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹pops-devé›†ç¾¤ingress nginx svcå‘½ä»¤</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pops-devé›†ç¾¤clbåç§°ï¼špops-k8s-dev-ingress</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pops-devé›†ç¾¤clb <span class="built_in">id</span>ï¼šlb-bp1r1dsywnqktp1hxih38</span></span><br><span class="line">kubectl edit svc/ingress-nginx-controller -n ingress-nginx</span><br></pre></td></tr></table></figure>

<h3 id="3-8-4-è®¿é—®åœ°å€"><a href="#3-8-4-è®¿é—®åœ°å€" class="headerlink" title="3.8.4 è®¿é—®åœ°å€"></a>3.8.4 è®¿é—®åœ°å€</h3><p>æŸ¥çœ‹æµè§ˆå™¨è®¿é—®åœ°å€ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä»è‡ªå®šä¹‰é…ç½®ä¸­æå–</span></span><br><span class="line">BK_DOMAIN=$(yq e &#x27;.domain.bkDomain&#x27; environments/default/custom.yaml)  </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ™®é€šç™»å½•åœ°å€(æ¥å…¥ç»Ÿä¸€ç™»å½•ï¼Œä¸”ç™»å½•æˆåŠŸåä¼šè·³è½¬è“ç›¾)</span></span><br><span class="line">echo &quot;http://$BK_DOMAIN&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">adminç™»å½•åœ°å€(æ¥å…¥ç»Ÿä¸€ç™»å½•åï¼Œå¯é€šè¿‡æ­¤æ–¹æ³•é€‚ç”¨adminç™»å½•)</span></span><br><span class="line">echo &quot;http://$&#123;BK_DOMAIN&#125;/login/origin/&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æµ‹è¯•ç¯å¢ƒä¸€èˆ¬ç»“æœä¸ºï¼šhttp://bkce.diezhi.net/login/origin/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿäº§ç¯å¢ƒä¸€èˆ¬ç»“æœä¸ºï¼šhttps://bk.diezhi.net/login/origin/</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹ç”¨æˆ·å¯†ç (é¢„è®¾åŸå§‹å¯†ç )ï¼š</span></span><br><span class="line">kubectl get cm -n blueking bk-user-api-general-envs -o go-template=&#x27;user=&#123;&#123;.data.INITIAL_ADMIN_USERNAME&#125;&#125;&#123;&#123;&quot;\n&quot;&#125;&#125;password=&#123;&#123; .data.INITIAL_ADMIN_PASSWORD &#125;&#125;&#123;&#123;&quot;\n&quot;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="3-9-å¯¹æ¥LdapæœåŠ¡"><a href="#3-9-å¯¹æ¥LdapæœåŠ¡" class="headerlink" title="3.9 å¯¹æ¥LdapæœåŠ¡"></a>3.9 å¯¹æ¥LdapæœåŠ¡</h2><p>åœ¨ç”¨æˆ·ä¸­å¿ƒé‡Œé…ç½®Ldapç›¸å…³é…ç½®ï¼Œç„¶åæ›´æ–° bk-user-api-web æœåŠ¡çš„é•œåƒã€‚<br><img src="/img_22.png" alt="img_22.png"><br><img src="/img_23.png" alt="img_23.png"></p>
<h1 id="4-éƒ¨ç½²è“ç›¾"><a href="#4-éƒ¨ç½²è“ç›¾" class="headerlink" title="4. éƒ¨ç½²è“ç›¾"></a>4. éƒ¨ç½²è“ç›¾</h1><p>å‚è€ƒ<a href="https://bk.tencent.com/docs/markdown/ZH/DeploymentGuides/7.1/install-ci-suite.md">å®˜æ–¹æ–‡æ¡£</a>éƒ¨ç½²ï¼Œé…ç½® custom values çš„å†…å®¹æå‰ä¿®æ”¹å®Œæˆï¼Œæ‰§è¡Œç±»ä¼¼éƒ¨ç½²åŸºç¡€æœåŠ¡çš„ä»¥ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•</span><br><span class="line">helmfile -f 03-bkci.yaml.gotmpl sync  # éƒ¨ç½²</span><br><span class="line">helmfile -f 03-bkci.yaml.gotmpl apply # æ›´æ–°</span><br></pre></td></tr></table></figure>
<p>å‰©ä¸‹çš„æ­¥éª¤å‚è€ƒå®˜æ–¹æ–‡æ¡£æ‰§è¡Œå³å¯ï¼Œä¸»è¦æ­¥éª¤æœ‰ä»¥ä¸‹ä¸‰ä¸ªï¼Œå…¶ä»–çš„æ­¥éª¤å¯ä»¥ä¸åšã€‚</p>
<h2 id="4-1-å¯é€‰-æ³¨å†Œé»˜è®¤æ„å»ºé•œåƒ"><a href="#4-1-å¯é€‰-æ³¨å†Œé»˜è®¤æ„å»ºé•œåƒ" class="headerlink" title="4.1 [å¯é€‰]æ³¨å†Œé»˜è®¤æ„å»ºé•œåƒ"></a>4.1 [å¯é€‰]æ³¨å†Œé»˜è®¤æ„å»ºé•œåƒ</h2><p>æˆ‘ä»¬æä¾›äº† bkci&#x2F;ci é•œåƒç”¨äºæä¾›æ„å»ºç¯å¢ƒã€‚ä¸ºäº†åŠ é€Ÿé•œåƒä¸‹è½½è¿‡ç¨‹ï¼Œå¯ä»¥ä¿®æ”¹é•œåƒåœ°å€ä¸º hub.bktencent.com&#x2F;bkci&#x2F;ciï¼Œæˆ–è€…ä¸ºä½ è‡ªå·±æ‰˜ç®¡çš„å†…ç½‘ registryã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl exec -it -n blueking bk-ci-mysql-0 -- /bin/bash -c &#x27;MYSQL_PWD=&quot;$MYSQL_ROOT_PASSWORD&quot; mysql -u root -e &quot;USE devops_ci_store; SELECT IMAGE_NAME,IMAGE_CODE,IMAGE_REPO_NAME FROM T_IMAGE WHERE IMAGE_CODE = \&quot;bkci\&quot; ;&quot;&#x27;</span><br></pre></td></tr></table></figure>

<p>è¯·æ ¹æ®ç»“æœè¿›è¡Œæ“ä½œï¼š</p>
<ul>
<li><p>å¦‚æœæœ‰æ˜¾ç¤ºé•œåƒæ•°æ®ï¼Œå¯ä»¥ä¿®æ”¹é•œåƒåœ°å€ä¸ºè“é²¸å›½å†…ä»“åº“ï¼Œä¹Ÿå¯æ”¹ä¸ºä½ å·²ç»ç¼“å­˜åœ¨å†…ç½‘çš„é•œåƒï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl exec -it -n blueking bk-ci-mysql-0 -- /bin/bash -c &#x27;MYSQL_PWD=&quot;$MYSQL_ROOT_PASSWORD&quot; mysql -u root -e &quot;USE devops_ci_store; UPDATE  T_IMAGE SET IMAGE_REPO_NAME=\&quot;hub.bktencent.com/bkci/ci\&quot; WHERE IMAGE_CODE = \&quot;bkci\&quot; ;&quot;&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç„¶åé‡æ–°æŸ¥è¯¢æ•°æ®åº“ï¼Œå¯ä»¥çœ‹åˆ° IMAGE_REPO_NAME åˆ—å·²ç»æ›´æ–°ã€‚</p>
</li>
<li><p>å¦‚æœæ²¡æœ‰é•œåƒï¼Œå¯ä»¥æ–°å¢ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl exec -n blueking deploy/bk-ci-bk-ci-store -- \curl -vs http://bk-ci-bk-ci-store.blueking.svc.cluster.local/api/op/market/image/init -X POST \-H &#x27;X-DEVOPS-UID: admin&#x27; -H &#x27;Content-type: application/json&#x27; -d &#x27;&#123;&quot;imageCode&quot;:&quot;bkci&quot;,&quot;imageName&quot;:&quot;bkci&quot;,&quot;imageRepo&quot;:&quot;hub.bktencent.com/bkci/ci&quot;,&quot;projectCode&quot;:&quot;demo&quot;,&quot;userId&quot;:&quot;admin&quot;&#125;&#x27; | jq .</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<ul>
<li>æç¤º</li>
<li>å½“ä½ å•ç‹¬å¸è½½è“ç›¾é‡è£…åï¼Œå¯èƒ½å‡ºç°æŸ¥è¯¢é•œåƒä¸ºç©ºï¼Œä½†æ˜¯æ–°å¢é•œåƒæ—¶æŠ¥é”™ { status: 400, message: â€œæƒé™ä¸­å¿ƒåˆ›å»ºé¡¹ç›®å¤±è´¥â€ } çš„æƒ…å†µã€‚è¿™æ˜¯å› ä¸ºæƒé™ä¸­å¿ƒå­˜åœ¨è“ç›¾ demo é¡¹ç›®çš„æ•°æ®æ‰€è‡´ï¼Œæˆ‘ä»¬åç»­ä¼šä¼˜åŒ–è“ç›¾å•ç‹¬å¸è½½çš„æ–‡æ¡£ã€‚è¯·å…ˆæ‰‹åŠ¨æ–°å»ºé¡¹ç›®ï¼Œå¹¶ä¿®æ”¹ä¸Šè¿°ä»£ç ä¸­ projectCode å­—æ®µçš„å€¼ã€‚</li>
</ul>
</blockquote>
<h3 id="4-1-1-è§£å†³æƒé™ä¸­å¿ƒåˆ›å»ºé¡¹ç›®å¤±è´¥"><a href="#4-1-1-è§£å†³æƒé™ä¸­å¿ƒåˆ›å»ºé¡¹ç›®å¤±è´¥" class="headerlink" title="4.1.1 è§£å†³æƒé™ä¸­å¿ƒåˆ›å»ºé¡¹ç›®å¤±è´¥"></a>4.1.1 è§£å†³æƒé™ä¸­å¿ƒåˆ›å»ºé¡¹ç›®å¤±è´¥</h3><p>åœ¨ ä¸­æ§æœº æ‰§è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•</span><br><span class="line">./scripts/control_coredns.sh list  # æ£€æŸ¥æ·»åŠ çš„è®°å½•ã€‚</span><br></pre></td></tr></table></figure>

<p>ä¼šå¾—åˆ°ç±»ä¼¼çš„ç»“æœï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">172.27.124.109 devops.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkrepo.bkce.diezhi.net</span><br><span class="line">172.27.124.109 docker.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkapi.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkpaas.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkiam-api.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bkiam.bkce.diezhi.net</span><br><span class="line">172.27.124.109 apps.bkce.diezhi.net</span><br><span class="line">172.27.124.109 bknodeman.bkce.diezhi.net</span><br><span class="line">172.27.124.109 job.bkce.diezhi.net</span><br><span class="line">172.27.124.109 jobapi.bkce.diezhi.net</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨adminè´¦å·é€šè¿‡æµè§ˆå™¨è®¿é—®devops.bkce.diezhi.netï¼Œå¹¶åˆ›å»ºé¡¹ç›®ï¼š<br><img src="/img_15.png" alt="img_15.png"></p>
<p><img src="/img_16.png" alt="img_16.png"></p>
<p><img src="/img_17.png" alt="img_17.png"></p>
<p>æ­¤æ—¶é‡æ–°æ–°å¢ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl exec -n blueking deploy/bk-ci-bk-ci-store -- \curl -vs http://bk-ci-bk-ci-store.blueking.svc.cluster.local/api/op/market/image/init -X POST \-H &#x27;X-DEVOPS-UID: admin&#x27; -H &#x27;Content-type: application/json&#x27; -d &#x27;&#123;&quot;imageCode&quot;:&quot;bkci&quot;,&quot;imageName&quot;:&quot;bkci&quot;,&quot;imageRepo&quot;:&quot;hub.bktencent.com/bkci/ci&quot;,&quot;projectCode&quot;:&quot;huari-demo&quot;,&quot;userId&quot;:&quot;admin&quot;&#125;&#x27; | jq .</span><br></pre></td></tr></table></figure>

<p>å¦‚æ–°å»ºé¡¹ç›®é‡è§å¯æˆæƒäººå‘˜èŒƒå›´åŠ è½½ä¸å‡ºæ¥(ç™½å±è½¬åœˆåœˆ)</p>
<p>éœ€è¦ç¡®å®šè·³è½¬ä»è“é²¸è·³è½¬è“ç›¾æ˜¯å¦æ˜¯èµ°äº†httpsï¼Œæœ¬æ–‡æ¡£æ˜¯ä½¿ç”¨httpéƒ¨ç½²ï¼Œæ‰€ä»¥ä½¿ç”¨httpsä¼šå‡ºç°é—®é¢˜<br><img src="/img_18.png" alt="img_18.png"></p>
<h2 id="4-2-å¯è·³è¿‡-å¯¹æ¥åˆ¶å“åº“"><a href="#4-2-å¯è·³è¿‡-å¯¹æ¥åˆ¶å“åº“" class="headerlink" title="4.2 [å¯è·³è¿‡]å¯¹æ¥åˆ¶å“åº“"></a>4.2 [å¯è·³è¿‡]å¯¹æ¥åˆ¶å“åº“</h2><p>è“ç›¾ä¾é è“é²¸åˆ¶å“åº“æ¥æä¾›æµæ°´çº¿ä»“åº“å’Œè‡ªå®šä¹‰ä»“åº“ï¼Œéœ€è¦è°ƒæ•´åˆ¶å“åº“çš„è®¤è¯æ¨¡å¼ã€‚</p>
<p>å½“ <code>bk-ci</code> release æˆåŠŸå¯åŠ¨åï¼Œæˆ‘ä»¬å¼€å§‹é…ç½®è“é²¸åˆ¶å“åº“ï¼Œå¹¶æ³¨å†Œåˆ°è“ç›¾ä¸­ã€‚</p>
<h3 id="4-2-1-ä¿®æ”¹-bk-repo-custom-values"><a href="#4-2-1-ä¿®æ”¹-bk-repo-custom-values" class="headerlink" title="4.2.1 ä¿®æ”¹ bk-repo custom values"></a>4.2.1 ä¿®æ”¹ bk-repo custom values</h3><p>ç›¸å…³é…ç½®å·²ç»æ”¾åœ¨gitlabä»“åº“ä¸Šç»´æŠ¤ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡æœ¬æ­¥éª¤ã€‚</p>
<p>[å¯è·³è¿‡]è¯·åœ¨ ä¸­æ§æœº æ‰§è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•</span><br><span class="line">case $(yq e &#x27;.auth.config.realm&#x27; environments/default/bkrepo-custom-values.yaml.gotmpl 2&gt;/dev/null) in</span><br><span class="line">  null|&quot;&quot;)</span><br><span class="line">    tee -a environments/default/bkrepo-custom-values.yaml.gotmpl &lt;&lt;&lt; $&#x27;auth:\n  config:\n    realm: devops&#x27;</span><br><span class="line">  ;;</span><br><span class="line">  devops)</span><br><span class="line">    echo &quot;environments/default/bkrepo-custom-values.yaml.gotmpl ä¸­é…ç½®äº† .auth.config.realm=devops, æ— éœ€ä¿®æ”¹.&quot;</span><br><span class="line">  ;;</span><br><span class="line">  *)</span><br><span class="line">    echo &quot;environments/default/bkrepo-custom-values.yaml.gotmpl ä¸­é…ç½®äº† .auth.config.realm ä¸ºå…¶ä»–å€¼, è¯·æ‰‹åŠ¨ä¿®æ”¹å€¼ä¸º devops.&quot;</span><br><span class="line">  ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<p>[å¯è·³è¿‡]ä¿®æ”¹æˆåŠŸåï¼Œç»§ç»­åœ¨å·¥ä½œç›®å½•æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ä½¿ä¿®æ”¹ç”Ÿæ•ˆï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helmfile -f base-blueking.yaml.gotmpl -l name=bk-repo apply</span><br></pre></td></tr></table></figure>

<h3 id="4-2-2-æ£€æŸ¥é…ç½®æ˜¯å¦ç”Ÿæ•ˆ"><a href="#4-2-2-æ£€æŸ¥é…ç½®æ˜¯å¦ç”Ÿæ•ˆ" class="headerlink" title="4.2.2 æ£€æŸ¥é…ç½®æ˜¯å¦ç”Ÿæ•ˆ"></a>4.2.2 æ£€æŸ¥é…ç½®æ˜¯å¦ç”Ÿæ•ˆ</h3><p>æ£€æŸ¥ release ç”Ÿæ•ˆçš„ values å’Œ configmap æ˜¯å¦é‡æ–°æ¸²æŸ“ã€‚</p>
<p>[å¯è·³è¿‡]è¯·åœ¨ ä¸­æ§æœº æ‰§è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm get values -n blueking bk-repo | yq e &#x27;.auth.config.realm&#x27;</span><br><span class="line">kubectl get cm -n blueking bk-repo-bkrepo-auth -o json | jq -r &#x27;.data.&quot;application.yml&quot;&#x27; | yq e &#x27;.auth.realm&#x27; -</span><br></pre></td></tr></table></figure>

<h3 id="4-2-3-é‡å¯-bk-repo-auth-å¾®æœåŠ¡"><a href="#4-2-3-é‡å¯-bk-repo-auth-å¾®æœåŠ¡" class="headerlink" title="4.2.3 é‡å¯ bk-repo auth å¾®æœåŠ¡"></a>4.2.3 é‡å¯ bk-repo auth å¾®æœåŠ¡</h3><p>å› ä¸ºå¯¹æ¥åˆ¶å“åº“çš„ç›¸å…³ä¿¡æ¯å·²ç»åœ¨gitlabä»“åº“ä¸Šç»´æŠ¤äº†ï¼Œæ‰€ä»¥æ­¤å¤„ä¸ç”¨è¿›è¡Œé‡å¯ã€‚</p>
<p>[å¯è·³è¿‡]å› ä¸º deployment æ²¡æœ‰å˜åŠ¨ï¼Œæ‰€ä»¥ä¸ä¼šè‡ªåŠ¨é‡å¯ï¼Œæ­¤å¤„éœ€è¦å•ç‹¬é‡å¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl rollout restart deployment -n blueking bk-repo-bkrepo-auth</span><br></pre></td></tr></table></figure>

<h3 id="4-2-4-åœ¨è“ç›¾ä¸­æ³¨å†Œåˆ¶å“åº“"><a href="#4-2-4-åœ¨è“ç›¾ä¸­æ³¨å†Œåˆ¶å“åº“" class="headerlink" title="4.2.4 åœ¨è“ç›¾ä¸­æ³¨å†Œåˆ¶å“åº“"></a>4.2.4 åœ¨è“ç›¾ä¸­æ³¨å†Œåˆ¶å“åº“</h3><p>[å¯è·³è¿‡]è¯·åœ¨ ä¸­æ§æœº æ‰§è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•</span><br><span class="line">BK_DOMAIN=$(yq e &#x27;.domain.bkDomain&#x27; environments/default/custom.yaml)  # ä»è‡ªå®šä¹‰é…ç½®ä¸­æå–, ä¹Ÿå¯è‡ªè¡Œèµ‹å€¼# å‘projectå¾®æœåŠ¡æ³¨å†Œåˆ¶å“åº“</span><br><span class="line">kubectl exec -i -n blueking deploy/bk-ci-bk-ci-project -- curl -sS -X PUT -H &#x27;Content-Type: application/json&#x27; -H &#x27;Accept: application/json&#x27; -H &#x27;X-DEVOPS-UID: admin&#x27; -d &quot;&#123;\&quot;showProjectList\&quot;:true,\&quot;showNav\&quot;:true,\&quot;status\&quot;:\&quot;ok\&quot;,\&quot;deleted\&quot;:false,\&quot;iframeUrl\&quot;:\&quot;//bkrepo.$BK_DOMAIN/ui/\&quot;&#125;&quot; &quot;http://bk-ci-bk-ci-project.blueking.svc.cluster.local/api/op/services/update/Repo&quot;</span><br></pre></td></tr></table></figure>

<h2 id="4-3-å¯é€‰-ä¸‹è½½å’Œä¸Šä¼ æ’ä»¶"><a href="#4-3-å¯é€‰-ä¸‹è½½å’Œä¸Šä¼ æ’ä»¶" class="headerlink" title="4.3 [å¯é€‰]ä¸‹è½½å’Œä¸Šä¼ æ’ä»¶"></a>4.3 [å¯é€‰]ä¸‹è½½å’Œä¸Šä¼ æ’ä»¶</h2><h3 id="4-3-1-ä¸‹è½½æ’ä»¶"><a href="#4-3-1-ä¸‹è½½æ’ä»¶" class="headerlink" title="4.3.1 ä¸‹è½½æ’ä»¶"></a>4.3.1 ä¸‹è½½æ’ä»¶</h3><p>è¯·åœ¨ ä¸­æ§æœº æ‰§è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bkdl-7.1-stable.sh -ur latest ci-plugins</span><br></pre></td></tr></table></figure>

<h3 id="4-3-2-ä¸Šä¼ æ’ä»¶"><a href="#4-3-2-ä¸Šä¼ æ’ä»¶" class="headerlink" title="4.3.2 ä¸Šä¼ æ’ä»¶"></a>4.3.2 ä¸Šä¼ æ’ä»¶</h3><p>æ­¤æ“ä½œåªèƒ½æ–°å»ºæ’ä»¶ï¼Œæ¯ä¸ªæ’ä»¶åªèƒ½ä¸Šä¼ ä¸€æ¬¡ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•</span><br><span class="line">for f in ../ci-plugins/*.zip; do</span><br><span class="line">    atom=&quot;$&#123;f##*/&#125;&quot;</span><br><span class="line">    atom=$&#123;atom%.zip&#125;</span><br><span class="line">    echo &gt;&amp;2 &quot;upload $atom from $f&quot;</span><br><span class="line">    kubectl exec -i -n blueking deploy/bk-ci-bk-ci-store -- \</span><br><span class="line">      curl -s \</span><br><span class="line">      http://bk-ci-bk-ci-store.blueking.svc.cluster.local/api/op/pipeline/atom/deploy/&quot;?publisher=admin&quot; \</span><br><span class="line">      -H &#x27;X-DEVOPS-UID: admin&#x27; -F atomCode=$atom -F file=@- &lt; &quot;$f&quot; | jq .</span><br><span class="line">      # è®¾ç½®ä¸ºé»˜è®¤æ’ä»¶ï¼Œå…¨éƒ¨é¡¹ç›®å¯è§ã€‚</span><br><span class="line">    kubectl exec -n blueking deploy/bk-ci-bk-ci-store -- \</span><br><span class="line">    curl -s http://bk-ci-bk-ci-store.blueking.svc.cluster.local/api/op/pipeline/atom/default/atomCodes/$atom \-H &#x27;X-DEVOPS-UID: admin&#x27; -X POST | jq .</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="4-3-3-é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ"><a href="#4-3-3-é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ" class="headerlink" title="4.3.3 é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ"></a>4.3.3 é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ</h3><p><code>è¿™ä¸ªé—®é¢˜å·²ç»åœ¨è“ç›¾çš„helm chartsé‡Œé¢è¿›è¡Œäº†ä¼˜åŒ–</code></p>
<p>ä¸Šä¼ æ’ä»¶æ—¶ä¼šç¢°åˆ°è¿™ä¸ªé—®é¢˜ï¼š<br><img src="/img_19.png" alt="img_19.png"></p>
<p>è“ç›¾å®˜æ–¹æ–‡æ¡£è¯´æ³•æ˜¯ï¼š<br><img src="/img_20.png" alt="img_20.png"></p>
<p>å®é™…åŸå› æ˜¯ï¼šHTTPè¯·æ±‚æŠ¥äº† 413 Request Entity Too Large</p>
<p>å…·ä½“è§£å†³æ–¹å¼è¯¦è§ï¼š<a href="https://developer.aliyun.com/article/1001630">Ingress åŸŸåæ–¹å¼å¯¼è‡´413 Request Entity Too Large-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº</a></p>
<p>é€ æˆè¿™ä¸ªé—®é¢˜çš„ä¸»è¦åŸå› æ˜¯nginx-ingressçš„é»˜è®¤é…ç½®ä¸­proxy-body-sizeçš„æ•°å€¼å¤ªå°<br><img src="/img_21.png" alt="img_21.png"></p>
<h1 id="5-æ”¯æŒhttps"><a href="#5-æ”¯æŒhttps" class="headerlink" title="5. æ”¯æŒhttps"></a>5. æ”¯æŒhttps</h1><p>å¦‚æœå¼€å§‹å°±å‡†å¤‡å¥½äº†ç›¸å…³è¯ä¹¦ï¼Œé‚£ä¹ˆå¯ä»¥å°†è¯¥æ­¥éª¤æå‰ï¼Œåœ¨éƒ¨ç½²åŸºç¡€æœåŠ¡å’Œè“ç›¾ä¹‹å‰å°±å…ˆä¿®æ”¹å¥½ç›¸å…³çš„yamlï¼Œå°†éœ€è¦åˆ›å»ºçš„Secretå’Œè¦æ›´æ–°çš„Ingressé…ç½®éƒ½æå‰ä¿®æ”¹å¥½ï¼Œç„¶åç›´æ¥éƒ¨ç½²å³å¯ã€‚</p>
<h2 id="5-1-è´­ä¹°ç›¸å…³è¯ä¹¦"><a href="#5-1-è´­ä¹°ç›¸å…³è¯ä¹¦" class="headerlink" title="5.1 è´­ä¹°ç›¸å…³è¯ä¹¦"></a>5.1 è´­ä¹°ç›¸å…³è¯ä¹¦</h2><p>æ¶‰åŠçš„åŸŸåï¼šbk.blazehu.comã€*.bk.blazehu.comï¼ˆå¦‚devops.bk.blazehu.comï¼‰ã€‚éœ€è´­ä¹°æ³›åŸŸåè¯ä¹¦ã€‚</p>
<h2 id="5-2-åˆ›å»ºç›¸å…³Secretï¼ˆç”¨äºå­˜å‚¨TLSè¯ä¹¦å’Œç§é’¥ï¼‰"><a href="#5-2-åˆ›å»ºç›¸å…³Secretï¼ˆç”¨äºå­˜å‚¨TLSè¯ä¹¦å’Œç§é’¥ï¼‰" class="headerlink" title="5.2 åˆ›å»ºç›¸å…³Secretï¼ˆç”¨äºå­˜å‚¨TLSè¯ä¹¦å’Œç§é’¥ï¼‰"></a>5.2 åˆ›å»ºç›¸å…³Secretï¼ˆç”¨äºå­˜å‚¨TLSè¯ä¹¦å’Œç§é’¥ï¼‰</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºSecret</span></span><br><span class="line">BK_DOMAIN=$(yq e &#x27;.domain.bkDomain&#x27; environments/default/custom.yaml)</span><br><span class="line">cd $HOME/$BK_DOMAIN</span><br><span class="line">kubectl create secret tls $BK_DOMAIN -n blueking --cert=$HOME/$BK_DOMAIN/$BK_DOMAIN.pem --key=$HOME/$BK_DOMAIN/$BK_DOMAIN.key</span><br><span class="line">â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span><br><span class="line">æœ¬æ–‡é“¾æ¥ï¼šhttps://blazehu.com/2024/05/24/devops/landun_install/</span><br><span class="line">ç‰ˆæƒå£°æ˜ï¼š æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ CC BY 4.0 CNåè®® è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</span><br></pre></td></tr></table></figure>

<h2 id="5-3-æ›´æ–°-Ingress-TLS"><a href="#5-3-æ›´æ–°-Ingress-TLS" class="headerlink" title="5.3 æ›´æ–° Ingress TLS"></a>5.3 æ›´æ–° Ingress TLS</h2><p>åœ¨è¯ä¹¦åŠè¯ä¹¦secretå‡†å¤‡å¥½ä¹‹åï¼Œéœ€è¦å˜æ›´è“é²¸ç³»åˆ—ingresså¼€å¯tlsçš„æ”¯æŒï¼Œæ‰§è¡Œå¯¹åº”çš„è„šæœ¬</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®å˜é‡</span></span><br><span class="line">NAMESPACE=&quot;blueking&quot;</span><br><span class="line">DOMAIN_FILE=&quot;environments/default/custom.yaml&quot;</span><br><span class="line">BK_DOMAIN=$(yq e &#x27;.domain.bkDomain&#x27; &quot;$DOMAIN_FILE&quot;)  # ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–åŸŸå</span><br><span class="line">TLS_HOST=&quot;*.$BK_DOMAIN&quot;  # æ³›åŸŸå</span><br><span class="line">TLS_SECRET=&quot;$BK_DOMAIN&quot;  # Secret åç§°ä¸åŸŸåä¸€è‡´</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥åŸŸåå’Œ Secret æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">if [[ -z &quot;$BK_DOMAIN&quot; ]]; then</span><br><span class="line">  echo &quot;Error: BK_DOMAIN is not set in $DOMAIN_FILE.&quot;</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰ Ingress èµ„æº</span></span><br><span class="line">ingresses=$(kubectl get ingress -n &quot;$NAMESPACE&quot; -o jsonpath=&#x27;&#123;.items[*].metadata.name&#125;&#x27;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éå†æ‰€æœ‰ Ingress èµ„æºå¹¶æ›´æ–° TLS é…ç½®</span></span><br><span class="line">for ingress in $ingresses; do</span><br><span class="line">  echo &quot;Updating Ingress: $ingress in namespace: $NAMESPACE&quot;</span><br><span class="line">  </span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">æ£€æŸ¥ Ingress æ˜¯å¦å·²å­˜åœ¨ TLS é…ç½®</span></span><br><span class="line">  if kubectl get ingress &quot;$ingress&quot; -n &quot;$NAMESPACE&quot; -o jsonpath=&#x27;&#123;.spec.tls&#125;&#x27; | grep -q &quot;$TLS_HOST&quot;; then</span><br><span class="line">    echo &quot;TLS configuration for $TLS_HOST already exists in Ingress $ingress. Skipping.&quot;</span><br><span class="line">    continue</span><br><span class="line">  fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">æ›´æ–° Ingress çš„ TLS é…ç½®</span></span><br><span class="line">  kubectl patch ingress &quot;$ingress&quot; -n &quot;$NAMESPACE&quot; --type=json -p=&#x27;[</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;op&quot;: &quot;add&quot;,</span><br><span class="line">      &quot;path&quot;: &quot;/spec/tls&quot;,</span><br><span class="line">      &quot;value&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;hosts&quot;: [&quot;&#x27;&quot;$TLS_HOST&quot;&#x27;&quot;],</span><br><span class="line">          &quot;secretName&quot;: &quot;&#x27;&quot;$TLS_SECRET&quot;&#x27;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]&#x27; || &#123; echo &quot;Failed to update Ingress $ingress&quot;; exit 1; &#125;</span><br><span class="line"></span><br><span class="line">  echo &quot;Updated Ingress $ingress with TLS configuration for $TLS_HOST.&quot;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo &quot;All Ingress resources in namespace $NAMESPACE have been updated with TLS configuration for $TLS_HOST.&quot;</span><br></pre></td></tr></table></figure>

<h2 id="5-4-é…ç½®è“é²¸å¯ç”¨HTTPS"><a href="#5-4-é…ç½®è“é²¸å¯ç”¨HTTPS" class="headerlink" title="5.4 é…ç½®è“é²¸å¯ç”¨HTTPS"></a>5.4 é…ç½®è“é²¸å¯ç”¨HTTPS</h2><p>åœ¨gitä»“åº“ç»´æŠ¤ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªå˜æ›´ï¼š</p>
<p>environments&#x2F;default&#x2F;custom.yaml: .bkDomainScheme å€¼è®¾ç½®ä¸º https<br>environments&#x2F;default&#x2F;bkci&#x2F;bkci-custom-values.yaml.gotmpl: .config.bkHttpSchema å€¼è®¾ç½®ä¸º https</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yq -i &#x27;.bkDomainScheme = &quot;https&quot;&#x27; environments/default/custom.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†bkHttpSchema: httpsæ›¿æ¢ä¸ºbkHttpSchema: http</span></span><br><span class="line">sed -i &#x27;s|bkHttpSchema: http|bkHttpSchema: https|&#x27; environments/default/bkci/bkci-custom-values.yaml.gotmpl</span><br></pre></td></tr></table></figure>

<h2 id="5-5-æ„å»ºæœºAgenté…ç½®å˜æ›´åŠé‡å¯"><a href="#5-5-æ„å»ºæœºAgenté…ç½®å˜æ›´åŠé‡å¯" class="headerlink" title="5.5 æ„å»ºæœºAgenté…ç½®å˜æ›´åŠé‡å¯"></a>5.5 æ„å»ºæœºAgenté…ç½®å˜æ›´åŠé‡å¯</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœæ­¢agentæœåŠ¡</span></span><br><span class="line">./stop.sh</span><br><span class="line"></span><br><span class="line">BK_DOMAIN=&quot;deveops.bk.blazehu.com&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹.agent.propertiesæ–‡ä»¶ï¼Œå¼€å¯https</span></span><br><span class="line">sed -i &#x27;&#x27; &#x27;s|http://$BK_DOMAIN|https://$BK_DOMAIN|g&#x27; .agent.properties</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹telegraf.confæ–‡ä»¶ï¼Œå¼€å¯https</span></span><br><span class="line">sed -i &#x27;&#x27; &#x27;s|http://$BK_DOMAIN|https://$BK_DOMAIN|g&#x27; telegraf.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯åŠ¨agent</span></span><br><span class="line">./start.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œä»”ç»†æŸ¥çœ‹.agent.propertiesé‡Œdevops.agent.userï¼Œ è¿™é‡Œæ˜¯å“ªä¸ªç”¨æˆ·å°±ç”¨å“ªä¸ªç”¨æˆ·å¯åŠ¨agent</span></span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>é›†ç¾¤æ¥å…¥dashboard</title>
    <url>/2025/07/kubernetes/%E9%9B%86%E7%BE%A4%E6%8E%A5%E5%85%A5dashboard/</url>
    <content><![CDATA[<h1 id="1-Kubernets-Dashboardå®‰è£…"><a href="#1-Kubernets-Dashboardå®‰è£…" class="headerlink" title="1 Kubernets Dashboardå®‰è£…"></a>1 Kubernets Dashboardå®‰è£…</h1><p>ä¸‹è½½kubernetes-dashboardçš„yaml:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml -O dashboard.yaml</span><br></pre></td></tr></table></figure>

<p>åœ¨å®˜æ–¹yamlé‡Œï¼Œæˆ‘ä»¬éœ€è¦å°†é•œåƒä¿®æ”¹ä¸€ä¸‹ï¼Œä¸ç„¶ä¼šé‡è§ImagePullBackOffçš„é”™è¯¯ï¼š</p>
<ul>
<li>kubernetesui&#x2F;dashboard:v2.7.0</li>
<li>kubernetesui&#x2F;metrics-scraper:v1.0.8</li>
<li>å¤‡æ³¨ï¼šç‰ˆæœ¬å¯èƒ½ä¸åŒï¼Œè®¤å‡†é•œåƒå</li>
</ul>
<p>å°†ä»¥ä¸Šé•œåƒä¿®æ”¹ä¸ºå¯ç”¨çš„ï¼š</p>
<ul>
<li>m.daocloud.io&#x2F;docker.io&#x2F;kubernetesui&#x2F;dashboard:v2.7.0</li>
<li>m.daocloud.io&#x2F;docker.io&#x2F;kubernetesui&#x2F;metrics-scraper:v1.0.8</li>
</ul>
<p>å®‰è£…dashboardï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl apply -f ./dashboard.yaml</span><br></pre></td></tr></table></figure>

<p>éªŒè¯æ“ä½œç•Œé¢å·²ç»éƒ¨ç½²å¹¶ä¸”æ­£åœ¨è¿è¡Œ:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo kubectl get pod -n kubernetes-dashboard</span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">dashboard-metrics-scraper-864c58f57b-fjlfs   1/1     Running   0          98s</span><br><span class="line">kubernetes-dashboard-58db7bd7d4-pdh76        1/1     Running   0          98s</span><br></pre></td></tr></table></figure>

<p>åˆ›å»º ServiceAccount å’Œ ClusterRoleBinding ä»¥æä¾›å¯¹æ–°åˆ›å»ºçš„é›†ç¾¤çš„ç®¡ç†æƒé™è®¿é—®:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl create serviceaccount -n kubernetes-dashboard admin-user</span><br><span class="line">kubectl create clusterrolebinding -n kubernetes-dashboard admin-user --clusterrole cluster-admin --serviceaccount=kubernetes-dashboard:admin-user</span><br></pre></td></tr></table></figure>

<p>éœ€è¦ç”¨ Bearer Token æ¥ç™»å½•åˆ°æ“ä½œç•Œé¢ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°† token ä¿å­˜åˆ°å˜é‡:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo kubectl -n kubernetes-dashboard create token admin-user</span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6InF3b1ZJN0ZVSWUyRkF4blgxVG42d2hVMm0wTGtoSTg3VkVoai1yRTdMN3MifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzI3OTc0NzYyLCJpYXQiOjE3Mjc5NzExNjIsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiZTI2YjE1NjctYjk5YS00ZGRlLTlmMWUtYTIwYmUzZDAwZGJiIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiNWMxYjMyMmUtNDFmNS00ODcxLTkxNjQtZTYzOTk2NzkxZDM4In19LCJuYmYiOjE3Mjc5NzExNjIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.d-b12OQrq_9BnmWz5g-_2nvRS-ktEhg813N8zb-kWBh5GScUHhuiAej2v1p1kt54Xom1H6DaeyvlmL3G8ub7aKgZwJjOyJBFDnt0B04Ysz-KSj788jR_Yg2d1FhTbgk8-pBdV9qSweBVT6GRyQ53NIsTIc5ArDsvfOg66nEiW9rp5-3XLitKpoSLtp_Dpib1VpOR_1XAV8wRNVc9psxOp3vtALs1_jI0Izo_4qOX17OZ9FnxgkeeKglRFynlgGiQ0g2KG74oYQn0b_sUROvb52cdDJ2RDhk4yao2vjMyg19f_x1gK-xM8O7kgfYkA8gXEzguRMl0OEbWP_UgH0RQqA</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ kubectl å‘½ä»¤è¡Œå·¥å…·è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥è®¿é—®æ“ä½œç•Œé¢ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl proxy</span><br></pre></td></tr></table></figure>

<p>è¿›å…¥dashboardï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</span><br></pre></td></tr></table></figure>

<p><img src="/img.png" alt="img.png"><br><img src="/img_1.png" alt="img_1.png"></p>
<p>è¿™é‡Œæ˜¯ç”¨kubectl proxyèµ·äº†ä¸€ä¸ªä»£ç†ï¼Œå®ç°åœ¨é›†ç¾¤å¤–è®¿é—®é›†ç¾¤å†…çš„dashboard</p>
]]></content>
  </entry>
  <entry>
    <title>BK-CIæ’ä»¶å¼€å‘æŒ‡å¼•</title>
    <url>/2025/07/devops/blueking/BK-CI%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E6%8C%87%E5%BC%95/</url>
    <content><![CDATA[<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><blockquote>
<p>å¼€å‘æ’ä»¶å‰ï¼Œå…ˆè¿›å…¥æ’ä»¶å·¥ä½œå°åˆå§‹åŒ–ä¸€ä¸ªæ’ä»¶ï¼Œç¡®å®šæ’ä»¶åœ¨å¹³å°ä¸­çš„å”¯ä¸€æ ‡è¯†</p>
</blockquote>
<h1 id="å·¥ä½œå°"><a href="#å·¥ä½œå°" class="headerlink" title="å·¥ä½œå°"></a>å·¥ä½œå°</h1><p>å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œæ–°å¢&#x2F;å‘å¸ƒ&#x2F;ä¸‹æ¶ç­‰ç®¡ç†æ’ä»¶çš„æ“ä½œ</p>
<h2 id="åŠŸèƒ½åŒºä»‹ç»"><a href="#åŠŸèƒ½åŒºä»‹ç»" class="headerlink" title="åŠŸèƒ½åŒºä»‹ç»"></a>åŠŸèƒ½åŒºä»‹ç»</h2><p><img src="/img.png" alt="img.png"></p>
<ol>
<li>åˆ‡æ¢èµ„æºç±»å‹</li>
<li>æ–°å¢æ’ä»¶</li>
<li>å•ä¸ªæ’ä»¶çš„ç®¡ç†å…¥å£</li>
<li>å‡çº§ã€ä¸‹æ¶ã€åˆ é™¤æ’ä»¶å¿«æ·å…¥å£</li>
<li>æŒ‡å¼•æ–‡æ¡£å’Œæ’ä»¶ UI è°ƒè¯•å·¥å…·å…¥å£</li>
</ol>
<h2 id="æ–°å¢æ’ä»¶"><a href="#æ–°å¢æ’ä»¶" class="headerlink" title="æ–°å¢æ’ä»¶"></a>æ–°å¢æ’ä»¶</h2><p><img src="/img_1.png" alt="img_1.png"></p>
<ol>
<li>æ ‡è¯†</li>
</ol>
<ul>
<li>æ’ä»¶åœ¨å¹³å°ä¸­çš„å”¯ä¸€æ ‡è¯†ï¼Œå»ºè®®å–å’Œæ’ä»¶åŠŸèƒ½ç›¸å…³çš„å¯è¯»æ€§å¥½çš„è‹±æ–‡æ ‡è¯†</li>
</ul>
<ol start="2">
<li>è°ƒè¯•é¡¹ç›®</li>
</ol>
<ul>
<li>æ’ä»¶å‘å¸ƒè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥åœ¨è°ƒè¯•é¡¹ç›®ä¸‹å°†æ’ä»¶æ·»åŠ åˆ°æµæ°´çº¿æ‰§è¡Œï¼Œå¯¹æ’ä»¶è¿›è¡Œæµ‹è¯•ï¼Œä¿è¯æ’ä»¶åŠŸèƒ½æ»¡è¶³é¢„æœŸã€‚</li>
<li>å»ºè®®æ–°å¢ä¸“ç”¨çš„æ’ä»¶è°ƒè¯•é¡¹ç›®ï¼Œé¿å…æµ‹è¯•è¿‡ç¨‹ä¸­å½±å“åˆ°ä¸šåŠ¡ã€‚</li>
</ul>
<ol start="3">
<li>å¼€å‘è¯­è¨€</li>
</ol>
<ul>
<li>æ”¯æŒå››ç§è¯­è¨€å¼€å‘æ’ä»¶ï¼š<ul>
<li>Javaï¼ˆæ¨èï¼‰</li>
<li>Python</li>
<li>Golang</li>
<li>Nodejs</li>
</ul>
</li>
</ul>
<h2 id="å¼€å‘æ’ä»¶"><a href="#å¼€å‘æ’ä»¶" class="headerlink" title="å¼€å‘æ’ä»¶"></a>å¼€å‘æ’ä»¶</h2><blockquote>
<p>åˆå§‹åŒ–å¥½æ’ä»¶ä¹‹åï¼Œå¯ä»¥å¼€å§‹å¼€å‘æ’ä»¶</p>
</blockquote>
<ul>
<li>æ ¹æ®å¼€å‘è¯­è¨€å‚è€ƒå¯¹åº”çš„å¼€å‘æŒ‡å¼•<ul>
<li><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Developer/plugins/plugin-dev-guide/java.md">Java æ’ä»¶å¼€å‘æŒ‡å¼•</a></li>
<li><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Developer/plugins/plugin-dev-guide/python.md">Python æ’ä»¶å¼€å‘æŒ‡å¼•</a></li>
<li><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Developer/plugins/plugin-dev-guide/golang.md">Golang æ’ä»¶å¼€å‘æŒ‡å¼•</a></li>
<li><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Developer/plugins/plugin-dev-guide/nodejs.md">Nodejs æ’ä»¶å¼€å‘æŒ‡å¼•</a></li>
</ul>
</li>
</ul>
<h2 id="æ’ä»¶ç§æœ‰é…ç½®"><a href="#æ’ä»¶ç§æœ‰é…ç½®" class="headerlink" title="æ’ä»¶ç§æœ‰é…ç½®"></a>æ’ä»¶ç§æœ‰é…ç½®</h2><blockquote>
<p>æ’ä»¶çº§åˆ«çš„æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚ tokenã€ç”¨æˆ·åå¯†ç ã€IPã€åŸŸåç­‰ï¼Œä¸å»ºè®®ç›´æ¥æäº¤åˆ°ä»£ç åº“ï¼Œé€šè¿‡å·¥ä½œå°ç§æœ‰é…ç½®ç•Œé¢ç®¡ç†</p>
</blockquote>
<p><img src="/img_2.png" alt="img_2.png"></p>
<h1 id="Golang-æ’ä»¶å¼€å‘"><a href="#Golang-æ’ä»¶å¼€å‘" class="headerlink" title="Golang æ’ä»¶å¼€å‘"></a>Golang æ’ä»¶å¼€å‘</h1><h2 id="æ’ä»¶å¼€å‘æ¡†æ¶è¯´æ˜"><a href="#æ’ä»¶å¼€å‘æ¡†æ¶è¯´æ˜" class="headerlink" title="æ’ä»¶å¼€å‘æ¡†æ¶è¯´æ˜"></a>æ’ä»¶å¼€å‘æ¡†æ¶è¯´æ˜</h2><blockquote>
<p>æ’ä»¶æœ€ç»ˆæ‰“åŒ…æˆä¸€ä¸ªå‘½ä»¤è¡Œå¯æ‰§è¡Œçš„å‘½ä»¤å³å¯ï¼Œå¯¹å¼€å‘æ¡†æ¶æ— ç¡¬æ€§è¦æ±‚ ä¸‹è¾¹ä»¥ demo æ’ä»¶ä¸ºä¾‹ç¤ºèŒƒ</p>
</blockquote>
<h2 id="ç¤ºä¾‹æ’ä»¶ä»£ç å·¥ç¨‹çš„æ•´ä½“ç»“æ„å¦‚ä¸‹"><a href="#ç¤ºä¾‹æ’ä»¶ä»£ç å·¥ç¨‹çš„æ•´ä½“ç»“æ„å¦‚ä¸‹" class="headerlink" title="ç¤ºä¾‹æ’ä»¶ä»£ç å·¥ç¨‹çš„æ•´ä½“ç»“æ„å¦‚ä¸‹"></a>ç¤ºä¾‹æ’ä»¶ä»£ç å·¥ç¨‹çš„æ•´ä½“ç»“æ„å¦‚ä¸‹</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">|- &lt;ä½ çš„æ’ä»¶æ ‡è¯†&gt;</span><br><span class="line">    |- cmd</span><br><span class="line">        |- application</span><br><span class="line">            |- main.go</span><br><span class="line"></span><br><span class="line">    |- hello</span><br><span class="line">        |- hello.go</span><br></pre></td></tr></table></figure>

<h2 id="å¦‚ä½•å¼€å‘æ’ä»¶ï¼š"><a href="#å¦‚ä½•å¼€å‘æ’ä»¶ï¼š" class="headerlink" title="å¦‚ä½•å¼€å‘æ’ä»¶ï¼š"></a>å¦‚ä½•å¼€å‘æ’ä»¶ï¼š</h2><blockquote>
<p>å‚è€ƒ <a href="https://github.com/ci-plugins/plugin-demo-golang">plugin-demo-golang</a></p>
</blockquote>
<ul>
<li>å»ºæ’ä»¶ä»£ç å·¥ç¨‹<ul>
<li>æ’ä»¶ä»£ç å»ºè®®ä¼ä¸šä¸‹ç»Ÿä¸€ç®¡ç†ã€‚ é€šç”¨çš„å¼€æºæ’ä»¶å¯ä»¥è”ç³»è“é²¸å®˜æ–¹æ”¾åˆ° <a href="https://github.com/TencentBlueKing">TencentBlueKing</a> ä¸‹ï¼Œä¾›æ›´å¤šç”¨æˆ·ä½¿ç”¨</li>
</ul>
</li>
<li>å®ç°æ’ä»¶åŠŸèƒ½</li>
<li>è§„èŒƒï¼š<ul>
<li><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Developer/plugins/plugin-dev-standard/plugin-specification.md">æ’ä»¶å¼€å‘è§„èŒƒ</a></li>
<li><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Developer/plugins/plugin-dev-standard/plugin-config.md">æ’ä»¶é…ç½®è§„èŒƒ</a></li>
</ul>
</li>
<li>æ’ä»¶å‰ç«¯ä¸ä»…å¯ä»¥é€šè¿‡ task.json è¿›è¡Œæ ‡å‡†åŒ–é…ç½®ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰å¼€å‘ï¼š<ul>
<li><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Developer/plugins/plugin-dev-standard/plugin-custom-ui.md">è‡ªå®šä¹‰æ’ä»¶ UI äº¤äº’æŒ‡å¼•</a></li>
<li><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Developer/plugins/plugin-dev-standard/plugin-output.md">æ’ä»¶è¾“å‡ºè§„èŒƒ</a></li>
<li><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Developer/plugins/plugin-dev-standard/plugin-error-code.md">æ’ä»¶é”™è¯¯ç è§„èŒƒ</a></li>
<li><a href="https://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Developer/plugins/plugin-dev-standard/release.md">æ’ä»¶å‘å¸ƒåŒ…è§„èŒƒ</a></li>
</ul>
</li>
</ul>
<h2 id="Demoç¤ºä¾‹ç ”è¯»"><a href="#Demoç¤ºä¾‹ç ”è¯»" class="headerlink" title="Demoç¤ºä¾‹ç ”è¯»"></a>Demoç¤ºä¾‹ç ”è¯»</h2><p>å°† <a href="https://github.com/ci-plugins/plugin-demo-golang">plugin-demo-golang</a> cloneåˆ°æœ¬åœ°ã€‚<br>æ¥çœ‹ä¸‹é¡¹ç›®ç»“æ„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ CONTRIBUTING.md</span><br><span class="line">â”œâ”€â”€ LICENSE</span><br><span class="line">â”œâ”€â”€ Makefile</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ go.sum</span><br><span class="line">â”œâ”€â”€ i18n</span><br><span class="line">â”‚   â”œâ”€â”€ message_en_US.properties</span><br><span class="line">â”‚   â””â”€â”€ message_zh_CN.properties</span><br><span class="line">â”œâ”€â”€ main.go</span><br><span class="line">â”œâ”€â”€ task.json</span><br><span class="line">â””â”€â”€ translation</span><br><span class="line">    â””â”€â”€ translation.go</span><br><span class="line"></span><br><span class="line">3 directories, 11 files</span><br></pre></td></tr></table></figure>

<p>å’¦ï¼å’Œä¸Šé¢è¯´çš„æ’ä»¶ä»£ç å·¥ç¨‹çš„æ•´ä½“æ¶æ„ä¸ä¸€æ ·ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">|- &lt;ä½ çš„æ’ä»¶æ ‡è¯†&gt;</span><br><span class="line">    |- cmd</span><br><span class="line">        |- application</span><br><span class="line">            |- main.go</span><br><span class="line"></span><br><span class="line">    |- hello</span><br><span class="line">        |- hello.go</span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡ï¼Œè¿™ä¸é‡è¦ï¼Œåªè¦æ’ä»¶æœ€ç»ˆèƒ½å¤Ÿæ‰“åŒ…æˆä¸€ä¸ªå‘½ä»¤è¡Œå¯æ‰§è¡Œçš„å‘½ä»¤å³å¯ã€‚<br>è¿™é‡Œi18næ˜¯å®ç°ä¸­è‹±æ–‡å›½é™…åŒ–ä½¿ç”¨çš„ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ i18n</span><br><span class="line">â”‚   â”œâ”€â”€ message_en_US.properties</span><br><span class="line">â”‚   â””â”€â”€ message_zh_CN.properties</span><br></pre></td></tr></table></figure>

<p>çœ‹ä¸‹å†…å®¹å¯¹æ¯”ï¼š<br>message_en_US.propertiesï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">input.desc.label=desc</span><br><span class="line">100001=input param [&#123;0&#125;] invitated</span><br></pre></td></tr></table></figure>

<p>message_zh_CN.properties</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">input.desc.label=æè¿°</span><br><span class="line">100001=è¾“å…¥å‚æ•°[&#123;0&#125;]éæ³•</span><br></pre></td></tr></table></figure>

<p>é‚£æˆ‘ä»¬å°±å¯ä»¥çŒœæµ‹ï¼Œè¿™é‡Œæ˜¯å®ç°è¾“å…¥å‚æ•°[{0}]éæ³•è¿™å¥è¯çš„ä¸­è‹±æ–‡ï¼Œå…¶ä¸­[{0}]ä¼šä½¿ç”¨å…·ä½“çš„å‚æ•°å¡«å……ã€‚<br>ç„¶åi18ngeneratoråˆ™æ˜¯æ ¹æ®propertiesæ–‡ä»¶çš„é…ç½®ï¼Œç”Ÿæˆtranslationä»£ç ï¼Œå¦‚translation.goï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Code generated by &quot;i18ngenerator&quot;; DO NOT EDIT.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> translation</span><br><span class="line"></span><br><span class="line"><span class="comment">// Translations</span></span><br><span class="line"><span class="keyword">var</span> Translations <span class="keyword">map</span>[<span class="type">string</span>][][]<span class="type">string</span> = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>][][]<span class="type">string</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    Translations[<span class="string">&quot;en-US&quot;</span>] = [][]<span class="type">string</span>&#123;</span><br><span class="line">       &#123;</span><br><span class="line">          <span class="string">&quot;100001&quot;</span>,</span><br><span class="line">          <span class="string">&quot;input param [&#123;0&#125;] invitated&quot;</span>,</span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">          <span class="string">&quot;input.desc.label&quot;</span>,</span><br><span class="line">          <span class="string">&quot;desc&quot;</span>,</span><br><span class="line">       &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    Translations[<span class="string">&quot;zh-CN&quot;</span>] = [][]<span class="type">string</span>&#123;</span><br><span class="line">       &#123;</span><br><span class="line">          <span class="string">&quot;100001&quot;</span>,</span><br><span class="line">          <span class="string">&quot;è¾“å…¥å‚æ•°[&#123;0&#125;]éæ³•&quot;</span>,</span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">          <span class="string">&quot;input.desc.label&quot;</span>,</span><br><span class="line">          <span class="string">&quot;æè¿°&quot;</span>,</span><br><span class="line">       &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–‡ä»¶æ˜¯ç”±i18ngeneratorè‡ªåŠ¨ç”Ÿæˆçš„ï¼Œä¸è¦è‡ªå·±æ”¹ã€‚<br>mainå‡½æ•°å†…ï¼Œå®ç°äº†ä¸€ä¸ªå°çš„è¾“å‡ºåŠŸèƒ½ï¼Œç®€å•çœ‹ä¸‹æºç ï¼Œç„¶åå»è¿›è¡Œæµ‹è¯•ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;runtime&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/ci-plugins/golang-plugin-sdk/api&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/ci-plugins/golang-plugin-sdk/log&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/ci-plugins/plugin-demo-golang/translation&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:generate i18ngenerator i18n ./translation/translation.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> greetingParam <span class="keyword">struct</span> &#123;</span><br><span class="line">    UserName <span class="type">string</span> <span class="string">`json:&quot;userName&quot;`</span></span><br><span class="line">    Greeting <span class="type">string</span> <span class="string">`json:&quot;greeting&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *greetingParam)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;userName: %v, greeting: %v&quot;</span>, a.UserName, a.Greeting)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    runtime.GOMAXPROCS(<span class="number">4</span>)</span><br><span class="line">    log.Info(<span class="string">&quot;atom-demo-glang starts&quot;</span>)</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">       <span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">          log.Error(<span class="string">&quot;panic: &quot;</span>, err)</span><br><span class="line">          api.FinishBuild(api.StatusError, <span class="string">&quot;panic occurs&quot;</span>)</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    api.InitI18n(translation.Translations, api.GetRuntimeLanguage())</span><br><span class="line">    msg, err := api.Localize(<span class="string">&quot;input.desc.label&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       log.Error(err)</span><br><span class="line">    &#125;</span><br><span class="line">    log.Info(msg)</span><br><span class="line"></span><br><span class="line">    helloBuild()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">helloBuild</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å•ä¸ªè¾“å…¥å‚æ•°</span></span><br><span class="line">    userName := api.GetInputParam(<span class="string">&quot;userName&quot;</span>)</span><br><span class="line">    log.Info(<span class="string">&quot;userName: &quot;</span>, userName)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å±</span></span><br><span class="line">    log.Info(<span class="string">&quot;\nBuildInfo:&quot;</span>)</span><br><span class="line">    log.Info(<span class="string">&quot;Project Name:     &quot;</span>, api.GetProjectDisplayName())</span><br><span class="line">    log.Info(<span class="string">&quot;Pipeline Id:      &quot;</span>, api.GetPipelineId())</span><br><span class="line">    log.Info(<span class="string">&quot;Pipeline Name:    &quot;</span>, api.GetPipelineName())</span><br><span class="line">    log.Info(<span class="string">&quot;Pipeline Version: &quot;</span>, api.GetPipelineVersion())</span><br><span class="line">    log.Info(<span class="string">&quot;Build Id:         &quot;</span>, api.GetPipelineBuildId())</span><br><span class="line">    log.Info(<span class="string">&quot;Build Num:        &quot;</span>, api.GetPipelineBuildNumber())</span><br><span class="line">    log.Info(<span class="string">&quot;Start Type:       &quot;</span>, api.GetPipelineStartType())</span><br><span class="line">    log.Info(<span class="string">&quot;Start UserId:     &quot;</span>, api.GetPipelineStartUserId())</span><br><span class="line">    log.Info(<span class="string">&quot;Start UserName:   &quot;</span>, api.GetPipelineStartUserName())</span><br><span class="line">    log.Info(<span class="string">&quot;Start Time:       &quot;</span>, api.GetPipelineStartTimeMills())</span><br><span class="line">    log.Info(<span class="string">&quot;Workspace:        &quot;</span>, api.GetWorkspace())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾“å…¥å‚æ•°è§£æåˆ°å¯¹è±¡</span></span><br><span class="line">    paramData := <span class="built_in">new</span>(greetingParam)</span><br><span class="line">    api.LoadInputParam(paramData)</span><br><span class="line">    log.Info(fmt.Sprintf(<span class="string">&quot;\n%vï¼Œ%v\n&quot;</span>, paramData.Greeting, paramData.UserName))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">    log.Info(<span class="string">&quot;start build&quot;</span>)</span><br><span class="line">    build()</span><br><span class="line">    time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾“å‡º</span></span><br><span class="line">    <span class="comment">// å­—ç¬¦ä¸²è¾“å‡º</span></span><br><span class="line">    strData := api.NewStringData(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">    api.AddOutputData(<span class="string">&quot;strData_01&quot;</span>, strData)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶å½’æ¡£è¾“å‡º</span></span><br><span class="line">    artifactData := api.NewArtifactData()</span><br><span class="line">    artifactData.AddArtifact(<span class="string">&quot;result.dat&quot;</span>)</span><br><span class="line">    api.AddOutputData(<span class="string">&quot;artifactData_02&quot;</span>, artifactData)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠ¥å‘Šè¾“å‡º</span></span><br><span class="line">    reportData := api.NewReportData(<span class="string">&quot;label_01&quot;</span>, api.GetWorkspace()+<span class="string">&quot;/report&quot;</span>, <span class="string">&quot;report.htm&quot;</span>)</span><br><span class="line">    api.AddOutputData(<span class="string">&quot;report_01&quot;</span>, reportData)</span><br><span class="line"></span><br><span class="line">    api.WriteOutput()</span><br><span class="line">    log.Info(<span class="string">&quot;build done&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">build</span><span class="params">()</span></span> &#123;</span><br><span class="line">    log.Info(<span class="string">&quot;write result.dat&quot;</span>)</span><br><span class="line">    ioutil.WriteFile(api.GetWorkspace()+<span class="string">&quot;/result.dat&quot;</span>, []<span class="type">byte</span>(<span class="string">&quot;content&quot;</span>), <span class="number">0644</span>)</span><br><span class="line">    log.Info(<span class="string">&quot;write report.htm&quot;</span>)</span><br><span class="line">    os.Mkdir(api.GetWorkspace()+<span class="string">&quot;/report&quot;</span>, os.ModePerm)</span><br><span class="line">    ioutil.WriteFile(api.GetWorkspace()+<span class="string">&quot;/report/report.htm&quot;</span>, []<span class="type">byte</span>(<span class="string">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Report&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;H1&gt;This is a Report&lt;/H1&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>), <span class="number">0644</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨æ ¹ç›®å½•ä¸‹å·²ç»ç»™æˆ‘ä»¬é¢„è®¾äº†ä¸€ä¸ªtask.jsonæ–‡ä»¶ï¼Œåé¢å¯ä»¥ç®€å•ä¿®æ”¹ä¸‹è¿™ä¸ªæ–‡ä»¶æ¥å®ç°æµ‹è¯•ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;atomCode&quot;</span>: <span class="string">&quot;goDemo&quot;</span>,</span><br><span class="line">  <span class="string">&quot;execution&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;language&quot;</span>: <span class="string">&quot;golang&quot;</span>,</span><br><span class="line">    <span class="string">&quot;packagePath&quot;</span>: <span class="string">&quot;goDemo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;demands&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;chmod +x goDemo&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;target&quot;</span>: <span class="string">&quot;./goDemo&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;input&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;greeting&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;label&quot;</span>: <span class="string">&quot;æ¬¢è¿è¯&quot;</span>,</span><br><span class="line">      <span class="string">&quot;default&quot;</span>: <span class="string">&quot;Glad to see you&quot;</span>,</span><br><span class="line">      <span class="string">&quot;placeholder&quot;</span>: <span class="string">&quot;æ¬¢è¿è¯&quot;</span>,</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;vuex-input&quot;</span>,</span><br><span class="line">      <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;æ¬¢è¿è¯&quot;</span>,</span><br><span class="line">      <span class="string">&quot;required&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;disabled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;hidden&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;isSensitive&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;userName&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;label&quot;</span>: <span class="string">&quot;å§“å&quot;</span>,</span><br><span class="line">      <span class="string">&quot;default&quot;</span>: <span class="string">&quot;Mr. Huang&quot;</span>,</span><br><span class="line">      <span class="string">&quot;placeholder&quot;</span>: <span class="string">&quot;å§“å&quot;</span>,</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;vuex-input&quot;</span>,</span><br><span class="line">      <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;å§“å&quot;</span>,</span><br><span class="line">      <span class="string">&quot;required&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;disabled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;hidden&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;isSensitive&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;output&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;strData_01&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;description&quot;</span>: <span class="string">&quot;æµ‹è¯•&quot;</span>,</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="string">&quot;isSensitive&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="å¦‚ä½•æ‰“åŒ…å‘å¸ƒ"><a href="#å¦‚ä½•æ‰“åŒ…å‘å¸ƒ" class="headerlink" title="å¦‚ä½•æ‰“åŒ…å‘å¸ƒ"></a>å¦‚ä½•æ‰“åŒ…å‘å¸ƒ</h2><ol>
<li>è¿›å…¥æ’ä»¶ä»£ç å·¥ç¨‹ç›®å½•ä¸‹</li>
<li>æ‰“åŒ…</li>
</ol>
<ul>
<li>å¦‚æœæŒ‰ç…§æ­£å¸¸çš„demoçš„ç›®å½•ç»“æ„æ˜¯éœ€è¦è¿›å…¥cmd&#x2F;applicationå†…æ‰§è¡Œbuildå‘½ä»¤ï¼Œå› ä¸ºmainåœ¨æ­¤</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd cmd/application</span><br><span class="line">GO111MODULE=on GOOS=linux GOARCH=amd64 go build -o bin/$&#123;executable&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™æ¬¡ç”¨çš„demoåˆ™ç›´æ¥åœ¨æ ¹ç›®å½•ä¸‹æ‰§è¡Œbuildå‘½ä»¤ï¼Œå› ä¸ºmainåœ¨æ ¹ç›®å½•ä¸‹</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GO111MODULE=on GOOS=linux GOARCH=amd64 go build -o bin/$&#123;executable&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œgo build -o bin&#x2F;${executable}ä¼šåœ¨binç›®å½•ä¸‹ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ–‡ä»¶åæ˜¯${executable}ï¼Œå³é¡¹ç›®åã€‚<br>ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªåå­—ï¼Œå¦‚<code>GO111MODULE=on GOOS=linux GOARCH=amd64 go build -o bin/kingtest</code></p>
<ol>
<li>åœ¨ä»»æ„ä½ç½®æ–°å»ºæ–‡ä»¶å¤¹ï¼Œå‘½åç¤ºä¾‹ï¼šrelease_pkg &#x3D; &lt;ä½ çš„æ’ä»¶æ ‡è¯†&gt;_release</li>
<li>å°†æ­¥éª¤ 2 ç”Ÿäº§çš„æ‰§è¡ŒåŒ…æ‹·è´åˆ° ä¸‹</li>
<li>æ·»åŠ  task.json æ–‡ä»¶åˆ° ä¸‹ task.json è§ç¤ºä¾‹ï¼ŒæŒ‰ç…§æ’ä»¶åŠŸèƒ½é…ç½®ã€‚</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir kingtest_release</span><br><span class="line">cp bin/kingtest kingtest_release/kingtest</span><br><span class="line">touch kingtest_release/task.json</span><br></pre></td></tr></table></figure>

<ul>
<li>æ’ä»¶é…ç½®è§„èŒƒ</li>
<li>task.json ç¤ºä¾‹ï¼š</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;atomCode&quot;: &quot;king-test&quot;,                  # atomCode è¦ä¸å·¥ä½œå°å½•å…¥çš„ä¸€è‡´</span><br><span class="line">  &quot;execution&quot;: &#123;</span><br><span class="line">    &quot;language&quot;: &quot;golang&quot;,</span><br><span class="line">    &quot;packagePath&quot;: &quot;kingtest&quot;,              # å‘å¸ƒåŒ…ä¸­æ’ä»¶å®‰è£…åŒ…çš„ç›¸å¯¹è·¯å¾„</span><br><span class="line">    &quot;demands&quot;: [</span><br><span class="line">      &quot;echo start run chmod +x kingtest&quot;,   # æ’ä»¶å¯åŠ¨å‰éœ€è¦æ‰§è¡Œçš„å®‰è£…å‘½ä»¤ï¼Œé¡ºåºæ‰§è¡Œ</span><br><span class="line">      &quot;chmod +x kingtest&quot;,                  # æ’ä»¶å¯åŠ¨å‰éœ€è¦æ‰§è¡Œçš„å®‰è£…å‘½ä»¤ï¼Œé¡ºåºæ‰§è¡Œ</span><br><span class="line">      &quot;echo stop run chmod +x kingtest&quot;,    # æ’ä»¶å¯åŠ¨å‰éœ€è¦æ‰§è¡Œçš„å®‰è£…å‘½ä»¤ï¼Œé¡ºåºæ‰§è¡Œ</span><br><span class="line">    ],</span><br><span class="line">    &quot;target&quot;: &quot;./kingtest&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;input&quot;: &#123;</span><br><span class="line">    &quot;greeting&quot;: &#123;</span><br><span class="line">      &quot;label&quot;: &quot;æ¬¢è¿è¯&quot;,</span><br><span class="line">      &quot;default&quot;: &quot;Glad to see you&quot;,</span><br><span class="line">      &quot;placeholder&quot;: &quot;æ¬¢è¿è¯&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;vuex-input&quot;,</span><br><span class="line">      &quot;desc&quot;: &quot;æ¬¢è¿è¯&quot;,</span><br><span class="line">      &quot;required&quot;: true,</span><br><span class="line">      &quot;disabled&quot;: false,</span><br><span class="line">      &quot;hidden&quot;: false,</span><br><span class="line">      &quot;isSensitive&quot;: false</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;userName&quot;: &#123;</span><br><span class="line">      &quot;label&quot;: &quot;å§“å&quot;,</span><br><span class="line">      &quot;default&quot;: &quot;Mr. Huang&quot;,</span><br><span class="line">      &quot;placeholder&quot;: &quot;å§“å&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;vuex-input&quot;,</span><br><span class="line">      &quot;desc&quot;: &quot;å§“å&quot;,</span><br><span class="line">      &quot;required&quot;: true,</span><br><span class="line">      &quot;disabled&quot;: false,</span><br><span class="line">      &quot;hidden&quot;: false,</span><br><span class="line">      &quot;isSensitive&quot;: false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;output&quot;: &#123;</span><br><span class="line">    &quot;strData_01&quot;: &#123;</span><br><span class="line">      &quot;description&quot;: &quot;æµ‹è¯•&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">      &quot;isSensitive&quot;: false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>åœ¨ ç›®å½•ä¸‹ï¼ŒæŠŠæ‰€æœ‰æ–‡ä»¶æ‰“æˆ zip åŒ…å³å¯</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd kingtest_release &amp;&amp; zip kingtest_release.zip kingtest task.json</span><br></pre></td></tr></table></figure>

<p>zipåŒ…ç»“æ„ç¤ºä¾‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">|- kingtest_release.zip         # å‘å¸ƒåŒ…</span><br><span class="line">   |- kingtest                  # æ’ä»¶æ‰§è¡ŒåŒ…</span><br><span class="line">   |- task.json                 # æ’ä»¶é…ç½®æ–‡ä»¶</span><br></pre></td></tr></table></figure>

<p>æ‰“åŒ…å®Œæˆåï¼Œåœ¨æ’ä»¶å·¥ä½œå°æå•å‘å¸ƒï¼Œå³å¯æµ‹è¯•æˆ–å‘å¸ƒæ’ä»¶</p>
<h1 id="ä¸Šä¼ ä¸€ä¸ªæµæ°´çº¿æ’ä»¶"><a href="#ä¸Šä¼ ä¸€ä¸ªæµæ°´çº¿æ’ä»¶" class="headerlink" title="ä¸Šä¼ ä¸€ä¸ªæµæ°´çº¿æ’ä»¶"></a>ä¸Šä¼ ä¸€ä¸ªæµæ°´çº¿æ’ä»¶</h1><blockquote>
<p>å¼€å‘å¥½æ’ä»¶ä¹‹åï¼Œé€šè¿‡ç ”å‘å•†åº—å·¥ä½œå°ï¼Œå°†æ’ä»¶å‘å¸ƒåˆ°ç ”å‘å•†åº—ï¼Œæä¾›ç»™ç”¨æˆ·æ·»åŠ åˆ°æµæ°´çº¿ä¸­ä½¿ç”¨ã€‚</p>
</blockquote>
<h2 id="å…¥å£"><a href="#å…¥å£" class="headerlink" title="å…¥å£"></a>å…¥å£</h2><p>åœ¨å·¥ä½œå°åˆ—è¡¨ï¼Œç‚¹å‡»å¦‚ä¸‹å…¥å£å‘èµ·å‘å¸ƒæµç¨‹ï¼š<br><img src="/img_3.png" alt="img_3.png"></p>
<p>é¦–æ¬¡å‘å¸ƒæ—¶ï¼Œå…¥å£åä¸ºä¸Šæ¶<br>åç»­æ›´æ–°ç‰ˆæœ¬æ—¶ï¼Œå…¥å£åä¸ºå‡çº§<br>æˆ–è€…åœ¨æ’ä»¶å‘å¸ƒç®¡ç†-&gt;ç‰ˆæœ¬ç®¡ç†ç•Œé¢å‘èµ·å‘å¸ƒæµç¨‹ï¼š<br><img src="/img_4.png" alt="img_4.png"></p>
<h2 id="å¡«å†™æ’ä»¶ç›¸å…³ä¿¡æ¯-ä¸Šä¼ æ’ä»¶å‘å¸ƒåŒ…"><a href="#å¡«å†™æ’ä»¶ç›¸å…³ä¿¡æ¯-ä¸Šä¼ æ’ä»¶å‘å¸ƒåŒ…" class="headerlink" title="å¡«å†™æ’ä»¶ç›¸å…³ä¿¡æ¯&#x2F;ä¸Šä¼ æ’ä»¶å‘å¸ƒåŒ…"></a>å¡«å†™æ’ä»¶ç›¸å…³ä¿¡æ¯&#x2F;ä¸Šä¼ æ’ä»¶å‘å¸ƒåŒ…</h2><p>ä¸Šæ¶&#x2F;å‡çº§æ’ä»¶æ—¶ï¼Œå¯ä»¥ä¿®æ”¹æ’ä»¶çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src="/img_5.png" alt="img_5.png"></p>
<ol>
<li>é€‚ç”¨ Job ç±»å‹ï¼š</li>
</ol>
<ul>
<li>å’Œæµæ°´çº¿ Job ç±»å‹å¯¹åº”ï¼Œè¯·æŒ‰ç…§æ’ä»¶å®é™…é€‚ç”¨æƒ…å†µé€‰æ‹©</li>
<li>è‹¥é€‰é”™ï¼Œéœ€æ–°å¢ç‰ˆæœ¬ä¿®æ”¹</li>
</ul>
<ol start="2">
<li>å‘å¸ƒåŒ…ï¼š</li>
</ol>
<ul>
<li>task.json ä¸­çš„ atomCode éœ€å’Œ æ–°å¢æ’ä»¶æ—¶å¡«å†™çš„æ ‡è¯†ä¸€è‡´ï¼Œå¦åˆ™ä¸Šä¼ ä¼šå¤±è´¥</li>
</ul>
<h2 id="æµ‹è¯•-å‘å¸ƒæ’ä»¶"><a href="#æµ‹è¯•-å‘å¸ƒæ’ä»¶" class="headerlink" title="æµ‹è¯•&#x2F;å‘å¸ƒæ’ä»¶"></a>æµ‹è¯•&#x2F;å‘å¸ƒæ’ä»¶</h2><blockquote>
<p>å¡«å†™å¥½ä¿¡æ¯ï¼Œæäº¤åï¼Œè¿›å…¥å‘å¸ƒæµç¨‹ï¼Œå¯ä»¥æµ‹è¯•-&gt;é‡æ–°ä¼ åŒ…-&gt;æµ‹è¯•ï¼Œç›´è‡³æ’ä»¶æ»¡è¶³é¢„æœŸåï¼Œæ‰‹åŠ¨ç»§ç»­æµç¨‹å°†æ’ä»¶å‘å¸ƒåˆ°ç ”å‘å•†åº—</p>
</blockquote>
<p><img src="/img_6.png" alt="img_6.png"></p>
<ol>
<li>æµ‹è¯•ï¼šç‚¹å‡»åè·³è½¬åˆ°æ’ä»¶è°ƒè¯•é¡¹ç›®çš„æµæ°´çº¿æœåŠ¡ä¸‹ï¼Œå¯ä»¥å°†å½“å‰æ’ä»¶æ·»åŠ åˆ°æµæ°´çº¿ï¼ŒéªŒè¯ UIã€åŠŸèƒ½æ˜¯å¦æ»¡è¶³é¢„æœŸ</li>
<li>é‡æ–°ä¼ åŒ…ï¼šå½“æµ‹è¯•å‘ç°é—®é¢˜ï¼Œä¿®å¤åï¼Œé‡æ–°ä¸Šä¼ å‘å¸ƒåŒ…ï¼Œå†æ¬¡è¿›è¡Œæµ‹è¯•</li>
<li>ç»§ç»­ï¼šæµ‹è¯• OKï¼Œæ»¡è¶³é¢„æœŸåï¼Œç¡®è®¤æäº¤å‘å¸ƒ</li>
<li>å–æ¶ˆå‘å¸ƒï¼šå‘å¸ƒè¿‡ç¨‹ä¸­ï¼Œéšæ—¶å¯ä»¥ç»ˆæ­¢å‘å¸ƒ</li>
</ol>
<h2 id="é‡è§çš„å‡ ä¸ªé”™è¯¯"><a href="#é‡è§çš„å‡ ä¸ªé”™è¯¯" class="headerlink" title="é‡è§çš„å‡ ä¸ªé”™è¯¯"></a>é‡è§çš„å‡ ä¸ªé”™è¯¯</h2><h3 id="æ— æƒé™æ‰§è¡Œ"><a href="#æ— æƒé™æ‰§è¡Œ" class="headerlink" title="æ— æƒé™æ‰§è¡Œ"></a>æ— æƒé™æ‰§è¡Œ</h3><p>åœ¨æµ‹è¯•ä¸­é‡è§ä¸€ä¸ªé—®é¢˜ï¼šæ— æƒé™æ‰§è¡Œ<br><img src="/img_7.png" alt="img_7.png"></p>
<p>åœ¨<code>execution-&gt;demands</code>å¢åŠ ä¸€ä¸ªå‘½ä»¤<code>chmod +x kingtest</code>å³å¯è§£å†³</p>
<h3 id="å‘å¸ƒè¿›åº¦é‡Œé‡æ–°ä¼ åŒ…æŒç»­æŠ¥é”™task-jsonæ ¼å¼é”™è¯¯"><a href="#å‘å¸ƒè¿›åº¦é‡Œé‡æ–°ä¼ åŒ…æŒç»­æŠ¥é”™task-jsonæ ¼å¼é”™è¯¯" class="headerlink" title="å‘å¸ƒè¿›åº¦é‡Œé‡æ–°ä¼ åŒ…æŒç»­æŠ¥é”™task.jsonæ ¼å¼é”™è¯¯"></a>å‘å¸ƒè¿›åº¦é‡Œé‡æ–°ä¼ åŒ…æŒç»­æŠ¥é”™task.jsonæ ¼å¼é”™è¯¯</h3><p>è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œåœ¨å‘å¸ƒè¿›åº¦é‡Œé‡æ–°ä¼ åŒ…æ—¶ï¼Œä¸€ç›´æŠ¥é”™task.jsonæ ¼å¼é”™è¯¯ï¼Œä½†å®é™…æ ¼å¼æ˜¯å¯¹çš„ï¼<br>è§¦å‘çš„åŸå› æš‚ä¸çŸ¥é“ï¼Œä½†æ˜¯ç¡®å®æ˜¯ä¸€ä¸ªéšè—çš„bugã€‚<br><img src="/img_8.png" alt="img_8.png"></p>
<p>ç›´æ¥ç‚¹å‡»ç»§ç»­ï¼Œç„¶åèµ°å‡çº§æ’ä»¶çš„æ–¹å¼å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚</p>
<h3 id="cannot-execute-binary-file-Exec-format-error"><a href="#cannot-execute-binary-file-Exec-format-error" class="headerlink" title="cannot execute binary file: Exec format error"></a>cannot execute binary file: Exec format error</h3><p>è¿™é‡Œçš„é—®é¢˜æ˜¯æˆ‘é€ æˆçš„ï¼Œæœ€åˆæˆ‘åœ¨macç¯å¢ƒä¸‹ç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå‘½ä»¤æ˜¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">macä¸‹æ‰§è¡Œ</span></span><br><span class="line">go build -o bin/kingtest</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯æ’ä»¶é‡Œé€‰æ‹©çš„ç¼–è¯‘ç¯å¢ƒæ˜¯linuxã€‚<br><img src="/img_9.png" alt="img_9.png"></p>
<p>è§£å†³æ–¹å¼ï¼šè®©æ’ä»¶é€‰æ‹©çš„ç¼–è¯‘ç¯å¢ƒå’Œå¯æ‰§è¡Œæ–‡ä»¶çš„å¹³å°ç»Ÿä¸€ã€‚<br>æˆ‘è¿™é‡Œé€‰æ‹©é‡æ–°ç¼–è¯‘ä¸‹å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé‡‡ç”¨åœ¨macå¹³å°äº¤å‰ç¼–è¯‘linuxå¹³å°å¯æ‰§è¡Œæ–‡ä»¶çš„æ–¹å¼ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GO111MODULE=on GOOS=linux GOARCH=amd64 go build -o bin/kingtest</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥æ–°å»ºä¸€ä¸ªæ’ä»¶ï¼Œç¼–è¯‘ç¯å¢ƒé€‰æ‹©macã€‚</p>
<h2 id="è¿è¡Œç»“æœ"><a href="#è¿è¡Œç»“æœ" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h2><p>æµæ°´çº¿ç»“æœï¼š<br><img src="/img_10.png" alt="img_10.png"></p>
<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[Plugin info]</span><br><span class="line">=====================================================================</span><br><span class="line">Task           : king-test</span><br><span class="line">Description    : bkæ’ä»¶æµ‹è¯•</span><br><span class="line">Version        : 1.0.3</span><br><span class="line">Author         : huari</span><br><span class="line">Help           : More Information</span><br><span class="line">=====================================================================</span><br><span class="line">-----</span><br><span class="line">[Input]</span><br><span class="line">input(normal): (æ¬¢è¿è¯)greeting=Glad to see you</span><br><span class="line">input(normal): (å§“å)userName=Mr. Huang</span><br><span class="line">-----</span><br><span class="line">[Install plugin]</span><br><span class="line">-----</span><br><span class="line">start run chmod +x kingtest</span><br><span class="line">stop run chmod +x kingtest</span><br><span class="line">atom-demo-glang starts</span><br><span class="line">æè¿°</span><br><span class="line">userName:  Mr. Huang</span><br><span class="line"></span><br><span class="line">BuildInfo:</span><br><span class="line">Project Name:      GOPS</span><br><span class="line">Pipeline Id:       p-8967ed52b08847c8a5b0140937db0975</span><br><span class="line">Pipeline Name:     king-test</span><br><span class="line">Pipeline Version:  11</span><br><span class="line">Build Id:          b-78947b5c39f34b32bbafb803042d1e22</span><br><span class="line">Build Num:         15</span><br><span class="line">Start Type:        MANUAL</span><br><span class="line">Start UserId:      huari</span><br><span class="line">Start UserName:    huari</span><br><span class="line">Start Time:        1733298107286</span><br><span class="line">Workspace:         /data/devops/workspace</span><br><span class="line"></span><br><span class="line">Glad to see youï¼ŒMr. Huang</span><br><span class="line">start build</span><br><span class="line">write result.dat</span><br><span class="line">write report.htm</span><br><span class="line">build done</span><br><span class="line">[Output]</span><br><span class="line">1 file match: </span><br><span class="line">  /data/devops/workspace/result.dat</span><br><span class="line">prepare to upload 7 B</span><br><span class="line">1/1 file(s) finished</span><br><span class="line">output(except): artifactData_02=result.dat</span><br><span class="line">å…¥å£æ–‡ä»¶æ£€æµ‹å®Œæˆ</span><br><span class="line">ä¸Šä¼ è‡ªå®šä¹‰äº§å‡ºç‰©æˆåŠŸï¼Œå…±äº§ç”Ÿäº†1ä¸ªæ–‡ä»¶</span><br><span class="line">output(except): report_01=report.htm</span><br><span class="line">output(normal): strData_01=test</span><br><span class="line">-----</span><br><span class="line"></span><br></pre></td></tr></table></figure>






]]></content>
  </entry>
  <entry>
    <title>NPDä»‹ç»</title>
    <url>/2025/07/devops/npd/NPD%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<h1 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1 ç®€ä»‹"></a>1 ç®€ä»‹</h1><p>å®˜æ–¹æ–‡æ¡£åº“åœ°å€ï¼š<a href="https://github.com/kubernetes/node-problem-detector">https://github.com/kubernetes/node-problem-detector</a></p>
<p>node-problem-detector æ—¨åœ¨ä½¿é›†ç¾¤ç®¡ç†å †æ ˆä¸­çš„ä¸Šæ¸¸å±‚èƒ½å¤Ÿçœ‹åˆ°å„ç§èŠ‚ç‚¹é—®é¢˜ã€‚</p>
<p>å®ƒæ˜¯ä¸€ä¸ªåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œçš„å®ˆæŠ¤è¿›ç¨‹ï¼Œæ£€æµ‹èŠ‚ç‚¹é—®é¢˜å¹¶å°†å…¶æŠ¥å‘Šç»™apiserverã€‚</p>
<p>node-problem-detector å¯ä»¥ä½œä¸º DaemonSet è¿è¡Œï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹è¿è¡Œã€‚</p>
<p>ç°åœ¨å®ƒä½œä¸º GKEé›†ç¾¤ä¸­é»˜è®¤å¯ç”¨çš„Kubernetes Addonè¿è¡Œã€‚å®ƒä¹Ÿä½œä¸ºAKS Linux Extensionçš„ä¸€éƒ¨åˆ†åœ¨ AKS ä¸­é»˜è®¤å¯ç”¨ã€‚</p>
<h2 id="1-2-èƒŒæ™¯"><a href="#1-2-èƒŒæ™¯" class="headerlink" title="1.2 èƒŒæ™¯"></a>1.2 èƒŒæ™¯</h2><p>å¤§é‡èŠ‚ç‚¹é—®é¢˜å¯èƒ½ä¼šå½±å“èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ podï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>åŸºç¡€è®¾æ–½å®ˆæŠ¤è¿›ç¨‹é—®é¢˜ï¼šntp æœåŠ¡å…³é—­ï¼›</li>
<li>ç¡¬ä»¶é—®é¢˜ï¼šCPUã€å†…å­˜æˆ–ç£ç›˜æŸåï¼›</li>
<li>å†…æ ¸é—®é¢˜ï¼šå†…æ ¸æ­»é”ã€æ–‡ä»¶ç³»ç»ŸæŸåï¼›</li>
<li>å®¹å™¨è¿è¡Œæ—¶é—®é¢˜ï¼šè¿è¡Œæ—¶å®ˆæŠ¤è¿›ç¨‹æ— å“åº”ï¼›</li>
<li>â€¦</li>
</ul>
<p>ç›®å‰ï¼Œè¿™äº›é—®é¢˜å¯¹äºé›†ç¾¤ç®¡ç†å †æ ˆä¸­çš„ä¸Šæ¸¸å±‚æ˜¯ä¸å¯è§çš„ï¼Œå› æ­¤ Kubernetes å°†ç»§ç»­å°† pod è°ƒåº¦åˆ°åèŠ‚ç‚¹ã€‚<br>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥äº†è¿™ä¸ªæ–°çš„å®ˆæŠ¤è¿›ç¨‹node-problem-detectoræ¥ä»å„ç§å®ˆæŠ¤è¿›ç¨‹æ”¶é›†èŠ‚ç‚¹é—®é¢˜ï¼Œå¹¶å°†å®ƒä»¬æä¾›ç»™ä¸Šæ¸¸å±‚ã€‚ä¸€æ—¦ä¸Šæ¸¸å±‚èƒ½å¤Ÿçœ‹åˆ°è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¨è®º <a href="https://github.com/kubernetes/node-problem-detector?tab=readme-ov-file#remedy-systems">remedy systems</a>äº†ã€‚</p>
<h2 id="1-3-Problem-API"><a href="#1-3-Problem-API" class="headerlink" title="1.3 Problem API"></a>1.3 Problem API</h2><p>node-problem-detector ä½¿ç”¨Eventå¹¶å‘NodeConditionapiserver æŠ¥å‘Šé—®é¢˜ã€‚</p>
<ul>
<li>NodeConditionï¼šå¯¼è‡´èŠ‚ç‚¹æ— æ³•ç”¨äº pod çš„æ°¸ä¹…æ€§é—®é¢˜åº”æŠ¥å‘Šä¸ºNodeConditionã€‚</li>
<li>Eventï¼šå¯¹ pod å½±å“æœ‰é™ä½†å…·æœ‰å‚è€ƒæ„ä¹‰çš„ä¸´æ—¶é—®é¢˜åº”æŠ¥å‘Šä¸ºEventã€‚</li>
</ul>
<h2 id="1-4-Problem-Daemon"><a href="#1-4-Problem-Daemon" class="headerlink" title="1.4 Problem Daemon"></a>1.4 Problem Daemon</h2><p>é—®é¢˜å®ˆæŠ¤è¿›ç¨‹æ˜¯ node-problem-detector çš„ä¸€ä¸ªå­å®ˆæŠ¤è¿›ç¨‹ã€‚å®ƒç›‘è§†ç‰¹å®šç±»å‹çš„èŠ‚ç‚¹é—®é¢˜å¹¶å°†å…¶æŠ¥å‘Šç»™ node-problem-detectorã€‚<br>å®ˆæŠ¤è¿›ç¨‹å¯èƒ½æ˜¯ï¼š</p>
<ul>
<li>ä¸“ä¸º Kubernetes ä¸“ç”¨ç”¨ä¾‹è®¾è®¡çš„å¾®å‹å®ˆæŠ¤è¿›ç¨‹ã€‚</li>
<li>ä¸èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨é›†æˆçš„ç°æœ‰èŠ‚ç‚¹å¥åº·ç›‘æ§å®ˆæŠ¤è¿›ç¨‹ã€‚</li>
</ul>
<p>ç›®å‰ï¼Œé—®é¢˜å®ˆæŠ¤è¿›ç¨‹åœ¨ node-problem-detector äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ä»¥ goroutine çš„å½¢å¼è¿è¡Œã€‚</p>
<p>æœªæ¥ï¼Œæˆ‘ä»¬ä¼šå°† node-problem-detectorå’Œé—®é¢˜å®ˆæŠ¤è¿›ç¨‹åˆ†ç¦»åˆ°ä¸åŒçš„å®¹å™¨ä¸­ï¼Œå¹¶ä½¿ç”¨ pod è§„èŒƒå°†å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·ã€‚</p>
<p>æ¯ç§ç±»å‹çš„é—®é¢˜å®ˆæŠ¤è¿›ç¨‹éƒ½å¯ä»¥é€šè¿‡è®¾ç½®ç›¸åº”çš„æ„å»ºæ ‡ç­¾åœ¨ç¼–è¯‘æ—¶ç¦ç”¨ã€‚</p>
<p>å¦‚æœåœ¨ç¼–è¯‘æ—¶ç¦ç”¨å®ƒä»¬ï¼Œåˆ™å®ƒä»¬çš„æ‰€æœ‰æ„å»ºä¾èµ–é¡¹ã€å…¨å±€å˜é‡å’Œåå°goroutine éƒ½å°†ä»ç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­å‰”é™¤ã€‚</p>
<p>æ”¯æŒçš„å®ˆæŠ¤è¿›ç¨‹åˆ—è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th>é—®é¢˜å®ˆæŠ¤è¿›ç¨‹ç±»å‹</th>
<th>èŠ‚ç‚¹çŠ¶æ€</th>
<th>è§£é‡Š</th>
<th>é…ç½®</th>
<th>ç¦ç”¨æ„å»ºæ ‡ç­¾</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://github.com/kubernetes/node-problem-detector/tree/master/pkg/systemlogmonitor">SystemLogMonitor</a></td>
<td>KernelDeadlock ReadonlyFilesystem FrequentKubeletRestart FrequentDockerRestart FrequentContainerdRestart</td>
<td>ç³»ç»Ÿæ—¥å¿—ç›‘è§†å™¨ç›‘è§†ç³»ç»Ÿæ—¥å¿—å¹¶æ ¹æ®é¢„å®šä¹‰çš„è§„åˆ™æŠ¥å‘Šé—®é¢˜å’ŒæŒ‡æ ‡ã€‚</td>
<td><a href="https://github.com/kubernetes/node-problem-detector/blob/master/config/kernel-monitor-filelog.json">filelog</a>, <a href="https://github.com/kubernetes/node-problem-detector/blob/master/config/kernel-monitor.json">kmsg</a>, <a href="https://github.com/kubernetes/node-problem-detector/blob/master/config/kernel-monitor-counter.json">kernel</a>, <a href="https://github.com/kubernetes/node-problem-detector/blob/master/config/systemd-monitor-counter.json">abrt</a>, <a href="https://github.com/kubernetes/node-problem-detector/blob/master/config/systemd-monitor-counter.json">systemd</a></td>
<td>disable_system_log_monitor</td>
</tr>
<tr>
<td><a href="https://github.com/kubernetes/node-problem-detector/tree/master/pkg/systemstatsmonitor">SystemStatsMonitor</a></td>
<td>None(Could be added in the future)</td>
<td>èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨çš„ç³»ç»Ÿç»Ÿè®¡ç›‘è§†å™¨ï¼Œç”¨äºæ”¶é›†å„ç§ä¸å¥åº·ç›¸å…³çš„ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯ä½œä¸ºæŒ‡æ ‡ã€‚è¯·å‚é˜…<a href="https://docs.google.com/document/d/1SeaUz6kBavI283Dq8GBpoEUDrHA2a795xtw0OvjM568/edit">æ­¤å¤„</a>çš„ææ¡ˆã€‚</td>
<td><a href="https://github.com/kubernetes/node-problem-detector/blob/master/config/system-stats-monitor.json">system-stats-monitor</a></td>
<td>disable_system_stats_monitor</td>
</tr>
<tr>
<td><a href="https://github.com/kubernetes/node-problem-detector/tree/master/pkg/custompluginmonitor">CustomPluginMonitor</a></td>
<td>On-demand(According to users configuration), existing example: NTPProblem</td>
<td>ä¸€ä¸ªè‡ªå®šä¹‰çš„ node-problem-detector æ’ä»¶ç›‘æ§å™¨ï¼Œç”¨äºè°ƒç”¨å’Œæ£€æŸ¥å„ç§èŠ‚ç‚¹é—®é¢˜ï¼Œå¹¶ä½¿ç”¨ç”¨æˆ·å®šä¹‰çš„æ£€æŸ¥è„šæœ¬ã€‚è¯·å‚é˜…<a href="https://docs.google.com/document/d/1jK_5YloSYtboj-DtfjmYKxfNnUxCAvohLnsH5aGCAYQ/edit#">æ­¤å¤„</a>çš„ææ¡ˆã€‚</td>
<td><a href="https://github.com/kubernetes/node-problem-detector/blob/4ad49bbd84b8ced45ac825eac01ec93d9235935e/config/custom-plugin-monitor.json">example</a></td>
<td>disable_custom_plugin_monitor</td>
</tr>
<tr>
<td><a href="https://github.com/kubernetes/node-problem-detector/tree/master/pkg/healthchecker">HealthChecker</a></td>
<td>KubeletUnhealthy ContainerRuntimeUnhealthy</td>
<td>èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨çš„å¥åº·æ£€æŸ¥å™¨ç”¨äºæ£€æŸ¥ kubelet å’Œå®¹å™¨è¿è¡Œæ—¶çš„å¥åº·çŠ¶å†µã€‚</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="1-5-Exporter"><a href="#1-5-Exporter" class="headerlink" title="1.5 Exporter"></a>1.5 Exporter</h2><p>exporter æ˜¯ node-problem-detector çš„ä¸€ä¸ªç»„ä»¶ã€‚</p>
<p>å®ƒå‘æŸäº›åç«¯æŠ¥å‘ŠèŠ‚ç‚¹é—®é¢˜ å’Œ&#x2F;æˆ– æŒ‡æ ‡ã€‚</p>
<p>å…¶ä¸­ä¸€äº›å¯ä»¥åœ¨ç¼–è¯‘æ—¶ä½¿ç”¨æ„å»ºæ ‡è®°ç¦ç”¨ã€‚æ”¯æŒçš„å¯¼å‡ºå™¨åˆ—è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th>Exporter</th>
<th>è§£é‡Š</th>
<th>ç¦ç”¨æ„å»ºæ ‡ç­¾</th>
</tr>
</thead>
<tbody><tr>
<td>Kubernetes exporter</td>
<td>Kubernetes å¯¼å‡ºå™¨å‘ Kubernetes API æœåŠ¡å™¨æŠ¥å‘ŠèŠ‚ç‚¹é—®é¢˜ï¼šä¸´æ—¶é—®é¢˜æŠ¥å‘Šä¸ºäº‹ä»¶ï¼Œæ°¸ä¹…é—®é¢˜æŠ¥å‘Šä¸ºèŠ‚ç‚¹çŠ¶å†µã€‚</td>
<td></td>
</tr>
<tr>
<td>Prometheus exporter</td>
<td>Prometheus å¯¼å‡ºå™¨å°†èŠ‚ç‚¹é—®é¢˜å’ŒæŒ‡æ ‡æœ¬åœ°æŠ¥å‘Šä¸º Prometheus æŒ‡æ ‡</td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/kubernetes/node-problem-detector/blob/master/config/exporter/stackdriver-exporter.json">Stackdriver exporter</a></td>
<td>Stackdriver å¯¼å‡ºå™¨å‘ Stackdriver Monitoring API æŠ¥å‘ŠèŠ‚ç‚¹é—®é¢˜å’ŒæŒ‡æ ‡ã€‚</td>
<td>disable_stackdriver_exporter</td>
</tr>
</tbody></table>
<h2 id="1-6-ç”¨æ³•"><a href="#1-6-ç”¨æ³•" class="headerlink" title="1.6 ç”¨æ³•"></a>1.6 ç”¨æ³•</h2><h3 id="1-6-1-æ ‡å¿—"><a href="#1-6-1-æ ‡å¿—" class="headerlink" title="1.6.1 æ ‡å¿—"></a>1.6.1 æ ‡å¿—</h3><ul>
<li>â€“versionï¼šæ‰“å°èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨çš„å½“å‰ç‰ˆæœ¬ã€‚</li>
<li>â€“hostname-overrideï¼šnode-problem-detector ç”¨äºæ›´æ–°çŠ¶æ€å’Œå‘å‡ºäº‹ä»¶çš„è‡ªå®šä¹‰èŠ‚ç‚¹åç§°ã€‚node-problem-detector é¦–å…ˆä»hostname-overrideè·å–èŠ‚ç‚¹åç§°ï¼Œç„¶åä»NODE_NAMEç¯å¢ƒå˜é‡ è·å–ï¼Œæœ€åè¿”å›åˆ°os.Hostnameã€‚</li>
</ul>
<h3 id="1-6-2-å¯¹äºç³»ç»Ÿæ—¥å¿—ç›‘æ§"><a href="#1-6-2-å¯¹äºç³»ç»Ÿæ—¥å¿—ç›‘æ§" class="headerlink" title="1.6.2 å¯¹äºç³»ç»Ÿæ—¥å¿—ç›‘æ§"></a>1.6.2 å¯¹äºç³»ç»Ÿæ—¥å¿—ç›‘æ§</h3><ul>
<li>â€“config.system-log-monitorï¼šç³»ç»Ÿæ—¥å¿—ç›‘è§†å™¨é…ç½®æ–‡ä»¶è·¯å¾„åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ config&#x2F;kernel-monitor.jsonã€‚èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨å°†ä¸ºæ¯ä¸ªé…ç½®å¯åŠ¨å•ç‹¬çš„æ—¥å¿—ç›‘è§†å™¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ—¥å¿—ç›‘è§†å™¨æ¥ç›‘è§†ä¸åŒçš„ç³»ç»Ÿæ—¥å¿—ã€‚</li>
</ul>
<h3 id="1-6-3-å¯¹äºç³»ç»Ÿç»Ÿè®¡ç›‘æ§"><a href="#1-6-3-å¯¹äºç³»ç»Ÿç»Ÿè®¡ç›‘æ§" class="headerlink" title="1.6.3 å¯¹äºç³»ç»Ÿç»Ÿè®¡ç›‘æ§"></a>1.6.3 å¯¹äºç³»ç»Ÿç»Ÿè®¡ç›‘æ§</h3><ul>
<li>â€“config.system-stats-monitorï¼šç³»ç»Ÿç»Ÿè®¡ç›‘æ§é…ç½®æ–‡ä»¶çš„è·¯å¾„åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ <a href="https://github.com/kubernetes/node-problem-detector/blob/master/config/system-stats-monitor.json">config&#x2F;system-stats-monitor.json</a>ã€‚èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨å°†ä¸ºæ¯ä¸ªé…ç½®å¯åŠ¨ä¸€ä¸ªå•ç‹¬çš„ç³»ç»Ÿç»Ÿè®¡ç›‘æ§å™¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä¸åŒçš„ç³»ç»Ÿç»Ÿè®¡ç›‘æ§å™¨æ¥ç›‘æ§ä¸é—®é¢˜ç›¸å…³çš„ä¸åŒç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯ã€‚</li>
</ul>
<h3 id="1-6-4-å¯¹äºè‡ªå®šä¹‰æ’ä»¶ç›‘è§†å™¨"><a href="#1-6-4-å¯¹äºè‡ªå®šä¹‰æ’ä»¶ç›‘è§†å™¨" class="headerlink" title="1.6.4 å¯¹äºè‡ªå®šä¹‰æ’ä»¶ç›‘è§†å™¨"></a>1.6.4 å¯¹äºè‡ªå®šä¹‰æ’ä»¶ç›‘è§†å™¨</h3><ul>
<li>â€“config.custom-plugin-monitorï¼šè‡ªå®šä¹‰æ’ä»¶ç›‘æ§é…ç½®æ–‡ä»¶è·¯å¾„åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ <a href="https://github.com/kubernetes/node-problem-detector/blob/master/config/custom-plugin-monitor.json">config&#x2F;custom-plugin-monitor.json</a>ã€‚èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨å°†ä¸ºæ¯ä¸ªé…ç½®å¯åŠ¨ä¸€ä¸ªå•ç‹¬çš„è‡ªå®šä¹‰æ’ä»¶ç›‘æ§ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä¸åŒçš„è‡ªå®šä¹‰æ’ä»¶ç›‘æ§æ¥ç›‘æ§ä¸åŒçš„èŠ‚ç‚¹é—®é¢˜ã€‚</li>
</ul>
<h3 id="1-6-5-å¯¹äºå¥åº·æ£€æŸ¥è€…"><a href="#1-6-5-å¯¹äºå¥åº·æ£€æŸ¥è€…" class="headerlink" title="1.6.5 å¯¹äºå¥åº·æ£€æŸ¥è€…"></a>1.6.5 å¯¹äºå¥åº·æ£€æŸ¥è€…</h3><ul>
<li>â€“enable-k8s-exporterï¼šå¯ç”¨å‘ Kubernetes API æœåŠ¡å™¨æŠ¥å‘Šï¼Œé»˜è®¤ä¸ºtrueã€‚</li>
<li>â€“apiserver-overrideï¼šç”¨äºè‡ªå®šä¹‰ node-problem-detector å¦‚ä½•è¿æ¥ apiserver çš„ URI å‚æ•°ã€‚å¦‚æœâ€“enable-k8s-exporteræ˜¯ï¼Œåˆ™å¿½ç•¥æ­¤å‚æ•°ã€‚æ ¼å¼ä¸<a href="https://github.com/kubernetes/heapster">Heapster</a> çš„æ ‡å¿—falseç›¸åŒã€‚ä¾‹å¦‚ï¼Œè¦æ— éœ€èº«ä»½éªŒè¯å³å¯è¿è¡Œï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼š <a href="https://github.com/kubernetes/heapster/blob/master/docs/source-configuration.md#kubernetes">source</a></li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">http://APISERVER_IP:APISERVER_PORT?inClusterConfig=false</span><br></pre></td></tr></table></figure>

<p>è¯·å‚é˜…<a href="https://github.com/kubernetes/heapster/blob/master/docs/source-configuration.md#kubernetes">heapster æ–‡æ¡£</a><br>ä»¥è·å–å¯ç”¨é€‰é¡¹çš„å®Œæ•´åˆ—è¡¨ã€‚</p>
<ul>
<li>â€“addressï¼šç»‘å®šèŠ‚ç‚¹é—®é¢˜æ£€æµ‹æœåŠ¡å™¨çš„åœ°å€ã€‚</li>
<li>â€“portï¼šç»‘å®šèŠ‚ç‚¹é—®é¢˜æ£€æµ‹æœåŠ¡å™¨çš„ç«¯å£ã€‚ä½¿ç”¨ 0 è¡¨ç¤ºç¦ç”¨ã€‚</li>
</ul>
<h3 id="1-6-6-å¯¹äº-Prometheus-exporter"><a href="#1-6-6-å¯¹äº-Prometheus-exporter" class="headerlink" title="1.6.6 å¯¹äº Prometheus exporter"></a>1.6.6 å¯¹äº Prometheus exporter</h3><ul>
<li>â€“prometheus-addressï¼šç»‘å®šPrometheusæŠ“å–ç«¯ç‚¹çš„åœ°å€ï¼Œé»˜è®¤ä¸º127.0.0.1ã€‚</li>
<li>â€“prometheus-portï¼šç»‘å®š Prometheus æŠ“å–ç«¯ç‚¹çš„ç«¯å£ï¼Œé»˜è®¤ä¸º 20257ã€‚ä½¿ç”¨ 0 è¡¨ç¤ºç¦ç”¨ã€‚</li>
</ul>
<h3 id="1-6-7-å¯¹äº-Stackdriver-exporter"><a href="#1-6-7-å¯¹äº-Stackdriver-exporter" class="headerlink" title="1.6.7 å¯¹äº Stackdriver exporter"></a>1.6.7 å¯¹äº Stackdriver exporter</h3><ul>
<li>â€“exporter.stackdriverï¼šStackdriver å¯¼å‡ºå™¨é…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼Œä¾‹å¦‚config&#x2F;exporter&#x2F;stackdriver-exporter.jsonï¼Œé»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²ã€‚è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²å³å¯ç¦ç”¨ã€‚</li>
</ul>
<h3 id="1-6-8-å·²å¼ƒç”¨çš„æ ‡å¿—"><a href="#1-6-8-å·²å¼ƒç”¨çš„æ ‡å¿—" class="headerlink" title="1.6.8 å·²å¼ƒç”¨çš„æ ‡å¿—"></a>1.6.8 å·²å¼ƒç”¨çš„æ ‡å¿—</h3><ul>
<li>â€“system-log-monitorsï¼šç³»ç»Ÿæ—¥å¿—ç›‘æ§é…ç½®æ–‡ä»¶çš„è·¯å¾„åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”ã€‚æ­¤é€‰é¡¹å·²å¼ƒç”¨ï¼Œç”±â€“config.system-log-monitoræ›¿ä»£ï¼Œå¹¶å°†è¢«åˆ é™¤ã€‚å¦‚æœåŒæ—¶è®¾ç½®â€“system-log-monitorså’Œ â€“config.system-log-monitor ï¼Œ NPD å°†å´©æºƒã€‚</li>
<li>â€“custom-plugin-monitorsï¼šè‡ªå®šä¹‰æ’ä»¶ç›‘æ§é…ç½®æ–‡ä»¶çš„è·¯å¾„åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”ã€‚æ­¤é€‰é¡¹å·²å¼ƒç”¨ï¼Œç”±â€“config.custom-plugin-monitoræ›¿ä»£ï¼Œå¹¶å°†è¢«åˆ é™¤ã€‚å¦‚æœåŒæ—¶è®¾ç½®â€“custom-plugin-monitorså’Œ â€“config.custom-plugin-monitorï¼ŒNPD å°†å´©æºƒã€‚</li>
</ul>
<h2 id="1-7-æ„å»ºé•œåƒ"><a href="#1-7-æ„å»ºé•œåƒ" class="headerlink" title="1.7 æ„å»ºé•œåƒ"></a>1.7 æ„å»ºé•œåƒ</h2><ul>
<li>å®‰è£…libsystemdARM GCC å·¥å…·é“¾çš„å¼€å‘ä¾èµ–é¡¹<ul>
<li>Debian &#x2F; Ubuntuï¼šapt install libsystemd-dev gcc-aarch64-linux-gnu</li>
</ul>
</li>
<li>git clone <a href="mailto:&#103;&#x69;&#116;&#64;&#103;&#105;&#116;&#x68;&#x75;&#98;&#46;&#x63;&#x6f;&#109;">&#103;&#x69;&#116;&#64;&#103;&#105;&#116;&#x68;&#x75;&#98;&#46;&#x63;&#x6f;&#109;</a>:kubernetes&#x2F;node-problem-detector.git</li>
<li>åœ¨é¡¶å±‚ç›®å½•ä¸­è¿è¡Œmakeã€‚å®ƒå°†ï¼š<ul>
<li>æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ã€‚</li>
<li>æ„å»ºdockeré•œåƒã€‚äºŒè¿›åˆ¶æ–‡ä»¶å’Œconfig&#x2F;è¢«å¤åˆ¶åˆ°dockeré•œåƒä¸­ã€‚</li>
</ul>
</li>
</ul>
<p>å¦‚æœæ‚¨ä¸éœ€è¦æŸäº›ç±»åˆ«çš„é—®é¢˜å®ˆæŠ¤è¿›ç¨‹ï¼Œæ‚¨å¯ä»¥é€‰æ‹©åœ¨ç¼–è¯‘æ—¶ç¦ç”¨å®ƒä»¬ã€‚è¿™æ˜¯ä¿æŒ node-problem-detectorè¿è¡Œæ—¶ç´§å‡‘ä¸”æ²¡æœ‰ä¸å¿…è¦ä»£ç ï¼ˆä¾‹å¦‚å…¨å±€å˜é‡ã€goroutines ç­‰ï¼‰çš„æœ€ä½³æ–¹æ³•ã€‚</p>
<p>æ‚¨å¯ä»¥é€šè¿‡BUILD_TAGSåœ¨è¿è¡Œä¹‹å‰è®¾ç½®ç¯å¢ƒå˜é‡æ¥å®ç°è¿™ä¸€ç‚¹makeã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">BUILD_TAGS=&quot;disable_custom_plugin_monitor disable_system_stats_monitor&quot; make</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°å‘½ä»¤å°†åœ¨ä¸ä½¿ç”¨<a href="https://github.com/kubernetes/node-problem-detector/tree/master/pkg/custompluginmonitor">è‡ªå®šä¹‰æ’ä»¶ç›‘è§†å™¨</a>å’Œ<a href="https://github.com/kubernetes/node-problem-detector/tree/master/pkg/systemstatsmonitor">ç³»ç»Ÿç»Ÿè®¡ç›‘è§†å™¨</a>çš„æƒ…å†µä¸‹ç¼–è¯‘node-problem-detector ã€‚æŸ¥çœ‹<a href="https://github.com/kubernetes/node-problem-detector#problem-daemon">é—®é¢˜å®ˆæŠ¤è¿›ç¨‹</a>éƒ¨åˆ†ï¼Œäº†è§£å¦‚ä½•åœ¨ç¼–è¯‘æ—¶ç¦ç”¨æ¯ä¸ªé—®é¢˜å®ˆæŠ¤è¿›ç¨‹ã€‚</p>
<h2 id="1-8-æ¨é€é•œåƒ"><a href="#1-8-æ¨é€é•œåƒ" class="headerlink" title="1.8 æ¨é€é•œåƒ"></a>1.8 æ¨é€é•œåƒ</h2><p><code>make push</code>å°† docker é•œåƒä¸Šä¼ åˆ°æ³¨å†Œè¡¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œé•œåƒå°†ä¸Šä¼ åˆ° <code>staging-k8s.gcr.io</code>ã€‚å¯ä»¥è½»æ¾ä¿®æ”¹<code>Makefile</code>ä»¥å°†é•œåƒæ¨é€åˆ°å¦ä¸€ä¸ªæ³¨å†Œè¡¨ã€‚</p>
<h2 id="1-9-å®‰è£…"><a href="#1-9-å®‰è£…" class="headerlink" title="1.9 å®‰è£…"></a>1.9 å®‰è£…</h2><p>å°† node-problem-detector<br>å®‰è£…åˆ°é›†ç¾¤ä¸­çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨<a href="https://github.com/deliveryhero/helm-charts/tree/master/stable/node-problem-detector">Helm å›¾è¡¨</a>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm repo add deliveryhero https://charts.deliveryhero.io/</span><br><span class="line">helm install --generate-name deliveryhero/node-problem-detector</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…ï¼Œæ‰‹åŠ¨å®‰è£… node-problem-detectorï¼š</p>
<p>ç¼–è¾‘<a href="https://github.com/kubernetes/node-problem-detector/blob/master/deployment/node-problem-detector.yaml">node-problem-detector.yaml</a>ä»¥é€‚åº”æ‚¨çš„ç¯å¢ƒã€‚å°†<code>log</code>å·è®¾ç½®ä¸ºæ‚¨çš„ç³»ç»Ÿæ—¥å¿—ç›®å½•ï¼ˆç”± SystemLogMonitor ä½¿ç”¨ï¼‰ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ ConfigMap è¦†ç›–<code>config</code> pod å†…çš„ç›®å½•ã€‚</p>
<p>ç¼–è¾‘<a href="https://github.com/kubernetes/node-problem-detector/blob/master/deployment/node-problem-detector-config.yaml">node-problem-detector-config.yaml</a>æ¥é…ç½® node-problem-detectorã€‚</p>
<ul>
<li>ç¼–è¾‘<a href="https://github.com/kubernetes/node-problem-detector/blob/master/deployment/rbac.yaml">rbac.yaml</a>ä»¥é€‚åˆæ‚¨çš„ç¯å¢ƒã€‚</li>
<li>ä½¿ç”¨ åˆ›å»º ServiceAccount å’Œ ClusterRoleBinding <code>kubectl create -f rbac.yaml</code>ã€‚</li>
<li>ä½¿ç”¨ åˆ›å»º ConfigMap <code>kubectl create -f node-problem-detector-config.yaml</code>ã€‚</li>
<li>ä½¿ç”¨ åˆ›å»º DaemonSet <code>kubectl create -f node-problem-detector.yaml</code>ã€‚</li>
</ul>
<h2 id="1-10-å¼€å§‹ç‹¬ç«‹è¿è¡Œ"><a href="#1-10-å¼€å§‹ç‹¬ç«‹è¿è¡Œ" class="headerlink" title="1.10 å¼€å§‹ç‹¬ç«‹è¿è¡Œ"></a>1.10 å¼€å§‹ç‹¬ç«‹è¿è¡Œ</h2><p>è¦ç‹¬ç«‹è¿è¡Œ node-problem-detectorï¼Œæ‚¨åº”è¯¥è®¾ç½®inClusterConfigä¸ºfalseï¼Œå¹¶ä¸”æ•™ node-problem-detector å¦‚ä½• è®¿é—® apiserverï¼Œä¹Ÿå°±æ˜¯apiserver-overrideã€‚</p>
<p>è¦ä½¿ç”¨ä¸å®‰å…¨çš„ apiserver è¿æ¥ç‹¬ç«‹è¿è¡Œ node-problem-detectorï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">node-problem-detector --apiserver-override=http://APISERVER_IP:APISERVER_INSECURE_PORT?inClusterConfig=false</span><br></pre></td></tr></table></figure>

<p>æ›´å¤šåœºæ™¯è¯·è§<a href="https://github.com/kubernetes/heapster/blob/master/docs/source-configuration.md#kubernetes">æ­¤å¤„</a></p>
<h2 id="1-11-è¯•ç”¨"><a href="#1-11-è¯•ç”¨" class="headerlink" title="1.11 è¯•ç”¨"></a>1.11 è¯•ç”¨</h2><p>æ‚¨å¯ä»¥åœ¨æ­£åœ¨è¿è¡Œçš„é›†ç¾¤ä¸­å°è¯•ä½¿ç”¨ node-problem-detectorï¼Œæ–¹æ³•æ˜¯å°†æ¶ˆæ¯æ³¨å…¥åˆ° node-problem-detector æ­£åœ¨ç›‘è§†çš„æ—¥å¿—ä¸­ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå‡è®¾ node-problem-detector æ­£åœ¨ä½¿ç”¨KernelMonitorã€‚</p>
<p>åœ¨æ‚¨çš„æœºå™¨ä¸Šè¿è¡Œ<code>kubectl get events -w</code>ã€‚åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œ<code>sudo sh -c &quot;echo &#39;kernel: BUG: unable to handle kernel NULL pointer dereference at TESTING&#39; &gt;&gt; /dev/kmsg&quot;</code>ã€‚ç„¶åæ‚¨åº”è¯¥ä¼šçœ‹åˆ°è¯¥KernelOopssäº‹ä»¶ã€‚</p>
<p>æ·»åŠ æ–°è§„åˆ™æˆ–å¼€å‘èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨æ—¶ï¼Œåœ¨ç‹¬ç«‹æ¨¡å¼ä¸‹åœ¨æœ¬åœ°å·¥ä½œç«™ä¸Šè¿›è¡Œæµ‹è¯•å¯èƒ½æ›´å®¹æ˜“ã€‚</p>
<p>å¯¹äº API æœåŠ¡å™¨ï¼Œä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨kubectl proxyæ­£åœ¨è¿è¡Œçš„é›†ç¾¤çš„ API æœåŠ¡å™¨åœ¨æœ¬åœ°å¯ç”¨ã€‚</p>
<p>æ‚¨ä¼šæ”¶åˆ°ä¸€äº›é”™è¯¯ï¼Œå› ä¸º API æœåŠ¡å™¨æ— æ³•è¯†åˆ«æ‚¨çš„æœ¬åœ°å·¥ä½œç«™ã€‚ä½†æ— è®ºå¦‚ä½•ï¼Œæ‚¨ä»ç„¶åº”è¯¥èƒ½å¤Ÿæµ‹è¯•æ‚¨çš„æ–°è§„åˆ™ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæµ‹è¯•KernelMonitorè§„åˆ™ï¼š</p>
<ul>
<li><code>make</code>ï¼ˆæœ¬åœ°æ„å»ºnode-problem-detectorï¼‰</li>
<li><code>kubectl proxy --port=8080</code>ï¼ˆä½¿æ­£åœ¨è¿è¡Œçš„é›†ç¾¤çš„ API æœåŠ¡å™¨åœ¨æœ¬åœ°å¯ç”¨ï¼‰</li>
<li>å°†KernelMonitoræ›´æ–°åˆ°æ‚¨çš„æœ¬åœ°å†…æ ¸æ—¥å¿—ç›®å½•<code>logPath</code>ã€‚ä¾‹å¦‚ï¼Œåœ¨æŸäº› Linux ç³»ç»Ÿä¸Šï¼Œå®ƒæ˜¯<code>/run/log/journal</code>, è€Œä¸æ˜¯<code>/var/log/journal</code>ã€‚</li>
<li><code>./bin/node-problem-detector --logtostderr --apiserver-override=http://127.0.0.1:8080?inClusterConfig=false --config.system-log-monitor=config/kernel-monitor.json --config.system-stats-monitor=config/system-stats-monitor.json --port=20256 --prometheus-port=2025</code>ï¼ˆæˆ–æŒ‡å‘ä»»ä½• API æœåŠ¡å™¨åœ°å€ï¼šç«¯å£å’Œ Prometheus ç«¯å£ï¼‰</li>
<li><code>sudo sh -c &quot;echo &#39;kernel: BUG: unable to handle kernel NULL pointer dereference at TESTING&#39; &gt;&gt; /dev/kmsg&quot;</code></li>
<li>æ‚¨å¯ä»¥<code>KernelOops</code>åœ¨èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨æ—¥å¿—ä¸­çœ‹åˆ°äº‹ä»¶ã€‚</li>
<li><code>sudo sh -c &quot;echo &#39;kernel: INFO: task docker:20744 blocked for more than 120 seconds.&#39; &gt;&gt; /dev/kmsg&quot;</code></li>
<li>æ‚¨å¯ä»¥åœ¨node-problem-detector logçœ‹DockerHung eventå’ŒçŠ¶æ€</li>
<li>æ‚¨å¯ä»¥åœ¨<a href="http://127.0.0.1:20256/conditions%E6%9F%A5%E7%9C%8B%60DockerHung%60%E7%8A%B6%E6%80%81">http://127.0.0.1:20256/conditionsæŸ¥çœ‹DockerHungçŠ¶æ€</a></li>
<li>æ‚¨å¯ä»¥åœ¨<a href="http://127.0.0.1:20257/metrics%E4%B8%8A%E6%9F%A5%E7%9C%8B">http://127.0.0.1:20257/metrics</a>ä¸ŠæŸ¥çœ‹ Prometheus æ ¼å¼çš„ç£ç›˜ç›¸å…³ç³»ç»ŸæŒ‡æ ‡ã€‚</li>
</ul>
<p>æ³¨ï¼š æ‚¨å¯ä»¥åœ¨<a href="https://github.com/kubernetes/node-problem-detector/tree/master/test/kernel_log_generator/problems">test&#x2F;kernel_log_generator&#x2F;problems</a>ä¸‹æŸ¥çœ‹æ›´å¤šè§„åˆ™ç¤ºä¾‹ã€‚</p>
<ul>
<li>å¯¹äº<a href="https://github.com/kubernetes/node-problem-detector/blob/master/config/kernel-monitor.json">KernelMonitor</a><br>æ¶ˆæ¯æ³¨å…¥ï¼Œæ‰€æœ‰æ¶ˆæ¯éƒ½åº”è¯¥æœ‰kernel: å‰ç¼€ï¼ˆå¦è¯·æ³¨æ„ï¼Œåé¢æœ‰ä¸€ä¸ªç©ºæ ¼:ï¼‰ï¼›æˆ–è€…ä½¿ç”¨<a href="https://github.com/kubernetes/node-problem-detector/blob/master/test/kernel_log_generator/generator.sh">generator.sh</a>ã€‚</li>
<li>è¦å°†å…¶ä»–æ—¥å¿—ï¼ˆå¦‚ systemd æ—¥å¿—ï¼‰æ³¨å…¥ journaldï¼Œè¯·ä½¿ç”¨<code>echo &#39;Some systemd message&#39; | systemd-cat -t systemd</code>ã€‚</li>
</ul>
<h2 id="1-12-Remedy-Systems"><a href="#1-12-Remedy-Systems" class="headerlink" title="1.12 Remedy Systems"></a>1.12 Remedy Systems</h2><p>Remedy Systemsæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæ—¨åœ¨å°è¯•è§£å†³node-problem-detectoræ£€æµ‹åˆ°çš„é—®é¢˜çš„è¿‡ç¨‹ã€‚</p>
<p>Remedy Systemsä¼šè§‚å¯Ÿnode-problem-detectorå‘å‡ºçš„äº‹ä»¶ å’Œ&#x2F;æˆ– èŠ‚ç‚¹çŠ¶å†µï¼Œå¹¶é‡‡å–æªæ–½ä½¿ Kubernetes é›†ç¾¤æ¢å¤å¥åº·çŠ¶æ€ã€‚</p>
<p>è¡¥æ•‘ç³»ç»Ÿæœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li><a href="https://github.com/planetlabs/draino">Draino</a> æ ¹æ®æ ‡ç­¾å’ŒèŠ‚ç‚¹æ¡ä»¶è‡ªåŠ¨æ’ç©º KubernetesèŠ‚ç‚¹ã€‚ä¸æ‰€æœ‰æä¾›çš„æ ‡ç­¾å’Œä»»ä½•æä¾›çš„èŠ‚ç‚¹æ¡ä»¶åŒ¹é…çš„èŠ‚ç‚¹å°†è¢«é˜»æ­¢ç«‹å³æ¥å—æ–° podï¼ˆä¹Ÿç§°ä¸ºâ€œå°é”â€ï¼‰ï¼Œå¹¶åœ¨å¯é…ç½®çš„æ—¶é—´å<a href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/">æ’ç©º</a>ã€‚Drainoå¯ä»¥ä¸ <a href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler">Cluster Autoscaler</a>ç»“åˆä½¿ç”¨ï¼Œä»¥è‡ªåŠ¨ç»ˆæ­¢æ’ç©ºçš„èŠ‚ç‚¹ã€‚è¯·å‚é˜… <a href="https://github.com/kubernetes/node-problem-detector/issues/199">æ­¤é—®é¢˜</a> ï¼Œäº†è§£ Drainoçš„ç¤ºä¾‹ç”Ÿäº§ç”¨ä¾‹ã€‚</li>
<li><a href="https://github.com/kubernetes-sigs/descheduler">Descheduler</a> å–æ¶ˆè°ƒåº¦ç­–ç•¥RemovePodsViolatingNodeTaintsä¼šé©±é€èŠ‚ç‚¹ä¸Šè¿åNoScheduleæ±¡æŸ“çš„Podã€‚å¿…é¡»å¯ç”¨k8sè°ƒåº¦ç¨‹åºçš„TaintNodesByConditionåŠŸèƒ½ã€‚</li>
<li><a href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler">Cluster Autoscaler</a> å¯ç”¨äºè‡ªåŠ¨ç»ˆæ­¢è€—å°½çš„èŠ‚ç‚¹ã€‚</li>
<li><a href="https://github.com/medik8s">mediK8S</a> æ˜¯ä¸€ä¸ªåŸºäº<a href="https://github.com/medik8s/node-healthcheck-operator">Node Health Check Operator (NHC)</a>æ„å»ºçš„è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿçš„æ€»ä½“é¡¹ç›®ï¼Œè¯¥ç³»ç»Ÿç›‘æ§èŠ‚ç‚¹çŠ¶å†µå¹¶ä½¿ç”¨ä¿®å¤ APIå°†ä¿®å¤å§”æ‰˜ç»™å¤–éƒ¨ä¿®å¤ç¨‹åºã€‚</li>
<li><a href="https://github.com/medik8s/poison-pill">Poison-Pill</a>æ˜¯ä¸€ä¸ªä¿®å¤ç¨‹åºï¼Œå®ƒå°†é‡æ–°å¯åŠ¨èŠ‚ç‚¹å¹¶ç¡®ä¿æ‰€æœ‰æœ‰çŠ¶æ€çš„å·¥ä½œè´Ÿè½½éƒ½å¾—åˆ°é‡æ–°å®‰æ’ã€‚å¦‚æœé›†ç¾¤å…·æœ‰è¶³å¤Ÿçš„å¥åº·å®¹é‡ï¼ŒNHCæ”¯æŒæœ‰æ¡ä»¶åœ°è¿›è¡Œä¿®å¤ï¼Œæˆ–è€…æ‰‹åŠ¨æš‚åœä»»ä½•æ“ä½œä»¥æœ€å¤§é™åº¦åœ°å‡å°‘é›†ç¾¤ä¸­æ–­ã€‚</li>
<li><a href="https://cluster-api.sigs.k8s.io/">Cluster API</a> çš„<a href="https://cluster-api.sigs.k8s.io/developer/architecture/controllers/machine-health-check">MachineHealthCheck</a>è´Ÿè´£ä¿®å¤ä¸å¥åº·çš„æœºå™¨ã€‚</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Ldapé€šè¿‡helméƒ¨ç½²</title>
    <url>/2025/07/devops/ldap/Ldap%E9%80%9A%E8%BF%87helm%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><blockquote>
<p>âš¡ï¸: OpenLDAPæ˜¯è½»é‡çº§ç›®å½•è®¿é—®åè®®ï¼ˆLDAPï¼‰çš„å¼€æºå®ç°ï¼Œå®ƒæä¾›äº†ä¸€ç§å­˜å‚¨å’Œè®¿é—®å…³äºç”¨æˆ·ã€ç»„ã€è®¡ç®—æœºå’Œå…¶ä»–èµ„æºçš„ä¿¡æ¯çš„ä¸­å¿ƒåŒ–ç›®å½•æœåŠ¡ã€‚</p>
</blockquote>
<h1 id="å±æ€§ä»‹ç»"><a href="#å±æ€§ä»‹ç»" class="headerlink" title="å±æ€§ä»‹ç»"></a>å±æ€§ä»‹ç»</h1><ul>
<li>cnï¼ˆcommon nameï¼‰ï¼šé€šç”¨åç§°ï¼Œè¡¨ç¤ºä¸€ä¸ªå¯¹è±¡çš„åç§°ã€‚åœ¨ç”¨æˆ·æ¡ç›®ä¸­ï¼Œé€šå¸¸ä¸ç”¨æˆ·çš„å§“åç›¸å¯¹åº”ï¼›åœ¨ç»„æ¡ç›®ä¸­ï¼Œåˆ™ä¸ç»„åç›¸å¯¹åº”ã€‚</li>
<li>ouï¼ˆorganizational unitï¼‰ï¼šç»„ç»‡å•ä½ï¼Œè¡¨ç¤ºä¸€ä¸ªç»„ç»‡æˆ–éƒ¨é—¨ã€‚åœ¨LDAPç›®å½•æœåŠ¡ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ouæ¥åˆ›å»ºå¤šçº§ç»„ç»‡ç»“æ„ï¼Œå¹¶å°†ç”¨æˆ·å’Œå…¶ä»–å¯¹è±¡åˆ†é…åˆ°ç›¸åº”çš„ç»„ç»‡å•å…ƒä¸­ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç®¡ç†å®ƒä»¬ã€‚</li>
<li>dcï¼ˆdomain componentï¼‰ï¼šåŸŸç»„ä»¶ï¼Œè¡¨ç¤ºåŸŸåçš„ä¸€éƒ¨åˆ†ã€‚åœ¨LDAPä¸­ï¼ŒåŸŸåé€šå¸¸æ˜¯æŒ‰ç…§å±‚æ¬¡ç»“æ„ç»„ç»‡çš„ï¼Œä¾‹å¦‚ï¼šexample.comå¯ä»¥è¢«æ‹†åˆ†ä¸ºdc&#x3D;example,dc&#x3D;comã€‚è¿™æ ·åšæœ‰åˆ©äºæœ‰æ•ˆåœ°ç»„ç»‡å’Œç®¡ç†å¤§è§„æ¨¡çš„ç›®å½•æœåŠ¡ã€‚</li>
<li>snï¼ˆsurnameï¼‰ï¼šå§“æ°ï¼Œè¡¨ç¤ºä¸€ä¸ªäººçš„å§“æ°ã€‚ä¸cnå±æ€§ä¸åŒï¼Œsnåªè¡¨ç¤ºå§“æ°ï¼Œè€Œä¸”é€šå¸¸ä¸å”¯ä¸€ã€‚</li>
</ul>
<h1 id="kubernetesé›†ç¾¤éƒ¨ç½²"><a href="#kubernetesé›†ç¾¤éƒ¨ç½²" class="headerlink" title="kubernetesé›†ç¾¤éƒ¨ç½²"></a>kubernetesé›†ç¾¤éƒ¨ç½²</h1><p>å‚è€ƒ<a href="https://hua-ri.cn/2025/07/kubernetes/Kind%E6%90%AD%E5%BB%BA%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4/">å¿«é€Ÿæ­å»ºkindæµ‹è¯•é›†ç¾¤</a>å¿«é€Ÿæ­å»ºä¸€æœ¬åœ°æµ‹ä½¿ç”¨çš„kindé›†ç¾¤ã€‚</p>
<h1 id="Helméƒ¨ç½²"><a href="#Helméƒ¨ç½²" class="headerlink" title="Helméƒ¨ç½²"></a>Helméƒ¨ç½²</h1><h2 id="æç®€éƒ¨ç½²"><a href="#æç®€éƒ¨ç½²" class="headerlink" title="æç®€éƒ¨ç½²"></a>æç®€éƒ¨ç½²</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm repo add stable https://charts.helm.sh/stable</span><br><span class="line">helm install openldap stable/openldap</span><br></pre></td></tr></table></figure>

<h2 id="å¸¸è§„éƒ¨ç½²"><a href="#å¸¸è§„éƒ¨ç½²" class="headerlink" title="å¸¸è§„éƒ¨ç½²"></a>å¸¸è§„éƒ¨ç½²</h2><p>éƒ¨ç½²ååˆ†ç®€å•ï¼Œä½†æ˜¯æˆ‘ä»¬å¯èƒ½éœ€è¦è°ƒæ•´Helm charté…ç½®ï¼Œæ‰€ä»¥å»ºè®®æŠŠåŒ…æ‹‰å–åˆ°æœ¬åœ°è°ƒæ•´ä¹‹åå†è¿›è¡Œéƒ¨ç½²ï¼Œä¸‹é¢æ˜¯è¯¦ç»†æµç¨‹</p>
<h2 id="å¢åŠ helm-repo"><a href="#å¢åŠ helm-repo" class="headerlink" title="å¢åŠ helm repo"></a>å¢åŠ helm repo</h2><p>å¢åŠ helm repoï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm repo add stable https://charts.helm.sh/stable</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">âœ  ~ helm repo add stable https://charts.helm.sh/stable</span><br><span class="line">&quot;stable&quot; has been added to your repositories</span><br></pre></td></tr></table></figure>

<p>æ£€ç´¢éªŒè¯repoï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm search repo openldap</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">âœ  ~ helm search repo openldap</span><br><span class="line">NAME                   CHART VERSION        APP VERSION        DESCRIPTION                                   </span><br><span class="line">stable/openldap        1.2.7                2.4.48             DEPRECATED - Community developed LDAP software</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="æ‹‰å–chart"><a href="#æ‹‰å–chart" class="headerlink" title="æ‹‰å–chart"></a>æ‹‰å–chart</h2><p>ä¸ºäº†èƒ½å¤Ÿè¿›è¡Œé…ç½®ä¿®æ”¹æ“ä½œï¼Œå°†chartæ‹‰åˆ°æœ¬åœ°ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm pull stable/openldap</span><br></pre></td></tr></table></figure>

<p>è§£å‹chartï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar -zxvf openldap-1.2.7.tgz </span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">âœ  github tar -zxvf openldap-1.2.7.tgz </span><br><span class="line">x openldap/Chart.yaml</span><br><span class="line">x openldap/values.yaml</span><br><span class="line">x openldap/templates/NOTES.txt</span><br><span class="line">x openldap/templates/_helpers.tpl</span><br><span class="line">x openldap/templates/configmap-customldif.yaml</span><br><span class="line">x openldap/templates/configmap-env.yaml</span><br><span class="line">x openldap/templates/deployment.yaml</span><br><span class="line">x openldap/templates/pvc.yaml</span><br><span class="line">x openldap/templates/secret.yaml</span><br><span class="line">x openldap/templates/service.yaml</span><br><span class="line">x openldap/templates/tests/openldap-test-runner.yaml</span><br><span class="line">x openldap/templates/tests/openldap-tests.yaml</span><br><span class="line">x openldap/.helmignore</span><br><span class="line">x openldap/README.md</span><br></pre></td></tr></table></figure>

<h2 id="é…ç½®è°ƒæ•´"><a href="#é…ç½®è°ƒæ•´" class="headerlink" title="é…ç½®è°ƒæ•´"></a>é…ç½®è°ƒæ•´</h2><p>æ‹‰å–çš„ChartåŒ…ï¼Œæ•´ä½“æ¯”è¾ƒå°ï¼Œæ¥çœ‹ä¸‹å¤§æ¦‚çš„ç»“æ„ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ Chart.yaml</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ templates</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ NOTES.txt</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ _helpers.tpl</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ configmap-customldif.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ configmap-env.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ deployment.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ pvc.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ secret.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ service.yaml</span><br><span class="line">â”‚Â Â  â””â”€â”€ tests</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ openldap-test-runner.yaml</span><br><span class="line">â”‚Â Â      â””â”€â”€ openldap-tests.yaml</span><br><span class="line">â””â”€â”€ values.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¦‚æœæœ‰å‚æ•°æ–¹é¢çš„å˜æ›´ï¼Œå¯ä»¥åœ¨values.yamlæ–‡ä»¶å†…è¿›è¡Œå¡«å……é…ç½®ï¼Œæˆ–è€…ä¿®æ”¹é…ç½®ã€‚</p>
<p>templatesç›®å½•ä¸‹å°±æ˜¯æ•´ä¸ªchartçš„æ¨¡æ¿ï¼ŒåŒ…å«äº†éƒ¨ç½²éœ€è¦çš„configmapã€deploymentã€pvcã€secretã€svcç­‰èµ„æºyamlæ¨¡æ¿ã€‚</p>
<p>åˆšåˆšæˆ‘ä»¬æ‹‰å–çš„ChartåŒ… éƒ¨ç½²openldapï¼Œvalues.yamlæ–‡ä»¶å†…éœ€è¦è°ƒæ•´çš„åœ°æ–¹ä¸æ˜¯å¾ˆå¤š:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">env:</span><br><span class="line">  LDAP_ORGANISATION: &quot;King Inc.&quot;</span><br><span class="line">  LDAP_DOMAIN: &quot;king-ldap.net&quot;</span><br><span class="line">  LDAP_BACKEND: &quot;hdb&quot;</span><br><span class="line">  LDAP_TLS: &quot;false&quot;</span><br><span class="line">  LDAP_TLS_ENFORCE: &quot;false&quot;</span><br><span class="line">  LDAP_REMOVE_CONFIG_AFTER_SETUP: &quot;false&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>åœ¨chartçš„æ ¹ç›®å½•æ‰§è¡Œå®‰è£…ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm install --kubeconfig=$HOME/.kube/king_test_config ldap ./</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Password:</span><br><span class="line">WARNING: This chart is deprecated</span><br><span class="line">NAME: ldap</span><br><span class="line">LAST DEPLOYED: Wed Jan 15 21:56:54 2025</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">OpenLDAP has been installed. You can access the server from within the k8s cluster using:</span><br><span class="line"></span><br><span class="line">  ldap-openldap.default.svc.cluster.local:389</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">You can access the LDAP adminPassword and configPassword using:</span><br><span class="line"></span><br><span class="line">  kubectl get secret --namespace default ldap-openldap -o jsonpath=&quot;&#123;.data.LDAP_ADMIN_PASSWORD&#125;&quot; | base64 --decode; echo</span><br><span class="line">  kubectl get secret --namespace default ldap-openldap -o jsonpath=&quot;&#123;.data.LDAP_CONFIG_PASSWORD&#125;&quot; | base64 --decode; echo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">You can access the LDAP service, from within the cluster (or with kubectl port-forward) with a command like (replace password and domain):</span><br><span class="line">  ldapsearch -x -H ldap://ldap-openldap.default.svc.cluster.local:389 -b dc=example,dc=org -D &quot;cn=admin,dc=example,dc=org&quot; -w $LDAP_ADMIN_PASSWORD</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Test server health using Helm test:</span><br><span class="line">  helm test ldap</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">You can also consider installing the helm chart for phpldapadmin to manage this instance of OpenLDAP, or install Apache Directory Studio, and connect using kubectl port-forward.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Helm-æµ‹è¯•"><a href="#Helm-æµ‹è¯•" class="headerlink" title="Helm æµ‹è¯•"></a>Helm æµ‹è¯•</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm list ldap</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹idapçš„podï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl --kubeconfig=$HOME/.kube/king_test_config get pod -A|grep ldap</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">NAMESPACE            NAME                                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">default              ldap-openldap-6d5cc55fc-vzq5v                      1/1     Running   0          17m</span><br></pre></td></tr></table></figure>

<p>ç™»å½•idapçš„podï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl --kubeconfig=$HOME/.kube/king_test_config exec -it pod/ldap-openldap-6d5cc55fc-vzq5v -- /bin/bash</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ä½¿ç”¨ldapsearchå‘½ä»¤è¿›è¡ŒæŸ¥è¯¢ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ldapsearch -x -b &lt;search_base&gt; -H &lt;ldap_host&gt; -D &lt;bind_dn&gt; -W</span></span><br></pre></td></tr></table></figure>
<ul>
<li>-xï¼šè¡¨ç¤ºç®€å•çš„èº«ä»½è®¤è¯ã€‚</li>
<li>-bï¼šæŒ‡å®šæœç´¢çš„ DCã€‚</li>
<li>-Hï¼šæŒ‡å®šæœç´¢çš„ä¸»æœº URLï¼Œå¦‚æœä½ æ˜¯åœ¨ LDAP æœåŠ¡å™¨ä¸Šï¼Œåˆ™ä¸éœ€è¦å¸¦è¿™ä¸ªå‚æ•°ã€‚æ¯”å¦‚æˆ‘è¿™é‡Œä¸º ldap:&#x2F;&#x2F;192.168.31.76:389</li>
<li>-Dï¼šç»‘å®šçš„ DNã€‚</li>
<li>-Wï¼šç»‘å®šçš„ DN çš„å¯†ç ã€‚</li>
</ul>
<p>ä¾‹å¦‚ä¸€ä¸ªå®é™…çš„æŸ¥è¯¢å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ldapsearch -x -b &quot;dc=king-ldap,dc=net&quot; -D &quot;cn=admin,dc=king-ldap,dc=net&quot;  -W</span><br></pre></td></tr></table></figure>

<p>ä¼šè¦æ±‚è¾“å…¥å¯†ç ï¼Œå¯ä»¥å¦‚æ­¤è·å–ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">env|grep -i PASSWORD</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">LDAP_CONFIG_PASSWORD=M2ulnYD2lZPvM1hKsYP5sCy8meDN8h61</span><br><span class="line">LDAP_ADMIN_PASSWORD=a4QL47j3QvQWaTkDolvgLHpbpX8YDTdn</span><br></pre></td></tr></table></figure>

<p>æŸ¥è¯¢ç»“æœï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">root@ldap-openldap-6d5cc55fc-vzq5v:~# ldapsearch -x -b &quot;dc=king-ldap,dc=net&quot; -D &quot;cn=admin,dc=king-ldap,dc=net&quot;  -W</span><br><span class="line">Enter LDAP Password: </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">extended LDIF</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># LDAPv3</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">base &lt;dc=king-ldap,dc=net&gt; with scope subtree</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">filter: (objectclass=*)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">requesting: ALL</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"></span><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">king-ldap.net</span></span><br><span class="line">dn: dc=king-ldap,dc=net</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: dcObject</span><br><span class="line">objectClass: organization</span><br><span class="line">o: King Inc.</span><br><span class="line">dc: king-ldap</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">admin, king-ldap.net</span></span><br><span class="line">dn: cn=admin,dc=king-ldap,dc=net</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">cn: admin</span><br><span class="line">description: LDAP administrator</span><br><span class="line">userPassword:: e1NTSEF9eEl0d3JvcFN1cTgxelBLSFozVHYzQzJSdmtLcXNXenY=</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">search result</span></span><br><span class="line">search: 2</span><br><span class="line">result: 0 Success</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">numResponses: 3</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">numEntries: 2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Helm-æ•°æ®æŒä¹…åŒ–ï¼Ÿ"><a href="#Helm-æ•°æ®æŒä¹…åŒ–ï¼Ÿ" class="headerlink" title="Helm æ•°æ®æŒä¹…åŒ–ï¼Ÿ"></a>Helm æ•°æ®æŒä¹…åŒ–ï¼Ÿ</h1><p>çœ‹ä¸‹pvcçš„yamlæ¨¡æ¿ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;&#123;- if and .Values.persistence.enabled (not .Values.persistence.existingClaim) &#125;&#125;</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; template &quot;openldap.fullname&quot; . &#125;&#125;</span><br><span class="line">  labels:</span><br><span class="line">    app: &#123;&#123; template &quot;openldap.name&quot; . &#125;&#125;</span><br><span class="line">    chart: &#123;&#123; template &quot;openldap.chart&quot; . &#125;&#125;</span><br><span class="line">    release: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">    heritage: &#123;&#123; .Release.Service &#125;&#125;</span><br><span class="line">&#123;&#123;- if .Values.extraLabels &#125;&#125;</span><br><span class="line">&#123;&#123; toYaml .Values.extraLabels | indent 4 &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - &#123;&#123; .Values.persistence.accessMode | quote &#125;&#125;</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: &#123;&#123; .Values.persistence.size | quote &#125;&#125;</span><br><span class="line">&#123;&#123;- if .Values.persistence.storageClass &#125;&#125;</span><br><span class="line">&#123;&#123;- if (eq &quot;-&quot; .Values.persistence.storageClass) &#125;&#125;</span><br><span class="line">  storageClassName: &quot;&quot;</span><br><span class="line">&#123;&#123;- else &#125;&#125;</span><br><span class="line">  storageClassName: &quot;&#123;&#123; .Values.persistence.storageClass &#125;&#125;&quot;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®é…ç½®ï¼Œåªè¦åœ¨values.yamlæ–‡ä»¶çš„è¿™éƒ¨åˆ†è¿›è¡Œpvcé…ç½®çš„å¡«å…¥å†è¿›è¡Œå®‰è£…å³å¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Persist data to a persistent volume</span></span></span><br><span class="line">persistence:</span><br><span class="line">  enabled: false</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment"># database data Persistent Volume Storage Class</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment"># If defined, storageClassName: &lt;storageClass&gt;</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment"># If set to &quot;-&quot;, storageClassName: &quot;&quot;, which disables dynamic provisioning</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment"># If undefined (the default) or set to null, no storageClassName spec is</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment">#   set, choosing the default provisioner.  (gp2 on AWS, standard on</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment">#   GKE, AWS &amp; OpenStack)</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">storageClass: <span class="string">&quot;-&quot;</span></span></span><br><span class="line">  accessMode: ReadWriteOnce</span><br><span class="line">  size: 8Gi</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">existingClaim: <span class="string">&quot;&quot;</span></span></span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>gitç¯å¢ƒé…ç½®</title>
    <url>/2025/07/devops/environment/git%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<h1 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h1><h2 id="è®¾ç½®ç”¨æˆ·ç­¾å"><a href="#è®¾ç½®ç”¨æˆ·ç­¾å" class="headerlink" title="è®¾ç½®ç”¨æˆ·ç­¾å"></a>è®¾ç½®ç”¨æˆ·ç­¾å</h2><p>é…ç½®ç”¨æˆ·åï¼š git config â€“global user.name ä½ çš„ç”¨æˆ·å<br>é…ç½®é‚®ç®±ï¼š git config â€“global user.email æ³¨å†Œçš„é‚®ç®±</p>
<p>é…ç½®å¥½ä¹‹åï¼Œå¯ä»¥ç”¨git config â€“global â€“listå‘½ä»¤æŸ¥çœ‹é…ç½®æ˜¯å¦OK</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git config --global --list</span></span><br><span class="line">user.name=xxx</span><br><span class="line">user.email=xxx@163.com</span><br></pre></td></tr></table></figure>

<h2 id="è®¾ç½®sshKey"><a href="#è®¾ç½®sshKey" class="headerlink" title="è®¾ç½®sshKey"></a>è®¾ç½®sshKey</h2><p>ç”Ÿæˆæ–°çš„rsaå¯†é’¥ï¼šssh-keygen -t rsa -C â€˜æ³¨å†ŒGitHubçš„é‚®ç®±â€™</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C xxx@163.com</span><br></pre></td></tr></table></figure>

<p>ä¸€ç›´å›è½¦å°±å¯ä»¥ï¼Œå³ä¸è®¾ç½®å¯†ç ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh-keygen -t rsa -C xxx@163.com</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/home/king/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /home/king/.ssh/id_rsa</span><br><span class="line">Your public key has been saved in /home/king/.ssh/id_rsa.pub</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:n+yyy xxx@163.com</span><br><span class="line">The key&#x27;s randomart image is:</span><br><span class="line">+---[RSA 3072]----+</span><br><span class="line">|    .*=.+.       |</span><br><span class="line">|    = +=o= o     |</span><br><span class="line">|     * ++ o .    |</span><br><span class="line">|  o . o..  .     |</span><br><span class="line">| o * .  S o      |</span><br><span class="line">|. X o  o = +     |</span><br><span class="line">| + + .. = *      |</span><br><span class="line">|..o .  o E       |</span><br><span class="line">|.o==    .        |</span><br><span class="line">+----[SHA256]-----+</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶å·²ç»ç”Ÿæˆäº†ssh rasçš„å¯†é’¥ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> <span class="variable">$HOME</span>/.ssh</span></span><br><span class="line">authorized_keys  id_rsa  id_rsa.pub  known_hosts</span><br></pre></td></tr></table></figure>

<h2 id="è®¾ç½®githubçš„SSH-key"><a href="#è®¾ç½®githubçš„SSH-key" class="headerlink" title="è®¾ç½®githubçš„SSH key"></a>è®¾ç½®githubçš„SSH key</h2><p><img src="/img.png" alt="img.png"><br><img src="/img_1.png" alt="img_1.png"><br><img src="/img_2.png" alt="img_2.png"></p>
<p>å°†ä¸Šé¢ç”Ÿæˆçš„sshå…¬é’¥å¤åˆ¶è¿›å»ã€‚<br><img src="/img_3.png" alt="img_3.png"></p>
]]></content>
  </entry>
  <entry>
    <title>ä»“åº“forkååŒæ­¥</title>
    <url>/2025/07/devops/environment/%E4%BB%93%E5%BA%93fork%E5%90%8E%E5%90%8C%E6%AD%A5/</url>
    <content><![CDATA[<h1 id="forkä»“åº“"><a href="#forkä»“åº“" class="headerlink" title="forkä»“åº“"></a>forkä»“åº“</h1><p><img src="/img_4.png" alt="img_4.png"><br><img src="/img_5.png" alt="img_5.png"></p>
<p>æ­¤æ—¶ä¼šå°†è¯¥ä»“åº“åœ¨å¤åˆ¶ä¸€ä»½ï¼Œå¹¶å­˜æ”¾åœ¨ä½ çš„è·¯å¾„ä¸‹ï¼š<br><img src="/img_6.png" alt="img_6.png"></p>
<h1 id="è®¾ç½®ä¸Šæ¸¸ä»£ç åº“"><a href="#è®¾ç½®ä¸Šæ¸¸ä»£ç åº“" class="headerlink" title="è®¾ç½®ä¸Šæ¸¸ä»£ç åº“"></a>è®¾ç½®ä¸Šæ¸¸ä»£ç åº“</h1><p>è¿›å…¥æœ¬åœ°ä»£ç åº“ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä»è‡ªå·±ä»“åº“è¿›è¡Œ<span class="built_in">clone</span>(fork)</span></span><br><span class="line">git clone https://github.com/qiqiuyang/bk-ci.git</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿›å…¥ç›®å½•</span></span><br><span class="line">cd bk-ci/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹ç›®å½•ç»“æ„</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span></span></span><br><span class="line">CHANGELOG              CONTRIBUTING.md  README_EN.md  support-files</span><br><span class="line">CODE_OF_CONDUCT.en.md  docker-images    README.md     THIRD-PARTY-NOTICES.txt</span><br><span class="line">CODE_OF_CONDUCT.md     docs             scripts</span><br><span class="line">CODEOWNERS             helm-charts      SECURITY.md</span><br><span class="line">CONTRIBUTING.en.md     LICENSE.txt      src</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹è¿œç¨‹ä»“åº“çš„è·¯å¾„</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git remote -v</span></span><br><span class="line">origin        https://github.com/qiqiuyang/bk-ci.git (fetch)</span><br><span class="line">origin        https://github.com/qiqiuyang/bk-ci.git (push)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯ä»¥å‘ç°ä»è‡ªå·±ä»“åº“cloneä¸‹æ¥åï¼Œfetchå’Œpushçš„è·¯å¾„éƒ½æ˜¯è‡ªå·±çš„ã€‚</p>
<p>è®¾ç½®ä¸Šæ¸¸ä»£ç åº“</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git remote add upstream git@github.com:TencentBlueKing/bk-ci.git</span></span><br></pre></td></tr></table></figure>

<p>å†æ¬¡æŸ¥çœ‹è¿œç¨‹ä»“åº“åœ°å€ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git remote -v</span></span><br><span class="line">origin        https://github.com/qiqiuyang/bk-ci.git (fetch)</span><br><span class="line">origin        https://github.com/qiqiuyang/bk-ci.git (push)</span><br><span class="line">upstream        git@github.com:TencentBlueKing/bk-ci.git (fetch)</span><br><span class="line">upstream        git@github.com:TencentBlueKing/bk-ci.git (push)</span><br></pre></td></tr></table></figure>

<h1 id="åŒæ­¥æºä»“åº“çš„æ›´æ–°"><a href="#åŒæ­¥æºä»“åº“çš„æ›´æ–°" class="headerlink" title="åŒæ­¥æºä»“åº“çš„æ›´æ–°"></a>åŒæ­¥æºä»“åº“çš„æ›´æ–°</h1><p>ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ‹‰å–æºä»“åº“çš„æ›´æ–°ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git fetch upstream</span></span><br><span class="line">remote: Enumerating objects: 17643, done.</span><br><span class="line">remote: Counting objects: 100% (13492/13492), done.</span><br><span class="line">remote: Compressing objects: 100% (3960/3960), done.</span><br><span class="line">remote: Total 10070 (delta 4278), reused 8600 (delta 3184), pack-reused 0 (from 0)</span><br><span class="line">æ¥æ”¶å¯¹è±¡ä¸­: 100% (10070/10070), 2.44 MiB | 2.05 MiB/s, å®Œæˆ.</span><br><span class="line">å¤„ç† delta ä¸­: 100% (4278/4278), å®Œæˆ 657 ä¸ªæœ¬åœ°å¯¹è±¡.</span><br><span class="line">æ¥è‡ª github.com:TencentBlueKing/bk-ci</span><br><span class="line"> * [æ–°åˆ†æ”¯]                master          -&gt; upstream/master</span><br><span class="line"> * [æ–°åˆ†æ”¯]                release-1.11    -&gt; upstream/release-1.11</span><br><span class="line"> * [æ–°åˆ†æ”¯]                release-1.14    -&gt; upstream/release-1.14</span><br><span class="line"> * [æ–°åˆ†æ”¯]                release-1.2     -&gt; upstream/release-1.2</span><br><span class="line"> * [æ–°åˆ†æ”¯]                release-1.3     -&gt; upstream/release-1.3</span><br><span class="line">ã€‚ã€‚ã€‚</span><br><span class="line">ã€‚ã€‚ã€‚</span><br><span class="line"> * [æ–°æ ‡ç­¾]                v1.8.4          -&gt; v1.8.4</span><br><span class="line"> * [æ–°æ ‡ç­¾]                v1.8.5          -&gt; v1.8.5</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œå°±æ¯”è¾ƒæ¸…æ™°äº†ï¼Œåœ¨æ›´æ–°æ—¶å°±æ˜¯æŠŠæºä»“åº“çš„æ›´æ–°çš„åˆ†æ”¯æ”¾åœ¨upstreamä¸‹ï¼Œä¾‹å¦‚ï¼šupstream&#x2F;master</p>
<p>æ‰€ä»¥åŒæ­¥è¿œç«¯åˆ†æ”¯æ—¶ï¼Œå°±æ˜¯git fetch upstreamï¼Œç„¶åå°†è‡ªå·±çš„åˆ†æ”¯mergeç›®æ ‡åˆ†æ”¯å†…å®¹ï¼Œä¾‹å¦‚ï¼šgit merge upstream&#x2F;master</p>
<p>å¦‚æ­¤ä¾¿å¯ä»¥å®ç°è‡ªå·±çš„forkä»“åº“åŒæ­¥æºä»“åº“çš„æ–°å˜æ›´äº†ã€‚</p>
<h1 id="å‘åŸä»“åº“å‘èµ·PR"><a href="#å‘åŸä»“åº“å‘èµ·PR" class="headerlink" title="å‘åŸä»“åº“å‘èµ·PR"></a>å‘åŸä»“åº“å‘èµ·PR</h1><p>é¦–å…ˆåœ¨è‡ªå·±çš„ä»“åº“ç‚¹å‡»Pull Request-&gt;New Pull Requestï¼Œè¿›å…¥ä»¥ä¸‹æˆªå›¾é¡µé¢<br><img src="/img_7.png" alt="img_7.png"></p>
<p>base repositoryä¸ºåŸä»“åº“çš„æŸä¸ªåˆ†æ”¯ï¼Œhead repositoryä¸ºforkä»“åº“å‘æŸä¸ªåˆ†æ”¯, headçš„æŸä¸ªåˆ†æ”¯ä»£ç åˆåˆ°baseçš„æŸä¸ªåˆ†æ”¯<br><img src="/img_8.png" alt="img_8.png"></p>
<p>è¿›å…¥åŸä»“åº“çš„Pull requestså¯çœ‹åˆ°åˆšæ‰å‘èµ·çš„PRï¼Œ è¿™é‡Œå°±ä¸æ¼”ç¤ºäº†</p>
]]></content>
  </entry>
  <entry>
    <title>alicloud_alikafka_instance</title>
    <url>/2025/07/devops/terraform/alicloud_alikafka_instance/</url>
    <content><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>çº¦å®šæ ¼å¼ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ aliyun                                             # äº‘å‚å•†å®ä¾‹æ–‡ä»¶</span><br><span class="line">â”‚   â””â”€â”€ aliyun_ecs_mod_demo                           # æ¨¡å‹å</span><br><span class="line">â”‚       â””â”€â”€ aliyun_china_platform_7111                # äº‘è´¦å·å</span><br><span class="line">â”‚           â””â”€â”€ ecs_instance_name_20241224121212      # å®ä¾‹å</span><br><span class="line">â”‚               â”œâ”€â”€ backend.tf                        # å®ä¾‹stateæ–‡ä»¶ä¿å­˜è¯´æ˜ï¼šoss</span><br><span class="line">â”‚               â””â”€â”€ main.tf                           # å®ä¾‹å…·ä½“çš„å‚æ•°</span><br><span class="line">â”œâ”€â”€ modules                                            # æ¨¡å‹æ•°æ®æ–‡ä»¶å¤¹</span><br><span class="line">â”‚   â”œâ”€â”€ aliyun                                        # äº‘å‚å•†æ¨¡å‹æ–‡ä»¶å¤¹</span><br><span class="line">â”‚   â”‚   â””â”€â”€ aliyun_ecs_mod_demo                       # æ¨¡å‹å</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ main.tf                               # æ¨¡å‹å®šä¹‰ä¸»æ–‡ä»¶</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ outputs.tf                            # æ¨¡å‹å®šä¹‰è¾“å‡ºæ–‡ä»¶</span><br><span class="line">â”‚   â”‚       â””â”€â”€ variables.tf                          # æ¨¡å‹å®šä¹‰å‚æ•°æ–‡ä»¶</span><br><span class="line">â”‚   â””â”€â”€ tenmod                                         # å¦ä¸€ä¸ªäº‘å‚å•†æ¨¡å‹</span><br><span class="line">â””â”€â”€ tenent                                              # å¦ä¸€ä¸ªäº‘å‚å•†å®ä¾‹æ–‡ä»¶</span><br></pre></td></tr></table></figure>

<h1 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ aliyun</span><br><span class="line">â”‚   â””â”€â”€ aliyun_alikafka_demo</span><br><span class="line">â”‚       â””â”€â”€ aliyun_china_pt_7111</span><br><span class="line">â”‚           â””â”€â”€ alikafka_demo_202502061910</span><br><span class="line">â”‚               â”œâ”€â”€ backend.tf</span><br><span class="line">â”‚               â””â”€â”€ main.tf</span><br><span class="line">â””â”€â”€ modules</span><br><span class="line">    â””â”€â”€ aliyun</span><br><span class="line">        â””â”€â”€ aliyun_alikafka_mod_demo</span><br><span class="line">            â”œâ”€â”€ main.tf</span><br><span class="line">            â””â”€â”€ variables.tf</span><br></pre></td></tr></table></figure>

<h2 id="modules"><a href="#modules" class="headerlink" title="modules"></a>modules</h2><h3 id="modules-aliyun-aliyun-alikafka-mod-demo-main-tf"><a href="#modules-aliyun-aliyun-alikafka-mod-demo-main-tf" class="headerlink" title="&#x2F;modules&#x2F;aliyun&#x2F;aliyun_alikafka_mod_demo&#x2F;main.tf"></a>&#x2F;modules&#x2F;aliyun&#x2F;aliyun_alikafka_mod_demo&#x2F;main.tf</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    alicloud = &#123;</span><br><span class="line">      source  = &quot;aliyun/alicloud&quot;</span><br><span class="line">      version = &quot;1.225.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">provider &quot;alicloud&quot; &#123;</span><br><span class="line">  region = var.region</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;alicloud_alikafka_instance&quot; &quot;this&quot; &#123;</span><br><span class="line">  name          = var.instance_name</span><br><span class="line">  deploy_type   = var.deploy_type</span><br><span class="line">  disk_size     = var.disk_size</span><br><span class="line">  disk_type     = var.disk_type</span><br><span class="line">  vswitch_id    = var.vswitch_id</span><br><span class="line">  partition_num = var.partition_num</span><br><span class="line">  io_max        = var.io_max</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="modules-aliyun-aliyun-alikafka-mod-demo-variables-tf"><a href="#modules-aliyun-aliyun-alikafka-mod-demo-variables-tf" class="headerlink" title="&#x2F;modules&#x2F;aliyun&#x2F;aliyun_alikafka_mod_demo&#x2F;variables.tf"></a>&#x2F;modules&#x2F;aliyun&#x2F;aliyun_alikafka_mod_demo&#x2F;variables.tf</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">variable &quot;region&quot; &#123;</span><br><span class="line">  description = &quot;åœ°åŸŸ&quot;</span><br><span class="line">  type        = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;instance_name&quot; &#123;</span><br><span class="line">  description = &quot;kafkaå®ä¾‹å&quot;</span><br><span class="line">  type        = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;deploy_type&quot; &#123;</span><br><span class="line">  // - 4: eip/vpc instanceï¼›- 5: vpc instance.</span><br><span class="line">  description = &quot;éƒ¨ç½²ç±»å‹&quot;</span><br><span class="line">  type        = number</span><br><span class="line">  default = 5</span><br><span class="line">  validation &#123;</span><br><span class="line">    condition     = contains([4, 5], var.deploy_type)</span><br><span class="line">    error_message = &quot;The deploy_type must be one of 4, 5&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;disk_size&quot; &#123;</span><br><span class="line">  description = &quot;kafkaå®ä¾‹ç£ç›˜è§„æ ¼&quot;</span><br><span class="line">  type = number</span><br><span class="line">  validation &#123;</span><br><span class="line">    condition     = contains([500, 1000], var.disk_size)</span><br><span class="line">    error_message = &quot;The disk_size must be one of 200, 400&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;disk_type&quot; &#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">0: efficient cloud disk , 1: SSD.</span></span><br><span class="line">  description = &quot;ç£ç›˜ç±»å‹&quot;</span><br><span class="line">  type = number</span><br><span class="line">  default = 1</span><br><span class="line">  validation &#123;</span><br><span class="line">    condition     = contains([0, 1], var.disk_type)</span><br><span class="line">    error_message = &quot;The disk_type must be empty, or one of 0, 1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;vswitch_id&quot; &#123;</span><br><span class="line">  description = &quot;ç»‘å®šè™šæ‹Ÿäº¤æ¢æœºid&quot;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;partition_num&quot; &#123;</span><br><span class="line">  description = &quot;åˆ†åŒºæ•°é‡&quot;</span><br><span class="line">  type = number</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">variable &quot;io_max&quot; &#123;</span><br><span class="line">  description = &quot;ioçš„æœ€å¤§å€¼&quot;</span><br><span class="line">  type = number</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><h3 id="aliyun-aliyun-alikafka-demo-aliyun-china-pt-7111-alikafka-demo-202502061910-backend-tf"><a href="#aliyun-aliyun-alikafka-demo-aliyun-china-pt-7111-alikafka-demo-202502061910-backend-tf" class="headerlink" title="&#x2F;aliyun&#x2F;aliyun_alikafka_demo&#x2F;aliyun_china_pt_7111&#x2F;alikafka_demo_202502061910&#x2F;backend.tf"></a>&#x2F;aliyun&#x2F;aliyun_alikafka_demo&#x2F;aliyun_china_pt_7111&#x2F;alikafka_demo_202502061910&#x2F;backend.tf</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  backend &quot;oss&quot; &#123;</span><br><span class="line">    endpoint = &quot;oss-cn-hangzhou.aliyuncs.com&quot;</span><br><span class="line">    bucket   = &quot;dz-devops&quot; # æ›¿æ¢ä¸ºä½ çš„ OSS Bucket åç§°</span><br><span class="line">    prefix = &quot;terraform_state//aliyun/aliyun_alikafka_demo/aliyun_china_pt_7111/alikafka_demo_202502061910&quot;</span><br><span class="line">    key      = &quot;terraform.tfstate&quot; # å­˜å‚¨çŠ¶æ€æ–‡ä»¶çš„è·¯å¾„å’Œåç§°</span><br><span class="line">    region   = &quot;cn-hangzhou&quot;       # OSS çš„åœ°åŸŸï¼ˆæ ¹æ®ä½ çš„å®é™…æƒ…å†µè°ƒæ•´ï¼‰</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="aliyun-aliyun-alikafka-demo-aliyun-china-pt-7111-alikafka-demo-202502061910-main-tf"><a href="#aliyun-aliyun-alikafka-demo-aliyun-china-pt-7111-alikafka-demo-202502061910-main-tf" class="headerlink" title="&#x2F;aliyun&#x2F;aliyun_alikafka_demo&#x2F;aliyun_china_pt_7111&#x2F;alikafka_demo_202502061910&#x2F;main.tf"></a>&#x2F;aliyun&#x2F;aliyun_alikafka_demo&#x2F;aliyun_china_pt_7111&#x2F;alikafka_demo_202502061910&#x2F;main.tf</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">module &quot;alikafka_instance&quot; &#123;</span><br><span class="line">  source        = &quot;../../../../modules/aliyun/aliyun_alikafka_mod_demo&quot;</span><br><span class="line">  region        = &quot;cn-hangzhou&quot;</span><br><span class="line">  disk_size     = 500</span><br><span class="line">  instance_name = &quot;alikafka-testV2&quot;</span><br><span class="line">  deploy_type   = 5</span><br><span class="line">  vswitch_id    = &quot;vsw-bp1co65f3q2s0bis9yfkg&quot;</span><br><span class="line">  partition_num = 50</span><br><span class="line">  io_max        = 20</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è¿è¡Œæµ‹è¯•"><a href="#è¿è¡Œæµ‹è¯•" class="headerlink" title="è¿è¡Œæµ‹è¯•"></a>è¿è¡Œæµ‹è¯•</h2><h3 id="è·å–-AK-SK"><a href="#è·å–-AK-SK" class="headerlink" title="è·å– AK&#x2F;SK"></a>è·å– AK&#x2F;SK</h3><p>åœ¨é¦–æ¬¡ä½¿ç”¨ Terraform ä¹‹å‰ï¼Œéœ€è¦å‰å¾€è…¾è®¯äº‘çš„<a href="https://console.cloud.tencent.com/cam/capi">äº‘ API å¯†é’¥é¡µé¢</a>ç”³è¯·å®‰å…¨å‡­è¯SecretIdå’ŒSecretKey2ã€‚è‹¥å·²æœ‰å¯ä½¿ç”¨çš„å®‰å…¨å‡­è¯ï¼Œåˆ™è·³è¿‡è¯¥æ­¥éª¤2ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹2ï¼š</p>
<ol>
<li>ç™»å½•è…¾è®¯äº‘<a href="https://console.cloud.tencent.com/cam">è®¿é—®ç®¡ç†æ§åˆ¶å°</a>ï¼Œåœ¨å·¦ä¾§å¯¼èˆªæ ï¼Œé€‰æ‹©è®¿é—®å¯†é’¥&gt;API å¯†é’¥ç®¡ç†ã€‚</li>
<li>åœ¨API å¯†é’¥ç®¡ç†é¡µé¢ï¼Œå•å‡»æ–°å»ºå¯†é’¥ï¼Œå³å¯ä»¥åˆ›å»ºä¸€å¯¹SecretId&#x2F;SecretKeyã€‚</li>
</ol>
<h3 id="è®¾ç½®ç¯å¢ƒå˜é‡"><a href="#è®¾ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="è®¾ç½®ç¯å¢ƒå˜é‡"></a>è®¾ç½®ç¯å¢ƒå˜é‡</h3><p>å°†è·å–åˆ°çš„SecretIdå’ŒSecretKeyè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export TENCENTCLOUD_SECRET_ID=your_secret_id</span><br><span class="line">export TENCENTCLOUD_SECRET_KEY=your_secret_key</span><br></pre></td></tr></table></figure>

<h3 id="è¿è¡Œé¡¹ç›®"><a href="#è¿è¡Œé¡¹ç›®" class="headerlink" title="è¿è¡Œé¡¹ç›®"></a>è¿è¡Œé¡¹ç›®</h3><p>è¿›å…¥é¡¹ç›®æ ¹ç›®å½•ï¼Œalikafka_demo_202502061910ç›®å½•ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ./aliyun/aliyun_alikafka_demo/aliyun_china_pt_7111/alikafka_demo_202502061910</span><br></pre></td></tr></table></figure>

<p>åˆå§‹åŒ– Terraform é¡¹ç›®:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†xxxæ›¿æ¢ä¸ºå®é™…backendçš„akï¼Œå°†yyyæ›¿æ¢ä¸ºå®é™…backendçš„sk</span></span><br><span class="line">terraform init -backend-config=&quot;access_key=xxx&quot; -backend-config=&quot;secret_key=yyy&quot;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‘½ä»¤ä¼šä¸‹è½½æ‰€éœ€çš„æ’ä»¶å’Œä¾èµ–ï¼Œå¹¶åˆå§‹åŒ–åç«¯é…ç½®ã€‚<br>ç±»ä¼¼çš„è¾“å‡ºï¼ˆé¦–æ¬¡ä½¿ç”¨æŸä¸€ä¸ªprovieræ—¶ï¼Œä¼šå…ˆä¸‹è½½ï¼‰ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Initializing the backend...</span><br><span class="line"></span><br><span class="line">Successfully configured the backend &quot;oss&quot;! Terraform will automatically</span><br><span class="line">use this backend unless the backend configuration changes.</span><br><span class="line">Initializing modules...</span><br><span class="line">Initializing provider plugins...</span><br><span class="line">- Reusing previous version of aliyun/alicloud from the dependency lock file</span><br><span class="line">- Using previously-installed aliyun/alicloud v1.225.0</span><br><span class="line"></span><br><span class="line">Terraform has been successfully initialized!</span><br><span class="line"></span><br><span class="line">You may now begin working with Terraform. Try running &quot;terraform plan&quot; to see</span><br><span class="line">any changes that are required for your infrastructure. All Terraform commands</span><br><span class="line">should now work.</span><br><span class="line"></span><br><span class="line">If you ever set or change modules or backend configuration for Terraform,</span><br><span class="line">rerun this command to reinitialize your working directory. If you forget, other</span><br><span class="line">commands will detect it and remind you to do so if necessary.</span><br></pre></td></tr></table></figure>

<p>é¢„è§ˆè®¡åˆ’å˜æ›´ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">terraform plan</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span><br><span class="line">  + create</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">module.alikafka_instance.alicloud_alikafka_instance.this will be created</span></span><br><span class="line">  + resource &quot;alicloud_alikafka_instance&quot; &quot;this&quot; &#123;</span><br><span class="line">      + config            = (known after apply)</span><br><span class="line">      + deploy_type       = 5</span><br><span class="line">      + disk_size         = 500</span><br><span class="line">      + disk_type         = 1</span><br><span class="line">      + eip_max           = (known after apply)</span><br><span class="line">      + end_point         = (known after apply)</span><br><span class="line">      + group_left        = (known after apply)</span><br><span class="line">      + group_used        = (known after apply)</span><br><span class="line">      + id                = (known after apply)</span><br><span class="line">      + io_max            = 20</span><br><span class="line">      + io_max_spec       = (known after apply)</span><br><span class="line">      + is_partition_buy  = (known after apply)</span><br><span class="line">      + name              = &quot;alikafka-testV2&quot;</span><br><span class="line">      + paid_type         = &quot;PostPaid&quot;</span><br><span class="line">      + partition_left    = (known after apply)</span><br><span class="line">      + partition_num     = 50</span><br><span class="line">      + partition_used    = (known after apply)</span><br><span class="line">      + resource_group_id = (known after apply)</span><br><span class="line">      + security_group    = (known after apply)</span><br><span class="line">      + service_version   = (known after apply)</span><br><span class="line">      + spec_type         = &quot;normal&quot;</span><br><span class="line">      + status            = (known after apply)</span><br><span class="line">      + topic_left        = (known after apply)</span><br><span class="line">      + topic_num_of_buy  = (known after apply)</span><br><span class="line">      + topic_quota       = (known after apply)</span><br><span class="line">      + topic_used        = (known after apply)</span><br><span class="line">      + vpc_id            = (known after apply)</span><br><span class="line">      + vswitch_id        = &quot;vsw-bp1co65f3q2s0bis9yfkg&quot;</span><br><span class="line">      + zone_id           = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 1 to add, 0 to change, 0 to destroy.</span><br><span class="line"></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"></span><br><span class="line">Note: You didn&#x27;t use the -out option to save this plan, so Terraform can&#x27;t guarantee to take exactly these actions if you run &quot;terraform apply&quot; now.</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œå˜æ›´ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">terraform apply</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span><br><span class="line">  + create</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">module.alikafka_instance.alicloud_alikafka_instance.this will be created</span></span><br><span class="line">  + resource &quot;alicloud_alikafka_instance&quot; &quot;this&quot; &#123;</span><br><span class="line">      + config            = (known after apply)</span><br><span class="line">      + deploy_type       = 5</span><br><span class="line">      + disk_size         = 500</span><br><span class="line">      + disk_type         = 1</span><br><span class="line">      + eip_max           = (known after apply)</span><br><span class="line">      + end_point         = (known after apply)</span><br><span class="line">      + group_left        = (known after apply)</span><br><span class="line">      + group_used        = (known after apply)</span><br><span class="line">      + id                = (known after apply)</span><br><span class="line">      + io_max            = 20</span><br><span class="line">      + io_max_spec       = (known after apply)</span><br><span class="line">      + is_partition_buy  = (known after apply)</span><br><span class="line">      + name              = &quot;alikafka-testV2&quot;</span><br><span class="line">      + paid_type         = &quot;PostPaid&quot;</span><br><span class="line">      + partition_left    = (known after apply)</span><br><span class="line">      + partition_num     = 50</span><br><span class="line">      + partition_used    = (known after apply)</span><br><span class="line">      + resource_group_id = (known after apply)</span><br><span class="line">      + security_group    = (known after apply)</span><br><span class="line">      + service_version   = (known after apply)</span><br><span class="line">      + spec_type         = &quot;normal&quot;</span><br><span class="line">      + status            = (known after apply)</span><br><span class="line">      + topic_left        = (known after apply)</span><br><span class="line">      + topic_num_of_buy  = (known after apply)</span><br><span class="line">      + topic_quota       = (known after apply)</span><br><span class="line">      + topic_used        = (known after apply)</span><br><span class="line">      + vpc_id            = (known after apply)</span><br><span class="line">      + vswitch_id        = &quot;vsw-bp1co65f3q2s0bis9yfkg&quot;</span><br><span class="line">      + zone_id           = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 1 to add, 0 to change, 0 to destroy.</span><br><span class="line"></span><br><span class="line">Do you want to perform these actions?</span><br><span class="line">  Terraform will perform the actions described above.</span><br><span class="line">  Only &#x27;yes&#x27; will be accepted to approve.</span><br><span class="line"></span><br><span class="line">  Enter a value: yes</span><br><span class="line"></span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Creating...</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [10s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [20s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [30s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [40s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [50s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [1m0s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [1m10s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [1m20s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [1m30s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [1m40s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [1m50s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [2m0s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [2m10s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [2m20s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [2m30s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [2m40s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [2m50s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [3m0s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [3m10s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [3m20s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [3m30s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [3m40s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [3m50s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [4m0s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [4m10s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [4m20s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [4m30s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [4m40s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Creation complete after 4m45s [id=alikafka_post-cn-0gx44g6dm006]</span><br><span class="line"></span><br><span class="line">Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</span><br></pre></td></tr></table></figure>

<h3 id="éªŒè¯åˆ›å»º"><a href="#éªŒè¯åˆ›å»º" class="headerlink" title="éªŒè¯åˆ›å»º"></a>éªŒè¯åˆ›å»º</h3><p>åœ¨å‰ç«¯æŸ¥çœ‹æ˜¯å¦æˆåŠŸåˆ›å»ºå®ä¾‹ï¼š<br><img src="/img.png" alt="img.png"></p>
<h3 id="é”€æ¯èµ„æº"><a href="#é”€æ¯èµ„æº" class="headerlink" title="é”€æ¯èµ„æº"></a>é”€æ¯èµ„æº</h3><p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿›è¡Œé”€æ¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">terraform destroy</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Refreshing state... [id=alikafka_post-cn-0gx44g6dm006]</span><br><span class="line"></span><br><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span><br><span class="line">  - destroy</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">module.alikafka_instance.alicloud_alikafka_instance.this will be destroyed</span></span><br><span class="line">  - resource &quot;alicloud_alikafka_instance&quot; &quot;this&quot; &#123;</span><br><span class="line">      - config            = jsonencode(</span><br><span class="line">            &#123;</span><br><span class="line">              - &quot;cloud.maxTieredStoreSpace&quot;           = &quot;0&quot;</span><br><span class="line">              - &quot;enable.acl&quot;                          = &quot;false&quot;</span><br><span class="line">              - &quot;enable.compact&quot;                      = &quot;true&quot;</span><br><span class="line">              - &quot;enable.tiered&quot;                       = &quot;false&quot;</span><br><span class="line">              - &quot;enable.vpc_sasl_ssl&quot;                 = &quot;false&quot;</span><br><span class="line">              - &quot;kafka.log.retention.hours&quot;           = &quot;72&quot;</span><br><span class="line">              - &quot;kafka.message.max.bytes&quot;             = &quot;1048576&quot;</span><br><span class="line">              - &quot;kafka.offsets.retention.minutes&quot;     = &quot;10080&quot;</span><br><span class="line">              - &quot;kafka.ssl.bit&quot;                       = &quot;1024&quot;</span><br><span class="line">              - &quot;message.timestamp.difference.max.ms&quot; = &quot;9223372036854775807&quot;</span><br><span class="line">              - &quot;message.timestamp.type&quot;              = &quot;CreateTime&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ) -&gt; null</span><br><span class="line">      - deploy_type       = 5 -&gt; null</span><br><span class="line">      - disk_size         = 500 -&gt; null</span><br><span class="line">      - disk_type         = 1 -&gt; null</span><br><span class="line">      - eip_max           = 0 -&gt; null</span><br><span class="line">      - end_point         = &quot;172.31.1.64:9092,172.31.1.66:9092,172.31.1.65:9092&quot; -&gt; null</span><br><span class="line">      - group_left        = 2100 -&gt; null</span><br><span class="line">      - group_used        = 0 -&gt; null</span><br><span class="line">      - id                = &quot;alikafka_post-cn-0gx44g6dm006&quot; -&gt; null</span><br><span class="line">      - io_max            = 20 -&gt; null</span><br><span class="line">      - io_max_spec       = &quot;alikafka.hw.2xlarge&quot; -&gt; null</span><br><span class="line">      - is_partition_buy  = 1 -&gt; null</span><br><span class="line">      - name              = &quot;alikafka-testV2&quot; -&gt; null</span><br><span class="line">      - paid_type         = &quot;PostPaid&quot; -&gt; null</span><br><span class="line">      - partition_left    = 1050 -&gt; null</span><br><span class="line">      - partition_num     = 50 -&gt; null</span><br><span class="line">      - partition_used    = 0 -&gt; null</span><br><span class="line">      - resource_group_id = &quot;rg-acfmzpn54i5ejry&quot; -&gt; null</span><br><span class="line">      - security_group    = &quot;sg-bp184o2lwjnssf12wf3w&quot; -&gt; null</span><br><span class="line">      - service_version   = &quot;2.2.0&quot; -&gt; null</span><br><span class="line">      - spec_type         = &quot;normal&quot; -&gt; null</span><br><span class="line">      - status            = 5 -&gt; null</span><br><span class="line">      - tags              = &#123;&#125; -&gt; null</span><br><span class="line">      - topic_left        = 1050 -&gt; null</span><br><span class="line">      - topic_num_of_buy  = 1050 -&gt; null</span><br><span class="line">      - topic_quota       = 1050 -&gt; null</span><br><span class="line">      - topic_used        = 0 -&gt; null</span><br><span class="line">      - vpc_id            = &quot;vpc-bp1sro6pb0sec14x7s05l&quot; -&gt; null</span><br><span class="line">      - vswitch_id        = &quot;vsw-bp1co65f3q2s0bis9yfkg&quot; -&gt; null</span><br><span class="line">      - zone_id           = &quot;zonei&quot; -&gt; null</span><br><span class="line">        # (1 unchanged attribute hidden)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 0 to add, 0 to change, 1 to destroy.</span><br><span class="line"></span><br><span class="line">Do you really want to destroy all resources?</span><br><span class="line">  Terraform will destroy all your managed infrastructure, as shown above.</span><br><span class="line">  There is no undo. Only &#x27;yes&#x27; will be accepted to confirm.</span><br><span class="line"></span><br><span class="line">  Enter a value: yes</span><br><span class="line"></span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Destroying... [id=alikafka_post-cn-0gx44g6dm006]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 10s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 20s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 30s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 40s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 50s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 1m1s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 1m11s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 1m21s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 1m31s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 1m41s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 1m51s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 2m1s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 2m11s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 2m21s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 2m31s elapsed]</span><br><span class="line">module.alikafka_instance.alicloud_alikafka_instance.this: Destruction complete after 2m37s</span><br><span class="line"></span><br><span class="line">Destroy complete! Resources: 1 destroyed.</span><br></pre></td></tr></table></figure>


]]></content>
  </entry>
  <entry>
    <title>Npdä»£ç ç»“æ„äº†è§£</title>
    <url>/2025/07/devops/npd/Npd%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84%E4%BA%86%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="1-pkgç›®å½•ç»“æ„"><a href="#1-pkgç›®å½•ç»“æ„" class="headerlink" title="1 pkgç›®å½•ç»“æ„"></a>1 pkgç›®å½•ç»“æ„</h1><p>è¿™é‡Œæ˜¯å„ä¸ªmonitorçš„å®ç°ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ custompluginmonitor             -&gt; ç”¨äºå®ç°è‡ªå®šä¹‰ç›‘è§†æ’ä»¶ã€‚node-problem-detector æ”¯æŒé€šè¿‡æ’ä»¶ç›‘è§†ç‰¹å®šçŠ¶æ€æˆ–äº‹ä»¶ï¼Œæ­¤ç›®å½•ä¸­åŒ…å«ä¸ç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶ç›¸å…³çš„ä»£ç ã€‚</span><br><span class="line">â”œâ”€â”€ exporters                       -&gt; ç”¨äºåŒ…å«å¯¼å‡ºå™¨ï¼ˆexportersï¼‰çš„å®ç°ï¼Œå¯¼å‡ºå™¨è´Ÿè´£å°†ç›‘è§†åˆ°çš„æ•°æ®å‘é€åˆ°å¤–éƒ¨ç³»ç»Ÿï¼Œæ¯”å¦‚ç›‘æ§ç³»ç»Ÿï¼ˆä¾‹å¦‚ Prometheusï¼‰ã€‚å¯¼å‡ºå™¨åœ¨æ•°æ®æ”¶é›†å’Œç›‘æ§é›†æˆä¸­èµ·åˆ°å…³é”®ä½œç”¨ã€‚</span><br><span class="line">â”œâ”€â”€ healthchecker                   -&gt; å®ç°å¥åº·æ£€æŸ¥é€»è¾‘ï¼Œç¡®ä¿ node-problem-detector æœ¬èº«å’Œå…¶ä»–ä¾èµ–çš„ç»„ä»¶å¤„äºå¥åº·çŠ¶æ€ã€‚è¿™æ˜¯ç›‘æ§å’Œç»´æŠ¤è½¯ä»¶ç¨³å®šæ€§çš„é‡è¦éƒ¨åˆ†ã€‚</span><br><span class="line">â”œâ”€â”€ logcounter                      -&gt; å®ç°äº† logcounter çš„åŠŸèƒ½ï¼Œé€šå¸¸ç”¨äºè®¡æ•°å’Œåˆ†æç³»ç»Ÿæ—¥å¿—ï¼Œä»¥æ£€æµ‹å¼‚å¸¸è¡Œä¸ºæˆ–é—®é¢˜ã€‚å®ƒå¯ä»¥ä¸ç³»ç»Ÿæ—¥å¿—ç›‘æ§ç»“åˆä½¿ç”¨ã€‚</span><br><span class="line">â”œâ”€â”€ problemdaemon                   -&gt; å®ç°é—®é¢˜å®ˆæŠ¤ç¨‹åºã€‚è¿™ä¸ªå®ˆæŠ¤ç¨‹åºè´Ÿè´£ç›‘æµ‹å’Œè¯†åˆ«èŠ‚ç‚¹ä¸­çš„é—®é¢˜ï¼Œé€šè¿‡é—®é¢˜å‘ç°æœºåˆ¶æ”¶é›†æŒ‡æ ‡å¹¶ç”Ÿæˆå‘Šè­¦ã€‚</span><br><span class="line">â”œâ”€â”€ problemdetector                 -&gt; åŒ…å«é—®é¢˜æ£€æµ‹çš„æ ¸å¿ƒé€»è¾‘ã€‚è¿™æ˜¯ node-problem-detector çš„ä¸»è¦åŠŸèƒ½éƒ¨åˆ†ï¼Œè´Ÿè´£ä»ä¸åŒçš„æ¥æºæ”¶é›†ä¿¡æ¯ï¼Œå¹¶æ ¹æ®è¿™äº›ä¿¡æ¯è¯†åˆ«å’ŒæŠ¥å‘ŠèŠ‚ç‚¹é—®é¢˜ã€‚</span><br><span class="line">â”œâ”€â”€ problemmetrics                  -&gt; åŒ…å«é—®é¢˜æŒ‡æ ‡çš„å®ç°ï¼Œç”¨äºæ”¶é›†ã€å¤„ç†å’Œå¯¼å‡ºæœ‰å…³èŠ‚ç‚¹çŠ¶æ€å’Œé—®é¢˜çš„æ•°æ®ã€‚è¿™äº›æŒ‡æ ‡å¯ä»¥å±•ç¤ºåœ¨ç›‘æ§ç•Œé¢ä¸Šï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£ç³»ç»Ÿçš„å¥åº·çŠ¶å†µã€‚</span><br><span class="line">â”œâ”€â”€ systemlogmonitor                -&gt; å®ç°äº†ç³»ç»Ÿæ—¥å¿—ç›‘æ§çš„åŠŸèƒ½ã€‚å®ƒå¤„ç†ç³»ç»Ÿæ—¥å¿—ï¼Œåˆ†ææ—¥å¿—å†…å®¹ï¼Œä»¥æ£€æµ‹å¯èƒ½å¯¼è‡´é—®é¢˜çš„äº‹ä»¶å’Œé”™è¯¯ã€‚</span><br><span class="line">â”œâ”€â”€ systemstatsmonitor              -&gt; ç”¨äºç›‘æ§ç³»ç»Ÿçš„å„ç§ç»Ÿè®¡æ•°æ®ï¼Œä¾‹å¦‚ CPU ä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨æƒ…å†µç­‰ã€‚å®ƒè´Ÿè´£æ”¶é›†å’ŒæŠ¥å‘Šè¿™äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œä»¥å¸®åŠ©éªŒè¯èŠ‚ç‚¹çš„å¥åº·çŠ¶æ€ã€‚</span><br><span class="line">â”œâ”€â”€ types                           -&gt; ç”¨äºå®šä¹‰é¡¹ç›®ä¸­ä½¿ç”¨çš„å„ç§ç±»å‹ç»“æ„ä½“å’Œå¸¸é‡ã€‚è¿™äº›ç±»å‹é€šå¸¸ç”¨äºæ•°æ®ä¼ è¾“å’Œå¤„ç†ï¼Œä¸ºæ ¸å¿ƒé€»è¾‘æä¾›æ•°æ®æ¨¡å‹ã€‚</span><br><span class="line">â”œâ”€â”€ util                            -&gt; åŒ…å«ä¸€äº›å…¬ç”¨å·¥å…·å‡½æ•°å’Œåº“ï¼Œè¿™äº›å‡½æ•°å¯ä»¥åœ¨å…¶ä»–æ¨¡å—ä¸­å¤ç”¨ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§ã€‚</span><br><span class="line">â””â”€â”€ version                         -&gt; ä¿å­˜ä¸ç‰ˆæœ¬ç›¸å…³çš„ä¿¡æ¯å’Œç»“æ„ã€‚å®ƒç”¨äºç®¡ç†ç‰ˆæœ¬å·å¹¶æä¾›ç‰ˆæœ¬ä¿¡æ¯çš„åŠŸèƒ½</span><br></pre></td></tr></table></figure>

<h1 id="2-problemdaemon"><a href="#2-problemdaemon" class="headerlink" title="2 problemdaemon"></a>2 problemdaemon</h1><h2 id="2-1-Register"><a href="#2-1-Register" class="headerlink" title="2.1 Register"></a>2.1 Register</h2><p>pkg&#x2F;problemdaemon&#x2F;problem_daemon.go:32</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">var (</span><br><span class="line">        handlers = make(map[types.ProblemDaemonType]types.ProblemDaemonHandler)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// Register registers a problem daemon factory method, which will be used to create the problem daemon.</span><br><span class="line">func Register(problemDaemonType types.ProblemDaemonType, handler types.ProblemDaemonHandler) &#123;</span><br><span class="line">        handlers[problemDaemonType] = handler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨å†Œä¸€ä¸ªé—®é¢˜å®ˆæŠ¤è¿›ç¨‹å·¥å‚æ–¹æ³•ã€‚<br>å‚æ•°ï¼š</p>
<ul>
<li>problemDaemonType: éœ€è¦æ³¨å†Œçš„å®ˆæŠ¤è¿›ç¨‹ç±»å‹ã€‚</li>
<li>handler: å¯¹åº”çš„å¤„ç†å™¨ï¼Œå…¶ä¸­åŒ…å«åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹çš„æ–¹æ³•ã€‚<br>ä½œç”¨ï¼šå°†æŒ‡å®šç±»å‹çš„å¤„ç†å™¨æ·»åŠ åˆ° handlers æ˜ å°„ä¸­ï¼Œä»¥ä¾¿åç»­æ ¹æ®ç±»å‹è·å–å¯¹åº”çš„å¤„ç†å™¨ã€‚</li>
</ul>
<h2 id="2-2-GetProblemDaemonNames"><a href="#2-2-GetProblemDaemonNames" class="headerlink" title="2.2 GetProblemDaemonNames"></a>2.2 GetProblemDaemonNames</h2><p>pkg&#x2F;problemdaemon&#x2F;problem_daemon.go:37</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// GetProblemDaemonNames retrieves all available problem daemon types.</span><br><span class="line">func GetProblemDaemonNames() []types.ProblemDaemonType &#123;</span><br><span class="line">        problemDaemonTypes := []types.ProblemDaemonType&#123;&#125;</span><br><span class="line">        for problemDaemonType := range handlers &#123;</span><br><span class="line">                problemDaemonTypes = append(problemDaemonTypes, problemDaemonType)</span><br><span class="line">        &#125;</span><br><span class="line">        return problemDaemonTypes</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ£€ç´¢æ‰€æœ‰å¯ç”¨çš„é—®é¢˜å®ˆæŠ¤è¿›ç¨‹ç±»å‹ã€‚</p>
<p>è¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰æ³¨å†Œçš„å®ˆæŠ¤è¿›ç¨‹ç±»å‹çš„åˆ‡ç‰‡ã€‚</p>
<p>å®ç°ç»†èŠ‚ï¼šéå† handlers æ˜ å°„ï¼Œå°†æ¯ç§é—®é¢˜å®ˆæŠ¤è¿›ç¨‹ç±»å‹æ·»åŠ åˆ°è¿”å›çš„åˆ‡ç‰‡ä¸­ã€‚</p>
<h2 id="2-3-GetProblemDaemonHandlerOrDie"><a href="#2-3-GetProblemDaemonHandlerOrDie" class="headerlink" title="2.3 GetProblemDaemonHandlerOrDie"></a>2.3 GetProblemDaemonHandlerOrDie</h2><p>pkg&#x2F;problemdaemon&#x2F;problem_daemon.go:46</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// GetProblemDaemonHandlerOrDie retrieves the ProblemDaemonHandler for a specific type of problem daemon, panic if error occurs..</span><br><span class="line">func GetProblemDaemonHandlerOrDie(problemDaemonType types.ProblemDaemonType) types.ProblemDaemonHandler &#123;</span><br><span class="line">        handler, ok := handlers[problemDaemonType]</span><br><span class="line">        if !ok &#123;</span><br><span class="line">                panic(fmt.Sprintf(&quot;Problem daemon handler for %v does not exist&quot;, problemDaemonType))</span><br><span class="line">        &#125;</span><br><span class="line">        return handler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·å–ç‰¹å®šç±»å‹é—®é¢˜å®ˆæŠ¤è¿›ç¨‹çš„å¤„ç†å™¨ã€‚</p>
<p>å‚æ•°ï¼šé—®é¢˜å®ˆæŠ¤è¿›ç¨‹ç±»å‹ã€‚</p>
<p>è¿”å›å€¼ï¼šè¿”å›å¯¹åº”çš„å¤„ç†å™¨ã€‚</p>
<p>å®ç°ç»†èŠ‚ï¼šå¦‚æœæŒ‡å®šç±»å‹æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å¤„ç†å™¨ï¼Œåˆ™è§¦å‘ææ…Œï¼ˆpanicï¼‰ï¼Œè¿™é€šå¸¸ç”¨äºåœ¨åˆå§‹åŒ–æ—¶ç¡®ä¿é…ç½®çš„æœ‰æ•ˆæ€§ã€‚</p>
<h2 id="2-4-NewProblemDaemons"><a href="#2-4-NewProblemDaemons" class="headerlink" title="2.4 NewProblemDaemons"></a>2.4 NewProblemDaemons</h2><p>pkg&#x2F;problemdaemon&#x2F;problem_daemon.go:55</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// NewProblemDaemons creates all problem daemons based on the configurations provided.</span><br><span class="line">func NewProblemDaemons(monitorConfigPaths types.ProblemDaemonConfigPathMap) []types.Monitor &#123;</span><br><span class="line">        problemDaemonMap := make(map[string]types.Monitor)</span><br><span class="line">        for problemDaemonType, configs := range monitorConfigPaths &#123;</span><br><span class="line">                for _, config := range *configs &#123;</span><br><span class="line">                        if _, ok := problemDaemonMap[config]; ok &#123;</span><br><span class="line">                                // Skip the config if it&#x27;s duplicated.</span><br><span class="line">                                klog.Warningf(&quot;Duplicated problem daemon configuration %q&quot;, config)</span><br><span class="line">                                continue</span><br><span class="line">                        &#125;</span><br><span class="line">                        problemDaemonMap[config] = handlers[problemDaemonType].CreateProblemDaemonOrDie(config)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        problemDaemons := []types.Monitor&#123;&#125;</span><br><span class="line">        for _, problemDaemon := range problemDaemonMap &#123;</span><br><span class="line">                problemDaemons = append(problemDaemons, problemDaemon)</span><br><span class="line">        &#125;</span><br><span class="line">        return problemDaemons</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®æä¾›çš„é…ç½®åˆ›å»ºæ‰€æœ‰é—®é¢˜å®ˆæŠ¤è¿›ç¨‹ã€‚</p>
<p>å‚æ•°ï¼š</p>
<p>monitorConfigPaths: åŒ…å«æ¯ç§é—®é¢˜å®ˆæŠ¤è¿›ç¨‹ç±»å‹åŠå…¶å¯¹åº”é…ç½®è·¯å¾„çš„æ˜ å°„ã€‚<br>è¿”å›å€¼ï¼šè¿”å›åˆ›å»ºçš„æ‰€æœ‰ Monitor å®ä¾‹çš„åˆ‡ç‰‡ã€‚<br>å®ç°ç»†èŠ‚</p>
<ul>
<li>åˆ›å»ºç©ºæ˜ å°„ï¼šä½¿ç”¨ problemDaemonMap å­˜å‚¨å·²åˆ›å»ºçš„å®ˆæŠ¤è¿›ç¨‹ï¼Œä»¥é¿å…é‡å¤ã€‚</li>
<li>éå†é…ç½®ï¼š<ul>
<li>å¯¹äºé…ç½®ä¸­çš„æ¯ç§é—®é¢˜å®ˆæŠ¤è¿›ç¨‹ç±»å‹åŠå…¶ç›¸åº”çš„é…ç½®è·¯å¾„ï¼Œæ£€æŸ¥æ˜¯å¦å·²ç»åˆ›å»ºã€‚</li>
<li>å¦‚æœé…ç½®å·²å­˜åœ¨ï¼Œåˆ™è®°å½•è­¦å‘Šå¹¶è·³è¿‡ã€‚</li>
<li>ä½¿ç”¨æ³¨å†Œçš„å¤„ç†å™¨åˆ›å»ºæ–°çš„é—®é¢˜å®ˆæŠ¤è¿›ç¨‹å¹¶å°†å…¶æ·»åŠ åˆ°æ˜ å°„ä¸­ã€‚</li>
</ul>
</li>
<li>è¿”å›å€¼æ„å»ºï¼šå°†åœ°å›¾ä¸­çš„æ‰€æœ‰å®ˆæŠ¤è¿›ç¨‹è½¬æ¢ä¸ºåˆ‡ç‰‡å¹¶è¿”å›ã€‚</li>
</ul>
<h1 id="3-problem-detector"><a href="#3-problem-detector" class="headerlink" title="3 problem_detector"></a>3 problem_detector</h1><h2 id="3-1-problemDetectorå®šä¹‰"><a href="#3-1-problemDetectorå®šä¹‰" class="headerlink" title="3.1 problemDetectorå®šä¹‰"></a>3.1 problemDetectorå®šä¹‰</h2><p>pkg&#x2F;problemdetector&#x2F;problem_detector.go:33</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// ProblemDetector collects statuses from all problem daemons and update the node condition and send node event.</span><br><span class="line">type ProblemDetector interface &#123;</span><br><span class="line">        Run(context.Context) error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type problemDetector struct &#123;</span><br><span class="line">        monitors  []types.Monitor</span><br><span class="line">        exporters []types.Exporter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­—æ®µï¼š</p>
<p>monitors: å­˜å‚¨ç›‘æ§å™¨çš„åˆ‡ç‰‡ï¼Œç”¨äºæ”¶é›†é—®é¢˜çŠ¶æ€ã€‚</p>
<p>exporters: å­˜å‚¨å¯¼å‡ºå™¨çš„åˆ‡ç‰‡ï¼Œç”¨äºå°†æ”¶é›†åˆ°çš„çŠ¶æ€å‘é€åˆ°å¤–éƒ¨ç³»ç»Ÿæˆ–ç”¨æˆ·ã€‚</p>
<p>æ–¹æ³•è¯´æ˜ï¼š Run(context.Context) error å¯åŠ¨é—®é¢˜æ£€æµ‹å™¨ï¼Œå¹¶åœ¨ä¸Šä¸‹æ–‡è¢«å–æ¶ˆæˆ–å‡ºç°é”™è¯¯æ—¶è¿”å›é”™è¯¯ã€‚</p>
<h2 id="3-2-NewProblemDetector"><a href="#3-2-NewProblemDetector" class="headerlink" title="3.2 NewProblemDetector"></a>3.2 NewProblemDetector</h2><p>pkg&#x2F;problemdetector&#x2F;problem_detector.go:40</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// NewProblemDetector creates the problem detector. Currently we just directly passed in the problem daemons, but</span><br><span class="line">// in the future we may want to let the problem daemons register themselves.</span><br><span class="line">func NewProblemDetector(monitors []types.Monitor, exporters []types.Exporter) ProblemDetector &#123;</span><br><span class="line">        return &amp;problemDetector&#123;</span><br><span class="line">                monitors:  monitors,</span><br><span class="line">                exporters: exporters,</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºä¸€ä¸ªæ–°çš„é—®é¢˜æ£€æµ‹å™¨å®ä¾‹ã€‚</p>
<p>å‚æ•°ï¼š</p>
<p>monitors: ç›‘æ§å™¨æ•°ç»„ï¼Œç”¨äºæ£€æµ‹ä¸åŒé—®é¢˜ã€‚</p>
<p>exporters: å¯¼å‡ºå™¨æ•°ç»„ï¼Œç”¨äºå°†çŠ¶æ€å‘é€ç»™å¤–éƒ¨ç³»ç»Ÿã€‚</p>
<p>è¿”å›å€¼ï¼šè¿”å›å®ç° ProblemDetector æ¥å£çš„æ–°çš„ problemDetector å®ä¾‹ã€‚</p>
<h2 id="3-3-Run"><a href="#3-3-Run" class="headerlink" title="3.3 Run"></a>3.3 Run</h2><p>pkg&#x2F;problemdetector&#x2F;problem_detector.go:48</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// Run starts the problem detector.</span><br><span class="line">func (p *problemDetector) Run(ctx context.Context) error &#123;</span><br><span class="line">        // Start the log monitors one by one.</span><br><span class="line">        var chans []&lt;-chan *types.Status</span><br><span class="line">        failureCount := 0</span><br><span class="line">        for _, m := range p.monitors &#123;</span><br><span class="line">                ch, err := m.Start()</span><br><span class="line">                if err != nil &#123;</span><br><span class="line">                        // Do not return error and keep on trying the following config files.</span><br><span class="line">                        klog.Errorf(&quot;Failed to start problem daemon %v: %v&quot;, m, err)</span><br><span class="line">                        failureCount++</span><br><span class="line">                        continue</span><br><span class="line">                &#125;</span><br><span class="line">                if ch != nil &#123;</span><br><span class="line">                        chans = append(chans, ch)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        allMonitors := p.monitors</span><br><span class="line"></span><br><span class="line">        if len(allMonitors) == failureCount &#123;</span><br><span class="line">                return fmt.Errorf(&quot;no problem daemon is successfully setup&quot;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        defer func() &#123;</span><br><span class="line">                for _, m := range allMonitors &#123;</span><br><span class="line">                        m.Stop()</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;()</span><br><span class="line"></span><br><span class="line">        ch := groupChannel(chans)</span><br><span class="line">        klog.Info(&quot;Problem detector started&quot;)</span><br><span class="line"></span><br><span class="line">        for &#123;</span><br><span class="line">                select &#123;</span><br><span class="line">                case &lt;-ctx.Done():</span><br><span class="line">                        return nil</span><br><span class="line">                case status := &lt;-ch:</span><br><span class="line">                        for _, exporter := range p.exporters &#123;</span><br><span class="line">                                exporter.ExportProblems(status)</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œé—®é¢˜æ£€æµ‹å™¨çš„ä¸»è¦è¿è¡Œé€»è¾‘ã€‚</p>
<p>å®ç°ç»†èŠ‚ï¼š</p>
<ul>
<li>å¼€å§‹ç›‘æ§å™¨ï¼šéå†å¹¶å¯åŠ¨æ¯ä¸ªç›‘æ§å™¨ã€‚</li>
<li>å¦‚æœå¯åŠ¨å¤±è´¥ï¼Œè®°å½•é”™è¯¯å¹¶å¢åŠ å¤±è´¥è®¡æ•°ã€‚</li>
<li>å¦‚æœæˆåŠŸï¼Œåˆ™å°†è¿”å›çš„é€šé“æ·»åŠ åˆ° chans åˆ‡ç‰‡ã€‚</li>
<li>æ£€æŸ¥å¤±è´¥æƒ…å†µï¼šå¦‚æœæ‰€æœ‰ç›‘æ§å™¨éƒ½å¤±è´¥ï¼Œåˆ™è¿”å›é”™è¯¯ã€‚</li>
<li>å»¶è¿Ÿå…³é—­ï¼šåœ¨å‡½æ•°ç»“æŸæ—¶åœæ­¢æ‰€æœ‰ç›‘æ§å™¨ã€‚</li>
<li>é€šé“ç»„åˆï¼šè°ƒç”¨ groupChannel å‡½æ•°ï¼Œç”¨äºå°†æ‰€æœ‰ç›‘æ§å™¨çš„çŠ¶æ€é€šé“ç»„åˆæˆå•ä¸€é€šé“ã€‚</li>
<li>ç›‘å¬çŠ¶æ€ï¼šä½¿ç”¨ select ä¸æ–­ç›‘å¬ä¸Šä¸‹æ–‡å’Œç›‘æ§å™¨çš„çŠ¶æ€ã€‚</li>
<li>å¦‚æœæ”¶åˆ°çŠ¶æ€ï¼Œä»æ‰€æœ‰å¯¼å‡ºå™¨å¯¼å‡ºé—®é¢˜ã€‚</li>
</ul>
<h2 id="3-4-groupChannel"><a href="#3-4-groupChannel" class="headerlink" title="3.4 groupChannel"></a>3.4 groupChannel</h2><p>pkg&#x2F;problemdetector&#x2F;problem_detector.go:91</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">func groupChannel(chans []&lt;-chan *types.Status) &lt;-chan *types.Status &#123;</span><br><span class="line">        statuses := make(chan *types.Status)</span><br><span class="line">        for _, ch := range chans &#123;</span><br><span class="line">                go func(c &lt;-chan *types.Status) &#123;</span><br><span class="line">                        for status := range c &#123;</span><br><span class="line">                                statuses &lt;- status</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;(ch)</span><br><span class="line">        &#125;</span><br><span class="line">        return statuses</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°†å¤šä¸ªçŠ¶æ€é€šé“ç»„åˆä¸ºä¸€ä¸ªé€šé“ã€‚</p>
<p>å‚æ•°ï¼šåˆ‡ç‰‡ chansï¼ŒåŒ…å«å¤šä¸ªçŠ¶æ€é€šé“ã€‚</p>
<p>è¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ªæ–°çš„é€šé“ statusesï¼Œç”¨äºæ¥æ”¶æ¥è‡ªæ‰€æœ‰ç›‘æ§å™¨çš„çŠ¶æ€ã€‚</p>
<p>å®ç°ç»†èŠ‚</p>
<p>å¯åŠ¨å¤šä¸ª goroutineï¼Œæ¯ä¸ª goroutine ä»ä¸€ä¸ªç›‘æ§å™¨çš„é€šé“è¯»å–çŠ¶æ€ï¼Œå¹¶å°†å…¶è½¬å‘åˆ°æ–°çš„ statuses é€šé“ä¸­ã€‚</p>
<h1 id="4-problemmetrics"><a href="#4-problemmetrics" class="headerlink" title="4 problemmetrics"></a>4 problemmetrics</h1><h2 id="4-1-ProblemMetricsManagerå®šä¹‰"><a href="#4-1-ProblemMetricsManagerå®šä¹‰" class="headerlink" title="4.1 ProblemMetricsManagerå®šä¹‰"></a>4.1 ProblemMetricsManagerå®šä¹‰</h2><p>pkg&#x2F;problemmetrics&#x2F;problem_metrics.go:40</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// ProblemMetricsManager manages problem-converted metrics.</span><br><span class="line">// ProblemMetricsManager is thread-safe.</span><br><span class="line">type ProblemMetricsManager struct &#123;</span><br><span class="line">        problemCounter           metrics.Int64MetricInterface</span><br><span class="line">        problemGauge             metrics.Int64MetricInterface</span><br><span class="line">        problemTypeToReason      map[string]string</span><br><span class="line">        problemTypeToReasonMutex sync.Mutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­—æ®µï¼š</p>
<ul>
<li>problemCounter: ä¸€ä¸ªæ•´å‹æŒ‡æ ‡æ¥å£ï¼Œç”¨äºè®¡æ•°ç‰¹å®šé—®é¢˜å‘ç”Ÿçš„æ¬¡æ•°ã€‚</li>
<li>problemGauge: ä¸€ä¸ªæ•´å‹æŒ‡æ ‡æ¥å£ï¼Œç”¨äºè¡¨ç¤ºç‰¹å®šé—®é¢˜æ˜¯å¦å¯¹èŠ‚ç‚¹äº§ç”Ÿå½±å“ã€‚</li>
<li>problemTypeToReason: ä¸€ä¸ªæ˜ å°„ï¼Œä¿å­˜é—®é¢˜ç±»å‹ä¸åŸå› çš„å…³ç³»ã€‚</li>
<li>problemTypeToReasonMutex: ä¸€ä¸ªäº’æ–¥é”ï¼Œç”¨äºä¿æŠ¤ problemTypeToReason çš„å¹¶å‘è®¿é—®ã€‚</li>
</ul>
<h2 id="4-2-init"><a href="#4-2-init" class="headerlink" title="4.2 init"></a>4.2 init</h2><p>pkg&#x2F;problemmetrics&#x2F;problem_metrics.go:31</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// GlobalProblemMetricsManager is a singleton of ProblemMetricsManager,</span><br><span class="line">// which should be used to manage all problem-converted metrics across all</span><br><span class="line">// problem daemons.</span><br><span class="line">var GlobalProblemMetricsManager *ProblemMetricsManager</span><br><span class="line"></span><br><span class="line">func init() &#123;</span><br><span class="line">        GlobalProblemMetricsManager = NewProblemMetricsManagerOrDie()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GlobalProblemMetricsManager: å…¨å±€å”¯ä¸€çš„ ProblemMetricsManager å®ä¾‹ï¼Œç”¨äºç®¡ç†æ‰€æœ‰é—®é¢˜ç›¸å…³çš„æŒ‡æ ‡ã€‚</p>
<p>init å‡½æ•°: åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆå§‹åŒ– GlobalProblemMetricsManagerï¼Œç¡®ä¿å…¶å¯ç”¨ã€‚</p>
<h2 id="4-3-NewProblemMetricsManagerOrDie"><a href="#4-3-NewProblemMetricsManagerOrDie" class="headerlink" title="4.3 NewProblemMetricsManagerOrDie"></a>4.3 NewProblemMetricsManagerOrDie</h2><p>pkg&#x2F;problemmetrics&#x2F;problem_metrics.go:47</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">func NewProblemMetricsManagerOrDie() *ProblemMetricsManager &#123;</span><br><span class="line">        pmm := ProblemMetricsManager&#123;&#125;</span><br><span class="line"></span><br><span class="line">        var err error</span><br><span class="line">        pmm.problemCounter, err = metrics.NewInt64Metric(</span><br><span class="line">                metrics.ProblemCounterID,</span><br><span class="line">                string(metrics.ProblemCounterID),</span><br><span class="line">                &quot;Number of times a specific type of problem have occurred.&quot;,</span><br><span class="line">                &quot;1&quot;,</span><br><span class="line">                metrics.Sum,</span><br><span class="line">                []string&#123;&quot;reason&quot;&#125;)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">                klog.Fatalf(&quot;Failed to create problem_counter metric: %v&quot;, err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pmm.problemGauge, err = metrics.NewInt64Metric(</span><br><span class="line">                metrics.ProblemGaugeID,</span><br><span class="line">                string(metrics.ProblemGaugeID),</span><br><span class="line">                &quot;Whether a specific type of problem is affecting the node or not.&quot;,</span><br><span class="line">                &quot;1&quot;,</span><br><span class="line">                metrics.LastValue,</span><br><span class="line">                []string&#123;&quot;type&quot;, &quot;reason&quot;&#125;)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">                klog.Fatalf(&quot;Failed to create problem_gauge metric: %v&quot;, err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pmm.problemTypeToReason = make(map[string]string)</span><br><span class="line"></span><br><span class="line">        return &amp;pmm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºå¹¶åˆå§‹åŒ– ProblemMetricsManager å®ä¾‹ã€‚</p>
<p>å®ç°ç»†èŠ‚ï¼š</p>
<p>åˆ›å»º problemCounter æŒ‡æ ‡ï¼Œç”¨äºè®°å½•ç‰¹å®šé—®é¢˜çš„å‘ç”Ÿæ¬¡æ•°ï¼Œæ¥æ”¶æ ‡ç­¾ reasonã€‚</p>
<p>åˆ›å»º problemGauge æŒ‡æ ‡ï¼Œç”¨äºæŒ‡ç¤ºç‰¹å®šé—®é¢˜æ˜¯å¦æ­£åœ¨å½±å“èŠ‚ç‚¹ï¼Œæ¥æ”¶æ ‡ç­¾ type å’Œ reasonã€‚</p>
<p>å¦‚æœåˆ›å»ºæŒ‡æ ‡å¤±è´¥ï¼Œåˆ™ç¨‹åºä¼šå´©æºƒï¼ˆFatalfï¼‰ã€‚</p>
<p>åˆå§‹åŒ–é—®é¢˜ç±»å‹åˆ°åŸå› çš„æ˜ å°„ã€‚</p>
<h2 id="4-4-IncrementProblemCounter"><a href="#4-4-IncrementProblemCounter" class="headerlink" title="4.4 IncrementProblemCounter"></a>4.4 IncrementProblemCounter</h2><p>pkg&#x2F;problemmetrics&#x2F;problem_metrics.go:79</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// IncrementProblemCounter increments the value of a problem counter.</span><br><span class="line">func (pmm *ProblemMetricsManager) IncrementProblemCounter(reason string, count int64) error &#123;</span><br><span class="line">        if pmm.problemCounter == nil &#123;</span><br><span class="line">                return errors.New(&quot;problem counter is being incremented before initialized.&quot;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return pmm.problemCounter.Record(map[string]string&#123;&quot;reason&quot;: reason&#125;, count)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¢åŠ é—®é¢˜è®¡æ•°å™¨çš„å€¼ï¼Œæ ¹æ® reason æ ‡ç­¾è®°å½•ç»Ÿè®¡æ•°æ®ã€‚</p>
<p>å‚æ•°ï¼š</p>
<p>reason: é—®é¢˜å‘ç”Ÿçš„åŸå› ã€‚</p>
<p>count: è¦å¢åŠ çš„æ•°é‡ã€‚</p>
<p>è¿”å›å€¼ï¼šè¿”å›å¯èƒ½çš„é”™è¯¯ã€‚</p>
<h2 id="4-5-SetProblemGauge"><a href="#4-5-SetProblemGauge" class="headerlink" title="4.5 SetProblemGauge"></a>4.5 SetProblemGauge</h2><p>pkg&#x2F;problemmetrics&#x2F;problem_metrics.go:88</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// SetProblemGauge sets the value of a problem gauge.</span><br><span class="line">func (pmm *ProblemMetricsManager) SetProblemGauge(problemType string, reason string, value bool) error &#123;</span><br><span class="line">        if pmm.problemGauge == nil &#123;</span><br><span class="line">                return errors.New(&quot;problem gauge is being set before initialized.&quot;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pmm.problemTypeToReasonMutex.Lock()</span><br><span class="line">        defer pmm.problemTypeToReasonMutex.Unlock()</span><br><span class="line"></span><br><span class="line">        // We clear the last reason, because the expected behavior is that at any point of time,</span><br><span class="line">        // for each type of permanent problem, there should be at most one reason got set to 1.</span><br><span class="line">        // This behavior is consistent with the behavior of node condition in Kubernetes.</span><br><span class="line">        // However, problemGauges with different &quot;type&quot; and &quot;reason&quot; are considered as different</span><br><span class="line">        // metrics in Prometheus. So we need to clear the previous metrics explicitly.</span><br><span class="line">        if lastReason, ok := pmm.problemTypeToReason[problemType]; ok &#123;</span><br><span class="line">                err := pmm.problemGauge.Record(map[string]string&#123;&quot;type&quot;: problemType, &quot;reason&quot;: lastReason&#125;, 0)</span><br><span class="line">                if err != nil &#123;</span><br><span class="line">                        return fmt.Errorf(&quot;failed to clear previous reason %q for type %q: %v&quot;,</span><br><span class="line">                                problemType, lastReason, err)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pmm.problemTypeToReason[problemType] = reason</span><br><span class="line"></span><br><span class="line">        var valueInt int64</span><br><span class="line">        if value &#123;</span><br><span class="line">                valueInt = 1</span><br><span class="line">        &#125;</span><br><span class="line">        return pmm.problemGauge.Record(map[string]string&#123;&quot;type&quot;: problemType, &quot;reason&quot;: reason&#125;, valueInt)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®é—®é¢˜é‡è§„çš„å€¼ï¼ŒæŒ‡ç¤ºç‰¹å®šé—®é¢˜å¯¹èŠ‚ç‚¹çš„å½±å“ã€‚</p>
<p>å‚æ•°ï¼š</p>
<ul>
<li>problemType: é—®é¢˜ç±»å‹ï¼ˆä¾‹å¦‚ï¼ŒèŠ‚ç‚¹ä¸å¯ç”¨ï¼‰ã€‚</li>
<li>reason: å…·ä½“åŸå› ã€‚</li>
<li>value: è¡¨ç¤ºé—®é¢˜çš„çŠ¶æ€ï¼Œtrueè¡¨ç¤ºé—®é¢˜å­˜åœ¨ (1)ï¼Œfalseè¡¨ç¤ºé—®é¢˜æ¶ˆå¤± (0)ã€‚</li>
</ul>
<p>å®ç°ç»†èŠ‚ï¼š</p>
<ul>
<li>ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤å¯¹ problemTypeToReason çš„å¹¶å‘è®¿é—®ã€‚</li>
<li>æ¸…é™¤ä¹‹å‰çš„åŸå› ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œä¿è¯æ¯ä¸ªé—®é¢˜ç±»å‹åœ¨ä»»ä½•æ—¶åˆ»éƒ½æœ€å¤šåªæœ‰ä¸€ä¸ªåŸå› è¢«è®¾ç½®ä¸º 1ã€‚</li>
<li>è®°å½•æ–°çš„é‡è§„å€¼ã€‚</li>
</ul>
<h1 id="5-exporters"><a href="#5-exporters" class="headerlink" title="5 exporters"></a>5 exporters</h1><p>ç›®å½•ç»“æ„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ k8sexporter</span><br><span class="line">â”‚   â”œâ”€â”€ condition</span><br><span class="line">â”‚   â”œâ”€â”€ k8s_exporter.go</span><br><span class="line">â”‚   â””â”€â”€ problemclient</span><br><span class="line">â”œâ”€â”€ prometheusexporter</span><br><span class="line">â”‚   â””â”€â”€ prometheus_exporter.go</span><br><span class="line">â”œâ”€â”€ register.go</span><br><span class="line">â”œâ”€â”€ register_test.go</span><br><span class="line">â””â”€â”€ stackdriver</span><br><span class="line">    â”œâ”€â”€ config</span><br><span class="line">    â”œâ”€â”€ gce</span><br><span class="line">    â”œâ”€â”€ stackdriver_exporter.go</span><br><span class="line">    â””â”€â”€ stackdriver_exporter_test.go</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå°±æ¶‰åŠåˆ°äº†ä¸‰ä¸ªexporterï¼Œåˆ†åˆ«æ˜¯k8sexporterã€prometheusexporterã€stackdriver_exporter</p>
<p>è¿™ä¸‰ä¸ªæ˜¯æ¯”è¾ƒç‹¬ç«‹çš„ï¼Œå› ä¸ºèƒ½åŠ›æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ï¼Œ</p>
<ul>
<li>exporterï¼šä¸“æ³¨äºå°†types.Statusçš„eventå’Œconditationä¸ŠæŠ¥ï¼Œå¹¶ä¸”ä¼šæœ‰ä¸€äº›httpæœåŠ¡æ¥å£å¼€æ”¾(healthzã€conditionsã€&#x2F;debug&#x2F;pprof)ï¼Œ</li>
<li>prometheusexporterï¼šç›´æ¥ç”¨çš„prometheuseçš„åº“ï¼Œç®€å•ç†è§£å°±æ˜¯ä¸ºäº†è®©prometheuseå¯ä»¥é‡‡é›†åˆ°æ•°æ®</li>
<li>stackdriver_exporterï¼šå¤„ç†ä¸ Google Stackdriver çš„é›†æˆï¼ŒStackdriver æ˜¯ Google Cloud æä¾›çš„ç›‘æ§å’Œç®¡ç†å¹³å°ï¼Œè¯¥exporterè´Ÿè´£å°†æŒ‡æ ‡æ•°æ®å‘é€åˆ°<br>Stackdriverï¼Œä»¥ä¾¿åœ¨ Google Cloud ç¯å¢ƒä¸­ç›‘æ§åº”ç”¨ç¨‹åºå’Œé›†ç¾¤çŠ¶æ€ã€‚</li>
</ul>
<p>è¿™é‡Œæ¥è¯´è¯´æˆ‘çš„ç†è§£å§ï¼Œprometheusexporterå’Œstackdriver_exporterè¿™ä¸¤ä¸ªexporteræ˜¯ä¸ºäº†å°†metricæ•°æ®å‘é€åˆ°å¯¹åº”çš„ç›‘æ§å¹³å°ï¼Œè€Œk8sexporteråˆ™æ˜¯ä¸ºäº†å°†types.Statuså‘é€åˆ°k8sï¼Œç›®å‰å·²ç»å¼€å§‹å‘registerç»§æ‰¿æ–¹å‘å»¶å±•ï¼Œå¦‚stackdriver_exporterå·²ç»ä½¿ç”¨è¯¥æ¨¡å¼å¹¶ä¸”å·²ç»ç»Ÿä¸€äº†structçš„å®ç°æ–¹æ³•ï¼Œä½†æ˜¯prometheusexporterå’Œk8sexporterè¿˜æ²¡å®Œæˆæ¼”å˜ï¼Œç›®å‰è¿˜æ˜¯é€šè¿‡packageç›´æ¥è°ƒç”¨çš„æ–¹å¼ä½¿ç”¨çš„ã€‚</p>
<p>è¿™ä¸ªæ¨¡å—å°±ä¸è¿›è¡Œä»£ç çº§åˆ«è§£æäº†ï¼Œæ•´ä½“æ˜¯éå¸¸ç®€å•çš„ã€‚</p>
<h1 id="6-healthchecker"><a href="#6-healthchecker" class="headerlink" title="6 healthchecker"></a>6 healthchecker</h1><p>ç›®å½•ç»“æ„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ health_checker.go</span><br><span class="line">â”œâ”€â”€ health_checker_darwin.go</span><br><span class="line">â”œâ”€â”€ health_checker_linux.go</span><br><span class="line">â”œâ”€â”€ health_checker_test.go</span><br><span class="line">â”œâ”€â”€ health_checker_windows.go</span><br><span class="line">â””â”€â”€ types</span><br><span class="line">â”œâ”€â”€ types.go</span><br><span class="line">â”œâ”€â”€ types_test.go</span><br><span class="line">â”œâ”€â”€ types_unix.go</span><br><span class="line">â””â”€â”€ types_windows.go</span><br></pre></td></tr></table></figure>

<p>6.1 healthCheckerå®šä¹‰<br>pkg&#x2F;healthchecker&#x2F;health_checker.go:31</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">type healthChecker struct &#123;</span><br><span class="line">  component       string</span><br><span class="line">  service         string</span><br><span class="line">  enableRepair    bool</span><br><span class="line">  healthCheckFunc func () (bool, error)</span><br><span class="line">  // The repair is &quot;best-effort&quot; and ignores the error from the underlying actions.</span><br><span class="line">  // The bash commands to kill the process will fail if the service is down and hence ignore.</span><br><span class="line">  repairFunc         func ()</span><br><span class="line">  uptimeFunc         func () (time.Duration, error)</span><br><span class="line">  crictlPath         string</span><br><span class="line">  healthCheckTimeout time.Duration</span><br><span class="line">  coolDownTime       time.Duration</span><br><span class="line">  loopBackTime       time.Duration</span><br><span class="line">  logPatternsToCheck map[string]int</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­—æ®µå«ä¹‰ï¼š</p>
<ul>
<li>componentï¼šè¢«æ£€æŸ¥çš„ Kubernetes ç»„ä»¶åç§°ï¼ˆå¦‚ Kubeletã€Kube Proxy ç­‰ï¼‰ã€‚</li>
<li>serviceï¼šæœåŠ¡åç§°æˆ–æ ‡è¯†ç¬¦ã€‚</li>
<li>enableRepairï¼šå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºæ˜¯å¦åœ¨å‘ç°æœåŠ¡ä¸å¥åº·æ—¶å°è¯•ä¿®å¤å®ƒã€‚</li>
<li>healthCheckFuncï¼šä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºæ‰§è¡Œå¥åº·æ£€æŸ¥ï¼Œè¿”å›å¥åº·çŠ¶æ€å’Œå¯èƒ½çš„é”™è¯¯ã€‚</li>
<li>repairFuncï¼šä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºå°è¯•ä¿®å¤ä¸å¥åº·çš„æœåŠ¡ã€‚</li>
<li>uptimeFuncï¼šä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºè·å–æœåŠ¡çš„è¿è¡Œæ—¶é—´ã€‚</li>
<li>crictlPathï¼šæŒ‡å‘ CRI å·¥å…·çš„è·¯å¾„ã€‚</li>
<li>healthCheckTimeoutï¼šå¥åº·æ£€æŸ¥çš„è¶…æ—¶è®¾ç½®ã€‚</li>
<li>coolDownTimeï¼šåœ¨å°è¯•ä¿®å¤ä¹‹å‰è¦æ±‚æœåŠ¡å¿…é¡»æ­£å¸¸è¿è¡Œçš„æ—¶é—´ã€‚</li>
<li>loopBackTimeï¼šç”¨äºå›æº¯æ£€æŸ¥æ—¥å¿—çš„æ—¶é—´æ®µã€‚</li>
<li>logPatternsToCheckï¼šä¸€ä¸ªæ˜ å°„ï¼ŒåŒ…å«è¦æ£€æŸ¥çš„æ—¥å¿—æ¨¡å¼åŠå…¶å‡ºç°æ¬¡æ•°é˜ˆå€¼ã€‚</li>
</ul>
<h2 id="6-2-NewHealthChecker"><a href="#6-2-NewHealthChecker" class="headerlink" title="6.2 NewHealthChecker"></a>6.2 NewHealthChecker</h2><p>pkg&#x2F;healthchecker&#x2F;health_checker.go:48</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// NewHealthChecker returns a new health checker configured with the given options.</span><br><span class="line">func NewHealthChecker(hco *options.HealthCheckerOptions) (types.HealthChecker, error) &#123;</span><br><span class="line">  hc := &amp;healthChecker&#123;</span><br><span class="line">    component:          hco.Component,</span><br><span class="line">    enableRepair:       hco.EnableRepair,</span><br><span class="line">    crictlPath:         hco.CriCtlPath,</span><br><span class="line">    healthCheckTimeout: hco.HealthCheckTimeout,</span><br><span class="line">    coolDownTime:       hco.CoolDownTime,</span><br><span class="line">    service:            hco.Service,</span><br><span class="line">    loopBackTime:       hco.LoopBackTime,</span><br><span class="line">    logPatternsToCheck: hco.LogPatterns.GetLogPatternCountMap(),</span><br><span class="line">  &#125;</span><br><span class="line">  hc.healthCheckFunc = getHealthCheckFunc(hco)</span><br><span class="line">  hc.repairFunc = getRepairFunc(hco)</span><br><span class="line">  hc.uptimeFunc = getUptimeFunc(hco.Service)</span><br><span class="line">  return hc, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NewHealthCheckerä¼šæ ¹æ®è¾“å…¥çš„options.HealthCheckerOptionsæ¥è¿›è¡Œtypes.HealthCheckerçš„æ„é€ ã€‚</p>
<h2 id="6-3-CheckHealth"><a href="#6-3-CheckHealth" class="headerlink" title="6.3 CheckHealth"></a>6.3 CheckHealth</h2><p>pkg&#x2F;healthchecker&#x2F;health_checker.go:67</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// CheckHealth checks for the health of the component and tries to repair if enabled.</span><br><span class="line">// Returns true if healthy, false otherwise.</span><br><span class="line">func (hc *healthChecker) CheckHealth() (bool, error) &#123;</span><br><span class="line">        healthy, err := hc.healthCheckFunc()</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">                return healthy, err</span><br><span class="line">        &#125;</span><br><span class="line">        logPatternHealthy, err := logPatternHealthCheck(hc.service, hc.loopBackTime, hc.logPatternsToCheck)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">                return logPatternHealthy, err</span><br><span class="line">        &#125;</span><br><span class="line">        if healthy &amp;&amp; logPatternHealthy &#123;</span><br><span class="line">                return true, nil</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // The service is unhealthy.</span><br><span class="line">        // Attempt repair based on flag.</span><br><span class="line">        if hc.enableRepair &#123;</span><br><span class="line">                // repair if the service has been up for the cool down period.</span><br><span class="line">                uptime, err := hc.uptimeFunc()</span><br><span class="line">                if err != nil &#123;</span><br><span class="line">                        klog.Infof(&quot;error in getting uptime for %v: %v\n&quot;, hc.component, err)</span><br><span class="line">                        return false, nil</span><br><span class="line">                &#125;</span><br><span class="line">                klog.Infof(&quot;%v is unhealthy, component uptime: %v\n&quot;, hc.component, uptime)</span><br><span class="line">                if uptime &gt; hc.coolDownTime &#123;</span><br><span class="line">                        klog.Infof(&quot;%v cooldown period of %v exceeded, repairing&quot;, hc.component, hc.coolDownTime)</span><br><span class="line">                        hc.repairFunc()</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ£€æŸ¥ç»„ä»¶çš„å¥åº·çŠ¶æ€ï¼Œè¿”å›æ˜¯å¦å¥åº·ï¼Œå¹¶åœ¨ä¸å¥åº·çš„æƒ…å†µä¸‹å°è¯•ä¿®å¤ã€‚</p>
<p>é€»è¾‘ï¼š</p>
<ul>
<li>è°ƒç”¨ healthCheckFunc æ‰§è¡Œå¥åº·æ£€æŸ¥ã€‚</li>
<li>ä½¿ç”¨ logPatternHealthCheck æ£€æŸ¥æ—¥å¿—æ¨¡å¼ã€‚</li>
<li>å¦‚æœç»„ä»¶ä¸å¥åº·ä¸”å¯ç”¨äº†ä¿®å¤ï¼Œæ£€æŸ¥ç»„ä»¶çš„è¿è¡Œæ—¶é—´å¹¶è°ƒç”¨ä¿®å¤å‡½æ•°ã€‚</li>
</ul>
<h2 id="6-4-logPatternHealthCheck"><a href="#6-4-logPatternHealthCheck" class="headerlink" title="6.4 logPatternHealthCheck"></a>6.4 logPatternHealthCheck</h2><p>pkg&#x2F;healthchecker&#x2F;health_checker.go:100</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// logPatternHealthCheck checks for the provided logPattern occurrences in the service logs.</span><br><span class="line">// Returns true if the pattern is empty or does not exist logThresholdCount times since start of service, false otherwise.</span><br><span class="line">func logPatternHealthCheck(service string, loopBackTime time.Duration, logPatternsToCheck map[string]int) (bool, error) &#123;</span><br><span class="line">        if len(logPatternsToCheck) == 0 &#123;</span><br><span class="line">                return true, nil</span><br><span class="line">        &#125;</span><br><span class="line">        uptimeFunc := getUptimeFunc(service)</span><br><span class="line">        klog.Infof(&quot;Getting uptime for service: %v\n&quot;, service)</span><br><span class="line">        uptime, err := uptimeFunc()</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">                klog.Warningf(&quot;Failed to get the uptime: %+v&quot;, err)</span><br><span class="line">                return true, err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logStartTime := time.Now().Add(-uptime).Format(types.LogParsingTimeLayout)</span><br><span class="line">        if loopBackTime &gt; 0 &amp;&amp; uptime &gt; loopBackTime &#123;</span><br><span class="line">                logStartTime = time.Now().Add(-loopBackTime).Format(types.LogParsingTimeLayout)</span><br><span class="line">        &#125;</span><br><span class="line">        for pattern, count := range logPatternsToCheck &#123;</span><br><span class="line">                healthy, err := checkForPattern(service, logStartTime, pattern, count)</span><br><span class="line">                if err != nil || !healthy &#123;</span><br><span class="line">                        return healthy, err</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return true, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ£€æŸ¥æœåŠ¡æ—¥å¿—ä¸­æŒ‡å®šæ¨¡å¼çš„å‡ºç°æ¬¡æ•°ã€‚</p>
<p>å‚æ•°ï¼š</p>
<ul>
<li>serviceï¼šè¢«ç›‘æ§çš„æœåŠ¡åç§°ã€‚</li>
<li>loopBackTimeï¼šç”¨äºç¡®å®šè¦æ£€æŸ¥çš„æ—¥å¿—æ—¶é—´èŒƒå›´ã€‚</li>
<li>logPatternsToCheckï¼šè¦æ£€æŸ¥çš„æ—¥å¿—æ¨¡å¼åŠå…¶å‡ºç°çš„é˜ˆå€¼ã€‚<br>è¿”å›å€¼ï¼šå¸ƒå°”å€¼è¡¨ç¤ºå¥åº·çŠ¶æ€å’Œå¯èƒ½çš„é”™è¯¯ã€‚</li>
</ul>
<h2 id="6-5-healthCheckEndpointOKFunc"><a href="#6-5-healthCheckEndpointOKFunc" class="headerlink" title="6.5 healthCheckEndpointOKFunc"></a>6.5 healthCheckEndpointOKFunc</h2><p>pkg&#x2F;healthchecker&#x2F;health_checker.go:126</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// healthCheckEndpointOKFunc returns a function to check the status of an http endpoint</span><br><span class="line">func healthCheckEndpointOKFunc(endpoint string, timeout time.Duration) func() (bool, error) &#123;</span><br><span class="line">        return func() (bool, error) &#123;</span><br><span class="line">                httpClient := http.Client&#123;Timeout: timeout&#125;</span><br><span class="line">                response, err := httpClient.Get(endpoint)</span><br><span class="line">                if err != nil || response.StatusCode != http.StatusOK &#123;</span><br><span class="line">                        return false, nil</span><br><span class="line">                &#125;</span><br><span class="line">                return true, nil</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æ£€æŸ¥ç»™å®š HTTP ç«¯ç‚¹çš„å¥åº·çŠ¶æ€ã€‚</p>
<p>å‚æ•°ï¼šç«¯ç‚¹ URI å’Œè¶…æ—¶æ—¶é—´ã€‚</p>
<p>è¿”å›å€¼ï¼šå¥åº·æ£€æŸ¥å‡½æ•°ã€‚</p>
<h2 id="6-6-getHealthCheckFunc"><a href="#6-6-getHealthCheckFunc" class="headerlink" title="6.6 getHealthCheckFunc"></a>6.6 getHealthCheckFunc</h2><p>pkg&#x2F;healthchecker&#x2F;health_checker.go:138</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// getHealthCheckFunc returns the health check function based on the component.</span><br><span class="line">func getHealthCheckFunc(hco *options.HealthCheckerOptions) func() (bool, error) &#123;</span><br><span class="line">        switch hco.Component &#123;</span><br><span class="line">        case types.KubeletComponent:</span><br><span class="line">                return healthCheckEndpointOKFunc(types.KubeletHealthCheckEndpoint(), hco.HealthCheckTimeout)</span><br><span class="line">        case types.KubeProxyComponent:</span><br><span class="line">                return healthCheckEndpointOKFunc(types.KubeProxyHealthCheckEndpoint(), hco.HealthCheckTimeout)</span><br><span class="line">        case types.DockerComponent:</span><br><span class="line">                return func() (bool, error) &#123;</span><br><span class="line">                        if _, err := execCommand(hco.HealthCheckTimeout, getDockerPath(), &quot;ps&quot;); err != nil &#123;</span><br><span class="line">                                return false, nil</span><br><span class="line">                        &#125;</span><br><span class="line">                        return true, nil</span><br><span class="line">                &#125;</span><br><span class="line">        case types.CRIComponent:</span><br><span class="line">                return func() (bool, error) &#123;</span><br><span class="line">                        _, err := execCommand(</span><br><span class="line">                                hco.HealthCheckTimeout,</span><br><span class="line">                                hco.CriCtlPath,</span><br><span class="line">                                &quot;--timeout=&quot;+hco.CriTimeout.String(),</span><br><span class="line">                                &quot;--runtime-endpoint=&quot;+hco.CriSocketPath,</span><br><span class="line">                                &quot;pods&quot;,</span><br><span class="line">                                &quot;--latest&quot;,</span><br><span class="line">                        )</span><br><span class="line">                        if err != nil &#123;</span><br><span class="line">                                return false, nil</span><br><span class="line">                        &#125;</span><br><span class="line">                        return true, nil</span><br><span class="line">                &#125;</span><br><span class="line">        default:</span><br><span class="line">                klog.Warningf(&quot;Unsupported component: %v&quot;, hco.Component)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®ç»„ä»¶ç±»å‹è¿”å›ç›¸åº”çš„å¥åº·æ£€æŸ¥æ–¹æ³•ã€‚</p>
<p>å‚æ•°ï¼šå¥åº·æ£€æŸ¥é€‰é¡¹ã€‚</p>
<p>è¿”å›å€¼ï¼šæ‰§è¡Œå¥åº·æ£€æŸ¥çš„å‡½æ•°ã€‚</p>
<h2 id="6-7-execCommand"><a href="#6-7-execCommand" class="headerlink" title="6.7 execCommand"></a>6.7 execCommand</h2><p>pkg&#x2F;healthchecker&#x2F;health_checker.go:174</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// execCommand executes the bash command and returns the (output, error) from command, error if timeout occurs.</span><br><span class="line">func execCommand(timeout time.Duration, command string, args ...string) (string, error) &#123;</span><br><span class="line">        ctx, cancel := context.WithTimeout(context.Background(), timeout)</span><br><span class="line">        defer cancel()</span><br><span class="line">        cmd := exec.CommandContext(ctx, command, args...)</span><br><span class="line">        out, err := cmd.CombinedOutput()</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">                klog.Infof(&quot;command %v failed: %v, %s\n&quot;, cmd, err, string(out))</span><br><span class="line">                return &quot;&quot;, err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return strings.TrimSuffix(string(out), &quot;\n&quot;), nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»™å®šçš„å‘½ä»¤ï¼Œå¹¶åœ¨æŒ‡å®šçš„è¶…æ—¶æ—¶é—´å†…è¿”å›è¾“å‡ºå’Œé”™è¯¯ã€‚</p>
<p>å‚æ•°ï¼šè¶…æ—¶æ—¶é—´ã€å‘½ä»¤å’Œå‚æ•°ã€‚</p>
<p>è¿”å›å€¼ï¼šå‘½ä»¤çš„è¾“å‡ºå’Œé”™è¯¯ä¿¡æ¯ã€‚</p>
<h2 id="6-8-getUptimeFunc"><a href="#6-8-getUptimeFunc" class="headerlink" title="6.8 getUptimeFunc"></a>6.8 getUptimeFunc</h2><p>pkg&#x2F;healthchecker&#x2F;health_checker_linux.go:32</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// getUptimeFunc returns the time for which the given service has been running.</span><br><span class="line">func getUptimeFunc(service string) func() (time.Duration, error) &#123;</span><br><span class="line">        return func() (time.Duration, error) &#123;</span><br><span class="line">                // Using InactiveExitTimestamp to capture the exact time when systemd tried starting the service. The service will</span><br><span class="line">                // transition from inactive -&gt; activating and the timestamp is captured.</span><br><span class="line">                // Source : https://www.freedesktop.org/wiki/Software/systemd/dbus/</span><br><span class="line">                // Using ActiveEnterTimestamp resulted in race condition where the service was repeatedly killed by plugin when</span><br><span class="line">                // RestartSec of systemd and invoke interval of plugin got in sync. The service was repeatedly killed in</span><br><span class="line">                // activating state and hence ActiveEnterTimestamp was never updated.</span><br><span class="line">                out, err := execCommand(types.CmdTimeout, &quot;systemctl&quot;, &quot;show&quot;, service, &quot;--property=InactiveExitTimestamp&quot;)</span><br><span class="line"></span><br><span class="line">                if err != nil &#123;</span><br><span class="line">                        return time.Duration(0), err</span><br><span class="line">                &#125;</span><br><span class="line">                val := strings.Split(out, &quot;=&quot;)</span><br><span class="line">                if len(val) &lt; 2 &#123;</span><br><span class="line">                        return time.Duration(0), errors.New(&quot;could not parse the service uptime time correctly&quot;)</span><br><span class="line">                &#125;</span><br><span class="line">                t, err := time.Parse(types.UptimeTimeLayout, val[1])</span><br><span class="line">                if err != nil &#123;</span><br><span class="line">                        return time.Duration(0), err</span><br><span class="line">                &#125;</span><br><span class="line">                return time.Since(t), nil</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè®¡ç®—æŒ‡å®šæœåŠ¡çš„è¿è¡Œæ—¶é—´ã€‚</p>
<p>å‚æ•°ï¼š</p>
<ul>
<li><p>service string - è¢«ç›‘æ§æœåŠ¡çš„åç§°ã€‚</p>
</li>
<li><p>è¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›æœåŠ¡è¿è¡Œçš„æŒç»­æ—¶é—´æˆ–é”™è¯¯ã€‚</p>
</li>
<li><p>å®ç°ç»†èŠ‚</p>
</li>
<li><p>ä½¿ç”¨ systemctl show å‘½ä»¤è·å– InactiveExitTimestampï¼Œè¿™æ˜¯æœåŠ¡ä» inactive çŠ¶æ€è½¬æ¢æ—¶çš„æ—¶é—´æˆ³ã€‚</p>
</li>
<li><p>è§£æå‘½ä»¤çš„è¾“å‡ºï¼Œå°†æ—¶é—´æˆ³è½¬æ¢ä¸º time.Time ç±»å‹ï¼Œå¹¶è®¡ç®—è‡ªè¯¥æ—¶é—´ä»¥æ¥çš„æŒç»­æ—¶é—´ã€‚</p>
</li>
<li><p>æ­¤æ–¹æ³•å¯ç”¨äºè·å–æœåŠ¡çš„å½“å‰è¿è¡Œæ—¶é—´ï¼Œä»¥ä¾¿è¯„ä¼°æ˜¯å¦åœ¨ä¿®å¤ä¹‹å‰è¾¾åˆ°å†·å´æ—¶é—´ã€‚</p>
</li>
</ul>
<h2 id="6-9-getRepairFunc"><a href="#6-9-getRepairFunc" class="headerlink" title="6.9 getRepairFunc"></a>6.9 getRepairFunc</h2><p>pkg&#x2F;healthchecker&#x2F;health_checker_linux.go:58</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// getRepairFunc returns the repair function based on the component.</span><br><span class="line">func getRepairFunc(hco *options.HealthCheckerOptions) func() &#123;</span><br><span class="line">        // Use `systemctl kill` instead of `systemctl restart` for the repair function.</span><br><span class="line">        // We start to rely on the kernel message difference for the two commands to</span><br><span class="line">        // indicate if the component restart is due to an administrative plan (restart)</span><br><span class="line">        // or a system issue that needs repair (kill).</span><br><span class="line">        // See https://github.com/kubernetes/node-problem-detector/issues/847.</span><br><span class="line">        switch hco.Component &#123;</span><br><span class="line">        case types.DockerComponent:</span><br><span class="line">                // Use &quot;docker ps&quot; for docker health check. Not using crictl for docker to remove</span><br><span class="line">                // dependency on the kubelet.</span><br><span class="line">                return func() &#123;</span><br><span class="line">                        execCommand(types.CmdTimeout, &quot;pkill&quot;, &quot;-SIGUSR1&quot;, &quot;dockerd&quot;)</span><br><span class="line">                        execCommand(types.CmdTimeout, &quot;systemctl&quot;, &quot;kill&quot;, &quot;--kill-who=main&quot;, hco.Service)</span><br><span class="line">                &#125;</span><br><span class="line">        default:</span><br><span class="line">                // Just kill the service for all other components</span><br><span class="line">                return func() &#123;</span><br><span class="line">                        execCommand(types.CmdTimeout, &quot;systemctl&quot;, &quot;kill&quot;, &quot;--kill-who=main&quot;, hco.Service)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®æœåŠ¡çš„ç»„ä»¶ç±»å‹è¿”å›ä¸€ä¸ªæ¼”ç¤ºä¿®å¤åŠŸèƒ½çš„æ–¹æ³•ã€‚</p>
<p>å‚æ•°ï¼š</p>
<ul>
<li>hco *options.HealthCheckerOptions - å¥åº·æ£€æŸ¥çš„é€‰é¡¹ã€‚</li>
<li>è¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æ‰§è¡Œç›¸åº”ä¿®å¤æ“ä½œã€‚</li>
</ul>
<p>å®ç°ç»†èŠ‚</p>
<ul>
<li>å¯¹äº Docker ç»„ä»¶ï¼Œé€šè¿‡ pkill å‘é€ SIGUSR1 ä¿¡å·ä»¥æ›´ä¼˜é›…åœ°åœæ­¢ Docker å®ˆæŠ¤è¿›ç¨‹ã€‚</li>
<li>å¯¹äºå…¶ä»–ç»„ä»¶ï¼Œè°ƒç”¨ systemctl kill å‘½ä»¤ç»ˆæ­¢ä¸»è¦è¿›ç¨‹ã€‚</li>
<li>è¿™ç§è®¾è®¡ä½¿å¾—ä¿®å¤åŠŸèƒ½èƒ½å¤Ÿæ ¹æ®ä¸åŒçš„ç»„ä»¶é‡‡å–åˆé€‚çš„å¤„ç†æ–¹å¼ã€‚</li>
</ul>
<h2 id="6-10-checkForPattern"><a href="#6-10-checkForPattern" class="headerlink" title="6.10 checkForPattern"></a>6.10 checkForPattern</h2><p>pkg&#x2F;healthchecker&#x2F;health_checker_linux.go:82</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// checkForPattern returns (true, nil) if logPattern occurs less than logCountThreshold number of times since last</span><br><span class="line">// service restart. (false, nil) otherwise.</span><br><span class="line">func checkForPattern(service, logStartTime, logPattern string, logCountThreshold int) (bool, error) &#123;</span><br><span class="line">        out, err := execCommand(types.CmdTimeout, &quot;/bin/sh&quot;, &quot;-c&quot;,</span><br><span class="line">                // Query service logs since the logStartTime</span><br><span class="line">                `journalctl --unit &quot;`+service+`&quot; --since &quot;`+logStartTime+</span><br><span class="line">                        // Grep the pattern</span><br><span class="line">                        `&quot; | grep -i &quot;`+logPattern+</span><br><span class="line">                        // Get the count of occurrences</span><br><span class="line">                        `&quot; | wc -l`)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">                return true, err</span><br><span class="line">        &#125;</span><br><span class="line">        occurrences, err := strconv.Atoi(out)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">                return true, err</span><br><span class="line">        &#125;</span><br><span class="line">        if occurrences &gt;= logCountThreshold &#123;</span><br><span class="line">                klog.Infof(&quot;%s failed log pattern check, %s occurrences: %v&quot;, service, logPattern, occurrences)</span><br><span class="line">                return false, nil</span><br><span class="line">        &#125;</span><br><span class="line">        return true, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ£€æŸ¥æŒ‡å®šæœåŠ¡çš„æ—¥å¿—ä¸­æ˜¯å¦åŒ…å«ç‰¹å®šæ¨¡å¼ï¼Œå¹¶è¿”å›å…¶å‡ºç°æ¬¡æ•°æ˜¯å¦è¾¾åˆ°é˜ˆå€¼ã€‚</p>
<p>å‚æ•°ï¼š</p>
<ul>
<li>serviceï¼šè¢«ç›‘æ§æœåŠ¡çš„åç§°ã€‚</li>
<li>logStartTimeï¼šèµ·å§‹æ—¶é—´ï¼Œç”¨äºè¿‡æ»¤æ—¥å¿—ã€‚</li>
<li>logPatternï¼šéœ€è¦æ£€æŸ¥çš„æ—¥å¿—æ¨¡å¼ã€‚</li>
<li>logCountThresholdï¼šæ¨¡å¼å‡ºç°çš„æœ€å¤§æ¬¡æ•°é˜ˆå€¼ã€‚</li>
<li>è¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºæ˜¯å¦å¥åº·ï¼Œä»¥åŠå¯èƒ½çš„é”™è¯¯ã€‚</li>
</ul>
<p>å®ç°ç»†èŠ‚</p>
<ul>
<li>ä½¿ç”¨ journalctl å‘½ä»¤è·å–ä»æŒ‡å®šæ—¶é—´å¼€å§‹çš„æœåŠ¡æ—¥å¿—ï¼Œå¹¶é€šè¿‡ grep è¿‡æ»¤ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—æ¨¡å¼ã€‚</li>
<li>ä½¿ç”¨ wc -l è®¡ç®—åŒ¹é…çš„è¡Œæ•°ã€‚</li>
<li>å¦‚æœæ—¥å¿—æ¨¡å¼å‡ºç°çš„æ¬¡æ•°å¤§äºé˜ˆå€¼ï¼Œè®°å½•ç›¸å…³ä¿¡æ¯å¹¶è¿”å›å¥åº·æ£€æŸ¥å¤±è´¥çš„ç»“æœã€‚</li>
</ul>
<h1 id="7-logcounter"><a href="#7-logcounter" class="headerlink" title="7 logcounter"></a>7 logcounter</h1><h2 id="7-1-logCounterå®šä¹‰"><a href="#7-1-logCounterå®šä¹‰" class="headerlink" title="7.1 logCounterå®šä¹‰"></a>7.1 logCounterå®šä¹‰</h2><p>pkg&#x2F;logcounter&#x2F;log_counter.go:42</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">type logCounter struct &#123;</span><br><span class="line">        logCh         &lt;-chan *systemtypes.Log</span><br><span class="line">        buffer        systemlogmonitor.LogBuffer</span><br><span class="line">        pattern       string</span><br><span class="line">        revertPattern string</span><br><span class="line">        clock         clock.Clock</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å­—æ®µè§£é‡Šï¼š</p>
<ul>
<li>logChï¼šåªè¯»é€šé“ï¼Œç”¨äºæ¥æ”¶ç³»ç»Ÿæ—¥å¿—ã€‚</li>
<li>bufferï¼šå­˜å‚¨æ—¥å¿—çš„ç¼“å†²åŒºï¼Œä»¥ä¾¿åˆ†æå’Œè®¡æ•°ã€‚</li>
<li>patternï¼šå¤„ç†æ—¥å¿—æ—¶ä½¿ç”¨çš„åŒ¹é…æ¨¡å¼ã€‚</li>
<li>revertPatternï¼šå¯ç”¨æ¥åå‘è®¡æ•°çš„æ¨¡å¼ã€‚</li>
<li>clockï¼šç”¨äºè·å–å½“å‰æ—¶é—´çš„æ—¶é’Ÿï¼Œæ”¯æŒæ¨¡æ‹Ÿæ—¶é’ŸåŠŸèƒ½ã€‚</li>
</ul>
<h2 id="7-2-NewJournaldLogCounter"><a href="#7-2-NewJournaldLogCounter" class="headerlink" title="7.2 NewJournaldLogCounter"></a>7.2 NewJournaldLogCounter</h2><p>pkg&#x2F;logcounter&#x2F;log_counter.go:50</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">func NewJournaldLogCounter(options *options.LogCounterOptions) (types.LogCounter, error) &#123;</span><br><span class="line">        watcher := journald.NewJournaldWatcher(watchertypes.WatcherConfig&#123;</span><br><span class="line">                Plugin:       &quot;journald&quot;,</span><br><span class="line">                PluginConfig: map[string]string&#123;journaldSourceKey: options.JournaldSource&#125;,</span><br><span class="line">                LogPath:      options.LogPath,</span><br><span class="line">                Lookback:     options.Lookback,</span><br><span class="line">                Delay:        options.Delay,</span><br><span class="line">        &#125;)</span><br><span class="line">        logCh, err := watcher.Watch()</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">                return nil, fmt.Errorf(&quot;error watching journald: %v&quot;, err)</span><br><span class="line">        &#125;</span><br><span class="line">        return &amp;logCounter&#123;</span><br><span class="line">                logCh:         logCh,</span><br><span class="line">                buffer:        systemlogmonitor.NewLogBuffer(bufferSize),</span><br><span class="line">                pattern:       options.Pattern,</span><br><span class="line">                revertPattern: options.RevertPattern,</span><br><span class="line">                clock:         clock.RealClock&#123;&#125;,</span><br><span class="line">        &#125;, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆå§‹åŒ–å¹¶è¿”å›ä¸€ä¸ªæ–°çš„ logCounter å®ä¾‹ã€‚</p>
<p>å‚æ•°ï¼š</p>
<ul>
<li>options *options.LogCounterOptions - åŒ…å«é…ç½®ä¿¡æ¯ï¼ˆä¾‹å¦‚æ—¥å¿—æºã€è·¯å¾„ã€æ¨¡å¼ç­‰ï¼‰ã€‚</li>
<li>è¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ªå®ç°äº† types.LogCounter æ¥å£çš„ logCounter å®ä¾‹ã€‚</li>
</ul>
<p>å®ç°ç»†èŠ‚</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ª journald æ—¥å¿—è§‚å¯Ÿè€…å®ä¾‹æ¥ç›‘æ§æŒ‡å®šçš„æ—¥å¿—è·¯å¾„ã€‚</li>
<li>å¦‚æœç›‘è§†æ“ä½œæˆåŠŸï¼Œå»ºç«‹æ—¥å¿—é€šé“å¹¶åˆ›å»º logCounter çš„å®ä¾‹ï¼Œè®¾ç½®ç¼“å†²åŒºã€åŒ¹é…æ¨¡å¼ç­‰ã€‚</li>
</ul>
<h2 id="7-3-Count"><a href="#7-3-Count" class="headerlink" title="7.3 Count"></a>7.3 Count</h2><p>pkg&#x2F;logcounter&#x2F;log_counter.go:71</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">func (e *logCounter) Count() (count int, err error) &#123;</span><br><span class="line">        start := e.clock.Now()</span><br><span class="line">        for &#123;</span><br><span class="line">                select &#123;</span><br><span class="line">                case log, ok := &lt;-e.logCh:</span><br><span class="line">                        if !ok &#123;</span><br><span class="line">                                err = fmt.Errorf(&quot;log channel closed unexpectedly&quot;)</span><br><span class="line">                                return</span><br><span class="line">                        &#125;</span><br><span class="line">                        if start.Before(log.Timestamp) &#123;</span><br><span class="line">                                return</span><br><span class="line">                        &#125;</span><br><span class="line">                        e.buffer.Push(log)</span><br><span class="line">                        if len(e.buffer.Match(e.pattern)) != 0 &#123;</span><br><span class="line">                                count++</span><br><span class="line">                        &#125;</span><br><span class="line">                        if e.revertPattern != &quot;&quot; &amp;&amp; len(e.buffer.Match(e.revertPattern)) != 0 &#123;</span><br><span class="line">                                count--</span><br><span class="line">                        &#125;</span><br><span class="line">                case &lt;-e.clock.After(timeout):</span><br><span class="line">                        return</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»Ÿè®¡åœ¨è¿è¡ŒæœŸé—´åŒ¹é…çš„æ—¥å¿—æ¡ç›®æ•°é‡ã€‚</p>
<p>è¿”å›å€¼ï¼šè¿”å›ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—è®¡æ•°åŠä»»ä½•æ½œåœ¨çš„é”™è¯¯ã€‚</p>
<p>å®ç°ç»†èŠ‚</p>
<ul>
<li>ä½¿ç”¨å½“å‰æ—¶é—´ (start) è®°å½•å¼€å§‹æ—¶åˆ»ã€‚</li>
<li>åœ¨æ— é™å¾ªç¯ä¸­ï¼Œä½¿ç”¨ select è¯­å¥ç›‘å¬æ—¥å¿—é€šé“å’Œè¶…æ—¶äº‹ä»¶ã€‚</li>
<li>å¦‚æœä» logCh è¯»å–åˆ°æ—¥å¿—ï¼š<ul>
<li>æ£€æŸ¥é€šé“æ˜¯å¦å·²ç»å…³é—­ã€‚</li>
<li>å¦‚æœè¯»å–åˆ°çš„æ—¥å¿—æ—¶é—´æˆ³æ™šäºå¼€å§‹æ—¶é—´ï¼Œåˆ™åœæ­¢è®¡æ•°ã€‚</li>
<li>å°†æ—¥å¿—æ¡ç›®å‹å…¥ç¼“å†²åŒºã€‚</li>
<li>æ£€æŸ¥å½“å‰æ—¥å¿—æ˜¯å¦ä¸æ¨¡å¼åŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ™è®¡æ•°åŠ ä¸€ï¼›å¦‚æœåŒ¹é…åå‘æ¨¡å¼ï¼Œåˆ™è®¡æ•°å‡ä¸€ã€‚</li>
<li>å¦‚æœåœ¨è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°æ–°æ—¥å¿—ï¼Œç»“æŸå¾ªç¯å¹¶è¿”å›è®¡æ•°ã€‚</li>
</ul>
</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>kubebuilderçš„makefileæ–‡ä»¶</title>
    <url>/2025/07/kubernetes/Operator%E5%BC%80%E5%8F%91/kubebuilder%E7%9A%84makefile%E6%96%87%E4%BB%B6/</url>
    <content><![CDATA[<h1 id="1ã€Makefileç®€ä»‹"><a href="#1ã€Makefileç®€ä»‹" class="headerlink" title="1ã€Makefileç®€ä»‹"></a>1ã€Makefileç®€ä»‹</h1><p>Makefile æ˜¯ä¸€ç§ç”¨äºè‡ªåŠ¨åŒ–æ„å»ºè½¯ä»¶é¡¹ç›®çš„æ–‡ä»¶ã€‚å®ƒé€šå¸¸ç”¨äºç®¡ç†å’Œæ‰§è¡Œç¼–è¯‘ã€é“¾æ¥ã€æµ‹è¯•ç­‰ä¸€ç³»åˆ—ä»»åŠ¡ï¼Œä»¥æé«˜å¼€å‘æ•ˆç‡ã€‚</p>
<h2 id="1-1-ç›®æ ‡ä¸ä¾èµ–"><a href="#1-1-ç›®æ ‡ä¸ä¾èµ–" class="headerlink" title="1.1 ç›®æ ‡ä¸ä¾èµ–"></a>1.1 ç›®æ ‡ä¸ä¾èµ–</h2><h3 id="1-1-1ç›®æ ‡ï¼ˆTargetsï¼‰"><a href="#1-1-1ç›®æ ‡ï¼ˆTargetsï¼‰" class="headerlink" title="1.1.1ç›®æ ‡ï¼ˆTargetsï¼‰"></a>1.1.1ç›®æ ‡ï¼ˆTargetsï¼‰</h3><ul>
<li>ä»£è¡¨ä¸€ä¸ªä»»åŠ¡æˆ–ä¸€ä¸ªæ–‡ä»¶çš„ç”Ÿæˆç»“æœã€‚ä¾‹å¦‚ï¼Œç¼–è¯‘ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€åº“æ–‡ä»¶ç­‰éƒ½å¯ä»¥æ˜¯ç›®æ ‡ã€‚</li>
<li>å¸¸è§çš„ç›®æ ‡æœ‰ â€œallâ€ï¼ˆè¡¨ç¤ºæ„å»ºæ•´ä¸ªé¡¹ç›®ï¼‰ã€â€œcleanâ€ï¼ˆç”¨äºæ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶ï¼‰ç­‰ã€‚</li>
</ul>
<h3 id="1-1-2-ä¾èµ–ï¼ˆDependenciesï¼‰"><a href="#1-1-2-ä¾èµ–ï¼ˆDependenciesï¼‰" class="headerlink" title="1.1.2 ä¾èµ–ï¼ˆDependenciesï¼‰"></a>1.1.2 ä¾èµ–ï¼ˆDependenciesï¼‰</h3><ul>
<li>ç›®æ ‡æ‰€ä¾èµ–çš„å…¶ä»–æ–‡ä»¶æˆ–ç›®æ ‡ã€‚åªæœ‰å½“ä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡æ–°æ‰§è¡Œç”Ÿæˆç›®æ ‡çš„å‘½ä»¤ã€‚</li>
<li>ä¾‹å¦‚ï¼Œä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¯èƒ½ä¾èµ–äºå¤šä¸ªæºæ–‡ä»¶å’Œåº“æ–‡ä»¶ã€‚</li>
</ul>
<h2 id="1-2-è§„åˆ™ä¸å‘½ä»¤"><a href="#1-2-è§„åˆ™ä¸å‘½ä»¤" class="headerlink" title="1.2 è§„åˆ™ä¸å‘½ä»¤"></a>1.2 è§„åˆ™ä¸å‘½ä»¤</h2><h3 id="1-2-1-è§„åˆ™ï¼ˆRulesï¼‰"><a href="#1-2-1-è§„åˆ™ï¼ˆRulesï¼‰" class="headerlink" title="1.2.1 è§„åˆ™ï¼ˆRulesï¼‰"></a>1.2.1 è§„åˆ™ï¼ˆRulesï¼‰</h3><ul>
<li>æè¿°äº†å¦‚ä½•ä»ä¾èµ–ç”Ÿæˆç›®æ ‡ã€‚é€šå¸¸ç”±ç›®æ ‡ã€ä¾èµ–å’Œå‘½ä»¤ä¸‰éƒ¨åˆ†ç»„æˆã€‚</li>
<li>æ ¼å¼ä¸€èˆ¬ä¸ºï¼štarget: dependenciesï¼Œæ¥ç€æ˜¯å‘½ä»¤éƒ¨åˆ†ï¼Œæ¯è¡Œå‘½ä»¤å‰é¢å¿…é¡»ä»¥åˆ¶è¡¨ç¬¦ï¼ˆTabï¼‰å¼€å¤´ã€‚</li>
</ul>
<h3 id="1-2-2-å‘½ä»¤ï¼ˆCommandsï¼‰"><a href="#1-2-2-å‘½ä»¤ï¼ˆCommandsï¼‰" class="headerlink" title="1.2.2 å‘½ä»¤ï¼ˆCommandsï¼‰"></a>1.2.2 å‘½ä»¤ï¼ˆCommandsï¼‰</h3><ul>
<li>ç”¨äºæ‰§è¡Œç”Ÿæˆç›®æ ‡çš„å…·ä½“æ“ä½œã€‚å¯ä»¥æ˜¯ç¼–è¯‘å™¨å‘½ä»¤ã€é“¾æ¥å™¨å‘½ä»¤ã€æ–‡ä»¶å¤åˆ¶å‘½ä»¤ç­‰ã€‚</li>
<li>ä¾‹å¦‚ï¼Œç¼–è¯‘ C è¯­è¨€æºæ–‡ä»¶çš„å‘½ä»¤å¯èƒ½æ˜¯gcc -o target source.cã€‚</li>
</ul>
<h2 id="1-3-å˜é‡ä¸å‡½æ•°"><a href="#1-3-å˜é‡ä¸å‡½æ•°" class="headerlink" title="1.3 å˜é‡ä¸å‡½æ•°"></a>1.3 å˜é‡ä¸å‡½æ•°</h2><h3 id="1-3-1-å˜é‡ï¼ˆVariablesï¼‰"><a href="#1-3-1-å˜é‡ï¼ˆVariablesï¼‰" class="headerlink" title="1.3.1 å˜é‡ï¼ˆVariablesï¼‰"></a>1.3.1 å˜é‡ï¼ˆVariablesï¼‰</h3><ul>
<li>å¯ä»¥å®šä¹‰å’Œä½¿ç”¨å˜é‡æ¥å­˜å‚¨å¸¸ç”¨çš„å€¼ï¼Œå¦‚ç¼–è¯‘å™¨åç§°ã€ç¼–è¯‘é€‰é¡¹ã€æºæ–‡ä»¶åˆ—è¡¨ç­‰ã€‚</li>
<li>å˜é‡å®šä¹‰æ–¹å¼ä¸ºVARIABLE &#x3D; valueï¼Œä½¿ç”¨æ—¶ç”¨$(VARIABLE)ã€‚</li>
</ul>
<h3 id="1-3-2-å‡½æ•°ï¼ˆFunctionsï¼‰"><a href="#1-3-2-å‡½æ•°ï¼ˆFunctionsï¼‰" class="headerlink" title="1.3.2 å‡½æ•°ï¼ˆFunctionsï¼‰"></a>1.3.2 å‡½æ•°ï¼ˆFunctionsï¼‰</h3><ul>
<li>Makefile æä¾›äº†ä¸€äº›å†…ç½®å‡½æ•°ï¼Œå¯ä»¥è¿›è¡Œå­—ç¬¦ä¸²å¤„ç†ã€æ–‡ä»¶æ“ä½œç­‰ã€‚</li>
<li>ä¾‹å¦‚ï¼Œ$(wildcard *.c)å¯ä»¥è·å–å½“å‰ç›®å½•ä¸‹æ‰€æœ‰çš„ C è¯­è¨€æºæ–‡ä»¶ã€‚</li>
</ul>
<h2 id="1-4-ä¼˜åŠ¿"><a href="#1-4-ä¼˜åŠ¿" class="headerlink" title="1.4 ä¼˜åŠ¿"></a>1.4 ä¼˜åŠ¿</h2><h3 id="1-4-1-è‡ªåŠ¨åŒ–æ„å»º"><a href="#1-4-1-è‡ªåŠ¨åŒ–æ„å»º" class="headerlink" title="1.4.1 è‡ªåŠ¨åŒ–æ„å»º"></a>1.4.1 è‡ªåŠ¨åŒ–æ„å»º</h3><ul>
<li>å¯ä»¥è‡ªåŠ¨æ‰§è¡Œä¸€ç³»åˆ—æ„å»ºæ­¥éª¤ï¼Œå‡å°‘æ‰‹åŠ¨æ“ä½œå’Œé”™è¯¯ã€‚</li>
<li>å½“æºæ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåªé‡æ–°æ„å»ºå—å½±å“çš„éƒ¨åˆ†ï¼Œæé«˜æ„å»ºæ•ˆç‡ã€‚</li>
</ul>
<h3 id="1-4-2-å¯é‡å¤æ€§"><a href="#1-4-2-å¯é‡å¤æ€§" class="headerlink" title="1.4.2 å¯é‡å¤æ€§"></a>1.4.2 å¯é‡å¤æ€§</h3><p>ç¡®ä¿åœ¨ä¸åŒçš„ç¯å¢ƒä¸­éƒ½èƒ½ä»¥ç›¸åŒçš„æ–¹å¼æ„å»ºé¡¹ç›®ã€‚</p>
<h3 id="1-4-3-æ˜“äºç»´æŠ¤"><a href="#1-4-3-æ˜“äºç»´æŠ¤" class="headerlink" title="1.4.3 æ˜“äºç»´æŠ¤"></a>1.4.3 æ˜“äºç»´æŠ¤</h3><p>é¡¹ç›®çš„æ„å»ºè¿‡ç¨‹é›†ä¸­åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä¾¿äºä¿®æ”¹å’Œç®¡ç†ã€‚</p>
<h1 id="2ã€kubebuilder-makefile"><a href="#2ã€kubebuilder-makefile" class="headerlink" title="2ã€kubebuilder makefile"></a>2ã€kubebuilder makefile</h1><h2 id="2-1-kubebuilder-é¡¹ç›®makefile"><a href="#2-1-kubebuilder-é¡¹ç›®makefile" class="headerlink" title="2.1 kubebuilder é¡¹ç›®makefile"></a>2.1 kubebuilder é¡¹ç›®makefile</h2><p>ä¸€ä¸ªkubebuilderåˆ›å»ºçš„operatoré¡¹ç›®çš„makefileæ–‡ä»¶å†…å®¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Image URL to use all building/pushing image targets</span></span><br><span class="line">IMG ?= controller:latest</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ENVTEST_K8S_VERSION refers to the version of kubebuilder assets to be downloaded by envtest binary.</span></span><br><span class="line">ENVTEST_K8S_VERSION = 1.31.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Get the currently used golang install path (<span class="keyword">in</span> GOPATH/bin, unless GOBIN is <span class="built_in">set</span>)</span></span><br><span class="line">ifeq (,$(shell go env GOBIN))</span><br><span class="line">GOBIN=$(shell go env GOPATH)/bin</span><br><span class="line">else</span><br><span class="line">GOBIN=$(shell go env GOBIN)</span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CONTAINER_TOOL defines the container tool to be used <span class="keyword">for</span> building images.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Be aware that the target commands are only tested with Docker <span class="built_in">which</span> is</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">scaffolded by default. However, you might want to replace it to use other</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tools. (i.e. podman)</span></span><br><span class="line">CONTAINER_TOOL ?= docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Setting SHELL to bash allows bash commands to be executed by recipes.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Options are <span class="built_in">set</span> to <span class="built_in">exit</span> when a recipe line exits non-zero or a piped <span class="built_in">command</span> fails.</span></span><br><span class="line">SHELL = /usr/bin/env bash -o pipefail</span><br><span class="line">.SHELLFLAGS = -ec</span><br><span class="line"></span><br><span class="line">.PHONY: all</span><br><span class="line">all: build</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#@ General</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The <span class="built_in">help</span> target prints out all targets with their descriptions organized</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">beneath their categories. The categories are represented by <span class="string">&#x27;##@&#x27;</span> and the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">target descriptions by <span class="string">&#x27;##&#x27;</span>. The awk <span class="built_in">command</span> is responsible <span class="keyword">for</span> reading the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">entire <span class="built_in">set</span> of makefiles included <span class="keyword">in</span> this invocation, looking <span class="keyword">for</span> lines of the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">file as xyz: <span class="comment">## something, and then pretty-format the target and help. Then,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">if</span> there<span class="string">&#x27;s a line with ##@ something, that gets pretty-printed as a category.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">More info on the usage of ANSI control characters for terminal formatting:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">https://en.wikipedia.org/wiki/ANSI_escape_code#SGR_parameters</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">More info on the awk command:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">http://linuxcommand.org/lc3_adv_awk.php</span></span></span><br><span class="line"></span><br><span class="line">.PHONY: help</span><br><span class="line">help: ## Display this help.</span><br><span class="line">        @awk &#x27;BEGIN &#123;FS = &quot;:.*##&quot;; printf &quot;\nUsage:\n  make \033[36m&lt;target&gt;\033[0m\n&quot;&#125; /^[a-zA-Z_0-9-]+:.*?##/ &#123; printf &quot;  \033[36m%-15s\033[0m %s\n&quot;, $$1, $$2 &#125; /^##@/ &#123; printf &quot;\n\033[1m%s\033[0m\n&quot;, substr($$0, 5) &#125; &#x27; $(MAKEFILE_LIST)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">#@ Development</span></span></span><br><span class="line"></span><br><span class="line">.PHONY: manifests</span><br><span class="line">manifests: controller-gen ## Generate WebhookConfiguration, ClusterRole and CustomResourceDefinition objects.</span><br><span class="line">        $(CONTROLLER_GEN) rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br><span class="line"></span><br><span class="line">.PHONY: generate</span><br><span class="line">generate: controller-gen ## Generate code containing DeepCopy, DeepCopyInto, and DeepCopyObject method implementations.</span><br><span class="line">        $(CONTROLLER_GEN) object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;</span><br><span class="line"></span><br><span class="line">.PHONY: fmt</span><br><span class="line">fmt: ## Run go fmt against code.</span><br><span class="line">        go fmt ./...</span><br><span class="line"></span><br><span class="line">.PHONY: vet</span><br><span class="line">vet: ## Run go vet against code.</span><br><span class="line">        go vet ./...</span><br><span class="line"></span><br><span class="line">.PHONY: test</span><br><span class="line">test: manifests generate fmt vet envtest ## Run tests.</span><br><span class="line">        KUBEBUILDER_ASSETS=&quot;$(shell $(ENVTEST) use $(ENVTEST_K8S_VERSION) --bin-dir $(LOCALBIN) -p path)&quot; go test $$(go list ./... | grep -v /e2e) -coverprofile cover.out</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Utilize Kind or modify the e2e tests to load the image locally, enabling compatibility with other vendors.</span></span></span><br><span class="line">.PHONY: test-e2e  # Run the e2e tests against a Kind k8s instance that is spun up.</span><br><span class="line">test-e2e:</span><br><span class="line">        go test ./test/e2e/ -v -ginkgo.v</span><br><span class="line"></span><br><span class="line">.PHONY: lint</span><br><span class="line">lint: golangci-lint ## Run golangci-lint linter</span><br><span class="line">        $(GOLANGCI_LINT) run</span><br><span class="line"></span><br><span class="line">.PHONY: lint-fix</span><br><span class="line">lint-fix: golangci-lint ## Run golangci-lint linter and perform fixes</span><br><span class="line">        $(GOLANGCI_LINT) run --fix</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">#@ Build</span></span></span><br><span class="line"></span><br><span class="line">.PHONY: build</span><br><span class="line">build: manifests generate fmt vet ## Build manager binary.</span><br><span class="line">        go build -o bin/manager cmd/main.go</span><br><span class="line"></span><br><span class="line">.PHONY: run</span><br><span class="line">run: manifests generate fmt vet ## Run a controller from your host.</span><br><span class="line">        go run ./cmd/main.go</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">If you wish to build the manager image targeting other platforms you can use the --platform flag.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">(i.e. docker build --platform linux/arm64). However, you must enable docker buildKit for it.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">More info: https://docs.docker.com/develop/develop-images/build_enhancements/</span></span></span><br><span class="line">.PHONY: docker-build</span><br><span class="line">docker-build: ## Build docker image with the manager.</span><br><span class="line">        $(CONTAINER_TOOL) build -t $&#123;IMG&#125; .</span><br><span class="line"></span><br><span class="line">.PHONY: docker-push</span><br><span class="line">docker-push: ## Push docker image with the manager.</span><br><span class="line">        $(CONTAINER_TOOL) push $&#123;IMG&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">PLATFORMS defines the target platforms for the manager image be built to provide support to multiple</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">architectures. (i.e. make docker-buildx IMG=myregistry/mypoperator:0.0.1). To use this option you need to:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">- be able to use docker buildx. More info: https://docs.docker.com/build/buildx/</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">- have enabled BuildKit. More info: https://docs.docker.com/develop/develop-images/build_enhancements/</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">- be able to push the image to your registry (i.e. if you do not set a valid value via IMG=&lt;myregistry/image:&lt;tag&gt;&gt; then the export will fail)</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">To adequately provide solutions that are compatible with multiple platforms, you should consider using this option.</span></span></span><br><span class="line">PLATFORMS ?= linux/arm64,linux/amd64,linux/s390x,linux/ppc64le</span><br><span class="line">.PHONY: docker-buildx</span><br><span class="line">docker-buildx: ## Build and push docker image for the manager for cross-platform support</span><br><span class="line">        # copy existing Dockerfile and insert --platform=$&#123;BUILDPLATFORM&#125; into Dockerfile.cross, and preserve the original Dockerfile</span><br><span class="line">        sed -e &#x27;1 s/\(^FROM\)/FROM --platform=\$$\&#123;BUILDPLATFORM\&#125;/; t&#x27; -e &#x27; 1,// s//FROM --platform=\$$\&#123;BUILDPLATFORM\&#125;/&#x27; Dockerfile &gt; Dockerfile.cross</span><br><span class="line">        - $(CONTAINER_TOOL) buildx create --name myapp-operator-builder</span><br><span class="line">        $(CONTAINER_TOOL) buildx use myapp-operator-builder</span><br><span class="line">        - $(CONTAINER_TOOL) buildx build --push --platform=$(PLATFORMS) --tag $&#123;IMG&#125; -f Dockerfile.cross .</span><br><span class="line">        - $(CONTAINER_TOOL) buildx rm myapp-operator-builder</span><br><span class="line">        rm Dockerfile.cross</span><br><span class="line"></span><br><span class="line">.PHONY: build-installer</span><br><span class="line">build-installer: manifests generate kustomize ## Generate a consolidated YAML with CRDs and deployment.</span><br><span class="line">        mkdir -p dist</span><br><span class="line">        cd config/manager &amp;&amp; $(KUSTOMIZE) edit set image controller=$&#123;IMG&#125;</span><br><span class="line">        $(KUSTOMIZE) build config/default &gt; dist/install.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">#@ Deployment</span></span></span><br><span class="line"></span><br><span class="line">ifndef ignore-not-found</span><br><span class="line">  ignore-not-found = false</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">.PHONY: install</span><br><span class="line">install: manifests kustomize ## Install CRDs into the K8s cluster specified in ~/.kube/config.</span><br><span class="line">        $(KUSTOMIZE) build config/crd | $(KUBECTL) apply -f -</span><br><span class="line"></span><br><span class="line">.PHONY: uninstall</span><br><span class="line">uninstall: manifests kustomize ## Uninstall CRDs from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.</span><br><span class="line">        $(KUSTOMIZE) build config/crd | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -</span><br><span class="line"></span><br><span class="line">.PHONY: deploy</span><br><span class="line">deploy: manifests kustomize ## Deploy controller to the K8s cluster specified in ~/.kube/config.</span><br><span class="line">        cd config/manager &amp;&amp; $(KUSTOMIZE) edit set image controller=$&#123;IMG&#125;</span><br><span class="line">        $(KUSTOMIZE) build config/default | $(KUBECTL) apply -f -</span><br><span class="line"></span><br><span class="line">.PHONY: undeploy</span><br><span class="line">undeploy: kustomize ## Undeploy controller from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.</span><br><span class="line">        $(KUSTOMIZE) build config/default | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">#@ Dependencies</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"># Location to install dependencies to</span></span></span><br><span class="line">LOCALBIN ?= $(shell pwd)/bin</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">(LOCALBIN):</span></span></span><br><span class="line">        mkdir -p $(LOCALBIN)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"># Tool Binaries</span></span></span><br><span class="line">KUBECTL ?= kubectl</span><br><span class="line">KUSTOMIZE ?= $(LOCALBIN)/kustomize</span><br><span class="line">CONTROLLER_GEN ?= $(LOCALBIN)/controller-gen</span><br><span class="line">ENVTEST ?= $(LOCALBIN)/setup-envtest</span><br><span class="line">GOLANGCI_LINT = $(LOCALBIN)/golangci-lint</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"># Tool Versions</span></span></span><br><span class="line">KUSTOMIZE_VERSION ?= v5.4.3</span><br><span class="line">CONTROLLER_TOOLS_VERSION ?= v0.16.1</span><br><span class="line">ENVTEST_VERSION ?= release-0.19</span><br><span class="line">GOLANGCI_LINT_VERSION ?= v1.59.1</span><br><span class="line"></span><br><span class="line">.PHONY: kustomize</span><br><span class="line">kustomize: $(KUSTOMIZE) ## Download kustomize locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">(KUSTOMIZE): $(LOCALBIN)</span></span></span><br><span class="line">        $(call go-install-tool,$(KUSTOMIZE),sigs.k8s.io/kustomize/kustomize/v5,$(KUSTOMIZE_VERSION))</span><br><span class="line"></span><br><span class="line">.PHONY: controller-gen</span><br><span class="line">controller-gen: $(CONTROLLER_GEN) ## Download controller-gen locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">(CONTROLLER_GEN): $(LOCALBIN)</span></span></span><br><span class="line">        $(call go-install-tool,$(CONTROLLER_GEN),sigs.k8s.io/controller-tools/cmd/controller-gen,$(CONTROLLER_TOOLS_VERSION))</span><br><span class="line"></span><br><span class="line">.PHONY: envtest</span><br><span class="line">envtest: $(ENVTEST) ## Download setup-envtest locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">(ENVTEST): $(LOCALBIN)</span></span></span><br><span class="line">        $(call go-install-tool,$(ENVTEST),sigs.k8s.io/controller-runtime/tools/setup-envtest,$(ENVTEST_VERSION))</span><br><span class="line"></span><br><span class="line">.PHONY: golangci-lint</span><br><span class="line">golangci-lint: $(GOLANGCI_LINT) ## Download golangci-lint locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">(GOLANGCI_LINT): $(LOCALBIN)</span></span></span><br><span class="line">        $(call go-install-tool,$(GOLANGCI_LINT),github.com/golangci/golangci-lint/cmd/golangci-lint,$(GOLANGCI_LINT_VERSION))</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">go-install-tool will &#x27;</span>go install<span class="string">&#x27; any package with custom target and name of binary, if it doesn&#x27;</span>t exist</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$1</span> - target path with name of binary</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$2</span> - package url <span class="built_in">which</span> can be installed</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$3</span> - specific version of package</span></span><br><span class="line">define go-install-tool</span><br><span class="line">@[ -f &quot;$(1)-$(3)&quot; ] || &#123; \</span><br><span class="line">set -e; \</span><br><span class="line">package=$(2)@$(3) ;\</span><br><span class="line">echo &quot;Downloading $$&#123;package&#125;&quot; ;\</span><br><span class="line">rm -f $(1) || true ;\</span><br><span class="line">GOBIN=$(LOCALBIN) go install $$&#123;package&#125; ;\</span><br><span class="line">mv $(1) $(1)-$(3) ;\</span><br><span class="line">&#125; ;\</span><br><span class="line">ln -sf $(1)-$(3) $(1)</span><br><span class="line">endef</span><br></pre></td></tr></table></figure>

<h2 id="2-2-å˜é‡å®šä¹‰éƒ¨åˆ†"><a href="#2-2-å˜é‡å®šä¹‰éƒ¨åˆ†" class="headerlink" title="2.2 å˜é‡å®šä¹‰éƒ¨åˆ†"></a>2.2 å˜é‡å®šä¹‰éƒ¨åˆ†</h2><h3 id="2-2-1-IMGï¼ˆå®šä¹‰æ„å»ºå’Œæ¨é€Dockeré•œåƒçš„ç›®æ ‡é•œåƒURLï¼‰"><a href="#2-2-1-IMGï¼ˆå®šä¹‰æ„å»ºå’Œæ¨é€Dockeré•œåƒçš„ç›®æ ‡é•œåƒURLï¼‰" class="headerlink" title="2.2.1 IMGï¼ˆå®šä¹‰æ„å»ºå’Œæ¨é€Dockeré•œåƒçš„ç›®æ ‡é•œåƒURLï¼‰"></a>2.2.1 IMGï¼ˆå®šä¹‰æ„å»ºå’Œæ¨é€Dockeré•œåƒçš„ç›®æ ‡é•œåƒURLï¼‰</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Image URL to use all building/pushing image targets</span></span><br><span class="line">IMG ?= controller:latest</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šå®šä¹‰æ„å»ºå’Œæ¨é€Dockeré•œåƒçš„ç›®æ ‡é•œåƒURL<br>è§£é‡Šï¼šå¦‚æœæ²¡æœ‰åœ¨å‘½ä»¤ä¸­æŒ‡å®šIMGï¼Œåˆ™é»˜è®¤å€¼ä¸ºcontroller:latest</p>
<h3 id="2-2-2-ENVTEST-K8S-VERSIONï¼ˆå®šä¹‰envtestå·¥å…·ä¸‹è½½çš„Kubernetesèµ„äº§ç‰ˆæœ¬ï¼‰"><a href="#2-2-2-ENVTEST-K8S-VERSIONï¼ˆå®šä¹‰envtestå·¥å…·ä¸‹è½½çš„Kubernetesèµ„äº§ç‰ˆæœ¬ï¼‰" class="headerlink" title="2.2.2 ENVTEST_K8S_VERSIONï¼ˆå®šä¹‰envtestå·¥å…·ä¸‹è½½çš„Kubernetesèµ„äº§ç‰ˆæœ¬ï¼‰"></a>2.2.2 ENVTEST_K8S_VERSIONï¼ˆå®šä¹‰envtestå·¥å…·ä¸‹è½½çš„Kubernetesèµ„äº§ç‰ˆæœ¬ï¼‰</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ENVTEST_K8S_VERSION refers to the version of kubebuilder assets to be downloaded by envtest binary.</span></span><br><span class="line">ENVTEST_K8S_VERSION = 1.31.0</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šå®šä¹‰envtestå·¥å…·ä¸‹è½½çš„Kubernetesèµ„äº§ç‰ˆæœ¬<br>è§£é‡Šï¼šenvtestæ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•çš„å·¥å…·ï¼Œè¿™ä¸ªå˜é‡åˆ¶å®šäº†è¦ä¸‹è½½çš„Kubernetesç‰ˆæœ¬ã€‚</p>
<h3 id="2-2-3-GOBINï¼ˆå½“å‰ä½¿ç”¨çš„Goçš„å®‰è£…è·¯å¾„ï¼‰"><a href="#2-2-3-GOBINï¼ˆå½“å‰ä½¿ç”¨çš„Goçš„å®‰è£…è·¯å¾„ï¼‰" class="headerlink" title="2.2.3 GOBINï¼ˆå½“å‰ä½¿ç”¨çš„Goçš„å®‰è£…è·¯å¾„ï¼‰"></a>2.2.3 GOBINï¼ˆå½“å‰ä½¿ç”¨çš„Goçš„å®‰è£…è·¯å¾„ï¼‰</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Get the currently used golang install path (<span class="keyword">in</span> GOPATH/bin, unless GOBIN is <span class="built_in">set</span>)</span></span><br><span class="line">ifeq (,$(shell go env GOBIN))</span><br><span class="line">GOBIN=$(shell go env GOPATH)/bin</span><br><span class="line">else</span><br><span class="line">GOBIN=$(shell go env GOBIN)</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>

<p>ä½œç”¨ï¼šè·å–å½“å‰ä½¿ç”¨çš„Goçš„å®‰è£…è·¯å¾„<br>è§£é‡Šï¼šå¦‚æœGONBINç¯å¢ƒå˜é‡æœªè®¾ç½®ï¼Œåˆ™ä½¿ç”¨GOPATCH&#x2F;binä½œä¸ºé»˜è®¤è·¯å¾„ï¼›å¦åˆ™ä½¿ç”¨GOBINçš„å€¼ã€‚</p>
<h3 id="2-2-4-CONTAINER-TOOLï¼ˆç”¨äºæ„å»ºé•œåƒçš„å®¹å™¨å·¥å…·ï¼‰"><a href="#2-2-4-CONTAINER-TOOLï¼ˆç”¨äºæ„å»ºé•œåƒçš„å®¹å™¨å·¥å…·ï¼‰" class="headerlink" title="2.2.4 CONTAINER_TOOLï¼ˆç”¨äºæ„å»ºé•œåƒçš„å®¹å™¨å·¥å…·ï¼‰"></a>2.2.4 CONTAINER_TOOLï¼ˆç”¨äºæ„å»ºé•œåƒçš„å®¹å™¨å·¥å…·ï¼‰</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CONTAINER_TOOL defines the container tool to be used <span class="keyword">for</span> building images.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Be aware that the target commands are only tested with Docker <span class="built_in">which</span> is</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">scaffolded by default. However, you might want to replace it to use other</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tools. (i.e. podman)</span></span><br><span class="line">CONTAINER_TOOL ?= docker</span><br></pre></td></tr></table></figure>

<p>ä½œç”¨ï¼šå®šä¹‰ç”¨äºæ„å»ºé•œåƒçš„å®¹å™¨å·¥å…·<br>è§£é‡Šï¼šé»˜è®¤å€¼ä¸ºdockerï¼Œä½†æ˜¯å¯ä»¥æ›¿æ¢ä¸ºå…¶ä»–å·¥å…·ï¼Œä¾‹å¦‚podman</p>
<h3 id="2-2-5-SHELL-å’Œ-SHELLFLAGSï¼ˆè®¾ç½®Makefileä½¿ç”¨çš„shellå’Œshellé€‰é¡¹ï¼‰"><a href="#2-2-5-SHELL-å’Œ-SHELLFLAGSï¼ˆè®¾ç½®Makefileä½¿ç”¨çš„shellå’Œshellé€‰é¡¹ï¼‰" class="headerlink" title="2.2.5 SHELL å’Œ .SHELLFLAGSï¼ˆè®¾ç½®Makefileä½¿ç”¨çš„shellå’Œshellé€‰é¡¹ï¼‰"></a>2.2.5 SHELL å’Œ .SHELLFLAGSï¼ˆè®¾ç½®Makefileä½¿ç”¨çš„shellå’Œshellé€‰é¡¹ï¼‰</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Setting SHELL to bash allows bash commands to be executed by recipes.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Options are <span class="built_in">set</span> to <span class="built_in">exit</span> when a recipe line exits non-zero or a piped <span class="built_in">command</span> fails.</span></span><br><span class="line">SHELL = /usr/bin/env bash -o pipefail</span><br><span class="line">.SHELLFLAGS = -ec</span><br></pre></td></tr></table></figure>

<p>ä½œç”¨ï¼šè®¾ç½®Makefileä½¿ç”¨çš„shellå’Œshellé€‰é¡¹<br>è§£é‡Šï¼š</p>
<ul>
<li>SHELLè®¾ç½®ä¸º&#x2F;usr&#x2F;bin&#x2F;env bash -o pipefail</li>
<li>.SHELLFLAGS è®¾ç½®ä¸º-ecï¼Œè¡¨ç¤ºshellåº”è¯¥ç«‹å³é€€å‡ºå¹¶åœ¨ä»»ä½•å‘½ä»¤å¤±è´¥æ—¶æŠ¥å‘Šé”™è¯¯</li>
</ul>
<h2 id="2-3-ç›®æ ‡å®šä¹‰éƒ¨åˆ†"><a href="#2-3-ç›®æ ‡å®šä¹‰éƒ¨åˆ†" class="headerlink" title="2.3 ç›®æ ‡å®šä¹‰éƒ¨åˆ†"></a>2.3 ç›®æ ‡å®šä¹‰éƒ¨åˆ†</h2><h3 id="2-3-1-é€šç”¨ç›®æ ‡"><a href="#2-3-1-é€šç”¨ç›®æ ‡" class="headerlink" title="2.3.1 é€šç”¨ç›®æ ‡"></a>2.3.1 é€šç”¨ç›®æ ‡</h3><h4 id="2-3-1-1-allï¼ˆå®šä¹‰é»˜è®¤ç›®æ ‡ï¼Œè°ƒç”¨buildç›®æ ‡ï¼‰"><a href="#2-3-1-1-allï¼ˆå®šä¹‰é»˜è®¤ç›®æ ‡ï¼Œè°ƒç”¨buildç›®æ ‡ï¼‰" class="headerlink" title="2.3.1.1 allï¼ˆå®šä¹‰é»˜è®¤ç›®æ ‡ï¼Œè°ƒç”¨buildç›®æ ‡ï¼‰"></a>2.3.1.1 allï¼ˆå®šä¹‰é»˜è®¤ç›®æ ‡ï¼Œè°ƒç”¨buildç›®æ ‡ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: all</span><br><span class="line">all: build</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šå®šä¹‰é»˜è®¤ç›®æ ‡ï¼Œè°ƒç”¨buildç›®æ ‡<br>è§£é‡Šï¼šå½“è¿è¡Œmakeæ—¶ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šç›®æ ‡ã€‚é»˜è®¤ä¼šæ‰§è¡Œbuildç›®æ ‡ã€‚</p>
<h4 id="2-3-1-2-helpï¼ˆæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼‰"><a href="#2-3-1-2-helpï¼ˆæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼‰" class="headerlink" title="2.3.1.2 helpï¼ˆæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼‰"></a>2.3.1.2 helpï¼ˆæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: help</span><br><span class="line">help: ## Display this help.</span><br><span class="line">        @awk &#x27;BEGIN &#123;FS = &quot;:.*##&quot;; printf &quot;\nUsage:\n  make \033[36m&lt;target&gt;\033[0m\n&quot;&#125; /^[a-zA-Z_0-9-]+:.*?##/ &#123; printf &quot;  \033[36m%-15s\033[0m %s\n&quot;, $$1, $$2 &#125; /^##@/ &#123; printf &quot;\n\033[1m%s\033[0m\n&quot;, substr($$0, 5) &#125; &#x27; $(MAKEFILE_LIST)</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯<br>è§£é‡Šï¼šä½¿ç”¨awkå‘½ä»¤è§£æMakefile,æå–æ¯ä¸ªç›®æ ‡çš„æè¿°ï¼Œå¹¶æŒ‰ç±»åˆ«ç»„ç»‡æ˜¾ç¤ºã€‚##@è¡¨ç¤ºç±»åˆ«ï¼Œ##è¡¨ç¤ºç›®æ ‡æè¿°</p>
<h3 id="2-3-2-å¼€å‘ç›®æ ‡"><a href="#2-3-2-å¼€å‘ç›®æ ‡" class="headerlink" title="2.3.2 å¼€å‘ç›®æ ‡"></a>2.3.2 å¼€å‘ç›®æ ‡</h3><h4 id="2-3-2-1-manifestsï¼ˆç”ŸæˆWebhookConfigurationã€ClusterRoleå’ŒCustomResourceDefinition-å¯¹è±¡ï¼‰"><a href="#2-3-2-1-manifestsï¼ˆç”ŸæˆWebhookConfigurationã€ClusterRoleå’ŒCustomResourceDefinition-å¯¹è±¡ï¼‰" class="headerlink" title="2.3.2.1 manifestsï¼ˆç”ŸæˆWebhookConfigurationã€ClusterRoleå’ŒCustomResourceDefinition å¯¹è±¡ï¼‰"></a>2.3.2.1 manifestsï¼ˆç”ŸæˆWebhookConfigurationã€ClusterRoleå’ŒCustomResourceDefinition å¯¹è±¡ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: manifests</span><br><span class="line">manifests: controller-gen ## Generate WebhookConfiguration, ClusterRole and CustomResourceDefinition objects.</span><br><span class="line">        $(CONTROLLER_GEN) rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šç”ŸæˆWebhookConfigurationã€ClusterRoleå’ŒCustomResourceDefinition å¯¹è±¡<br>è§£é‡Šï¼šä½¿ç”¨controller-genå·¥å…·ç”Ÿæˆå¿…è¦çš„Kubernetesèµ„æºæ–‡ä»¶ï¼Œå¹¶ä¿å­˜åˆ°config&#x2F;crd&#x2F;basesç›®å½•</p>
<h4 id="2-3-2-2-generateï¼ˆç”ŸæˆåŒ…å«DeepCopyã€DeepCopyInto-å’ŒDeepCopyObjectæ–¹æ³•å®ç°çš„ä»£ç ã€‚ï¼‰"><a href="#2-3-2-2-generateï¼ˆç”ŸæˆåŒ…å«DeepCopyã€DeepCopyInto-å’ŒDeepCopyObjectæ–¹æ³•å®ç°çš„ä»£ç ã€‚ï¼‰" class="headerlink" title="2.3.2.2 generateï¼ˆç”ŸæˆåŒ…å«DeepCopyã€DeepCopyInto, å’ŒDeepCopyObjectæ–¹æ³•å®ç°çš„ä»£ç ã€‚ï¼‰"></a>2.3.2.2 generateï¼ˆç”ŸæˆåŒ…å«DeepCopyã€DeepCopyInto, å’ŒDeepCopyObjectæ–¹æ³•å®ç°çš„ä»£ç ã€‚ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: generate</span><br><span class="line">generate: controller-gen ## Generate code containing DeepCopy, DeepCopyInto, and DeepCopyObject method implementations.</span><br><span class="line">        $(CONTROLLER_GEN) object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šç”ŸæˆåŒ…å«DeepCopyã€DeepCopyInto, å’ŒDeepCopyObjectæ–¹æ³•å®ç°çš„ä»£ç ã€‚<br>è§£é‡Šï¼šä½¿ç”¨controller-genå·¥å…·ç”ŸæˆGOä»£ç ï¼Œè¿™äº›ä»£ç è‡ªåŠ¨ç”Ÿæˆå¯¹è±¡çš„æ·±æ‹·è´æ–¹æ³•ã€‚</p>
<h4 id="2-3-2-3-fmtï¼ˆæ ¼å¼åŒ–ä»£ç ï¼‰"><a href="#2-3-2-3-fmtï¼ˆæ ¼å¼åŒ–ä»£ç ï¼‰" class="headerlink" title="2.3.2.3 fmtï¼ˆæ ¼å¼åŒ–ä»£ç ï¼‰"></a>2.3.2.3 fmtï¼ˆæ ¼å¼åŒ–ä»£ç ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: fmt</span><br><span class="line">fmt: ## Run go fmt against code.</span><br><span class="line">        go fmt ./...</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šæ ¼å¼åŒ–ä»£ç <br>è§£é‡Šï¼šä½¿ç”¨go fmtå‘½ä»¤æ ¼å¼åŒ–é¡¹ç›®ä¸­çš„æ‰€æœ‰Goä»£ç </p>
<h4 id="2-3-2-4-vetï¼ˆæ£€æŸ¥ä»£ç ä¸­çš„æ½œåœ¨é—®é¢˜ï¼‰"><a href="#2-3-2-4-vetï¼ˆæ£€æŸ¥ä»£ç ä¸­çš„æ½œåœ¨é—®é¢˜ï¼‰" class="headerlink" title="2.3.2.4 vetï¼ˆæ£€æŸ¥ä»£ç ä¸­çš„æ½œåœ¨é—®é¢˜ï¼‰"></a>2.3.2.4 vetï¼ˆæ£€æŸ¥ä»£ç ä¸­çš„æ½œåœ¨é—®é¢˜ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: vet</span><br><span class="line">vet: ## Run go vet against code.</span><br><span class="line">        go vet ./...</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šæ£€æŸ¥ä»£ç ä¸­çš„æ½œåœ¨é—®é¢˜<br>è§£é‡Šï¼šä½¿ç”¨go vetå‘½ä»¤æ£€æŸ¥é¡¹ç›®ä¸­çš„æ‰€æœ‰Goä»£ç ï¼ŒæŸ¥æ‰¾å¯èƒ½çš„é—®é¢˜ã€‚</p>
<h4 id="2-3-2-5-testï¼ˆè¿è¡Œæµ‹è¯•ï¼‰"><a href="#2-3-2-5-testï¼ˆè¿è¡Œæµ‹è¯•ï¼‰" class="headerlink" title="2.3.2.5 testï¼ˆè¿è¡Œæµ‹è¯•ï¼‰"></a>2.3.2.5 testï¼ˆè¿è¡Œæµ‹è¯•ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: test</span><br><span class="line">test: manifests generate fmt vet envtest ## Run tests.</span><br><span class="line">        KUBEBUILDER_ASSETS=&quot;$(shell $(ENVTEST) use $(ENVTEST_K8S_VERSION) --bin-dir $(LOCALBIN) -p path)&quot; go test $$(go list ./... | grep -v /e2e) -coverprofile cover.out</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šè¿è¡Œæµ‹è¯•<br>è§£é‡Šï¼š</p>
<ul>
<li>å…ˆè¿è¡Œmanifestsã€generateã€fmtå’Œvetç›®æ ‡</li>
<li>ä½¿ç”¨envtestå·¥å…·è®¾ç½®ç¯å¢ƒå˜é‡KUBEBUILDER_ASSETSï¼Œç„¶åè¿è¡Œé¡¹ç›®ä¸­çš„æ‰€æœ‰æµ‹è¯•(æ’é™¤e2eæµ‹è¯•)</li>
</ul>
<h4 id="2-3-2-6-test-e2eï¼ˆè¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼‰"><a href="#2-3-2-6-test-e2eï¼ˆè¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼‰" class="headerlink" title="2.3.2.6 test-e2eï¼ˆè¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼‰"></a>2.3.2.6 test-e2eï¼ˆè¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Utilize Kind or modify the e2e tests to load the image locally, enabling compatibility with other vendors.</span></span><br><span class="line">.PHONY: test-e2e  # Run the e2e tests against a Kind k8s instance that is spun up.</span><br><span class="line">test-e2e:</span><br><span class="line">        go test ./test/e2e/ -v -ginkgo.v</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šè¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•<br>è§£é‡Šï¼šä½¿ç”¨go testå‘½ä»¤è¿è¡Œtest&#x2F;e2eç›®å½•ä¸­çš„ç«¯åˆ°ç«¯æµ‹è¯•ï¼Œå¹¶å¯åŠ¨è¯¦ç»†è¾“å‡ºã€‚</p>
<h4 id="2-3-2-7-lintï¼ˆè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥ï¼‰"><a href="#2-3-2-7-lintï¼ˆè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥ï¼‰" class="headerlink" title="2.3.2.7 lintï¼ˆè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥ï¼‰"></a>2.3.2.7 lintï¼ˆè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: lint</span><br><span class="line">lint: golangci-lint ## Run golangci-lint linter</span><br><span class="line">        $(GOLANGCI_LINT) run</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥<br>è§£é‡Šï¼šä½¿ç”¨golangci-lintå·¥å…·è¿è¡Œä»£ç é£æ ¼æ£€æŸ¥</p>
<h4 id="2-3-2-8-lint-fix-ï¼ˆè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥å¹¶è‡ªåŠ¨ä¿®å¤é—®é¢˜ï¼‰"><a href="#2-3-2-8-lint-fix-ï¼ˆè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥å¹¶è‡ªåŠ¨ä¿®å¤é—®é¢˜ï¼‰" class="headerlink" title="2.3.2.8 lint-fix ï¼ˆè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥å¹¶è‡ªåŠ¨ä¿®å¤é—®é¢˜ï¼‰"></a>2.3.2.8 lint-fix ï¼ˆè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥å¹¶è‡ªåŠ¨ä¿®å¤é—®é¢˜ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: lint-fix</span><br><span class="line">lint-fix: golangci-lint ## Run golangci-lint linter and perform fixes</span><br><span class="line">        $(GOLANGCI_LINT) run --fix</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥å¹¶è‡ªåŠ¨ä¿®å¤é—®é¢˜<br>è§£é‡Šï¼šä½¿ç”¨golangci-lintå·¥å…·è¿è¡Œä»£ç é£æ ¼æ£€æŸ¥ï¼Œå¹¶ä½¿ç”¨â€“fixé€‰é¡¹è‡ªåŠ¨ä¿®å¤å‘ç°çš„é—®é¢˜ã€‚</p>
<h3 id="2-3-3-æ„å»ºç›®æ ‡"><a href="#2-3-3-æ„å»ºç›®æ ‡" class="headerlink" title="2.3.3 æ„å»ºç›®æ ‡"></a>2.3.3 æ„å»ºç›®æ ‡</h3><h4 id="2-3-3-1-buildï¼ˆæ„å»ºcontrollerçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰"><a href="#2-3-3-1-buildï¼ˆæ„å»ºcontrollerçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰" class="headerlink" title="2.3.3.1 buildï¼ˆæ„å»ºcontrollerçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰"></a>2.3.3.1 buildï¼ˆæ„å»ºcontrollerçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: build</span><br><span class="line">build: manifests generate fmt vet ## Build manager binary.</span><br><span class="line">        go build -o bin/manager cmd/main.go</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šæ„å»ºcontrollerçš„äºŒè¿›åˆ¶æ–‡ä»¶<br>è§£é‡Šï¼š</p>
<ul>
<li>å…ˆè¿è¡Œmanifestsã€generateã€fmtå’Œvetç›®æ ‡</li>
<li>ä½¿ç”¨go buildå‘½ä»¤ç¼–è¯‘cmd&#x2F;main.goæ–‡ä»¶ï¼Œå¹¶å°†ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¿å­˜åˆ°bin&#x2F;managerã€‚</li>
</ul>
<h4 id="2-3-3-2-runï¼ˆåœ¨ä¸»æœºä¸Šè¿è¡Œcontrollerï¼‰"><a href="#2-3-3-2-runï¼ˆåœ¨ä¸»æœºä¸Šè¿è¡Œcontrollerï¼‰" class="headerlink" title="2.3.3.2 runï¼ˆåœ¨ä¸»æœºä¸Šè¿è¡Œcontrollerï¼‰"></a>2.3.3.2 runï¼ˆåœ¨ä¸»æœºä¸Šè¿è¡Œcontrollerï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: run</span><br><span class="line">run: manifests generate fmt vet ## Run a controller from your host.</span><br><span class="line">        go run ./cmd/main.go</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šåœ¨ä¸»æœºä¸Šè¿è¡Œcontroller<br>è§£é‡Šï¼š</p>
<ul>
<li>å…ˆè¿è¡Œmanifestsã€generateã€fmtå’Œvetç›®æ ‡</li>
<li>ä½¿ç”¨go runå‘½ä»¤è¿è¡Œcmd&#x2F;main.goæ–‡ä»¶</li>
</ul>
<h4 id="2-3-3-3-docker-buildï¼ˆæ„å»ºDockeré•œåƒï¼‰"><a href="#2-3-3-3-docker-buildï¼ˆæ„å»ºDockeré•œåƒï¼‰" class="headerlink" title="2.3.3.3 docker-buildï¼ˆæ„å»ºDockeré•œåƒï¼‰"></a>2.3.3.3 docker-buildï¼ˆæ„å»ºDockeré•œåƒï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">If you wish to build the manager image targeting other platforms you can use the --platform flag.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(i.e. docker build --platform linux/arm64). However, you must <span class="built_in">enable</span> docker buildKit <span class="keyword">for</span> it.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">More info: https://docs.docker.com/develop/develop-images/build_enhancements/</span></span><br><span class="line">.PHONY: docker-build</span><br><span class="line">docker-build: ## Build docker image with the manager.</span><br><span class="line">        $(CONTAINER_TOOL) build -t $&#123;IMG&#125; .</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šæ„å»ºDockeré•œåƒ<br>è§£é‡Šï¼šä½¿ç”¨CONTAINER_TOOL(é»˜è®¤ä¸ºdocker)æ„å»ºdockeré•œåƒï¼Œå¹¶ä½¿ç”¨IMGå˜é‡æŒ‡å®šé•œåƒåç§°å’Œæ ‡ç­¾</p>
<h4 id="2-3-3-4-docker-pushï¼ˆæ¨é€Dockeré•œåƒï¼‰"><a href="#2-3-3-4-docker-pushï¼ˆæ¨é€Dockeré•œåƒï¼‰" class="headerlink" title="2.3.3.4 docker-pushï¼ˆæ¨é€Dockeré•œåƒï¼‰"></a>2.3.3.4 docker-pushï¼ˆæ¨é€Dockeré•œåƒï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: docker-push</span><br><span class="line">docker-push: ## Push docker image with the manager.</span><br><span class="line">        $(CONTAINER_TOOL) push $&#123;IMG&#125;</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šæ¨é€Dockeré•œåƒ<br>è§£é‡Šï¼šä½¿ç”¨CONTAINER_TOOL(é»˜è®¤ä¸ºdocker)æ¨é€æ„å»ºå¥½çš„Dockeré•œåƒåˆ°æŒ‡å®šçš„ä»“åº“</p>
<h4 id="2-3-3-5-docker-buildxï¼ˆæ„å»ºå¹¶æ¨é€å¤šå¹³å°æ”¯æŒçš„Dockeré•œåƒï¼‰"><a href="#2-3-3-5-docker-buildxï¼ˆæ„å»ºå¹¶æ¨é€å¤šå¹³å°æ”¯æŒçš„Dockeré•œåƒï¼‰" class="headerlink" title="2.3.3.5 docker-buildxï¼ˆæ„å»ºå¹¶æ¨é€å¤šå¹³å°æ”¯æŒçš„Dockeré•œåƒï¼‰"></a>2.3.3.5 docker-buildxï¼ˆæ„å»ºå¹¶æ¨é€å¤šå¹³å°æ”¯æŒçš„Dockeré•œåƒï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">PLATFORMS defines the target platforms <span class="keyword">for</span> the manager image be built to provide support to multiple</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">architectures. (i.e. make docker-buildx IMG=myregistry/mypoperator:0.0.1). To use this option you need to:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- be able to use docker buildx. More info: https://docs.docker.com/build/buildx/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- have enabled BuildKit. More info: https://docs.docker.com/develop/develop-images/build_enhancements/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- be able to push the image to your registry (i.e. <span class="keyword">if</span> you <span class="keyword">do</span> not <span class="built_in">set</span> a valid value via IMG=&lt;myregistry/image:&lt;tag&gt;&gt; <span class="keyword">then</span> the <span class="built_in">export</span> will fail)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">To adequately provide solutions that are compatible with multiple platforms, you should consider using this option.</span></span><br><span class="line">PLATFORMS ?= linux/arm64,linux/amd64,linux/s390x,linux/ppc64le</span><br><span class="line">.PHONY: docker-buildx</span><br><span class="line">docker-buildx: ## Build and push docker image for the manager for cross-platform support</span><br><span class="line">        # copy existing Dockerfile and insert --platform=$&#123;BUILDPLATFORM&#125; into Dockerfile.cross, and preserve the original Dockerfile</span><br><span class="line">        sed -e &#x27;1 s/\(^FROM\)/FROM --platform=\$$\&#123;BUILDPLATFORM\&#125;/; t&#x27; -e &#x27; 1,// s//FROM --platform=\$$\&#123;BUILDPLATFORM\&#125;/&#x27; Dockerfile &gt; Dockerfile.cross</span><br><span class="line">        - $(CONTAINER_TOOL) buildx create --name myapp-operator-builder</span><br><span class="line">        $(CONTAINER_TOOL) buildx use myapp-operator-builder</span><br><span class="line">        - $(CONTAINER_TOOL) buildx build --push --platform=$(PLATFORMS) --tag $&#123;IMG&#125; -f Dockerfile.cross .</span><br><span class="line">        - $(CONTAINER_TOOL) buildx rm myapp-operator-builder</span><br><span class="line">        rm Dockerfile.cross</span><br></pre></td></tr></table></figure>

<p>ä½œç”¨ï¼šæ„å»ºå¹¶æ¨é€å¤šå¹³å°æ”¯æŒçš„Dockeré•œåƒ<br>è§£é‡Šï¼š</p>
<ul>
<li>ä½¿ç”¨sedå‘½ä»¤å¤åˆ¶ç°æœ‰çš„Dockerfileå¹¶æ’å…¥â€“platform&#x3D;${BUILDPLATFORM}é€‰é¡¹,ç”ŸæˆDockerfile.cross</li>
<li>åˆ›å»ºä¸€ä¸ªåä¸ºmyapp-builderçš„æ„å»ºå™¨</li>
<li>ä½¿ç”¨buildxæ„å»ºå¹¶æ¨é€å¤šå¹³å°é•œåƒ</li>
<li>åˆ é™¤æ„å»ºå™¨å’Œä¸´æ—¶ç”Ÿæˆçš„Dockerfile.cross</li>
</ul>
<h4 id="2-3-3-6-docker-installerï¼ˆç”ŸæˆåŒ…å«CRDså’Œéƒ¨ç½²çš„åˆå¹¶YAMLæ–‡ä»¶ï¼‰"><a href="#2-3-3-6-docker-installerï¼ˆç”ŸæˆåŒ…å«CRDså’Œéƒ¨ç½²çš„åˆå¹¶YAMLæ–‡ä»¶ï¼‰" class="headerlink" title="2.3.3.6 docker-installerï¼ˆç”ŸæˆåŒ…å«CRDså’Œéƒ¨ç½²çš„åˆå¹¶YAMLæ–‡ä»¶ï¼‰"></a>2.3.3.6 docker-installerï¼ˆç”ŸæˆåŒ…å«CRDså’Œéƒ¨ç½²çš„åˆå¹¶YAMLæ–‡ä»¶ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: build-installer</span><br><span class="line">build-installer: manifests generate kustomize ## Generate a consolidated YAML with CRDs and deployment.</span><br><span class="line">        mkdir -p dist</span><br><span class="line">        cd config/manager &amp;&amp; $(KUSTOMIZE) edit set image controller=$&#123;IMG&#125;</span><br><span class="line">        $(KUSTOMIZE) build config/default &gt; dist/install.yaml</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šç”ŸæˆåŒ…å«CRDså’Œéƒ¨ç½²çš„åˆå¹¶YAMLæ–‡ä»¶<br>è§£é‡Šï¼š</p>
<ul>
<li>åˆ›å»ºdistç›®å½•</li>
<li>ä½¿ç”¨kustomizeå·¥å…·è®¾ç½®controlleré•œåƒä¸ºIMG</li>
<li>ä½¿ç”¨kustomizeæ„å»ºconfig&#x2F;defaultç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä¿å­˜åˆ°dist&#x2F;install.yaml</li>
</ul>
<h3 id="2-3-4-éƒ¨ç½²ç›®æ ‡"><a href="#2-3-4-éƒ¨ç½²ç›®æ ‡" class="headerlink" title="2.3.4 éƒ¨ç½²ç›®æ ‡"></a>2.3.4 éƒ¨ç½²ç›®æ ‡</h3><h4 id="2-3-4-1-installï¼ˆå®‰è£…CRDsåˆ°Kubernetesé›†ç¾¤ï¼‰"><a href="#2-3-4-1-installï¼ˆå®‰è£…CRDsåˆ°Kubernetesé›†ç¾¤ï¼‰" class="headerlink" title="2.3.4.1 installï¼ˆå®‰è£…CRDsåˆ°Kubernetesé›†ç¾¤ï¼‰"></a>2.3.4.1 installï¼ˆå®‰è£…CRDsåˆ°Kubernetesé›†ç¾¤ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: install</span><br><span class="line">install: manifests kustomize ## Install CRDs into the K8s cluster specified in ~/.kube/config.</span><br><span class="line">        $(KUSTOMIZE) build config/crd | $(KUBECTL) apply -f -</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šå®‰è£…CRDsåˆ°Kubernetesé›†ç¾¤<br>è§£é‡Šï¼š</p>
<ul>
<li>å…ˆè¿è¡Œmanifestså’Œkustomizeç›®æ ‡</li>
<li>ä½¿ç”¨kustomize æ„å»ºconfig&#x2F;crdç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶åº”ç”¨åˆ°é›†ç¾¤ã€‚</li>
</ul>
<h4 id="2-3-4-2-uninstallï¼ˆä»Kubernetesé›†ç¾¤å¸è½½CRDsï¼‰"><a href="#2-3-4-2-uninstallï¼ˆä»Kubernetesé›†ç¾¤å¸è½½CRDsï¼‰" class="headerlink" title="2.3.4.2 uninstallï¼ˆä»Kubernetesé›†ç¾¤å¸è½½CRDsï¼‰"></a>2.3.4.2 uninstallï¼ˆä»Kubernetesé›†ç¾¤å¸è½½CRDsï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: uninstall</span><br><span class="line">uninstall: manifests kustomize ## Uninstall CRDs from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.</span><br><span class="line">        $(KUSTOMIZE) build config/crd | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -</span><br></pre></td></tr></table></figure>

<p>ä½œç”¨ï¼šä»Kubernetesé›†ç¾¤å¸è½½CRDs<br>è§£é‡Šï¼š</p>
<ul>
<li>å…ˆè¿è¡Œmanifestså’Œkustomizeç›®æ ‡</li>
<li>ä½¿ç”¨kustomize æ„å»ºconfig&#x2F;crdç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶ä»é›†ç¾¤ä¸­åˆ é™¤ï¼Œå¯ä»¥é€šè¿‡ignore-not-found&#x3D;trueå¿½ç•¥èµ„æºæœªæ‰¾åˆ°çš„é”™è¯¯</li>
</ul>
<h4 id="2-3-4-3-deployï¼ˆéƒ¨ç½²controlleråˆ°Kubernetesé›†ç¾¤ï¼‰"><a href="#2-3-4-3-deployï¼ˆéƒ¨ç½²controlleråˆ°Kubernetesé›†ç¾¤ï¼‰" class="headerlink" title="2.3.4.3 deployï¼ˆéƒ¨ç½²controlleråˆ°Kubernetesé›†ç¾¤ï¼‰"></a>2.3.4.3 deployï¼ˆéƒ¨ç½²controlleråˆ°Kubernetesé›†ç¾¤ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: deploy</span><br><span class="line">deploy: manifests kustomize ## Deploy controller to the K8s cluster specified in ~/.kube/config.</span><br><span class="line">        cd config/manager &amp;&amp; $(KUSTOMIZE) edit set image controller=$&#123;IMG&#125;</span><br><span class="line">        $(KUSTOMIZE) build config/default | $(KUBECTL) apply -f -</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šéƒ¨ç½²controlleråˆ°Kubernetesé›†ç¾¤<br>è§£é‡Šï¼š</p>
<ul>
<li>å…ˆè¿è¡Œmanifestså’Œkustomizeç›®æ ‡</li>
<li>ä½¿ç”¨kustomizeè®¾ç½®controlleré•œåƒä¸ºIMG</li>
<li>ä½¿ç”¨kustomizeæ„å»ºconfig&#x2F;defaultç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶åº”ç”¨åˆ°é›†ç¾¤</li>
</ul>
<h4 id="2-3-4-4-undeployï¼ˆä»Kubernetesé›†ç¾¤ä¸­å¸è½½Controllerï¼‰"><a href="#2-3-4-4-undeployï¼ˆä»Kubernetesé›†ç¾¤ä¸­å¸è½½Controllerï¼‰" class="headerlink" title="2.3.4.4 undeployï¼ˆä»Kubernetesé›†ç¾¤ä¸­å¸è½½Controllerï¼‰"></a>2.3.4.4 undeployï¼ˆä»Kubernetesé›†ç¾¤ä¸­å¸è½½Controllerï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: undeploy</span><br><span class="line">undeploy: kustomize ## Undeploy controller from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.</span><br><span class="line">        $(KUSTOMIZE) build config/default | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šä»Kubernetesé›†ç¾¤ä¸­å¸è½½Controller<br>è§£é‡Šï¼šä½¿ç”¨kustomize æ„å»ºconfig&#x2F;defaultç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶ä»é›†ç¾¤ä¸­åˆ é™¤ã€‚å¯ä»¥é€šè¿‡ignore-not-found&#x3D;trueå¿½ç•¥èµ„æºæœªæ‰¾åˆ°çš„é”™è¯¯</p>
<h3 id="2-3-5-ä¾èµ–ç›®æ ‡"><a href="#2-3-5-ä¾èµ–ç›®æ ‡" class="headerlink" title="2.3.5 ä¾èµ–ç›®æ ‡"></a>2.3.5 ä¾èµ–ç›®æ ‡</h3><h4 id="2-3-5-1-ignore-not-foundï¼ˆå®šä¹‰ignore-not-foundå˜é‡ï¼Œé»˜è®¤å€¼ä¸ºfalseï¼‰"><a href="#2-3-5-1-ignore-not-foundï¼ˆå®šä¹‰ignore-not-foundå˜é‡ï¼Œé»˜è®¤å€¼ä¸ºfalseï¼‰" class="headerlink" title="2.3.5.1 ignore-not-foundï¼ˆå®šä¹‰ignore-not-foundå˜é‡ï¼Œé»˜è®¤å€¼ä¸ºfalseï¼‰"></a>2.3.5.1 ignore-not-foundï¼ˆå®šä¹‰ignore-not-foundå˜é‡ï¼Œé»˜è®¤å€¼ä¸ºfalseï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ifndef ignore-not-found</span><br><span class="line">  ignore-not-found = false</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šå®šä¹‰ignore-not-foundå˜é‡ï¼Œé»˜è®¤å€¼ä¸ºfalse<br>è§£é‡Šï¼šå¦‚æœå‘½ä»¤è¡Œä¸­æœªæŒ‡å®šignore-not-foundï¼Œåˆ™é»˜è®¤å€¼ä¸ºfalse</p>
<h4 id="2-3-5-2-LOCALBINï¼ˆå®šä¹‰æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶çš„å®‰è£…ç›®å½•ï¼‰"><a href="#2-3-5-2-LOCALBINï¼ˆå®šä¹‰æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶çš„å®‰è£…ç›®å½•ï¼‰" class="headerlink" title="2.3.5.2 LOCALBINï¼ˆå®šä¹‰æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶çš„å®‰è£…ç›®å½•ï¼‰"></a>2.3.5.2 LOCALBINï¼ˆå®šä¹‰æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶çš„å®‰è£…ç›®å½•ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Location to install dependencies to</span></span></span><br><span class="line">LOCALBIN ?= $(shell pwd)/bin</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(LOCALBIN):</span></span><br><span class="line">        mkdir -p $(LOCALBIN)</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šå®šä¹‰æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶çš„å®‰è£…ç›®å½•ï¼Œé»˜è®¤ä¸ºå½“å‰ç›®å½•ä¸‹çš„binç›®å½•<br>è§£é‡Šï¼šå¦‚æœLOCALBINæœªè®¾ç½®ï¼Œåˆ™é»˜è®¤ä¸º$(shell pwd)&#x2F;binã€‚å¦‚æœLOCALBINç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå®ƒã€‚</p>
<h4 id="2-3-5-3-å·¥å…·äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå®šä¹‰å„ç§å·¥å…·çš„è·¯å¾„å’Œé»˜è®¤å€¼ï¼‰"><a href="#2-3-5-3-å·¥å…·äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå®šä¹‰å„ç§å·¥å…·çš„è·¯å¾„å’Œé»˜è®¤å€¼ï¼‰" class="headerlink" title="2.3.5.3 å·¥å…·äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå®šä¹‰å„ç§å·¥å…·çš„è·¯å¾„å’Œé»˜è®¤å€¼ï¼‰"></a>2.3.5.3 å·¥å…·äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå®šä¹‰å„ç§å·¥å…·çš„è·¯å¾„å’Œé»˜è®¤å€¼ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Tool Binaries</span></span></span><br><span class="line">KUBECTL ?= kubectl</span><br><span class="line">KUSTOMIZE ?= $(LOCALBIN)/kustomize</span><br><span class="line">CONTROLLER_GEN ?= $(LOCALBIN)/controller-gen</span><br><span class="line">ENVTEST ?= $(LOCALBIN)/setup-envtest</span><br><span class="line">GOLANGCI_LINT = $(LOCALBIN)/golangci-lint</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šå®šä¹‰å„ç§å·¥å…·çš„è·¯å¾„å’Œé»˜è®¤å€¼<br>è§£é‡Šï¼š</p>
<ul>
<li>KUBECTLï¼šé»˜è®¤ä¸ºkubectl</li>
<li>KUSTOMIZEï¼šé»˜è®¤ä¸º$(LOCALBIN)&#x2F;kustomize</li>
<li>CONTROLLER_GENï¼šé»˜è®¤ä¸º$(LOCALBIN)&#x2F;controller-gen</li>
<li>ENVTESTï¼šé»˜è®¤ä¸º$(LOCALBIN)&#x2F;setup-envtest</li>
<li>GOLANGCI_LINTï¼š é»˜è®¤ä¸º$(LOCALBIN)&#x2F;golangci-lint</li>
</ul>
<h4 id="2-3-5-4-å·¥å…·ç‰ˆæœ¬ï¼ˆå®šä¹‰å„ä¸ªå·¥å…·çš„ç‰ˆæœ¬ï¼‰"><a href="#2-3-5-4-å·¥å…·ç‰ˆæœ¬ï¼ˆå®šä¹‰å„ä¸ªå·¥å…·çš„ç‰ˆæœ¬ï¼‰" class="headerlink" title="2.3.5.4 å·¥å…·ç‰ˆæœ¬ï¼ˆå®šä¹‰å„ä¸ªå·¥å…·çš„ç‰ˆæœ¬ï¼‰"></a>2.3.5.4 å·¥å…·ç‰ˆæœ¬ï¼ˆå®šä¹‰å„ä¸ªå·¥å…·çš„ç‰ˆæœ¬ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Tool Versions</span></span></span><br><span class="line">KUSTOMIZE_VERSION ?= v5.4.3</span><br><span class="line">CONTROLLER_TOOLS_VERSION ?= v0.16.1</span><br><span class="line">ENVTEST_VERSION ?= release-0.19</span><br><span class="line">GOLANGCI_LINT_VERSION ?= v1.59.1</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šå®šä¹‰å„ä¸ªå·¥å…·çš„ç‰ˆæœ¬<br>è§£é‡Šï¼š</p>
<ul>
<li>KUSTOMIZE_VERSIONï¼šé»˜è®¤ä¸ºv5.4.3</li>
<li>CONTROLLER_TOOLS_VERSIONï¼šé»˜è®¤ä¸ºv0.16.1</li>
<li>ENVTEST_VERSIONï¼šé»˜è®¤ä¸ºrelease-0.19</li>
<li>GOLANGCI_LINT_VERSIONï¼šé»˜è®¤ä¸ºv1.59.1</li>
</ul>
<h4 id="2-3-5-5-kustomizeï¼ˆä¸‹è½½kustomizeå·¥å…·ï¼‰"><a href="#2-3-5-5-kustomizeï¼ˆä¸‹è½½kustomizeå·¥å…·ï¼‰" class="headerlink" title="2.3.5.5 kustomizeï¼ˆä¸‹è½½kustomizeå·¥å…·ï¼‰"></a>2.3.5.5 kustomizeï¼ˆä¸‹è½½kustomizeå·¥å…·ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: kustomize</span><br><span class="line">kustomize: $(KUSTOMIZE) ## Download kustomize locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(KUSTOMIZE): $(LOCALBIN)</span></span><br><span class="line">        $(call go-install-tool,$(KUSTOMIZE),sigs.k8s.io/kustomize/kustomize/v5,$(KUSTOMIZE_VERSION))</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šä¸‹è½½kustomizeå·¥å…·(å¦‚æœ‰å¿…è¦)<br>è§£é‡Šï¼šå¦‚æœkustomizeæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ go-install-toolå‡½æ•°ä¸‹è½½kustomizeå·¥å…·</p>
<h4 id="2-3-5-6-controller-genï¼ˆä¸‹è½½controller-genå·¥å…·ï¼‰"><a href="#2-3-5-6-controller-genï¼ˆä¸‹è½½controller-genå·¥å…·ï¼‰" class="headerlink" title="2.3.5.6 controller-genï¼ˆä¸‹è½½controller-genå·¥å…·ï¼‰"></a>2.3.5.6 controller-genï¼ˆä¸‹è½½controller-genå·¥å…·ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: controller-gen</span><br><span class="line">controller-gen: $(CONTROLLER_GEN) ## Download controller-gen locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(CONTROLLER_GEN): $(LOCALBIN)</span></span><br><span class="line">        $(call go-install-tool,$(CONTROLLER_GEN),sigs.k8s.io/controller-tools/cmd/controller-gen,$(CONTROLLER_TOOLS_VERSION))</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šä¸‹è½½controller-genå·¥å…·(å¦‚æœ‰å¿…è¦)<br>è§£é‡Šï¼šå¦‚æœ$(CONTROLLER_GEN)æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ go-install-toolå‡½æ•°ä¸‹è½½controller-genå·¥å…·</p>
<h4 id="2-3-5-7-envtestï¼ˆä¸‹è½½setup-envtestå·¥å…·ï¼‰"><a href="#2-3-5-7-envtestï¼ˆä¸‹è½½setup-envtestå·¥å…·ï¼‰" class="headerlink" title="2.3.5.7 envtestï¼ˆä¸‹è½½setup-envtestå·¥å…·ï¼‰"></a>2.3.5.7 envtestï¼ˆä¸‹è½½setup-envtestå·¥å…·ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: envtest</span><br><span class="line">envtest: $(ENVTEST) ## Download setup-envtest locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(ENVTEST): $(LOCALBIN)</span></span><br><span class="line">        $(call go-install-tool,$(ENVTEST),sigs.k8s.io/controller-runtime/tools/setup-envtest,$(ENVTEST_VERSION))</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šä¸‹è½½setup-envtestå·¥å…·(å¦‚æœ‰å¿…è¦)<br>è§£é‡Šï¼šå¦‚æœ$(ENVTEST)æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨go-install-toolå‡½æ•°ä¸‹è½½setup-envteså·¥å…·</p>
<h4 id="2-3-5-8-golangci-lintï¼ˆä¸‹è½½golangci-lintå·¥å…·ï¼‰"><a href="#2-3-5-8-golangci-lintï¼ˆä¸‹è½½golangci-lintå·¥å…·ï¼‰" class="headerlink" title="2.3.5.8 golangci-lintï¼ˆä¸‹è½½golangci-lintå·¥å…·ï¼‰"></a>2.3.5.8 golangci-lintï¼ˆä¸‹è½½golangci-lintå·¥å…·ï¼‰</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: golangci-lint</span><br><span class="line">golangci-lint: $(GOLANGCI_LINT) ## Download golangci-lint locally if necessary.</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(GOLANGCI_LINT): $(LOCALBIN)</span></span><br><span class="line">        $(call go-install-tool,$(GOLANGCI_LINT),github.com/golangci/golangci-lint/cmd/golangci-lint,$(GOLANGCI_LINT_VERSION))</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šä¸‹è½½golangci-lintå·¥å…·(å¦‚æœ‰å¿…è¦)<br>è§£é‡Šï¼šå¦‚æœ$(GOLANGCI_LINT)æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨go-install-toolå‡½æ•°ä¸‹è½½golangci-lintå·¥å…·ã€‚</p>
<h2 id="2-4-è‡ªå®šä¹‰å‡½æ•°"><a href="#2-4-è‡ªå®šä¹‰å‡½æ•°" class="headerlink" title="2.4 è‡ªå®šä¹‰å‡½æ•°"></a>2.4 è‡ªå®šä¹‰å‡½æ•°</h2><h3 id="2-4-1-go-install-toolï¼ˆä¸‹è½½å¹¶å®‰è£…æŒ‡å®šçš„GoåŒ…ï¼‰"><a href="#2-4-1-go-install-toolï¼ˆä¸‹è½½å¹¶å®‰è£…æŒ‡å®šçš„GoåŒ…ï¼‰" class="headerlink" title="2.4.1 go-install-toolï¼ˆä¸‹è½½å¹¶å®‰è£…æŒ‡å®šçš„GoåŒ…ï¼‰"></a>2.4.1 go-install-toolï¼ˆä¸‹è½½å¹¶å®‰è£…æŒ‡å®šçš„GoåŒ…ï¼‰</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">go-install-tool will <span class="string">&#x27;go install&#x27;</span> any package with custom target and name of binary, <span class="keyword">if</span> it doesn<span class="string">&#x27;t exist</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">$1 - target path with name of binary</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">$2 - package url which can be installed</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">$3 - specific version of package</span></span></span><br><span class="line">define go-install-tool</span><br><span class="line">@[ -f &quot;$(1)-$(3)&quot; ] || &#123; \</span><br><span class="line">set -e; \</span><br><span class="line">package=$(2)@$(3) ;\</span><br><span class="line">echo &quot;Downloading $$&#123;package&#125;&quot; ;\</span><br><span class="line">rm -f $(1) || true ;\</span><br><span class="line">GOBIN=$(LOCALBIN) go install $$&#123;package&#125; ;\</span><br><span class="line">mv $(1) $(1)-$(3) ;\</span><br><span class="line">&#125; ;\</span><br><span class="line">ln -sf $(1)-$(3) $(1)</span><br><span class="line">endef</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šä¸‹è½½å¹¶å®‰è£…æŒ‡å®šçš„GoåŒ…<br>è§£é‡Šï¼š</p>
<ul>
<li>$1ï¼šç›®æ ‡è·¯å¾„å’ŒäºŒè¿›åˆ¶æ–‡ä»¶å</li>
<li>$2ï¼šåŒ…çš„URL</li>
<li>$3:åŒ…çš„å…·ä½“ç‰ˆæœ¬</li>
<li>å¦‚æœç›®æ ‡æ–‡ä»¶$(1)~$(3)ä¸å­˜åœ¨ï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ­¥éª¤</li>
<li>è®¾ç½®set -eï¼Œç¡®ä¿ä»»ä½•å‘½ä»¤æ‰§è¡Œå¤±è´¥ç«‹å³é€€å‡º</li>
<li>è®¾ç½®packageå˜é‡ä¸ºåŒ…çš„URLå’Œç‰ˆæœ¬</li>
<li>è¾“å‡ºä¸‹è½½ä¿¡æ¯</li>
<li>åˆ é™¤æ—§çš„äºŒè¿›åˆ¶æ–‡ä»¶(å¦‚æœå­˜åœ¨)</li>
<li>ä½¿ç”¨go installå‘½ä»¤å®‰è£…åŒ…ï¼Œå¹¶å°†äºŒè¿›åˆ¶æ–‡ä»¶ä¿å­˜åœ¨LOCALBINç›®å½•</li>
<li>å°†ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶é‡å‘½ä»¤ä¸º$(1)-$(3)</li>
<li>æœ€ååˆ›å»ºä¸€ä¸ªç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘$(1)-$(3)</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Kustomizeä¸Helmå¯¹æ¯”</title>
    <url>/2025/07/kubernetes/Operator%E5%BC%80%E5%8F%91/Kustomize%E4%B8%8EHelm%E5%AF%B9%E6%AF%94/</url>
    <content><![CDATA[<h1 id="0ã€å‰è¨€"><a href="#0ã€å‰è¨€" class="headerlink" title="0ã€å‰è¨€"></a>0ã€å‰è¨€</h1><p>K8s æ˜¯ä¸€ä¸ªå¼€æºå®¹å™¨ç¼–æ’å¹³å°ï¼Œå¯è‡ªåŠ¨æ‰§è¡Œå®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†ã€‚è¿‘å¹´æ¥ï¼ŒK8s å·²æˆä¸ºé‡‡ç”¨äº‘åŸç”Ÿæ¶æ„å’Œå®¹å™¨åŒ–æŠ€æœ¯çš„ç»„ç»‡çš„æ ‡å‡†ã€‚</p>
<p>ä½†æ˜¯ç”±äºK8sçš„å¤æ‚æ€§ï¼Œæ‰€ä»¥å¾ˆå¤šå…¬å¸ä»¥åŠå¼€æºç»„ç»‡éƒ½åœ¨å¼€å‘ç›¸å…³çš„å·¥å…·æ¥ç®€åŒ–k8sçš„ä½¿ç”¨é—¨æ§›ï¼Œè¿™å…¶ä¸­å°±åŒ…æ‹¬ä¸¤ä¸ªå¾ˆä¼˜ç§€çš„å¼€æºå·¥å…·ï¼ŒKustomize<br>ï¼ˆK8s çš„é…ç½®ç®¡ç†å™¨ï¼‰å’ŒHelm ï¼ˆK8s çš„åŒ…ç®¡ç†å™¨ï¼‰ã€‚</p>
<p>æœ¬æ–‡å°†é’ˆå¯¹äºŒè€…æ¥è¿›è¡Œå¯¹æ¯”ã€‚</p>
<table>
<thead>
<tr>
<th></th>
<th>Kustomize</th>
<th>Helm</th>
</tr>
</thead>
<tbody><tr>
<td>æ“ä½œæ–¹æ³•</td>
<td>overlays</td>
<td>templating</td>
</tr>
<tr>
<td>ä½¿ç”¨æˆæœ¬</td>
<td>ç®€å•</td>
<td>å¤æ‚</td>
</tr>
<tr>
<td>æ˜¯å¦æ”¯æŒå°è£…</td>
<td>ç®€å•</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>kubectlé›†æˆ</td>
<td>æ˜¯</td>
<td>å¦</td>
</tr>
<tr>
<td>kubectlé›†æˆ</td>
<td>å£°æ˜å¼</td>
<td>å‘½ä»¤å¼</td>
</tr>
</tbody></table>
<h1 id="1ã€Kustomize"><a href="#1ã€Kustomize" class="headerlink" title="1ã€Kustomize"></a>1ã€Kustomize</h1><p>Kustomize æ˜¯ k8sé›†ç¾¤çš„é…ç½®å®šåˆ¶å·¥å…·ã€‚å®ƒå…è®¸ç®¡ç†å‘˜ä½¿ç”¨éæ¨¡æ¿æ–‡ä»¶è¿›è¡Œå£°æ˜æ€§æ›´æ”¹ï¼Œè€Œä¸å½±å“åŸå§‹æ¸…å•æ–‡ä»¶ã€‚</p>
<p>æ¥çœ‹ä¸€ä¸‹kubebuilderç”Ÿæˆé¡¹ç›®çš„Kustomizeé…ç½®ï¼Œä»¥&#x2F;config&#x2F;crdç›®å½•ä¸ºä¾‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ crd</span><br><span class="line">â”‚   â”œâ”€â”€ bases</span><br><span class="line">â”‚   â”‚   â””â”€â”€ apps.kubenode.alibaba-inc.com_myapps.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ kustomizeconfig.yaml</span><br><span class="line">â”‚   â””â”€â”€ patches</span><br><span class="line">â”‚       â”œâ”€â”€ cainjection_in_myapps.yaml</span><br><span class="line">â”‚       â””â”€â”€ webhook_in_myapps.yaml</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­config&#x2F;crdç›®å½•æ˜¯æ‰§è¡Œ<code>kubebuilder create api</code>åç”Ÿæˆçš„ï¼Œæœ€åŸå§‹çš„ç›®å½•ç»“æ„æ˜¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ crd</span><br><span class="line">â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â””â”€â”€ kustomizeconfig.yaml</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥baseså­ç›®å½•å’Œpatcheså­ç›®å½•éƒ½æ˜¯æ‰§è¡Œ<code>make manifests</code>åç”Ÿæˆçš„ã€‚</p>
<p>æ‰§è¡Œ<code>kubebuilder create api</code>å¯ä»¥å‚è€ƒï¼š<a href="https://blog.csdn.net/qq_41004932/article/details/142702284">https://blog.csdn.net/qq_41004932/article/details/142702284</a></p>
<p>æ‰§è¡Œ<code>make manifests</code>å¯ä»¥å‚è€ƒï¼š<a href="https://blog.csdn.net/qq_41004932/article/details/142703870">https://blog.csdn.net/qq_41004932/article/details/142703870</a></p>
<p>åœ¨ Kubebuilder ç”Ÿæˆçš„é¡¹ç›®ä¸­ï¼Œconfig&#x2F;crd ç›®å½•ä¸‹çš„æ–‡ä»¶ä¸»è¦ç”¨äºç®¡ç†å’Œé…ç½®è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCustom Resource Definitions, CRDsï¼‰ã€‚è¿™äº›æ–‡ä»¶é€šè¿‡ Kustomize å·¥å…·è¿›è¡Œç®¡ç†ï¼Œä»¥ä¾¿äºåœ¨ä¸åŒçš„ç¯å¢ƒä¸­éƒ¨ç½²å’Œç®¡ç† CRDsã€‚ä¸‹é¢æ˜¯æ¯ä¸ªæ–‡ä»¶çš„ä½œç”¨è§£é‡Šï¼š</p>
<ol>
<li>bases ç›®å½•<br>bases&#x2F;apps.kubenode.alibaba-inc.com_myapps.yaml:<br>è¿™ä¸ªæ–‡ä»¶åŒ…å«äº†è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCRDï¼‰çš„ YAML æè¿°ã€‚å®ƒå®šä¹‰äº†ä½ çš„è‡ªå®šä¹‰èµ„æºï¼ˆCustom Resource, CRï¼‰çš„ç»“æ„å’Œå…ƒæ•°æ®ã€‚<br>ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º MyApp çš„è‡ªå®šä¹‰èµ„æºï¼Œè¿™ä¸ªæ–‡ä»¶å°†æè¿° MyApp çš„ API ç‰ˆæœ¬ã€èµ„æºåç§°ã€å­—æ®µç­‰ã€‚</li>
<li>kustomization.yaml:<br>è¿™ä¸ªæ–‡ä»¶æ˜¯ Kustomize çš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰å¦‚ä½•ç»„åˆå’Œä¿®æ”¹ Kubernetes èµ„æºæ–‡ä»¶ã€‚<br>å®ƒæŒ‡å®šäº†å“ªäº›èµ„æºæ–‡ä»¶ï¼ˆå¦‚ CRD æ–‡ä»¶ï¼‰éœ€è¦è¢«åº”ç”¨ï¼Œå¹¶ä¸”å¯ä»¥åŒ…å«è¡¥ä¸æ–‡ä»¶å’Œå…¶ä»–é…ç½®é€‰é¡¹ã€‚<br>ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥æŒ‡å®š bases ç›®å½•ä¸­çš„ CRD æ–‡ä»¶ï¼Œä»¥åŠ patches ç›®å½•ä¸­çš„è¡¥ä¸æ–‡ä»¶ã€‚</li>
<li>kustomizeconfig.yaml:<br>è¿™ä¸ªæ–‡ä»¶é€šå¸¸ç”¨äºé…ç½® Kustomize çš„ä¸€äº›é«˜çº§é€‰é¡¹ï¼Œä½†åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­å¯èƒ½ä¸æ˜¯å¿…éœ€çš„ã€‚å®ƒå¯èƒ½ä¼šåŒ…å«ä¸€äº›ç‰¹å®šçš„é…ç½®é¡¹ï¼Œç”¨äºå®šåˆ¶ Kustomize çš„è¡Œä¸ºã€‚<br>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ–‡ä»¶å¯èƒ½ä¸éœ€è¦æ‰‹åŠ¨ç¼–è¾‘ã€‚</li>
<li>patches&#x2F;cainjection_in_myapps.yaml:<br>è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ªè¡¥ä¸æ–‡ä»¶ï¼Œç”¨äºåœ¨ CRD ä¸Šåº”ç”¨ Webhook æ³¨å…¥ï¼ˆä¾‹å¦‚ï¼Œè¯ä¹¦æ³¨å…¥ï¼‰ã€‚<br>ä¾‹å¦‚ï¼Œå¦‚æœä½ çš„ CRD éœ€è¦ä¸ mutating æˆ– validating webhooks ä¸€èµ·å·¥ä½œï¼Œè¿™ä¸ªè¡¥ä¸æ–‡ä»¶ä¼šç¡®ä¿ Webhook é…ç½®æ­£ç¡®åœ°æ³¨å…¥åˆ° CRD ä¸­ã€‚</li>
<li>patches&#x2F;webhook_in_myapps.yaml:<br>è¿™ä¸ªæ–‡ä»¶ä¹Ÿæ˜¯ä¸€ä¸ªè¡¥ä¸æ–‡ä»¶ï¼Œç”¨äºåœ¨ CRD ä¸Šåº”ç”¨ Webhook é…ç½®ã€‚<br>ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½ä¼šæ·»åŠ æˆ–ä¿®æ”¹ Webhook çš„é…ç½®ï¼Œä»¥ä¾¿åœ¨åˆ›å»ºæˆ–æ›´æ–°è‡ªå®šä¹‰èµ„æºæ—¶è§¦å‘ç‰¹å®šçš„è¡Œä¸ºã€‚</li>
</ol>
<p>æ€»ç»“</p>
<p>bases ç›®å½•ï¼šåŒ…å« CRD çš„åŸºæœ¬å®šä¹‰æ–‡ä»¶ã€‚</p>
<p>kustomization.yamlï¼šKustomize çš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰å¦‚ä½•ç»„åˆå’Œä¿®æ”¹èµ„æºæ–‡ä»¶ã€‚</p>
<p>kustomizeconfig.yamlï¼šKustomize çš„é«˜çº§é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰ã€‚</p>
<p>patches ç›®å½•ï¼šåŒ…å«ç”¨äºä¿®æ”¹ CRD çš„è¡¥ä¸æ–‡ä»¶ï¼Œé€šå¸¸ç”¨äºæ³¨å…¥ Webhook é…ç½®ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬åƒè®©è¿™ä¸ªcrdæ ¹æ®ä¸åŒçš„ç¯å¢ƒåšé’ˆå¯¹æ€§éƒ¨ç½²çš„ï¼Œä¾‹å¦‚ä¸‹é¢çš„ç›®å½•ç»“æ„:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ crd</span><br><span class="line">â”‚   â”œâ”€â”€ bases</span><br><span class="line">â”‚   â”‚   â””â”€â”€ apps.kubenode.alibaba-inc.com_myapps.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ development</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ patches</span><br><span class="line">â”‚   â”‚       â””â”€â”€ webhook_in_myapps.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ testing</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ patches</span><br><span class="line">â”‚   â”‚       â””â”€â”€ webhook_in_myapps.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ production</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ patches</span><br><span class="line">â”‚   â”‚       â””â”€â”€ webhook_in_myapps.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ kustomizeconfig.yaml</span><br><span class="line">â”‚   â””â”€â”€ patches</span><br><span class="line">â”‚       â”œâ”€â”€ cainjection_in_myapps.yaml</span><br><span class="line">â”‚       â””â”€â”€ webhook_in_myapps.yaml</span><br></pre></td></tr></table></figure>

<p>æ‰€æœ‰è‡ªå®šä¹‰è§„èŒƒéƒ½åŒ…å«åœ¨ kustomization.yaml æ–‡ä»¶ä¸­ï¼Œè¯¥æ–‡ä»¶å°†è§„èŒƒå åŠ åœ¨ç°æœ‰æ¸…å•ä¹‹ä¸Šä»¥ç”Ÿæˆèµ„æºçš„è‡ªå®šä¹‰ç‰ˆæœ¬ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸€ç‰¹æ€§ï¼Œé’ˆå¯¹ä¸åŒçš„ç¯å¢ƒï¼Œå¯¹crdè¿›è¡Œå®šåˆ¶ã€‚</p>
<h1 id="2ã€Helm"><a href="#2ã€Helm" class="headerlink" title="2ã€Helm"></a>2ã€Helm</h1><p>Helm æ˜¯ä¸€ä¸ªèƒ½å¤Ÿåœ¨ K8s ä¸Šæ‰“åŒ…ã€éƒ¨ç½²å’Œç®¡ç†åº”ç”¨ç¨‹åºçš„å·¥å…·ï¼Œå³ä½¿æ˜¯æœ€å¤æ‚çš„ K8s åº”ç”¨ç¨‹åºå®ƒéƒ½å¯ä»¥å¸®åŠ©å®šä¹‰ï¼Œå®‰è£…å’Œå‡çº§ï¼ŒåŒæ—¶Helm ä¹Ÿæ˜¯ <a href="https://cncf.io/">CNCF</a> çš„æ¯•ä¸šé¡¹ç›®ã€‚<br>è¿™é‡Œæ¶‰åŠåˆ°äº†ä»¥åŠå…³äºhelmçš„é‡è¦æ¦‚å¿µï¼š</p>
<ul>
<li>Helm Chartsï¼šé¢„å…ˆé…ç½®yamlçš„æ¨¡æ¿ï¼Œåœ¨è¿™é‡Œå«Chartï¼Œç”¨äºæè¿° K8s åº”ç”¨ç¨‹åºçš„yamlå’Œé…ç½®</li>
<li>Helm Clientï¼šç”¨äºä¸ Helm äº¤äº’å¹¶ç®¡ç†è¿™äº›Chartç‰ˆæœ¬çš„å‘½ä»¤è¡Œç•Œé¢</li>
<li>Chart ä»“åº“ï¼šç®¡ç†Chartçš„ä»“åº“ï¼Œè·ŸMavençš„Nexusä¸€ä¸ªæ„æ€ï¼Œæ¯”å¦‚åœ¨å…¬å¸ç¯å¢ƒæ„å»ºä¸Šä¼ ï¼Œåœ¨å®¢æˆ·çš„æœºæˆ¿è¿æ¥åˆ°è¿™Chart ä»“åº“ä¸‹è½½Chartï¼Œå¹¶éƒ¨ç½²åˆ°k8sä¸­ã€‚</li>
</ul>
<h1 id="2-1-helmç¤ºä¾‹"><a href="#2-1-helmç¤ºä¾‹" class="headerlink" title="2.1 helmç¤ºä¾‹"></a>2.1 helmç¤ºä¾‹</h1><p>helmçš„ç¤ºä¾‹éœ€è¦ç”¨åˆ°kubectlã€helmä»¥åŠk8sé›†ç¾¤ï¼Œç›¸åº”çš„å®‰è£…å‚è€ƒï¼š</p>
<ul>
<li>macç¯å¢ƒï¼š<a href="https://blog.csdn.net/qq_41004932/article/details/142684319">https://blog.csdn.net/qq_41004932/article/details/142684319</a></li>
<li>ubuntuç¯å¢ƒï¼š<a href="https://blog.csdn.net/qq_41004932/article/details/142691490">https://blog.csdn.net/qq_41004932/article/details/142691490</a></li>
<li>kindé›†ç¾¤ï¼š<a href="https://blog.csdn.net/qq_41004932/article/details/142691490">https://blog.csdn.net/qq_41004932/article/details/142691490</a></li>
</ul>
<p>Helm Charts æ˜¯é¢„å…ˆé…ç½®çš„ K8s èµ„æºåŒ…ã€‚Helm Chart åŒ…å«éƒ¨ç½²ç‰¹å®šåº”ç”¨ç¨‹åºæˆ–æœåŠ¡æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬ K8s æ¸…å•ã€ç¯å¢ƒå˜é‡å’Œå…¶ä»–é…ç½®</p>
<p>ç›®å½•åç§°æ˜¯Chartçš„åç§°ï¼Œå¦‚<a href="https://helm.sh/docs/topics/charts/">Helm æ–‡æ¡£</a>æ‰€ç¤ºï¼Œæˆ‘ä»¬é€šè¿‡helm create demoå‘½ä»¤åˆ›å»ºä¸€ä¸ªChartï¼Œæ‰§è¡Œå®Œä»¥åï¼Œé»˜è®¤ä¼šç”Ÿæˆä¸€ä¸ª nginx çš„Chartã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm create demo</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">helm create demo                                                                                                                      [10:33:35]</span></span><br><span class="line">Creating demo</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹ç›®å½•ç»“æ„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ Chart.yaml</span><br><span class="line">â”œâ”€â”€ charts</span><br><span class="line">â”œâ”€â”€ templates</span><br><span class="line">â”‚   â”œâ”€â”€ NOTES.txt</span><br><span class="line">â”‚   â”œâ”€â”€ _helpers.tpl</span><br><span class="line">â”‚   â”œâ”€â”€ deployment.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ hpa.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ ingress.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ service.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ serviceaccount.yaml</span><br><span class="line">â”‚   â””â”€â”€ tests</span><br><span class="line">â”‚       â””â”€â”€ test-connection.yaml</span><br><span class="line">â””â”€â”€ values.yaml</span><br><span class="line"></span><br><span class="line">3 directories, 10 files</span><br></pre></td></tr></table></figure>

<h2 id="2-2-Chart-yaml"><a href="#2-2-Chart-yaml" class="headerlink" title="2.2 Chart.yaml"></a>2.2 Chart.yaml</h2><p>å®šä¹‰äº†å½“å‰ chartç‰ˆæœ¬ï¼Œä»¥åŠæè¿°å½“å‰chartç”¨é€”ï¼Œå…¶ä¸­ name å‚æ•°è¡¨ç¤º chart åç§°ï¼ŒåæœŸä¸Šä¼ ä¸‹è½½éƒ½ä¼šç”¨æ­¤åç§°</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">apiVersion: v2</span><br><span class="line">name: demo</span><br><span class="line">description: A Helm chart for Kubernetes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A chart can be either an <span class="string">&#x27;application&#x27;</span> or a <span class="string">&#x27;library&#x27;</span> chart.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Application charts are a collection of templates that can be packaged into versioned archives</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">to be deployed.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Library charts provide useful utilities or functions for the chart developer. They&#x27;re included as</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">a dependency of application charts to inject those utilities and <span class="built_in">functions</span> into the rendering</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pipeline. Library charts <span class="keyword">do</span> not define any templates and therefore cannot be deployed.</span></span><br><span class="line">type: application</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is the chart version. This version number should be incremented each <span class="keyword">time</span> you make changes</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">to the chart and its templates, including the app version.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Versions are expected to follow Semantic Versioning (https://semver.org/)</span></span><br><span class="line">version: 0.1.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is the version number of the application being deployed. This version number should be</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">incremented each <span class="keyword">time</span> you make changes to the application. Versions are not expected to</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">follow Semantic Versioning. They should reflect the version the application is using.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">It is recommended to use it with quotes.</span></span><br><span class="line">appVersion: &quot;1.16.0&quot;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-values-yaml"><a href="#2-3-values-yaml" class="headerlink" title="2.3 values.yaml"></a>2.3 values.yaml</h2><p>å¯å˜å‚æ•°ï¼Œéƒ½æ˜¯åœ¨æ­¤æ–‡ä»¶ä¸­å®šä¹‰ï¼Œåœ¨yamlæ¨¡æ¿ä¸­å¼•ç”¨ï¼Œæ¯”å¦‚ï¼šimage.repositoryï¼Œè€Œå¼•ç”¨åˆ™é€šè¿‡.Values+å˜é‡çš„åè¿›è¡Œå¼•ç”¨</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Default values <span class="keyword">for</span> demo.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is a YAML-formatted file.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Declare variables to be passed into your templates.</span></span><br><span class="line"></span><br><span class="line">replicaCount: 1</span><br><span class="line"></span><br><span class="line">image:</span><br><span class="line">  repository: nginx</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">Overrides the image tag whose default is the chart appVersion.</span></span><br><span class="line">  tag: &quot;&quot;</span><br><span class="line"></span><br><span class="line">imagePullSecrets: []</span><br><span class="line">nameOverride: &quot;&quot;</span><br><span class="line">fullnameOverride: &quot;&quot;</span><br><span class="line"></span><br><span class="line">serviceAccount:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">Specifies whether a service account should be created</span></span><br><span class="line">  create: true</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">Annotations to add to the service account</span></span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">The name of the service account to use.</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">If not <span class="built_in">set</span> and create is <span class="literal">true</span>, a name is generated using the fullname template</span></span><br><span class="line">  name: &quot;&quot;</span><br><span class="line"></span><br><span class="line">podAnnotations: &#123;&#125;</span><br><span class="line"></span><br><span class="line">podSecurityContext: &#123;&#125;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">fsGroup: 2000</span></span><br><span class="line"></span><br><span class="line">securityContext: &#123;&#125;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">capabilities:</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">  drop:</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">  - ALL</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">readOnlyRootFilesystem: <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">runAsNonRoot: <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">runAsUser: 1000</span></span><br><span class="line"></span><br><span class="line">service:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  port: 80</span><br><span class="line"></span><br><span class="line">ingress:</span><br><span class="line">  enabled: false</span><br><span class="line">  className: &quot;&quot;</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">    # kubernetes.io/ingress.class: nginx</span><br><span class="line">    # kubernetes.io/tls-acme: &quot;true&quot;</span><br><span class="line">  hosts:</span><br><span class="line">    - host: chart-example.local</span><br><span class="line">      paths:</span><br><span class="line">        - path: /</span><br><span class="line">          pathType: ImplementationSpecific</span><br><span class="line">  tls: []</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash"> - secretName: chart-example-tls</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">   hosts:</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">     - chart-example.local</span></span><br><span class="line"></span><br><span class="line">resources: &#123;&#125;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">We usually recommend not to specify default resources and to leave this as a conscious</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">choice <span class="keyword">for</span> the user. This also increases chances charts run on environments with little</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">resources, such as Minikube. If you <span class="keyword">do</span> want to specify resources, uncomment the following</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">lines, adjust them as necessary, and remove the curly braces after <span class="string">&#x27;resources:&#x27;</span>.</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">limits:</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">  cpu: 100m</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">  memory: 128Mi</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">requests:</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">  cpu: 100m</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">  memory: 128Mi</span></span><br><span class="line"></span><br><span class="line">autoscaling:</span><br><span class="line">  enabled: false</span><br><span class="line">  minReplicas: 1</span><br><span class="line">  maxReplicas: 100</span><br><span class="line">  targetCPUUtilizationPercentage: 80</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">targetMemoryUtilizationPercentage: 80</span></span><br><span class="line"></span><br><span class="line">nodeSelector: &#123;&#125;</span><br><span class="line"></span><br><span class="line">tolerations: []</span><br><span class="line"></span><br><span class="line">affinity: &#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-4-helpers-tpl"><a href="#2-4-helpers-tpl" class="headerlink" title="2.4 _helpers.tpl"></a>2.4 _helpers.tpl</h2><p>å®šä¹‰é€šç”¨ä»£ç å—ï¼Œç„¶åyaml æ–‡ä»¶ä¼šé€šè¿‡ include å¼•ç”¨</p>
<p>å®šä¹‰:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;&#123;- define &quot;demo.name&quot; -&#125;&#125;</span><br><span class="line">&#123;&#123;- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix &quot;-&quot; &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>å¼•ç”¨:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;&#123; include &quot;demo.fullname&quot; . &#125;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-templates"><a href="#2-5-templates" class="headerlink" title="2.5 templates"></a>2.5 templates</h2><p>æ­¤ç›®å½•ä¸»è¦å­˜æ”¾çš„æ˜¯è¦éƒ¨ç½²çš„ yamlæ–‡ä»¶æ¨¡æ¿ï¼ŒåŒæ—¶ä¹ŸåŒ…å«_helpers.tplæ–‡ä»¶ï¼Œæ¨¡æ¿ä¼šå¼•ç”¨values.yamlã€Chart.yamlå®šä¹‰çš„å‚æ•°ï¼Œä»¥åŠ_helpers.tplå®šä¹‰çš„é€šç”¨ä»£ç å—</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; include &quot;demo.fullname&quot; . &#125;&#125;</span><br><span class="line">  labels:</span><br><span class="line">    &#123;&#123;- include &quot;demo.labels&quot; . | nindent 4 &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  &#123;&#123;- if not .Values.autoscaling.enabled &#125;&#125;</span><br><span class="line">  replicas: &#123;&#123; .Values.replicaCount &#125;&#125;</span><br><span class="line">  &#123;&#123;- end &#125;&#125;</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      &#123;&#123;- include &quot;demo.selectorLabels&quot; . | nindent 6 &#125;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      &#123;&#123;- with .Values.podAnnotations &#125;&#125;</span><br><span class="line">      annotations:</span><br><span class="line">        &#123;&#123;- toYaml . | nindent 8 &#125;&#125;</span><br><span class="line">      &#123;&#123;- end &#125;&#125;</span><br><span class="line">      labels:</span><br><span class="line">        &#123;&#123;- include &quot;demo.selectorLabels&quot; . | nindent 8 &#125;&#125;</span><br><span class="line">    spec:</span><br><span class="line">      &#123;&#123;- with .Values.imagePullSecrets &#125;&#125;</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">        &#123;&#123;- toYaml . | nindent 8 &#125;&#125;</span><br><span class="line">      &#123;&#123;- end &#125;&#125;</span><br><span class="line">      serviceAccountName: &#123;&#123; include &quot;demo.serviceAccountName&quot; . &#125;&#125;</span><br><span class="line">      securityContext:</span><br><span class="line">        &#123;&#123;- toYaml .Values.podSecurityContext | nindent 8 &#125;&#125;</span><br><span class="line">      containers:</span><br><span class="line">        - name: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">          securityContext:</span><br><span class="line">            &#123;&#123;- toYaml .Values.securityContext | nindent 12 &#125;&#125;</span><br><span class="line">          image: &quot;&#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag | default .Chart.AppVersion &#125;&#125;&quot;</span><br><span class="line">          imagePullPolicy: &#123;&#123; .Values.image.pullPolicy &#125;&#125;</span><br><span class="line">          ports:</span><br><span class="line">            - name: http</span><br><span class="line">              containerPort: &#123;&#123; .Values.service.port &#125;&#125;</span><br><span class="line">              protocol: TCP</span><br><span class="line">          livenessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /</span><br><span class="line">              port: http</span><br><span class="line">          readinessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /</span><br><span class="line">              port: http</span><br><span class="line">          resources:</span><br><span class="line">            &#123;&#123;- toYaml .Values.resources | nindent 12 &#125;&#125;</span><br><span class="line">      &#123;&#123;- with .Values.nodeSelector &#125;&#125;</span><br><span class="line">      nodeSelector:</span><br><span class="line">        &#123;&#123;- toYaml . | nindent 8 &#125;&#125;</span><br><span class="line">      &#123;&#123;- end &#125;&#125;</span><br><span class="line">      &#123;&#123;- with .Values.affinity &#125;&#125;</span><br><span class="line">      affinity:</span><br><span class="line">        &#123;&#123;- toYaml . | nindent 8 &#125;&#125;</span><br><span class="line">      &#123;&#123;- end &#125;&#125;</span><br><span class="line">      &#123;&#123;- with .Values.tolerations &#125;&#125;</span><br><span class="line">      tolerations:</span><br><span class="line">        &#123;&#123;- toYaml . | nindent 8 &#125;&#125;</span><br><span class="line">      &#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">image: &quot;&#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag | default .Chart.AppVersion &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<h2 id="2-5-éƒ¨ç½²"><a href="#2-5-éƒ¨ç½²" class="headerlink" title="2.5 éƒ¨ç½²"></a>2.5 éƒ¨ç½²</h2><p>å¦‚æœæƒ³éƒ¨ç½²çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤è¿›è¡Œ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm package helm-demo</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°ï¼Œè¿™é‡Œhelmæ˜¯å°†è¦éƒ¨ç½²çš„èµ„æºå½“ä½œä¸€ä¸ªæ•´ä½“æ¥è¿›è¡Œæ“ä½œçš„ï¼Œä¹Ÿå°±æ˜¯è®²ä¸€ä¸ªèµ„æºçš„æ‰€æœ‰yamlé…ç½®ä½œä¸ºä¸€ä¸ªæ•´ä½“çš„å½¢å¼æ¥è¿›è¡Œæ“ä½œã€‚</p>
<h1 id="3ã€ä¸»è¦å·®å¼‚"><a href="#3ã€ä¸»è¦å·®å¼‚" class="headerlink" title="3ã€ä¸»è¦å·®å¼‚"></a>3ã€ä¸»è¦å·®å¼‚</h1><h2 id="3-1-æ“ä½œæ–¹æ³•"><a href="#3-1-æ“ä½œæ–¹æ³•" class="headerlink" title="3.1 æ“ä½œæ–¹æ³•"></a>3.1 æ“ä½œæ–¹æ³•</h2><p>Kustomize ä¾èµ–ç‰¹å®šäºç›®å½•çš„kustomization.yamlæ–‡ä»¶æ¥æ„å»ºå„ä¸ªèµ„æºå¹¶å¯¹å…¶è¿›è¡Œæ›´æ”¹ã€‚è¿™äº›æ–‡ä»¶å°†è¡¥ä¸å’Œè¦†ç›–åº”ç”¨åˆ°å…±äº«åŸºæ–‡ä»¶å¤¹ä¸­å£°æ˜çš„èµ„æºï¼Œä»¥æä¾›è‡ªåŠ¨åŒ–çš„å¤šç¯å¢ƒé…ç½®ã€‚</p>
<p>Helm é€šè¿‡å¼•ç”¨value.yamlæ–‡ä»¶ä½œä¸ºå˜é‡æºï¼Œä½¿ç”¨æ¨¡æ¿ç”Ÿæˆæœ‰æ•ˆçš„ K8s é…ç½®ã€‚æ¨¡æ¿ç›®å½•æ‰˜ç®¡ Helm Chartåœ¨éƒ¨ç½²æœŸé—´ç”¨äºåˆ›å»ºèµ„æºçš„æ–‡ä»¶ã€‚</p>
<h2 id="3-2-ä¾¿æ·æ€§"><a href="#3-2-ä¾¿æ·æ€§" class="headerlink" title="3.2 ä¾¿æ·æ€§"></a>3.2 ä¾¿æ·æ€§</h2><p>ä»K8s ç‰ˆæœ¬ 1.14 å¼€å§‹ï¼ŒKustomize ä¸ kubectl CLI æ†ç»‘åœ¨ä¸€èµ·ï¼Œå› æ­¤ä¸éœ€è¦æŒæ¡ä»»ä½•å…¶ä»–å·¥å…·ã€‚Kustomize æ”¯æŒå£°æ˜å¼éƒ¨ç½²ï¼Œå¹¶å¯¹æ¯ä¸ªæ–‡ä»¶ä½¿ç”¨çº¯ YAMLï¼Œä»è€Œæ›´å®¹æ˜“ä½¿ç”¨ã€‚</p>
<p>Helm ä¸ºK8såŒ…ç®¡ç†ä»»åŠ¡æ·»åŠ äº†é¢å¤–çš„æŠ½è±¡å±‚ï¼Œä»è€ŒåŠ å¿«äº†å¸Œæœ›ç®€åŒ–é›†ç¾¤é…ç½®å’Œå‘å¸ƒè‡ªåŠ¨åŒ–çš„å›¢é˜Ÿçš„å­¦ä¹ æ›²çº¿ã€‚Helm Chart ç›¸å¯¹Kustomizeå¤æ‚ï¼Œä¸è¿‡åŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚</p>
<h2 id="3-3-æ‰“åŒ…"><a href="#3-3-æ‰“åŒ…" class="headerlink" title="3.3 æ‰“åŒ…"></a>3.3 æ‰“åŒ…</h2><p>Kustomize ç¼ºä¹çš„æ‰“åŒ…åŠŸèƒ½ï¼Œå¹¶ä¸”æ¯ä¸ªèµ„æºéƒ½å¿…é¡»åœ¨åŸºæœ¬æ–‡ä»¶å¤¹ä¸­å£°æ˜ï¼Œå¹¶åœ¨è¦†ç›–kustomization.yamlæ–‡ä»¶ä¸­å•ç‹¬å£°æ˜å˜ä½“ã€‚</p>
<p>è€ŒHelmå°†æ‰€æœ‰å¿…éœ€çš„K8sèµ„æºéƒ½æ‰“åŒ…åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œè¯¥æ–‡ä»¶å¤¹å¯ä»¥æ ¹æ®éœ€è¦é‡å¤ä½¿ç”¨ã€‚Helm è¿˜å…è®¸è®¾ç½®åº”ç”¨ç¨‹åºé»˜è®¤å€¼ï¼Œå¹¶ä¸”ä½¿ç”¨values.yamlæ–‡ä»¶ä¿®æ”¹å‚æ•°ï¼Œä»è€Œæ³¨å…¥å¼•ç”¨çš„ yaml æ–‡ä»¶ä¸­ã€‚</p>
<h2 id="3-4-åŸç”Ÿ-kubectl-é›†æˆ"><a href="#3-4-åŸç”Ÿ-kubectl-é›†æˆ" class="headerlink" title="3.4 åŸç”Ÿ kubectl é›†æˆ"></a>3.4 åŸç”Ÿ kubectl é›†æˆ</h2><p>ä» K8s 1.14 ç‰ˆå¼€å§‹ï¼ŒKustomize å°±é¢„è£…äº† kubectlï¼ŒHelm å¹¶æœªä¸ K8s é¢„å…ˆé›†æˆï¼Œå› æ­¤å¿…é¡»æ‰‹åŠ¨å®‰è£… Helmã€‚</p>
<h2 id="3-5-Kustomize-ä¸-Helm-ä½•æ—¶ä½¿ç”¨"><a href="#3-5-Kustomize-ä¸-Helm-ä½•æ—¶ä½¿ç”¨" class="headerlink" title="3.5 Kustomize ä¸ Helm - ä½•æ—¶ä½¿ç”¨"></a>3.5 Kustomize ä¸ Helm - ä½•æ—¶ä½¿ç”¨</h2><h3 id="3-5-1-ä½•æ—¶ä½¿ç”¨-Kustomize"><a href="#3-5-1-ä½•æ—¶ä½¿ç”¨-Kustomize" class="headerlink" title="3.5.1 ä½•æ—¶ä½¿ç”¨ Kustomize"></a>3.5.1 ä½•æ—¶ä½¿ç”¨ Kustomize</h3><p>Kustomizeå…è®¸åœ¨ä¸æ”¹å˜åŸå§‹æ–‡ä»¶çš„æƒ…å†µä¸‹è¿›è¡Œç²¾ç¡®æ›´æ”¹ã€‚ å› æ­¤å¯ä»¥æœ‰ä»¥ä¸‹åœºæ™¯</p>
<ul>
<li>åº”ç”¨é…ç½®çš„å˜ä½“ç®¡ç†ï¼šå½“ä½ éœ€è¦ç®¡ç†å¤šä¸ªç¯å¢ƒï¼ˆä¾‹å¦‚å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰ä¸­åº”ç”¨çš„å˜ä½“æ—¶ï¼ŒKustomize æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚å®ƒå…è®¸ä½ ä¸ºä¸åŒçš„ç¯å¢ƒåˆ›å»ºä¸åŒçš„é…ç½®ï¼Œå¹¶ä½¿ç”¨ä¸€å¥—åŸºç¡€é…ç½®æ¥å®šä¹‰é€šç”¨éƒ¨åˆ†ã€‚</li>
<li>æŒç»­é›†æˆå’ŒæŒç»­éƒ¨ç½²ï¼ˆCI&#x2F;CDï¼‰æµæ°´çº¿ï¼šKustomize å¯ä»¥ä¸ CI&#x2F;CD å·¥å…·é›†æˆï¼Œå¸®åŠ©ä½ å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚é€šè¿‡åœ¨æµæ°´çº¿ä¸­ä½¿ç”¨ Kustomizeï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦ç”Ÿæˆç‰¹å®šç¯å¢ƒçš„é…ç½®ï¼Œå¹¶å°†å…¶åº”ç”¨åˆ°é›†ç¾¤ä¸­ã€‚</li>
</ul>
<h3 id="3-5-2-ä½•æ—¶ä½¿ç”¨-Helm"><a href="#3-5-2-ä½•æ—¶ä½¿ç”¨-Helm" class="headerlink" title="3.5.2 ä½•æ—¶ä½¿ç”¨ Helm"></a>3.5.2 ä½•æ—¶ä½¿ç”¨ Helm</h3><p>Helm å°†æ‰€æœ‰ K8s å¯¹è±¡å°è£…åˆ°ä¸€ä¸ªåŒ…ä¸­ï¼Œå‡å°‘äº†ä¸å„ä¸ªyaml æ–‡ä»¶çš„äº¤äº’ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¤§å¤šæ•°ç¬¬ä¸‰æ–¹ä¾›åº”å•†è¿˜æä¾›é¢„æ„å»ºçš„ Helm å›¾è¡¨ï¼Œä»¥ç®€åŒ–å°†å…¶äº§å“éƒ¨ç½²åˆ° K8s ä¸­çš„è¿‡ç¨‹ã€‚å› æ­¤ï¼ŒHelm é€šå¸¸æ˜¯å®‰è£…ç°æˆè§£å†³æ–¹æ¡ˆï¼ˆä¾‹å¦‚ç›‘æ§ã€æ•°æ®åº“å’Œæ¶ˆæ¯ä¸­é—´ä»¶ç­‰ï¼‰çš„é¦–é€‰</p>
]]></content>
  </entry>
  <entry>
    <title>operatorå¼€å‘è„šæ‰‹æ¶</title>
    <url>/2025/07/kubernetes/Operator%E5%BC%80%E5%8F%91/operator%E5%BC%80%E5%8F%91%E8%84%9A%E6%89%8B%E6%9E%B6/</url>
    <content><![CDATA[<h1 id="1ã€è„šæ‰‹æ¶å·¥å…·"><a href="#1ã€è„šæ‰‹æ¶å·¥å…·" class="headerlink" title="1ã€è„šæ‰‹æ¶å·¥å…·"></a>1ã€è„šæ‰‹æ¶å·¥å…·</h1><p>Operatorçš„å®ç°æ–¹å¼ä¸»è¦åŒ…æ‹¬OperatorSDKå’ŒKubeBuilderï¼Œç›®å‰KubeBuilderåœ¨é˜¿é‡Œä½¿ç”¨çš„æ¯”è¾ƒå¤šã€‚</p>
<p><a href="https://github.com/kubernetes-sigs/kubebuilder?spm=ata.21736010.0.0.5e4b6ec8eEasr9">KubeBuilder</a></p>
<p><a href="https://github.com/operator-framework/operator-sdk?spm=ata.21736010.0.0.5e4b6ec8eEasr9">OperatorSDK</a></p>
<p>æˆ‘ä»¬è¿™é‡Œä¸»è¦æ˜¯ç”¨KubeBuilderæ¥è¿›è¡Œï¼Œå…¶ä¸­OperatorSDKå…¶å®ä¹Ÿæ˜¯åº”ç”¨äº†KubeBuilderã€‚</p>
<h1 id="2ã€åˆ›å»ºOperatorå·¥ç¨‹"><a href="#2ã€åˆ›å»ºOperatorå·¥ç¨‹" class="headerlink" title="2ã€åˆ›å»ºOperatorå·¥ç¨‹"></a>2ã€åˆ›å»ºOperatorå·¥ç¨‹</h1><p>åˆ›å»ºè„šæ‰‹æ¶å·¥ç¨‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir myapp-operator</span><br><span class="line">cd myapp-operator/</span><br><span class="line">go env -w GO111MODULE=on</span><br><span class="line">go env -w GOPROXY=https://goproxy.cn,direct</span><br><span class="line">kubebuilder init --domain kubenode.kingtest.com</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºè„šæ‰‹æ¶ç»“æœï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubebuilder init --domain kubenode.kingtest.com</span><br><span class="line">INFO Writing kustomize manifests for you to edit... </span><br><span class="line">INFO Writing scaffold for you to edit...          </span><br><span class="line">INFO Get controller runtime:</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go get sigs.k8s.io/controller-runtime@v0.19.0</span> </span><br><span class="line">go: downloading sigs.k8s.io/controller-runtime v0.19.0</span><br><span class="line">go: downloading k8s.io/apimachinery v0.31.0</span><br><span class="line">go: downloading k8s.io/api v0.31.0</span><br><span class="line">go: downloading k8s.io/client-go v0.31.0</span><br><span class="line">go: downloading k8s.io/utils v0.0.0-20240711033017-18e509b52bc8</span><br><span class="line">go: downloading github.com/go-logr/logr v1.4.2</span><br><span class="line">go: downloading k8s.io/klog/v2 v2.130.1</span><br><span class="line">go: downloading golang.org/x/exp v0.0.0-20230515195305-f3d0a9c9a5cc</span><br><span class="line">go: downloading github.com/evanphx/json-patch/v5 v5.9.0</span><br><span class="line">go: downloading github.com/prometheus/client_golang v1.19.1</span><br><span class="line">go: downloading gomodules.xyz/jsonpatch/v2 v2.4.0</span><br><span class="line">go: downloading github.com/gogo/protobuf v1.3.2</span><br><span class="line">go: downloading github.com/google/gofuzz v1.2.0</span><br><span class="line">go: downloading sigs.k8s.io/structured-merge-diff/v4 v4.4.1</span><br><span class="line">go: downloading k8s.io/apiextensions-apiserver v0.31.0</span><br><span class="line">go: downloading sigs.k8s.io/json v0.0.0-20221116044647-bc3834ca7abd</span><br><span class="line">go: downloading k8s.io/kube-openapi v0.0.0-20240228011516-70dd3763d340</span><br><span class="line">go: downloading github.com/google/uuid v1.6.0</span><br><span class="line">go: downloading github.com/prometheus/client_model v0.6.1</span><br><span class="line">go: downloading github.com/prometheus/common v0.55.0</span><br><span class="line">go: downloading github.com/fsnotify/fsnotify v1.7.0</span><br><span class="line">go: downloading golang.org/x/net v0.26.0</span><br><span class="line">go: downloading gopkg.in/inf.v0 v0.9.1</span><br><span class="line">go: downloading github.com/golang/groupcache v0.0.0-20210331224755-41bb18bfe9da</span><br><span class="line">go: downloading github.com/imdario/mergo v0.3.6</span><br><span class="line">go: downloading github.com/spf13/pflag v1.0.5</span><br><span class="line">go: downloading golang.org/x/term v0.21.0</span><br><span class="line">go: downloading github.com/golang/protobuf v1.5.4</span><br><span class="line">go: downloading github.com/google/gnostic-models v0.6.8</span><br><span class="line">go: downloading golang.org/x/time v0.3.0</span><br><span class="line">go: downloading sigs.k8s.io/yaml v1.4.0</span><br><span class="line">go: downloading github.com/beorn7/perks v1.0.1</span><br><span class="line">go: downloading github.com/cespare/xxhash/v2 v2.3.0</span><br><span class="line">go: downloading github.com/prometheus/procfs v0.15.1</span><br><span class="line">go: downloading golang.org/x/sys v0.21.0</span><br><span class="line">go: downloading google.golang.org/protobuf v1.34.2</span><br><span class="line">go: downloading golang.org/x/oauth2 v0.21.0</span><br><span class="line">go: downloading github.com/json-iterator/go v1.1.12</span><br><span class="line">go: downloading gopkg.in/yaml.v2 v2.4.0</span><br><span class="line">go: downloading github.com/fxamacker/cbor/v2 v2.7.0</span><br><span class="line">go: downloading github.com/google/go-cmp v0.6.0</span><br><span class="line">go: downloading gopkg.in/yaml.v3 v3.0.1</span><br><span class="line">go: downloading github.com/davecgh/go-spew v1.1.2-0.20180830191138-d8f796af33cc</span><br><span class="line">go: downloading github.com/munnerz/goautoneg v0.0.0-20191010083416-a7dc8b61c822</span><br><span class="line">go: downloading github.com/modern-go/concurrent v0.0.0-20180306012644-bacd9c7ef1dd</span><br><span class="line">go: downloading github.com/modern-go/reflect2 v1.0.2</span><br><span class="line">go: downloading github.com/go-openapi/jsonreference v0.20.2</span><br><span class="line">go: downloading github.com/go-openapi/swag v0.22.4</span><br><span class="line">go: downloading golang.org/x/text v0.16.0</span><br><span class="line">go: downloading github.com/go-openapi/jsonpointer v0.19.6</span><br><span class="line">go: downloading github.com/emicklei/go-restful/v3 v3.11.0</span><br><span class="line">go: downloading github.com/mailru/easyjson v0.7.7</span><br><span class="line">go: downloading github.com/josharian/intern v1.0.0</span><br><span class="line">go: downloading github.com/x448/float16 v0.8.4</span><br><span class="line">go: downloading github.com/pkg/errors v0.9.1</span><br><span class="line">INFO Update dependencies:</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go mod tidy</span>           </span><br><span class="line">go: downloading github.com/onsi/ginkgo/v2 v2.19.0</span><br><span class="line">go: downloading github.com/stretchr/testify v1.9.0</span><br><span class="line">go: downloading github.com/onsi/gomega v1.33.1</span><br><span class="line">go: downloading github.com/go-logr/zapr v1.3.0</span><br><span class="line">go: downloading go.uber.org/zap v1.26.0</span><br><span class="line">go: downloading k8s.io/apiserver v0.31.0</span><br><span class="line">go: downloading go.uber.org/goleak v1.3.0</span><br><span class="line">go: downloading github.com/evanphx/json-patch v0.5.2</span><br><span class="line">go: downloading gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c</span><br><span class="line">go: downloading gopkg.in/evanphx/json-patch.v4 v4.12.0</span><br><span class="line">go: downloading github.com/kr/pretty v0.3.1</span><br><span class="line">go: downloading go.uber.org/multierr v1.11.0</span><br><span class="line">go: downloading github.com/go-task/slim-sprig/v3 v3.0.0</span><br><span class="line">go: downloading golang.org/x/tools v0.21.1-0.20240508182429-e35e4ccd0d2d</span><br><span class="line">go: downloading github.com/google/pprof v0.0.0-20240525223248-4bfdf5a9a2af</span><br><span class="line">go: downloading github.com/pmezard/go-difflib v1.0.1-0.20181226105442-5d4384ee4fb2</span><br><span class="line">go: downloading github.com/rogpeppe/go-internal v1.12.0</span><br><span class="line">go: downloading github.com/kr/text v0.2.0</span><br><span class="line">go: downloading k8s.io/component-base v0.31.0</span><br><span class="line">go: downloading go.opentelemetry.io/otel v1.28.0</span><br><span class="line">go: downloading go.opentelemetry.io/otel/trace v1.28.0</span><br><span class="line">go: downloading google.golang.org/grpc v1.65.0</span><br><span class="line">go: downloading sigs.k8s.io/apiserver-network-proxy/konnectivity-client v0.30.3</span><br><span class="line">go: downloading golang.org/x/sync v0.7.0</span><br><span class="line">go: downloading github.com/google/cel-go v0.20.1</span><br><span class="line">go: downloading github.com/blang/semver/v4 v4.0.0</span><br><span class="line">go: downloading go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp v0.53.0</span><br><span class="line">go: downloading go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc v1.27.0</span><br><span class="line">go: downloading go.opentelemetry.io/otel/sdk v1.28.0</span><br><span class="line">go: downloading google.golang.org/genproto/googleapis/api v0.0.0-20240528184218-531527333157</span><br><span class="line">go: downloading github.com/felixge/httpsnoop v1.0.4</span><br><span class="line">go: downloading go.opentelemetry.io/otel/metric v1.28.0</span><br><span class="line">go: downloading github.com/asaskevich/govalidator v0.0.0-20190424111038-f61b66f89f4a</span><br><span class="line">go: downloading github.com/go-logr/stdr v1.2.2</span><br><span class="line">go: downloading google.golang.org/genproto/googleapis/rpc v0.0.0-20240701130421-f6361c86f094</span><br><span class="line">go: downloading github.com/antlr4-go/antlr/v4 v4.13.0</span><br><span class="line">go: downloading google.golang.org/genproto v0.0.0-20230822172742-b8732ec3820d</span><br><span class="line">go: downloading github.com/spf13/cobra v1.8.1</span><br><span class="line">go: downloading github.com/stoewer/go-strcase v1.2.0</span><br><span class="line">go: downloading github.com/inconshreveable/mousetrap v1.1.0</span><br><span class="line">go: downloading go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.28.0</span><br><span class="line">go: downloading github.com/cenkalti/backoff/v4 v4.3.0</span><br><span class="line">go: downloading go.opentelemetry.io/proto/otlp v1.3.1</span><br><span class="line">go: downloading github.com/grpc-ecosystem/grpc-gateway/v2 v2.20.0</span><br><span class="line">go: downloading github.com/grpc-ecosystem/grpc-gateway v1.16.0</span><br><span class="line">Next: define a resource with:</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubebuilder create api</span></span><br></pre></td></tr></table></figure>

<p>æœ¬æ­¥éª¤åˆ›å»ºäº† Go module å·¥ç¨‹çš„æ¨¡æ¿æ–‡ä»¶ï¼Œå¼•å…¥äº†å¿…è¦çš„ä¾èµ–ã€‚<br>è¿™é‡Œå…ˆè®¾ç½®äº†goçš„ä»£ç†ï¼Œä¸ç„¶ä¼šæ— æ³•ä¸‹è½½ä¾èµ–ã€‚<br>ç¬¬ä¸€æ¬¡æ–°å»ºå·¥ç¨‹æ—¶ï¼Œä¼šä¸‹è½½ä¸€äº›ä¾èµ–(go: downloading ã€‚ã€‚ã€‚)<br>æŸ¥çœ‹æ­¤æ—¶çš„é¡¹ç›®ç»“æ„:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ cmd</span><br><span class="line">â”‚   â””â”€â”€ main.go</span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚   â”œâ”€â”€ default</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ manager_metrics_patch.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ metrics_service.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ manager</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ manager.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ network-policy</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ allow-metrics-traffic.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ prometheus</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ monitor.yaml</span><br><span class="line">â”‚   â””â”€â”€ rbac</span><br><span class="line">â”‚       â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ leader_election_role_binding.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ leader_election_role.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ metrics_auth_role_binding.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ metrics_auth_role.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ metrics_reader_role.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ role_binding.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ role.yaml</span><br><span class="line">â”‚       â””â”€â”€ service_account.yaml</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ go.sum</span><br><span class="line">â”œâ”€â”€ hack</span><br><span class="line">â”‚   â””â”€â”€ boilerplate.go.txt</span><br><span class="line">â”œâ”€â”€ Makefile</span><br><span class="line">â”œâ”€â”€ PROJECT</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â””â”€â”€ test</span><br><span class="line">    â”œâ”€â”€ e2e</span><br><span class="line">    â”‚   â”œâ”€â”€ e2e_suite_test.go</span><br><span class="line">    â”‚   â””â”€â”€ e2e_test.go</span><br><span class="line">    â””â”€â”€ utils</span><br><span class="line">        â””â”€â”€ utils.go</span><br><span class="line"></span><br><span class="line">12 directories, 29 files</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºAPIï¼Œç”ŸæˆCRDå’ŒController:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubebuilder create api --group apps --version v1 --kind Myapp</span><br></pre></td></tr></table></figure>

<p>å‚æ•°å«ä¹‰ï¼š</p>
<ul>
<li>groupå‚æ•°è¡¨ç¤ºç»„çš„æ¦‚å¿µ</li>
<li>versionå®šä¹‰ç‰ˆæœ¬</li>
<li>kindå®šä¹‰è‡ªå®šä¹‰èµ„æºç±»å‹</li>
<li>ä»¥ä¸Šå‚æ•°ç»„æˆ è‡ªå®šä¹‰yaml çš„ apiVersionå’Œkind</li>
<li>æ‰§è¡Œkubebuilder create apiæ—¶ç›´æ¥å¸¦ä¸Šâ€“namespaced&#x3D;falseå¯ä»¥å°†è¯¥å¯¹è±¡è®¾è®¡ä¸ºé›†ç¾¤çº§åˆ«ï¼ˆç±»ä¼¼nodeã€pvï¼‰</li>
</ul>
<p>åˆ›å»ºAPIç»“æœï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubebuilder create api --group apps --version v1 --kind Myapp</span><br><span class="line">INFO Create Resource [y/n]                        </span><br><span class="line">y</span><br><span class="line">INFO Create Controller [y/n]                      </span><br><span class="line">y</span><br><span class="line">INFO Writing kustomize manifests for you to edit... </span><br><span class="line">INFO Writing scaffold for you to edit...          </span><br><span class="line">INFO api/v1/myapp_types.go                        </span><br><span class="line">INFO api/v1/groupversion_info.go                  </span><br><span class="line">INFO internal/controller/suite_test.go            </span><br><span class="line">INFO internal/controller/myapp_controller.go      </span><br><span class="line">INFO internal/controller/myapp_controller_test.go </span><br><span class="line">INFO Update dependencies:</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go mod tidy</span>           </span><br><span class="line">INFO Running make:</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make generate</span>                </span><br><span class="line">mkdir -p /home/king/workspace/king-devops/operator/myapp-operator/bin</span><br><span class="line">Downloading sigs.k8s.io/controller-tools/cmd/controller-gen@v0.16.1</span><br><span class="line">go: downloading sigs.k8s.io/controller-tools v0.16.1</span><br><span class="line">go: downloading github.com/fatih/color v1.17.0</span><br><span class="line">go: downloading golang.org/x/tools v0.24.0</span><br><span class="line">go: downloading github.com/gobuffalo/flect v1.0.2</span><br><span class="line">go: downloading golang.org/x/net v0.28.0</span><br><span class="line">go: downloading github.com/mattn/go-isatty v0.0.20</span><br><span class="line">go: downloading github.com/mattn/go-colorable v0.1.13</span><br><span class="line">go: downloading golang.org/x/sys v0.23.0</span><br><span class="line">go: downloading golang.org/x/sync v0.8.0</span><br><span class="line">go: downloading golang.org/x/mod v0.20.0</span><br><span class="line">go: downloading golang.org/x/text v0.17.0</span><br><span class="line">/home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;</span><br><span class="line">Next: implement your new API and generate the manifests (e.g. CRDs,CRs) with:</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make manifests</span></span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶çš„ç›®å½•ç»“æ„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ api</span><br><span class="line">â”‚   â””â”€â”€ v1</span><br><span class="line">â”‚       â”œâ”€â”€ groupversion_info.go</span><br><span class="line">â”‚       â”œâ”€â”€ myapp_types.go</span><br><span class="line">â”‚       â””â”€â”€ zz_generated.deepcopy.go</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”‚   â”œâ”€â”€ controller-gen -&gt; /home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen-v0.16.1</span><br><span class="line">â”‚   â””â”€â”€ controller-gen-v0.16.1</span><br><span class="line">â”œâ”€â”€ cmd</span><br><span class="line">â”‚   â””â”€â”€ main.go</span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚   â”œâ”€â”€ crd</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ kustomizeconfig.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ default</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ manager_metrics_patch.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ metrics_service.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ manager</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ manager.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ network-policy</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ allow-metrics-traffic.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ prometheus</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ monitor.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ rbac</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ leader_election_role_binding.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ leader_election_role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ metrics_auth_role_binding.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ metrics_auth_role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ metrics_reader_role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ myapp_editor_role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ myapp_viewer_role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ role_binding.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ role.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ service_account.yaml</span><br><span class="line">â”‚   â””â”€â”€ samples</span><br><span class="line">â”‚       â”œâ”€â”€ apps_v1_myapp.yaml</span><br><span class="line">â”‚       â””â”€â”€ kustomization.yaml</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ go.sum</span><br><span class="line">â”œâ”€â”€ hack</span><br><span class="line">â”‚   â””â”€â”€ boilerplate.go.txt</span><br><span class="line">â”œâ”€â”€ internal</span><br><span class="line">â”‚   â””â”€â”€ controller</span><br><span class="line">â”‚       â”œâ”€â”€ myapp_controller.go</span><br><span class="line">â”‚       â”œâ”€â”€ myapp_controller_test.go</span><br><span class="line">â”‚       â””â”€â”€ suite_test.go</span><br><span class="line">â”œâ”€â”€ Makefile</span><br><span class="line">â”œâ”€â”€ PROJECT</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â””â”€â”€ test</span><br><span class="line">    â”œâ”€â”€ e2e</span><br><span class="line">    â”‚   â”œâ”€â”€ e2e_suite_test.go</span><br><span class="line">    â”‚   â””â”€â”€ e2e_test.go</span><br><span class="line">    â””â”€â”€ utils</span><br><span class="line">        â””â”€â”€ utils.go</span><br><span class="line"></span><br><span class="line">19 directories, 43 files</span><br></pre></td></tr></table></figure>

<p>å¦‚æœéœ€è¦åœ¨Nginx CRUD æ—¶è¿›è¡Œåˆæ³•æ€§æ£€æŸ¥ï¼Œ å¯ä»¥ç”Ÿæˆwebhook:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubebuilder create webhook --group apps --version v1 --kind Myapp --conversion --defaulting --programmatic-validation</span><br></pre></td></tr></table></figure>

<p>å‚æ•°å«ä¹‰ï¼š</p>
<ul>
<li>groupå‚æ•°è¡¨ç¤ºç»„çš„æ¦‚å¿µ</li>
<li>versionå®šä¹‰ç‰ˆæœ¬</li>
<li>kindå®šä¹‰è‡ªå®šä¹‰èµ„æºç±»å‹</li>
<li>ä»¥ä¸Šå‚æ•°ç»„æˆ è‡ªå®šä¹‰yaml çš„ apiVersionå’Œkind</li>
<li>defaultingï¼šé»˜è®¤å€¼è®¾ç½®ï¼ˆDefaultingï¼‰ çš„ç›®çš„æ˜¯åœ¨CRDå¯¹è±¡åˆ›å»ºæˆ–æ›´æ–°æ—¶ï¼Œå¦‚æœæŸäº›å­—æ®µæ²¡æœ‰è¢«æ˜¾å¼è®¾ç½®å€¼ï¼Œè‡ªåŠ¨ä¸ºå…¶å¡«å……ä¸€ä¸ªåˆç†çš„é»˜è®¤å€¼ã€‚è¿™å¯¹äºç¡®ä¿èµ„æºå®ä¾‹æœ‰ä¸€å¥—ç»Ÿä¸€çš„ã€é¢„å…ˆå®šä¹‰çš„é…ç½®éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥å‡å°‘ç”¨æˆ·çš„é…ç½®è´Ÿæ‹…ï¼Œå¹¶ä¿è¯èµ„æºçš„ä¸€è‡´æ€§ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ å®šä¹‰äº†ä¸€ä¸ªç›‘æ§åº”ç”¨çš„CRDï¼Œå¯èƒ½å¸Œæœ›é»˜è®¤å¼€å¯æ—¥å¿—è®°å½•åŠŸèƒ½ï¼Œé™¤éç”¨æˆ·æ˜ç¡®å…³é—­å®ƒã€‚</li>
<li>programmatic-validationï¼šç¨‹åºåŒ–éªŒè¯ï¼ˆProgrammatic Validationï¼‰ åˆ™æ˜¯åœ¨CRDå¯¹è±¡åˆ›å»ºæˆ–æ›´æ–°å‰ï¼Œå¯¹æäº¤çš„æ•°æ®è¿›è¡Œé€»è¾‘éªŒè¯çš„æœºåˆ¶ã€‚ä¸CRD schemaæä¾›çš„é™æ€éªŒè¯ç›¸æ¯”ï¼Œç¨‹åºåŒ–éªŒè¯å¯ä»¥å®ç°æ›´åŠ å¤æ‚çš„ä¸šåŠ¡é€»è¾‘éªŒè¯ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥åœ¨webhookæœåŠ¡ä¸­ç¼–å†™ä»£ç æ¥æ£€æŸ¥CRDå®ä¾‹çš„æ•°æ®æ˜¯å¦æ»¡è¶³ç‰¹å®šçš„ä¸šåŠ¡è§„åˆ™æˆ–çº¦æŸæ¡ä»¶ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥éªŒè¯ä¸€ä¸ªèµ„æºè¯·æ±‚çš„å†…å­˜é…é¢æ˜¯å¦è¶…è¿‡äº†é›†ç¾¤çš„æœ€å¤§å…è®¸å€¼ï¼Œæˆ–è€…ç¡®ä¿å¼•ç”¨çš„å…¶ä»–èµ„æºç¡®å®å­˜åœ¨ã€‚</li>
<li>conversionï¼šè‡ªåŠ¨æ•°æ®è¿ç§»ï¼šconversion webhookå¯ä»¥åœ¨åå°è‡ªåŠ¨å°†CRDçš„ä¸€ä¸ªç‰ˆæœ¬è½¬æ¢ä¸ºå¦ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ— éœ€äººå·¥å¹²é¢„ï¼Œä»è€Œç®€åŒ–äº†ç‰ˆæœ¬å‡çº§è¿‡ç¨‹ã€‚<ul>
<li>å…¼å®¹æ€§ä¿éšœï¼šå³ä½¿APIå‘ç”Ÿå˜åŒ–ï¼Œä¹Ÿèƒ½ç¡®ä¿æ—§å®¢æˆ·ç«¯å’Œæ–°å®¢æˆ·ç«¯éƒ½èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œæé«˜äº†ç³»ç»Ÿçš„å‘åå’Œå‘å‰å…¼å®¹æ€§ã€‚</li>
<li>å¤æ‚é€»è¾‘å¤„ç†ï¼šå¯¹äºç®€å•çš„å­—æ®µæ·»åŠ æˆ–åˆ é™¤ï¼ŒKubernetesçš„è‡ªåŠ¨è½¬æ¢å™¨å¯èƒ½è¶³å¤Ÿç”¨ã€‚ä½†æ¶‰åŠåˆ°å¤æ‚çš„æ•°æ®ç»“æ„è°ƒæ•´æˆ–é€»è¾‘å˜æ¢æ—¶ï¼Œå°±éœ€è¦è‡ªå®šä¹‰conversion webhookæ¥ç²¾ç¡®æ§åˆ¶è½¬æ¢è¿‡ç¨‹ã€‚</li>
</ul>
</li>
</ul>
<p>æ‰§è¡Œç»“æœï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubebuilder create webhook --group apps --version v1 --kind Myapp --conversion --defaulting --programmatic-validation</span><br><span class="line">INFO Writing kustomize manifests for you to edit... </span><br><span class="line">INFO Writing scaffold for you to edit...          </span><br><span class="line">INFO api/v1/myapp_webhook.go                      </span><br><span class="line">INFO api/v1/myapp_webhook_test.go                 </span><br><span class="line">INFO Webhook server has been set up for you.</span><br><span class="line">You need to implement the conversion.Hub and conversion.Convertible interfaces for your CRD types. </span><br><span class="line">INFO api/v1/webhook_suite_test.go                 </span><br><span class="line">INFO Update dependencies:</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go mod tidy</span>           </span><br><span class="line">INFO Running make:</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make generate</span>                </span><br><span class="line">/home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;</span><br><span class="line">Next: implement your new Webhook and generate the manifests with:</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make manifests</span></span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ç›®å½•ç»“æ„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ api</span><br><span class="line">â”‚   â””â”€â”€ v1</span><br><span class="line">â”‚       â”œâ”€â”€ groupversion_info.go</span><br><span class="line">â”‚       â”œâ”€â”€ myapp_types.go</span><br><span class="line">â”‚       â”œâ”€â”€ myapp_webhook.go</span><br><span class="line">â”‚       â”œâ”€â”€ myapp_webhook_test.go</span><br><span class="line">â”‚       â”œâ”€â”€ webhook_suite_test.go</span><br><span class="line">â”‚       â””â”€â”€ zz_generated.deepcopy.go</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”‚   â”œâ”€â”€ controller-gen -&gt; /home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen-v0.16.1</span><br><span class="line">â”‚   â””â”€â”€ controller-gen-v0.16.1</span><br><span class="line">â”œâ”€â”€ cmd</span><br><span class="line">â”‚   â””â”€â”€ main.go</span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚   â”œâ”€â”€ certmanager</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ certificate.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ kustomizeconfig.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ crd</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomizeconfig.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ patches</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ cainjection_in_myapps.yaml</span><br><span class="line">â”‚   â”‚       â””â”€â”€ webhook_in_myapps.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ default</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ manager_metrics_patch.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ manager_webhook_patch.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ metrics_service.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ webhookcainjection_patch.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ manager</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ manager.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ network-policy</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ allow-metrics-traffic.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ allow-webhook-traffic.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ prometheus</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ monitor.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ rbac</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ leader_election_role_binding.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ leader_election_role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ metrics_auth_role_binding.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ metrics_auth_role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ metrics_reader_role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ myapp_editor_role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ myapp_viewer_role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ role_binding.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ role.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ service_account.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ samples</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ apps_v1_myapp.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â””â”€â”€ webhook</span><br><span class="line">â”‚       â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ kustomizeconfig.yaml</span><br><span class="line">â”‚       â””â”€â”€ service.yaml</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ go.sum</span><br><span class="line">â”œâ”€â”€ hack</span><br><span class="line">â”‚   â””â”€â”€ boilerplate.go.txt</span><br><span class="line">â”œâ”€â”€ internal</span><br><span class="line">â”‚   â””â”€â”€ controller</span><br><span class="line">â”‚       â”œâ”€â”€ myapp_controller.go</span><br><span class="line">â”‚       â”œâ”€â”€ myapp_controller_test.go</span><br><span class="line">â”‚       â””â”€â”€ suite_test.go</span><br><span class="line">â”œâ”€â”€ Makefile</span><br><span class="line">â”œâ”€â”€ PROJECT</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â””â”€â”€ test</span><br><span class="line">    â”œâ”€â”€ e2e</span><br><span class="line">    â”‚   â”œâ”€â”€ e2e_suite_test.go</span><br><span class="line">    â”‚   â””â”€â”€ e2e_test.go</span><br><span class="line">    â””â”€â”€ utils</span><br><span class="line">        â””â”€â”€ utils.go</span><br><span class="line"></span><br><span class="line">22 directories, 57 files</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆçš„å·¥ç¨‹ç»“æ„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ api</span><br><span class="line">â”‚   â””â”€â”€ v1</span><br><span class="line">â”‚       â”œâ”€â”€ groupversion_info.go</span><br><span class="line">â”‚       â”œâ”€â”€ myapp_types.go</span><br><span class="line">â”‚       â”œâ”€â”€ myapp_webhook.go</span><br><span class="line">â”‚       â”œâ”€â”€ myapp_webhook_test.go</span><br><span class="line">â”‚       â”œâ”€â”€ webhook_suite_test.go</span><br><span class="line">â”‚       â””â”€â”€ zz_generated.deepcopy.go</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”‚   â”œâ”€â”€ controller-gen -&gt; /home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen-v0.16.1</span><br><span class="line">â”‚   â””â”€â”€ controller-gen-v0.16.1</span><br><span class="line">â”œâ”€â”€ cmd</span><br><span class="line">â”‚   â””â”€â”€ main.go</span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚   â”œâ”€â”€ certmanager</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ certificate.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ kustomizeconfig.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ crd</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomizeconfig.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ patches</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ cainjection_in_myapps.yaml</span><br><span class="line">â”‚   â”‚       â””â”€â”€ webhook_in_myapps.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ default</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ manager_metrics_patch.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ manager_webhook_patch.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ metrics_service.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ webhookcainjection_patch.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ manager</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ manager.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ network-policy</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ allow-metrics-traffic.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ allow-webhook-traffic.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ prometheus</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ monitor.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ rbac</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ leader_election_role_binding.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ leader_election_role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ metrics_auth_role_binding.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ metrics_auth_role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ metrics_reader_role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ myapp_editor_role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ myapp_viewer_role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ role_binding.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ role.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ service_account.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ samples</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ apps_v1_myapp.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â””â”€â”€ webhook</span><br><span class="line">â”‚       â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ kustomizeconfig.yaml</span><br><span class="line">â”‚       â””â”€â”€ service.yaml</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ go.sum</span><br><span class="line">â”œâ”€â”€ hack</span><br><span class="line">â”‚   â””â”€â”€ boilerplate.go.txt</span><br><span class="line">â”œâ”€â”€ internal</span><br><span class="line">â”‚   â””â”€â”€ controller</span><br><span class="line">â”‚       â”œâ”€â”€ myapp_controller.go</span><br><span class="line">â”‚       â”œâ”€â”€ myapp_controller_test.go</span><br><span class="line">â”‚       â””â”€â”€ suite_test.go</span><br><span class="line">â”œâ”€â”€ Makefile</span><br><span class="line">â”œâ”€â”€ PROJECT</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â””â”€â”€ test</span><br><span class="line">    â”œâ”€â”€ e2e</span><br><span class="line">    â”‚   â”œâ”€â”€ e2e_suite_test.go</span><br><span class="line">    â”‚   â””â”€â”€ e2e_test.go</span><br><span class="line">    â””â”€â”€ utils</span><br><span class="line">        â””â”€â”€ utils.go</span><br><span class="line"></span><br><span class="line">22 directories, 57 files</span><br></pre></td></tr></table></figure>

<p>å…³é”®ç›®å½•åŠå…¶å†…å®¹çš„æ¦‚è¿°ï¼š</p>
<ul>
<li>Dockerfile: å®šä¹‰äº†ç”¨äºæ„å»ºOperatorå®¹å™¨é•œåƒçš„Dockeré…ç½®æ–‡ä»¶ã€‚</li>
<li>Makefile: åŒ…å«äº†ä¸€ç³»åˆ—é¢„å®šä¹‰çš„Makeä»»åŠ¡ï¼Œç”¨äºæ„å»ºã€æµ‹è¯•ã€è¿è¡Œå’Œéƒ¨ç½²Operatorã€‚</li>
<li>PROJECT: å­˜å‚¨é¡¹ç›®å…ƒæ•°æ®çš„æ–‡ä»¶ï¼ŒKubebuilderä½¿ç”¨å®ƒæ¥è·Ÿè¸ªé¡¹ç›®çš„çŠ¶æ€å’Œé…ç½®ã€‚</li>
<li>README.md: é¡¹ç›®çš„ä¸»è¦è¯´æ˜æ–‡æ¡£ï¼Œé€šå¸¸åŒ…å«é¡¹ç›®ç®€ä»‹ã€å®‰è£…æŒ‡å—ã€å¼€å‘æµç¨‹ç­‰ä¿¡æ¯ã€‚</li>
<li>api&#x2F;v1: å®šä¹‰äº†è‡ªå®šä¹‰èµ„æºå®šä¹‰(CRD)çš„ç›®å½•ï¼Œå…¶ä¸­åŒ…å«äº†èµ„æºçš„Goç±»å‹å®šä¹‰åŠDeepCopyç”Ÿæˆæ–‡ä»¶ã€‚<ul>
<li>myapp_types.go: èµ„æºç±»å‹çš„å®šä¹‰(myapp_types.go)</li>
<li>myapp_webhook.go: webhooké€»è¾‘</li>
<li>zz_generated.deepcopy.go: æ·±æ‹·è´ç”Ÿæˆä»£ç </li>
<li>groupversion_info.go: å®šä¹‰äº†APIç»„å’Œç‰ˆæœ¬ä¿¡æ¯ã€‚</li>
</ul>
</li>
<li>bin: å­˜æ”¾é¡¹ç›®ä¾èµ–çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¦‚controller-genï¼Œç”¨äºCRDä»£ç ç”Ÿæˆã€‚</li>
<li>cmd&#x2F;main.go: Operatorçš„å…¥å£ç‚¹ï¼Œè´Ÿè´£åˆå§‹åŒ–å’Œè¿è¡Œæ§åˆ¶å™¨ã€‚</li>
<li>config: é…ç½®ç›®å½•ï¼ŒåŒ…å«ç”¨äºKubernetesèµ„æºéƒ¨ç½²çš„å„ç§Kustomizeé…ç½®ã€‚<ul>
<li>crd&#x2F;: ç”¨äºCRDèµ„æºçš„Kustomizeé…ç½®ã€‚</li>
<li>default&#x2F;: åº”ç”¨é»˜è®¤çš„RBACã€æœåŠ¡ç­‰é…ç½®ã€‚</li>
<li>manager&#x2F;: Operator Managerçš„éƒ¨ç½²é…ç½®ã€‚</li>
<li>network-policy&#x2F;, prometheus&#x2F;, rbac&#x2F;, samples&#x2F;: åˆ†åˆ«åŒ…å«ç½‘ç»œç­–ç•¥ã€Prometheusç›‘æ§é…ç½®ã€RBACè§„åˆ™å’Œç¤ºä¾‹èµ„æºçš„é…ç½®ã€‚</li>
</ul>
</li>
<li>go.mod, go.sum: Goæ¨¡å—ç®¡ç†æ–‡ä»¶ï¼Œè®°å½•é¡¹ç›®ä¾èµ–ã€‚</li>
<li>hack&#x2F;boilerplate.go.txt: ç”¨äºä»£ç ç”Ÿæˆçš„æ¨¡æ¿æ–‡ä»¶ï¼Œä¿æŒç‰ˆæƒå¤´éƒ¨ä¸€è‡´æ€§ã€‚</li>
<li>internal&#x2F;controller: Operatoræ§åˆ¶å™¨çš„æ ¸å¿ƒé€»è¾‘æ‰€åœ¨ï¼ŒåŒ…å«ç›‘æ§èµ„æº(Myapp)çš„æ§åˆ¶å™¨å®ç°ã€‚</li>
<li>test: æµ‹è¯•ç›¸å…³ç›®å½•ã€‚<ul>
<li>e2e&#x2F;: ç«¯åˆ°ç«¯æµ‹è¯•ä»£ç ï¼ŒéªŒè¯æ•´ä¸ªOperatoråœ¨Kubernetesé›†ç¾¤ä¸Šçš„è¡Œä¸ºã€‚</li>
<li>utils&#x2F;: æµ‹è¯•è¾…åŠ©å·¥å…·å’Œå‡½æ•°ã€‚</li>
</ul>
</li>
</ul>
<h1 id="3ã€ç¼–å†™ä»£ç "><a href="#3ã€ç¼–å†™ä»£ç " class="headerlink" title="3ã€ç¼–å†™ä»£ç "></a>3ã€ç¼–å†™ä»£ç </h1><p>ä¸‹é¢ä¸»è¦ä»¥Deploymentä¸ºä¾‹ï¼Œæ ¸å¿ƒé€»è¾‘æ˜¯æŠŠè‡ªå®šä¹‰CRï¼ˆMyappï¼‰å½“åšç»ˆæ€ï¼ŒæŠŠDeploymentå½“åšè¿è¡Œæ€ï¼Œé€šè¿‡æ¯”å¯¹å±æ€§çš„ä¸ä¸€è‡´ï¼Œç¼–å†™ç›¸å…³çš„Reconcileé€»è¾‘ã€‚</p>
<p>ä¸€å¼ å›¾è§£é‡Šå„ç§èµ„æºå’Œ Controller çš„å…³ç³»ï¼š<br><img src="/img_4.png" alt="img_4.png"></p>
<h2 id="3-1-å®šä¹‰-CRD"><a href="#3-1-å®šä¹‰-CRD" class="headerlink" title="3.1 å®šä¹‰ CRD"></a>3.1 å®šä¹‰ CRD</h2><p>åœ¨api&#x2F;v1&#x2F;myapp_type.goä¸­å®šä¹‰ Spec å’Œ Status</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// MyappSpec defines the desired state of Myapp</span><br><span class="line">type MyappSpec struct &#123;</span><br><span class="line">        // INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</span><br><span class="line">        // Important: Run &quot;make&quot; to regenerate code after modifying this file</span><br><span class="line"></span><br><span class="line">        // Foo is an example field of Myapp. Edit myapp_types.go to remove/update</span><br><span class="line">        Foo                   string `json:&quot;foo,omitempty&quot;`</span><br><span class="line">        appsv1.DeploymentSpec `json:&quot;,inline&quot;`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// MyappStatus defines the observed state of Myapp</span><br><span class="line">type MyappStatus struct &#123;</span><br><span class="line">        // INSERT ADDITIONAL STATUS FIELD - define observed state of cluster</span><br><span class="line">        // Important: Run &quot;make&quot; to regenerate code after modifying this file</span><br><span class="line">        appsv1.DeploymentSpec `json:&quot;,inline&quot;`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// +kubebuilder:object:root=true</span><br><span class="line">// +kubebuilder:subresource:status</span><br><span class="line"></span><br><span class="line">// Myapp is the Schema for the myapps API</span><br><span class="line">type Myapp struct &#123;</span><br><span class="line">        metav1.TypeMeta   `json:&quot;,inline&quot;`</span><br><span class="line">        metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`</span><br><span class="line"></span><br><span class="line">        Spec   MyappSpec   `json:&quot;spec,omitempty&quot;`</span><br><span class="line">        Status MyappStatus `json:&quot;status,omitempty&quot;`</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„<code>+kubebuilder</code>å¹¶éæ™®é€šæ³¨é‡Šï¼Œä¸èƒ½éšæ„åˆ é™¤ã€‚</p>
<h2 id="3-2-ç¼–å†™Reconcileé€»è¾‘"><a href="#3-2-ç¼–å†™Reconcileé€»è¾‘" class="headerlink" title="3.2 ç¼–å†™Reconcileé€»è¾‘"></a>3.2 ç¼–å†™Reconcileé€»è¾‘</h2><p>åœ¨internal&#x2F;controller&#x2F;myapp_controller.goä¸­å®ç° Reconcile é€»è¾‘</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">func (r *MyappReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) &#123;</span><br><span class="line">        logger := log.FromContext(ctx)</span><br><span class="line"></span><br><span class="line">        // TODO(user): your logic here</span><br><span class="line">        logger.Info(&quot;start Reconcile&quot; + req.Name)</span><br><span class="line"></span><br><span class="line">        return ctrl.Result&#123;&#125;, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-3-ä¿®æ”¹Webhook"><a href="#3-3-ä¿®æ”¹Webhook" class="headerlink" title="3.3 ä¿®æ”¹Webhook"></a>3.3 ä¿®æ”¹Webhook</h2><p>åœ¨api&#x2F;v1&#x2F;myapp_webhook.goä¸­æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">func (r *Myapp) ValidateCreate() error </span><br><span class="line">func (r *Myapp) ValidateUpdate(old runtime.Object) error</span><br><span class="line">func (r *Myapp) Default()</span><br></pre></td></tr></table></figure>

<h2 id="3-4-ä¿®æ”¹mainå…¥å£"><a href="#3-4-ä¿®æ”¹mainå…¥å£" class="headerlink" title="3.4 ä¿®æ”¹mainå…¥å£"></a>3.4 ä¿®æ”¹mainå…¥å£</h2><p>ä»¥å‰çš„è€ç‰ˆæœ¬kubebuilderç”Ÿæˆçš„é¡¹ç›®ï¼Œéœ€è¦åœ¨cmd&#x2F;main.goæ·»åŠ ç›‘å¬çš„namespace<br>ä½†æ˜¯æ–°ç‰ˆæœ¬æ²¡æœ‰è¿™ä¸ªä¿¡æ¯ï¼Œä»¥ä¸‹æ˜¯ç¤ºä¾‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options&#123;</span><br><span class="line">                Scheme:                 scheme,</span><br><span class="line">                Metrics:                metricsServerOptions,</span><br><span class="line">                WebhookServer:          webhookServer,</span><br><span class="line">                HealthProbeBindAddress: probeAddr,</span><br><span class="line">                LeaderElection:         enableLeaderElection,</span><br><span class="line">                LeaderElectionID:       &quot;6a511ed4.kubenode.kingtest.com&quot;,</span><br><span class="line">                // LeaderElectionReleaseOnCancel defines if the leader should step down voluntarily</span><br><span class="line">                // when the Manager ends. This requires the binary to immediately end when the</span><br><span class="line">                // Manager is stopped, otherwise, this setting is unsafe. Setting this significantly</span><br><span class="line">                // speeds up voluntary leader transitions as the new leader don&#x27;t have to wait</span><br><span class="line">                // LeaseDuration time first.</span><br><span class="line">                //</span><br><span class="line">                // In the default scaffold provided, the program ends immediately after</span><br><span class="line">                // the manager stops, so would be fine to enable this option. However,</span><br><span class="line">                // if you are doing or is intended to do any operation such as perform cleanups</span><br><span class="line">                // after the manager stops then its usage might be unsafe.</span><br><span class="line">                // LeaderElectionReleaseOnCancel: true,</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæƒ³ç›‘å¬å›ºå®šçš„namespaceä¿¡æ¯ï¼Œå¯ä»¥åœ¨Reconcileå†…å®ç°ã€‚</p>
]]></content>
  </entry>
  <entry>
    <title>operatorç®€ä»‹</title>
    <url>/2025/07/kubernetes/Operator%E5%BC%80%E5%8F%91/operator%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h1 id="1-kubernetesèƒŒæ™¯"><a href="#1-kubernetesèƒŒæ™¯" class="headerlink" title="1 kubernetesèƒŒæ™¯"></a>1 kubernetesèƒŒæ™¯</h1><h2 id="1-1-Controlleræ¨¡å¼"><a href="#1-1-Controlleræ¨¡å¼" class="headerlink" title="1.1 Controlleræ¨¡å¼"></a>1.1 Controlleræ¨¡å¼</h2><p>controlleré€šè¿‡æ ¹æ®è¢«æ§åˆ¶å¯¹è±¡çš„å±æ€§å’Œå­—æ®µæ¥å®ç°ç¼–æ’ï¼Œå¯¹äºæ¯ä¸€ä¸ªbuild-inçš„èµ„æºç±»å‹ï¼Œéƒ½æœ‰å¯¹åº”çš„controllerã€‚</p>
<p>æ¯”å¦‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„Deploymentçš„yamlç¤ºä¾‹ï¼š</p>
<p>å…¶å¯¹åº”çš„Deployment Controllerç¼–æ’åŠ¨ä½œæ˜¯ç¡®ä¿app&#x3D;testçš„Podæ•°é‡ä¸º2ï¼ŒPodçš„å±æ€§å’Œå­—æ®µç”±spec.templateå®šä¹‰</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>æ‰€æœ‰æ§åˆ¶å™¨çš„ä¸»è¦æ“ä½œéƒ½æ˜¯ä¸€ä¸ªè°ƒè°å¾ªç¯ï¼ˆReconcile loopï¼‰ã€‚ä¸»è¦æœ‰ä¸‰æ­¥ï¼š</p>
<ul>
<li>è§‚å¯ŸæœŸæœ›çš„çŠ¶æ€ã€‚</li>
<li>è§‚å¯Ÿæ‰€ç®¡ç†èµ„æºçš„å½“å‰çŠ¶æ€ã€‚</li>
<li>é‡‡å–è¡ŒåŠ¨ï¼Œä½¿æ‰˜ç®¡çš„èµ„æºå¤„åœ¨æœŸæœ›çš„çŠ¶æ€ã€‚<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">for &#123;</span><br><span class="line">    actualState := GetResourceActualState(rsvc)</span><br><span class="line">    expectState := GetResourceExpectState(rsvc)</span><br><span class="line">    if actualState == expectState &#123;</span><br><span class="line">        // do nothing</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        Reconcile(rsvc)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="1-2-å£°æ˜å¼API"><a href="#1-2-å£°æ˜å¼API" class="headerlink" title="1.2 å£°æ˜å¼API"></a>1.2 å£°æ˜å¼API</h2><p>å£°æ˜å¼APIï¼šå‘Šè¯‰K8Sä½ è¦ä»€ä¹ˆï¼Œè€Œä¸æ˜¯å‘Šè¯‰å®ƒä½ æ€ä¹ˆåšã€‚</p>
<p>å£°æ˜å¼APIçš„æ“ä½œä½“ç°åœ¨kubectl applyå‘½ä»¤ä¸Šï¼Œåœ¨å¯¹è±¡åˆ›å»ºå’Œåç»­ä¿®æ”¹æ›´æ–°éƒ½ä½¿ç”¨applyå‘½ä»¤ï¼Œå‘Šè¯‰k8så¯¹è±¡çš„ç»ˆæ€å³å¯ï¼Œåº•å±‚çš„å®ç°æ˜¯ä¸€ä¸ªå¯¹åŸæœ‰APIå¯¹è±¡çš„PATCHæ“ä½œå®ç°çš„ï¼Œå¯ä»¥ä¸€æ¬¡æ€§å¤„ç†å¤šä¸ªå†™æ“ä½œï¼Œç›¸å¯¹äºå‘½ä»¤æ—¶ä¸€ä¸ªä¸ªçš„å‘½ä»¤å¤§å¤§æé«˜äº†æ“ä½œæ•ˆç‡ã€‚</p>
<p>æ¯”å¦‚ä¸Šé¢çš„deployment.yamlæ–‡ä»¶ï¼Œåœ¨æäº¤åä¼šé€šè¿‡Group&#x2F;Version&#x2F;Resourceçš„åˆ†çº§æ¥æ‰¾åˆ°deploymentåœ¨GOè¯­è¨€ä¸­çš„ç»“æ„ä½“å®šä¹‰ï¼Œä»è€Œå°†YAMLæè¿°è½¬æ¢æˆä¸€ä¸ªåºåˆ—åŒ–çš„deploymentå¯¹è±¡ï¼Œå¹¶é€šè¿‡etcdçš„APIå°†å…¶ä¿å­˜èµ·æ¥ã€‚</p>
<h2 id="1-3-â€œåŸç”Ÿçš„èµ„æº-Controllerâ€çš„é—®é¢˜"><a href="#1-3-â€œåŸç”Ÿçš„èµ„æº-Controllerâ€çš„é—®é¢˜" class="headerlink" title="1.3 â€œåŸç”Ÿçš„èµ„æº-Controllerâ€çš„é—®é¢˜"></a>1.3 â€œåŸç”Ÿçš„èµ„æº-Controllerâ€çš„é—®é¢˜</h2><ul>
<li>åŸç”Ÿèµ„æºä¸å¤Ÿç”¨<ul>
<li>K8Så†…éƒ¨çš„åŸºç¡€èµ„æºï¼Œå¦‚Podã€Statefulsetã€Serviceï¼Œèƒ½å¤Ÿè¦†ç›–å¤§éƒ¨åˆ†åº”ç”¨çš„å·¥ä½œæ¨¡å¼ã€‚</li>
<li>ä½†å¯¹ä»¥ä¸‹æƒ…å†µä¸å‹å¥½ï¼š<ul>
<li>æœ‰äº›åº”ç”¨ç»„ä»¶æ— æ³•æ‰¾åˆ°åˆé€‚çš„åŸºç¡€èµ„æºä½œä¸ºæ¨¡æ¿ï¼Œæ¯”å¦‚GPUèµ„æºã€è®­ç»ƒæ•°æ®é›†ã€è®­ç»ƒä»»åŠ¡ç­‰ï¼›</li>
<li>æœ‰äº›åº”ç”¨ç»„ä»¶éœ€è¦å¤šä¸ªåŸºç¡€èµ„æºå…±åŒè¾“å‡ºä¸€é¡¹èƒ½åŠ›ï¼Œä¼šå˜å¾—å¾ˆå¤æ‚ï¼›</li>
</ul>
</li>
</ul>
</li>
<li>ç»†ç²’åº¦æ“ä½œç¹ç<ul>
<li>éœ€è¦å¯¹äº‘åŸç”ŸK8Sçš„ç»†ç²’åº¦èµ„æºçš„ç§ç±»æ¯”è¾ƒç†Ÿæ‚‰ï¼›</li>
<li>åº”ç”¨åœ¨æä¾›æœåŠ¡æ—¶ï¼Œå­˜åœ¨é€šè¿‡Labelç­‰æ ‡ç­¾ä¿¡æ¯å¯¹åº”çš„é€»è¾‘ã€‚</li>
</ul>
</li>
<li>ç¼ºä¹å®šåˆ¶åŒ–èƒ½åŠ›ï¼Œå¦‚ï¼š<ul>
<li>ä¸€äº›ç®€å•çš„ä¸­é—´ä»¶é›†æˆ</li>
<li>å¯¹ä¸åŒèµ„æºçš„æ“ä½œæ—¶åºçš„æµæ°´çº¿ç®¡ç†ã€‚</li>
</ul>
</li>
</ul>
<h2 id="1-4-æ‹“å±•è‡ªå®šä¹‰èµ„æºä¸æ§åˆ¶å™¨"><a href="#1-4-æ‹“å±•è‡ªå®šä¹‰èµ„æºä¸æ§åˆ¶å™¨" class="headerlink" title="1.4 æ‹“å±•è‡ªå®šä¹‰èµ„æºä¸æ§åˆ¶å™¨"></a>1.4 æ‹“å±•è‡ªå®šä¹‰èµ„æºä¸æ§åˆ¶å™¨</h2><p>ä¸»è¦åšä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>ç¼–å†™è‡ªå®šä¹‰èµ„æºï¼Œå¹¶å°†å…¶éƒ¨ç½²åˆ°K8Sé›†ç¾¤ä¸­: é€šè¿‡ç¼–å†™ç¬¦åˆK8Sèµ„æºå’Œç»“æ„å±æ€§çš„æ–‡ä»¶ï¼Œä½¿å¾—K8Sèƒ½å¤Ÿæ ¡éªŒè¯¥èµ„æºå¹¶è¿›è¡ŒæŒä¹…åŒ–ã€‚</li>
<li>ç¼–å†™å…¶å¯¹åº”çš„æ§åˆ¶å™¨ï¼Œå¹¶å°†å…¶éƒ¨ç½²åˆ°K8Sé›†ç¾¤ä¸­: é€šè¿‡å®ç°è°ƒè°é€»è¾‘ï¼Œæ¥å®Œæˆèµ„æºç¼–æ’çš„å®é™…éœ€æ±‚ã€‚</li>
</ul>
<h1 id="2ã€Operator-ä»‹ç»"><a href="#2ã€Operator-ä»‹ç»" class="headerlink" title="2ã€Operator ä»‹ç»"></a>2ã€Operator ä»‹ç»</h1><h2 id="2-1-Operator"><a href="#2-1-Operator" class="headerlink" title="2.1 Operator"></a>2.1 Operator</h2><p>å€ŸåŠ© Kubernetes çš„æ§åˆ¶å™¨æ¨¡å¼ï¼Œç¼–å†™è‡ªå®šä¹‰çš„ç¼–æ’è§„åˆ™ï¼Œå®Œæˆå¯¹è‡ªå®šä¹‰èµ„æºçš„æ“ä½œï¼Œæ¯”å¦‚å¢åˆ æ”¹æŸ¥ç­‰ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼ŒOperator&#x3D;CRD(è‡ªå®šä¹‰èµ„æº)+Controller(è‡ªå®šä¹‰æ§åˆ¶å™¨)+Webhook(Admissionæ ¹æ®å®é™…æƒ…å†µé€‰æ‹©æ˜¯å¦æ·»åŠ )</p>
<h2 id="2-2-è‡ªå®šä¹‰èµ„æº-CRD"><a href="#2-2-è‡ªå®šä¹‰èµ„æº-CRD" class="headerlink" title="2.2 è‡ªå®šä¹‰èµ„æº CRD"></a>2.2 è‡ªå®šä¹‰èµ„æº CRD</h2><p>CRDï¼ˆCustom Resource Definitionï¼‰æ˜¯ç”¨æˆ·çš„è‡ªå®šä¹‰èµ„æºç±»å‹ï¼Œå¯ä»¥åŸºäºKubernetesçš„API Serverè¿›è¡Œç®¡ç†ã€‚å…¶å®ä¾‹ä¸ºCRï¼ˆCustom Resourceï¼‰ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">apiVersion: apiextensions.k8s.io/v1</span><br><span class="line">kind: CustomResourceDefinition</span><br><span class="line">metadata:</span><br><span class="line">  name: test ## CRDåç§°</span><br><span class="line">spec:</span><br><span class="line">  conversion:</span><br><span class="line">    strategy: None</span><br><span class="line">  group: tq   # REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><br><span class="line">  names:</span><br><span class="line">    kind: App</span><br><span class="line">    listKind: AppList</span><br><span class="line">    plural: apps</span><br><span class="line">    singular: app</span><br><span class="line">  scope: Namespaced  # èµ„æºæ˜¯å¦åŒºåˆ†namespace</span><br><span class="line">  versions: [] # èµ„æºçš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šv1beta1ã€v1ç­‰</span><br></pre></td></tr></table></figure>

<h2 id="2-3-è‡ªå®šä¹‰æ§åˆ¶å™¨-Controller"><a href="#2-3-è‡ªå®šä¹‰æ§åˆ¶å™¨-Controller" class="headerlink" title="2.3 è‡ªå®šä¹‰æ§åˆ¶å™¨ Controller"></a>2.3 è‡ªå®šä¹‰æ§åˆ¶å™¨ Controller</h2><p>Kubernetesæ§åˆ¶å™¨ä¼šç›‘è§†èµ„æºçš„åˆ›å»º&#x2F;æ›´æ–°&#x2F;åˆ é™¤äº‹ä»¶ï¼Œå¹¶è§¦å‘ Reconcile å‡½æ•°ä½œä¸ºå“åº”ã€‚Reconcile æ˜¯ä¸€ä¸ªä½¿ç”¨ objectï¼ˆResource çš„å®ä¾‹ï¼‰çš„å‘½åç©ºé—´å’Œå®ä¾‹åæ¥è°ƒç”¨çš„å‡½æ•°ï¼Œä½¿objectçš„å®é™…çŠ¶æ€ä¸objectçš„Specä¸­å®šä¹‰çš„çŠ¶æ€ä¿æŒä¸€è‡´ã€‚ è°ƒç”¨å®Œæˆåï¼ŒReconcile ä¼šå°†objectçš„çŠ¶æ€æ›´æ–°ä¸ºå½“å‰å®é™…çŠ¶æ€ã€‚</p>
<p>åœ¨å®é™…ç¯å¢ƒä¸­ï¼ŒControllerä¼šè¢«æ‰“åŒ…æˆé•œåƒï¼Œä»¥Deploymentæ‹‰èµ·çš„Podçš„å½¢å¼åº”ç”¨åœ¨é›†ç¾¤ä¸­ï¼Œå¹¶ç”¨serviceä¸­çš„ClusterIPæ–¹å¼è¿›è¡ŒæœåŠ¡æš´éœ²å‘ç°ã€‚<br><img src="/img.png" alt="img.png"></p>
<h2 id="2-4-åè¯è§£é‡Š"><a href="#2-4-åè¯è§£é‡Š" class="headerlink" title="2.4 åè¯è§£é‡Š"></a>2.4 åè¯è§£é‡Š</h2><ul>
<li>CRDï¼ˆCustom Resource Definitionï¼‰: CRDå…è®¸ç”¨æˆ·åœ¨Kubernetes APIä¸­å®šä¹‰æ–°çš„èµ„æºç±»å‹ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥åˆ›å»ºç¬¦åˆè‡ªå·±åº”ç”¨æˆ–æœåŠ¡ç‰¹æ€§çš„èµ„æºï¼Œè¿™äº›èµ„æºèƒ½å¤Ÿè¢«Kubernetesä»¥ç±»ä¼¼äºå†…ç½®èµ„æºï¼ˆå¦‚Podsã€Servicesï¼‰çš„æ–¹å¼æ¥ç®¡ç†å’Œæ“ä½œã€‚CRDå®è´¨ä¸Šæ˜¯æ‰©å±•äº†Kubernetes APIçš„åŠŸèƒ½ï¼Œå…è®¸ä½ å®šä¹‰èµ„æºçš„åç§°ã€å­—æ®µç»“æ„ã€éªŒè¯è§„åˆ™ç­‰å…ƒæ•°æ®ã€‚é€šè¿‡YAMLæˆ–JSONæ–‡ä»¶å®šä¹‰CRDåï¼ŒKubernetesä¼šå°†å…¶æ³¨å†Œåˆ°APIæœåŠ¡å™¨ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥é€šè¿‡Kubernetes APIæ¥åˆ›å»ºã€è¯»å–ã€æ›´æ–°å’Œåˆ é™¤è¿™äº›è‡ªå®šä¹‰èµ„æºã€‚</li>
<li>CRï¼ˆCustom Resourceï¼‰: CRæ˜¯åŸºäºCRDå®šä¹‰çš„å…·ä½“å®ä¾‹ã€‚ä¸€æ—¦å®šä¹‰äº†CRDï¼Œç”¨æˆ·å°±å¯ä»¥åˆ›å»ºè¯¥ç±»å‹çš„èµ„æºå®ä¾‹ï¼Œè¿™äº›å®ä¾‹å°±æ˜¯CRã€‚æ¯ä¸ªCRä»£è¡¨äº†ç‰¹å®šçš„é…ç½®æˆ–çŠ¶æ€ï¼Œæ¯”å¦‚ä¸€ä¸ªç‰¹å®šæ•°æ®åº“å®ä¾‹çš„é…ç½®ã€ä¸€ä¸ªå¤æ‚åº”ç”¨çš„éƒ¨ç½²é…ç½®ç­‰ã€‚CRçš„å·¥ä½œåŸç†ç±»ä¼¼äºKubernetesä¸­çš„å…¶ä»–å¯¹è±¡ï¼ˆå¦‚Deploymentã€Serviceï¼‰ï¼Œä½†å®ƒä»¬æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°é€‚åº”ç‰¹å®šåº”ç”¨çš„éœ€æ±‚ã€‚å¼€å‘è€…æˆ–è¿ç»´äººå‘˜é€šè¿‡åˆ›å»ºCRæ¥å£°æ˜ä»–ä»¬å¸Œæœ›åœ¨é›†ç¾¤ä¸­éƒ¨ç½²æˆ–ç®¡ç†çš„èµ„æºçŠ¶æ€ï¼Œè€Œä¸ä¹‹å…³è”çš„Operatorä¼šæ ¹æ®è¿™äº›å£°æ˜æ¥åˆ›å»ºã€ç»´æŠ¤å’Œæ›´æ–°å®é™…çš„Kuberneteså¯¹è±¡ã€‚</li>
<li>GVKï¼ˆGroup, Version, Kindï¼‰: GVKä»£è¡¨äº†èµ„æºçš„ç»„ï¼ˆGroupï¼‰ã€ç‰ˆæœ¬ï¼ˆVersionï¼‰å’Œç§ç±»ï¼ˆKindï¼‰ã€‚å®ƒæ˜¯ä»èµ„æºçš„APIå±‚é¢æè¿°èµ„æºçš„ä¸€ç§æ–¹å¼ã€‚<ul>
<li>Groupï¼šæŒ‡èµ„æºæ‰€å±çš„APIç»„ï¼Œç”¨äºåŒºåˆ†ä¸åŒåŠŸèƒ½é¢†åŸŸçš„APIã€‚ä¾‹å¦‚ï¼Œapps&#x2F;v1ä¸­çš„appså°±æ˜¯ç»„åï¼Œå®ƒé€šå¸¸å¯¹åº”ç€Kubernetesçš„ä¸€ä¸ªç‰¹å®šåŠŸèƒ½é¢†åŸŸï¼Œå¦‚åº”ç”¨ç¨‹åºç®¡ç†ã€‚</li>
<li>Versionï¼šèµ„æºçš„APIç‰ˆæœ¬ï¼Œè¡¨æ˜èµ„æºå®šä¹‰éµå¾ªçš„ç‰¹å®šAPIç‰ˆæœ¬è§„èŒƒã€‚éšç€Kubernetesçš„å‘å±•ï¼Œèµ„æºçš„APIå¯èƒ½ä¼šæœ‰å˜åŒ–ï¼Œç‰ˆæœ¬å·å¸®åŠ©åŒºåˆ†è¿™äº›ä¸åŒçš„è§„èŒƒã€‚</li>
<li>Kindï¼šèµ„æºçš„ç±»å‹ï¼Œå¦‚Podã€Serviceã€Deploymentç­‰ï¼Œå®ƒå®šä¹‰äº†ä¸€ç±»èµ„æºçš„åŸºæœ¬ç»“æ„å’Œç”¨é€”ã€‚</li>
</ul>
</li>
<li>GVR (Group, Version, Resource): GVRä¸GVKç±»ä¼¼ï¼Œä½†ç”¨Resourceæ›¿æ¢äº†Kindï¼Œå®ƒä»èµ„æºçš„è®¿é—®è·¯å¾„è§’åº¦æè¿°èµ„æºã€‚<ul>
<li>Groupï¼šæŒ‡èµ„æºæ‰€å±çš„APIç»„ï¼Œç”¨äºåŒºåˆ†ä¸åŒåŠŸèƒ½é¢†åŸŸçš„APIã€‚ä¾‹å¦‚ï¼Œapps&#x2F;v1ä¸­çš„appså°±æ˜¯ç»„åï¼Œå®ƒé€šå¸¸å¯¹åº”ç€Kubernetesçš„ä¸€ä¸ªç‰¹å®šåŠŸèƒ½é¢†åŸŸï¼Œå¦‚åº”ç”¨ç¨‹åºç®¡ç†ã€‚</li>
<li>Versionï¼šèµ„æºçš„APIç‰ˆæœ¬ï¼Œè¡¨æ˜èµ„æºå®šä¹‰éµå¾ªçš„ç‰¹å®šAPIç‰ˆæœ¬è§„èŒƒã€‚éšç€Kubernetesçš„å‘å±•ï¼Œèµ„æºçš„APIå¯èƒ½ä¼šæœ‰å˜åŒ–ï¼Œç‰ˆæœ¬å·å¸®åŠ©åŒºåˆ†è¿™äº›ä¸åŒçš„è§„èŒƒã€‚</li>
<li>Resource: æŒ‡çš„æ˜¯èµ„æºåœ¨APIè·¯å¾„ä¸­çš„åç§°ï¼Œå®ƒç›´æ¥å…³è”åˆ°APIç«¯ç‚¹ï¼Œæ˜¯ç”¨äºä¸APIæœåŠ¡å™¨äº¤äº’æ—¶çš„URLè·¯å¾„ç»„æˆéƒ¨åˆ†ã€‚Resourceé€šå¸¸ä¸Kindç›¸ä¼¼æˆ–ç›¸åŒï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½æœ‰ç»†å¾®å·®åˆ«ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCRDsï¼‰æ—¶ã€‚</li>
</ul>
</li>
<li>Scheme: è´Ÿè´£ç®¡ç†å’Œæ³¨å†ŒAPIç±»å‹ï¼ˆå¦‚å„ç§èµ„æºå¯¹è±¡ï¼‰ä»¥åŠå®ƒä»¬ä¹‹é—´çš„è½¬æ¢å…³ç³»ã€‚ç®€å•æ¥è¯´ï¼ŒSchemeæ˜¯ç†è§£å’Œæ“ä½œKuberneteså¯¹è±¡çš„åŸºç¡€æ¡†æ¶ï¼Œå®ƒç¡®ä¿äº†å¯¹è±¡çš„åºåˆ—åŒ–ã€ååºåˆ—åŒ–ä»¥åŠç±»å‹è½¬æ¢èƒ½å¤Ÿæ­£ç¡®è¿›è¡Œ<ul>
<li>ç±»å‹æ³¨å†Œï¼šSchemeå…è®¸ä½ æ³¨å†Œè‡ªå®šä¹‰æˆ–å†…ç½®çš„APIç±»å‹ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥å‘Šè¯‰Schemeå¦‚ä½•è¯†åˆ«å’Œå¤„ç†ç‰¹å®šçš„Goç»“æ„ä½“ç±»å‹ï¼Œæ¯”å¦‚Podã€Serviceã€æˆ–è€…è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCRDsï¼‰ç­‰ã€‚</li>
<li>å¯¹è±¡è½¬æ¢ï¼šå®ƒæä¾›äº†ç±»å‹è½¬æ¢åŠŸèƒ½ï¼Œå…è®¸åœ¨ä¸åŒçš„APIç‰ˆæœ¬ä¹‹é—´è½¬æ¢å¯¹è±¡ã€‚è¿™å¯¹äºå¤„ç†APIçš„ç‰ˆæœ¬å…¼å®¹æ€§å’Œå‡çº§éå¸¸é‡è¦ã€‚</li>
<li>é»˜è®¤åŒ–ï¼šSchemeæ”¯æŒä¸ºå¯¹è±¡è®¾ç½®é»˜è®¤å€¼ã€‚å½“åˆ›å»ºæˆ–æ›´æ–°èµ„æºæ—¶ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å®šæŸäº›å­—æ®µï¼ŒSchemeå¯ä»¥æ ¹æ®é¢„è®¾è§„åˆ™è‡ªåŠ¨å¡«å……é»˜è®¤å€¼</li>
<li>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼šSchemeçŸ¥é“å¦‚ä½•å°†Goç»“æ„ä½“è½¬æ¢ä¸ºJSONæˆ–YAMLæ ¼å¼çš„æ•°æ®ï¼ˆåºåˆ—åŒ–ï¼‰ï¼Œä»¥åŠå¦‚ä½•å°†è¿™äº›æ•°æ®ååºåˆ—åŒ–å›Goç»“æ„ä½“ã€‚è¿™å¯¹äºä¸Kubernetes APIæœåŠ¡å™¨é€šä¿¡è‡³å…³é‡è¦ã€‚</li>
<li>å…ƒæ•°æ®å¤„ç†ï¼šå®ƒè¿˜è´Ÿè´£å¤„ç†å¯¹è±¡çš„å…ƒæ•°æ®ï¼Œå¦‚APIç‰ˆæœ¬ä¿¡æ¯å’ŒKindä¿¡æ¯ï¼Œç¡®ä¿è¿™äº›ä¿¡æ¯åœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿‡ç¨‹ä¸­å¾—åˆ°å¦¥å–„å¤„ç†ã€‚</li>
</ul>
</li>
<li>Managerï¼šManageræ•´åˆäº†ä¸€ç³»åˆ—åŠŸèƒ½ï¼Œä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿæ›´å®¹æ˜“åœ°åˆ›å»ºå’Œç®¡ç†è‡ªå®šä¹‰èµ„æºï¼ˆCRDsï¼‰åŠå…¶å¯¹åº”çš„æ§åˆ¶å™¨é€»è¾‘ã€‚ä»¥ä¸‹æ˜¯Managerçš„ä¸€äº›å…³é”®èŒè´£å’ŒåŠŸèƒ½<ul>
<li>è‡ªå®šä¹‰èµ„æºç®¡ç†ï¼šManagerè´Ÿè´£ç›‘å¬å’Œç®¡ç†è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCRDsï¼‰çš„å˜åŒ–ï¼Œå½“CRå®ä¾‹è¢«åˆ›å»ºã€æ›´æ–°æˆ–åˆ é™¤æ—¶ï¼Œå®ƒèƒ½ç¡®ä¿ç›¸åº”çš„æ§åˆ¶å™¨é€»è¾‘å¾—åˆ°æ‰§è¡Œã€‚</li>
<li>æ§åˆ¶å™¨æ³¨å†Œï¼šå®ƒæä¾›äº†ä¸€ä¸ªä¸­å¿ƒç‚¹æ¥æ³¨å†Œå’Œç®¡ç†ä¸åŒçš„æ§åˆ¶å™¨ï¼ˆControllersï¼‰ã€‚æ§åˆ¶å™¨æ˜¯æ‰§è¡Œå…·ä½“ä¸šåŠ¡é€»è¾‘çš„ç»„ä»¶ï¼Œè´Ÿè´£ç»´æŠ¤æœŸæœ›çŠ¶æ€ä¸å®é™…é›†ç¾¤çŠ¶æ€çš„ä¸€è‡´æ€§ã€‚</li>
<li>ä¾èµ–æ³¨å…¥ï¼šManageræ¡†æ¶é€šå¸¸æ”¯æŒä¾èµ–æ³¨å…¥ï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥è½»æ¾åœ°å¤ç”¨å’Œå…±äº«æœåŠ¡ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯é›†ï¼ˆClientSetsï¼‰ç”¨äºä¸Kubernetes APIäº¤äº’ã€æ—¥å¿—è®°å½•å™¨ã€äº‹ä»¶è®°å½•å™¨ç­‰ã€‚</li>
<li>é¢†å¯¼è€…é€‰ä¸¾ï¼šåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼ŒManagerå¯ä»¥å®ç°é¢†å¯¼è€…é€‰ä¸¾é€»è¾‘ï¼Œç¡®ä¿åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ªæ´»è·ƒçš„å®ä¾‹åœ¨æ‰§è¡Œæ“ä½œï¼Œé¿å…å†²çªå’Œé‡å¤å¤„ç†ã€‚</li>
<li>Webhookæ³¨å†Œï¼šå®ƒè¿˜å¯èƒ½æ”¯æŒæ³¨å†Œå’Œç®¡ç†è‡ªå®šä¹‰çš„Admission Webhooksï¼Œå…è®¸åœ¨èµ„æºåˆ›å»ºæˆ–ä¿®æ”¹æ—¶æ’å…¥è‡ªå®šä¹‰éªŒè¯æˆ–ä¿®æ”¹é€»è¾‘ã€‚</li>
<li>ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šManagerè´Ÿè´£å¯åŠ¨ã€åœæ­¢æ§åˆ¶å™¨ï¼Œä»¥åŠå¤„ç†å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œç¡®ä¿èµ„æºçš„æœ‰æ•ˆç®¡ç†å’Œæ¸…ç†ã€‚</li>
</ul>
</li>
<li>Controllerï¼šKubebuilderä¸ºæˆ‘ä»¬ç”Ÿæˆçš„è„šæ‰‹æ¶æ–‡ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°Reconcileæ–¹æ³•å³å¯ã€‚</li>
<li>Informersï¼šåœ¨Kubernetesä¸­ï¼ŒInformersæ˜¯å®¢æˆ·ç«¯åº“ï¼ˆclient-goï¼‰æä¾›çš„ä¸€ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œç”¨äºé«˜æ•ˆåœ°ç›‘å¬å’ŒåŒæ­¥Kubernetes APIèµ„æºçš„å˜åŒ–ã€‚å®ƒæ˜¯å®ç°æ§åˆ¶å™¨æ¨¡å¼çš„å…³é”®æŠ€æœ¯ä¹‹ä¸€ï¼Œå°¤å…¶æ˜¯å¯¹äºé‚£äº›éœ€è¦æ ¹æ®èµ„æºçŠ¶æ€å˜åŒ–åšå‡ºååº”çš„ç»„ä»¶ï¼Œå¦‚è‡ªå®šä¹‰æ§åˆ¶å™¨ã€Operatorç­‰<ul>
<li>èµ„æºç›‘å¬ï¼šInformersæŒç»­ç›‘å¬Kubernetes APIæœåŠ¡å™¨ä¸­æŒ‡å®šèµ„æºç±»å‹ï¼ˆå¦‚Podsã€Deploymentsç­‰ï¼‰çš„å¢åˆ æ”¹äº‹ä»¶ï¼Œé€šè¿‡watch APIæœºåˆ¶å®ç°è¿‘ä¹å®æ—¶çš„èµ„æºå˜åŒ–æ„ŸçŸ¥ã€‚</li>
<li>ç¼“å­˜åŒæ­¥ï¼šå®ƒåœ¨æœ¬åœ°ç»´æŠ¤ä¸€ä¸ªèµ„æºå¯¹è±¡çš„ç¼“å­˜å‰¯æœ¬ï¼Œè¿™ä¸ªç¼“å­˜ä¼šéšç€APIæœåŠ¡å™¨çš„äº‹ä»¶æ›´æ–°è€Œè‡ªåŠ¨ä¿æŒæœ€æ–°çŠ¶æ€ã€‚è¿™æ ·ï¼Œæ§åˆ¶å™¨æˆ–å…¶ä»–ç»„ä»¶å¯ä»¥ç›´æ¥æŸ¥è¯¢æœ¬åœ°ç¼“å­˜è·å–èµ„æºåˆ—è¡¨æˆ–è¯¦æƒ…ï¼Œè€Œä¸éœ€è¦é¢‘ç¹åœ°ç›´æ¥æŸ¥è¯¢APIæœåŠ¡å™¨ï¼Œå¤§å¤§æé«˜äº†æ•ˆç‡ã€‚</li>
<li>äº‹ä»¶å¤„ç†ï¼šInformersæä¾›å›è°ƒæœºåˆ¶ï¼Œå…è®¸ç”¨æˆ·æ³¨å†Œå¤„ç†å‡½æ•°ï¼ˆå¦‚EventHandleræˆ–Informerçš„äº‹ä»¶å¤„ç†å™¨ï¼‰ï¼Œå½“èµ„æºå‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨è§¦å‘è¿™äº›å‡½æ•°ï¼Œæ‰§è¡Œç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ã€‚</li>
<li>åˆ—è¡¨å’Œè¯¦ç»†ä¿¡æ¯çš„ç»Ÿä¸€ç®¡ç†ï¼šé€šè¿‡Listeræ¥å£ï¼ŒInformersä¸ä»…èƒ½å¤Ÿæä¾›èµ„æºåˆ—è¡¨ï¼Œè¿˜èƒ½é«˜æ•ˆåœ°è·å–å•ä¸ªèµ„æºçš„è¯¦ç»†ä¿¡æ¯ï¼Œè¿›ä¸€æ­¥ç®€åŒ–äº†èµ„æºçš„ç®¡ç†å’ŒæŸ¥è¯¢è¿‡ç¨‹ã€‚</li>
</ul>
</li>
<li>Indexï¼šç”±äºControllerç»å¸¸è¦å¯¹Cacheè¿›è¡ŒæŸ¥è¯¢ï¼ŒKubebuilderæä¾›Index utilityç»™CacheåŠ ç´¢å¼•æå‡æŸ¥è¯¢æ•ˆç‡ã€‚</li>
<li>Finalizerï¼šåœ¨Kubernetesä¸­ï¼ŒFinalizer æ˜¯ä¸€ç§é«˜çº§ç‰¹æ€§ï¼Œç”¨äºç¡®ä¿èµ„æºåœ¨å…¶è¢«åˆ é™¤ä¹‹å‰èƒ½å®Œæˆå¿…è¦çš„æ¸…ç†å·¥ä½œã€‚å®ƒä½œä¸ºä¸€ç§ä¿éšœæœºåˆ¶ï¼Œå¯ä»¥è®©æ§åˆ¶å™¨æˆ–æ“ä½œè€…æœ‰æœºä¼šåœ¨å¯¹è±¡è¢«æ°¸ä¹…åˆ é™¤å‰æ‰§è¡Œä¸€äº›æ¸…ç†ã€å¤‡ä»½æˆ–å…¶ä»–å¿…è¦çš„æ“ä½œï¼Œç¡®ä¿èµ„æºçš„ä¼˜é›…åˆ é™¤å’Œèµ„æºä½¿ç”¨çš„å®Œæ•´æ€§ã€‚<ul>
<li>é˜»æ­¢åˆ é™¤ï¼šåˆ é™¤æ“ä½œä¼šè¢«æš‚åœï¼Œç›´åˆ°æ‰€æœ‰åˆ—å‡ºçš„finalizeréƒ½è¢«å¤„ç†å®Œæ¯•ã€‚</li>
<li>é€šçŸ¥å¤„ç†è€…ï¼šKubernetesä¼šé€šçŸ¥æˆ–ç­‰å¾…è´Ÿè´£è¯¥finalizerçš„æ§åˆ¶å™¨ï¼ˆæˆ–å¤–éƒ¨ç³»ç»Ÿï¼‰å®Œæˆç›¸åº”çš„æ¸…ç†æ“ä½œã€‚</li>
<li>æ¸…é™¤Finalizerï¼šä¸€æ—¦å¤„ç†è€…å®Œæˆäº†å…¶ä»»åŠ¡ï¼Œå®ƒä¼šé€šè¿‡APIæ›´æ–°è¯¥å¯¹è±¡ï¼Œä»metadata.finalizerså­—æ®µä¸­ç§»é™¤ç›¸åº”çš„finalizeré¡¹ã€‚</li>
<li>ç»§ç»­åˆ é™¤æµç¨‹ï¼šå½“æ‰€æœ‰finalizeréƒ½è¢«ç§»é™¤åï¼ŒKubernetesæ‰ä¼šæœ€ç»ˆä»APIæœåŠ¡å™¨ä¸­åˆ é™¤è¯¥å¯¹è±¡ã€‚</li>
<li>é…ç½®Finalizerï¼šFinalizeré€šå¸¸æ˜¯é€šè¿‡è‡ªå®šä¹‰æ§åˆ¶å™¨ï¼ˆå¦‚Operatorï¼‰åŠ¨æ€æ·»åŠ å’Œç®¡ç†çš„ã€‚æ§åˆ¶å™¨å¯ä»¥åœ¨åˆ›å»ºæˆ–æ›´æ–°èµ„æºæ—¶å‘å¯¹è±¡çš„metadata.finalizerså­—æ®µæ·»åŠ è‡ªå®šä¹‰çš„finalizeråç§°ï¼ŒåŒæ ·ï¼Œåœ¨å®Œæˆæ¸…ç†å·¥ä½œåï¼Œéœ€è¦é€šè¿‡APIè°ƒç”¨æ¥ç§»é™¤è¿™ä¸ªfinalizerï¼Œä»¥å…è®¸èµ„æºè¢«å½»åº•åˆ é™¤ã€‚</li>
</ul>
</li>
<li>OwnerReferenceå·¥ä½œåŸç†ï¼šåœ¨Kubernetesä¸­ï¼ŒOwnerReference æ˜¯ä¸€ç§æœºåˆ¶ï¼Œç”¨äºå»ºç«‹èµ„æºå¯¹è±¡ä¹‹é—´çš„æ‰€æœ‰æƒå…³ç³»ã€‚è¿™ç§å…³ç³»å®šä¹‰äº†èµ„æºçš„ç”Ÿå‘½å‘¨æœŸä¾èµ–æ€§ï¼Œå³â€œæ‹¥æœ‰è€…â€èµ„æºï¼ˆownerï¼‰æ§åˆ¶ç€â€œè¢«æ‹¥æœ‰â€èµ„æºï¼ˆowned resourceï¼‰çš„ç”Ÿå‘½å‘¨æœŸã€‚å½“ä¸€ä¸ªèµ„æºä½œä¸ºå¦ä¸€ä¸ªèµ„æºçš„Owneræ—¶ï¼Œå®ƒä¼šå¯¹è¢«æ‹¥æœ‰èµ„æºçš„åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤äº§ç”Ÿå½±å“ï¼Œç¡®ä¿èµ„æºä¹‹é—´çš„ä¸€è‡´æ€§å’Œè‡ªåŠ¨åŒ–ç®¡ç†ã€‚<ul>
<li>è‡ªåŠ¨æ¸…ç†ï¼ˆGarbage Collectionï¼‰ï¼šå½“ä¸€ä¸ªèµ„æºå¯¹è±¡è¢«åˆ é™¤ï¼Œå¹¶ä¸”å®ƒæ‹¥æœ‰å…¶ä»–èµ„æºæ—¶ï¼ŒKubernetesçš„åƒåœ¾æ”¶é›†æœºåˆ¶ä¼šè‡ªåŠ¨åˆ é™¤è¿™äº›è¢«æ‹¥æœ‰çš„èµ„æºï¼Œç¡®ä¿èµ„æºä¾èµ–å…³ç³»è¢«æ­£ç¡®æ¸…ç†ï¼Œé¿å…å­¤å„¿èµ„æºçš„äº§ç”Ÿã€‚</li>
<li>ç”Ÿå‘½å‘¨æœŸè€¦åˆï¼šè¢«æ‹¥æœ‰èµ„æºçš„ç”Ÿå‘½å‘¨æœŸä¸æ‹¥æœ‰è€…èµ„æºç´§å¯†ç›¸è¿ã€‚å¦‚æœæ‹¥æœ‰è€…èµ„æºè¢«ä¿®æ”¹æˆ–åˆ é™¤ï¼ŒKubernetesä¼šç›¸åº”åœ°æ›´æ–°æˆ–æ¸…ç†è¢«æ‹¥æœ‰èµ„æºã€‚</li>
<li>é˜²æ­¢å¾ªç¯ä¾èµ–ï¼šKubernetesç¦æ­¢åˆ›å»ºä¼šå¯¼è‡´å¾ªç¯OwnerReferenceå…³ç³»çš„èµ„æºï¼Œä»¥é˜²æ­¢èµ„æºç®¡ç†æ··ä¹±å’Œæ½œåœ¨çš„æ­»é”æƒ…å†µã€‚</li>
</ul>
</li>
<li>OwnerReferenceç»“æ„å®šä¹‰ï¼šOwnerReferenceæ˜¯ä»¥APIå¯¹è±¡çš„ä¸€ä¸ªå­—æ®µå½¢å¼å­˜åœ¨çš„ï¼Œé€šå¸¸ä½äºè¢«æ‹¥æœ‰èµ„æºçš„metadata.ownerReferenceså­—æ®µä¸­ã€‚å®ƒåŒ…å«å‡ ä¸ªå…³é”®å±æ€§ï¼š<ul>
<li>APIVersionï¼šæ‹¥æœ‰è€…çš„APIç‰ˆæœ¬ã€‚</li>
<li>Kindï¼šæ‹¥æœ‰è€…çš„èµ„æºç±»å‹ã€‚</li>
<li>Nameï¼šæ‹¥æœ‰è€…çš„åç§°ã€‚</li>
<li>UIDï¼šæ‹¥æœ‰è€…çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUIDï¼‰ï¼Œè¿™æ˜¯åŒºåˆ†ä¸åŒèµ„æºå®ä¾‹çš„å…³é”®ã€‚</li>
<li>Controllerï¼ˆå¯é€‰ï¼‰ï¼šå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦ç”±ä¸€ä¸ªæ§åˆ¶å™¨ï¼ˆå¦‚Deploymentæˆ–StatefulSetï¼‰ç®¡ç†è¿™ä¸ªå…³ç³»ã€‚å¦‚æœæ˜¯æ§åˆ¶å™¨ï¼ŒKubernetesä¼šåœ¨é€‚å½“çš„æ—¶å€™è‡ªåŠ¨ç®¡ç†è¢«æ‹¥æœ‰èµ„æºã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-5-CRDå‘½åè§„èŒƒ"><a href="#2-5-CRDå‘½åè§„èŒƒ" class="headerlink" title="2.5 CRDå‘½åè§„èŒƒ"></a>2.5 CRDå‘½åè§„èŒƒ</h2><p>CRDçš„å…¨åå¿…é¡»æ˜¯ç¬¦åˆå¦‚ä¸‹çš„å‘½åè§„èŒƒï¼š${Kind}.${Group}.${Organization}.<a href="http://kubenode.alibaba-inc.com/">kubenode.alibaba-inc.com</a>.</p>
<ul>
<li>${Organization}ï¼šä¸€èˆ¬ä¸ºä»“åº“çš„git groupï¼Œå³å›¢é˜Ÿè‹±æ–‡ç®€ç§°</li>
<li>${Group}ï¼šå¿…é¡»æ˜¯ä¸€ç§åŠŸèƒ½ç±»åˆ«ï¼Œå¦‚opsã€appsã€authç­‰ï¼Œå°½é‡ç”¨ç²¾ç®€çš„å•ä¸ªè‹±æ–‡å•è¯çš„æ–¹å¼ä¼ è¾¾ä½ çš„CRDå±äºçš„â€ç±»åˆ«â€ã€‚ç»„æˆçš„å­—æ¯å¿…é¡»å°å†™</li>
<li>${Kind}ï¼šå³ä¸ºCRDçœŸæ­£çš„çŸ­åå­—ï¼Œç”¨ç²¾ç®€çš„å•ä¸ªæˆ–å¤šä¸ªè‹±æ–‡å•è¯çš„æ‹¼æ¥æ¥æ˜æ˜çœŸæ­£çš„CRDçŸ­åå­—ã€‚å¦‚AdvanceDeploymentï¼ŒNetBookç­‰ã€‚ä½¿ç”¨å¤§é©¼å³°å‘½åæ³•(é¦–å­—æ¯ä¹Ÿæ˜¯ç­”è°¢ï¼Œå³UpperCamelCase)ã€‚</li>
<li><a href="http://alipay.com/">alipay.com</a>ï¼šæ ¹æ®è‡ªå·±çš„å…¬å¸åç§°è¿›è¡Œç¡®å®šï¼Œå³Company Name Domain</li>
<li>ç›®å‰å¯¹äºCRDçš„ç‰ˆæœ¬è½¬æ¢ä¸å¤ªå‹å¥½ï¼Œä¸€èˆ¬ç»Ÿä¸€ä½¿ç”¨v1.</li>
</ul>
<h2 id="2-6-Specï¼ŒStatus-è§„èŒƒ"><a href="#2-6-Specï¼ŒStatus-è§„èŒƒ" class="headerlink" title="2.6 Specï¼ŒStatus è§„èŒƒ"></a>2.6 Specï¼ŒStatus è§„èŒƒ</h2><ul>
<li>ç”¨å‘½ä»¤åœ¨apisåŒ…ä¸‹ç”ŸæˆCRD Typesåï¼Œè¯·ä¸è¦éšæ„ä¿®æ”¹apisé‡Œçš„ç»“æ„ä½“ã€å‘½åè§„åˆ™ã€ä»¥åŠæ³¨é‡Šã€‚</li>
<li>åªèƒ½ï¼Œä¹Ÿåªä¿®æ”¹${Kind}_types.goæ–‡ä»¶é‡Œçš„Specå’ŒStatusSpecç»“æ„ä½“é‡Œçš„å†…å®¹ã€‚</li>
<li>Specå’ŒStatusSpecé‡Œçš„å­—æ®µéƒ½å¿…é¡»æ˜¯Publicçš„ï¼Œä¹Ÿå°±æ˜¯å­—æ®µåé¦–å­—æ¯æ˜¯å¤§å†™ã€‚</li>
<li>æ¯ä¸ªå­—æ®µï¼Œéƒ½åº”è¯¥å†™ä¸ŠJSON Tagï¼ŒJSON Tagå¿…é¡»ä½¿ç”¨å°é©¼å³°å‘½åæ³•ï¼Œå³LowerCamelCaseã€‚</li>
<li>å¦‚æœå­—æ®µå…è®¸ä¸ºç©ºï¼ŒJSON Tagè®°å¾—å¸¦ä¸Šomitemptyã€‚StatusSpecçš„å­—æ®µä¸€èˆ¬éƒ½æ˜¯å…è®¸ä¸ºç©ºçš„ã€‚ä¾‹å­ï¼š</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">type DemoSpecs struct &#123;</span><br><span class="line">        // FiledA å…è®¸ä¸ºç©º</span><br><span class="line">        FieldA string `json&quot;fieldA,omitempty&quot;`</span><br><span class="line">        </span><br><span class="line">        // FieldB ä¸å…è®¸ä¸ºç©º</span><br><span class="line">        FieldB string `json&quot;fieldB&quot;`</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-Operator-å·¥ä½œæµç¨‹"><a href="#3-Operator-å·¥ä½œæµç¨‹" class="headerlink" title="3 Operator å·¥ä½œæµç¨‹"></a>3 Operator å·¥ä½œæµç¨‹</h1><p><img src="/img_1.png" alt="img_1.png"></p>
<h2 id="3-1-æ ¸å¿ƒç»„ä»¶"><a href="#3-1-æ ¸å¿ƒç»„ä»¶" class="headerlink" title="3.1 æ ¸å¿ƒç»„ä»¶"></a>3.1 æ ¸å¿ƒç»„ä»¶</h2><ul>
<li>Informerï¼šä¸€ä¸ªä¾èµ– Kubernetes List&#x2F;Watch API ã€å¯ç›‘å¬äº‹ä»¶å¹¶è§¦å‘å›è°ƒå‡½æ•°çš„äºŒçº§ç¼“å­˜å·¥å…·åŒ…ã€‚<ul>
<li>åœ¨å¯åŠ¨æ—¶Reflectorè°ƒç”¨List APIè·å¾—crdçš„å…¨éƒ¨Objectå®ä¾‹ï¼Œå¹¶ç¼“å­˜åœ¨Local Storeä¸­ã€‚</li>
<li>ç„¶åReflectorè°ƒç”¨Watch APIæ¥è·å–å’Œç›‘å¬å¯¹è±¡å®ä¾‹çš„å˜åŒ–ï¼Œç»´æŠ¤ç¼“å­˜çš„å˜åŒ–ã€‚</li>
<li>æ¯å½“æ”¶åˆ°add&#x2F;deleteç­‰å®ä¾‹è¯·æ±‚æ—¶ï¼ŒReflectorä¼šå°†å˜æ›´çš„äº‹ä»¶+å¯¹è±¡æ¨é€åˆ°deltaFIFOçš„é˜Ÿåˆ—ä¸­ã€‚</li>
<li>æ ¹æ®delttaFIFOä¸­çš„å†…å®¹ï¼Œå…ˆåˆ°Local Storeä¸­æ›´æ–°å¯¹è±¡çš„ä¿¡æ¯ä¸çŠ¶æ€ï¼Œä¹‹åç»è¿‡eventHandlerè¿›å…¥WorkQueueï¼Œè¿›è€Œè§¦å‘controllerçš„reconciletè°ƒè°é€»è¾‘ã€‚</li>
</ul>
</li>
<li>WorkQueueï¼šéœ€è¦å¤„ç†çš„äº‹ä»¶é˜Ÿåˆ—ï¼Œä¾›controlleræ¥è¿›è¡ŒçœŸæ­£çš„ä¸šåŠ¡å¤„ç†ã€‚</li>
<li>Control Loopï¼šå®é™…çš„æ§åˆ¶å™¨è§’è‰²ï¼Œé€šè¿‡å®ç°è°ƒè°é€»è¾‘ï¼Œç¡®ä¿æœŸæœ›å’Œå®é™…è¿è¡ŒçŠ¶æ€æ˜¯ä¸€è‡´çš„ã€‚é€šè¿‡Listerå‘Local Storeä¸­è¯»Objectå®ä¾‹ï¼Œé€šè¿‡Clientå‘API Serverå†™å…·ä½“çš„æ“ä½œé€»è¾‘ã€‚</li>
</ul>
<h2 id="3-2-å®ç°ç»†èŠ‚"><a href="#3-2-å®ç°ç»†èŠ‚" class="headerlink" title="3.2 å®ç°ç»†èŠ‚"></a>3.2 å®ç°ç»†èŠ‚</h2><ul>
<li>æ¶ˆæ¯å¯é æ€§ï¼šListçŸ­é“¾æ¥æŸ¥è¯¢å½“å‰å…¨é‡çš„èµ„æºåŠçŠ¶æ€ï¼›Watché•¿é“¾æ¥æ¥å—å¢é‡çš„èµ„æºå˜æ›´äº‹ä»¶å¹¶åšç›¸åº”å¤„ç†ã€‚ä¸¤è€…äº’ç›¸å¸®åŠ©ï¼Œè¾¾åˆ°æ¶ˆæ¯çš„å¯é æ€§å’Œæ•°æ®çš„ä¸€è‡´æ€§ã€‚</li>
<li>å…±äº«Informerï¼šå¯¹åŒä¸€ç±»å‹çš„èµ„æºåªå»ºç«‹ä¸€ä¸ªé“¾æ¥ï¼Œä¸ºå¤šä¸ªcontrolleræä¾›å…±äº«cacheçš„èƒ½åŠ›ã€‚</li>
<li>è‹¥è¯·æ±‚ä¸ºæ·»åŠ æ“ä½œï¼ŒIndexeræŠŠAPIå¯¹è±¡ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ä¸­ï¼Œå¹¶ä¸ºå®ƒåˆ›å»ºç´¢å¼•ï¼›è‹¥ä¸ºåˆ é™¤æ“ä½œï¼Œåˆ™åœ¨æœ¬åœ°ç¼“å­˜ä¸­åˆ é™¤è¯¥å¯¹è±¡ã€‚</li>
<li>LocalStore ä¼šå‘¨æœŸæ€§åœ°æŠŠæ‰€æœ‰èµ„æºçš„ä¿¡æ¯é‡æ–°æ”¾åˆ° DeltaFIFO ä¸­ï¼Œç¡®ä¿äºŒçº§ç¼“å­˜é—´çš„åŒæ­¥ï¼Œè®©å¤±è´¥çš„äº‹ä»¶å¾—åˆ°é‡æ–°å¤„ç†ã€‚è‹¥åœ¨å…¥é˜Ÿå‰å‘ç°DeltaFIFOä¸­å·²ç»æœ‰æ–°ç‰ˆæœ¬çš„Objectå®ä¾‹ï¼Œåˆ™ä¸å…¥é˜Ÿã€‚</li>
<li>Reconcilersæ˜¯æ ¸å¿ƒå¤„ç†é€»è¾‘ï¼Œä½†å…¶åªè·å–èµ„æºçš„åç§°å’Œå‘½åç©ºé—´ï¼Œå¹¶ä¸çŸ¥é“èµ„æºçš„æ“ä½œ(å¢åˆ æ”¹)æ˜¯ä»€ä¹ˆï¼Œä¹Ÿä¸çŸ¥é“èµ„æºçš„å…¶ä»–ä¿¡æ¯ã€‚ç›®çš„å°±æ˜¯åœ¨æ”¶åˆ°èµ„æºå˜æ›´æ—¶ï¼Œæ ¹æ®objectçš„æœŸæœ›çŠ¶æ€ç›´æ¥è°ƒæ•´èµ„æºçš„çŠ¶æ€ã€‚</li>
</ul>
<h2 id="3-3-ä»¥Podä¸ºå¯¹è±¡çš„æµç¨‹ç¤ºä¾‹"><a href="#3-3-ä»¥Podä¸ºå¯¹è±¡çš„æµç¨‹ç¤ºä¾‹" class="headerlink" title="3.3 ä»¥Podä¸ºå¯¹è±¡çš„æµç¨‹ç¤ºä¾‹"></a>3.3 ä»¥Podä¸ºå¯¹è±¡çš„æµç¨‹ç¤ºä¾‹</h2><p><img src="/img_2.png" alt="img_2.png"></p>
<ul>
<li>Informer åœ¨åˆå§‹åŒ–æ—¶ï¼ŒReflector ä¼šå…ˆé€šè¿‡ List API å‘ API Server è·å¾—æ‰€æœ‰çš„ Pod å®ä¾‹ã€‚</li>
<li>Reflector æ‹¿åˆ°å…¨éƒ¨ Pod å®ä¾‹åï¼Œä¼šå°†å…¨éƒ¨ Pod å®ä¾‹æ”¾åˆ° Local Store ä¸­</li>
<li>å¦‚æœåé¢ Controller è°ƒç”¨ Lister çš„ List&#x2F;Get æ–¹æ³•è·å– Pod å®ä¾‹æ—¶ï¼Œ é‚£ä¹ˆ Lister ä¼šç›´æ¥ä» Local Store ä¸­æ‹¿æ•°æ®ã€‚</li>
<li>Informer åˆå§‹åŒ–å®Œæˆä¹‹åï¼ŒReflectorå¼€å§‹é€šè¿‡Watch APIç›‘å¬Podç›¸å…³çš„æ‰€æœ‰äº‹ä»¶ï¼›å¦‚æœæ­¤æ—¶ pod_1 è¢«åˆ é™¤ï¼Œé‚£ä¹ˆ Reflector ä¼šç›‘å¬åˆ°è¿™ä¸ªäº‹ä»¶ã€‚</li>
<li>Reflector å°† pod_1 è¢«åˆ é™¤çš„è¿™ä¸ªäº‹ä»¶å‘é€åˆ° DeltaFIFO</li>
<li>DeltaFIFO é¦–å…ˆä¼šå°†è¿™ä¸ªäº‹ä»¶ï¼ˆä¸€èˆ¬ä¸ºkey : valueçš„å½¢å¼ï¼‰å­˜å‚¨åœ¨è‡ªå·±çš„WorkQueueï¼Œç„¶åä¼šç›´æ¥æ“ä½œ Local Store ä¸­çš„æ•°æ®ï¼Œåˆ é™¤ Local Store ä¸­çš„ pod_1ã€‚</li>
<li>WorkQueue ä¼š Pop è¿™ä¸ªäº‹ä»¶åˆ° Controller ä¸­ã€‚</li>
<li>Controller æ”¶åˆ°è¿™ä¸ªäº‹ä»¶ï¼Œé€šè¿‡ Lister ä»æœ¬åœ° Local Store ä¸­è·å–çœŸæ­£çš„å¯¹è±¡å®ä¾‹ï¼Œæ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ã€‚<ul>
<li>è‹¥æœ‰å…³è”èµ„æºï¼ˆownerReferenceä¸ºè¯¥å¯¹è±¡çš„èµ„æºï¼‰ï¼Œåˆ™åˆ é™¤å…³è”èµ„æºã€‚</li>
<li>è‹¥æ— å…³è”èµ„æºï¼Œåˆ™ç­‰å¾…è¯»å–ä¸‹ä¸€ä¸ªäº‹ä»¶ã€‚</li>
</ul>
</li>
</ul>
<h1 id="4-åŸç”Ÿå®ç°"><a href="#4-åŸç”Ÿå®ç°" class="headerlink" title="4 åŸç”Ÿå®ç°"></a>4 åŸç”Ÿå®ç°</h1><ul>
<li>CRDå®ç°ï¼š é¦–å…ˆåˆ©ç”¨CRDçš„å®šä¹‰æ–‡ä»¶types.goï¼Œé€šè¿‡å®˜æ–¹çš„code-generatorç”ŸæˆCRDçš„ç›¸å…³ä»£ç ï¼ŒåŒ…æ‹¬æ ‡å‡†clientï¼Œdeepcopyï¼Œinformerå’Œlisterã€‚</li>
<li>controllerå®ç°ï¼š ç„¶ååŸºäºå®˜æ–¹çš„sample-controllerçš„å®è·µç¤ºä¾‹ï¼Œè¿›è¡Œè‡ªå®šä¹‰çš„ç¼–æ’é€»è¾‘ç¼–å†™ï¼ŒåŒ…æ‹¬å¯¹äºä¸åŒadd &#x2F; update &#x2F;delete ç­‰æ“ä½œçš„å“åº”ç­‰ç»†èŠ‚æ“ä½œã€‚</li>
<li>YAMLæ–‡ä»¶ç¼–å†™ï¼š æ‰‹åŠ¨ç¼–å†™CRDå®šä¹‰å’ŒDeploymentå®šä¹‰YAMLæ–‡ä»¶ï¼Œé€šè¿‡kubectl applyå®Œæˆk8sèµ„æºçš„æ‰©å±•å’Œæ§åˆ¶å™¨çš„éƒ¨ç½²ã€‚</li>
<li>å…¶ä»–å¼€å‘å·¥ä½œï¼š æ¯”å¦‚å¯¹Controllerè¿›è¡ŒäºŒè¿›åˆ¶ç¼–è¯‘ã€é•œåƒæ‰“åŒ…ä¸Šä¼ ã€ä»¥Deploymentä¸­çš„Podçš„å½¢å¼éƒ¨ç½²åˆ°K8sä¸­ç­‰ã€‚</li>
</ul>
<p>ç­‰åé¢æ¥çœ‹ä¸‹ï¼Œè¿™äº›å·¥ä½œä¸­ï¼Œè„šæ‰‹æ¶èƒ½å¸®å¿™å®ç°å¤šå°‘ã€‚<br><img src="/img_3.png" alt="img_3.png"></p>
]]></content>
  </entry>
  <entry>
    <title>tencentcloud_ckafka_instance</title>
    <url>/2025/07/devops/terraform/tencentcloud_ckafka_instance/</url>
    <content><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>çº¦å®šæ ¼å¼ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ aliyun                                             # äº‘å‚å•†å®ä¾‹æ–‡ä»¶</span><br><span class="line">â”‚   â””â”€â”€ aliyun_ecs_mod_demo                           # æ¨¡å‹å</span><br><span class="line">â”‚       â””â”€â”€ aliyun_china_platform_7111                # äº‘è´¦å·å</span><br><span class="line">â”‚           â””â”€â”€ ecs_instance_name_20241224121212      # å®ä¾‹å</span><br><span class="line">â”‚               â”œâ”€â”€ backend.tf                        # å®ä¾‹stateæ–‡ä»¶ä¿å­˜è¯´æ˜ï¼šoss</span><br><span class="line">â”‚               â””â”€â”€ main.tf                           # å®ä¾‹å…·ä½“çš„å‚æ•°</span><br><span class="line">â”œâ”€â”€ modules                                            # æ¨¡å‹æ•°æ®æ–‡ä»¶å¤¹</span><br><span class="line">â”‚   â”œâ”€â”€ aliyun                                        # äº‘å‚å•†æ¨¡å‹æ–‡ä»¶å¤¹</span><br><span class="line">â”‚   â”‚   â””â”€â”€ aliyun_ecs_mod_demo                       # æ¨¡å‹å</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ main.tf                               # æ¨¡å‹å®šä¹‰ä¸»æ–‡ä»¶</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ outputs.tf                            # æ¨¡å‹å®šä¹‰è¾“å‡ºæ–‡ä»¶</span><br><span class="line">â”‚   â”‚       â””â”€â”€ variables.tf                          # æ¨¡å‹å®šä¹‰å‚æ•°æ–‡ä»¶</span><br><span class="line">â”‚   â””â”€â”€ tenmod                                         # å¦ä¸€ä¸ªäº‘å‚å•†æ¨¡å‹</span><br><span class="line">â””â”€â”€ tenent                                              # å¦ä¸€ä¸ªäº‘å‚å•†å®ä¾‹æ–‡ä»¶</span><br></pre></td></tr></table></figure>

<h1 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ modules</span><br><span class="line">â”‚   â””â”€â”€ tcloud</span><br><span class="line">â”‚       â””â”€â”€ tcloud_ckafka_mod_demo</span><br><span class="line">â”‚           â”œâ”€â”€ main.tf</span><br><span class="line">â”‚           â”œâ”€â”€ outputs.tf</span><br><span class="line">â”‚           â””â”€â”€ variables.tf</span><br><span class="line">â””â”€â”€ tcloud</span><br><span class="line">    â””â”€â”€ tcloud_ckafka_demo</span><br><span class="line">        â””â”€â”€ tcloud_china_game_x6</span><br><span class="line">            â””â”€â”€ ckafaka_demo_202501221738</span><br><span class="line">                â”œâ”€â”€ backend.tf</span><br><span class="line">                â””â”€â”€ main.tf</span><br></pre></td></tr></table></figure>

<h2 id="modules"><a href="#modules" class="headerlink" title="modules"></a>modules</h2><h3 id="modules-tcloud-tcloud-ckafka-mod-demo-main-tf"><a href="#modules-tcloud-tcloud-ckafka-mod-demo-main-tf" class="headerlink" title="&#x2F;modules&#x2F;tcloud&#x2F;tcloud_ckafka_mod_demo&#x2F;main.tf"></a>&#x2F;modules&#x2F;tcloud&#x2F;tcloud_ckafka_mod_demo&#x2F;main.tf</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    tencentcloud = &#123;</span><br><span class="line">      source = &quot;tencentcloudstack/tencentcloud&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;tencentcloud&quot; &#123;</span><br><span class="line">  region = var.region</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;tencentcloud_availability_zones_by_product&quot; &quot;zone&quot; &#123;</span><br><span class="line">  name    = var.availability_zone</span><br><span class="line">  product = &quot;ckafka&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;tencentcloud_ckafka_instance&quot; &quot;this&quot; &#123;</span><br><span class="line">  instance_name      = var.instance_name</span><br><span class="line">  zone_id            = data.tencentcloud_availability_zones_by_product.zone.zones[0].id</span><br><span class="line">  vpc_id             = var.vpc_id</span><br><span class="line">  subnet_id          = var.vswitch_id</span><br><span class="line">  msg_retention_time = var.msg_retention_time</span><br><span class="line">  kafka_version      = var.kafka_version</span><br><span class="line">  disk_size          = var.disk_size</span><br><span class="line">  band_width         = var.band_width</span><br><span class="line">  disk_type          = var.disk_type</span><br><span class="line">  partition          = var.partition</span><br><span class="line">  charge_type        = var.charge_type</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  config &#123;</span><br><span class="line">    auto_create_topic_enable   = var.auto_create_topic_enable</span><br><span class="line">    default_num_partitions     = var.num_partitions</span><br><span class="line">    default_replication_factor = var.replication_factor</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  dynamic_retention_config &#123;</span><br><span class="line">    enable = var.dynamic_retention_config_enable</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="modules-tcloud-tcloud-ckafka-mod-demo-outputs-tf"><a href="#modules-tcloud-tcloud-ckafka-mod-demo-outputs-tf" class="headerlink" title="&#x2F;modules&#x2F;tcloud&#x2F;tcloud_ckafka_mod_demo&#x2F;outputs.tf"></a>&#x2F;modules&#x2F;tcloud&#x2F;tcloud_ckafka_mod_demo&#x2F;outputs.tf</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">output &quot;ckafka_instance_id&quot; &#123;</span><br><span class="line">  value = tencentcloud_ckafka_instance.this.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="modules-tcloud-tcloud-ckafka-mod-demo-variables-tf"><a href="#modules-tcloud-tcloud-ckafka-mod-demo-variables-tf" class="headerlink" title="&#x2F;modules&#x2F;tcloud&#x2F;tcloud_ckafka_mod_demo&#x2F;variables.tf"></a>&#x2F;modules&#x2F;tcloud&#x2F;tcloud_ckafka_mod_demo&#x2F;variables.tf</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">variable &quot;region&quot; &#123;</span><br><span class="line">  description = &quot;åœ°åŸŸ&quot;</span><br><span class="line">  type        = string</span><br><span class="line">  default     = &quot;ap-shanghai&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;instance_name&quot; &#123;</span><br><span class="line">  description = &quot;kafkaå®ä¾‹å&quot;</span><br><span class="line">  type        = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;availability_zone&quot; &#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">å¦‚ap-shanghai-2</span></span><br><span class="line">  description = &quot;å¯ç”¨åŒº&quot;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;charge_type&quot; &#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">PREPAID(é¢„ä»˜è´¹), POSTPAID_BY_HOUR(æŒ‰é‡ä»˜è´¹)</span></span><br><span class="line">  description = &quot;kafkaå®ä¾‹è®¡è´¹æ–¹å¼&quot;</span><br><span class="line">  type = string</span><br><span class="line">  validation &#123;</span><br><span class="line">    condition     = contains([&quot;PREPAID&quot;, &quot;POSTPAID_BY_HOUR&quot;], var.charge_type)</span><br><span class="line">    error_message = &quot;The charge_type must be one of PREPAID, POSTPAID_BY_HOUR&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;kafka_version&quot; &#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">0.10.2/1.1.1/2.4.1/2.8.1</span></span><br><span class="line">  description = &quot;kafkaå®ä¾‹ç‰ˆæœ¬&quot;</span><br><span class="line">  type = string</span><br><span class="line">  validation &#123;</span><br><span class="line">    condition     = contains([&quot;0.10.2&quot;, &quot;1.1.1&quot;, &quot;2.4.1&quot;, &quot;2.4.2&quot;, &quot;2.8.1&quot;], var.kafka_version)</span><br><span class="line">    error_message = &quot;The kafka_version must be one of 0.10.2, 1.1.1, 2.4.1, 2.4.2, 2.8.1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">variable &quot;vswitch_id&quot; &#123;</span><br><span class="line">  // é˜¿é‡Œäº‘vswitch_id -&gt; è…¾è®¯äº‘subnet_id</span><br><span class="line">  description = &quot;ç»‘å®šå­ç½‘id&quot;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;vpc_id&quot; &#123;</span><br><span class="line">  description = &quot;ç»‘å®švpc_id&quot;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;disk_size&quot; &#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">éœ€æ»¡è¶³å½“å‰å®ä¾‹çš„è®¡è´¹è§„æ ¼ï¼Œæ­¤å¤„é¢„è®¾200å’Œ400ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹</span></span><br><span class="line">  description = &quot;kafkaå®ä¾‹ç£ç›˜è§„æ ¼&quot;</span><br><span class="line">  type = number</span><br><span class="line">  validation &#123;</span><br><span class="line">    condition     = contains([200, 400], var.disk_size)</span><br><span class="line">    error_message = &quot;The disk_size must be one of 200, 400&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;disk_type&quot; &#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">ä¸“ä¸šç‰ˆå®ä¾‹ç£ç›˜ç±»å‹ï¼Œæ ‡å‡†ç‰ˆå®ä¾‹ä¸éœ€è¦å¡«å†™ï¼ŒCLOUD_SSD(SSDäº‘ç¡¬ç›˜), CLOUD_BASIC(é«˜æ€§èƒ½äº‘ç¡¬ç›˜)</span></span><br><span class="line">  description = &quot;kafkaä¸“ä¸šç‰ˆå®ä¾‹ç£ç›˜ç±»å‹&quot;</span><br><span class="line">  type = string</span><br><span class="line">  default = &quot;&quot;</span><br><span class="line">  validation &#123;</span><br><span class="line">    condition     = contains([&quot;&quot;, &quot;CLOUD_SSD&quot;, &quot;CLOUD_BASIC&quot;], var.disk_type)</span><br><span class="line">    error_message = &quot;The disk_type must be empty, or one of CLOUD_SSD, CLOUD_BASIC&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;band_width&quot; &#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">å•ä½ä¸ºMBps.</span></span><br><span class="line">  description = &quot;kafkaå®ä¾‹å¸¦å®½&quot;</span><br><span class="line">  type = number</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;auto_create_topic_enable&quot; &#123;</span><br><span class="line">  description = &quot;æ˜¯å¦è‡ªåŠ¨åˆ›å»ºtopic&quot;</span><br><span class="line">  type = bool</span><br><span class="line">  default = true</span><br><span class="line">  validation &#123;</span><br><span class="line">    condition     = contains([true, false], var.auto_create_topic_enable)</span><br><span class="line">    error_message = &quot;The auto_create_topic_enable must be one of true, false&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;num_partitions&quot; &#123;</span><br><span class="line">  description = &quot;kafkaå®ä¾‹é»˜è®¤åˆ†åŒºæ•°&quot;</span><br><span class="line">  type = number</span><br><span class="line">  default = 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;replication_factor&quot; &#123;</span><br><span class="line">  description = &quot;kafkaå®ä¾‹é»˜è®¤å‰¯æœ¬æ•°&quot;</span><br><span class="line">  type = number</span><br><span class="line">  default = 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;dynamic_retention_config_enable&quot; &#123;</span><br><span class="line">  description = &quot;æ˜¯å¦å¯ç”¨åŠ¨æ€æ¶ˆæ¯ä¿ç•™æ—¶é—´é…ç½®&quot;</span><br><span class="line">  type = number</span><br><span class="line">  default = 0</span><br><span class="line">  validation &#123;</span><br><span class="line">    condition     = contains([0, 1], var.dynamic_retention_config_enable)</span><br><span class="line">    error_message = &quot;The dynamic_retention_config_enable must be one of 0, 1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;msg_retention_time&quot; &#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">ä»¥åˆ†é’Ÿä¸ºå•ä½</span></span><br><span class="line">  description = &quot;kafkaå®ä¾‹æ—¥å¿—çš„æœ€å¤§ä¿ç•™æ—¶é—´&quot;</span><br><span class="line">  type = number</span><br><span class="line">  default = 10080</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;partition&quot; &#123;</span><br><span class="line">  description = &quot;kafkaå®ä¾‹åˆ†åŒºå¤§å°&quot;</span><br><span class="line">  type = number</span><br><span class="line">  default = 3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><h3 id="tcloud-tcloud-ckafka-demo-tcloud-china-game-x6-ckafaka-demo-202501221738-backend-tf"><a href="#tcloud-tcloud-ckafka-demo-tcloud-china-game-x6-ckafaka-demo-202501221738-backend-tf" class="headerlink" title="&#x2F;tcloud&#x2F;tcloud_ckafka_demo&#x2F;tcloud_china_game_x6&#x2F;ckafaka_demo_202501221738&#x2F;backend.tf"></a>&#x2F;tcloud&#x2F;tcloud_ckafka_demo&#x2F;tcloud_china_game_x6&#x2F;ckafaka_demo_202501221738&#x2F;backend.tf</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  backend &quot;oss&quot; &#123;</span><br><span class="line">    endpoint = &quot;oss-cn-hangzhou.aliyuncs.com&quot;</span><br><span class="line">    bucket   = &quot;dz-devops&quot; # æ›¿æ¢ä¸ºä½ çš„ OSS Bucket åç§°</span><br><span class="line">    prefix = &quot;terraform_state/tcloud/tcloud_ckafka_demo/tcloud_china_game_x6/ckafka_demo_202501221738&quot;</span><br><span class="line">    key      = &quot;terraform.tfstate&quot; # å­˜å‚¨çŠ¶æ€æ–‡ä»¶çš„è·¯å¾„å’Œåç§°</span><br><span class="line">    region   = &quot;cn-hangzhou&quot;       # OSS çš„åœ°åŸŸï¼ˆæ ¹æ®ä½ çš„å®é™…æƒ…å†µè°ƒæ•´ï¼‰</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="tcloud-tcloud-ckafka-demo-tcloud-china-game-x6-ckafaka-demo-202501221738-main-tf"><a href="#tcloud-tcloud-ckafka-demo-tcloud-china-game-x6-ckafaka-demo-202501221738-main-tf" class="headerlink" title="&#x2F;tcloud&#x2F;tcloud_ckafka_demo&#x2F;tcloud_china_game_x6&#x2F;ckafaka_demo_202501221738&#x2F;main.tf"></a>&#x2F;tcloud&#x2F;tcloud_ckafka_demo&#x2F;tcloud_china_game_x6&#x2F;ckafaka_demo_202501221738&#x2F;main.tf</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">module &quot;ckafka_instance&quot; &#123;</span><br><span class="line">  source              = &quot;../../../../modules/tcloud/tcloud_ckafka_mod_demo&quot;</span><br><span class="line">  region              = &quot;ap-shanghai&quot;</span><br><span class="line">  instance_name       = &quot;ckafka-test&quot;</span><br><span class="line">  availability_zone   = &quot;ap-shanghai-2&quot;</span><br><span class="line">  charge_type         = &quot;POSTPAID_BY_HOUR&quot;</span><br><span class="line">  kafka_version       = &quot;2.4.2&quot;</span><br><span class="line">  vpc_id              = &quot;vpc-4tkroxts&quot;</span><br><span class="line">  vswitch_id          = &quot;subnet-oy1pqvzv&quot;</span><br><span class="line">  disk_size           = 200</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">disk_type           = <span class="string">&quot;CLOUD_BASIC&quot;</span></span></span><br><span class="line">  band_width          = 20</span><br><span class="line">  auto_create_topic_enable = true</span><br><span class="line">  num_partitions     = 3</span><br><span class="line">  replication_factor = 3</span><br><span class="line">  dynamic_retention_config_enable = 1</span><br><span class="line">  msg_retention_time = 1300</span><br><span class="line">  partition = 400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è¿è¡Œæµ‹è¯•"><a href="#è¿è¡Œæµ‹è¯•" class="headerlink" title="è¿è¡Œæµ‹è¯•"></a>è¿è¡Œæµ‹è¯•</h2><h3 id="è·å–-AK-SK"><a href="#è·å–-AK-SK" class="headerlink" title="è·å– AK&#x2F;SK"></a>è·å– AK&#x2F;SK</h3><p>åœ¨é¦–æ¬¡ä½¿ç”¨ Terraform ä¹‹å‰ï¼Œéœ€è¦å‰å¾€è…¾è®¯äº‘çš„<a href="https://console.cloud.tencent.com/cam/capi">äº‘ API å¯†é’¥é¡µé¢</a>ç”³è¯·å®‰å…¨å‡­è¯SecretIdå’ŒSecretKey2ã€‚è‹¥å·²æœ‰å¯ä½¿ç”¨çš„å®‰å…¨å‡­è¯ï¼Œåˆ™è·³è¿‡è¯¥æ­¥éª¤2ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹2ï¼š</p>
<ol>
<li>ç™»å½•è…¾è®¯äº‘<a href="https://console.cloud.tencent.com/cam">è®¿é—®ç®¡ç†æ§åˆ¶å°</a>ï¼Œåœ¨å·¦ä¾§å¯¼èˆªæ ï¼Œé€‰æ‹©è®¿é—®å¯†é’¥&gt;API å¯†é’¥ç®¡ç†ã€‚</li>
<li>åœ¨API å¯†é’¥ç®¡ç†é¡µé¢ï¼Œå•å‡»æ–°å»ºå¯†é’¥ï¼Œå³å¯ä»¥åˆ›å»ºä¸€å¯¹SecretId&#x2F;SecretKeyã€‚</li>
</ol>
<h3 id="è®¾ç½®ç¯å¢ƒå˜é‡"><a href="#è®¾ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="è®¾ç½®ç¯å¢ƒå˜é‡"></a>è®¾ç½®ç¯å¢ƒå˜é‡</h3><p>å°†è·å–åˆ°çš„SecretIdå’ŒSecretKeyè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export TENCENTCLOUD_SECRET_ID=your_secret_id</span><br><span class="line">export TENCENTCLOUD_SECRET_KEY=your_secret_key</span><br></pre></td></tr></table></figure>

<h3 id="è¿è¡Œé¡¹ç›®"><a href="#è¿è¡Œé¡¹ç›®" class="headerlink" title="è¿è¡Œé¡¹ç›®"></a>è¿è¡Œé¡¹ç›®</h3><p>è¿›å…¥é¡¹ç›®æ ¹ç›®å½•ï¼Œè¿™é‡Œæ˜¯ckafaka_demo_202501221738ç›®å½•ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ./tcloud/tcloud_ckafka_demo/tcloud_china_game_x6/ckafaka_demo_202501221738/</span><br></pre></td></tr></table></figure>

<p>åˆå§‹åŒ– Terraform é¡¹ç›®:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†xxxæ›¿æ¢ä¸ºå®é™…backendçš„akï¼Œå°†yyyæ›¿æ¢ä¸ºå®é™…backendçš„sk</span></span><br><span class="line">terraform init -backend-config=&quot;access_key=xxx&quot; -backend-config=&quot;secret_key=yyy&quot;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‘½ä»¤ä¼šä¸‹è½½æ‰€éœ€çš„æ’ä»¶å’Œä¾èµ–ï¼Œå¹¶åˆå§‹åŒ–åç«¯é…ç½®ã€‚<br>ç±»ä¼¼çš„è¾“å‡ºï¼ˆé¦–æ¬¡ä½¿ç”¨æŸä¸€ä¸ªprovieræ—¶ï¼Œä¼šå…ˆä¸‹è½½ï¼‰ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Initializing the backend...</span><br><span class="line"></span><br><span class="line">Successfully configured the backend &quot;oss&quot;! Terraform will automatically</span><br><span class="line">use this backend unless the backend configuration changes.</span><br><span class="line">Initializing modules...</span><br><span class="line">- ckafka_instance in ../../../../modules/tcloud/tcloud_ckafka_mod_demo</span><br><span class="line">Initializing provider plugins...</span><br><span class="line">- Finding latest version of tencentcloudstack/tencentcloud...</span><br><span class="line">- Installing tencentcloudstack/tencentcloud v1.81.162...</span><br><span class="line">- Installed tencentcloudstack/tencentcloud v1.81.162 (signed by a HashiCorp partner, key ID 84F69E1C1BECF459)</span><br><span class="line">Partner and community providers are signed by their developers.</span><br><span class="line">If you&#x27;d like to know more about provider signing, you can read about it here:</span><br><span class="line">https://www.terraform.io/docs/cli/plugins/signing.html</span><br><span class="line">Terraform has created a lock file .terraform.lock.hcl to record the provider</span><br><span class="line">selections it made above. Include this file in your version control repository</span><br><span class="line">so that Terraform can guarantee to make the same selections by default when</span><br><span class="line">you run &quot;terraform init&quot; in the future.</span><br><span class="line"></span><br><span class="line">Terraform has been successfully initialized!</span><br><span class="line"></span><br><span class="line">You may now begin working with Terraform. Try running &quot;terraform plan&quot; to see</span><br><span class="line">any changes that are required for your infrastructure. All Terraform commands</span><br><span class="line">should now work.</span><br><span class="line"></span><br><span class="line">If you ever set or change modules or backend configuration for Terraform,</span><br><span class="line">rerun this command to reinitialize your working directory. If you forget, other</span><br><span class="line">commands will detect it and remind you to do so if necessary.</span><br></pre></td></tr></table></figure>

<h3 id="é¢„è§ˆè®¡åˆ’å˜æ›´ï¼š"><a href="#é¢„è§ˆè®¡åˆ’å˜æ›´ï¼š" class="headerlink" title="é¢„è§ˆè®¡åˆ’å˜æ›´ï¼š"></a>é¢„è§ˆè®¡åˆ’å˜æ›´ï¼š</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">terraform plan</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">module.ckafka_instance.data.tencentcloud_availability_zones_by_product.zone: Reading...</span><br><span class="line">module.ckafka_instance.data.tencentcloud_availability_zones_by_product.zone: Read complete after 0s [id=2066006299]</span><br><span class="line"></span><br><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span><br><span class="line">  + create</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">module.ckafka_instance.tencentcloud_ckafka_instance.this will be created</span></span><br><span class="line">  + resource &quot;tencentcloud_ckafka_instance&quot; &quot;this&quot; &#123;</span><br><span class="line">      + band_width          = 20</span><br><span class="line">      + charge_type         = &quot;POSTPAID_BY_HOUR&quot;</span><br><span class="line">      + disk_size           = 200</span><br><span class="line">      + disk_type           = &quot;CLOUD_BASIC&quot;</span><br><span class="line">      + id                  = (known after apply)</span><br><span class="line">      + instance_name       = &quot;ckafka-test&quot;</span><br><span class="line">      + instance_type       = (known after apply)</span><br><span class="line">      + kafka_version       = &quot;kafka_version&quot;</span><br><span class="line">      + max_message_byte    = (known after apply)</span><br><span class="line">      + msg_retention_time  = 1300</span><br><span class="line">      + partition           = 400</span><br><span class="line">      + public_network      = (known after apply)</span><br><span class="line">      + renew_flag          = (known after apply)</span><br><span class="line">      + specifications_type = &quot;profession&quot;</span><br><span class="line">      + subnet_id           = &quot;subnet-oy1pqvzv&quot;</span><br><span class="line">      + tag_set             = (known after apply)</span><br><span class="line">      + upgrade_strategy    = 1</span><br><span class="line">      + vip                 = (known after apply)</span><br><span class="line">      + vpc_id              = &quot;vpc-4tkroxts&quot;</span><br><span class="line">      + vport               = (known after apply)</span><br><span class="line">      + zone_id             = 200002</span><br><span class="line"></span><br><span class="line">      + config &#123;</span><br><span class="line">          + auto_create_topic_enable   = true</span><br><span class="line">          + default_num_partitions     = 3</span><br><span class="line">          + default_replication_factor = 3</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      + dynamic_retention_config &#123;</span><br><span class="line">          + bottom_retention        = (known after apply)</span><br><span class="line">          + disk_quota_percentage   = (known after apply)</span><br><span class="line">          + enable                  = 1</span><br><span class="line">          + step_forward_percentage = (known after apply)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      + tags (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 1 to add, 0 to change, 0 to destroy.</span><br><span class="line"></span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"></span><br><span class="line">Note: You didn&#x27;t use the -out option to save this plan, so Terraform can&#x27;t guarantee to take exactly these actions if you run &quot;terraform apply&quot; now.</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œå˜æ›´ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">terraform apply</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">module.ckafka_instance.data.tencentcloud_availability_zones_by_product.zone: Reading...</span><br><span class="line">module.ckafka_instance.data.tencentcloud_availability_zones_by_product.zone: Read complete after 1s [id=2066006299]</span><br><span class="line"></span><br><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span><br><span class="line">  + create</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">module.ckafka_instance.tencentcloud_ckafka_instance.this will be created</span></span><br><span class="line">  + resource &quot;tencentcloud_ckafka_instance&quot; &quot;this&quot; &#123;</span><br><span class="line">      + band_width          = 20</span><br><span class="line">      + charge_type         = &quot;POSTPAID_BY_HOUR&quot;</span><br><span class="line">      + disk_size           = 200</span><br><span class="line">      + disk_type           = &quot;CLOUD_BASIC&quot;</span><br><span class="line">      + id                  = (known after apply)</span><br><span class="line">      + instance_name       = &quot;ckafka-test&quot;</span><br><span class="line">      + instance_type       = (known after apply)</span><br><span class="line">      + kafka_version       = &quot;kafka_version&quot;</span><br><span class="line">      + max_message_byte    = (known after apply)</span><br><span class="line">      + msg_retention_time  = 1300</span><br><span class="line">      + partition           = 400</span><br><span class="line">      + public_network      = (known after apply)</span><br><span class="line">      + renew_flag          = (known after apply)</span><br><span class="line">      + specifications_type = &quot;profession&quot;</span><br><span class="line">      + subnet_id           = &quot;subnet-oy1pqvzv&quot;</span><br><span class="line">      + tag_set             = (known after apply)</span><br><span class="line">      + upgrade_strategy    = 1</span><br><span class="line">      + vip                 = (known after apply)</span><br><span class="line">      + vpc_id              = &quot;vpc-4tkroxts&quot;</span><br><span class="line">      + vport               = (known after apply)</span><br><span class="line">      + zone_id             = 200002</span><br><span class="line"></span><br><span class="line">      + config &#123;</span><br><span class="line">          + auto_create_topic_enable   = true</span><br><span class="line">          + default_num_partitions     = 3</span><br><span class="line">          + default_replication_factor = 3</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      + dynamic_retention_config &#123;</span><br><span class="line">          + bottom_retention        = (known after apply)</span><br><span class="line">          + disk_quota_percentage   = (known after apply)</span><br><span class="line">          + enable                  = 1</span><br><span class="line">          + step_forward_percentage = (known after apply)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      + tags (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 1 to add, 0 to change, 0 to destroy.</span><br><span class="line"></span><br><span class="line">Do you want to perform these actions?</span><br><span class="line">  Terraform will perform the actions described above.</span><br><span class="line">  Only &#x27;yes&#x27; will be accepted to approve.</span><br><span class="line"></span><br><span class="line">  Enter a value: yes</span><br><span class="line"></span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Creating...</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [10s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [20s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [30s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [40s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [50s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [1m0s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [1m10s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [1m20s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [1m30s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [1m40s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [1m50s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [2m0s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [2m10s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [2m20s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [2m30s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [2m40s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [2m50s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [3m0s elapsed]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Creation complete after 3m7s [id=ckafka-9jnda3jn]</span><br><span class="line"></span><br><span class="line">Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</span><br></pre></td></tr></table></figure>

<h3 id="éªŒè¯åˆ›å»º"><a href="#éªŒè¯åˆ›å»º" class="headerlink" title="éªŒè¯åˆ›å»º"></a>éªŒè¯åˆ›å»º</h3><p>åœ¨å‰ç«¯æŸ¥çœ‹æ˜¯å¦æˆåŠŸåˆ›å»ºå®ä¾‹ï¼š<br><img src="/img_1.png" alt="img_1.png"></p>
<h3 id="é”€æ¯èµ„æº"><a href="#é”€æ¯èµ„æº" class="headerlink" title="é”€æ¯èµ„æº"></a>é”€æ¯èµ„æº</h3><p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿›è¡Œé”€æ¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">terraform destroy</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">module.ckafka_instance.data.tencentcloud_availability_zones_by_product.zone: Reading...</span><br><span class="line">module.ckafka_instance.data.tencentcloud_availability_zones_by_product.zone: Read complete after 1s [id=2066006299]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Refreshing state... [id=ckafka-9jnda3jn]</span><br><span class="line"></span><br><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span><br><span class="line">  - destroy</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">module.ckafka_instance.tencentcloud_ckafka_instance.this will be destroyed</span></span><br><span class="line">  - resource &quot;tencentcloud_ckafka_instance&quot; &quot;this&quot; &#123;</span><br><span class="line">      - band_width          = 20 -&gt; null</span><br><span class="line">      - charge_type         = &quot;POSTPAID_BY_HOUR&quot; -&gt; null</span><br><span class="line">      - disk_size           = 200 -&gt; null</span><br><span class="line">      - disk_type           = &quot;CLOUD_BASIC&quot; -&gt; null</span><br><span class="line">      - id                  = &quot;ckafka-9jnda3jn&quot; -&gt; null</span><br><span class="line">      - instance_name       = &quot;ckafka-test&quot; -&gt; null</span><br><span class="line">      - instance_type       = 1 -&gt; null</span><br><span class="line">      - kafka_version       = &quot;0.10.2.1&quot; -&gt; null</span><br><span class="line">      - msg_retention_time  = 1300 -&gt; null</span><br><span class="line">      - partition           = 400 -&gt; null</span><br><span class="line">      - public_network      = 3 -&gt; null</span><br><span class="line">      - renew_flag          = 0 -&gt; null</span><br><span class="line">      - specifications_type = &quot;profession&quot; -&gt; null</span><br><span class="line">      - subnet_id           = &quot;subnet-oy1pqvzv&quot; -&gt; null</span><br><span class="line">      - tag_set             = &#123;&#125; -&gt; null</span><br><span class="line">      - upgrade_strategy    = 1 -&gt; null</span><br><span class="line">      - vip                 = &quot;172.17.0.3&quot; -&gt; null</span><br><span class="line">      - vpc_id              = &quot;vpc-4tkroxts&quot; -&gt; null</span><br><span class="line">      - vport               = &quot;9092&quot; -&gt; null</span><br><span class="line">      - zone_id             = 200002 -&gt; null</span><br><span class="line"></span><br><span class="line">      - config &#123;</span><br><span class="line">          - auto_create_topic_enable   = true -&gt; null</span><br><span class="line">          - default_num_partitions     = 3 -&gt; null</span><br><span class="line">          - default_replication_factor = 3 -&gt; null</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      - dynamic_retention_config &#123;</span><br><span class="line">          - bottom_retention        = 0 -&gt; null</span><br><span class="line">          - disk_quota_percentage   = 0 -&gt; null</span><br><span class="line">          - enable                  = 1 -&gt; null</span><br><span class="line">          - step_forward_percentage = 0 -&gt; null</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 0 to add, 0 to change, 1 to destroy.</span><br><span class="line"></span><br><span class="line">Do you really want to destroy all resources?</span><br><span class="line">  Terraform will destroy all your managed infrastructure, as shown above.</span><br><span class="line">  There is no undo. Only &#x27;yes&#x27; will be accepted to confirm.</span><br><span class="line"></span><br><span class="line">  Enter a value: yes</span><br><span class="line"></span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Destroying... [id=ckafka-9jnda3jn]</span><br><span class="line">module.ckafka_instance.tencentcloud_ckafka_instance.this: Destruction complete after 5s</span><br><span class="line"></span><br><span class="line">Destroy complete! Resources: 1 destroyed.</span><br></pre></td></tr></table></figure>

<h3 id="éªŒè¯é”€æ¯"><a href="#éªŒè¯é”€æ¯" class="headerlink" title="éªŒè¯é”€æ¯"></a>éªŒè¯é”€æ¯</h3><p><img src="/img_2.png" alt="img_2.png"></p>
]]></content>
  </entry>
  <entry>
    <title>operatoréƒ¨ç½²éªŒè¯</title>
    <url>/2025/07/kubernetes/Operator%E5%BC%80%E5%8F%91/operator%E9%83%A8%E7%BD%B2%E9%AA%8C%E8%AF%81/</url>
    <content><![CDATA[<h1 id="1ã€éƒ¨ç½²å‘½ä»¤"><a href="#1ã€éƒ¨ç½²å‘½ä»¤" class="headerlink" title="1ã€éƒ¨ç½²å‘½ä»¤"></a>1ã€éƒ¨ç½²å‘½ä»¤</h1><p>è¿™ä¸ªæ˜¯å¾ˆå¤šåšå®¢æ•™ç¨‹éƒ½åœ¨ä½¿ç”¨çš„éƒ¨ç½²å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make manifests</span><br><span class="line">make install</span><br><span class="line">export ENABLE_WEBHOOKS=false</span><br><span class="line">make run</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨ä¹‹å‰çš„demoæ¥è¿›è¡Œéƒ¨ç½²éªŒè¯ï¼š<a href="https://hua-ri.cn/2025/07/kubernetes/Operator%E5%BC%80%E5%8F%91/operator%E5%BC%80%E5%8F%91%E8%84%9A%E6%89%8B%E6%9E%B6/">Kubernetes-Operatorç¯‡-02-è„šæ‰‹æ¶ç†Ÿæ‚‰</a></p>
<p>è¿™é‡Œé¢æ¶‰åŠåˆ°çš„makefileçš„é…ç½®å¯ä»¥å‚è€ƒï¼š<a href="https://hua-ri.cn/2025/07/kubernetes/Operator%E5%BC%80%E5%8F%91/kubebuilder%E7%9A%84makefile%E6%96%87%E4%BB%B6/">Kubernetes-Operatorç¯‡-03-kubebuilderçš„Makefileæ–‡ä»¶ç†Ÿæ‚‰</a></p>
<p>ä¸‹é¢è®©æˆ‘æ¥çœ‹çœ‹è¿™äº›å‘½ä»¤çš„å«ä¹‰ï¼Œå¹¶ä¸”éƒ½æ˜¯åœ¨å¹²ä»€ä¹ˆ</p>
<h2 id="1-1-make-manifests"><a href="#1-1-make-manifests" class="headerlink" title="1.1 make manifests"></a>1.1 make manifests</h2><p><code>make manifests</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: manifests</span><br><span class="line">manifests: controller-gen ## Generate WebhookConfiguration, ClusterRole and CustomResourceDefinition objects.</span><br><span class="line">        $(CONTROLLER_GEN) rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†ç”ŸæˆWebhookConfigurationã€ClusterRoleå’ŒCustomResourceDefinition å¯¹è±¡ã€‚</p>
<p>åœ¨ç”Ÿæˆäº†WebhookConfigurationã€ClusterRoleå’ŒCustomResourceDefinition å¯¹è±¡åï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡ŒæŸ¥çœ‹ï¼Œä½†æ˜¯ä¸è¦æ‰‹åŠ¨å»ä¿®æ”¹ï¼Œå› ä¸ºåé¢çš„<code>make install</code>å’Œ<code>make run</code>ç­‰å‘½ä»¤ï¼Œéƒ½ä¾èµ–è¯¥ç›®æ ‡ï¼Œå¹¶ä¸”å› ä¸ºéƒ½æ˜¯ä½¿ç”¨çš„<code>.PHONY</code>å…³é”®å­—æ¥ç”³æ˜çš„ä¼ªç›®æ ‡ï¼Œæ‰€ä»¥æ¯æ¬¡æ‰§è¡Œ<code>make install</code>å’Œ<code>make run</code>éƒ½ä¼šæ‰§è¡Œmanifestsä¾èµ–ã€‚</p>
<p>æ‰€ä»¥å•ç‹¬æ‰§è¡Œmake manifestsçš„æ„ä¹‰æ˜¯ä»€ä¹ˆå‘¢ï¼Œä¸ªäººè§‚ç‚¹ï¼Œåœ¨ä¸€ä¸ªå®Œæ•´éƒ¨ç½²åŠ¨ä½œä¸­ï¼Œå®Œæˆäº†ä»£ç å˜æ›´åï¼Œæ˜¯éœ€è¦é€šè¿‡<code>make manifests</code>æ¥è¿›è¡Œé…ç½®çš„ç”ŸæˆæŸ¥çœ‹çš„ã€‚<code>ä½†æ˜¯å¦‚æœåœ¨æœ¬éƒ¨ç½²åŠ¨ä½œä¸­ï¼Œä¸å…³å¿ƒç”Ÿæˆé…ç½®çš„å…·ä½“æƒ…å†µï¼Œåªæƒ³èµ°ä¸€éæµç¨‹ï¼Œæˆ–è€…ç›´æ¥æµ‹è¯•ï¼Œé‚£å…¶å®å¿½ç•¥ä¸æ‰§è¡Œä¹Ÿokï¼Œæ¯•ç«Ÿåé¢æ¯ä¸€æ­¥éƒ½ä¼šé‡æ–°ç”Ÿæˆä¸”è¦†ç›–ã€‚</code></p>
<h2 id="1-2-make-install"><a href="#1-2-make-install" class="headerlink" title="1.2 make install"></a>1.2 make install</h2><p><code>make install</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: install</span><br><span class="line">install: manifests kustomize ## Install CRDs into the K8s cluster specified in ~/.kube/config.</span><br><span class="line">        $(KUSTOMIZE) build config/crd | $(KUBECTL) apply -f -</span><br></pre></td></tr></table></figure>

<p>å…ˆè¿è¡Œmanifestså’Œkustomizeç›®æ ‡ï¼Œç„¶åä½¿ç”¨kustomize æ„å»ºconfig&#x2F;crdç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶åº”ç”¨åˆ°é›†ç¾¤ã€‚</p>
<p>è¿™é‡Œmanifestsç›®æ ‡ä¼šç”ŸæˆWebhookConfigurationã€ClusterRoleå’ŒCustomResourceDefinition å¯¹è±¡ï¼Œå¹¶ä¿å­˜åœ¨config&#x2F;crd&#x2F;basesç›®å½•ä¸‹ã€‚</p>
<p>è€Œkustomizeç›®æ ‡æ˜¯è¿›è¡Œkustomizeå·¥å…·çš„ä¸‹è½½ï¼Œå¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨åˆ™ä¸‹è½½ï¼Œç„¶åç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶çš„è½¯é“¾ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶åªåœ¨é¦–æ¬¡ä¸‹è½½ï¼Œåç»­éƒ½æ˜¯ä»…æ›´æ–°è½¯é“¾ã€‚</p>
<p>ä¸‹é¢çš„å‘½ä»¤æ˜¯installå®é™…æ‰§è¡Œçš„åŠ¨ä½œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(KUSTOMIZE) build config/crd | $(KUBECTL) apply -f -</span></span><br></pre></td></tr></table></figure>

<h2 id="1-3-make-run"><a href="#1-3-make-run" class="headerlink" title="1.3 make run"></a>1.3 make run</h2><p><code>make run</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: run</span><br><span class="line">run: manifests generate fmt vet ## Run a controller from your host.</span><br><span class="line">        go run ./cmd/main.go</span><br></pre></td></tr></table></figure>
<p>å…ˆè¿è¡Œmanifestsã€generateã€fmtå’Œvetç›®æ ‡ï¼Œç„¶åä½¿ç”¨go runå‘½ä»¤è¿è¡Œcmd&#x2F;main.goæ–‡ä»¶</p>
<p>è¿™é‡Œmanifestsç›®æ ‡ä¼šç”ŸæˆWebhookConfigurationã€ClusterRoleå’ŒCustomResourceDefinition å¯¹è±¡ï¼Œå¹¶ä¿å­˜åœ¨config&#x2F;crd&#x2F;basesç›®å½•ä¸‹ã€‚</p>
<p>è€Œgenerate ç›®æ ‡æ˜¯ä½¿ç”¨controller-genå·¥å…·ç”ŸæˆåŒ…å«DeepCopyã€DeepCopyInto, å’ŒDeepCopyObjectæ–¹æ³•å®ç°çš„ä»£ç ã€‚</p>
<p>è‡³äºfmtå’Œvetç›®æ ‡å°±æ˜¯æ‰§è¡Œgoçš„å‘½ä»¤ï¼š<code>fmt ./...</code>å’Œ<code>go vet ./...</code></p>
<p>ä¸‹é¢çš„å‘½ä»¤æ˜¯installå®é™…æ‰§è¡Œçš„åŠ¨ä½œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">go run ./cmd/main.go</span><br></pre></td></tr></table></figure>

<h3 id="1-4-ç¯å¢ƒå˜é‡ENABLE-WEBHOOKS"><a href="#1-4-ç¯å¢ƒå˜é‡ENABLE-WEBHOOKS" class="headerlink" title="1.4 ç¯å¢ƒå˜é‡ENABLE_WEBHOOKS"></a>1.4 ç¯å¢ƒå˜é‡ENABLE_WEBHOOKS</h3><p>ç¯å¢ƒå˜é‡ENABLE_WEBHOOKSæ§åˆ¶ç€webhookçš„å¯ç”¨ä¸å¦ã€‚</p>
<p>è¿™æ®µä»£ç æ˜¯kubectlç”Ÿæˆçš„operatoré¡¹ç›®çš„mainå‡½æ•°ä¸­å¯ç”¨webhooké€»è¾‘çš„éƒ¨åˆ†ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">if os.Getenv(&quot;ENABLE_WEBHOOKS&quot;) != &quot;false&quot; &#123;</span><br><span class="line">                if err = (&amp;appsv1.Myapp&#123;&#125;).SetupWebhookWithManager(mgr); err != nil &#123;</span><br><span class="line">                        setupLog.Error(err, &quot;unable to create webhook&quot;, &quot;webhook&quot;, &quot;Myapp&quot;)</span><br><span class="line">                        os.Exit(1)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¾ˆç®€å•ç²—æš´çš„æ ¹æ®ç¯å¢ƒå˜é‡ENABLE_WEBHOOKSæ¥å†³å®šæ˜¯å¦å¯ç”¨webhookï¼Œos.Getenvçš„å®šä¹‰:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">func Getenv(key string) string &#123;</span><br><span class="line">        testlog.Getenv(key)</span><br><span class="line">        v, _ := syscall.Getenv(key)</span><br><span class="line">        return v</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func Getenv(key string) (value string, found bool) &#123;</span><br><span class="line">        envOnce.Do(copyenv)</span><br><span class="line">        if len(key) == 0 &#123;</span><br><span class="line">                return &quot;&quot;, false</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        envLock.RLock()</span><br><span class="line">        defer envLock.RUnlock()</span><br><span class="line"></span><br><span class="line">        i, ok := env[key]</span><br><span class="line">        if !ok &#123;</span><br><span class="line">                return &quot;&quot;, false</span><br><span class="line">        &#125;</span><br><span class="line">        s := envs[i]</span><br><span class="line">        for i := 0; i &lt; len(s); i++ &#123;</span><br><span class="line">                if s[i] == &#x27;=&#x27; &#123;</span><br><span class="line">                        return s[i+1:], true</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;&quot;, false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè¿”å›çš„å€¼ï¼Œå¯èƒ½æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯èƒ½æ˜¯boolç±»å‹å€¼çš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯åªè¦å€¼ä¸æ˜¯falseï¼Œå°±ä¼šå¼€å¯webhookã€‚</p>
<p>è‡³äºè¿™é‡Œä¸ºä»€ä¹ˆè¦ä¸´æ—¶å…³é—­webhookï¼Œå› ä¸ºå¯ç”¨webhookæ˜¯éœ€è¦è¯ä¹¦çš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦åœ¨æœ¬åœ°å®‰è£…cert-managerï¼Œå¹¶ä¸”è¿˜éœ€è¦é…ç½®ï¼Œåœ¨æœ¬å®éªŒé¡¹ç›®å°±ä¸æå¤ªå¤æ‚äº†ã€‚</p>
<h1 id="2ã€CRD-è°ƒè¯•"><a href="#2ã€CRD-è°ƒè¯•" class="headerlink" title="2ã€CRD è°ƒè¯•"></a>2ã€CRD è°ƒè¯•</h1><h2 id="2-1-make-manifests"><a href="#2-1-make-manifests" class="headerlink" title="2.1 make manifests"></a>2.1 make manifests</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make manifests</span><br><span class="line">/home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br><span class="line"></span><br><span class="line">ls -lh config/crd/bases/</span><br><span class="line">æ€»è®¡ 1.1M</span><br><span class="line">-rw-rw-r-- 1 king king 1.1M 10æœˆ  5 16:17 apps.kubenode.kingtest.com_myapps.yaml</span><br></pre></td></tr></table></figure>

<h2 id="2-2-make-install"><a href="#2-2-make-install" class="headerlink" title="2.2 make install"></a>2.2 make install</h2><p>å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make install</span><br></pre></td></tr></table></figure>

<h3 id="2-2-1-make-installé”™è¯¯ï¼šdial-tcp-127-0-0-1-8080-connect-connection-refused"><a href="#2-2-1-make-installé”™è¯¯ï¼šdial-tcp-127-0-0-1-8080-connect-connection-refused" class="headerlink" title="2.2.1 make installé”™è¯¯ï¼šdial tcp 127.0.0.1:8080: connect: connection refused"></a>2.2.1 make installé”™è¯¯ï¼šdial tcp 127.0.0.1:8080: connect: connection refused</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make install</span><br><span class="line">/home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br><span class="line">/home/king/workspace/king-devops/operator/myapp-operator/bin/kustomize build config/crd | kubectl apply -f -</span><br><span class="line">error: error validating &quot;STDIN&quot;: error validating data: failed to download openapi: Get &quot;http://localhost:8080/openapi/v2?timeout=32s&quot;: dial tcp 127.0.0.1:8080: connect: connection refused; if you choose to ignore these errors, turn validation off with --validate=false</span><br><span class="line">make: *** [Makefile:131ï¼šinstall] é”™è¯¯ 1</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªé”™è¯¯å¾ˆè¯¡å¼‚ï¼š dial tcp 127.0.0.1:8080: connect: connection refused</p>
<p>é¦–å…ˆé›†ç¾¤æ˜¯å­˜åœ¨çš„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo kind get clusters</span><br><span class="line">myk8s-test</span><br></pre></td></tr></table></figure>

<p>å…¶æ¬¡å·²ç»ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å°†é›†ç¾¤ä¿¡æ¯ï¼Œè®¾ç½®è¿›å»kubectlçš„ä¸Šä¸‹æ–‡é‡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo kubectl cluster-info --context kind-myk8s-test</span><br></pre></td></tr></table></figure>

<p>sudo kubectl cluster-info â€“context kind-myk8s-test</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo kubectl get nodes</span><br><span class="line">NAME                       STATUS   ROLES           AGE   VERSION</span><br><span class="line">myk8s-test-control-plane   Ready    control-plane   43h   v1.31.0</span><br><span class="line">myk8s-test-worker          Ready    &lt;none&gt;          43h   v1.31.0</span><br><span class="line">myk8s-test-worker2         Ready    &lt;none&gt;          43h   v1.31.0</span><br></pre></td></tr></table></figure>

<p>è¿›ä¸€æ­¥æµ‹è¯•ï¼Œåˆ†åˆ«æ‰§è¡Œ<code>kubectl version</code>å’Œ<code>kubectl cluster-info dump</code>éƒ½é‡è§äº†ç±»ä¼¼çš„é”™è¯¯ï¼š</p>
<p><code>kubectl version</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl version</span><br><span class="line">Client Version: v1.31.1</span><br><span class="line">Kustomize Version: v5.4.2</span><br><span class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</span><br></pre></td></tr></table></figure>

<p><code>kubectl cluster-info dump</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl cluster-info dump</span><br><span class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å¾ˆæ‚²å‚¬çš„æ˜¯ï¼Œå¿˜è®°å°†kindé›†ç¾¤çš„kubeconfigå¯¼å‡ºåˆ°æœ¬åœ°ï¼Œæˆ‘çš„ç†è§£æ˜¯ï¼Œè™½ç„¶kubectlä¸Šä¸‹æ–‡æ˜¯æœ‰é›†ç¾¤kubeconfigçš„ï¼Œä½†æ˜¯æœ¬åœ°å¹¶æ²¡æœ‰ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯è¿™ä¸ªä¿¡æ¯æ˜¯kubectlè‡ªèº«ä¿å­˜çš„ï¼Œä¸æ˜¯ç›´æ¥ä½¿ç”¨çš„ç³»ç»Ÿä¸Šå­˜å‚¨çš„kubeconfig</p>
<p>ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œå°†kubeconfigä¿¡æ¯ä¿å­˜åœ¨<code>$HOME/.kube/configå†…</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo kind export kubeconfig --name=myk8s-test --kubeconfig=$HOME/.kube/config</span><br></pre></td></tr></table></figure>

<p>å†æ‰§è¡Œ<code>make install</code>å‘½ä»¤ï¼Œæœ¬é—®é¢˜å·²ç»è§£å†³ï¼Œä½†æ˜¯æ–°çš„é—®é¢˜å‡ºç°äº†ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make install</span><br><span class="line">/home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br><span class="line">/home/king/workspace/king-devops/operator/myapp-operator/bin/kustomize build config/crd | kubectl apply -f -</span><br><span class="line">The CustomResourceDefinition &quot;myapps.apps.kubenode.kingtest.com&quot; is invalid: metadata.annotations: Too long: must have at most 262144 bytes</span><br><span class="line">make: *** [Makefile:131ï¼šinstall] é”™è¯¯ 1</span><br></pre></td></tr></table></figure>

<h3 id="2-2-2-make-installé”™è¯¯ï¼šmetadata-annotations-Too-long-must-have-at-most-262144-bytes"><a href="#2-2-2-make-installé”™è¯¯ï¼šmetadata-annotations-Too-long-must-have-at-most-262144-bytes" class="headerlink" title="2.2.2 make installé”™è¯¯ï¼šmetadata.annotations: Too long: must have at most 262144 bytes"></a>2.2.2 make installé”™è¯¯ï¼šmetadata.annotations: Too long: must have at most 262144 bytes</h3><p>kubebuilderçš„github issuesä¸­ï¼Œä¿®å¤è¿‡è¿™ä¸ªé—®é¢˜: <a href="https://github.com/kubernetes-sigs/kubebuilder/pull/2862/commits/2c5b9edf614444acd43ae5f65af1702a5ed63ed6">https://github.com/kubernetes-sigs/kubebuilder/pull/2862/commits/2c5b9edf614444acd43ae5f65af1702a5ed63ed6</a></p>
<p>ä¿®å¤æ–¹æ³•ï¼šæ‰“å¼€Makefileï¼Œåœ¨ manifests å‘½ä»¤å¤„ï¼Œä¿®æ”¹ crd ä¸º crd:maxDescLen&#x3D;0</p>
<p>åŸå§‹çš„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: manifests</span><br><span class="line">manifests: controller-gen ## Generate WebhookConfiguration, ClusterRole and CustomResourceDefinition objects.</span><br><span class="line">        $(CONTROLLER_GEN) rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br></pre></td></tr></table></figure>

<p>ä¿®å¤åçš„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: manifests</span><br><span class="line">manifests: controller-gen ## Generate WebhookConfiguration, ClusterRole and CustomResourceDefinition objects.</span><br><span class="line">        $(CONTROLLER_GEN) rbac:roleName=manager-role crd:maxDescLen=0 webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br></pre></td></tr></table></figure>

<p>é—®é¢˜è§£å†³ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make install</span><br><span class="line">/home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen rbac:roleName=manager-role crd:maxDescLen=0 webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br><span class="line">/home/king/workspace/king-devops/operator/myapp-operator/bin/kustomize build config/crd | kubectl apply -f -</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/my</span><br></pre></td></tr></table></figure>

<h3 id="2-2-3-make-installéªŒè¯"><a href="#2-2-3-make-installéªŒè¯" class="headerlink" title="2.2.3 make installéªŒè¯"></a>2.2.3 make installéªŒè¯</h3><p>æŸ¥çœ‹å®‰è£…ç»“æœï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl get crd</span><br><span class="line">NAME                                CREATED AT</span><br><span class="line">myapps.apps.kubenode.kingtest.com   2024-10-05T11:56:22Z</span><br></pre></td></tr></table></figure>
<p>å·²ç»å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å®šä¹‰çš„crdäº†ã€‚</p>
<h2 id="2-3-make-run"><a href="#2-3-make-run" class="headerlink" title="2.3 make run"></a>2.3 make run</h2><p>å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export ENABLE_WEBHOOKS=false</span><br><span class="line">make run</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make run</span><br><span class="line">/home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen rbac:roleName=manager-role crd:maxDescLen=0 webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br><span class="line">/home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;</span><br><span class="line">go fmt ./...</span><br><span class="line">go vet ./...</span><br><span class="line">go run ./cmd/main.go</span><br><span class="line">2024-10-05T20:29:02+08:00       INFO    setup   starting manager</span><br><span class="line">2024-10-05T20:29:02+08:00       INFO    starting server &#123;&quot;name&quot;: &quot;health probe&quot;, &quot;addr&quot;: &quot;[::]:8081&quot;&#125;</span><br><span class="line">2024-10-05T20:29:02+08:00       INFO    Starting EventSource    &#123;&quot;controller&quot;: &quot;myapp&quot;, &quot;controllerGroup&quot;: &quot;apps.kubenode.kingtest.com&quot;, &quot;controllerKind&quot;: &quot;Myapp&quot;, &quot;source&quot;: &quot;kind source: *v1.Myapp&quot;&#125;</span><br><span class="line">2024-10-05T20:29:02+08:00       INFO    Starting Controller     &#123;&quot;controller&quot;: &quot;myapp&quot;, &quot;controllerGroup&quot;: &quot;apps.kubenode.kingtest.com&quot;, &quot;controllerKind&quot;: &quot;Myapp&quot;&#125;</span><br><span class="line">2024-10-05T20:29:02+08:00       INFO    Starting workers        &#123;&quot;controller&quot;: &quot;myapp&quot;, &quot;controllerGroup&quot;: &quot;apps.kubenode.kingtest.com&quot;, &quot;controllerKind&quot;: &quot;Myapp&quot;, &quot;worker count&quot;: 1&#125;</span><br></pre></td></tr></table></figure>

<p>å·²ç»æˆåŠŸå¯åŠ¨ï¼ï¼ï¼</p>
<h2 id="2-4-æ‰§è¡Œdebug"><a href="#2-4-æ‰§è¡Œdebug" class="headerlink" title="2.4 æ‰§è¡Œdebug"></a>2.4 æ‰§è¡Œdebug</h2><h3 id="2-4-1-å¯åŠ¨debug"><a href="#2-4-1-å¯åŠ¨debug" class="headerlink" title="2.4.1 å¯åŠ¨debug"></a>2.4.1 å¯åŠ¨debug</h3><p>åœ¨ä¸Šé¢æ‰§è¡Œäº†ä»¥ä¸‹æ­¥éª¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make manifests</span><br><span class="line">make install</span><br><span class="line">export ENABLE_WEBHOOKS=false</span><br><span class="line">make run</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å…ˆå°†make runè¿è¡Œçš„controlleråœæ­¢ï¼Œç„¶åæ‰“å¼€operatoré¡¹ç›®ï¼Œåœ¨é¡¹ç›®çš„è°ƒè°å‡½æ•°å†…æ‰“ä¸Šæ–­ç‚¹ï¼Œç„¶åç›´æ¥ä»¥debugæ¨¡å¼å¯åŠ¨ã€‚</p>
<p>æ‰“æ–­ç‚¹<br><img src="/img_5.png" alt="img_5.png"></p>
<p>åˆ«å¿˜äº†è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå…³é—­webhook<br><img src="/img_6.png" alt="img_6.png"></p>
<p>ä»¥debugæ–¹å¼å¯åŠ¨ï¼š<br><img src="/img_7.png" alt="img_7.png"></p>
<p>æ‰§è¡Œç»“æœ<br><img src="/img_8.png" alt="img_8.png"></p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥applyä¸€ä¸ªèµ„æºï¼Œæµ‹è¯•ä¸€ä¸‹ã€‚</p>
<h3 id="2-4-2-crdæµ‹è¯•"><a href="#2-4-2-crdæµ‹è¯•" class="headerlink" title="2.4.2 crdæµ‹è¯•"></a>2.4.2 crdæµ‹è¯•</h3><p>ç¼–å†™ä¸€ä¸ªæµ‹è¯•çš„yamlï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">apiVersion: apps.kubenode.kingtest.com/v1</span><br><span class="line">kind: Myapp</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-sample</span><br><span class="line">spec:</span><br><span class="line">  foo: &quot;test value&quot;</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: myapp</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: myapp</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: myapp-container</span><br><span class="line">        image: nginx:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<p>å°†æµ‹è¯•yamlé€šè¿‡kubectl applyè¿›å»é›†ç¾¤:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo kubectl apply -f myapptest.yaml</span><br><span class="line">myapp.apps.kubenode.kingtest.com/myapp-sample created</span><br></pre></td></tr></table></figure>

<p>ç„¶åcontrollerçš„è°ƒè°å‡½æ•°æˆåŠŸæ–­ä½<br><img src="/img_9.png" alt="img_9.png"></p>
<p>å†å‘ä¸‹æ‰§è¡Œä¸€æ­¥<br><img src="/img_10.png" alt="img_10.png"></p>
<p>åœ¨ç»ˆç«¯é‡Œå·²ç»æˆåŠŸæ‰“å°å‡ºæ¥ä»£ç é‡Œçš„æ—¥å¿—ï¼š<br><img src="/img_11.png" alt="img_11.png"></p>
<p>é€šè¿‡kubectlæŸ¥çœ‹crdçŠ¶æ€ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo kubectl get Myapp -A -owide</span><br><span class="line">NAMESPACE   NAME           AGE</span><br><span class="line">default     myapp-sample   14m</span><br></pre></td></tr></table></figure>
<p>åˆ°æ­¤éƒ½æ˜¯ç¬¦åˆé¢„æœŸçš„ã€‚</p>
<h1 id="4-æ„å»ºCRDé•œåƒå¹¶éƒ¨ç½²è¿›k8s"><a href="#4-æ„å»ºCRDé•œåƒå¹¶éƒ¨ç½²è¿›k8s" class="headerlink" title="4 æ„å»ºCRDé•œåƒå¹¶éƒ¨ç½²è¿›k8s"></a>4 æ„å»ºCRDé•œåƒå¹¶éƒ¨ç½²è¿›k8s</h1><p>ä¸Šé¢æˆ‘ä»¬æ˜¯åœ¨æœ¬åœ°è¿è¡Œçš„controllerï¼Œé‚£ä¹ˆåœ¨å®é™…ä¸­è¯¥æ€ä¹ˆåŠå‘¢ã€‚</p>
<p>ç­”æ¡ˆæ˜¯å°†controlleræ‰“åŒ…æˆdockeré•œåƒï¼Œç„¶åéƒ¨ç½²è¿›é›†ç¾¤ã€‚</p>
<p>æ„å»ºé•œåƒå¹¶æ¨é€è‡³ä½ çš„é•œåƒä»“åº“</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make docker-build docker-push IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag</span><br></pre></td></tr></table></figure>

<p>çœ‹ä¸‹makefileçš„å®šä¹‰ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: docker-build</span><br><span class="line">docker-build: ## Build docker image with the manager.</span><br><span class="line">        $(CONTAINER_TOOL) build -t $&#123;IMG&#125; .</span><br><span class="line"></span><br><span class="line">.PHONY: docker-push</span><br><span class="line">docker-push: ## Push docker image with the manager.</span><br><span class="line">        $(CONTAINER_TOOL) push $&#123;IMG&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå°±æ˜¯ä½¿ç”¨CONTAINER_TOOL(é»˜è®¤ä¸ºdocker)æ„å»ºå¹¶æ¨é€dockeré•œåƒï¼Œå¹¶ä½¿ç”¨IMGå˜é‡æŒ‡å®šé•œåƒåç§°å’Œæ ‡ç­¾<br>æŒ‡å®šé•œåƒå°†controlleréƒ¨ç½²è¿›ä½ çš„é›†ç¾¤</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make deploy IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹makefileå®šä¹‰ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: deploy</span><br><span class="line">deploy: manifests kustomize ## Deploy controller to the K8s cluster specified in ~/.kube/config.</span><br><span class="line">        cd config/manager &amp;&amp; $(KUSTOMIZE) edit set image controller=$&#123;IMG&#125;</span><br><span class="line">        $(KUSTOMIZE) build config/default | $(KUBECTL) apply -f -</span><br></pre></td></tr></table></figure>

<ul>
<li>å…ˆè¿è¡Œmanifestså’Œkustomizeç›®æ ‡</li>
<li>ä½¿ç”¨kustomizeè®¾ç½®controlleré•œåƒä¸ºIMG</li>
<li>ä½¿ç”¨kustomizeæ„å»ºconfig&#x2F;defaultç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶åº”ç”¨åˆ°é›†ç¾¤</li>
</ul>
<h1 id="5-åˆ é™¤controlleréƒ¨ç½²å’Œå¸è½½CRD"><a href="#5-åˆ é™¤controlleréƒ¨ç½²å’Œå¸è½½CRD" class="headerlink" title="5 åˆ é™¤controlleréƒ¨ç½²å’Œå¸è½½CRD"></a>5 åˆ é™¤controlleréƒ¨ç½²å’Œå¸è½½CRD</h1><p>åˆ é™¤controlleréƒ¨ç½²ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make undeploy</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹makefileå®šä¹‰ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: undeploy</span><br><span class="line">undeploy: kustomize ## Undeploy controller from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.</span><br><span class="line">        $(KUSTOMIZE) build config/default | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨kustomize æ„å»ºconfig&#x2F;defaultç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶ä»é›†ç¾¤ä¸­åˆ é™¤ã€‚å¯ä»¥é€šè¿‡ignore-not-found&#x3D;trueå¿½ç•¥èµ„æºæœªæ‰¾åˆ°çš„é”™è¯¯</p>
<p>ä»é›†ç¾¤å¸è½½CRDï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make uninstall</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹makefileå®šä¹‰ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.PHONY: uninstall</span><br><span class="line">uninstall: manifests kustomize ## Uninstall CRDs from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.</span><br><span class="line">        $(KUSTOMIZE) build config/crd | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -</span><br></pre></td></tr></table></figure>
<ul>
<li>å…ˆè¿è¡Œmanifestså’Œkustomizeç›®æ ‡</li>
<li>ä½¿ç”¨kustomize æ„å»ºconfig&#x2F;crdç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶ä»é›†ç¾¤ä¸­åˆ é™¤ï¼Œå¯ä»¥é€šè¿‡ignore-not-found&#x3D;trueå¿½ç•¥èµ„æºæœªæ‰¾åˆ°çš„é”™è¯¯</li>
</ul>
<h1 id="6-å…¶ä»–"><a href="#6-å…¶ä»–" class="headerlink" title="6 å…¶ä»–"></a>6 å…¶ä»–</h1><p>è¿™æ˜¯åœ¨æˆ‘ä»¬æœ¬åœ°è¿è¡Œçš„controllerï¼Œæˆ‘åœ¨æœ€åˆä¸€ç›´æƒ³ä¸é€šæ˜¯æ€ä¹ˆè¿æ¥çš„é›†ç¾¤çš„ï¼ŒçŸ¥é“æƒ³èµ·äº†æœ€åˆçš„client-goçš„ä½¿ç”¨ã€‚</p>
<p>åœ¨çœ‹æœ¬æ–‡çš„åŒå­¦ï¼Œè‚¯å®šæ˜¯å¬è¯´è¿‡ï¼Œç”šè‡³ä½¿ç”¨è¿‡client-goçš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨client-goå»å®ç°ä¸€äº›å°å·¥å…·ï¼Œæ¯”å¦‚è¯´æŸä¸ªnamespaceä¸‹podçš„æŸ¥è¯¢ï¼Œç”šè‡³å¯ä»¥è·å–nodeçš„åˆ—è¡¨ï¼Œpodçš„å…¨éƒ¨ä¿¡æ¯ç­‰ç­‰ï¼Œåªè¦æ˜¯kubectlå¯ä»¥åšçš„ï¼Œéƒ½å¯ä»¥é€šè¿‡client-goæ¥å®ç°ï¼Œå¹¶ä¸”å¯ä»¥åšæ›´å¤æ‚çš„åœºæ™¯ã€‚</p>
<p>æˆ‘ä»¬æ˜¯å¯ä»¥åœ¨å·¥å…·é‡ŒæŒ‡å®škubeconfigçš„è·¯å¾„çš„ï¼Œè®©client-goå»è¯»å–ï¼Œå¹¶æ¸²æŸ“å¯¹åº”çš„clientï¼Œç„¶åå’Œå¯¹åº”é›†ç¾¤çš„apiserveråšäº¤äº’ã€‚</p>
<p>çŸ¥é“äº†è¿™ç‚¹ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œoperatoræ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Œoperatorå…¶å®æ˜¯ä½¿ç”¨çš„controller-runtimeåº“ï¼Œä»–å’Œclient-goæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Œä»–æ˜¯client-goä»¥åŠå…¶ä»–åº“çš„æ›´ä¸Šä¸€å±‚å°è£…ã€‚</p>
<p>æ‰€ä»¥è™½ç„¶æ²¡å…·ä½“çœ‹ï¼Œä½†æ˜¯controller-runtimeè‚¯å®šæ˜¯é»˜è®¤è¯»å–çš„$HOME&#x2F;.kube&#x2F;configæ–‡ä»¶çš„kubeconfigï¼Œè‡³äºå¯ä¸å¯ä»¥æŒ‡å®šå…¶ä»–çš„kubeconfigï¼Œç†è®ºä¸Šæ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºå°±æ˜¯æŒ‡å®šä¸‹kubeconfigçš„è·¯å¾„ï¼Œç„¶åå»è¯»å–æ¸²æŸ“clientï¼Œè¿™é‡Œå’Œè‡ªå·±ç›´æ¥ä½¿ç”¨client-goå»å®ç°æ˜¯ä¸€æ ·çš„é€»è¾‘ã€‚</p>
<p>ä½†æ˜¯ï¼Œcontroller-runtimeç©¶ç«Ÿæ”¯ä¸æ”¯æŒï¼Œè¿˜éœ€è¦è‡ªå·±å»æ‰¾ä¸€ä¸‹æºç æˆ–è€…èµ„æ–™ï¼Œå› ä¸ºæœ¬åœ°è¿è¡Œcontrollerè¿™æœ¬èº«è‚¯å®šæ˜¯ä¸å»ºè®®çš„ï¼Œæ‰€ä»¥ä¸æ”¯æŒä¹Ÿæ˜¯è¯´å¾—è¿‡å»çš„ã€‚</p>
]]></content>
  </entry>
</search>
