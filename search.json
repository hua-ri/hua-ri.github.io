[{"title":"Kindæ­å»ºæµ‹è¯•é›†ç¾¤","url":"/2025/07/kubernetes/kind-da-jian-ce-shi-ji-qun/","content":"Kindå·¥å…·ä»‹ç»","categories":["kubernetes"],"tags":["kubernetes"]},{"title":"åŠ é€Ÿä»£ç†","url":"/2025/07/kubernetes/jia-su-dai-li/","content":"1 å‹æƒ…é“¾æ¥\né•œåƒåŠ é€Ÿï¼šhttps://github.com/DaoCloud/public-image-mirror\näºŒè¿›åˆ¶æ–‡ä»¶åŠ é€Ÿï¼šhttps://github.com/DaoCloud/public-binary-files-mirror\nHelm åŠ é€Ÿï¼šhttps://github.com/DaoCloud/public-helm-charts-mirror\n\n2 äºŒè¿›åˆ¶æ–‡ä»¶åŠ é€Ÿ2.1 ä½¿ç”¨æ–¹æ³•åœ¨åŸå§‹ URL ä¸Šé¢åŠ å…¥ files.m.daocloud.io çš„ å‰ç¼€ å°±å¯ä»¥ä½¿ç”¨ã€‚æ¯”å¦‚ï¼š\n# Helm ä¸‹è½½åŸå§‹URLwget https://get.helm.sh/helm-v3.9.1-linux-amd64.tar.gz# åŠ é€Ÿåçš„ URLwget https://files.m.daocloud.io/get.helm.sh/helm-v3.9.1-linux-amd64.tar.gz\n\n2.2 å®‰è£… Helmcd /tmpexport HELM_VERSION=&quot;v3.9.3&quot;wget &quot;https://files.m.daocloud.io/get.helm.sh/helm-$&#123;HELM_VERSION&#125;-linux-amd64.tar.gz&quot;tar -zxvf helm-$&#123;HELM_VERSION&#125;-linux-amd64.tar.gzmv linux-amd64/helm /usr/local/bin/helmhelm version\n\n2.3 å®‰è£… KINDcd /tmpexport KIND_VERSION=&quot;v0.22.0&quot;curl -Lo ./kind https://files.m.daocloud.io/github.com/kubernetes-sigs/kind/releases/download/$&#123;KIND_VERSION&#125;/kind-linux-amd64chmod +x ./kindmv ./kind /usr/bin/kindkind version\n\n2.4 å®‰è£… istiocd /tmpexport ISTIO_VERSION=&quot;1.14.3&quot;wget &quot;https://files.m.daocloud.io/github.com/istio/istio/releases/download/$&#123;ISTIO_VERSION&#125;/istio-$&#123;ISTIO_VERSION&#125;-linux-amd64.tar.gz&quot;tar -zxvf istio-$&#123;ISTIO_VERSION&#125;-linux-amd64.tar.gz# Do follow the istio docs to install istio\n\n2.5 å®‰è£… nerdctl ï¼ˆä»£æ›¿ docker å·¥å…·ï¼‰export NERDCTL_VERSION=&quot;1.7.6&quot;mkdir -p nerdctl ;cd nerdctlwget https://files.m.daocloud.io/github.com/containerd/nerdctl/releases/download/v$&#123;NERDCTL_VERSION&#125;/nerdctl-full-$&#123;NERDCTL_VERSION&#125;-linux-amd64.tar.gztar -zvxf nerdctl-full-$&#123;NERDCTL_VERSION&#125;-linux-amd64.tar.gzmkdir -p /opt/cni/bin ;cp -f libexec/cni/* /opt/cni/bin/ ;cp bin/* /usr/local/bin/ ;cp lib/systemd/system/*.service /usr/lib/systemd/system/systemctl enable containerd ;systemctl start containerd --nowsystemctl enable buildkit;systemctl start buildkit --now\n\n3 dockeré•œåƒåŠ é€Ÿ3.1 ä½¿ç”¨æ–¹æ³•å¢åŠ å‰ç¼€ (æ¨èæ–¹å¼)ã€‚æ¯”å¦‚ï¼š\n              docker.io/library/busybox                 |                 Vm.daocloud.io/docker.io/library/busybox\n\næˆ–è€… æ”¯æŒçš„é•œåƒä»“åº“ çš„ å‰ç¼€æ›¿æ¢ å°±å¯ä»¥ä½¿ç”¨ã€‚æ¯”å¦‚ï¼š\n           docker.io/library/busybox             |             Vdocker.m.daocloud.io/library/busybox\n\n3.2 é€šè¿‡ åŠ é€Ÿ å®‰è£… kubeadmkubeadm config images pull --image-repository k8s-gcr.m.daocloud.io\n\n3.3 é€šè¿‡ åŠ é€Ÿ å®‰è£… kindkind create cluster --name kind --image m.daocloud.io/docker.io/kindest/node:v1.22.1\n\n3.4 é€šè¿‡ åŠ é€Ÿ éƒ¨ç½² åº”ç”¨(è¿™é‡Œä»¥ Ingress ä¸ºä¾‹)wget -O image-filter.sh https://github.com/DaoCloud/public-image-mirror/raw/main/hack/image-filter.sh &amp;&amp; chmod +x image-filter.shwget -O deploy.yaml https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.0/deploy/static/provider/baremetal/deploy.yamlcat ./deploy.yaml | ./image-filter.sh | kubectl apply -f -\n\n3.5 Docker åŠ é€Ÿæ·»åŠ åˆ° &#x2F;etc&#x2F;docker&#x2F;daemon.json\n&#123;  &quot;registry-mirrors&quot;: [    &quot;https://docker.m.daocloud.io&quot;  ]&#125;\n\n4 helm åŠ é€Ÿhelm repo add community https://release.daocloud.io/chartrepo/community \n\n\n","categories":["kubernetes"],"tags":["kubernetes"]},{"title":"kubectlå¸¸ç”¨å‘½ä»¤","url":"/2025/07/kubernetes/kubectl-chang-yong-ming-ling/","content":"ç™»å½•å‘½ä»¤æ ¹æ®æœºå™¨ipä½¿ç”¨kubectlç™»å½•æœºå™¨(field-selector):\n#!/bin/bashexport targetIp=&quot;6.0.90.240&quot;#alias kubectl=&#x27;kubectl&#x27;alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;podinfo=`kubectl get pod --all-namespaces --field-selector=status.podIP=&quot;$targetIp&quot; -o wide | grep -v NAME | head -n 1 `ns=`echo $&#123;podinfo&#125; | awk &#x27;&#123;print $1&#125;&#x27;`pod=`echo $&#123;podinfo&#125; | awk &#x27;&#123;print $2&#125;&#x27;`echo &quot;$kubectl exec -it -n $&#123;ns&#125; $&#123;pod&#125; -- su - root&quot;kubectl exec -it -n $&#123;ns&#125; $&#123;pod&#125; -- su - root\n\næ ¹æ®æœºå™¨ipä½¿ç”¨kubectlç™»å½•æœºå™¨(label):\n#!/bin/bashexport targetIp=&quot;6.3.144.241&quot;#alias kubectl=&#x27;kubectl&#x27;alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;podinfo=`kubectl get pod --all-namespaces -l sigma.ali/ip=&quot;$targetIp&quot; -o wide | grep -v NAMESPACE`ns=`echo $&#123;podinfo&#125; | awk &#x27;&#123;print $1&#125;&#x27;`pod=`echo $&#123;podinfo&#125; | awk &#x27;&#123;print $2&#125;&#x27;`echo &quot;$kubectl exec -it -n $&#123;ns&#125; $&#123;pod&#125; -- su - root&quot;kubectl exec -it -n $&#123;ns&#125; $&#123;pod&#125; -- su - root\n\næ›´æ™ºèƒ½ç‰ˆæœ¬çš„kubectlç™»å½•å‘½ä»¤ï¼š\n\næŸ¥çœ‹KUBECONFIG_DIRç›®å½•ä¸‹æœ‰å“ªäº›kubeconfigå¯ä»¥ç”¨\næ ¡éªŒç›®æ ‡ç™»å½•çš„ipæ ¼å¼\næŸ¥è¯¢å¹¶è§£æpodä¿¡æ¯\næŸ¥è¯¢è¯¥podæœ‰å“ªäº›å®¹å™¨å¹¶å±•ç¤º\næŸ¥è¯¢é€‰å®šçš„å®¹å™¨æœ‰å“ªäº›ç”¨æˆ·(ä¸user_arrayåšäº¤é›†)ï¼Œæ”¯æŒè‡ªå®šä¹‰è¾“å…¥ç”¨æˆ·\næ ¹æ®ä»¥ä¸Šä¿¡æ¯ç™»å½•ç›®æ ‡ipå¯¹åº”podçš„é€‰å®šå®¹å™¨#!/bin/bash# æ·»åŠ ç‰¹å®šç”¨æˆ·user_array=(&quot;root&quot; &quot;admin&quot; &quot;log&quot;)# ä»æŒ‡å®šç›®å½•è·å–æ‰€æœ‰ kubeconfig æ–‡ä»¶KUBECONFIG_DIR=&quot;/Users/king/.kube&quot;# åˆå§‹åŒ– kubectl å‘½ä»¤å‰ç¼€KUBECTL_CMD=&quot;kubectl&quot;# ç¡®ä¿å°†ä¿¡æ¯æ‰“å°åˆ°ç»ˆç«¯é‡Œï¼Œå³ä½¿åœ¨å‡½æ•°ä¹‹é—´$(...)è°ƒç”¨çš„åœºæ™¯function print_to_console() &#123;    printf &quot;%s\\n&quot; &quot;$1&quot; &gt;&amp;2&#125;# æ£€æŸ¥IPåœ°å€æ˜¯å¦ç¬¦åˆæ­£ç¡®çš„æ ¼å¼function is_valid_ip() &#123;    local ip=$1    local valid_regex=&#x27;^([0-9]&#123;1,3&#125;\\.)&#123;3&#125;[0-9]&#123;1,3&#125;$&#x27;    if [[ $ip =~ $valid_regex ]]; then        # ç¡®ä¿æ¯ä¸ªæ•°å­—éƒ¨åˆ†å°äºç­‰äº255        IFS=&#x27;.&#x27; read -r -a octets &lt;&lt;&lt; &quot;$ip&quot;        for octet in &quot;$&#123;octets[@]&#125;&quot;; do            if ((octet &gt; 255)); then                return 1            fi        done        return 0    fi    return 1&#125;KUBECONFIGS=($(find $KUBECONFIG_DIR -maxdepth 1 -name &quot;*.config&quot; -print))# æ£€æŸ¥æ˜¯å¦æ‰¾åˆ° kubeconfig æ–‡ä»¶if [ $&#123;#KUBECONFIGS[@]&#125; -eq 0 ]; then    print_to_console &quot;æ²¡æœ‰æ‰¾åˆ°ä»»ä½• kubeconfig æ–‡ä»¶åœ¨ç›®å½•: $KUBECONFIG_DIR&quot;else    # æä¾›ç»™ç”¨æˆ·é€‰æ‹©çš„èœå•ï¼ŒåŠ¨æ€ç”Ÿæˆé€‰é¡¹èŒƒå›´æç¤º    cat &lt;&lt; EOF    ----------------------------------------------    |*******Please Enter Your Choice:[1-$&#123;#KUBECONFIGS[@]&#125;]*******|    ----------------------------------------------EOF    # è¾“å‡ºå¯ä¾›é€‰æ‹©çš„é…ç½®æ–‡ä»¶é€‰é¡¹    for i in &quot;$&#123;!KUBECONFIGS[@]&#125;&quot;; do        print_to_console &quot;*     $(($i + 1)) $&#123;KUBECONFIGS[$i]&#125;&quot;    done    # æ•è·ç”¨æˆ·è¾“å…¥å¹¶ç¡®ä¿åœ¨åˆæ³•èŒƒå›´å†…    while true; do        read -p &quot;please input your choice [1-$&#123;#KUBECONFIGS[@]&#125;] (or press Enter to skip): &quot; num        if [[ -z &quot;$num&quot; ]]; then            break        elif [[ &quot;$num&quot; =~ ^[0-9]+$ ]] &amp;&amp; [ &quot;$num&quot; -ge 1 ] &amp;&amp; [ &quot;$num&quot; -le $&#123;#KUBECONFIGS[@]&#125; ]; then            selected_config=&quot;$&#123;KUBECONFIGS[$((num - 1))]&#125;&quot;            KUBECTL_CMD=&quot;kubectl --kubeconfig=$selected_config&quot;            print_to_console &quot;Using configuration file: $selected_config&quot;            break        else            print_to_console &quot;Invalid choice. Please try again.&quot;        fi    donefi# è¾“å‡ºç”¨æˆ·é€‰æ‹©çš„é…ç½®æ–‡ä»¶selected_config=&quot;$&#123;KUBECONFIGS[$((num - 1))]&#125;&quot;print_to_console &quot;You selected: $selected_config&quot;# æ•è·ç”¨æˆ·è¾“å…¥çš„targetIPwhile true; do    read -p &quot;please input your target ip: &quot; targetIP    # æ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸ºç©ºå’Œæ ¼å¼æœ‰æ•ˆæ€§    if [[ -z &quot;$targetIP&quot; ]]; then        print_to_console &quot;IP åœ°å€ä¸èƒ½ä¸ºç©ºï¼Œè¯·é‡æ–°è¾“å…¥ã€‚&quot;    elif ! is_valid_ip &quot;$targetIP&quot;; then        print_to_console &quot;æ— æ•ˆçš„IPæ ¼å¼ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„IPåœ°å€ã€‚&quot;    else        print_to_console &quot;æ‚¨è¾“å…¥çš„IPåœ°å€æ˜¯: $targetIP&quot;        break    fidone# è·å– Pod ä¿¡æ¯podinfo=$($KUBECTL_CMD get pod --all-namespaces --field-selector=status.podIP=&quot;$targetIP&quot; -o wide | grep -v NAME | head -n 1)# æ£€æŸ¥ podinfo æ˜¯å¦ä¸ºç©ºif [[ -z &quot;$podinfo&quot; ]]; then    print_to_console &quot;æœªèƒ½è·å–åˆ°å¯¹åº” IP çš„ Pod ä¿¡æ¯ï¼Œé€€å‡ºè„šæœ¬ã€‚&quot;    exit 1fi# æå–å‘½åç©ºé—´å’Œ Pod åç§°ns=$(echo &quot;$&#123;podinfo&#125;&quot; | awk &#x27;&#123;print $1&#125;&#x27;)pod=$(echo &quot;$&#123;podinfo&#125;&quot; | awk &#x27;&#123;print $2&#125;&#x27;)# æ£€æŸ¥ ns å’Œ pod æ˜¯å¦ä¸ºç©ºif [[ -z &quot;$ns&quot; || -z &quot;$pod&quot; ]]; then    print_to_console &quot;æœªèƒ½æå–åˆ°å‘½åç©ºé—´æˆ– Pod åç§°ï¼Œé€€å‡ºè„šæœ¬ã€‚&quot;    exit 1fiprint_to_console &quot;Namespace: $ns, Pod: $pod&quot;# è·å–å®¹å™¨åˆ—è¡¨containers=($($KUBECTL_CMD get pod $pod -n $ns -o jsonpath=&#x27;&#123;.spec.containers[*].name&#125;&#x27;))selected_container=&quot;&quot;if [ $&#123;#containers[@]&#125; -gt 0 ]; then    print_to_console &quot;è¯·é€‰æ‹©ä¸€ä¸ªå®¹å™¨ (æˆ–ç›´æ¥æŒ‰ Enter è·³è¿‡ä½¿ç”¨é»˜è®¤å®¹å™¨):&quot;    for i in &quot;$&#123;!containers[@]&#125;&quot;; do        print_to_console &quot;*      $(($i + 1)) $&#123;containers[$i]&#125;&quot;    done    while true; do        read -p &quot;please input your choice [1-$&#123;#containers[@]&#125;] (or press Enter to skip): &quot; container_num        if [[ -z &quot;$container_num&quot; ]]; then            break        elif [[ &quot;$container_num&quot; =~ ^[0-9]+$ ]] &amp;&amp; [ &quot;$container_num&quot; -ge 1 ] &amp;&amp; [ &quot;$container_num&quot; -le $&#123;#containers[@]&#125; ]; then            selected_container=&quot;$&#123;containers[$((container_num - 1))]&#125;&quot;            print_to_console &quot;Selected container: $selected_container&quot;            break        else            print_to_console &quot;Invalid choice. Please try again.&quot;        fi    donefi# è§£æå®¹å™¨ä¸­çš„ç”¨æˆ·å¹¶æ·»åŠ åˆ°ç”¨æˆ·æ•°ç»„ä¸­while IFS=: read -r username _ uid _; do    if [[ $uid -ge 1000 &amp;&amp; $username != &quot;nobody&quot; ]]; then        user_array+=(&quot;$username&quot;)    fidone &lt;&lt;&lt; &quot;$user_list&quot;# æ˜¾ç¤ºå¯ä¾›é€‰æ‹©çš„ç”¨æˆ·åˆ—è¡¨print_to_console &quot;è¯·é€‰æ‹©ä¸€ä¸ªç”¨æˆ· (æˆ–è‡ªå®šä¹‰è¾“å…¥):&quot;for i in &quot;$&#123;!user_array[@]&#125;&quot;; do    print_to_console &quot;*      $(($i + 1)) $&#123;user_array[$i]&#125;&quot;doneprint_to_console &quot;*      $(( $&#123;#user_array[@]&#125; + 1 )) è‡ªå®šä¹‰è¾“å…¥ &quot;# æ•è·ç”¨æˆ·é€‰æ‹©çš„ç”¨æˆ·while true; do    read -p &quot;please input your choice [1-$(( $&#123;#user_array[@]&#125; + 1 ))]: &quot; user_num    if [[ &quot;$user_num&quot; =~ ^[0-9]+$ ]] &amp;&amp; [ &quot;$user_num&quot; -ge 1 ] &amp;&amp; [ &quot;$user_num&quot; -le $(( $&#123;#user_array[@]&#125; + 1 )) ]; then        if [ &quot;$user_num&quot; -eq $(( $&#123;#user_array[@]&#125; + 1 )) ]; then            read -p &quot;è¯·è¾“å…¥è‡ªå®šä¹‰ç”¨æˆ·å: &quot; targetUser        else            targetUser=&quot;$&#123;user_array[$((user_num - 1))]&#125;&quot;        fi        print_to_console &quot;Selected user: $targetUser&quot;        break    else        print_to_console &quot;Invalid choice. Please try again.&quot;    fidone# æ‰§è¡Œå‘½ä»¤if [[ -n &quot;$selected_container&quot; ]]; then    print_to_console &quot;$KUBECTL_CMD exec -it -n $&#123;ns&#125; $&#123;pod&#125; -c $&#123;selected_container&#125; -- su - $targetUser&quot;    $KUBECTL_CMD exec -it -n $&#123;ns&#125; $&#123;pod&#125; -c $&#123;selected_container&#125; -- su - $targetUserelse    print_to_console &quot;$KUBECTL_CMD exec -it -n $&#123;ns&#125; $&#123;pod&#125; -- su - $targetUser&quot;    $KUBECTL_CMD exec -it -n $&#123;ns&#125; $&#123;pod&#125; -- su - $targetUserfi\n\næŸ¥è¯¢å‘½ä»¤æ ¹æ®æœºå™¨ip(field-selector)æŸ¥è¯¢pod:\n#!/bin/bashexport fieldKEY=&quot;status.podIP&quot;export fieldVALUE=&quot;6.0.90.240&quot;#alias kubectl=&#x27;kubectl&#x27;alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;kubectl get pod --all-namespaces --field-selector=$fieldKEY=$fieldVALUE -o wide\n\næ ¹æ®labelæŸ¥è¯¢pod:\n#!/bin/bashexport labelKEY=&quot;sigma.ali/ip&quot;export labelVALUE=&quot;6.0.90.240&quot;#alias kubectl=&#x27;kubectl&#x27;alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;kubectl get pod --all-namespaces -l $labelKEY=$labelVALUE -o wide\n\nå¯¼å‡ºyamlæ ¹æ®æœºå™¨ipä½¿ç”¨kubectlå¯¼å‡ºæœºå™¨yaml:\n#!/bin/bashlocal podName=&quot;&quot;local namespace=&quot;&quot;#alias kubectl=&#x27;kubectl&#x27;alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;kubectl get pod/$podName -n $&#123;namespace&#125; -oyaml\n\ndescribeæ ¹æ®namespaceå’ŒpodNameè¿›è¡Œdescribe\nlocal namespace=&quot;longtermbase&quot;local podName=&quot;inplaceset-antcodebuild-tn1oimjfl-gz00b-0&quot;#alias kubectl=&#x27;kubectl&#x27;alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;kubectl describe pod $podName -n $namespace\n\næ¸…ç†terminatingçš„podé€šè¿‡æ¸…ç†finalizerså®ç°\nlocal namespace=&quot;&quot;local podName=&quot;&quot;#alias kubectl=&#x27;kubectl&#x27;alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;kubectl patch pod/$podName -n $namespace -p &#x27;&#123;&quot;metadata&quot;:&#123;&quot;finalizers&quot;:null&#125;&#125;&#x27;\n\nå¼ºåˆ¶åˆ é™¤\nlocal namespace=&quot;&quot;local podName=&quot;&quot;#alias kubectl=&#x27;kubectl&#x27;alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;k delete pod/$podName -n $namespace --force --grace-period=0\n\nå¤åˆ¶æ–‡ä»¶åˆ°podå®¹å™¨local namespace=&quot;&quot;local podName=&quot;&quot;local sourceDir=&quot;&quot;local sourceFile=&quot;&quot;local targetDir=&quot;&quot;local targetFile=&quot;&quot;#alias kubectl=&#x27;kubectl&#x27;alias kubectl=&#x27;kubectl --kubeconfig=/Users/king/.kube/sa128.config&#x27;kubectl cp -n linkw $sourceDir/$sourceFile $podName:/targetDir/targetFile","categories":["kubernetes"],"tags":["kubernetes"]},{"title":"é›†ç¾¤æ¥å…¥dashboard","url":"/2025/07/kubernetes/ji-qun-jie-ru-dashboard/","content":"1 Kubernets Dashboardå®‰è£…ä¸‹è½½kubernetes-dashboardçš„yaml:\nwget https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml -O dashboard.yaml\n\nåœ¨å®˜æ–¹yamlé‡Œï¼Œæˆ‘ä»¬éœ€è¦å°†é•œåƒä¿®æ”¹ä¸€ä¸‹ï¼Œä¸ç„¶ä¼šé‡è§ImagePullBackOffçš„é”™è¯¯ï¼š\n\nkubernetesui&#x2F;dashboard:v2.7.0\nkubernetesui&#x2F;metrics-scraper:v1.0.8\nå¤‡æ³¨ï¼šç‰ˆæœ¬å¯èƒ½ä¸åŒï¼Œè®¤å‡†é•œåƒå\n\nå°†ä»¥ä¸Šé•œåƒä¿®æ”¹ä¸ºå¯ç”¨çš„ï¼š\n\nm.daocloud.io&#x2F;docker.io&#x2F;kubernetesui&#x2F;dashboard:v2.7.0\nm.daocloud.io&#x2F;docker.io&#x2F;kubernetesui&#x2F;metrics-scraper:v1.0.8\n\nå®‰è£…dashboardï¼š\nkubectl apply -f ./dashboard.yaml\n\néªŒè¯æ“ä½œç•Œé¢å·²ç»éƒ¨ç½²å¹¶ä¸”æ­£åœ¨è¿è¡Œ:\nsudo kubectl get pod -n kubernetes-dashboardNAME                                         READY   STATUS    RESTARTS   AGEdashboard-metrics-scraper-864c58f57b-fjlfs   1/1     Running   0          98skubernetes-dashboard-58db7bd7d4-pdh76        1/1     Running   0          98s\n\nåˆ›å»º ServiceAccount å’Œ ClusterRoleBinding ä»¥æä¾›å¯¹æ–°åˆ›å»ºçš„é›†ç¾¤çš„ç®¡ç†æƒé™è®¿é—®:\nkubectl create serviceaccount -n kubernetes-dashboard admin-userkubectl create clusterrolebinding -n kubernetes-dashboard admin-user --clusterrole cluster-admin --serviceaccount=kubernetes-dashboard:admin-user\n\néœ€è¦ç”¨ Bearer Token æ¥ç™»å½•åˆ°æ“ä½œç•Œé¢ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°† token ä¿å­˜åˆ°å˜é‡:\nsudo kubectl -n kubernetes-dashboard create token admin-usereyJhbGciOiJSUzI1NiIsImtpZCI6InF3b1ZJN0ZVSWUyRkF4blgxVG42d2hVMm0wTGtoSTg3VkVoai1yRTdMN3MifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzI3OTc0NzYyLCJpYXQiOjE3Mjc5NzExNjIsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiZTI2YjE1NjctYjk5YS00ZGRlLTlmMWUtYTIwYmUzZDAwZGJiIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiNWMxYjMyMmUtNDFmNS00ODcxLTkxNjQtZTYzOTk2NzkxZDM4In19LCJuYmYiOjE3Mjc5NzExNjIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.d-b12OQrq_9BnmWz5g-_2nvRS-ktEhg813N8zb-kWBh5GScUHhuiAej2v1p1kt54Xom1H6DaeyvlmL3G8ub7aKgZwJjOyJBFDnt0B04Ysz-KSj788jR_Yg2d1FhTbgk8-pBdV9qSweBVT6GRyQ53NIsTIc5ArDsvfOg66nEiW9rp5-3XLitKpoSLtp_Dpib1VpOR_1XAV8wRNVc9psxOp3vtALs1_jI0Izo_4qOX17OZ9FnxgkeeKglRFynlgGiQ0g2KG74oYQn0b_sUROvb52cdDJ2RDhk4yao2vjMyg19f_x1gK-xM8O7kgfYkA8gXEzguRMl0OEbWP_UgH0RQqA\n\nä½¿ç”¨ kubectl å‘½ä»¤è¡Œå·¥å…·è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥è®¿é—®æ“ä½œç•Œé¢ï¼š\nkubectl proxy\n\nè¿›å…¥dashboardï¼š\nhttp://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/\n\n\nè¿™é‡Œæ˜¯ç”¨kubectl proxyèµ·äº†ä¸€ä¸ªä»£ç†ï¼Œå®ç°åœ¨é›†ç¾¤å¤–è®¿é—®é›†ç¾¤å†…çš„dashboard\n","categories":["kubernetes"],"tags":["kubernetes"]},{"title":"Ollamaéƒ¨ç½²qwen25:7b","url":"/2025/08/llm/ollama/ollama-bu-shu-qwen25-7b/","content":"Ollama ç®€ä»‹Ollama æ˜¯ä¸€ä¸ªæœ¬åœ°è¿è¡Œçš„å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å·¥å…·å¹³å°ï¼Œå…è®¸ç”¨æˆ·åœ¨æœ¬åœ°è®¾å¤‡ä¸Šè¿è¡Œå’Œç®¡ç†å¤§æ¨¡å‹ï¼Œè€Œæ— éœ€ä¾èµ–äº‘æœåŠ¡ã€‚å®ƒæ”¯æŒå¤šç§å¼€æºæ¨¡å‹ï¼Œå¹¶æä¾›äº†ç”¨æˆ·å‹å¥½çš„æ¥å£ï¼Œéå¸¸é€‚åˆå¼€å‘è€…å’Œä¼ä¸šä½¿ç”¨ã€‚\nå®‰è£… Ollamaé¦–å…ˆï¼Œä» Ollama å®˜ç½‘ ä¸‹è½½å®‰è£…åŒ…ï¼Œå¹¶æŒ‰ç…§æç¤ºå®Œæˆå®‰è£…ã€‚\nOllama å‘½ä»¤ä»‹ç»Ollama æä¾›äº†å‡ ä¸ªç®€å•æ˜“ç”¨çš„å‘½ä»¤ï¼ŒåŸºæœ¬åŠŸèƒ½å¦‚ä¸‹ï¼š\nUsage:  ollama [flags]  ollama [command]Available Commands:  serve       å¯åŠ¨ Ollama æœåŠ¡  create      ä» Modelfile åˆ›å»ºä¸€ä¸ªæ¨¡å‹  show        æŸ¥çœ‹æ¨¡å‹è¯¦ç»†ä¿¡æ¯  run         è¿è¡Œä¸€ä¸ªæ¨¡å‹  stop        åœæ­¢æ­£åœ¨è¿è¡Œçš„æ¨¡å‹  pull        ä»æ³¨å†Œè¡¨æ‹‰å–ä¸€ä¸ªæ¨¡å‹  push        å°†ä¸€ä¸ªæ¨¡å‹æ¨é€åˆ°æ³¨å†Œè¡¨  list        åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æ¨¡å‹  ps          åˆ—å‡ºå½“å‰æ­£åœ¨è¿è¡Œçš„æ¨¡å‹  cp          å¤åˆ¶ä¸€ä¸ªæ¨¡å‹  rm          åˆ é™¤ä¸€ä¸ªæ¨¡å‹  help        è·å–å…³äºä»»ä½•å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯Flags:  -h, --help      help for ollama  -v, --version   Show version information\n\nä¸‹è½½å¤§æ¨¡å‹åœ¨ Ollama å®˜ç½‘çš„ Models é¡µé¢ ä¸­ï¼Œå¯ä»¥æ‰¾åˆ° Ollama æ”¯æŒçš„å¤§æ¨¡å‹åˆ—è¡¨ã€‚\nå¦‚æœæ²¡æœ‰æ˜ç¡®çš„æ¨¡å‹é€‰æ‹©ï¼Œå»ºè®®ä½¿ç”¨é˜¿é‡Œçš„ qwen2.5:7b æˆ– Meta çš„ llama3.1:8bã€‚7b ä»¥ä¸Šçš„å¤§æ¨¡å‹é€šå¸¸èƒ½æä¾›æ›´å¥½çš„å¯¹è¯æ•ˆæœã€‚\næŸ¥çœ‹æ¨¡å‹ä¿¡æ¯é€‰æ‹©ä¸€ä¸ªæ¨¡å‹åï¼Œç‚¹å‡»è¿›å…¥å¯ä»¥æŸ¥çœ‹æ¨¡å‹çš„è¯¦ç»†ä¿¡æ¯ã€‚\nä¸‹è½½æ¨¡å‹ä½¿ç”¨ ollama run å‘½ä»¤å¯ä»¥åœ¨æ‹‰å–æ¨¡å‹åç›´æ¥è¿›å…¥äº¤äº’çª—å£ã€‚å¦‚æœåªæƒ³ä¸‹è½½æ¨¡å‹è€Œä¸è¿›å…¥äº¤äº’ç•Œé¢ï¼Œå¯ä»¥ä½¿ç”¨ ollama pull å‘½ä»¤ã€‚\nollama run qwen2.5:7b\n\nç­‰å¾…æ¨¡å‹ä¸‹è½½å®Œæˆåï¼Œä¼šç›´æ¥è¿›å…¥äº¤äº’ç•Œé¢ã€‚\nåœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥æ¶ˆæ¯ï¼Œå³å¯ä¸æ¨¡å‹è¿›è¡Œäº¤äº’ã€‚\näº¤äº’çª—å£å‘½ä»¤åœ¨äº¤äº’çª—å£ä¸­è¾“å…¥ &#x2F;? å¯ä»¥æŸ¥çœ‹å¯ç”¨å‘½ä»¤ã€‚\nAvailable Commands:  /set            Set session variables  /show           Show model information  /load &lt;model&gt;   Load a session or model  /save &lt;model&gt;   Save your current session  /clear          Clear session context  /bye            Exit  /?, /help       Help for a command  /? shortcuts    Help for keyboard shortcutsUse &quot;&quot;&quot; to begin a multi-line message.\n\nä¾‹å¦‚ï¼Œä½¿ç”¨ /show å‘½ä»¤æŸ¥çœ‹æ¨¡å‹ä¿¡æ¯ï¼š\nè°ƒç”¨ Ollama æ¥å£Ollama æä¾›äº†ä¸°å¯Œçš„ API æ¥å£ï¼Œä¾›å¤–éƒ¨è°ƒç”¨è®¿é—®ã€‚è¯¦ç»†çš„ æ¥å£æ–‡æ¡£ å¯ä»¥åœ¨å®˜æ–¹ GitHub ä¸­æ‰¾åˆ°ã€‚\n\n\n\næ¥å£åç§°\næ¥å£åœ°å€\nè¯·æ±‚æ–¹æ³•\næ¥å£æè¿°\n\n\n\nGenerate\n&#x2F;api&#x2F;generate\nPOST\nä½¿ç”¨æä¾›çš„æ¨¡å‹ä¸ºç»™å®šæç¤ºç”Ÿæˆå“åº”ã€‚\n\n\nChat\n&#x2F;api&#x2F;chat\nPOST\nä½¿ç”¨æä¾›çš„æ¨¡å‹ç”ŸæˆèŠå¤©ä¸­çš„ä¸‹ä¸€æ¡æ¶ˆæ¯\n\n\nCreate\n&#x2F;api&#x2F;create\nPOST\nä» Modelfile åˆ›å»ºä¸€ä¸ªæ–°çš„æ¨¡å‹ã€‚\n\n\nTags\n&#x2F;api&#x2F;tags\nGET\nåˆ—å‡ºæœ¬åœ°å¯æä¾›çš„å‹å·ã€‚\n\n\nShow\n&#x2F;api&#x2F;show\nPOST\nè·å–æŒ‡å®šæ¨¡å‹çš„è¯¦ç»†ä¿¡æ¯ã€‚\n\n\nCopy\n&#x2F;api&#x2F;copy\nPOST\nä»ç°æœ‰æ¨¡å‹åˆ›å»ºå‰¯æœ¬ã€‚\n\n\nDelete\n&#x2F;api&#x2F;delete\nDELETE\nåˆ é™¤æ¨¡å‹åŠå…¶æ•°æ®ã€‚\n\n\nPull\n&#x2F;api&#x2F;pull\nPOST\nä» Ollama åº“ä¸­ä¸‹è½½æŒ‡å®šæ¨¡å‹ã€‚\n\n\nPush\n&#x2F;api&#x2F;push\nPOST\nå°†æ¨¡å‹ä¸Šä¼ åˆ°æ¨¡å‹åº“ã€‚\n\n\nEmbed\n&#x2F;api&#x2F;embed\nPOST\nä½¿ç”¨æŒ‡å®šæ¨¡å‹ç”ŸæˆåµŒå…¥ã€‚\n\n\nListRunning\n&#x2F;api&#x2F;ps\nPOST\nåˆ—å‡ºå½“å‰åŠ è½½åˆ°å†…å­˜ä¸­çš„æ¨¡å‹ã€‚\n\n\nEmbeddings\n&#x2F;api&#x2F;embeddings\nPOST\nç”ŸæˆåµŒå…¥ï¼ˆä¸ Embed ç±»ä¼¼ï¼Œä½†å¯èƒ½é€‚ç”¨åœºæ™¯ä¸åŒï¼‰ã€‚\n\n\nVersion\n&#x2F;api&#x2F;version\nGET\nè·å– Ollama æœåŠ¡çš„ç‰ˆæœ¬å·ã€‚\n\n\næ£€æŸ¥æœåŠ¡å®‰è£… Ollama åï¼ŒæœåŠ¡é€šå¸¸ä¼šè‡ªåŠ¨å¯åŠ¨ã€‚ä¸ºäº†ç¡®ä¿æœåŠ¡æ­£å¸¸è¿è¡Œï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ï¼šOllama é»˜è®¤ç«¯å£ä¸º 11434ï¼Œè®¿é—®åœ°å€ä¸º 127.0.0.1:11434ã€‚\ncurl http://127.0.0.1:11434\n\n\nå¦‚æœæœåŠ¡æœªå¯åŠ¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ï¼š\nollama serve\n\nè°ƒç”¨æ¨¡å‹åˆ—è¡¨æ¥å£é¦–å…ˆï¼Œè°ƒç”¨ä¸€ä¸ªç®€å•çš„æ¥å£æ¥æŸ¥è¯¢æ¨¡å‹åˆ—è¡¨ï¼š\ncurl http://localhost:11434/api/tags\n\nè°ƒç”¨ç”Ÿæˆæ¥å£æ¥ä¸‹æ¥ï¼Œè°ƒç”¨ç”Ÿæˆæ¥å£æ¥è·å–æ¨¡å‹çš„å“åº”ï¼š\ncurl http://localhost:11434/api/generate -d &#x27;&#123;  &quot;model&quot;: &quot;qwen2.5:7b&quot;,  &quot;prompt&quot;: &quot;å¤©ç©ºä¸ºä»€ä¹ˆæ˜¯è“è‰²çš„?&quot;&#125;&#x27;\n\né»˜è®¤æƒ…å†µä¸‹ï¼Œæ¥å£ä¼šè¿”å›æµå¼æ•°æ®ï¼š\nå¯ä»¥é€šè¿‡è®¾ç½® stream: false å‚æ•°ï¼Œç›´æ¥è¿”å›å®Œæ•´å†…å®¹ï¼š\ncurl http://localhost:11434/api/generate -d &#x27;&#123;  &quot;model&quot;: &quot;qwen2.5:7b&quot;,  &quot;prompt&quot;: &quot;å¤©ç©ºä¸ºä»€ä¹ˆæ˜¯è“è‰²çš„?&quot;,  &quot;stream&quot;: false&#125;&#x27;\n\nä½¿ç”¨APIè¿œç¨‹è°ƒç”¨æ³¨æ„ï¼Œollamaå¯åŠ¨æ—¶é»˜è®¤ç›‘å¬åœ¨127.0.0.1:11434ä¸Šï¼Œå¯ä»¥é€šè¿‡é…ç½®OLLAMA_HOSTç¯å¢ƒå˜é‡ä¿®æ”¹\nexport OLLAMA_HOST=&quot;0.0.0.0:11434&quot; ollama serve&amp;   ollama run qwen2.5:7b\n\nç„¶åå¯ä»¥å¦‚ä¸Šé¢è°ƒç”¨ç”Ÿæˆæ¥å£ä¸€æ ·è¿›è¡Œè¿œç«¯è®¿é—®äº†ï¼š\ncurl http://localhost:11434/api/generate -d &#x27;&#123;&quot;model&quot;: &quot;qwen2.5:7b&quot;,&quot;prompt&quot;: &quot;what can you do?&quot;,&quot;stream&quot;:false&#125;&#x27;curl http://localhost:11434/api/generate -d &#x27;&#123;  &quot;model&quot;: &quot;qwen2.5:7b&quot;,  &quot;prompt&quot;: &quot;Why is the sky blue?&quot;,  &quot;stream&quot;: false,  &quot;options&quot;: &#123;    &quot;num_keep&quot;: 5,    &quot;seed&quot;: 42,    &quot;num_predict&quot;: 100,    &quot;top_k&quot;: 20,    &quot;top_p&quot;: 0.9,    &quot;tfs_z&quot;: 0.5,    &quot;typical_p&quot;: 0.7,    &quot;repeat_last_n&quot;: 33,    &quot;temperature&quot;: 0.8,    &quot;repeat_penalty&quot;: 1.2,    &quot;presence_penalty&quot;: 1.5,    &quot;frequency_penalty&quot;: 1.0,    &quot;mirostat&quot;: 1,    &quot;mirostat_tau&quot;: 0.8,    &quot;mirostat_eta&quot;: 0.6,    &quot;penalize_newline&quot;: true,    &quot;stop&quot;: [&quot;\\n&quot;, &quot;user:&quot;],    &quot;numa&quot;: false,    &quot;num_ctx&quot;: 1024,    &quot;num_batch&quot;: 2,    &quot;num_gqa&quot;: 1,    &quot;num_gpu&quot;: 1,    &quot;main_gpu&quot;: 0,    &quot;low_vram&quot;: false,    &quot;f16_kv&quot;: true,    &quot;vocab_only&quot;: false,    &quot;use_mmap&quot;: true,    &quot;use_mlock&quot;: false,    &quot;rope_frequency_base&quot;: 1.1,    &quot;rope_frequency_scale&quot;: 0.8,    &quot;num_thread&quot;: 8  &#125;&#125;&#x27;\n\né‡ç‚¹æ¥äº†ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é€šè¿‡openaiä»£ç æ¥å£è®¿é—®:\nfrom openai import OpenAIclient = OpenAI(    base_url=&#x27;http://localhost:11434/v1/&#x27;,    api_key=&#x27;ollama&#x27;,  # required but ignored)chat_completion = client.chat.completions.create(    messages=[        &#123;            &quot;role&quot;: &quot;system&quot;,            &quot;content&quot;: &quot;ä½ æ˜¯ä¸€ä¸ªèƒ½å¤Ÿç†è§£ä¸­è‹±æ–‡æŒ‡ä»¤å¹¶å¸®åŠ©å®Œæˆä»»åŠ¡çš„æ™ºèƒ½åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·çš„éœ€æ±‚ç”Ÿæˆåˆé€‚çš„åˆ†ç±»ä»»åŠ¡æˆ–ç”Ÿæˆä»»åŠ¡ï¼Œå¹¶å‡†ç¡®åˆ¤æ–­è¿™äº›ä»»åŠ¡çš„ç±»å‹ã€‚è¯·ç¡®ä¿ä½ çš„å›ç­”ç®€æ´ã€å‡†ç¡®ä¸”ç¬¦åˆä¸­è‹±æ–‡è¯­å¢ƒã€‚&quot;,        &#125;,        &#123;            &quot;role&quot;: &quot;user&quot;,            &quot;content&quot;: &quot;Come up with a series of tasks:1. Link all the entities in the sentence (highlighted in brackets) to a Wikipedia page.For each entity, you should output the Wikipedia page title, or output None if you know.&quot;,        &#125;    ],    model=&#x27;qwen2.5:7b&#x27;,    max_tokens=38192,    temperature=0.7,    top_p=0.5,    frequency_penalty=0,    presence_penalty=2,)print(chat_completion)\n\nç»“æœï¼š\nChatCompletion(id=&#x27;chatcmpl-228&#x27;, choices=[Choice(finish_reason=&#x27;stop&#x27;, index=0, logprobs=None, message=ChatCompletionMessage(content=&#x27;Task 1:\\nSentence: Apple (the technology company), founded by Steve Jobs and located in Cupertino.\\nOutput format for Task 1: \\n- Entity &quot;Apple&quot; is linked to [Wikipedia page title]: Apple Inc.\\n- Entity &quot;Steve Jobs&quot; is linked to [None] as the task only requires linking entities, not individuals.\\n\\nTask 2:\\nSentence: The Eiffel Tower (a famous landmark in Paris) was designed by Gustave Eiffel and completed in 1889.\\nOutput format for Task 2:\\n- Entity &quot;Eiffel Tower&quot; is linked to [Wikipedia page title]: Eiffel Tower\\n- Entity &quot;Gustave Eiffel&quot; is linked to [None]\\n\\nTask 3: \\nSentence: The Great Barrier Reef (the largest coral reef system in the world) spans over 2,000 kilometers.\\nOutput format for Task 3:\\n- Entity &quot;Great Barrier Reef&quot; is linked to [Wikipedia page title]: Great Barrier Reef\\n\\nNote that some entities might not have a corresponding Wikipedia article or may be ambiguous. In such cases, you should output None as instructed in the task description.\\n\\nThese tasks are of classification type since they require linking named entities to their respective Wikipedia pages (or determining if there is no suitable link).&#x27;, refusal=None, role=&#x27;assistant&#x27;, annotations=None, audio=None, function_call=None, tool_calls=None))], created=1753247977, model=&#x27;qwen2.5:7b&#x27;, object=&#x27;chat.completion&#x27;, service_tier=None, system_fingerprint=&#x27;fp_ollama&#x27;, usage=CompletionUsage(completion_tokens=266, prompt_tokens=109, total_tokens=375, completion_tokens_details=None, prompt_tokens_details=None))\n\nåœ¨gops-agenté‡Œæµ‹è¯•æ¨¡å‹ä¿¡æ¯ï¼š\nLLM_API_KEY= &quot;sk-ollama&quot;LLM_MODEL_NAME= &quot;qwen2.5:7b&quot;LLM_BASE_URL= &quot;http://localhost:11434/v1&quot;LLM_TEMPERATURE = 0LLM_MAX_TOKENS = 512\n\nåˆå§‹åŒ–ï¼š\n# å…¨å±€ LLM å®ä¾‹llm = ChatOpenAI(    model=settings.llm_model_name,    api_key=settings.llm_api_key,    base_url=settings.llm_base_url,    temperature=settings.llm_temperature,    max_tokens=settings.llm_max_tokens,)\n\næµ‹è¯•ç»“æœï¼š\n[default]&gt; ä¸Šæµ·å¤©æ°”æ€ä¹ˆæ ·ï¼Œå¦‚æœè¿˜ä¸é”™çš„è¯ï¼Œå¸®æˆ‘è®¡ç®—ä¸‹50ä¹˜4åŠ 6- å­ä»»åŠ¡1ï¼šæŸ¥è¯¢ä¸Šæµ·å¤©æ°” â†’ è°ƒç”¨ get_weather å·¥å…· âœ”ï¸- å­ä»»åŠ¡2ï¼šåˆ¤æ–­å¤©æ°”å¥½åï¼ˆLLM å¸¸è¯†åˆ¤æ–­ï¼‰â†’ æ™´å¤©è§†ä¸ºâ€œä¸é”™â€ âœ”ï¸- å­ä»»åŠ¡3ï¼šè®¡ç®— 50Ã—4+6 â†’ è°ƒç”¨ calculator âœ”ï¸ä¸Šæµ·å¤©æ°”é˜³å…‰æ˜åªšï¼Œæ™´ç©ºä¸‡é‡Œã€‚æ¥ä¸‹æ¥è¿›è¡Œè®¡ç®—ã€‚è®¡ç®—ç»“æœä¸º 206ã€‚- å­ä»»åŠ¡1ï¼šæŸ¥è¯¢ä¸Šæµ·å¤©æ°” â†’ è°ƒç”¨ get_weather å·¥å…· âœ”ï¸- å­ä»»åŠ¡2ï¼šåˆ¤æ–­å¤©æ°”å¥½åï¼ˆLLM å¸¸è¯†åˆ¤æ–­ï¼‰â†’ æ™´å¤©è§†ä¸ºâ€œä¸é”™â€ âœ”ï¸- å­ä»»åŠ¡3ï¼šè®¡ç®— 50Ã—4+6 â†’ è°ƒç”¨ calculator âœ”ï¸ä¸Šæµ·å¤©æ°”é˜³å…‰æ˜åªšï¼Œæ™´ç©ºä¸‡é‡Œã€‚æ¥ä¸‹æ¥è¿›è¡Œè®¡ç®—ã€‚è®¡ç®—ç»“æœä¸º 206ã€‚\n","categories":["llm/ollama"],"tags":["llm","ollama"]},{"title":"BK-CIæ’ä»¶å¼€å‘æŒ‡å¼•","url":"/2025/07/devops/blueking/bk-ci-cha-jian-kai-fa-zhi-yin/","content":"å†™åœ¨å‰é¢\nå¼€å‘æ’ä»¶å‰ï¼Œå…ˆè¿›å…¥æ’ä»¶å·¥ä½œå°åˆå§‹åŒ–ä¸€ä¸ªæ’ä»¶ï¼Œç¡®å®šæ’ä»¶åœ¨å¹³å°ä¸­çš„å”¯ä¸€æ ‡è¯†\n\nå·¥ä½œå°å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œæ–°å¢&#x2F;å‘å¸ƒ&#x2F;ä¸‹æ¶ç­‰ç®¡ç†æ’ä»¶çš„æ“ä½œ\nåŠŸèƒ½åŒºä»‹ç»\n\nåˆ‡æ¢èµ„æºç±»å‹\næ–°å¢æ’ä»¶\nå•ä¸ªæ’ä»¶çš„ç®¡ç†å…¥å£\nå‡çº§ã€ä¸‹æ¶ã€åˆ é™¤æ’ä»¶å¿«æ·å…¥å£\næŒ‡å¼•æ–‡æ¡£å’Œæ’ä»¶ UI è°ƒè¯•å·¥å…·å…¥å£\n\næ–°å¢æ’ä»¶\n\næ ‡è¯†\n\n\næ’ä»¶åœ¨å¹³å°ä¸­çš„å”¯ä¸€æ ‡è¯†ï¼Œå»ºè®®å–å’Œæ’ä»¶åŠŸèƒ½ç›¸å…³çš„å¯è¯»æ€§å¥½çš„è‹±æ–‡æ ‡è¯†\n\n\nè°ƒè¯•é¡¹ç›®\n\n\næ’ä»¶å‘å¸ƒè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥åœ¨è°ƒè¯•é¡¹ç›®ä¸‹å°†æ’ä»¶æ·»åŠ åˆ°æµæ°´çº¿æ‰§è¡Œï¼Œå¯¹æ’ä»¶è¿›è¡Œæµ‹è¯•ï¼Œä¿è¯æ’ä»¶åŠŸèƒ½æ»¡è¶³é¢„æœŸã€‚\nå»ºè®®æ–°å¢ä¸“ç”¨çš„æ’ä»¶è°ƒè¯•é¡¹ç›®ï¼Œé¿å…æµ‹è¯•è¿‡ç¨‹ä¸­å½±å“åˆ°ä¸šåŠ¡ã€‚\n\n\nå¼€å‘è¯­è¨€\n\n\næ”¯æŒå››ç§è¯­è¨€å¼€å‘æ’ä»¶ï¼š\nJavaï¼ˆæ¨èï¼‰\nPython\nGolang\nNodejs\n\n\n\nå¼€å‘æ’ä»¶\nåˆå§‹åŒ–å¥½æ’ä»¶ä¹‹åï¼Œå¯ä»¥å¼€å§‹å¼€å‘æ’ä»¶\n\n\næ ¹æ®å¼€å‘è¯­è¨€å‚è€ƒå¯¹åº”çš„å¼€å‘æŒ‡å¼•\nJava æ’ä»¶å¼€å‘æŒ‡å¼•\nPython æ’ä»¶å¼€å‘æŒ‡å¼•\nGolang æ’ä»¶å¼€å‘æŒ‡å¼•\nNodejs æ’ä»¶å¼€å‘æŒ‡å¼•\n\n\n\næ’ä»¶ç§æœ‰é…ç½®\næ’ä»¶çº§åˆ«çš„æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚ tokenã€ç”¨æˆ·åå¯†ç ã€IPã€åŸŸåç­‰ï¼Œä¸å»ºè®®ç›´æ¥æäº¤åˆ°ä»£ç åº“ï¼Œé€šè¿‡å·¥ä½œå°ç§æœ‰é…ç½®ç•Œé¢ç®¡ç†\n\n\nGolang æ’ä»¶å¼€å‘æ’ä»¶å¼€å‘æ¡†æ¶è¯´æ˜\næ’ä»¶æœ€ç»ˆæ‰“åŒ…æˆä¸€ä¸ªå‘½ä»¤è¡Œå¯æ‰§è¡Œçš„å‘½ä»¤å³å¯ï¼Œå¯¹å¼€å‘æ¡†æ¶æ— ç¡¬æ€§è¦æ±‚ ä¸‹è¾¹ä»¥ demo æ’ä»¶ä¸ºä¾‹ç¤ºèŒƒ\n\nç¤ºä¾‹æ’ä»¶ä»£ç å·¥ç¨‹çš„æ•´ä½“ç»“æ„å¦‚ä¸‹|- &lt;ä½ çš„æ’ä»¶æ ‡è¯†&gt;    |- cmd        |- application            |- main.go    |- hello        |- hello.go\n\nå¦‚ä½•å¼€å‘æ’ä»¶ï¼š\nå‚è€ƒ plugin-demo-golang\n\n\nå»ºæ’ä»¶ä»£ç å·¥ç¨‹\næ’ä»¶ä»£ç å»ºè®®ä¼ä¸šä¸‹ç»Ÿä¸€ç®¡ç†ã€‚ é€šç”¨çš„å¼€æºæ’ä»¶å¯ä»¥è”ç³»è“é²¸å®˜æ–¹æ”¾åˆ° TencentBlueKing ä¸‹ï¼Œä¾›æ›´å¤šç”¨æˆ·ä½¿ç”¨\n\n\nå®ç°æ’ä»¶åŠŸèƒ½\nè§„èŒƒï¼š\næ’ä»¶å¼€å‘è§„èŒƒ\næ’ä»¶é…ç½®è§„èŒƒ\n\n\næ’ä»¶å‰ç«¯ä¸ä»…å¯ä»¥é€šè¿‡ task.json è¿›è¡Œæ ‡å‡†åŒ–é…ç½®ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰å¼€å‘ï¼š\nè‡ªå®šä¹‰æ’ä»¶ UI äº¤äº’æŒ‡å¼•\næ’ä»¶è¾“å‡ºè§„èŒƒ\næ’ä»¶é”™è¯¯ç è§„èŒƒ\næ’ä»¶å‘å¸ƒåŒ…è§„èŒƒ\n\n\n\nDemoç¤ºä¾‹ç ”è¯»å°† plugin-demo-golang cloneåˆ°æœ¬åœ°ã€‚æ¥çœ‹ä¸‹é¡¹ç›®ç»“æ„ï¼š\n.â”œâ”€â”€ CONTRIBUTING.mdâ”œâ”€â”€ LICENSEâ”œâ”€â”€ Makefileâ”œâ”€â”€ README.mdâ”œâ”€â”€ go.modâ”œâ”€â”€ go.sumâ”œâ”€â”€ i18nâ”‚   â”œâ”€â”€ message_en_US.propertiesâ”‚   â””â”€â”€ message_zh_CN.propertiesâ”œâ”€â”€ main.goâ”œâ”€â”€ task.jsonâ””â”€â”€ translation    â””â”€â”€ translation.go3 directories, 11 files\n\nå’¦ï¼å’Œä¸Šé¢è¯´çš„æ’ä»¶ä»£ç å·¥ç¨‹çš„æ•´ä½“æ¶æ„ä¸ä¸€æ ·ï¼š\n|- &lt;ä½ çš„æ’ä»¶æ ‡è¯†&gt;    |- cmd        |- application            |- main.go    |- hello        |- hello.go\n\nä¸è¿‡ï¼Œè¿™ä¸é‡è¦ï¼Œåªè¦æ’ä»¶æœ€ç»ˆèƒ½å¤Ÿæ‰“åŒ…æˆä¸€ä¸ªå‘½ä»¤è¡Œå¯æ‰§è¡Œçš„å‘½ä»¤å³å¯ã€‚è¿™é‡Œi18næ˜¯å®ç°ä¸­è‹±æ–‡å›½é™…åŒ–ä½¿ç”¨çš„ï¼Œ\nâ”œâ”€â”€ i18nâ”‚   â”œâ”€â”€ message_en_US.propertiesâ”‚   â””â”€â”€ message_zh_CN.properties\n\nçœ‹ä¸‹å†…å®¹å¯¹æ¯”ï¼šmessage_en_US.propertiesï¼š\ninput.desc.label=desc100001=input param [&#123;0&#125;] invitated\n\nmessage_zh_CN.properties\ninput.desc.label=æè¿°100001=è¾“å…¥å‚æ•°[&#123;0&#125;]éæ³•\n\né‚£æˆ‘ä»¬å°±å¯ä»¥çŒœæµ‹ï¼Œè¿™é‡Œæ˜¯å®ç°è¾“å…¥å‚æ•°[{0}]éæ³•è¿™å¥è¯çš„ä¸­è‹±æ–‡ï¼Œå…¶ä¸­[{0}]ä¼šä½¿ç”¨å…·ä½“çš„å‚æ•°å¡«å……ã€‚ç„¶åi18ngeneratoråˆ™æ˜¯æ ¹æ®propertiesæ–‡ä»¶çš„é…ç½®ï¼Œç”Ÿæˆtranslationä»£ç ï¼Œå¦‚translation.goï¼š\n// Code generated by &quot;i18ngenerator&quot;; DO NOT EDIT.package translation// Translationsvar Translations map[string][][]string = make(map[string][][]string)func init() &#123;    Translations[&quot;en-US&quot;] = [][]string&#123;       &#123;          &quot;100001&quot;,          &quot;input param [&#123;0&#125;] invitated&quot;,       &#125;,       &#123;          &quot;input.desc.label&quot;,          &quot;desc&quot;,       &#125;,    &#125;    Translations[&quot;zh-CN&quot;] = [][]string&#123;       &#123;          &quot;100001&quot;,          &quot;è¾“å…¥å‚æ•°[&#123;0&#125;]éæ³•&quot;,       &#125;,       &#123;          &quot;input.desc.label&quot;,          &quot;æè¿°&quot;,       &#125;,    &#125;&#125;\n\nè¯¥æ–‡ä»¶æ˜¯ç”±i18ngeneratorè‡ªåŠ¨ç”Ÿæˆçš„ï¼Œä¸è¦è‡ªå·±æ”¹ã€‚mainå‡½æ•°å†…ï¼Œå®ç°äº†ä¸€ä¸ªå°çš„è¾“å‡ºåŠŸèƒ½ï¼Œç®€å•çœ‹ä¸‹æºç ï¼Œç„¶åå»è¿›è¡Œæµ‹è¯•ï¼š\npackage mainimport (    &quot;fmt&quot;    &quot;io/ioutil&quot;    &quot;os&quot;    &quot;runtime&quot;    &quot;time&quot;    &quot;github.com/ci-plugins/golang-plugin-sdk/api&quot;    &quot;github.com/ci-plugins/golang-plugin-sdk/log&quot;    &quot;github.com/ci-plugins/plugin-demo-golang/translation&quot;)//go:generate i18ngenerator i18n ./translation/translation.gotype greetingParam struct &#123;    UserName string `json:&quot;userName&quot;`    Greeting string `json:&quot;greeting&quot;`&#125;func (a *greetingParam) String() string &#123;    return fmt.Sprintf(&quot;userName: %v, greeting: %v&quot;, a.UserName, a.Greeting)&#125;func main() &#123;    runtime.GOMAXPROCS(4)    log.Info(&quot;atom-demo-glang starts&quot;)    defer func() &#123;       if err := recover(); err != nil &#123;          log.Error(&quot;panic: &quot;, err)          api.FinishBuild(api.StatusError, &quot;panic occurs&quot;)       &#125;    &#125;()    api.InitI18n(translation.Translations, api.GetRuntimeLanguage())    msg, err := api.Localize(&quot;input.desc.label&quot;)    if err != nil &#123;       log.Error(err)    &#125;    log.Info(msg)    helloBuild()&#125;func helloBuild() &#123;    // è·å–å•ä¸ªè¾“å…¥å‚æ•°    userName := api.GetInputParam(&quot;userName&quot;)    log.Info(&quot;userName: &quot;, userName)    // æ‰“å±    log.Info(&quot;\\nBuildInfo:&quot;)    log.Info(&quot;Project Name:     &quot;, api.GetProjectDisplayName())    log.Info(&quot;Pipeline Id:      &quot;, api.GetPipelineId())    log.Info(&quot;Pipeline Name:    &quot;, api.GetPipelineName())    log.Info(&quot;Pipeline Version: &quot;, api.GetPipelineVersion())    log.Info(&quot;Build Id:         &quot;, api.GetPipelineBuildId())    log.Info(&quot;Build Num:        &quot;, api.GetPipelineBuildNumber())    log.Info(&quot;Start Type:       &quot;, api.GetPipelineStartType())    log.Info(&quot;Start UserId:     &quot;, api.GetPipelineStartUserId())    log.Info(&quot;Start UserName:   &quot;, api.GetPipelineStartUserName())    log.Info(&quot;Start Time:       &quot;, api.GetPipelineStartTimeMills())    log.Info(&quot;Workspace:        &quot;, api.GetWorkspace())    // è¾“å…¥å‚æ•°è§£æåˆ°å¯¹è±¡    paramData := new(greetingParam)    api.LoadInputParam(paramData)    log.Info(fmt.Sprintf(&quot;\\n%vï¼Œ%v\\n&quot;, paramData.Greeting, paramData.UserName))    // ä¸šåŠ¡é€»è¾‘    log.Info(&quot;start build&quot;)    build()    time.Sleep(2 * time.Second)    // è¾“å‡º    // å­—ç¬¦ä¸²è¾“å‡º    strData := api.NewStringData(&quot;test&quot;)    api.AddOutputData(&quot;strData_01&quot;, strData)    // æ–‡ä»¶å½’æ¡£è¾“å‡º    artifactData := api.NewArtifactData()    artifactData.AddArtifact(&quot;result.dat&quot;)    api.AddOutputData(&quot;artifactData_02&quot;, artifactData)    // æŠ¥å‘Šè¾“å‡º    reportData := api.NewReportData(&quot;label_01&quot;, api.GetWorkspace()+&quot;/report&quot;, &quot;report.htm&quot;)    api.AddOutputData(&quot;report_01&quot;, reportData)    api.WriteOutput()    log.Info(&quot;build done&quot;)&#125;func build() &#123;    log.Info(&quot;write result.dat&quot;)    ioutil.WriteFile(api.GetWorkspace()+&quot;/result.dat&quot;, []byte(&quot;content&quot;), 0644)    log.Info(&quot;write report.htm&quot;)    os.Mkdir(api.GetWorkspace()+&quot;/report&quot;, os.ModePerm)    ioutil.WriteFile(api.GetWorkspace()+&quot;/report/report.htm&quot;, []byte(&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Report&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;H1&gt;This is a Report&lt;/H1&gt;&lt;/body&gt;&lt;/html&gt;&quot;), 0644)&#125;\n\nåœ¨æ ¹ç›®å½•ä¸‹å·²ç»ç»™æˆ‘ä»¬é¢„è®¾äº†ä¸€ä¸ªtask.jsonæ–‡ä»¶ï¼Œåé¢å¯ä»¥ç®€å•ä¿®æ”¹ä¸‹è¿™ä¸ªæ–‡ä»¶æ¥å®ç°æµ‹è¯•ï¼š\n&#123;  &quot;atomCode&quot;: &quot;goDemo&quot;,  &quot;execution&quot;: &#123;    &quot;language&quot;: &quot;golang&quot;,    &quot;packagePath&quot;: &quot;goDemo&quot;,    &quot;demands&quot;: [      &quot;chmod +x goDemo&quot;    ],    &quot;target&quot;: &quot;./goDemo&quot;  &#125;,  &quot;input&quot;: &#123;    &quot;greeting&quot;: &#123;      &quot;label&quot;: &quot;æ¬¢è¿è¯&quot;,      &quot;default&quot;: &quot;Glad to see you&quot;,      &quot;placeholder&quot;: &quot;æ¬¢è¿è¯&quot;,      &quot;type&quot;: &quot;vuex-input&quot;,      &quot;desc&quot;: &quot;æ¬¢è¿è¯&quot;,      &quot;required&quot;: true,      &quot;disabled&quot;: false,      &quot;hidden&quot;: false,      &quot;isSensitive&quot;: false    &#125;,    &quot;userName&quot;: &#123;      &quot;label&quot;: &quot;å§“å&quot;,      &quot;default&quot;: &quot;Mr. Huang&quot;,      &quot;placeholder&quot;: &quot;å§“å&quot;,      &quot;type&quot;: &quot;vuex-input&quot;,      &quot;desc&quot;: &quot;å§“å&quot;,      &quot;required&quot;: true,      &quot;disabled&quot;: false,      &quot;hidden&quot;: false,      &quot;isSensitive&quot;: false    &#125;  &#125;,  &quot;output&quot;: &#123;    &quot;strData_01&quot;: &#123;      &quot;description&quot;: &quot;æµ‹è¯•&quot;,      &quot;type&quot;: &quot;string&quot;,      &quot;isSensitive&quot;: false    &#125;  &#125;&#125;\n\nå¦‚ä½•æ‰“åŒ…å‘å¸ƒ\nè¿›å…¥æ’ä»¶ä»£ç å·¥ç¨‹ç›®å½•ä¸‹\næ‰“åŒ…\n\n\nå¦‚æœæŒ‰ç…§æ­£å¸¸çš„demoçš„ç›®å½•ç»“æ„æ˜¯éœ€è¦è¿›å…¥cmd&#x2F;applicationå†…æ‰§è¡Œbuildå‘½ä»¤ï¼Œå› ä¸ºmainåœ¨æ­¤\n\ncd cmd/applicationGO111MODULE=on GOOS=linux GOARCH=amd64 go build -o bin/$&#123;executable&#125;\n\nè¿™æ¬¡ç”¨çš„demoåˆ™ç›´æ¥åœ¨æ ¹ç›®å½•ä¸‹æ‰§è¡Œbuildå‘½ä»¤ï¼Œå› ä¸ºmainåœ¨æ ¹ç›®å½•ä¸‹\n\nGO111MODULE=on GOOS=linux GOARCH=amd64 go build -o bin/$&#123;executable&#125;\n\nè¿™é‡Œgo build -o bin&#x2F;${executable}ä¼šåœ¨binç›®å½•ä¸‹ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ–‡ä»¶åæ˜¯${executable}ï¼Œå³é¡¹ç›®åã€‚ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªåå­—ï¼Œå¦‚GO111MODULE=on GOOS=linux GOARCH=amd64 go build -o bin/kingtest\n\nåœ¨ä»»æ„ä½ç½®æ–°å»ºæ–‡ä»¶å¤¹ï¼Œå‘½åç¤ºä¾‹ï¼šrelease_pkg &#x3D; &lt;ä½ çš„æ’ä»¶æ ‡è¯†&gt;_release\nå°†æ­¥éª¤ 2 ç”Ÿäº§çš„æ‰§è¡ŒåŒ…æ‹·è´åˆ° ä¸‹\næ·»åŠ  task.json æ–‡ä»¶åˆ° ä¸‹ task.json è§ç¤ºä¾‹ï¼ŒæŒ‰ç…§æ’ä»¶åŠŸèƒ½é…ç½®ã€‚\n\nmkdir kingtest_releasecp bin/kingtest kingtest_release/kingtesttouch kingtest_release/task.json\n\n\næ’ä»¶é…ç½®è§„èŒƒ\ntask.json ç¤ºä¾‹ï¼š\n\n&#123;  &quot;atomCode&quot;: &quot;king-test&quot;,                  # atomCode è¦ä¸å·¥ä½œå°å½•å…¥çš„ä¸€è‡´  &quot;execution&quot;: &#123;    &quot;language&quot;: &quot;golang&quot;,    &quot;packagePath&quot;: &quot;kingtest&quot;,              # å‘å¸ƒåŒ…ä¸­æ’ä»¶å®‰è£…åŒ…çš„ç›¸å¯¹è·¯å¾„    &quot;demands&quot;: [      &quot;echo start run chmod +x kingtest&quot;,   # æ’ä»¶å¯åŠ¨å‰éœ€è¦æ‰§è¡Œçš„å®‰è£…å‘½ä»¤ï¼Œé¡ºåºæ‰§è¡Œ      &quot;chmod +x kingtest&quot;,                  # æ’ä»¶å¯åŠ¨å‰éœ€è¦æ‰§è¡Œçš„å®‰è£…å‘½ä»¤ï¼Œé¡ºåºæ‰§è¡Œ      &quot;echo stop run chmod +x kingtest&quot;,    # æ’ä»¶å¯åŠ¨å‰éœ€è¦æ‰§è¡Œçš„å®‰è£…å‘½ä»¤ï¼Œé¡ºåºæ‰§è¡Œ    ],    &quot;target&quot;: &quot;./kingtest&quot;  &#125;,  &quot;input&quot;: &#123;    &quot;greeting&quot;: &#123;      &quot;label&quot;: &quot;æ¬¢è¿è¯&quot;,      &quot;default&quot;: &quot;Glad to see you&quot;,      &quot;placeholder&quot;: &quot;æ¬¢è¿è¯&quot;,      &quot;type&quot;: &quot;vuex-input&quot;,      &quot;desc&quot;: &quot;æ¬¢è¿è¯&quot;,      &quot;required&quot;: true,      &quot;disabled&quot;: false,      &quot;hidden&quot;: false,      &quot;isSensitive&quot;: false    &#125;,    &quot;userName&quot;: &#123;      &quot;label&quot;: &quot;å§“å&quot;,      &quot;default&quot;: &quot;Mr. Huang&quot;,      &quot;placeholder&quot;: &quot;å§“å&quot;,      &quot;type&quot;: &quot;vuex-input&quot;,      &quot;desc&quot;: &quot;å§“å&quot;,      &quot;required&quot;: true,      &quot;disabled&quot;: false,      &quot;hidden&quot;: false,      &quot;isSensitive&quot;: false    &#125;  &#125;,  &quot;output&quot;: &#123;    &quot;strData_01&quot;: &#123;      &quot;description&quot;: &quot;æµ‹è¯•&quot;,      &quot;type&quot;: &quot;string&quot;,      &quot;isSensitive&quot;: false    &#125;  &#125;&#125;\n\n\nåœ¨ ç›®å½•ä¸‹ï¼ŒæŠŠæ‰€æœ‰æ–‡ä»¶æ‰“æˆ zip åŒ…å³å¯\n\ncd kingtest_release &amp;&amp; zip kingtest_release.zip kingtest task.json\n\nzipåŒ…ç»“æ„ç¤ºä¾‹ï¼š\n|- kingtest_release.zip         # å‘å¸ƒåŒ…   |- kingtest                  # æ’ä»¶æ‰§è¡ŒåŒ…   |- task.json                 # æ’ä»¶é…ç½®æ–‡ä»¶\n\næ‰“åŒ…å®Œæˆåï¼Œåœ¨æ’ä»¶å·¥ä½œå°æå•å‘å¸ƒï¼Œå³å¯æµ‹è¯•æˆ–å‘å¸ƒæ’ä»¶\nä¸Šä¼ ä¸€ä¸ªæµæ°´çº¿æ’ä»¶\nå¼€å‘å¥½æ’ä»¶ä¹‹åï¼Œé€šè¿‡ç ”å‘å•†åº—å·¥ä½œå°ï¼Œå°†æ’ä»¶å‘å¸ƒåˆ°ç ”å‘å•†åº—ï¼Œæä¾›ç»™ç”¨æˆ·æ·»åŠ åˆ°æµæ°´çº¿ä¸­ä½¿ç”¨ã€‚\n\nå…¥å£åœ¨å·¥ä½œå°åˆ—è¡¨ï¼Œç‚¹å‡»å¦‚ä¸‹å…¥å£å‘èµ·å‘å¸ƒæµç¨‹ï¼š\né¦–æ¬¡å‘å¸ƒæ—¶ï¼Œå…¥å£åä¸ºä¸Šæ¶åç»­æ›´æ–°ç‰ˆæœ¬æ—¶ï¼Œå…¥å£åä¸ºå‡çº§æˆ–è€…åœ¨æ’ä»¶å‘å¸ƒç®¡ç†-&gt;ç‰ˆæœ¬ç®¡ç†ç•Œé¢å‘èµ·å‘å¸ƒæµç¨‹ï¼š\nå¡«å†™æ’ä»¶ç›¸å…³ä¿¡æ¯&#x2F;ä¸Šä¼ æ’ä»¶å‘å¸ƒåŒ…ä¸Šæ¶&#x2F;å‡çº§æ’ä»¶æ—¶ï¼Œå¯ä»¥ä¿®æ”¹æ’ä»¶çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n\né€‚ç”¨ Job ç±»å‹ï¼š\n\n\nå’Œæµæ°´çº¿ Job ç±»å‹å¯¹åº”ï¼Œè¯·æŒ‰ç…§æ’ä»¶å®é™…é€‚ç”¨æƒ…å†µé€‰æ‹©\nè‹¥é€‰é”™ï¼Œéœ€æ–°å¢ç‰ˆæœ¬ä¿®æ”¹\n\n\nå‘å¸ƒåŒ…ï¼š\n\n\ntask.json ä¸­çš„ atomCode éœ€å’Œ æ–°å¢æ’ä»¶æ—¶å¡«å†™çš„æ ‡è¯†ä¸€è‡´ï¼Œå¦åˆ™ä¸Šä¼ ä¼šå¤±è´¥\n\næµ‹è¯•&#x2F;å‘å¸ƒæ’ä»¶\nå¡«å†™å¥½ä¿¡æ¯ï¼Œæäº¤åï¼Œè¿›å…¥å‘å¸ƒæµç¨‹ï¼Œå¯ä»¥æµ‹è¯•-&gt;é‡æ–°ä¼ åŒ…-&gt;æµ‹è¯•ï¼Œç›´è‡³æ’ä»¶æ»¡è¶³é¢„æœŸåï¼Œæ‰‹åŠ¨ç»§ç»­æµç¨‹å°†æ’ä»¶å‘å¸ƒåˆ°ç ”å‘å•†åº—\n\n\n\næµ‹è¯•ï¼šç‚¹å‡»åè·³è½¬åˆ°æ’ä»¶è°ƒè¯•é¡¹ç›®çš„æµæ°´çº¿æœåŠ¡ä¸‹ï¼Œå¯ä»¥å°†å½“å‰æ’ä»¶æ·»åŠ åˆ°æµæ°´çº¿ï¼ŒéªŒè¯ UIã€åŠŸèƒ½æ˜¯å¦æ»¡è¶³é¢„æœŸ\né‡æ–°ä¼ åŒ…ï¼šå½“æµ‹è¯•å‘ç°é—®é¢˜ï¼Œä¿®å¤åï¼Œé‡æ–°ä¸Šä¼ å‘å¸ƒåŒ…ï¼Œå†æ¬¡è¿›è¡Œæµ‹è¯•\nç»§ç»­ï¼šæµ‹è¯• OKï¼Œæ»¡è¶³é¢„æœŸåï¼Œç¡®è®¤æäº¤å‘å¸ƒ\nå–æ¶ˆå‘å¸ƒï¼šå‘å¸ƒè¿‡ç¨‹ä¸­ï¼Œéšæ—¶å¯ä»¥ç»ˆæ­¢å‘å¸ƒ\n\né‡è§çš„å‡ ä¸ªé”™è¯¯æ— æƒé™æ‰§è¡Œåœ¨æµ‹è¯•ä¸­é‡è§ä¸€ä¸ªé—®é¢˜ï¼šæ— æƒé™æ‰§è¡Œ\nåœ¨execution-&gt;demandså¢åŠ ä¸€ä¸ªå‘½ä»¤chmod +x kingtestå³å¯è§£å†³\nå‘å¸ƒè¿›åº¦é‡Œé‡æ–°ä¼ åŒ…æŒç»­æŠ¥é”™task.jsonæ ¼å¼é”™è¯¯è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œåœ¨å‘å¸ƒè¿›åº¦é‡Œé‡æ–°ä¼ åŒ…æ—¶ï¼Œä¸€ç›´æŠ¥é”™task.jsonæ ¼å¼é”™è¯¯ï¼Œä½†å®é™…æ ¼å¼æ˜¯å¯¹çš„ï¼è§¦å‘çš„åŸå› æš‚ä¸çŸ¥é“ï¼Œä½†æ˜¯ç¡®å®æ˜¯ä¸€ä¸ªéšè—çš„bugã€‚\nç›´æ¥ç‚¹å‡»ç»§ç»­ï¼Œç„¶åèµ°å‡çº§æ’ä»¶çš„æ–¹å¼å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚\ncannot execute binary file: Exec format errorè¿™é‡Œçš„é—®é¢˜æ˜¯æˆ‘é€ æˆçš„ï¼Œæœ€åˆæˆ‘åœ¨macç¯å¢ƒä¸‹ç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå‘½ä»¤æ˜¯ï¼š\n# macä¸‹æ‰§è¡Œgo build -o bin/kingtest\n\nä½†æ˜¯æ’ä»¶é‡Œé€‰æ‹©çš„ç¼–è¯‘ç¯å¢ƒæ˜¯linuxã€‚\nè§£å†³æ–¹å¼ï¼šè®©æ’ä»¶é€‰æ‹©çš„ç¼–è¯‘ç¯å¢ƒå’Œå¯æ‰§è¡Œæ–‡ä»¶çš„å¹³å°ç»Ÿä¸€ã€‚æˆ‘è¿™é‡Œé€‰æ‹©é‡æ–°ç¼–è¯‘ä¸‹å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé‡‡ç”¨åœ¨macå¹³å°äº¤å‰ç¼–è¯‘linuxå¹³å°å¯æ‰§è¡Œæ–‡ä»¶çš„æ–¹å¼ã€‚\nGO111MODULE=on GOOS=linux GOARCH=amd64 go build -o bin/kingtest\n\nä¹Ÿå¯ä»¥æ–°å»ºä¸€ä¸ªæ’ä»¶ï¼Œç¼–è¯‘ç¯å¢ƒé€‰æ‹©macã€‚\nè¿è¡Œç»“æœæµæ°´çº¿ç»“æœï¼š\nè¾“å‡ºç»“æœï¼š\n[Plugin info]=====================================================================Task           : king-testDescription    : bkæ’ä»¶æµ‹è¯•Version        : 1.0.3Author         : huariHelp           : More Information=====================================================================-----[Input]input(normal): (æ¬¢è¿è¯)greeting=Glad to see youinput(normal): (å§“å)userName=Mr. Huang-----[Install plugin]-----start run chmod +x kingteststop run chmod +x kingtestatom-demo-glang startsæè¿°userName:  Mr. HuangBuildInfo:Project Name:      GOPSPipeline Id:       p-8967ed52b08847c8a5b0140937db0975Pipeline Name:     king-testPipeline Version:  11Build Id:          b-78947b5c39f34b32bbafb803042d1e22Build Num:         15Start Type:        MANUALStart UserId:      huariStart UserName:    huariStart Time:        1733298107286Workspace:         /data/devops/workspaceGlad to see youï¼ŒMr. Huangstart buildwrite result.datwrite report.htmbuild done[Output]1 file match:   /data/devops/workspace/result.datprepare to upload 7 B1/1 file(s) finishedoutput(except): artifactData_02=result.datå…¥å£æ–‡ä»¶æ£€æµ‹å®Œæˆä¸Šä¼ è‡ªå®šä¹‰äº§å‡ºç‰©æˆåŠŸï¼Œå…±äº§ç”Ÿäº†1ä¸ªæ–‡ä»¶output(except): report_01=report.htmoutput(normal): strData_01=test-----\n\n\n\n\n\n\n","categories":["devops/blueking"],"tags":["devops","blueking"]},{"title":"BKCI ç®€ä»‹","url":"/2025/07/devops/blueking/bkci-jian-jie/","content":"æ–‡æ¡£BK-CIå®˜æ–¹æ–‡æ¡£ï¼šhttps://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/intro/README.mdgithubä»“åº“åœ°å€ï¼šhttps://github.com/TencentBlueKing/bk-ci\nå¯¼èˆª\n\n\nğŸ¤ äº†è§£åŸºæœ¬æ¦‚å¿µ\nğŸ‘‰ ä½¿ç”¨ BKCI\nğŸš€ éƒ¨ç½² BKCI\n\n\n\nBKCI æ˜¯ä»€ä¹ˆï¼Ÿ\nåˆ›å»ºä½ çš„ç¬¬ä¸€æ¡æµæ°´çº¿\nBKCI ç¡¬ä»¶è§„æ ¼æŒ‡å—\n\n\nBKCI ç»„ä»¶\nå…³è”ä½ çš„ç¬¬ä¸€ä¸ªä»£ç åº“\nBKCI ç³»ç»Ÿè¦æ±‚\n\n\nå¿«é€Ÿç†Ÿæ‚‰æµæ°´çº¿\nä¸ºä½ çš„Gitå·¥ç¨‹å¼€å¯CI\n\n\n\næœ¯è¯­è§£é‡Š\nç¤ºä¾‹\n\n\n\n\nAPIæ¥å£\n\n\n\n\n\n\nğŸ“” äº§å“åŠŸèƒ½\nğŸª ç ”å‘å•†åº—\n\n\n\næµæ°´çº¿\næµè§ˆç ”å‘å•†åº—\n\n\næ§åˆ¶å°\nå¼€å‘ä¸€ä¸ªæµæ°´çº¿æ’ä»¶\n\n\nå‡­è¯ç®¡ç†\nåœ¨ BKCI é‡Œä½¿ç”¨å•†åº—æ’ä»¶\n\n\næ„å»ºèµ„æº\n\n\n\nç›¸å…³æ–‡æ¡£è“é²¸å­¦ä¹ ç¤¾åŒºï¼šhttps://bk.tencent.com/s-mart/communitiesè“é²¸å®˜æ–¹æ–‡æ¡£ï¼šhttps://bk.tencent.com/docs/\nè“é²¸ä½“ç³»è“é²¸ç®€ä»‹ï¼šhttps://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/intro.mdæ ¸å¿ƒä¼˜åŠ¿ï¼šhttps://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/advantages.mdä½“ç³»æ¶æ„ï¼šhttps://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/Solution/solution.mdCIé¢†åŸŸï¼šhttps://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/Solution/ci_intro.mdCDé¢†åŸŸï¼šhttps://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/Solution/cd_intro.mdCOé¢†åŸŸï¼šhttps://bk.tencent.com/docs/markdown/ZH/BlueKingFamily/7.2/UserGuide/Solution/co_intro.md\n","categories":["devops/blueking"],"tags":["devops","blueking"]},{"title":"Kanikoå®¹å™¨åŒ–æ„å»ºè°ƒç ”","url":"/2025/08/devops/blueking/kaniko-rong-qi-hua-gou-jian-diao-yan/","content":"ç®€ä»‹Githubåœ°å€ï¼šhttps://github.com/GoogleContainerTools/kaniko\nKaniko æ˜¯è°·æ­Œå¼€æºçš„ä¸€æ¬¾æ„å»ºå®¹å™¨é•œåƒçš„å·¥å…·ã€‚\nKaniko å¹¶ä¸ä¾èµ–äº Docker å®ˆæŠ¤è¿›ç¨‹ï¼Œå®Œå…¨åœ¨ç”¨æˆ·ç©ºé—´æ ¹æ® Dockerfile çš„å†…å®¹é€è¡Œæ‰§è¡Œå‘½ä»¤æ¥æ„å»ºé•œåƒï¼Œè¿™å°±ä½¿å¾—åœ¨ä¸€äº›æ— æ³•è·å– docker å®ˆæŠ¤ è¿›ç¨‹çš„ç¯å¢ƒä¸‹ä¹Ÿèƒ½å¤Ÿæ„å»ºé•œåƒã€‚\n\nKaniko ä¼šå…ˆæå–åŸºç¡€é•œåƒ(Dockerfile FROM ä¹‹åçš„é•œåƒ)çš„æ–‡ä»¶ç³»ç»Ÿï¼Œç„¶åæ ¹æ® Dockerfile ä¸­æ‰€æè¿°çš„ï¼Œä¸€æ¡æ¡æ‰§è¡Œå‘½ä»¤ï¼Œæ¯ä¸€æ¡å‘½ä»¤æ‰§è¡Œå®Œä»¥åä¼šåœ¨ç”¨æˆ·ç©ºé—´ä¸‹é¢åˆ›å»ºä¸€ä¸ª snapshotï¼Œå¹¶ä¸å­˜å‚¨ä¸å†…å­˜ä¸­çš„ä¸Šä¸€ä¸ªçŠ¶æ€è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœæœ‰å˜åŒ–ï¼Œå°±å°†æ–°çš„ä¿®æ”¹ç”Ÿæˆä¸€ä¸ªé•œåƒå±‚æ·»åŠ åœ¨åŸºç¡€é•œåƒä¸Šï¼Œå¹¶ä¸”å°†ç›¸å…³çš„ä¿®æ”¹ä¿¡æ¯å†™å…¥é•œåƒå…ƒæ•°æ®ä¸­ã€‚ç­‰æ‰€æœ‰å‘½ä»¤æ‰§è¡Œå®Œï¼Œkaniko ä¼šå°†æœ€ç»ˆé•œåƒæ¨é€åˆ°æŒ‡å®šçš„è¿œç«¯é•œåƒä»“åº“ã€‚\nè·å–Kanikoé•œåƒè¿™ä¸ªéœ€è¦åœ¨linuxç¯å¢ƒä¸‹æ‰§è¡Œï¼š\n# docker ç™»é™†docker login --username=huari@xxx public-registry.cn-hangzhou.cr.aliyuncs.com# é€šè¿‡ä»£ç†æ‹‰å–é•œåƒdocker pull --platform linux/amd64 m.daocloud.io/gcr.io/kaniko-project/executor:latest# ä¿®æ”¹tagdocker tag m.daocloud.io/gcr.io/kaniko-project/executor:latest public-registry.cn-hangzhou.cr.aliyuncs.com/public/kaniko-executor:latest# æ¨é€é•œåƒdocker push public-registry.cn-hangzhou.cr.aliyuncs.com/public/kaniko-executor:latest\n\n\nâ€“platform linux&#x2F;amd64ï¼šå®ç°åœ¨macä¸Špull amd64çš„é•œåƒï¼Œ\n\npullé•œåƒæ—¶ï¼Œä¼šé»˜è®¤åŒ¹é…å½“å‰æ¶æ„ï¼Œå› æ­¤è‹¥ä¸è®¾ç½®è¯¥å‚æ•°ï¼Œåˆ™ä¼šè‡ªåŠ¨åŒ¹é…ä¸‹è½½arm64é•œåƒï¼Œåœ¨amd64ä¸Šè¿è¡Œæ—¶ä¼šé‡è§ä¸‹é¢è¿™ä¸ªæŠ¥é”™ï¼š\nexec /kaniko/executor: exec format error\n\nKaniko Demodemoé¡¹ç›®é€‰æ‹©åœ¨gitlabä¸Šæ–°å»ºä¸€ä¸ªdemoé¡¹ç›®ï¼Œä»…æ·»åŠ ä¸€ä¸ªDockerfileå³å¯ã€‚å†…å®¹å¦‚ä¸‹ï¼š\nFROM ubuntu:20.04LABEL maintainer=&quot;yourname@example.com&quot;RUN apt-get update &amp;&amp; apt-get install -y nginx\n\nå¯¹é¡¹ç›®çš„è¦æ±‚æ˜¯ï¼Œé€šè¿‡ Dockerfile èƒ½å¤Ÿç›´æ¥ç¼–è¯‘å¾—åˆ°é•œåƒã€‚ä¸€å…±æœ‰ä¸¤ä¸ªéªŒè¯ç‚¹:\n\né€šè¿‡kanikoå¯ä»¥ç›´æ¥æ„å»ºdockeré•œåƒ\næ„å»ºçš„é•œåƒå¯ä»¥æ­£å¸¸è¿è¡Œ\n\nDockerç¯å¢ƒè¿›è¡Œæµ‹è¯•ç”Ÿæˆæ¨é€é•œåƒçš„å‡­è¯å‡­è¯ä¿¡æ¯ï¼š\n\nYOUR_USERNAMEï¼ˆæˆ‘çš„é˜¿é‡Œäº‘ dockerhubè´¦æˆ·ï¼‰:huari@xxx\nYOUR_PASSWORDï¼ˆæˆ‘çš„é˜¿é‡Œäº‘ dockerhubè´¦æˆ·å¯†ç ï¼‰: åŸŸè´¦å·å¯†ç export AUTH=$(echo -n YOUR_USERNAME:YOUR_PASSWORD | base64 )cat &gt; config.json &lt;&lt;-EOF&#123;        &quot;auths&quot;: &#123;                &quot;https://index.docker.io/v1/&quot;: &#123;                        &quot;auth&quot;: &quot;$&#123;AUTH&#125;&quot;                &#125;        &#125;&#125;EOF\n\næ‰§è¡Œæ„å»ºå› ä¸ºæˆ‘åœ¨macç¯å¢ƒæ‰§è¡Œï¼Œæ‰€ä»¥pull imageæ—¶ï¼Œè¦åŠ â€“platform linux&#x2F;arm64ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨åŸå§‹é•œåƒ(ç»è¿‡ä»£ç†)ï¼šm.daocloud.io&#x2F;gcr.io&#x2F;kaniko-project&#x2F;executor:latest\ndocker run \\  --interactive -v `pwd`/config.json:/kaniko/.docker/config.json m.daocloud.io/gcr.io/kaniko-project/executor:latest \\  --context git://gitlab.papegames.com/huari/kaniko-build-test \\  --dockerfile Dockerfile \\  --destination=dev-registry.cn-hangzhou.cr.aliyuncs.com/ops/kaniko-demo:v2\n\nå‚æ•°è¯´æ˜:\n\ncontextï¼šæ„å»ºéœ€è¦çš„ä¸Šä¸‹æ–‡ã€‚æ”¯æŒå¤šç§æ ¼å¼ï¼ŒS3ã€æœ¬åœ°ç›®å½•ã€æ ‡å‡†è¾“å…¥ã€Git ä»“åº“ç­‰\ndockerfileï¼šDockerfile è·¯å¾„\ndestinationï¼šæ„å»ºåæ¨é€çš„é•œåƒåœ°å€\n\nå·²ç»å¯ä»¥å®Œæˆé•œåƒç¼–è¯‘å’Œä¸Šä¼ ï¼š\nK8sé›†ç¾¤ç¯å¢ƒè¿›è¡Œæµ‹è¯•ç”Ÿæˆæ¨é€é•œåƒå‡­è¯è¿™ä¸ªæ˜¯ç”¨æ¥ç»™kanikoå‘é˜¿é‡Œäº‘æ¨é€é•œåƒä½¿ç”¨çš„\nå‡­è¯ä¿¡æ¯ï¼š\n\nYOUR_USERNAMEï¼ˆæˆ‘çš„é˜¿é‡Œäº‘ dockerhubè´¦æˆ·ï¼‰:huari@xxx\nYOUR_PASSWORDï¼ˆæˆ‘çš„é˜¿é‡Œäº‘ dockerhubè´¦æˆ·å¯†ç ï¼‰: åŸŸè´¦å·å¯†ç \nYOUR_EMAIL ï¼ˆæˆ‘çš„å çº¸é‚®ç®±ï¼‰ï¼š&#120;&#x78;&#x78;&#x40;&#x79;&#x79;&#121;&#x2e;&#110;&#101;&#x74;\nYOUR_NAMESPACE (é›†ç¾¤å†…çš„namespace)\n\nkubectl create secret docker-registry aliyun-regsecret --docker-server=dev-registry.cn-hangzhou.cr.aliyuncs.com --docker-username=&lt;YOUR_USERNAME&gt; --docker-password=&lt;YOUR_PASSWORD&gt; --docker-email=&lt;YOUR_EMAIL&gt; -n &lt;YOUR_NAMESPACE&gt;\n\nå‚æ•°è§£é‡Šï¼š\n\nkubectl create secret aliyun-regsecretï¼šæ ¸å¿ƒå‘½ä»¤\nåˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äº Docker é•œåƒä»“åº“è®¤è¯çš„ Kubernetes Secret\nè¿™ç§ Secret ä¼šè‡ªåŠ¨ç”Ÿæˆ ~&#x2F;.docker&#x2F;config.json æ ¼å¼çš„è®¤è¯æ–‡ä»¶\n\n\naliyun-regsecretï¼šSecret åç§°\nè‡ªå®šä¹‰çš„ Secret åç§°ï¼ˆå¯ä»»æ„å‘½åï¼‰\nåç»­åœ¨ Pod ä¸­é€šè¿‡æ­¤åç§°å¼•ç”¨è®¤è¯ä¿¡æ¯\n\n\nâ€“docker-server&#x3D;dev-registry.cn-hangzhou.cr.aliyuncs.comï¼šä»“åº“æœåŠ¡å™¨åœ°å€\né˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡çš„ Registry åœ°å€\ncn-hangzhou è¡¨ç¤ºæ­å·åœ°åŸŸï¼ˆæ ¹æ®ä½ çš„ä»“åº“æ‰€åœ¨åœ°åŸŸä¿®æ”¹ï¼‰\n\n\nè®¤è¯å‡­æ®\nâ€“docker-username&#x3D;  # é˜¿é‡Œäº‘è´¦å·ç”¨æˆ·å\nç”¨æˆ·åï¼šé˜¿é‡Œäº‘ ä¸»è´¦å· æˆ– RAM å­è´¦å· ç”¨æˆ·å\n\n\nâ€“docker-password&#x3D; # é˜¿é‡Œäº‘è´¦å·å¯†ç æˆ–è®¿é—®å‡­è¯\nä¸»è´¦å·ï¼šç™»å½•å¯†ç \næ¨èä½¿ç”¨ è®¿é—®å‡­è¯ï¼ˆæ›´å®‰å…¨ï¼‰ï¼š\nè¿›å…¥ é˜¿é‡Œäº‘è®¿é—®æ§åˆ¶å°\nåˆ›å»º AccessKeyï¼ˆåŒ…å« AccessKey ID å’Œ AccessKey Secretï¼‰\n\n\n\n\nâ€“docker-email&#x3D;    # è´¦å·é‚®ç®±ï¼ˆKubernetes è¦æ±‚ä½†å®é™…ä¸éªŒè¯ï¼‰\n\n\n\næŸ¥çœ‹secretï¼š\nkubectl describe secret aliyun-regsecret -n huariName:         aliyun-regsecretNamespace:    huariLabels:       &lt;none&gt;Annotations:  &lt;none&gt;Type:  kubernetes.io/dockerconfigjsonData====.dockerconfigjson:  218 bytes\n\næ„å»ºpodçš„yamlå› ä¸ºæœ€ç»ˆé•œåƒåœ¨amd64ç¯å¢ƒæ‰§è¡Œï¼Œæ‰€ä»¥pull imageæ—¶ï¼Œè¦åŠ â€“platform linux&#x2F;amd64\napiVersion: v1kind: Podmetadata:  name: kaniko-builder  namespace: huarispec:  containers:    - name: kaniko      image: m.daocloud.io/gcr.io/kaniko-project/executor:latest      args: [&quot;--dockerfile=Dockerfile&quot;,             &quot;--context=git://gitlab.papegames.com/huari/kaniko-build-test&quot;,             &quot;--destination=dev-registry.cn-hangzhou.cr.aliyuncs.com/ops/kaniko-demo:v3&quot;]      volumeMounts:        - name: kaniko-secret          mountPath: &quot;/kaniko/.docker&quot;  volumes:    - name: kaniko-secret      secret:        secretName: aliyun-regsecret        items:          - key: .dockerconfigjson            path: config.json  restartPolicy: Never\n\næ‰§è¡Œæ„å»ºå°†podçš„yamlä¿å­˜è¿›kaniko-test.yamlå†…ï¼Œç„¶åæ‰§è¡Œapplyï¼š\nkubectl apply -f kaniko-test.yaml\n\næŸ¥çœ‹è¿è¡Œæ—¥å¿—ï¼ˆéƒ¨åˆ†ï¼‰ï¼š\nâœ kubectl logs pod/kaniko-builder -n huari      Â·Â·Â·INFO[0020] Taking snapshot of full filesystem...        INFO[0022] Pushing image to dev-registry.cn-hangzhou.cr.aliyuncs.com/ops/kaniko-demo:v3 INFO[0032] Pushed dev-registry.cn-hangzhou.cr.aliyuncs.com/ops/kaniko-demo@sha256:baf97628a3981542e85db343f77c9e0dba5f666c868c2c6671290f7bfdc0d207 \n\nå·²ç»æ‰“åŒ…å¥½é•œåƒï¼š\nå¹¶ä¸”podçŠ¶æ€å·²ç»å˜ä¸ºï¼šCompleted\nâœ kubectl get pod -n huariNAME             READY   STATUS      RESTARTS   AGEkaniko-builder   0/1     Completed   0          2m22s\n\n","categories":["devops/blueking"],"tags":["devops","blueking","kaniko"]},{"title":"æ•°æ®åº“è¿ç§»","url":"/2025/08/devops/blueking/shu-ju-ku-qian-yi/","content":"æ•°æ®å¤‡ä»½å¤‡ä»½è„šæœ¬å‡†å¤‡#!/bin/bashMYSQL_USER=rootMYSQL_HOST=127.0.0.1MYSQL_PASSWD=ignoredblist=&#x27;information_schema|mysql|test|db_infobase|performance_schema|sys&#x27;dblist=&quot;$(mysql -h$MYSQL_HOST -u$MYSQL_USER -p$MYSQL_PASSWD -Nse&quot;show databases;&quot;|grep -Ewv &quot;$ignoredblist&quot; | xargs echo)&quot;mysqldump -h$MYSQL_HOST -u$MYSQL_USER -p$MYSQL_PASSWD --skip-opt --create-options --default-character-set=utf8mb4 -R  -E -q -e --single-transaction --no-autocommit --max-allowed-packet=1G  --hex-blob -B $dblist &gt; /tmp/bk_mysql_alldata.sql\n\nå°†å…¶ä¸­çš„MYSQL_USERã€MYSQL_HOSTã€MYSQL_PASSWORDæ›´æ¢æˆéœ€è¦å¤‡ä»½çš„æ•°æ®åº“åŠç”¨æˆ·åå¯†ç ã€‚å­˜ä¸º dbbackup_mysql.sh æ–‡ä»¶ã€‚\nå°†è„šæœ¬æ‹·è´åˆ°å®¹å™¨å†…æ‰§è¡Œä»¥è‡ªå»ºçš„è“ç›¾mysqlä¸ºä¾‹\n# å°†ä¸Šé¢çš„æ•°æ®å¤‡ä»½è„šæœ¬æ‹·è´è‡³è‡ªå»ºçš„è“ç›¾mysqlçš„podä¸­kubectl cp -n blueking /data/dbbackup_mysql.sh bk-ci-mysql-0:/tmp/dbbackup_mysql.sh# å¼€å§‹æ‰§è¡Œæ•°æ®å¤‡ä»½kubectl exec -it -n blueking bk-mysql-mysql-master-0 -- bash /tmp/dbbackup_mysql.sh# å°†å¤‡ä»½å¥½çš„sqlä»podæ‹·è´åˆ°æœ¬æœºæš‚å­˜kubectl cp -n blueking bk-ci-mysql-0:/tmp/bk_mysql_alldata.sql /data/bkmysql_bak/bk_mysql_alldata.sql\n\næœ€åä¸€æ­¥æ•°æ®æ‹·è´å¯ä»¥ä¸åšï¼Œç›´æ¥åœ¨è¿™ä¸ªpodé‡Œè¿›è¡Œåç»­çš„æ•°æ®å¯¼å…¥æ“ä½œã€‚\næ•°æ®å¯¼å…¥ä¸Šä¸€æ­¥çš„æ•°æ®å¤‡ä»½æ˜¯ç”¨rootç”¨æˆ·è¿›è¡Œæ“ä½œï¼Œå¤‡ä»½ä¸­æ¶‰åŠå­˜å‚¨è¿‡ç¨‹å‡½æ•°å’Œèµ‹æƒã€‚\n\næ³¨æ„ï¼šå¦‚æœå¯¼å…¥åˆ°é˜¿é‡Œäº‘mysqlæœåŠ¡ä¸­éœ€è¦å¤„ç†å¯¼å‡ºçš„sqlæ–‡ä»¶ï¼Œå› ä¸ºé˜¿é‡Œäº‘æä¾›çš„mysqlæœåŠ¡ï¼Œrootä½œä¸ºä¿ç•™å­—æ®µï¼Œä¸èƒ½ç”±ç”¨æˆ·è‡ªç”±åˆ›å»ºï¼Œä½†å…è®¸åˆ›å»ºæ‹¥æœ‰rootæƒé™çš„è´¦æˆ·ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹å¤‡ä»½æ•°æ®ä¸­ç›¸å…³çš„å†…å®¹ï¼Œæ›´æ¢æˆå®é™…ä½¿ç”¨çš„æ•°æ®åº“ç”¨ä»¥æ›¿æ¢æˆ superuser ä¸ºä¾‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š\n\n# ç»Ÿè®¡&quot;`root`@&quot;å­—ç¬¦ä¸²ä¸€å…±æœ‰å¤šå°‘ä¸ªgrep -o &#x27;`root`@&#x27; bk_mysql_alldata.sql | wc -l# å°†&quot;`root`@&quot; ä¿®æ”¹ä¸º &quot;`superuser`@&quot;sed -i &#x27;s/`root`@/`superuser`@/g&#x27; bk_mysql_alldata.sql# äºŒæ¬¡ç¡®è®¤grep -o &#x27;`superuser`@&#x27; bk_mysql_alldata.sql | wc -l\n\nå¯¼å…¥mysql -h $NEW_MYSQL_HOST -usuperuser -p$YOUR_PASSWORD --force &lt; bk_mysql_alldata.sql\n\næ£€æŸ¥mysql -h$MYSQL_HOST -usuperuser -p$MYSQL_PASSWD -Nse&quot;show databases like &#x27;devops_ci%&#x27;;&quot;\n\nHelmfileæ›´æ–°å˜æ›´ bkci\\environments\\default\\bkci\\bkci-custom-values.yaml.gotmpl æ–‡ä»¶åæ‰§è¡Œ helmfile ç›¸å…³å‘½ä»¤æ›´æ–°æœåŠ¡ã€‚\n","categories":["devops/blueking"],"tags":["devops","blueking"]},{"title":"ç”Ÿäº§éƒ¨ç½²æ–‡æ¡£(v7-1)","url":"/2025/08/devops/blueking/sheng-chan-bu-shu-wen-dang-v7-1/","content":"1. æ¦‚è¿°éœ€è¦å…ˆå‡†å¤‡ä¸€å°ä¸­æ§æœºï¼Œåœ¨ä¸­æ§æœºå®‰è£… kubectlã€helmã€helmfile ç­‰å·¥å…·ï¼Œä»¥åŠè“é²¸å®‰è£…è„šæœ¬ã€‚ç„¶åéƒ¨ç½²åŸºç¡€å¥—é¤ï¼Œæœ€åå†éƒ¨ç½²æŒç»­é›†æˆå¥—é¤ï¼ˆè“ç›¾ï¼‰ã€‚\nç®€å•æ¥è¯´å°±æ˜¯ä¸‰ä¸ªæ­¥éª¤ï¼š\n\n1.å‡†å¤‡ç¯å¢ƒ \n2.éƒ¨ç½²åŸºç¡€æœåŠ¡ \n3.éƒ¨ç½²è“ç›¾\n\n2. å‡†å¤‡ä¸­æ§æœºæŒ‰ç…§å®˜æ–¹æ–‡æ¡£å®‰è£…å’Œé…ç½®å³å¯ã€‚\n3. éƒ¨ç½²åŸºç¡€æœåŠ¡éœ€è¦æŒ‰ç…§å®˜æ–¹æ–‡æ¡£ä¸€æ­¥æ­¥éƒ¨ç½²ã€‚\n3.1 ä¸‹è½½å®‰è£…æ–‡ä»¶è¯·åœ¨ ä¸­æ§æœº ä½¿ç”¨ä¸‹è½½è„šæœ¬ä¸‹è½½è“é²¸ helmfile åŒ…åŠå…¬å…±è¯ä¹¦ã€‚ï¼ˆ helmfileç›¸å…³valueæ–‡ä»¶åœ¨gitä¸Šç»´æŠ¤ï¼‰\nbkdl-7.1-stable.sh -ur latest base demo\n\nè¿™äº›æ–‡ä»¶é»˜è®¤æ”¾åœ¨äº† ~&#x2F;bkce7.1-install&#x2F; ç›®å½•ã€‚\n3.2 é…ç½® Helm Chart ä»“åº“helm repo add blueking https://hub.bktencent.com/chartrepo/bluekinghelm repo updatehelm repo list\n\n3.3 é…ç½®å…¨å±€ custom-valuesç›¸å…³æ–‡ä»¶å·²ç»ä¿®æ”¹ï¼Œåœ¨gitä¸Šç»´æŠ¤ï¼Œé…ç½®è®¿é—®åŸŸåã€‚\nBK_DOMAIN=bk.blazehu.com  # è¯·ä¿®æ”¹ä¸ºä½ åˆ†é…ç»™è“é²¸å¹³å°çš„ä¸»åŸŸå cd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•# å¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ·»åŠ åŸŸåã€‚å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨ç¼–è¾‘ã€‚custom=environments/default/custom.yamlcat &gt;&gt; &quot;$custom&quot; &lt;&lt;EOFimageRegistry: $&#123;REGISTRY:-hub.bktencent.com&#125;domain:  bkDomain: $BK_DOMAIN  bkMainSiteDomain: $BK_DOMAINEOF\n\n3.4 ç”Ÿæˆ values æ–‡ä»¶è¿˜æœ‰ä¸€äº› values æ–‡ä»¶éšç€éƒ¨ç½²ç¯å¢ƒçš„ä¸åŒè€Œå˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬æä¾›äº†è„šæœ¬å¿«é€Ÿç”Ÿæˆã€‚\nç”Ÿæˆè“é²¸ app code å¯¹åº”çš„ secret\n./scripts/generate_app_secret.sh ./environments/default/app_secret.yaml\n\nç”Ÿæˆ apigw æ‰€éœ€çš„ keypair\n./scripts/generate_rsa_keypair.sh ./environments/default/bkapigateway_builtin_keypair.yaml\n\nç”Ÿæˆ paas æ‰€éœ€çš„ clusterAdmin\n./scripts/create_k8s_cluster_admin_for_paas3.sh\n\n3.5 å®‰è£…å…¥å£ç½‘å…³3.5.1 å®‰è£… ingress controllerå…ˆæ£€æŸ¥ä½ çš„ç¯å¢ƒæ˜¯å¦å·²ç»éƒ¨ç½²äº† ingress controller:\nkubectl get pods -A -l app.kubernetes.io/name=ingress-nginx\n\nå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åˆ›å»ºï¼š\nhelmfile -f 00-ingress-nginx.yaml.gotmpl synckubectl get pods -A -l app.kubernetes.io/name=ingress-nginx  æŸ¥çœ‹åˆ›å»ºçš„pod\n\npopsé›†ç¾¤ç›¸å…³æ ‡ç­¾å¦‚ä¸‹ï¼š\nkubectl get pods -A -l app=ingress-nginx  # æŸ¥çœ‹åˆ›å»ºçš„podIP1=$(kubectl get svc -A -l app=nginx-ingress-lb -o jsonpath=&#x27;&#123;.items[0].status.loadBalancer.ingress[0].ip&#125;&#x27;)# IP1=$(kubectl get svc -A -l app.kubernetes.io/name=ingress-nginx -o jsonpath=&#x27;&#123;.items[0].status.loadBalancer.ingress[0].ip&#125;&#x27;)\n\n3.5.2 é…ç½® corednsåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­ï¼Œä¼šåœ¨å®¹å™¨å†…è®¿é—®è¿™äº›åŸŸåï¼Œæ‰€ä»¥éœ€è¦æå‰é…ç½® corednsï¼Œå°†è“é²¸åŸŸåè§£æåˆ° service IPã€‚\n\næ³¨æ„: å½“ service è¢«åˆ é™¤ï¼Œé‡å»ºå clusterIP ä¼šå˜åŠ¨ï¼Œæ­¤æ—¶éœ€åˆ·æ–° hosts æ–‡ä»¶ã€‚\n\nå› æ­¤éœ€è¦æ³¨å…¥ hosts é…ç½®é¡¹åˆ° kube-system namespace ä¸‹çš„ coredns ç³»åˆ— pod\ncd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•BK_DOMAIN=$(yq e &#x27;.domain.bkDomain&#x27; environments/default/custom.yaml)  # ä»è‡ªå®šä¹‰é…ç½®ä¸­æå–, ä¹Ÿå¯è‡ªè¡Œèµ‹å€¼#IP1=$(kubectl get svc -A -l app.kubernetes.io/instance=ingress-nginx -o jsonpath=&#x27;&#123;.items[0].spec.clusterIP&#125;&#x27;)IP1=$(kubectl get svc -A -l app=nginx-ingress-lb -o jsonpath=&#x27;&#123;.items[0].status.loadBalancer.ingress[0].ip&#125;&#x27;)./scripts/control_coredns.sh update &quot;$IP1&quot; $BK_DOMAIN bkrepo.$BK_DOMAIN docker.$BK_DOMAIN bkapi.$BK_DOMAIN bkpaas.$BK_DOMAIN bkiam-api.$BK_DOMAIN bkiam.$BK_DOMAIN apps.$BK_DOMAIN bknodeman.$BK_DOMAIN job.$BK_DOMAIN jobapi.$BK_DOMAIN./scripts/control_coredns.sh update &quot;$IP1&quot; devops.$BK_DOMAIN./scripts/control_coredns.sh list  # æ£€æŸ¥æ·»åŠ çš„è®°å½•ã€‚\n\nç¡®è®¤æ³¨å…¥ç»“æœï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š\ncd ~/bkce7.1-install/blueking/  è¿›å…¥å·¥ä½œç›®å½•./scripts/control_coredns.sh list\n\nå‚è€ƒè¾“å‡ºå¦‚ä¸‹ï¼š\n172.27.124.109 bkce.diezhi.net172.27.124.109 bkrepo.bkce.diezhi.net172.27.124.109 docker.bkce.diezhi.net172.27.124.109 bkapi.bkce.diezhi.net172.27.124.109 bkpaas.bkce.diezhi.net172.27.124.109 bkiam-api.bkce.diezhi.net172.27.124.109 bkiam.bkce.diezhi.net172.27.124.109 apps.bkce.diezhi.net172.27.124.109 bknodeman.bkce.diezhi.net172.27.124.109 job.bkce.diezhi.net172.27.124.109 jobapi.bkce.diezhi.net172.27.124.109 devops.bkce.diezhi.net\n\n3.6 éƒ¨ç½²æˆ–å¯¹æ¥å­˜å‚¨æœåŠ¡3.6.1 éƒ¨ç½²è“é²¸é¢„ç½®çš„å­˜å‚¨æœåŠ¡å‚è€ƒå®˜æ–¹æ–‡æ¡£å®‰è£…ï¼Œç›¸å…³helmé…ç½®å·²ç»æ”¾åœ¨gitlabä»“åº“ä¸Šç»´æŠ¤ï¼Œå¯ä»¥ç›´æ¥ç®€å•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\nhelmfile -f base-storage.yaml.gotmpl sync\n\n3.6.2 å¯¹æ¥å·²æœ‰çš„å­˜å‚¨æœåŠ¡ç¦ç”¨è“é²¸å†…ç½®æœåŠ¡ï¼Œé…ç½®ä½¿ç”¨å·²æœ‰æœåŠ¡ã€‚helmfile å®šä¹‰åŠ values æ–‡ä»¶å·²ç»æ”¾åœ¨gitlabä»“åº“ä¸Šç»´æŠ¤ã€‚\næ­¤å¤„å¯ç›´æ¥è·³è¿‡ã€‚\n3.7 éƒ¨ç½²åŸºç¡€å¥—é¤é€šè¿‡helmfileå®‰è£… base-blueking.yaml.gotmpl ï¼ŒæŒ‰ç…§é¡ºåºä¾æ¬¡å®‰è£…ã€‚å…·ä½“æ¯å±‚å®‰è£…çš„å†…å®¹å¯ä»¥æŸ¥çœ‹æ–‡ä»¶å†…å®¹ã€‚å‚è€ƒå®˜æ–¹æ–‡æ¡£å®‰è£…ï¼Œç›¸å…³helmé…ç½®å·²ç»æ”¾åœ¨gitlabä»“åº“ä¸Šç»´æŠ¤ï¼Œå¯ä»¥ç›´æ¥ç®€å•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\nhelmfile -f base-blueking.yaml.gotmpl -l seq=first synchelmfile -f base-blueking.yaml.gotmpl -l seq=second synchelmfile -f base-blueking.yaml.gotmpl -l seq=third sync# helmfile -f base-blueking.yaml.gotmpl -l seq=fourth sync\n\n3.8 è®¿é—®è“é²¸æ¡Œé¢åœ¨è´Ÿè½½å‡è¡¡å™¨é…ç½®åç«¯ä¸º ingress-nginx pod æ‰€åœ¨æœºå™¨çš„å†…ç½‘ IPï¼Œç«¯å£ä¸º 80ã€‚è¯¦ç»†ä¿¡æ¯å‚è€ƒæ–‡æ¡£ã€‚\n3.8.1 æŸ¥æ‰¾ingress nginx svcæ‰¾åˆ°ingress nginxçš„svc\n# popskubectl get svc -n kube-system|grep ingress# pops-devkubectl get svc -n ingress-nginx|grep ingress\n\nç»“æœï¼š\n# popsingress-nginx-controller-admission        ClusterIP      172.26.10.30    &lt;none&gt;          443/TCP                        3y69dnginx-ingress-lb                          LoadBalancer   172.26.1.155    10.212.14.158   80:30725/TCP,443:31357/TCP     3y69d# pops-devingress-nginx-controller             NodePort    172.27.124.109   &lt;none&gt;        80:32080/TCP,443:32443/TCP   279dingress-nginx-controller-admission   ClusterIP   172.27.123.38    &lt;none&gt;        443/TCP                      279dingress-nginx-controller-metrics     ClusterIP   172.27.116.175   &lt;none&gt;        10254/TCP                    279d\n\nè¿™é‡Œnginx-ingress-lbæ˜¯ç›®å‰popsé›†ç¾¤çš„ingress nginx svcï¼Œè€Œingress-nginx-controlleræ˜¯ç›®å‰pops-devé›†ç¾¤çš„ingress nginx svcã€‚\n3.8.2 è®¾ç½®svc typeä¸ºLoadBalanceræŸ¥çœ‹svc typeï¼š\n# æŸ¥çœ‹popsé›†ç¾¤ingress nginx svcå‘½ä»¤kubectl get svc/nginx-ingress-lb -n kube-system -oyaml|grep type# æŸ¥çœ‹pops-devé›†ç¾¤ingress nginx svcå‘½ä»¤kubectl get svc/ingress-nginx-controller -n ingress-nginx -oyaml|grep type\n\nè‹¥æ— type: LoadBalancerç»“æœï¼Œåˆ™æ‰‹åŠ¨è¿›è¡Œä¿®æ”¹ï¼š\n# ä¿®æ”¹popsé›†ç¾¤ingress nginx svcå‘½ä»¤kubectl edit svc/nginx-ingress-lb -n kube-system# ä¿®æ”¹pops-devé›†ç¾¤ingress nginx svcå‘½ä»¤kubectl edit svc/ingress-nginx-controller -n ingress-nginx\n\n3.8.3 è´Ÿè½½å‡è¡¡clbå®ä¾‹æŸ¥çœ‹svc yamlæ˜¯å¦åŒ…å«ä¸¤ä¸ªé‡è¦annotationï¼š\n# æŸ¥çœ‹popsé›†ç¾¤ingress nginx svcå‘½ä»¤kubectl get svc/nginx-ingress-lb -n kube-system -oyaml|grep service.beta.kubernetes.io/alibaba-cloud-loadbalancer-force-override-listenerskubectl get svc/nginx-ingress-lb -n kube-system -oyaml|grep service.beta.kubernetes.io/alibaba-cloud-loadbalancer-id# æŸ¥çœ‹pops-devé›†ç¾¤ingress nginx svcå‘½ä»¤kubectl get svc/ingress-nginx-controller -n ingress-nginx -oyaml|grep service.beta.kubernetes.io/alibaba-cloud-loadbalancer-force-override-listenerskubectl get svc/ingress-nginx-controller -n ingress-nginx -oyaml|grep service.beta.kubernetes.io/alibaba-cloud-loadbalancer-id\n\nè‹¥è¿™ä¸¤ä¸ªé‡è¦annotationç¼ºå¤±ï¼Œåˆ™éœ€è¿›è¡Œè®¾ç½®ã€‚\nè´Ÿè½½å‡è¡¡æ§åˆ¶å°åœ°å€ï¼šhttps://slb.console.aliyun.com/overview\næ‰¾åˆ°pops-devé›†ç¾¤çš„clbï¼špops-k8s-dev-ingress\næ‰¾åˆ°popsé›†ç¾¤çš„clbï¼šk8s-pops-ingress-slb\n# ä¿®æ”¹popsé›†ç¾¤ingress nginx svcå‘½ä»¤# popsé›†ç¾¤clbåç§°ï¼šk8s-pops-ingress-slb# popsé›†ç¾¤clb idï¼šlb-bp1tt6vxctuzi38mqfkw0kubectl edit svc/nginx-ingress-lb -n kube-system# ä¿®æ”¹pops-devé›†ç¾¤ingress nginx svcå‘½ä»¤# pops-devé›†ç¾¤clbåç§°ï¼špops-k8s-dev-ingress# pops-devé›†ç¾¤clb idï¼šlb-bp1r1dsywnqktp1hxih38kubectl edit svc/ingress-nginx-controller -n ingress-nginx\n\n3.8.4 è®¿é—®åœ°å€æŸ¥çœ‹æµè§ˆå™¨è®¿é—®åœ°å€ï¼š\ncd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•# ä»è‡ªå®šä¹‰é…ç½®ä¸­æå–BK_DOMAIN=$(yq e &#x27;.domain.bkDomain&#x27; environments/default/custom.yaml)  # æ™®é€šç™»å½•åœ°å€(æ¥å…¥ç»Ÿä¸€ç™»å½•ï¼Œä¸”ç™»å½•æˆåŠŸåä¼šè·³è½¬è“ç›¾)echo &quot;http://$BK_DOMAIN&quot;# adminç™»å½•åœ°å€(æ¥å…¥ç»Ÿä¸€ç™»å½•åï¼Œå¯é€šè¿‡æ­¤æ–¹æ³•é€‚ç”¨adminç™»å½•)echo &quot;http://$&#123;BK_DOMAIN&#125;/login/origin/&quot;# æµ‹è¯•ç¯å¢ƒä¸€èˆ¬ç»“æœä¸ºï¼šhttp://bkce.diezhi.net/login/origin/# ç”Ÿäº§ç¯å¢ƒä¸€èˆ¬ç»“æœä¸ºï¼šhttps://bk.diezhi.net/login/origin/# æŸ¥çœ‹ç”¨æˆ·å¯†ç (é¢„è®¾åŸå§‹å¯†ç )ï¼škubectl get cm -n blueking bk-user-api-general-envs -o go-template=&#x27;user=&#123;&#123;.data.INITIAL_ADMIN_USERNAME&#125;&#125;&#123;&#123;&quot;\\n&quot;&#125;&#125;password=&#123;&#123; .data.INITIAL_ADMIN_PASSWORD &#125;&#125;&#123;&#123;&quot;\\n&quot;&#125;&#125;&#x27;\n\n3.9 å¯¹æ¥LdapæœåŠ¡åœ¨ç”¨æˆ·ä¸­å¿ƒé‡Œé…ç½®Ldapç›¸å…³é…ç½®ï¼Œç„¶åæ›´æ–° bk-user-api-web æœåŠ¡çš„é•œåƒã€‚\n4. éƒ¨ç½²è“ç›¾å‚è€ƒå®˜æ–¹æ–‡æ¡£éƒ¨ç½²ï¼Œé…ç½® custom values çš„å†…å®¹æå‰ä¿®æ”¹å®Œæˆï¼Œæ‰§è¡Œç±»ä¼¼éƒ¨ç½²åŸºç¡€æœåŠ¡çš„ä»¥ä¸‹å‘½ä»¤ï¼š\ncd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•helmfile -f 03-bkci.yaml.gotmpl sync  # éƒ¨ç½²helmfile -f 03-bkci.yaml.gotmpl apply # æ›´æ–°\nå‰©ä¸‹çš„æ­¥éª¤å‚è€ƒå®˜æ–¹æ–‡æ¡£æ‰§è¡Œå³å¯ï¼Œä¸»è¦æ­¥éª¤æœ‰ä»¥ä¸‹ä¸‰ä¸ªï¼Œå…¶ä»–çš„æ­¥éª¤å¯ä»¥ä¸åšã€‚\n4.1 [å¯é€‰]æ³¨å†Œé»˜è®¤æ„å»ºé•œåƒæˆ‘ä»¬æä¾›äº† bkci&#x2F;ci é•œåƒç”¨äºæä¾›æ„å»ºç¯å¢ƒã€‚ä¸ºäº†åŠ é€Ÿé•œåƒä¸‹è½½è¿‡ç¨‹ï¼Œå¯ä»¥ä¿®æ”¹é•œåƒåœ°å€ä¸º hub.bktencent.com&#x2F;bkci&#x2F;ciï¼Œæˆ–è€…ä¸ºä½ è‡ªå·±æ‰˜ç®¡çš„å†…ç½‘ registryã€‚\nkubectl exec -it -n blueking bk-ci-mysql-0 -- /bin/bash -c &#x27;MYSQL_PWD=&quot;$MYSQL_ROOT_PASSWORD&quot; mysql -u root -e &quot;USE devops_ci_store; SELECT IMAGE_NAME,IMAGE_CODE,IMAGE_REPO_NAME FROM T_IMAGE WHERE IMAGE_CODE = \\&quot;bkci\\&quot; ;&quot;&#x27;\n\nè¯·æ ¹æ®ç»“æœè¿›è¡Œæ“ä½œï¼š\n\nå¦‚æœæœ‰æ˜¾ç¤ºé•œåƒæ•°æ®ï¼Œå¯ä»¥ä¿®æ”¹é•œåƒåœ°å€ä¸ºè“é²¸å›½å†…ä»“åº“ï¼Œä¹Ÿå¯æ”¹ä¸ºä½ å·²ç»ç¼“å­˜åœ¨å†…ç½‘çš„é•œåƒï¼š\nkubectl exec -it -n blueking bk-ci-mysql-0 -- /bin/bash -c &#x27;MYSQL_PWD=&quot;$MYSQL_ROOT_PASSWORD&quot; mysql -u root -e &quot;USE devops_ci_store; UPDATE  T_IMAGE SET IMAGE_REPO_NAME=\\&quot;hub.bktencent.com/bkci/ci\\&quot; WHERE IMAGE_CODE = \\&quot;bkci\\&quot; ;&quot;&#x27;\n\nç„¶åé‡æ–°æŸ¥è¯¢æ•°æ®åº“ï¼Œå¯ä»¥çœ‹åˆ° IMAGE_REPO_NAME åˆ—å·²ç»æ›´æ–°ã€‚\n\nå¦‚æœæ²¡æœ‰é•œåƒï¼Œå¯ä»¥æ–°å¢ï¼š\nkubectl exec -n blueking deploy/bk-ci-bk-ci-store -- \\curl -vs http://bk-ci-bk-ci-store.blueking.svc.cluster.local/api/op/market/image/init -X POST \\-H &#x27;X-DEVOPS-UID: admin&#x27; -H &#x27;Content-type: application/json&#x27; -d &#x27;&#123;&quot;imageCode&quot;:&quot;bkci&quot;,&quot;imageName&quot;:&quot;bkci&quot;,&quot;imageRepo&quot;:&quot;hub.bktencent.com/bkci/ci&quot;,&quot;projectCode&quot;:&quot;demo&quot;,&quot;userId&quot;:&quot;admin&quot;&#125;&#x27; | jq .\n\n\n\næç¤º\nå½“ä½ å•ç‹¬å¸è½½è“ç›¾é‡è£…åï¼Œå¯èƒ½å‡ºç°æŸ¥è¯¢é•œåƒä¸ºç©ºï¼Œä½†æ˜¯æ–°å¢é•œåƒæ—¶æŠ¥é”™ { status: 400, message: â€œæƒé™ä¸­å¿ƒåˆ›å»ºé¡¹ç›®å¤±è´¥â€ } çš„æƒ…å†µã€‚è¿™æ˜¯å› ä¸ºæƒé™ä¸­å¿ƒå­˜åœ¨è“ç›¾ demo é¡¹ç›®çš„æ•°æ®æ‰€è‡´ï¼Œæˆ‘ä»¬åç»­ä¼šä¼˜åŒ–è“ç›¾å•ç‹¬å¸è½½çš„æ–‡æ¡£ã€‚è¯·å…ˆæ‰‹åŠ¨æ–°å»ºé¡¹ç›®ï¼Œå¹¶ä¿®æ”¹ä¸Šè¿°ä»£ç ä¸­ projectCode å­—æ®µçš„å€¼ã€‚\n\n\n4.1.1 è§£å†³æƒé™ä¸­å¿ƒåˆ›å»ºé¡¹ç›®å¤±è´¥åœ¨ ä¸­æ§æœº æ‰§è¡Œï¼š\ncd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•./scripts/control_coredns.sh list  # æ£€æŸ¥æ·»åŠ çš„è®°å½•ã€‚\n\nä¼šå¾—åˆ°ç±»ä¼¼çš„ç»“æœï¼š\n172.27.124.109 devops.bkce.diezhi.net172.27.124.109 bkce.diezhi.net172.27.124.109 bkrepo.bkce.diezhi.net172.27.124.109 docker.bkce.diezhi.net172.27.124.109 bkapi.bkce.diezhi.net172.27.124.109 bkpaas.bkce.diezhi.net172.27.124.109 bkiam-api.bkce.diezhi.net172.27.124.109 bkiam.bkce.diezhi.net172.27.124.109 apps.bkce.diezhi.net172.27.124.109 bknodeman.bkce.diezhi.net172.27.124.109 job.bkce.diezhi.net172.27.124.109 jobapi.bkce.diezhi.net\n\nä½¿ç”¨adminè´¦å·é€šè¿‡æµè§ˆå™¨è®¿é—®devops.bkce.diezhi.netï¼Œå¹¶åˆ›å»ºé¡¹ç›®ï¼š\n\n\næ­¤æ—¶é‡æ–°æ–°å¢ï¼š\nkubectl exec -n blueking deploy/bk-ci-bk-ci-store -- \\curl -vs http://bk-ci-bk-ci-store.blueking.svc.cluster.local/api/op/market/image/init -X POST \\-H &#x27;X-DEVOPS-UID: admin&#x27; -H &#x27;Content-type: application/json&#x27; -d &#x27;&#123;&quot;imageCode&quot;:&quot;bkci&quot;,&quot;imageName&quot;:&quot;bkci&quot;,&quot;imageRepo&quot;:&quot;hub.bktencent.com/bkci/ci&quot;,&quot;projectCode&quot;:&quot;huari-demo&quot;,&quot;userId&quot;:&quot;admin&quot;&#125;&#x27; | jq .\n\nå¦‚æ–°å»ºé¡¹ç›®é‡è§å¯æˆæƒäººå‘˜èŒƒå›´åŠ è½½ä¸å‡ºæ¥(ç™½å±è½¬åœˆåœˆ)\néœ€è¦ç¡®å®šè·³è½¬ä»è“é²¸è·³è½¬è“ç›¾æ˜¯å¦æ˜¯èµ°äº†httpsï¼Œæœ¬æ–‡æ¡£æ˜¯ä½¿ç”¨httpéƒ¨ç½²ï¼Œæ‰€ä»¥ä½¿ç”¨httpsä¼šå‡ºç°é—®é¢˜\n4.2 [å¯è·³è¿‡]å¯¹æ¥åˆ¶å“åº“è“ç›¾ä¾é è“é²¸åˆ¶å“åº“æ¥æä¾›æµæ°´çº¿ä»“åº“å’Œè‡ªå®šä¹‰ä»“åº“ï¼Œéœ€è¦è°ƒæ•´åˆ¶å“åº“çš„è®¤è¯æ¨¡å¼ã€‚\nå½“ bk-ci release æˆåŠŸå¯åŠ¨åï¼Œæˆ‘ä»¬å¼€å§‹é…ç½®è“é²¸åˆ¶å“åº“ï¼Œå¹¶æ³¨å†Œåˆ°è“ç›¾ä¸­ã€‚\n4.2.1 ä¿®æ”¹ bk-repo custom valuesç›¸å…³é…ç½®å·²ç»æ”¾åœ¨gitlabä»“åº“ä¸Šç»´æŠ¤ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡æœ¬æ­¥éª¤ã€‚\n[å¯è·³è¿‡]è¯·åœ¨ ä¸­æ§æœº æ‰§è¡Œï¼š\ncd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•case $(yq e &#x27;.auth.config.realm&#x27; environments/default/bkrepo-custom-values.yaml.gotmpl 2&gt;/dev/null) in  null|&quot;&quot;)    tee -a environments/default/bkrepo-custom-values.yaml.gotmpl &lt;&lt;&lt; $&#x27;auth:\\n  config:\\n    realm: devops&#x27;  ;;  devops)    echo &quot;environments/default/bkrepo-custom-values.yaml.gotmpl ä¸­é…ç½®äº† .auth.config.realm=devops, æ— éœ€ä¿®æ”¹.&quot;  ;;  *)    echo &quot;environments/default/bkrepo-custom-values.yaml.gotmpl ä¸­é…ç½®äº† .auth.config.realm ä¸ºå…¶ä»–å€¼, è¯·æ‰‹åŠ¨ä¿®æ”¹å€¼ä¸º devops.&quot;  ;;esac\n\n[å¯è·³è¿‡]ä¿®æ”¹æˆåŠŸåï¼Œç»§ç»­åœ¨å·¥ä½œç›®å½•æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ä½¿ä¿®æ”¹ç”Ÿæ•ˆï¼š\nhelmfile -f base-blueking.yaml.gotmpl -l name=bk-repo apply\n\n4.2.2 æ£€æŸ¥é…ç½®æ˜¯å¦ç”Ÿæ•ˆæ£€æŸ¥ release ç”Ÿæ•ˆçš„ values å’Œ configmap æ˜¯å¦é‡æ–°æ¸²æŸ“ã€‚\n[å¯è·³è¿‡]è¯·åœ¨ ä¸­æ§æœº æ‰§è¡Œï¼š\nhelm get values -n blueking bk-repo | yq e &#x27;.auth.config.realm&#x27;kubectl get cm -n blueking bk-repo-bkrepo-auth -o json | jq -r &#x27;.data.&quot;application.yml&quot;&#x27; | yq e &#x27;.auth.realm&#x27; -\n\n4.2.3 é‡å¯ bk-repo auth å¾®æœåŠ¡å› ä¸ºå¯¹æ¥åˆ¶å“åº“çš„ç›¸å…³ä¿¡æ¯å·²ç»åœ¨gitlabä»“åº“ä¸Šç»´æŠ¤äº†ï¼Œæ‰€ä»¥æ­¤å¤„ä¸ç”¨è¿›è¡Œé‡å¯ã€‚\n[å¯è·³è¿‡]å› ä¸º deployment æ²¡æœ‰å˜åŠ¨ï¼Œæ‰€ä»¥ä¸ä¼šè‡ªåŠ¨é‡å¯ï¼Œæ­¤å¤„éœ€è¦å•ç‹¬é‡å¯ï¼š\nkubectl rollout restart deployment -n blueking bk-repo-bkrepo-auth\n\n4.2.4 åœ¨è“ç›¾ä¸­æ³¨å†Œåˆ¶å“åº“[å¯è·³è¿‡]è¯·åœ¨ ä¸­æ§æœº æ‰§è¡Œï¼š\ncd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•BK_DOMAIN=$(yq e &#x27;.domain.bkDomain&#x27; environments/default/custom.yaml)  # ä»è‡ªå®šä¹‰é…ç½®ä¸­æå–, ä¹Ÿå¯è‡ªè¡Œèµ‹å€¼# å‘projectå¾®æœåŠ¡æ³¨å†Œåˆ¶å“åº“kubectl exec -i -n blueking deploy/bk-ci-bk-ci-project -- curl -sS -X PUT -H &#x27;Content-Type: application/json&#x27; -H &#x27;Accept: application/json&#x27; -H &#x27;X-DEVOPS-UID: admin&#x27; -d &quot;&#123;\\&quot;showProjectList\\&quot;:true,\\&quot;showNav\\&quot;:true,\\&quot;status\\&quot;:\\&quot;ok\\&quot;,\\&quot;deleted\\&quot;:false,\\&quot;iframeUrl\\&quot;:\\&quot;//bkrepo.$BK_DOMAIN/ui/\\&quot;&#125;&quot; &quot;http://bk-ci-bk-ci-project.blueking.svc.cluster.local/api/op/services/update/Repo&quot;\n\n4.3 [å¯é€‰]ä¸‹è½½å’Œä¸Šä¼ æ’ä»¶4.3.1 ä¸‹è½½æ’ä»¶è¯·åœ¨ ä¸­æ§æœº æ‰§è¡Œï¼š\nbkdl-7.1-stable.sh -ur latest ci-plugins\n\n4.3.2 ä¸Šä¼ æ’ä»¶æ­¤æ“ä½œåªèƒ½æ–°å»ºæ’ä»¶ï¼Œæ¯ä¸ªæ’ä»¶åªèƒ½ä¸Šä¼ ä¸€æ¬¡ã€‚\ncd ~/bkce7.1-install/blueking/  # è¿›å…¥å·¥ä½œç›®å½•for f in ../ci-plugins/*.zip; do    atom=&quot;$&#123;f##*/&#125;&quot;    atom=$&#123;atom%.zip&#125;    echo &gt;&amp;2 &quot;upload $atom from $f&quot;    kubectl exec -i -n blueking deploy/bk-ci-bk-ci-store -- \\      curl -s \\      http://bk-ci-bk-ci-store.blueking.svc.cluster.local/api/op/pipeline/atom/deploy/&quot;?publisher=admin&quot; \\      -H &#x27;X-DEVOPS-UID: admin&#x27; -F atomCode=$atom -F file=@- &lt; &quot;$f&quot; | jq .      # è®¾ç½®ä¸ºé»˜è®¤æ’ä»¶ï¼Œå…¨éƒ¨é¡¹ç›®å¯è§ã€‚    kubectl exec -n blueking deploy/bk-ci-bk-ci-store -- \\    curl -s http://bk-ci-bk-ci-store.blueking.svc.cluster.local/api/op/pipeline/atom/default/atomCodes/$atom \\-H &#x27;X-DEVOPS-UID: admin&#x27; -X POST | jq .done\n\n4.3.3 é—®é¢˜åŠè§£å†³æ–¹æ¡ˆè¿™ä¸ªé—®é¢˜å·²ç»åœ¨è“ç›¾çš„helm chartsé‡Œé¢è¿›è¡Œäº†ä¼˜åŒ–\nä¸Šä¼ æ’ä»¶æ—¶ä¼šç¢°åˆ°è¿™ä¸ªé—®é¢˜ï¼š\nè“ç›¾å®˜æ–¹æ–‡æ¡£è¯´æ³•æ˜¯ï¼š\nå®é™…åŸå› æ˜¯ï¼šHTTPè¯·æ±‚æŠ¥äº† 413 Request Entity Too Large\nå…·ä½“è§£å†³æ–¹å¼è¯¦è§ï¼šIngress åŸŸåæ–¹å¼å¯¼è‡´413 Request Entity Too Large-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº\né€ æˆè¿™ä¸ªé—®é¢˜çš„ä¸»è¦åŸå› æ˜¯nginx-ingressçš„é»˜è®¤é…ç½®ä¸­proxy-body-sizeçš„æ•°å€¼å¤ªå°\n5. æ”¯æŒhttpså¦‚æœå¼€å§‹å°±å‡†å¤‡å¥½äº†ç›¸å…³è¯ä¹¦ï¼Œé‚£ä¹ˆå¯ä»¥å°†è¯¥æ­¥éª¤æå‰ï¼Œåœ¨éƒ¨ç½²åŸºç¡€æœåŠ¡å’Œè“ç›¾ä¹‹å‰å°±å…ˆä¿®æ”¹å¥½ç›¸å…³çš„yamlï¼Œå°†éœ€è¦åˆ›å»ºçš„Secretå’Œè¦æ›´æ–°çš„Ingressé…ç½®éƒ½æå‰ä¿®æ”¹å¥½ï¼Œç„¶åç›´æ¥éƒ¨ç½²å³å¯ã€‚\n5.1 è´­ä¹°ç›¸å…³è¯ä¹¦æ¶‰åŠçš„åŸŸåï¼šbk.blazehu.comã€*.bk.blazehu.comï¼ˆå¦‚devops.bk.blazehu.comï¼‰ã€‚éœ€è´­ä¹°æ³›åŸŸåè¯ä¹¦ã€‚\n5.2 åˆ›å»ºç›¸å…³Secretï¼ˆç”¨äºå­˜å‚¨TLSè¯ä¹¦å’Œç§é’¥ï¼‰# åˆ›å»ºSecretBK_DOMAIN=$(yq e &#x27;.domain.bkDomain&#x27; environments/default/custom.yaml)cd $HOME/$BK_DOMAINkubectl create secret tls $BK_DOMAIN -n blueking --cert=$HOME/$BK_DOMAIN/$BK_DOMAIN.pem --key=$HOME/$BK_DOMAIN/$BK_DOMAIN.keyâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”æœ¬æ–‡é“¾æ¥ï¼šhttps://blazehu.com/2024/05/24/devops/landun_install/ç‰ˆæƒå£°æ˜ï¼š æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ CC BY 4.0 CNåè®® è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼\n\n5.3 æ›´æ–° Ingress TLSåœ¨è¯ä¹¦åŠè¯ä¹¦secretå‡†å¤‡å¥½ä¹‹åï¼Œéœ€è¦å˜æ›´è“é²¸ç³»åˆ—ingresså¼€å¯tlsçš„æ”¯æŒï¼Œæ‰§è¡Œå¯¹åº”çš„è„šæœ¬\n#!/bin/bash# é…ç½®å˜é‡NAMESPACE=&quot;blueking&quot;DOMAIN_FILE=&quot;environments/default/custom.yaml&quot;BK_DOMAIN=$(yq e &#x27;.domain.bkDomain&#x27; &quot;$DOMAIN_FILE&quot;)  # ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–åŸŸåTLS_HOST=&quot;*.$BK_DOMAIN&quot;  # æ³›åŸŸåTLS_SECRET=&quot;$BK_DOMAIN&quot;  # Secret åç§°ä¸åŸŸåä¸€è‡´# æ£€æŸ¥åŸŸåå’Œ Secret æ˜¯å¦æ­£ç¡®if [[ -z &quot;$BK_DOMAIN&quot; ]]; then  echo &quot;Error: BK_DOMAIN is not set in $DOMAIN_FILE.&quot;  exit 1fi# è·å–å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰ Ingress èµ„æºingresses=$(kubectl get ingress -n &quot;$NAMESPACE&quot; -o jsonpath=&#x27;&#123;.items[*].metadata.name&#125;&#x27;)# éå†æ‰€æœ‰ Ingress èµ„æºå¹¶æ›´æ–° TLS é…ç½®for ingress in $ingresses; do  echo &quot;Updating Ingress: $ingress in namespace: $NAMESPACE&quot;    # æ£€æŸ¥ Ingress æ˜¯å¦å·²å­˜åœ¨ TLS é…ç½®  if kubectl get ingress &quot;$ingress&quot; -n &quot;$NAMESPACE&quot; -o jsonpath=&#x27;&#123;.spec.tls&#125;&#x27; | grep -q &quot;$TLS_HOST&quot;; then    echo &quot;TLS configuration for $TLS_HOST already exists in Ingress $ingress. Skipping.&quot;    continue  fi  # æ›´æ–° Ingress çš„ TLS é…ç½®  kubectl patch ingress &quot;$ingress&quot; -n &quot;$NAMESPACE&quot; --type=json -p=&#x27;[    &#123;      &quot;op&quot;: &quot;add&quot;,      &quot;path&quot;: &quot;/spec/tls&quot;,      &quot;value&quot;: [        &#123;          &quot;hosts&quot;: [&quot;&#x27;&quot;$TLS_HOST&quot;&#x27;&quot;],          &quot;secretName&quot;: &quot;&#x27;&quot;$TLS_SECRET&quot;&#x27;&quot;        &#125;      ]    &#125;  ]&#x27; || &#123; echo &quot;Failed to update Ingress $ingress&quot;; exit 1; &#125;  echo &quot;Updated Ingress $ingress with TLS configuration for $TLS_HOST.&quot;doneecho &quot;All Ingress resources in namespace $NAMESPACE have been updated with TLS configuration for $TLS_HOST.&quot;\n\n5.4 é…ç½®è“é²¸å¯ç”¨HTTPSåœ¨gitä»“åº“ç»´æŠ¤ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªå˜æ›´ï¼š\nenvironments&#x2F;default&#x2F;custom.yaml: .bkDomainScheme å€¼è®¾ç½®ä¸º httpsenvironments&#x2F;default&#x2F;bkci&#x2F;bkci-custom-values.yaml.gotmpl: .config.bkHttpSchema å€¼è®¾ç½®ä¸º https\nyq -i &#x27;.bkDomainScheme = &quot;https&quot;&#x27; environments/default/custom.yaml# å°†bkHttpSchema: httpsæ›¿æ¢ä¸ºbkHttpSchema: httpsed -i &#x27;s|bkHttpSchema: http|bkHttpSchema: https|&#x27; environments/default/bkci/bkci-custom-values.yaml.gotmpl\n\n5.5 æ„å»ºæœºAgenté…ç½®å˜æ›´åŠé‡å¯# åœæ­¢agentæœåŠ¡./stop.shBK_DOMAIN=&quot;deveops.bk.blazehu.com&quot;# ä¿®æ”¹.agent.propertiesæ–‡ä»¶ï¼Œå¼€å¯httpssed -i &#x27;&#x27; &#x27;s|http://$BK_DOMAIN|https://$BK_DOMAIN|g&#x27; .agent.properties# ä¿®æ”¹telegraf.confæ–‡ä»¶ï¼Œå¼€å¯httpssed -i &#x27;&#x27; &#x27;s|http://$BK_DOMAIN|https://$BK_DOMAIN|g&#x27; telegraf.conf# å¯åŠ¨agent./start.sh# è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œä»”ç»†æŸ¥çœ‹.agent.propertiesé‡Œdevops.agent.userï¼Œ è¿™é‡Œæ˜¯å“ªä¸ªç”¨æˆ·å°±ç”¨å“ªä¸ªç”¨æˆ·å¯åŠ¨agent","categories":["devops/blueking"],"tags":["devops","blueking"]},{"title":"è“ç›¾ã€ŒDockerå…¬å…±æ„å»ºæœºã€å…¨é“¾è·¯æºç è§£æ","url":"/2025/08/devops/blueking/lan-dun-docker-gong-gong-gou-jian-ji-quan-lian-lu-yuan-ma-jie-xi/","content":"èƒŒæ™¯æœ¬æ–‡ä»¥è“ç›¾ç¤¾åŒºç‰ˆ7.1ä¸ºä¾‹ï¼Œç»“åˆå®é™…æºç å’Œé…ç½®ï¼Œè¯¦ç»†æ¢³ç†ä»å‰ç«¯ç‚¹å‡»ã€Œæ‰§è¡Œã€åˆ°æœ€ç»ˆåœ¨ Kubernetes é›†ç¾¤æ‹‰èµ· Deployment çš„å…¨é“¾è·¯è°ƒç”¨è¿‡ç¨‹ï¼Œ\nç›®å½•ç»“æ„bk-ci/srcâ”œâ”€â”€ gateway          # OpenResty ç½‘å…³ï¼ˆLuaï¼‰â”œâ”€â”€ frontend         # Vue å‰ç«¯ï¼Œæ¨¡å—çº§å¾®å‰ç«¯â”œâ”€â”€ backend          # Kotlin + SpringCloud å¾®æœåŠ¡â”‚   â”œâ”€â”€ process      # æµæ°´çº¿å¼•æ“â”‚   â”œâ”€â”€ dispatch     # æ„å»ºè°ƒåº¦ï¼ˆDocker &amp; K8sï¼‰â”‚   â””â”€â”€ ...â”œâ”€â”€ agent            # Go è¯­è¨€ Agentâ””â”€â”€ pipeline-plugin  # Java æ’ä»¶ SDK\n\næºç æ‹†è§£å‰ç«¯è§¦å‘é¡µé¢åœ°å€ï¼šhttps://devops.bk.tencent.com/console/pipeline/{projectId}/{pipelineId}/preview\n\n\n\näº‹ä»¶&#x2F;æ–¹æ³•\nå¯¹åº”åç«¯æ¥å£\nä½œç”¨\n\n\n\nrequestStartupInfo\nGET &#x2F;ms&#x2F;process&#x2F;api&#x2F;user&#x2F;builds&#x2F;{p}&#x2F;{pl}&#x2F;manualStartupInfo\nè·å–æµæ°´çº¿å¯åŠ¨æ‰€éœ€å‚æ•°\n\n\nexecutePipeline\nPOST &#x2F;ms&#x2F;process&#x2F;api&#x2F;user&#x2F;builds&#x2F;{p}&#x2F;{pl}\nçœŸæ­£è§¦å‘æµæ°´çº¿æ‰§è¡Œ\n\n\n\né€šè¿‡å…¨å±€äº‹ä»¶æ€»çº¿ bus é€šä¿¡ï¼Œä»¥åŠå…·åè§†å›¾ï¼ˆnamed viewsï¼‰æœºåˆ¶å®ç°é¡µé¢æ‹†åˆ†å’Œç»„åˆã€‚åœ¨ preview.vue é¡µé¢ç›‘å¬ executePipeline äº‹ä»¶ï¼Œç„¶ååœ¨ PreviewHeader.vue ä¸­é€šè¿‡äº‹ä»¶æ€»çº¿è§¦å‘æ‰§è¡Œã€‚\n\nç½‘å…³è½¬å‘&#x2F;ms&#x2F;process&#x2F;api&#x2F;user&#x2F;builds&#x2F;â€¦ ç»Ÿä¸€è½¬å‘åˆ° process å¾®æœåŠ¡ã€‚\nlocation /ms/process/ &#123;    proxy_pass http://process/;&#125;\n\nProcess æœåŠ¡ï¼šæµæ°´çº¿å¯åŠ¨ä¸»é“¾è·¯ä¸»è¦æ–¹æ³•è°ƒç”¨é“¾å¦‚ä¸‹ï¼š\nUserBuildResource.manualStartup()                // æ¥æ”¶å¯åŠ¨æµæ°´çº¿çš„è¯·æ±‚    â†“ServiceBuildResourceImpl.manualStartup()         // å…·ä½“å®ç°ï¼Œåšå‚æ•°æ ¡éªŒã€æƒé™æ ¡éªŒç­‰    â†“PipelineBuildFacadeService.buildManualStartup()  // è´Ÿè´£ç»„è£…å¯åŠ¨å‚æ•°ã€è°ƒç”¨æ ¸å¿ƒæœåŠ¡    â†“PipelineBuildService.startPipeline()             // å¯åŠ¨æµæ°´çº¿ä¸»æµç¨‹ï¼Œè´Ÿè´£æµæ°´çº¿çŠ¶æ€æµè½¬ã€è®°å½•ç­‰    â†“PipelineRuntimeService.startBuild()              // æµæ°´çº¿å¼•æ“ï¼Œè§£ææ¨¡å‹ï¼Œè°ƒåº¦ Stage/Job/Containerï¼Œå‡†å¤‡æ„å»ºä»»åŠ¡\nè¿™ä¸€é˜¶æ®µä¸»è¦è´Ÿè´£æ¥æ”¶å‰ç«¯çš„å¯åŠ¨è¯·æ±‚ï¼Œç»è¿‡å‚æ•°æ ¡éªŒã€æƒé™æ ¡éªŒåï¼Œç»„è£…å¯åŠ¨å‚æ•°ï¼Œæœ€ç»ˆè¿›å…¥æµæ°´çº¿å¼•æ“ã€‚æµæ°´çº¿å¼•æ“ä¼šè§£ææµæ°´çº¿çš„æ¨¡å‹ï¼ˆYAML&#x2F;DSLï¼‰ï¼Œä¸ºåç»­çš„è°ƒåº¦å’Œä»»åŠ¡å‡†å¤‡åšé“ºå«ã€‚\nç”Ÿæˆå¹¶ä¸‹å‘æ„å»ºä»»åŠ¡ä¸»è¦æ–¹æ³•è°ƒç”¨é“¾å¦‚ä¸‹ï¼š\nPipelineContainerService.prepareBuildContainerTasks()      // éå†æµæ°´çº¿æ¨¡å‹ï¼Œä¸ºæ¯ä¸ª Job/Container ç”Ÿæˆä»»åŠ¡ï¼Œåˆ¤æ–­åˆ†å‘ç±»å‹    â†“VmOperateTaskGenerator.makeStartVMContainerTask()          // é’ˆå¯¹å®¹å™¨æ„å»ºæœºï¼Œç”Ÿæˆ VM å¯åŠ¨ä»»åŠ¡ï¼ˆtaskAtom = &quot;dispatchVMStartupTaskAtom&quot;ï¼‰    â†“pipelineEventDispatcher.dispatch(PipelineBuildStartEvent()) // ä¸‹å‘æµæ°´çº¿å¯åŠ¨äº‹ä»¶\n\næ­¤é˜¶æ®µä¼šéå†æµæ°´çº¿æ¨¡å‹ä¸­çš„æ¯ä¸ª Job&#x2F;Containerï¼Œæ ¹æ®å…¶ç±»å‹ï¼ˆå¦‚å®¹å™¨æ„å»ºæœºï¼‰ç”Ÿæˆå¯¹åº”çš„ä»»åŠ¡ã€‚å¯¹äºå®¹å™¨æ„å»ºæœºï¼Œä¼šç”Ÿæˆ VM å¯åŠ¨ä»»åŠ¡ï¼Œå¹¶é€šè¿‡äº‹ä»¶åˆ†å‘å™¨ä¸‹å‘æµæ°´çº¿å¯åŠ¨äº‹ä»¶ï¼Œä¸ºåç»­çš„äº‹ä»¶é©±åŠ¨è°ƒåº¦åšå‡†å¤‡ã€‚\näº‹ä»¶é©±åŠ¨ï¼šStage&#x2F;Container&#x2F;Task è°ƒåº¦ä¸»è¦æ–¹æ³•è°ƒç”¨é“¾å¦‚ä¸‹ï¼š\nPipelineBuildStartListener.run(event)                      // æ¶ˆè´¹ PipelineBuildStartEventï¼Œé©±åŠ¨æµæ°´çº¿è°ƒåº¦    â†“BuildStartControl.handle(event)    â†“PipelineBuildStartEvent.execute(watcher)    â†“buildModel()    â†“pipelineEventDispatcher.dispatch(PipelineBuildStageEvent()) // ä¸‹å‘ Stage äº‹ä»¶PipelineStageBuildListener.run(event)                      // æ¶ˆè´¹ PipelineBuildStageEvent    â†“StageControl.handle(event)    â†“PipelineBuildStageEvent.execute(watcher)    â†“pipelineContainerService.listContainers(...)               // éå†å½“å‰ Stage ä¸‹æ‰€æœ‰ Containerï¼ˆJobï¼‰    â†“pipelineEventDispatcher.dispatch(PipelineBuildContainerEvent()) // ä¸ºæ¯ä¸ª Job ä¸‹å‘äº‹ä»¶PipelineContainerBuildListener.run(event)                  // æ¶ˆè´¹ PipelineBuildContainerEvent    â†“ContainerControl.handle(event)    â†“ContainerCmdChain.doCommand(context)                       // å‘½ä»¤é“¾æ‰§è¡Œï¼Œå…³é”®å‘½ä»¤ StartActionTaskContainerCmd    â†“pipelineEventDispatcher.dispatch(PipelineBuildAtomTaskEvent()) // ä¸‹å‘æ’ä»¶ä»»åŠ¡äº‹ä»¶\nè“ç›¾é‡‡ç”¨äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œæ¯ä¸ªé˜¶æ®µï¼ˆStageï¼‰ã€æ¯ä¸ª Jobï¼ˆContainerï¼‰ã€æ¯ä¸ªæ’ä»¶ï¼ˆTaskï¼‰éƒ½é€šè¿‡äº‹ä»¶è¿›è¡Œè°ƒåº¦ã€‚æ¯ä¸ªäº‹ä»¶éƒ½æœ‰å¯¹åº”çš„ Listener æ¶ˆè´¹ï¼Œé€æ­¥æ¨è¿›æµæ°´çº¿çš„æ‰§è¡Œæµç¨‹ï¼Œä¿è¯äº†ç³»ç»Ÿçš„é«˜è§£è€¦å’Œå¯æ‰©å±•æ€§ã€‚\næ’ä»¶ä»»åŠ¡è°ƒåº¦ä¸ VM å¯åŠ¨ä¸»è¦æ–¹æ³•è°ƒç”¨é“¾å¦‚ä¸‹ï¼š\nPipelineAtomTaskBuildListener.run(event)                   // æ¶ˆè´¹ PipelineBuildAtomTaskEvent    â†“TaskControl.handle(event)    â†“taskAtomService.start(buildTask)    â†“SpringContextUtil.getBean(IAtomTask::class.java, task.taskAtom).execute(task, runVariables)    â†“DispatchVMStartupTaskAtom.execute()                        // å¯¹äº VM å¯åŠ¨ä»»åŠ¡ï¼ŒåŠ è½½å¹¶æ‰§è¡Œ    â†“dispatch()    â†“getDispatchType()                                          // è¿”å› DockerDispatchTypeï¼ˆç¤¾åŒºç‰ˆå®¹å™¨æ„å»ºæœºé»˜è®¤ï¼‰    â†“pipelineEventDispatcher.dispatch(PipelineAgentStartupEvent()) // ä¸‹å‘åˆ†å‘äº‹ä»¶\n\næ¯ä¸ªæ’ä»¶ä»»åŠ¡ï¼ˆAtomï¼‰éƒ½ä¼šè¢«åŠ¨æ€åŠ è½½å¹¶æ‰§è¡Œã€‚å¯¹äº VM å¯åŠ¨ä»»åŠ¡ï¼Œä¼šåŠ è½½ DispatchVMStartupTaskAtom æ’ä»¶ï¼Œåˆ¤æ–­åˆ†å‘ç±»å‹ï¼ˆå¦‚ Dockerï¼‰ï¼Œå¹¶ä¸‹å‘ PipelineAgentStartupEventï¼Œä¸ºåç»­çš„æ„å»ºæœºåˆ†å‘åšå‡†å¤‡ã€‚\ndispatch-docker æœåŠ¡ï¼šåˆ†å‘åˆ° k8sä¸»è¦æ–¹æ³•è°ƒç”¨é“¾å¦‚ä¸‹ï¼š\nDockerVMListener.onStartup(dispatchMessage)                // æ¶ˆè´¹ PipelineAgentStartupEvent    â†“getDockerRoutingType(projectId)                            // åˆ¤æ–­è·¯ç”±ç±»å‹ï¼ˆå¦‚ configmap é…ç½®ä¸º &quot;KUBERNETES&quot;ï¼‰    â†“startKubernetesDocker(...)                                 // è·¯ç”±ç±»å‹ä¸º KUBERNETES æ—¶ï¼Œèµ° k8s èµ„æºæ±     â†“DispatchBuildService.startUp()    â†“createAndStartNewBuilder()    â†“containerServiceFactory.load(projectId).createAndStartBuilder()    â†“KubernetesContainerService.createAndStartBuilder()    â†“kubernetesBuilderClient.createBuilder()                    // HTTP POST /api/builders è°ƒç”¨ dispatch-k8s-manager\ndispatch-docker æœåŠ¡ä¼šæ ¹æ®é¡¹ç›®çš„è·¯ç”±é…ç½®ï¼Œå†³å®šæ˜¯èµ°æœ¬åœ° Docker è¿˜æ˜¯ k8s èµ„æºæ± ã€‚è‹¥é…ç½®ä¸º KUBERNETESï¼Œåˆ™ä¼šé€šè¿‡ HTTP è¯·æ±‚è°ƒç”¨ dispatch-k8s-manager æœåŠ¡ï¼Œå‡†å¤‡åœ¨ k8s é›†ç¾¤ä¸­æ‹‰èµ·æ„å»ºå®¹å™¨ã€‚\n\næŸ¥çœ‹ bk-ci-bk-ci-dispatch-docker è¿™ä¸ª configmapï¼Œå¯ä»¥å‘ç°é…ç½®æ–‡ä»¶é‡Œçš„ defaultDockerRoutingType æ˜¯ â€œKUBERNETESâ€ã€‚\n\ndispatch-k8s-manager æœåŠ¡ï¼šæ‹‰èµ· k8s Deploymentä¸»è¦æ–¹æ³•è°ƒç”¨é“¾å¦‚ä¸‹ï¼š\nPOST /api/builders                                         // è·¯ç”±    â†“createBuilder handler    â†“service.CreateBuilder    â†“task.DoCreateBuilder    â†“kubeclient.CreateDeployment(dep)                           // é€šè¿‡ k8s API åˆ›å»º Deploymentï¼Œæ‹‰èµ·å®é™…çš„æ„å»ºå®¹å™¨\n\ndispatch-k8s-manager æœåŠ¡è´Ÿè´£ä¸ Kubernetes API äº¤äº’ï¼Œæ¥æ”¶æ¥è‡ª dispatch-docker çš„ HTTP è¯·æ±‚åï¼Œç»„è£… Deployment å¯¹è±¡å¹¶è°ƒç”¨ k8s APIï¼Œæœ€ç»ˆåœ¨é›†ç¾¤ä¸­æ‹‰èµ·å®é™…çš„æ„å»ºå®¹å™¨ï¼Œå®Œæˆæµæ°´çº¿çš„ç¯å¢ƒå‡†å¤‡ã€‚\næ€»ç»“æ—¶åºå›¾\næ€»ç»“\n\n\né˜¶æ®µ\nå…³é”®æŠ€æœ¯ç‚¹\nä¸€å¥è¯æè¿°\n\n\n\nå‰ç«¯\nVue + Event Bus\nç‚¹å‡»æŒ‰é’® â†’ äº‹ä»¶æ€»çº¿ â†’ è¯·æ±‚å‘å‡º\n\n\nç½‘å…³\nOpenResty å‰ç¼€è½¬å‘\nç»Ÿä¸€å…¥å£ï¼Œ&#x2F;ms&#x2F;process&#x2F;** ç›´æ¥é€ä¼ è‡³ process æœåŠ¡ã€‚\n\n\næµç¨‹å¼•æ“\nè‡ªç ”äº‹ä»¶-å‘½ä»¤é“¾æ¡†æ¶\nPipelineBuildStart â†’ Stage â†’ Container â†’ Task â†’ AgentStartupï¼Œå±‚å±‚äº‹ä»¶æ¨è¿›ï¼Œé«˜å†…èšä½è€¦åˆã€‚\n\n\næ’ä»¶\nIAtomTask SPI æœºåˆ¶\nè¿è¡Œæ—¶åŠ¨æ€åŠ è½½ DispatchVMStartupTaskAtomï¼Œæ‰©å±•å³æ’å³ç”¨ã€‚\n\n\nè°ƒåº¦\ndispatch-docker â†’ dispatch-kubernetes\næ ¹æ® defaultDockerRoutingType&#x3D;KUBERNETES è·¯ç”±åˆ°å¯¹åº”èµ„æºæ± ã€‚\n\n\nK8s äº¤ä»˜\ndispatch-k8s-manager ä¸ kube-apiserver äº¤äº’\nä¸€æ¡ HTTP è¯·æ±‚å³å¯åœ¨é›†ç¾¤å†…æ‹‰èµ· Deploymentï¼Œæ•°ç§’å®Œæˆç¯å¢ƒå°±ç»ªã€‚\n\n\nå‚è€ƒ\nhttps://github.com/TencentBlueKing/bk-ci/tree/v2.0.0\nhttps://blazehu.com/2025/07/18/devops/landun_dispatch/\n\n","categories":["devops/blueking"],"tags":["devops","blueking"]},{"title":"è“ç›¾ã€ŒDockerå…¬å…±æ„å»ºæœºã€ç¼“å­˜æ¸…ç†","url":"/2025/08/devops/blueking/lan-dun-docker-gong-gong-gou-jian-ji-huan-cun-qing-li/","content":"èƒŒæ™¯åœ¨ä½¿ç”¨è“ç›¾ã€ŒDockerå…¬å…±æ„å»ºæœºã€ä¸€æ®µæ—¶é—´åï¼Œæˆ‘ä»¬å‘ç°æ„å»ºé•œåƒå¶å‘æ€§è¶…æ—¶ã€‚æ’æŸ¥åå‘ç°æ˜¯ç”±äºé›†ç¾¤çš„ Node èŠ‚ç‚¹çš„ç£ç›˜æ»¡äº†ï¼Œæœ¬æ–‡ä¼šä»‹ç»å¦‚ä½•æ¸…ç†æ„å»ºç¼“å­˜ã€‚\næˆ‘ä»¬å‘ç°æ„å»ºé•œåƒå¶å‘æ€§è¶…æ—¶ï¼Œæ’æŸ¥å‘ç°æ˜¯ä¸Šäº† Docker-in-Docker æ„å»ºé•œåƒä¹‹åå‘ç”Ÿçš„ï¼Œè€Œä¸”å‘ç”Ÿé¢‘ç‡è¶Šæ¥è¶Šé«˜ï¼Œè¿›ä¸€æ­¥æ’æŸ¥å‘ç°æ˜¯ç”±äº Pod ä¼šé€šè¿‡ hostPath æŒ‚è½½å·¥ä½œç›®å½•å’Œæ—¥å¿—ç›®å½•ï¼Œç”±äºæ„å»ºä»»åŠ¡è¿‡å¤šå¯¼è‡´ Node èŠ‚ç‚¹ç£ç›˜æ‰“æ»¡ã€‚\næ’æŸ¥è¿‡ç¨‹äº‹ä»¶åˆ†æé€šè¿‡ Pod äº‹ä»¶å¯ä»¥å‘ç°æ˜¯ç”±äº Node èŠ‚ç‚¹ç£ç›˜æ‰“æ»¡ï¼Œå¯¼è‡´ Pod è¢«é©±é€ï¼Œæ„å»ºä»»åŠ¡å¤±è´¥ã€‚\nEvents:  Type     Reason                 Age                 From     Message  ----     ------                 ----                ----     -------  Warning  Evicted                20m                 kubelet  The node was low on resource: ephemeral-storage. Container build1753761077695-ivcpmoxg was using 1580320Ki, which exceeds its request of 0.  Normal   NodeHasNoDiskPressure  3m (x32 over 6d5h)  kubelet  Node 10.10.32.2 status is now: NodeHasNoDiskPressure\n\npod yaml: \nvolumes:- hostPath:    path: /data/landun/workspace/build1753761077695-ivcpmoxg    type: &quot;&quot;  name: data-volume- hostPath:    path: /data/landun/logs/build1753761077695-ivcpmoxg    type: &quot;&quot;  name: logs-volume\næ˜¯ç”±äº Pod é€šè¿‡ hostPath æŒ‚è½½å·¥ä½œç›®å½•å’Œæ—¥å¿—ç›®å½•ï¼Œé€šè¿‡ hostPath æŒ‚è½½ç›®å½•æ˜¯ä¸ºäº†åšç¼“å­˜ï¼Œå½“åŒä¸€æµæ°´çº¿ä»»åŠ¡é‡å¤æ‰§è¡Œæ—¶èƒ½å¤ŸåŠ é€Ÿã€‚\ndispatch-k8s-manager æ¨¡å—çš„é…ç½®æ–‡ä»¶: dispatch-k8s-manager&#x2F;resources&#x2F;config.yaml\ndispatch:  volume:    # æ„å»ºæœºè„šæœ¬    builderConfigMap:      name: dispatch-kubernetes-builder      items:        # åˆå§‹åŒ–è„šæœ¬        - key: initsh.properties          path: init.sh        # ç™»å½•è°ƒè¯•éœ€è¦çš„sleepè„šæœ¬        - key: sleepsh.properties          path: sleep.sh    hostPath:      # æ•°æ®ç›˜      dataHostDir: /data/landun/workspace      # æ—¥å¿—ç›˜      logsHostDir: /data/landun/logs    # åº”ç”¨æ•°æ®ä½¿ç”¨cfs    cfs:      path: /data/cfs  volumeMount:    dataPath: /data/landun/workspace    logPath: /data/logs    builderConfigMapPath: /data/landun/config    cfs:      path: /data/bkdevops/apps      readOnly: true\n\næºç åˆ†ædispatch-k8s-manager&#x2F;pkg&#x2F;apiserver&#x2F;service&#x2F;builder_start.go\n// getBuilderVolumeAndMount è·å–ä¸€äº›æ„å»ºæœºçš„å¸¸è§„çš„è¢«æŒ‚è½½åˆ°podä¸Šçš„volumeå’Œmountfunc getBuilderVolumeAndMount(  workloadName string,  nFSs []types.NFS,) (volumes []corev1.Volume, volumeMounts []corev1.VolumeMount) &#123;  volumes = getBuilderPodVolume(workloadName)  volumeMounts = getBuilderPodVolumeMount()  ...  return volumes, volumeMounts&#125;// getBuilderPodVolume è·å–ä¸€äº›æ„å»ºæœºçš„å¸¸è§„çš„è¢«æŒ‚è½½åˆ°podä¸Šçš„volumeï¼ŒåŒ…æ‹¬é…ç½®configmapå’Œdataç›®å½•hostpathfunc getBuilderPodVolume(workloadName string) []corev1.Volume &#123;  dataHostPath := filepath.Join(config.Config.Dispatch.Volume.HostPath.DataHostDir, workloadName)  logHostPath := filepath.Join(config.Config.Dispatch.Volume.HostPath.LogsHostDir, workloadName)  var items []corev1.KeyToPath  for _, v := range config.Config.Dispatch.Volume.BuilderConfigMap.Items &#123;    items = append(items, corev1.KeyToPath&#123;      Key:  v.Key,      Path: v.Path,    &#125;)  &#125;  return ...&#125;\né€šè¿‡æºç åˆ†æå¯ä»¥å‘ç° hostPath æ˜¯é€šè¿‡ dispatch-k8s-manager&#x2F;resources&#x2F;config.yaml åŠ ä¸Š workloadName æ‹¼æ¥è€Œæˆçš„ï¼Œæ‰€ä»¥æ²¡åŠæ³•é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶ä¸ä½¿ç”¨ hostPathï¼Œäºæ˜¯æˆ‘ä»¬é€šè¿‡å®šæ—¶ä»»åŠ¡æ¥æ¸…ç†è¯¥ç¼“å­˜ã€‚\nè§£å†³æ–¹æ¡ˆå‚è€ƒ bk-applog-bkapp-filebeat çš„æ—¥å¿—æ¸…ç†æ–¹æ¡ˆï¼Œé€šè¿‡ DaemonSet å®ç°è“ç›¾æŒ‚è½½å·¥ä½œç›®å½•å®æ–½å®šæ—¶æ¸…ç†æ“ä½œã€‚\nNAME                                   DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGEbk-applog-bkapp-filebeat-ingress       18        18        18      18           18          &lt;none&gt;          424dbk-applog-bkapp-filebeat-json          18        18        18      18           18          &lt;none&gt;          424dbk-applog-bkapp-filebeat-log-cleaner   18        18        18      18           18          &lt;none&gt;          424dbk-applog-bkapp-filebeat-stdout        18        18        18      18           18          &lt;none&gt;          424dbk-ci-builder-cleaner                  18        18        18      18           18          &lt;none&gt;          13d\n\nç¼–å†™ daemonSet.yaml\napiVersion: apps/v1kind: DaemonSetmetadata:  name: bk-ci-builder-cleaner  namespace: blueking  labels:    app: bk-ci-builderspec:  revisionHistoryLimit: 10  selector:    matchLabels:      app: bk-ci-builder  template:    metadata:      labels:        app: bk-ci-builder      name: bk-ci-builder-cleaner    spec:      hostPID: true      restartPolicy: Always      serviceAccountName: bk-applog-bkapp-filebeat      containers:      - name: batch-delete-files        image: xxx.xxx.com/bk-ci-builder-cleaner:v1        imagePullPolicy: IfNotPresent        command:        - bash        args:        - -c        - while true; do ./delete_files.sh; sleep 21600; done;        resources:          requests:            cpu: 25m            memory: 32Mi          limits:            cpu: 2560m            memory: 256Mi        volumeMounts:        - mountPath: /data/devops/workspace          name: data-volume        - mountPath: /data/devops/logs          name: logs-volume      volumes:      - name: data-volume        hostPath:          path: /data/landun/workspace          type: DirectoryOrCreate      - name: logs-volume        hostPath:          path: /data/landun/logs          type: DirectoryOrCreate\n\nç¼“å­˜æ¸…ç†è„šæœ¬ delete_files.sh\n#!/usr/bin/env bash# delete_files.sh  â€”â€” æ­£å¼åˆ é™¤ç‰ˆ# åŒæ—¶æ‰«æ /data/devops/workspace å’Œ /data/devops/logsset -euo pipefail# --------- å¯é…ç½®å‚æ•° ---------ROOT_DIRS=(&quot;/data/devops/workspace&quot; &quot;/data/devops/logs&quot;)RETENTION_DAYS=7LOG_FILE=&quot;/tmp/delete_build_dirs.log&quot;# -----------------------------log() &#123;  printf &#x27;%s [%s] %s\\n&#x27; &quot;$(date &#x27;+%F %T&#x27;)&quot; &quot;$1&quot; &quot;$2&quot; | tee -a &quot;$LOG_FILE&quot;&#125;cutoff_date=$(date -d &quot;$RETENTION_DAYS days ago&quot; +%F)log INFO &quot;==== å¼€å§‹æ£€æŸ¥å¹¶åˆ é™¤ $RETENTION_DAYS å¤©æœªæ›´æ–°çš„ build* ç›®å½• ====&quot;for root in &quot;$&#123;ROOT_DIRS[@]&#125;&quot;; do  [[ -d $root ]] || &#123; log WARN &quot;ç›®å½•ä¸å­˜åœ¨: $root&quot;; continue; &#125;  for dir in &quot;$root&quot;/build*; do    [[ -d $dir ]] || continue    # äºŒæ¬¡ç¡®è®¤ï¼šç›®å½•å†…æ˜¯å¦ä»æ— ä»»ä½• 7 å¤©å†…æ›´æ–°çš„æ–‡ä»¶    if ! find &quot;$dir&quot; -type f -newermt &quot;$cutoff_date&quot; -print -quit | grep -q .; then        log DELETE &quot;$dir&quot;        rm -rf &quot;$dir&quot;    else        log SKIP &quot;$dir&quot;    fi  donedonelog INFO &quot;==== æ¸…ç†å®Œæˆï¼Œæ—¥å¿—: $LOG_FILE ====&quot;\n\nå‚è€ƒhttps://github.com/TencentBlueKing/bk-ci/blob/v2.0.0/https://blazehu.com/2025/07/17/devops/landun_dind_cleaner/\n","categories":["devops/blueking"],"tags":["devops","blueking"]},{"title":"è“ç›¾ä»å•æœºåˆ° DinD çš„å®è·µ","url":"/2025/08/devops/blueking/lan-dun-cong-dan-ji-dao-dind-de-shi-jian/","content":"ä¼ ç»Ÿçš„å•æœºæ„å»ºç¯å¢ƒåœ¨é¡¹ç›®å˜å¤§ã€ä»»åŠ¡å˜å¤šæ—¶ï¼Œå®¹æ˜“å‡ºé—®é¢˜ï¼Œæ¯”å¦‚å®¹æ˜“å´©æºƒã€èµ„æºä¸å¤Ÿç”¨ã€ä»»åŠ¡æ’é˜Ÿï¼Œä»¥åŠæˆæœ¬å’Œèµ„æºåˆ©ç”¨çš„çŸ›ç›¾ã€‚æœ¬æ–‡ä¼šä»‹ç»ç”¨å®¹å™¨åŒ–æŠ€æœ¯Docker-in-Dockerï¼ˆDinDï¼‰æ¥è§£å†³è¿™äº›é—®é¢˜ï¼Œæ‰“é€ ä¸€ä¸ªçµæ´»ã€é«˜æ•ˆçš„CI&#x2F;CDç³»ç»Ÿã€‚\nèƒŒæ™¯å½“å‰æ„å»ºç¯å¢ƒå› ä¾èµ–å•å°æœºå™¨ï¼Œé¢ä¸´è¯¸å¤šæŒ‘æˆ˜ï¼š\n\nå•ç‚¹æ•…éšœé£é™©ï¼Œç¡¬ä»¶æˆ–ç½‘ç»œæ•…éšœæ˜“è‡´æ„å»ºæµç¨‹ä¸­æ–­ï¼›\nèµ„æºç“¶é¢ˆï¼Œé¢‘ç¹çš„æ„å»ºä»»åŠ¡ä½¿æœºå™¨è´Ÿè½½è¿‡é«˜ï¼Œé¢‘ç¹è§¦å‘å‘Šè­¦ï¼Œå½±å“ç³»ç»Ÿç¨³å®šæ€§ï¼›\nä»»åŠ¡å †ç§¯ï¼Œå¤§é‡ä»»åŠ¡ç§¯å‹è‡´åç»­ä»»åŠ¡å»¶è¿Ÿç”šè‡³è¶…æ—¶å¤±è´¥ï¼Œé™ä½æ„å»ºæ•ˆç‡ï¼›\næˆæœ¬ä¸èµ„æºåˆ©ç”¨é—®é¢˜ï¼Œå¢åŠ æœºå™¨è™½å¯ç¼“è§£èµ„æºç´§å¼ ï¼Œä½†ä¼šå¢åŠ è¿ç»´å’Œç¡¬ä»¶æˆæœ¬ï¼Œä¸”ä»»åŠ¡éæŒç»­é«˜å³°ï¼Œéƒ¨åˆ†æ—¶é—´èµ„æºé—²ç½®æµªè´¹ã€‚\n\næŠ€æœ¯é€‰å‹æ–¹æ¡ˆKanikoKaniko æ˜¯è°·æ­Œå¼€æºçš„ä¸€æ¬¾æ„å»ºå®¹å™¨é•œåƒçš„å·¥å…·ã€‚Kaniko å¹¶ä¸ä¾èµ–äº Docker å®ˆæŠ¤è¿›ç¨‹ï¼Œå®Œå…¨åœ¨ç”¨æˆ·ç©ºé—´æ ¹æ® Dockerfile çš„å†…å®¹é€è¡Œæ‰§è¡Œå‘½ä»¤æ¥æ„å»ºé•œåƒï¼Œè¿™å°±ä½¿å¾—åœ¨ä¸€äº›æ— æ³•è·å– docker å®ˆæŠ¤ è¿›ç¨‹çš„ç¯å¢ƒä¸‹ä¹Ÿèƒ½å¤Ÿæ„å»ºé•œåƒã€‚\nKaniko é€šè¿‡æå–åŸºç¡€é•œåƒçš„æ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‰é¡ºåºæ‰§è¡Œ Dockerfile ä¸­çš„æŒ‡ä»¤ï¼Œæ¯æ‰§è¡Œä¸€æ¡æŒ‡ä»¤ååœ¨ç”¨æˆ·ç©ºé—´åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„å¿«ç…§å¹¶ä¸ä¸Šä¸€çŠ¶æ€å¯¹æ¯”ï¼Œè‹¥æœ‰å˜åŒ–åˆ™ç”Ÿæˆæ–°é•œåƒå±‚å¹¶æ›´æ–°å…ƒæ•°æ®ï¼Œæœ€ç»ˆå°†æ„å»ºå¥½çš„é•œåƒæ¨é€åˆ°é•œåƒä»“åº“ã€‚\nç®€å•ä¾‹å­ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨kanikoçš„æ„å»ºçš„ç®€å•ä¾‹å­\nåˆ›å»ºå¯†é’¥\nkubectl create secret generic -n blazehu kaniko-secret-common --from-file=config.json\n\næ„å»ºæµ‹è¯•\napiVersion: v1kind: Podmetadata:  name: kanikospec:  containers:    - name: kaniko      image: m.daocloud.io/gcr.io/kaniko-project/executor:latest      args:        - &quot;--dockerfile=Dockerfile&quot;        - &quot;--context=git://user:password@github.com:blazehu/go-examples.git#master&quot;        - &quot;--destination=blazehu1122/example:latest&quot;      volumeMounts:        - name: kaniko-secret          mountPath: /kaniko/.docker/  restartPolicy: Never  volumes:    - name: kaniko-secret      secret:        secretName: kaniko-secret-common\n\n\nä½¿ç”¨ kaniko-project&#x2F;executor:latest é•œåƒæ‰§è¡Œæ„å»ºä»»åŠ¡\næ„å»ºå‚æ•° â€“context: ä¸Šä¸‹æ–‡æŒ‡å®š Git Repositoryï¼ˆä»…æ”¯æŒ git:&#x2F;&#x2F;[repository url][#reference][#commit-id] æ ¼å¼ï¼‰\næ„å»ºå‚æ•° â€“destination: æŒ‡å®šé…ç½®çš„æ¨é€é•œåƒçš„åœ°å€\né•œåƒæ¨é€æŒ‚è½½äº† kaniko-secret å¯†é’¥\n\næ„å»ºæ–°çš„CIé•œåƒé‚£æˆ‘ä»¬å¦‚ä½•ç»“åˆè“ç›¾æ¥å®ç°Dindå‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦é‡æ–°åˆ¶ä½œä¸€ä¸ªæ–°çš„è“ç›¾CIé•œåƒï¼Œå‚è€ƒã€Šæ„å»ºå¹¶æ‰˜ç®¡ä¸€ä¸ª CI é•œåƒ ã€‹ï¼Œè¯¥CIé•œåƒéœ€è¦åŒ…æ‹¬ kaniko æ‰§è¡Œå™¨ã€‚è¿™é‡Œé€šè¿‡å¤šé˜¶æ®µæ„å»ºæ¥åˆ¶ä½œæ–°çš„CIé•œåƒã€‚\nFROM m.daocloud.io/gcr.io/kaniko-project/executor:latest as kanikoFROM bkci/ci:latest# å¤åˆ¶å¿…è¦æ–‡ä»¶COPY --from=kaniko /kaniko /kanikoRUN chmod +x /kaniko/executorRUN apt install -y git python-pip python3-pip \\    &amp;&amp; pip config set global.index-url https://mirrors.aliyun.com/pypi/simple \\    &amp;&amp; pip config set install.trusted-host mirrors.aliyun.com# è®¾ç½®ç¯å¢ƒå˜é‡ENV PATH $PATH:/kanikoENV DOCKER_CONFIG /kaniko/.dockerENV SSL_CERT_DIR /kaniko/ssl/certs# éªŒè¯ kaniko å¯æ‰§è¡Œæ–‡ä»¶RUN /kaniko/executor version\n\nè“ç›¾æµæ°´çº¿\n\nç¬¬ä¸€æ­¥ä½¿ç”¨è“ç›¾ Checkout æ’ä»¶æ‹‰å–ä»£ç \nç¬¬äºŒæ­¥ä½¿ç”¨è“ç›¾ Shell Script æ’ä»¶æ‰§è¡Œ kaniko æ„å»ºå‘½ä»¤\n\nkaniko/executor --context=/data/devops/workspace --dockerfile=Dockerfile --destination=blazehu1122/example:latest --ignore-path=/ &quot;\n\nDind Unix Socketä½¿ç”¨ DaemonSet æ¥å¯åŠ¨ Dind Podï¼Œå°† Docker socket æ–‡ä»¶ &#x2F;var&#x2F;run&#x2F;docker.sock æŒ‚è½½åˆ° Pod ä¸­ã€‚åœ¨è¦ä½¿ç”¨DockeræœåŠ¡çš„ Pod ä¸­éƒ½éœ€è¦æŒ‚è½½ socketæ–‡ä»¶ã€‚\nç®€å•ä¾‹å­apiVersion: apps/v1kind: DaemonSetmetadata:  name: dinp-daemonsetspec:  selector:    matchLabels:      name: dinp-daemonset  template:    metadata:      labels:        name: dinp-daemonset    spec:      containers:      - name: dind        image: docker:dind        securityContext:          privileged: true        volumeMounts:        - name: dockersock          mountPath: /var/run/docker.sock      volumes:      - name: dockersock        hostPath:          path: /var/run/docker.sock          type: Socket\n\nåœ¨è¿™ä¸ªé…ç½®ä¸­ï¼Œ&#x2F;var&#x2F;run&#x2F;docker.sock è¢«æŒ‚è½½åˆ° Pod ä¸­ï¼Œå…è®¸ Pod ç›´æ¥ä¸å®¿ä¸»æœºä¸Šçš„ Docker å®ˆæŠ¤è¿›ç¨‹é€šä¿¡ã€‚è¿™ç§æ–¹å¼ä¸éœ€è¦è®¾ç½® DOCKER_HOST ç¯å¢ƒå˜é‡ï¼Œå› ä¸º Docker å®¢æˆ·ç«¯å’Œå®ˆæŠ¤è¿›ç¨‹ç›´æ¥é€šè¿‡ socket æ–‡ä»¶é€šä¿¡ã€‚\nDind TCPå®šä¹‰ä¸€ä¸ª Deployment å’Œä¸€ä¸ª Serviceï¼Œç”¨äºå¯åŠ¨ä¸€ä¸ªåŒ…å« Dind çš„ Podï¼Œå¹¶é€šè¿‡ Service å¯¹å¤–æä¾› Docker æœåŠ¡ã€‚åœ¨è¦ä½¿ç”¨DockeræœåŠ¡çš„ Pod ä¸­è®¾ç½® DOCKER_HOST ç¯å¢ƒå˜é‡ï¼Œä½¿å¾— Docker å®¢æˆ·ç«¯çŸ¥é“å¦‚ä½•è¿æ¥åˆ° Docker å®ˆæŠ¤è¿›ç¨‹ï¼ˆæ¯”å¦‚åœ¨bkciçš„åŸºç¡€é•œåƒä¸­æ³¨å…¥è¯¥ç¯å¢ƒå˜é‡ï¼‰ã€‚\nç®€å•ä¾‹å­apiVersion: apps/v1kind: Deploymentmetadata:  name: dinp-deployment  namespace: blueking  labels:    name: dinp-deploymentspec:  replicas: 1  selector:    matchLabels:      name: dinp-deployment  template:    metadata:      labels:        name: dinp-deployment    spec:      containers:      - name: dind        image: docker:dind        resources:          requests:            memory: &quot;4Gi&quot;            cpu: &quot;2&quot;          limits:            memory: &quot;8Gi&quot;            cpu: &quot;4&quot;        securityContext:          privileged: true        env:        - name: DOCKER_TLS_CERTDIR          value: &quot;&quot;        - name: DOCKER_HOST          value: tcp://localhost:2375        tty: true        volumeMounts:        - name: docker-storage          mountPath: /var/lib/docker        - name: docker-run          mountPath: /var/run        readinessProbe:          exec:            command: [&quot;docker&quot;, &quot;info&quot;]          initialDelaySeconds: 10          failureThreshold: 6        livenessProbe:          exec:            command: [&quot;docker&quot;, &quot;info&quot;]          initialDelaySeconds: 60          failureThreshold: 10      ## æ±¡ç‚¹é…ç½®      tolerations:      - key: &quot;svc&quot;        value: &quot;bk&quot;        operator: &quot;Equal&quot;        effect: &quot;NoSchedule&quot;      affinity:        podAffinity:          requiredDuringSchedulingIgnoredDuringExecution:          - labelSelector:              matchExpressions:              - key: &quot;app.kubernetes.io/name&quot;                operator: &quot;In&quot;                values:                - dockerhost            topologyKey: &quot;kubernetes.io/hostname&quot;      volumes:      - name: docker-storage        hostPath:          path: /var/lib/docker_in_pod      - name: docker-run        hostPath:          path: /blueking/run          type: DirectoryOrCreate---apiVersion: v1kind: Servicemetadata:  name: bk-ci-docker-dinp  namespace: bluekingspec:  selector:    name: dinp-deployment  ports:    - protocol: TCP      port: 2375      targetPort: 2375\n\nåœ¨éœ€è¦ä½¿ç”¨ Docker çš„ Pod ä¸­è®¾ç½® DOCKER_HOST ç¯å¢ƒå˜é‡ä¸º bk-ci-docker-dinp.blueking.svc.cluster.localï¼Œé€šè¿‡ Kubernetes Service çš„åŸŸåè§£æå’Œç«¯å£è½¬å‘æœºåˆ¶ï¼Œä½¿ Pod å†…çš„ Docker å®¢æˆ·ç«¯èƒ½å¤Ÿè¿æ¥åˆ°åç«¯çš„ Docker å®ˆæŠ¤è¿›ç¨‹ã€‚\nè“ç›¾æµæ°´çº¿\nç¬¬ä¸€æ­¥ä½¿ç”¨è“ç›¾ Checkout æ’ä»¶æ‹‰å–ä»£ç \nç¬¬äºŒæ­¥ä½¿ç”¨è“ç›¾ Shell Script æ’ä»¶æ‰§è¡Œ docker æ„å»ºå‘½ä»¤\n\ndocker context create dind --docker &quot;host=tcp://bk-ci-docker-dinp.blueking.svc.cluster.local:2375,ca=/root/.docker/certs/ca.pem,cert=/root/.docker/certs/cert.pem,key=/root/.docker/certs/key.pem&quot; docker context use dinddocker build --platform=linux/amd64 -t $&#123;IMAGE_REPO&#125;:$&#123;IMAGE_TAG&#125; -f Dockerfile . --push\n\næŠ€æœ¯é€‰å‹å¯¹æ¯”\n\n\nç‰¹æ€§&#x2F;æ–¹æ¡ˆ\nKaniko\nDind Unix Socket\nDind TCP\n\n\n\nä¾èµ–ç¯å¢ƒ\nä¸ä¾èµ– Docker å®ˆæŠ¤è¿›ç¨‹\nä¾èµ–å®¿ä¸»æœº Docker Socket\nä¾èµ–å®¿ä¸»æœº Docker å®ˆæŠ¤è¿›ç¨‹ï¼ˆTCPï¼‰\n\n\néƒ¨ç½²å¤æ‚åº¦\nç®€å•ï¼Œåªéœ€éƒ¨ç½² Pod\nä¸­ç­‰ï¼Œéœ€è¦é…ç½® DaemonSet\nè¾ƒå¤æ‚ï¼Œéœ€è¦é…ç½® Deployment å’Œ Service\n\n\nèµ„æºæ¶ˆè€—\nä½\nä¸­ç­‰\nè¾ƒé«˜\n\n\nå®‰å…¨æ€§\né«˜\nä¸­ç­‰\nä¸­ç­‰\n\n\né€‚ç”¨åœºæ™¯\nKubernetes ç¯å¢ƒ\nå•æœºæˆ–å¤šèŠ‚ç‚¹é›†ç¾¤\nè·¨èŠ‚ç‚¹æˆ– Kubernetes é›†ç¾¤\n\n\nè“ç›¾é›†æˆéš¾åº¦\nä¸­ç­‰\nä½\nä¸­ç­‰\n\n\nè™½ç„¶æˆ‘ä»¬æœ€ç»ˆé€‰æ‹©äº† Kaniko æ–¹æ¡ˆï¼Œä½†åœ¨å®é™…åº”ç”¨ä¸­å‘ç°ï¼ŒåŸºäº m.daocloud.io&#x2F;gcr.io&#x2F;kaniko-project&#x2F;executor:latest åˆ¶ä½œçš„è“ç›¾ CI é•œåƒå­˜åœ¨ä¸€äº›å…¼å®¹æ€§é—®é¢˜ã€‚\næ ¹æ® Kaniko çš„å®˜æ–¹æ–‡æ¡£ï¼Œè¿™ç§åšæ³•å¹¶ä¸è¢«æ¨èï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›ä¸å¯é¢„è§çš„é—®é¢˜ã€‚\nåç»­å°†æ ¹æ®è“ç›¾çš„å®˜æ–¹æ–‡æ¡£å’Œ Kaniko çš„æœ€ä½³å®è·µï¼Œå»ºè®®é‡æ–°åˆ¶ä½œ CI é•œåƒã€‚\nå‚è€ƒ\nhttps://blazehu.com/2025/06/27/devops/landun_dind/\nhttps://github.com/GoogleContainerTools/kaniko\nhttps://juejin.cn/post/7217665415710081081\nhttps://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Services/Store/ci-images/docker-build.md\n\n","categories":["devops/blueking"],"tags":["devops","blueking"]},{"title":"è“ç›¾æ¥å…¥LDAPç™»å½•(v7-1)","url":"/2025/08/devops/blueking/lan-dun-jie-ru-ldap-deng-lu-v7-1/","content":"é€šè¿‡è“é²¸ç”¨æˆ·ä¸­å¿ƒé…ç½® LDAP åï¼Œå­˜åœ¨ç™»å½•å¤±è´¥ä»¥åŠç”¨æˆ·åéœ€è¦åŠ åŸŸï¼ˆä¸å½“å‰ç”¨æˆ·çš„ä½¿ç”¨ä¹ æƒ¯ä¸ç¬¦ï¼‰ç­‰é—®é¢˜ã€‚\nèƒŒæ™¯æŒ‰ç…§å®˜æ–¹æ–‡æ¡£å¯¹æ¥ LDAP æœåŠ¡åç”¨æˆ·æ­£å¸¸åŒæ­¥ï¼Œä½†æ˜¯ç™»å½•æ—¶æŠ¥ç”¨æˆ·å¯†ç é”™è¯¯ã€‚\né—®é¢˜åˆ†æåå°æŸ¥çœ‹ bk-user-api-web æ—¥å¿—ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š\n&#123;  &quot;levelname&quot;: &quot;ERROR&quot;,  &quot;asctime&quot;: &quot;2024-05-22 15:15:30,947&quot;,  &quot;pathname&quot;: &quot;/app/bkuser_core/api/login/views.py&quot;,  &quot;lineno&quot;: 205,  &quot;funcName&quot;: &quot;login&quot;,  &quot;process&quot;: 530,  &quot;thread&quot;: 140333237386568,  &quot;request_id&quot;: &quot;ebf27affe3f74e77b961a11df38583e9&quot;,  &quot;exc_info&quot;: &quot;Traceback (most recent call last):  File \\&quot;/app/bkuser_core/api/login/views.py\\&quot;, line 197, in login    login_class().check(profile, password)  File \\&quot;/app/bkuser_core/categories/plugins/ldap/login.py\\&quot;, line 62, in check    target_dn = self.fetch_dn(user)  File \\&quot;/app/bkuser_core/categories/plugins/ldap/login.py\\&quot;, line 30, in fetch_dn    return force_str(user_info[\\&quot;raw_attributes\\&quot;][\\&quot;entryDN\\&quot;][0])  File \\&quot;/usr/local/lib/python3.6/site-packages/ldap3/utils/ciDict.py\\&quot;, line 68, in __getitem__    return self._store[self._case_insensitive_keymap[self._ci_key(key)]]  KeyError: &#x27;entrydn&#x27;&quot;&#125;\næŠ¥é”™ä¿¡æ¯å¾ˆæ˜æ˜¾ï¼Œåœ¨ user_info.raw_attributes é‡Œæ‰¾ä¸åˆ° entryDN è¿™ä¸ª keyã€‚å³è·å–ç”¨æˆ·ç”¨äºç™»é™†çš„ login dn å¤±è´¥ï¼Œéœ€è¦ä¿®æ”¹ç›¸å…³é€»è¾‘ã€‚\nè§£å†³æ–¹æ¡ˆä¿®æ”¹ä»£ç æœ¬åœ°é€šè¿‡ vscode æ’ä»¶è¿ä¸Š ldap åï¼Œå‘ç°ç”¨æˆ·ç”¨äºç™»é™†çš„ login dn çš„ key åº”è¯¥æ˜¯ dnï¼Œä¿®æ”¹ç”¨äºç”¨æˆ·ç™»é™†çš„ login dn é€»è¾‘ã€‚è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š\n\né€šè¿‡éƒ¨ç½²çš„é…ç½®æ–‡ä»¶ environments/default/version.yaml æ‰¾åˆ°éƒ¨ç½²çš„ bk-user çš„ç‰ˆæœ¬ä¸ºï¼šbk-user: &quot;1.4.14-beta.10&quot;\nä¸‹è½½è¯¥åŒ…åˆ°æœ¬åœ° helm pull blueking/bk-user --version 1.4.14-beta.10ï¼Œè§£å‹æ‰¾åˆ°é•œåƒç‰ˆæœ¬ï¼štag: &quot;v2.5.4-beta.10&quot;\næ‰¾åˆ° bk-user è¯¥ tag æºç åœ°å€ï¼šhttps://github.com/TencentBlueKing/bk-user/tree/v2.5.4-beta.10\næ ¹æ®æ—¥å¿—æ‰¾åˆ°å¯¹åº”æ–‡ä»¶ src/api/bkuser_core/categories/plugins/ldap/login.py\nä¿®æ”¹ fetch_dn å‡½æ•°çš„å®ç°ï¼Œå°† entryDN ä¿®æ”¹ä¸º dnã€‚\n\n@staticmethoddef fetch_dn(user_info: dict) -&gt; str:    return force_str(user_info[&quot;raw_attributes&quot;][&quot;dn&quot;][0])\n\næ›´æ–°æœåŠ¡åˆ¶ä½œé•œåƒæˆ‘ä»¬åªéœ€è¦æ›´æ–° bk-user-api-web æœåŠ¡æ‰€ä»¥åªéœ€è¦åˆ¶ä½œè¯¥æœåŠ¡é•œåƒï¼Œæ‰§è¡Œå‘½ä»¤ make build-apiã€‚\nå˜æ›´æ¨¡ç‰ˆåœ¨ environments&#x2F;default ç›®å½•ä¸‹æ–°å»º bkuser-custom-values.yaml.gotmpl æ–‡ä»¶ä½¿ç”¨æ–°çš„é•œåƒï¼Œè‹¥ä»¥å­˜åœ¨åˆ™è·³è¿‡ã€‚\n# bk-user-api:v1.0.1api:  image:    registry: your registry    repository: bk-user-api    pullPolicy: IfNotPresent    tag: &quot;v1.0.1&quot;\n\næ›´æ–°æœåŠ¡helmfile -f base-blueking.yaml.gotmpl -l seq=third sync\n\næ£€æŸ¥ä»¥ä¸‹å®¹å™¨é•œåƒçš„å˜æ›´æ˜¯å¦ç¬¦åˆé¢„æœŸï¼š\nbk-user-api-beatbk-user-api-webbk-user-api-worker\næ€»ç»“ç™»é™†å¤±è´¥çš„é—®é¢˜å¯ä»¥é€šè¿‡ä¿®æ”¹æºç è¿›è¡Œä¿®å¤ã€‚ç™»é™†æ— éœ€åŠ åŸŸçš„ä¸´æ—¶æ–¹æ¡ˆï¼šå°†ç”¨æˆ·å’Œç»„ç»‡ç»“æ„ä¿¡æ¯åŒæ­¥è‡³é»˜è®¤åŸŸï¼Œç„¶åæŸ¥æ‰¾é»˜è®¤åŸŸã€‚éœ€è¦ä¿®æ”¹åŒæ­¥é€»è¾‘ã€‚\nå‚è€ƒ\nhttps://blazehu.com/2024/05/22/devops/landun_login_ldap/\nhttps://bk.tencent.com/s-mart/community/question/9114?type=article\nhttps://github.com/TencentBlueKing/bk-user/tree/v2.5.4-beta.10\n\n","categories":["devops/blueking"],"tags":["devops","blueking"]},{"title":"åŸºäºKanikoæ„å»ºbkciåŸºç¡€é•œåƒ","url":"/2025/08/devops/blueking/ji-yu-kaniko-gou-jian-bkci-ji-chu-jing-xiang/","content":"è‡ªå®šä¹‰ICé•œåƒå‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Services/Store/ci-images/docker-build.md\næœ‰ä¸¤ç§æ–¹å¼ï¼š\n\nDockerfile ç¤ºä¾‹ 1ï¼ˆä»¥ bkci é»˜è®¤é•œåƒä¸ºåŸºç¡€é•œåƒï¼‰ï¼šFROM bkci/ci:latestRUN yum install -y mysql-devel\nDockerfile ç¤ºä¾‹ 2ï¼ˆä¸ä»¥ bkci é»˜è®¤é•œåƒä¸ºåŸºç¡€é•œåƒæ—¶ï¼Œé•œåƒç¯å¢ƒåŸºæœ¬è¦æ±‚å¦‚ä¸‹ï¼‰ï¼š# ============= bkciåŸºç¡€ç¯å¢ƒ ================FROM openjdk:8-jre-slimRUN apt update &amp;&amp; apt upgrade &amp;&amp; apt autoremove -yRUN apt install -y curl wgetRUN wget -q https://repo1.maven.org/maven2/org/bouncycastle/bcprov-jdk16/1.46/bcprov-jdk16-1.46.jar -O $JAVA_HOME/lib/ext/bcprov-jdk16-1.46.jarRUN ln -sf $JAVA_HOME /usr/local/jre# ============= è‡ªå®šä¹‰ç¯å¢ƒ ================# RUN whatever you wantRUN apt install -y git python-pip\n\né‡è¦æç¤ºï¼š\n\nå› ä¸ºæµæ°´çº¿é‡Œçš„å®¹å™¨æ˜¯é€šè¿‡ CMDï¼Œä½¿ç”¨&#x2F;bin&#x2F;sh å¯åŠ¨çš„ï¼Œå› æ­¤å¿…é¡»ä¿è¯é•œåƒé‡Œé¢å­˜åœ¨&#x2F;bin&#x2F;sh ä»¥åŠ curl å‘½ä»¤ï¼ˆç”¨æ¥ä¸‹è½½ Agentï¼‰\nä¸è¦è®¾ç½® ENTRYPOINT\nç¡®ä¿ä¸º 64 ä½é•œåƒ\nç”¨æˆ·ç”¨ rootï¼Œå¦‚éœ€æ™®é€šç”¨æˆ·å¯ä»¥åœ¨ bash é‡Œé¢åˆ‡æ¢ï¼Œå¦åˆ™æµæ°´çº¿ä»»åŠ¡å¯åŠ¨ä¸äº†\næµæ°´çº¿æ’ä»¶æœ‰å¯èƒ½ä½¿ç”¨ python æˆ– nodejs å¼€å‘ï¼Œå»ºè®®å‡†å¤‡å¥½æ’ä»¶æ‰§è¡Œç¯å¢ƒ:Python æ’ä»¶æ‰§è¡Œç¯å¢ƒNodeJS æ’ä»¶æ‰§è¡Œç¯å¢ƒ\n\næ„å»ºkaniko bkcié•œåƒç¼–å†™Dockerfileï¼š# ç¬¬ä¸€é˜¶æ®µï¼šè·å– kaniko æ‰§è¡Œå™¨FROM m.daocloud.io/gcr.io/kaniko-project/executor:latest as kaniko# ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨ BKCI å®˜æ–¹åŸºç¡€é•œåƒFROM bkci/ci:latestMAINTAINER huari &quot;qiqiuyang@papegames.net&quot;# ä» kaniko é˜¶æ®µå¤åˆ¶å¿…è¦æ–‡ä»¶ï¼ˆä¸åŒ…å«ç”¨æˆ·ç‰¹å®šçš„é…ç½®æ–‡ä»¶ï¼‰COPY --from=kaniko /kaniko /kanikoRUN chmod +x /kaniko/executorRUN apt install -y git python-pip python3-pip \\    &amp;&amp; pip config set global.index-url https://mirrors.aliyun.com/pypi/simple \\    &amp;&amp; pip config set install.trusted-host mirrors.aliyun.com# è®¾ç½®ç¯å¢ƒå˜é‡ENV PATH $PATH:/kanikoENV DOCKER_CONFIG /kaniko/.dockerENV SSL_CERT_DIR /kaniko/ssl/certs# éªŒè¯ kaniko å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¸éªŒè¯é…ç½®ï¼‰RUN /kaniko/executor version\n\næ‰§è¡Œbkcié•œåƒæ„å»ºæµæ°´çº¿\nå‘å¸ƒå®¹å™¨é•œåƒå‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://bk.tencent.com/docs/markdown/ZH/Devops/3.0/UserGuide/Services/Store/ci-images/release-new-image.md\n","categories":["devops/blueking"],"tags":["devops","blueking","kaniko"]},{"title":"è“ç›¾æµæ°´çº¿ä¸­çš„ Kubernetes è°ƒåº¦ä¼˜åŒ–","url":"/2025/08/devops/blueking/lan-dun-liu-shui-xian-zhong-de-kubernetes-diao-du-you-hua/","content":"èƒŒæ™¯åœ¨å‰æ–‡è“ç›¾ã€ŒDockerå…¬å…±æ„å»ºæœºã€ç¼“å­˜æ¸…ç†ä¸­æˆ‘ä»¬é€šè¿‡åˆ†ææºç ï¼ŒçŸ¥é“æ‹‰èµ·çš„æ„å»º Pod é€šè¿‡ hostPath æŒ‚è½½å·¥ä½œç›®å½•åšç¼“å­˜ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥è¿›ä¸€æ­¥åˆ†æåˆ›å»º Pod çš„æµç¨‹ã€‚\néƒ¨ç½²é…ç½®dispatch-k8s-manager&#x2F;resources&#x2F;config.yaml\ndispatch:  # è°ƒåº¦éœ€è¦ä½¿ç”¨åˆ°çš„labelï¼Œç¡®å®šæ„å»ºæœºå”¯ä¸€æ€§  label: bkci.dispatch.kubenetes/core  # é€šè¿‡k8s watchæ¥è§‚å¯Ÿæ„å»ºæœºçŠ¶æ€  watch:    task:      label: bkci.dispatch.kubenetes/watch-task  builder:    # å°†æ„å»ºæœºè°ƒåº¦åˆ°æŒ‡å®šæ ‡ç­¾èŠ‚ç‚¹çš„é…ç½®ï¼Œä¸å¡«å†™åˆ™åœ¨é›†ç¾¤å†…éƒ½å¯ä»¥è°ƒåº¦ï¼Œä¼˜å…ˆçº§å°äºä¸“æœºå’Œç‰¹æ®Šæœºå™¨    nodeSelector:      label:      value:    # æ„å»ºæœºæ›¾ç»è°ƒåº¦è¿‡çš„èŠ‚ç‚¹åç§°åˆ—è¡¨    nodesAnnotation: bkci.dispatch.kubenetes/builder-history-nodes    # å®¹å™¨å†å²èµ„æºä½¿ç”¨ç›¸å…³    realResource:      # ç›‘æ§æ„å»ºæœºå®¹å™¨èµ„æºä½¿ç”¨çš„ prometheus apiåœ°å€ï¼Œ å­—æ®µä¸ºç©ºåˆ™ä¸å¼€å¯realResourceä¼˜åŒ–      # æ³¨ï¼šé›†ç¾¤å†…ä¸º é›†ç¾¤å†…ä¸º &lt;service&gt;.&lt;namespace&gt;.svc.cluster.local:&lt;port&gt;      prometheusUrl:       realResourceAnnotation: bkci.dispatch.kubenetes/builder-real-resources  # ä¸€äº›å…·æœ‰ç‰¹å®šå±æ€§çš„æœºå™¨ï¼Œä¾‹å¦‚ç‹¬ç‰¹çš„ç½‘ç»œç­–ç•¥  specialMachine:    label: bkci.dispatch.kubenetes/special-builder  # åªç»™ç‰¹å®šç”¨æˆ·ä½¿ç”¨çš„ä¸“æœº  privateMachine:    label: bkci.dispatch.kubenetes/private-builder\n\né€šè¿‡ dispatch-k8s-manager æ¨¡å—çš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å‘ç°å¯ä»¥é€šè¿‡ nodeSelectorã€ nodesAnnotation ã€realResource ç­‰é…ç½®æ¥è®¾ç½®è°ƒåº¦ç­–ç•¥ã€‚\næºç åˆ†æäº²å’Œæ€§å’Œæ±¡ç‚¹å®¹å¿dispatch-k8s-manager&#x2F;pkg&#x2F;apiserver&#x2F;service&#x2F;builder_start.go\nfunc CreateBuilder(builder *Builder) (taskId string, err error) &#123;  volumes, volumeMounts := getBuilderVolumeAndMount(builder.Name, builder.NFSs)  var replicas int32 = 1  tolers, nodeMatches := buildDedicatedBuilder(builder)    ...  annotations, err := getBuilderAnnotations(builder.Name)  if err != nil &#123;    return &quot;&quot;, err  &#125;  ...  go task.DoCreateBuilder(    taskId,    &amp;kubeclient.Deployment&#123;      Name:        builder.Name,      Labels:      labels,      MatchLabels: matchlabels,      Replicas:    &amp;replicas,      Pod: kubeclient.Pod&#123;        Labels:      labels,        Annotations: annotations,        Volumes:     volumes,        Containers: []kubeclient.Container&#123;          &#123;            Image:        builder.Image,            Resources:    *resources,            Env:          getEnvs(builder.Env),            Command:      builder.Command,            VolumeMounts: volumeMounts,          &#125;,        &#125;,        NodeMatches:     nodeMatches,        Tolerations:     tolers,        PullImageSecret: pullImageSecret,      &#125;,    &#125;,  )    return taskId, nil&#125;// buildDedicatedBuilder è·å–æ±¡ç‚¹å’ŒèŠ‚ç‚¹äº²å’Œåº¦é…ç½®func buildDedicatedBuilder(builder *Builder) ([]corev1.Toleration, []kubeclient.NodeMatch) &#123;    // ä¼˜å…ˆè¯»å–ä¸“æœºé…ç½®    ...    // è¯»å–å…·æœ‰ç‰¹æ®Šé…ç½®çš„æœºå™¨    ...    // å¦‚æœé…ç½®ä¸­é…ç½®äº†èŠ‚ç‚¹é€‰æ‹©å™¨åˆ™ä½¿ç”¨èŠ‚ç‚¹é€‰æ‹©å™¨    ...    return nil, nil&#125;// getBuilderAnnotations è·å–æ„å»ºæœºæ³¨é‡Šé…ç½®func getBuilderAnnotations(builderName string) (map[string]string, error) &#123;  ...  // è·å–èŠ‚ç‚¹è®°å½•ï¼Œç”¨æ¥æŠŠæ„å»ºæœºåˆ†é…åˆ°å·²æœ‰çš„èŠ‚ç‚¹  ...  // è·å–RealResourceè®°å½•  ...  return result, nil&#125;\n\ndispatch-k8s-manager&#x2F;pkg&#x2F;kubeclient&#x2F;deployment.go\nfunc CreateDeployment(dep *Deployment) error &#123;  ...  // å°† NodeMatches è½¬ä¸º nodeAffinity  var affinity *corev1.Affinity  if len(dep.Pod.NodeMatches) &gt; 0 &#123;    var matches []corev1.NodeSelectorRequirement    for _, mat := range dep.Pod.NodeMatches &#123;      matches = append(matches, corev1.NodeSelectorRequirement&#123;        Key:      mat.Key,        Operator: mat.Operator,        Values:   mat.Values,      &#125;)    &#125;    affinity = &amp;corev1.Affinity&#123;      NodeAffinity: &amp;corev1.NodeAffinity&#123;        RequiredDuringSchedulingIgnoredDuringExecution: &amp;corev1.NodeSelector&#123;          NodeSelectorTerms: []corev1.NodeSelectorTerm&#123;            &#123;              MatchExpressions: matches,            &#125;,          &#125;,        &#125;,      &#125;,    &#125;  &#125;  ...  return nil&#125;\nåœ¨ CreateBuilder é‡Œï¼Œè°ƒåº¦ç›¸å…³çš„ä¸¤ä¸ªæ ¸å¿ƒå‚æ•° tolers å’Œ nodeMatches éƒ½æ˜¯é€šè¿‡ buildDedicatedBuilder(builder) è¿”å›çš„ï¼Œè¿™ä¸¤ä¸ªå‚æ•°ä¼šä¸€èµ·ä¼ é€’ç»™ kubeclient å±‚ï¼Œåœ¨ kubeclient çš„ CreateDeployment æ–¹æ³•ä¸­ï¼š\n\nNodeMatches ä¼šè¢«è½¬æ¢ä¸º affinity.nodeAffinityï¼Œç”¨äºèŠ‚ç‚¹äº²å’Œè°ƒåº¦ã€‚\nTolerations ä¼šç›´æ¥ä¸‹å‘åˆ° Pod çš„ spec.tolerations å­—æ®µï¼Œç”¨äºæ±¡ç‚¹å®¹å¿ã€‚\n\nå†å²èŠ‚ç‚¹è°ƒåº¦è“ç›¾æºç é‡Œæˆ‘ä»¬æ‰¾åˆ°äº†æœ‰å…³äº²å’Œæ€§ä»¥åŠæ±¡ç‚¹å®¹å¿çš„å®ç°ï¼Œä½†æ˜¯æœ‰å…³å†å²èŠ‚ç‚¹è°ƒåº¦çš„å®ç°åªæœ‰é€šè¿‡ getBuilderAnnotations ç»™ Pod è®¾ç½®æ³¨è§£ã€‚è‡³äºå¦‚ä½•é€šè¿‡æ³¨è§£å½±å“è°ƒåº¦åœ¨è“ç›¾æºç é‡Œå¹¶æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å†…å®¹ã€‚\næˆ‘ä»¬è¿›ä¸€æ­¥åˆ†æå‘ç°ï¼Œå†å²èŠ‚ç‚¹è°ƒåº¦éœ€è¦é€šè¿‡è“ç›¾åŸºäºK8Sè°ƒåº¦æ’ä»¶å®ç°ã€‚\napiVersion: v1kind: Podmetadata:  annotations:    bkci.dispatch.kubenetes/builder-history-nodes: &#x27;[&quot;10.x.x.1&quot;,&quot;10.x.x.2&quot;,&quot;10.x.x.3&quot;]&#x27;  labels:    bkci.dispatch.kubenetes/core: build1753761077695-ivcpmoxg    bkci.dispatch.kubenetes/watch-task: t-1753785688231121886-iInjpMUr-builder-start  name: build1753761077695-ivcpmoxg-c9d8fc6c9-mqhkk  ...\n\npackage bkdevopsschedulerpluginimport (    &quot;context&quot;    &quot;encoding/json&quot;    &quot;k8s.io/api/core/v1&quot;    &quot;k8s.io/kubernetes/pkg/scheduler/framework&quot;)const nodesAnnotation = &quot;bkci.dispatch.kubenetes/builder-history-nodes&quot;const readResourceAnnotation = &quot;bkci.dispatch.kubenetes/builder-real-resources&quot;type realResourceUsage struct &#123;    Cpu    string `json:&quot;cpu&quot;`    Memory string `json:&quot;memory&quot;`&#125;func (s *SchedulerPlugin) Score(_ context.Context, _ *framework.CycleState, pod *v1.Pod, nodeName string) (int64, *framework.Status) &#123;    // è¯»å–å†å²èŠ‚ç‚¹ä¿¡æ¯    var nodeHis []string    if nodesS, ok := pod.ObjectMeta.Annotations[nodesAnnotation]; ok &#123;        _ = json.Unmarshal([]byte(nodesS), &amp;nodeHis)    &#125;    // è¯»å–èµ„æºä¿¡æ¯    var realResources []realResourceUsage    if realS, ok := pod.ObjectMeta.Annotations[readResourceAnnotation]; ok &#123;        _ = json.Unmarshal([]byte(realS), &amp;realResources)    &#125;    // è®¡ç®—å†å²èŠ‚ç‚¹åˆ†æ•°    nodeScore := calculateNodeHisScore(nodeHis, nodeName)    // è®¡ç®—èµ„æºåˆ†æ•°    // ...çœç•¥èµ„æºåˆ†æ•°è®¡ç®—é€»è¾‘...    realResourceScore := ... // é€šè¿‡ realResources å’ŒèŠ‚ç‚¹èµ„æºæƒ…å†µè®¡ç®—    // è¿”å›æ€»åˆ†    return nodeScore + realResourceScore, nil&#125;var nodeHisScores = map[int]int64&#123;0: 30, 1: 20, 2: 10&#125;// calculateNodeHisScore è®¡ç®—å†å²èŠ‚ç‚¹åˆ†æ•°ï¼Œå°†3ä¸ªå†å²èŠ‚ç‚¹ä»æœ€è¿‘åˆ°æœ€è¿œä¾æ¬¡æ‰“åˆ† 30 - 10åˆ†func calculateNodeHisScore(nodeHis []string, nodeName string) int64 &#123;  if len(nodeHis) == 0 &#123;    return framework.MinNodeScore  &#125;  for index, name := range nodeHis &#123;    if name != nodeName &#123;      continue    &#125;    score := framework.MinNodeScore    if indexS, ok := nodeHisScores[index]; ok &#123;      score = indexS    &#125;    return score  &#125;  return framework.MinNodeScore&#125;\n\n\nåœ¨æ’ä»¶çš„ Score é˜¶æ®µï¼Œä¼šè¯»å– Pod çš„ bkci.dispatch.kubenetes&#x2F;builder-history-nodes æ³¨è§£å†…å®¹ï¼Œå¹¶å°†å…¶ååºåˆ—åŒ–ä¸ºå†å²èŠ‚ç‚¹åç§°æ•°ç»„ï¼Œå³æä¾›å†å²èŠ‚ç‚¹ä¿¡æ¯ã€‚\næ’ä»¶é€šè¿‡ calculateNodeHisScore æ–¹æ³•ï¼Œæ ¹æ®å½“å‰è°ƒåº¦èŠ‚ç‚¹æ˜¯å¦åœ¨å†å²èŠ‚ç‚¹åˆ—è¡¨ä¸­ï¼Œä»¥åŠå…¶åœ¨åˆ—è¡¨ä¸­çš„é¡ºåºï¼Œç»™äºˆä¸åŒçš„åˆ†æ•°ï¼ˆæœ€è¿‘çš„å†å²èŠ‚ç‚¹åˆ†æ•°æœ€é«˜ï¼‰ã€‚\nè¯¥åˆ†æ•°ä¼šä¸èµ„æºåˆ†æ•°ï¼ˆé€šè¿‡ bkci.dispatch.kubenetes&#x2F;builder-real-resources æ³¨è§£å’ŒèŠ‚ç‚¹èµ„æºæƒ…å†µè®¡ç®—å¾—å‡ºï¼‰ç›¸åŠ ï¼Œä½œä¸ºæœ€ç»ˆè°ƒåº¦ä¼˜å…ˆçº§ï¼Œå½±å“è°ƒåº¦å™¨é€‰æ‹©èŠ‚ç‚¹çš„æ’åºã€‚\n\næ€»ç»“åœ¨è“ç›¾æµæ°´çº¿ä¸­ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°äº† Kubernetes çš„è°ƒåº¦ä¼˜åŒ–ï¼š\n\nå†å²èŠ‚ç‚¹è°ƒåº¦ï¼šé€šè¿‡æ³¨è§£è®°å½•å†å²èŠ‚ç‚¹ä¿¡æ¯ï¼Œè°ƒåº¦æ’ä»¶ä¼˜å…ˆé€‰æ‹©è¿™äº›èŠ‚ç‚¹ï¼Œå‡å°‘åˆå§‹åŒ–æ—¶é—´ã€‚\näº²å’Œæ€§ï¼ˆAffinityï¼‰ï¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„ nodeSelector å’Œä»£ç ä¸­çš„ NodeMatches è½¬æ¢ä¸º nodeAffinityï¼Œç¡®ä¿ Pod è°ƒåº¦åˆ°ç‰¹å®šèŠ‚ç‚¹ã€‚\næ±¡ç‚¹å®¹å¿ï¼ˆTolerationsï¼‰ï¼šä»…åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šäº†ä¸“æœºï¼ˆprivateMachineï¼‰æ—¶ï¼Œç”Ÿæˆæ±¡ç‚¹å®¹å¿é…ç½®ï¼Œå…è®¸ Pod è°ƒåº¦åˆ°å¸¦ç‰¹å®šæ±¡ç‚¹çš„èŠ‚ç‚¹ã€‚\n\nè¿™äº›æœºåˆ¶ååŒæå‡äº†è°ƒåº¦æ•ˆç‡å’Œèµ„æºåˆ©ç”¨ç‡ã€‚\nå‚è€ƒ\nhttps://github.com/TencentBlueKing/bk-ci/blob/v2.0.0/\nhttps://github.com/TencentBlueKing/ci-dispatch-k8s-manager-plugin\nhttps://blazehu.com/2025/07/30/devops/landun_dispatch_scheduler/\n\n","categories":["devops/blueking"],"tags":["devops","blueking"]},{"title":"Mcp-Golang-Demo","url":"/2025/08/llm/mcp/mcp-golang-demo/","content":"å‰è¨€å®˜æ–¹sdkä»“åº“ï¼šhttps://github.com/modelcontextprotocol/go-sdk\nç¯å¢ƒå‡†å¤‡åˆ›å»ºå·¥ä½œç›®å½•ï¼šmcp-server# åˆ›å»º&amp;è¿›å…¥å·¥ä½œç›®å½•mkdir mcp-server &amp;&amp; cd mcp-server# åˆå§‹åŒ–go modgo mod init mcp-server\n\nMcp demoæµ‹è¯•-stdio(æœ¬åœ°)æµ‹è¯•å°†ä¸‹é¢çš„ä»£ç ä¿å­˜ä¸ºmain.goæ–‡ä»¶ï¼š\npackage mainimport (    &quot;context&quot;    &quot;fmt&quot;    &quot;log&quot;    &quot;strings&quot;    &quot;github.com/modelcontextprotocol/go-sdk/mcp&quot;)// AddArgs å®šä¹‰åŠ æ³•å·¥å…·çš„è¾“å…¥å‚æ•°type AddArgs struct &#123;    A int `json:&quot;a&quot;`    B int `json:&quot;b&quot;`&#125;func main() &#123;    // åˆ›å»º MCP æœåŠ¡å™¨    s := mcp.NewServer(&quot;Demo&quot;, &quot;1.0.0&quot;, nil)    // æ·»åŠ åŠ æ³•å·¥å…·    addTool := mcp.NewServerTool(       &quot;add&quot;,       &quot;Add two numbers&quot;,       func(ctx context.Context, ss *mcp.ServerSession, params *mcp.CallToolParamsFor[AddArgs]) (*mcp.CallToolResultFor[int], error) &#123;          sum := params.Arguments.A + params.Arguments.B          return &amp;mcp.CallToolResultFor[int]&#123;             Content: []mcp.Content&#123;&amp;mcp.TextContent&#123;Text: fmt.Sprintf(&quot;%d&quot;, sum)&#125;&#125;,          &#125;, nil       &#125;,    )    s.AddTools(addTool)    // æ·»åŠ åŠ¨æ€é—®å€™èµ„æºæ¨¡æ¿    greetingTemplate := &amp;mcp.ServerResourceTemplate&#123;       ResourceTemplate: &amp;mcp.ResourceTemplate&#123;          URITemplate: &quot;greeting://&#123;name&#125;&quot;,          MIMEType:    &quot;text/plain&quot;,       &#125;,       Handler: func(ctx context.Context, ss *mcp.ServerSession, params *mcp.ReadResourceParams) (*mcp.ReadResourceResult, error) &#123;          // ä» URI ä¸­æå– name å‚æ•°          name := strings.TrimPrefix(params.URI, &quot;greeting://&quot;)          greeting := fmt.Sprintf(&quot;Hello, %s!&quot;, name)          return &amp;mcp.ReadResourceResult&#123;             Contents: []*mcp.ResourceContents&#123;                &#123;                   URI:      params.URI,                   MIMEType: &quot;text/plain&quot;,                   Text:     greeting,                &#125;,             &#125;,          &#125;, nil       &#125;,    &#125;    s.AddResourceTemplates(greetingTemplate)    // Run the server over stdin/stdout, until the client disconnects    if err := s.Run(context.Background(), mcp.NewStdioTransport()); err != nil &#123;       log.Fatal(err)    &#125;&#125;\n\nå°†goä»£ç ç¼–è¯‘æˆå¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼š\ngo build -o mcp-server main.go\n\næ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å¯åŠ¨mcp inspectorï¼š\nnpx @modelcontextprotocol/inspector\n\nä¼šæœ‰ç±»ä¼¼çš„è¾“å‡ºï¼š\nStarting MCP inspector...âš™ï¸ Proxy server listening on 127.0.0.1:6277ğŸ”‘ Session token: f53ad695ef69e8b0dce5c340ba7515ef5cad6eeb71938cdedeaaf37a01862166Use this token to authenticate requests or set DANGEROUSLY_OMIT_AUTH=true to disable authğŸ”— Open inspector with token pre-filled:   http://localhost:6274/?MCP_PROXY_AUTH_TOKEN=5191d3a4eec39eb2c355275d0b0152624b61e518f5224b02bcb27e198ea51040#resourcesğŸ” MCP Inspector is up and running at http://127.0.0.1:6274 ğŸš€\n\næ ¹æ®æç¤ºåœ¨å‰ç«¯è®¿é—®ï¼šhttp://localhost:6274/?MCP_PROXY_AUTH_TOKEN=5191d3a4eec39eb2c355275d0b0152624b61e518f5224b02bcb27e198ea51040#resources\nå‰ç«¯éœ€è®¾ç½®çš„å‚æ•°ï¼š\n\nTransport Typeï¼šSTDIO\nCommandå‚æ•°ï¼š.&#x2F;mcp-server\nArgumentså‚æ•°ï¼šâ€“directory &#x2F;Users&#x2F;king&#x2F;workspace-test&#x2F;mcp-server\n\n\nè¿™é‡Œçš„mcp-serverå°±æ˜¯ä¸Šé¢ç¼–è¯‘å‡ºæ¥çš„å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶\n\n\næµ‹è¯•ï¼š\næµ‹è¯•-sse(è¿œç¨‹)æµ‹è¯•å°†ä¸‹é¢çš„ä»£ç ä¿å­˜ä¸ºmain.goæ–‡ä»¶ï¼š\npackage mainimport (    &quot;context&quot;    &quot;fmt&quot;    &quot;log&quot;    &quot;net/http&quot;    &quot;strings&quot;    &quot;github.com/modelcontextprotocol/go-sdk/mcp&quot;)// AddArgs å®šä¹‰åŠ æ³•å·¥å…·çš„è¾“å…¥å‚æ•°type AddArgs struct &#123;    A int `json:&quot;a&quot;`    B int `json:&quot;b&quot;`&#125;func main() &#123;    // åˆ›å»º MCP æœåŠ¡å™¨    s := mcp.NewServer(&quot;Demo&quot;, &quot;1.0.0&quot;, nil)    // æ·»åŠ åŠ æ³•å·¥å…·    addTool := mcp.NewServerTool(       &quot;add&quot;,       &quot;Add two numbers&quot;,       func(ctx context.Context, ss *mcp.ServerSession, params *mcp.CallToolParamsFor[AddArgs]) (*mcp.CallToolResultFor[int], error) &#123;          sum := params.Arguments.A + params.Arguments.B          return &amp;mcp.CallToolResultFor[int]&#123;             Content: []mcp.Content&#123;&amp;mcp.TextContent&#123;Text: fmt.Sprintf(&quot;%d&quot;, sum)&#125;&#125;,          &#125;, nil       &#125;,    )    s.AddTools(addTool)    // æ·»åŠ åŠ¨æ€é—®å€™èµ„æºæ¨¡æ¿    greetingTemplate := &amp;mcp.ServerResourceTemplate&#123;       ResourceTemplate: &amp;mcp.ResourceTemplate&#123;          URITemplate: &quot;greeting://&#123;name&#125;&quot;,          MIMEType:    &quot;text/plain&quot;,       &#125;,       Handler: func(ctx context.Context, ss *mcp.ServerSession, params *mcp.ReadResourceParams) (*mcp.ReadResourceResult, error) &#123;          // ä» URI ä¸­æå– name å‚æ•°          name := strings.TrimPrefix(params.URI, &quot;greeting://&quot;)          greeting := fmt.Sprintf(&quot;Hello, %s!&quot;, name)          return &amp;mcp.ReadResourceResult&#123;             Contents: []*mcp.ResourceContents&#123;                &#123;                   URI:      params.URI,                   MIMEType: &quot;text/plain&quot;,                   Text:     greeting,                &#125;,             &#125;,          &#125;, nil       &#125;,    &#125;    s.AddResourceTemplates(greetingTemplate)    // å¯åŠ¨æœåŠ¡å™¨    // åˆ›å»ºSSEå¤„ç†å™¨    sseHandler := mcp.NewSSEHandler(func(request *http.Request) *mcp.Server &#123;       return s    &#125;)    // è®¾ç½®HTTPè·¯ç”±    http.Handle(&quot;/sse&quot;, sseHandler)    // å¯åŠ¨HTTPæœåŠ¡å™¨    log.Println(&quot;Starting MCP server on :8000...&quot;)    if err := http.ListenAndServe(&quot;:8000&quot;, nil); err != nil &#123;       log.Fatalf(&quot;HTTP server failed: %v&quot;, err)    &#125;&#125;\n\næ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å¯åŠ¨mcp inspectorï¼š\nnpx @modelcontextprotocol/inspector\n\nä¼šæœ‰ç±»ä¼¼çš„è¾“å‡ºï¼š\nStarting MCP inspector...âš™ï¸ Proxy server listening on 127.0.0.1:6277ğŸ”‘ Session token: 6b62eff25370b4bc483516c39e58fa9c25f37c2ecdbabad4ade0ca1d81683687Use this token to authenticate requests or set DANGEROUSLY_OMIT_AUTH=true to disable authğŸ”— Open inspector with token pre-filled:   http://localhost:6274/?MCP_PROXY_AUTH_TOKEN=6b62eff25370b4bc483516c39e58fa9c25f37c2ecdbabad4ade0ca1d81683687ğŸ” MCP Inspector is up and running at http://127.0.0.1:6274 ğŸš€\n\næ ¹æ®æç¤ºåœ¨å‰ç«¯è®¿é—®ï¼šhttp://localhost:6274/?MCP_PROXY_AUTH_TOKEN=5191d3a4eec39eb2c355275d0b0152624b61e518f5224b02bcb27e198ea51040#resources\nå‰ç«¯éœ€è®¾ç½®çš„å‚æ•°ï¼š\n\nTransport Typeï¼šSSE\nURLå‚æ•°ï¼šhttp://localhost:8000/sse\n\n\næ­¤å¤„çš„8000ç«¯å£æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹\n\n\næµ‹è¯•ï¼š\næµ‹è¯•-streamable httpå°†ä¸‹é¢çš„ä»£ç ä¿å­˜ä¸ºmain.goæ–‡ä»¶ï¼š\npackage mainimport (    &quot;context&quot;    &quot;fmt&quot;    &quot;log&quot;    &quot;net/http&quot;    &quot;strings&quot;    &quot;github.com/modelcontextprotocol/go-sdk/mcp&quot;)// AddArgs å®šä¹‰åŠ æ³•å·¥å…·çš„è¾“å…¥å‚æ•°type AddArgs struct &#123;    A int `json:&quot;a&quot;`    B int `json:&quot;b&quot;`&#125;func main() &#123;    // åˆ›å»º MCP æœåŠ¡å™¨    s := mcp.NewServer(&quot;Demo&quot;, &quot;1.0.0&quot;, nil)    // æ·»åŠ åŠ æ³•å·¥å…·    addTool := mcp.NewServerTool(       &quot;add&quot;,       &quot;Add two numbers&quot;,       func(ctx context.Context, ss *mcp.ServerSession, params *mcp.CallToolParamsFor[AddArgs]) (*mcp.CallToolResultFor[int], error) &#123;          sum := params.Arguments.A + params.Arguments.B          return &amp;mcp.CallToolResultFor[int]&#123;             Content: []mcp.Content&#123;&amp;mcp.TextContent&#123;Text: fmt.Sprintf(&quot;%d&quot;, sum)&#125;&#125;,          &#125;, nil       &#125;,    )    s.AddTools(addTool)    // æ·»åŠ åŠ¨æ€é—®å€™èµ„æºæ¨¡æ¿    greetingTemplate := &amp;mcp.ServerResourceTemplate&#123;       ResourceTemplate: &amp;mcp.ResourceTemplate&#123;          URITemplate: &quot;greeting://&#123;name&#125;&quot;,          MIMEType:    &quot;text/plain&quot;,       &#125;,       Handler: func(ctx context.Context, ss *mcp.ServerSession, params *mcp.ReadResourceParams) (*mcp.ReadResourceResult, error) &#123;          // ä» URI ä¸­æå– name å‚æ•°          name := strings.TrimPrefix(params.URI, &quot;greeting://&quot;)          greeting := fmt.Sprintf(&quot;Hello, %s!&quot;, name)          return &amp;mcp.ReadResourceResult&#123;             Contents: []*mcp.ResourceContents&#123;                &#123;                   URI:      params.URI,                   MIMEType: &quot;text/plain&quot;,                   Text:     greeting,                &#125;,             &#125;,          &#125;, nil       &#125;,    &#125;    s.AddResourceTemplates(greetingTemplate)    // å¯åŠ¨æœåŠ¡å™¨    // åˆ›å»ºSSEå¤„ç†å™¨    sseHandler := mcp.NewStreamableHTTPHandler(func(request *http.Request) *mcp.Server &#123;       return s    &#125;, nil)    // è®¾ç½®HTTPè·¯ç”±    http.Handle(&quot;/mcp&quot;, sseHandler)    // å¯åŠ¨HTTPæœåŠ¡å™¨    log.Println(&quot;Starting MCP server on :8000...&quot;)    if err := http.ListenAndServe(&quot;:8000&quot;, nil); err != nil &#123;       log.Fatalf(&quot;HTTP server failed: %v&quot;, err)    &#125;&#125;\n\nå¹¶å°†è„šæœ¬è¿è¡Œèµ·æ¥ï¼\næ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å¯åŠ¨mcp inspectorï¼š\nnpx @modelcontextprotocol/inspector\n\nä¼šæœ‰ç±»ä¼¼çš„è¾“å‡ºï¼š\nStarting MCP inspector...âš™ï¸ Proxy server listening on 127.0.0.1:6277ğŸ”‘ Session token: 6b62eff25370b4bc483516c39e58fa9c25f37c2ecdbabad4ade0ca1d81683687Use this token to authenticate requests or set DANGEROUSLY_OMIT_AUTH=true to disable authğŸ”— Open inspector with token pre-filled:   http://localhost:6274/?MCP_PROXY_AUTH_TOKEN=6b62eff25370b4bc483516c39e58fa9c25f37c2ecdbabad4ade0ca1d81683687ğŸ” MCP Inspector is up and running at http://127.0.0.1:6274 ğŸš€\n\næ ¹æ®æç¤ºåœ¨å‰ç«¯è®¿é—®ï¼šhttp://localhost:6274/?MCP_PROXY_AUTH_TOKEN=5191d3a4eec39eb2c355275d0b0152624b61e518f5224b02bcb27e198ea51040#resources\nå‰ç«¯éœ€è®¾ç½®çš„å‚æ•°ï¼š\n\nTransport Typeï¼šSSE\nURLå‚æ•°ï¼šhttp://localhost:8000/sse\n\n\næ­¤å¤„çš„8000ç«¯å£æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹\n\n\næµ‹è¯•ï¼š\n","categories":["llm/mcp"],"tags":["llm","mcp"]},{"title":"Mcp-Python-Demo","url":"/2025/08/llm/mcp/mcp-python-demo/","content":"å‰è¨€å®˜æ–¹sdkä»“åº“ï¼šhttps://github.com/modelcontextprotocol/python-sdk\nç¯å¢ƒå‡†å¤‡UVå®‰è£…macç¯å¢ƒå®‰è£…å‘½ä»¤ï¼š\ncurl -LsSf https://astral.sh/uv/install.sh | sh\n\nå®‰è£…python 3.13# æŸ¥çœ‹å·²å®‰è£…çš„pythonç‰ˆæœ¬uv python list# å®‰è£…pythonç‰ˆæœ¬3.13uv python install 3.13\n\nåˆ›å»ºå·¥ä½œç›®å½•ï¼šmcp-server# ä½¿ç”¨æŒ‡å®špythonç‰ˆæœ¬åˆå§‹åŒ–å·¥ä½œç›®å½•uv init mcp-server -p 3.13# è¿›å…¥å·¥ä½œç›®å½•cd mcp-server\n\nå®‰è£…mcp sdk# å°†MCPæ·»åŠ åˆ°é¡¹ç›®ä¾èµ–å…³ç³»ä¸­uv add &quot;mcp[cli]&quot;# å¯¹äºä½¿ç”¨pipä½œä¸ºä¾èµ–å…³ç³»çš„é¡¹ç›®pip install &quot;mcp[cli]&quot;\n\nMcp demoæµ‹è¯•-stdio(æœ¬åœ°)æµ‹è¯•å°†ä¸‹é¢çš„ä»£ç ä¿å­˜ä¸ºserver.pyæ–‡ä»¶ï¼š\n# server.pyfrom mcp.server.fastmcp import FastMCP# Create an MCP servermcp = FastMCP(&quot;Demo&quot;)# Add an addition tool@mcp.tool()def add(a: int, b: int) -&gt; int:    &quot;&quot;&quot;Add two numbers&quot;&quot;&quot;    return a + b# Add a dynamic greeting resource@mcp.resource(&quot;greeting://&#123;name&#125;&quot;)def get_greeting(name: str) -&gt; str:    &quot;&quot;&quot;Get a personalized greeting&quot;&quot;&quot;    return f&quot;Hello, &#123;name&#125;!&quot;if __name__ == &#x27;__main__&#x27;:    mcp.run(transport=&#x27;stdio&#x27;)\n\næ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å¯åŠ¨mcp inspectorï¼š\nnpx @modelcontextprotocol/inspector\n\nä¼šæœ‰ç±»ä¼¼çš„è¾“å‡ºï¼š\nStarting MCP inspector...âš™ï¸ Proxy server listening on 127.0.0.1:6277ğŸ”‘ Session token: c6e0d57bbbb6b4ffb134add451bf0b9332582485bfc005e56ad9b85765b89c46Use this token to authenticate requests or set DANGEROUSLY_OMIT_AUTH=true to disable authğŸ”— Open inspector with token pre-filled:   http://localhost:6274/?MCP_PROXY_AUTH_TOKEN=c6e0d57bbbb6b4ffb134add451bf0b9332582485bfc005e56ad9b85765b89c46ğŸ” MCP Inspector is up and running at http://127.0.0.1:6274 ğŸš€\n\næ ¹æ®æç¤ºåœ¨å‰ç«¯è®¿é—®ï¼šhttp://localhost:6274/?MCP_PROXY_AUTH_TOKEN=c6e0d57bbbb6b4ffb134add451bf0b9332582485bfc005e56ad9b85765b89c46\nå‰ç«¯éœ€è®¾ç½®çš„å‚æ•°ï¼š\n\nTransport Typeï¼šSTDIO\nCommandå‚æ•°ï¼šuv\nArgumentså‚æ•°ï¼šâ€“directory &#x2F;Users&#x2F;king&#x2F;workspace-test&#x2F;mcp-server run server.py\n\næµ‹è¯•ï¼š\næµ‹è¯•-sse(è¿œç¨‹)æµ‹è¯•å°†ä¸‹é¢çš„ä»£ç ä¿å­˜ä¸ºserver.pyæ–‡ä»¶ï¼š\n# server.pyfrom mcp.server.fastmcp import FastMCP# Create an MCP servermcp = FastMCP(&quot;Demo&quot;)# Add an addition tool@mcp.tool()def add(a: int, b: int) -&gt; int:    &quot;&quot;&quot;Add two numbers&quot;&quot;&quot;    return a + b# Add a dynamic greeting resource@mcp.resource(&quot;greeting://&#123;name&#125;&quot;)def get_greeting(name: str) -&gt; str:    &quot;&quot;&quot;Get a personalized greeting&quot;&quot;&quot;    return f&quot;Hello, &#123;name&#125;!&quot;if __name__ == &#x27;__main__&#x27;:    mcp.run(transport=&#x27;sse&#x27;)\n\nå¹¶å°†è„šæœ¬è¿è¡Œèµ·æ¥ï¼\næ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å¯åŠ¨mcp inspectorï¼š\nnpx @modelcontextprotocol/inspector\n\nä¼šæœ‰ç±»ä¼¼çš„è¾“å‡ºï¼š\nStarting MCP inspector...âš™ï¸ Proxy server listening on 127.0.0.1:6277ğŸ”‘ Session token: fec89a2677061c6e71dc76da9cb7d3b05305cc5497fc2c2d41bcc2a1c3c20676Use this token to authenticate requests or set DANGEROUSLY_OMIT_AUTH=true to disable authğŸ”— Open inspector with token pre-filled:   http://localhost:6274/?MCP_PROXY_AUTH_TOKEN=fec89a2677061c6e71dc76da9cb7d3b05305cc5497fc2c2d41bcc2a1c3c20676ğŸ” MCP Inspector is up and running at http://127.0.0.1:6274 ğŸš€\n\næ ¹æ®æç¤ºåœ¨å‰ç«¯è®¿é—®ï¼šhttp://localhost:6274/?MCP_PROXY_AUTH_TOKEN=fec89a2677061c6e71dc76da9cb7d3b05305cc5497fc2c2d41bcc2a1c3c20676\nå‰ç«¯éœ€è®¾ç½®çš„å‚æ•°ï¼š\n\nTransport Typeï¼šSSE\nURLå‚æ•°ï¼šhttp://localhost:8000/sse\n\n\næ­¤å¤„çš„8000ç«¯å£æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹\n\n\næµ‹è¯•ï¼š\næµ‹è¯•-streamable httpå°†ä¸‹é¢çš„ä»£ç ä¿å­˜ä¸ºserver.pyæ–‡ä»¶ï¼š\n# server.pyfrom mcp.server.fastmcp import FastMCP# Create an MCP servermcp = FastMCP(&quot;Demo&quot;)# Add an addition tool@mcp.tool()def add(a: int, b: int) -&gt; int:    &quot;&quot;&quot;Add two numbers&quot;&quot;&quot;    return a + b# Add a dynamic greeting resource@mcp.resource(&quot;greeting://&#123;name&#125;&quot;)def get_greeting(name: str) -&gt; str:    &quot;&quot;&quot;Get a personalized greeting&quot;&quot;&quot;    return f&quot;Hello, &#123;name&#125;!&quot;if __name__ == &#x27;__main__&#x27;:    mcp.run(transport=&#x27;streamable-http&#x27;)\n\nå¹¶å°†è„šæœ¬è¿è¡Œèµ·æ¥ï¼\næ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å¯åŠ¨mcp inspectorï¼š\nnpx @modelcontextprotocol/inspector\n\nä¼šæœ‰ç±»ä¼¼çš„è¾“å‡ºï¼š\nStarting MCP inspector...âš™ï¸ Proxy server listening on 127.0.0.1:6277ğŸ”‘ Session token: 54807640c398f18ae4067ce86afe5e9cc56dbb10851b3c9be9de0dfc5af120d4Use this token to authenticate requests or set DANGEROUSLY_OMIT_AUTH=true to disable authğŸ”— Open inspector with token pre-filled:   http://localhost:6274/?MCP_PROXY_AUTH_TOKEN=54807640c398f18ae4067ce86afe5e9cc56dbb10851b3c9be9de0dfc5af120d4ğŸ” MCP Inspector is up and running at http://127.0.0.1:6274 ğŸš€\n\næ ¹æ®æç¤ºåœ¨å‰ç«¯è®¿é—®ï¼šhttp://localhost:6274/?MCP_PROXY_AUTH_TOKEN=54807640c398f18ae4067ce86afe5e9cc56dbb10851b3c9be9de0dfc5af120d4\nå‰ç«¯éœ€è®¾ç½®çš„å‚æ•°ï¼š\n\nTransport Typeï¼šStreamable HTTP\nURLå‚æ•°ï¼šhttp://localhost:8000/mcp\n\n\næ­¤å¤„çš„8000ç«¯å£æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹\n\n\næµ‹è¯•ï¼š\n","categories":["llm/mcp"],"tags":["llm","mcp"]},{"title":"ä½¿ç”¨LangChainå’ŒDeepSeekå®ç°å¤šMCPæœåŠ¡è°ƒç”¨","url":"/2025/08/llm/langchain/shi-yong-langchain-he-deepseek-shi-xian-duo-mcp-fu-wu-diao-yong-v1/","content":"ç¯å¢ƒå‡†å¤‡UVå®‰è£…macç¯å¢ƒå®‰è£…å‘½ä»¤ï¼š\ncurl -LsSf https://astral.sh/uv/install.sh | sh\n\nå®‰è£…python 3.13# æŸ¥çœ‹å·²å®‰è£…çš„pythonç‰ˆæœ¬uv python list# å®‰è£…pythonç‰ˆæœ¬3.13uv python install 3.13\n\nåˆ›å»ºå·¥ä½œç›®å½•ï¼šlangchain-python# ä½¿ç”¨æŒ‡å®špythonç‰ˆæœ¬åˆå§‹åŒ–å·¥ä½œç›®å½•uv init langchain-python -p 3.13# è¿›å…¥å·¥ä½œç›®å½•cd langchain-python\n\nå®‰è£…ä¾èµ–# æ·»åŠ ä¾èµ–uv add langchain langgraphuv add langchain-mcp-adapters uv add -U langchain-deepseek# ä¸€äº›å…¶ä»–ä¾èµ–uv add grpcio grpcio-tools# å¯¹äºä½¿ç”¨pipä½œä¸ºä¾èµ–å…³ç³»çš„é¡¹ç›®pip install -U langchain langgraphpip install -U langchain-mcp-adapterspip install -U langchain-deepseek\n\nMCPå¼€å‘å¼€å‘è®¡ç®—å™¨MCP Serveré€šè¿‡Pythonå¼€å‘å·¥å…·ï¼Œåˆ›å»ºä¸€ä¸ªpythonæ–‡ä»¶ï¼Œå‘½åä¸ºmath_server.pyï¼Œé€šè¿‡stdioä¼ è¾“åè®®å‘å¸ƒã€‚æºä»£ç å¦‚ä¸‹ï¼š\nfrom mcp.server.fastmcp import FastMCPimport logging # é…ç½®æ—¥å¿—è®°å½•å™¨logging.basicConfig(    level=logging.INFO,  # è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º INFO    format=&quot;%(asctime)s - %(levelname)s - %(message)s&quot;  # æ—¥å¿—æ ¼å¼)logger = logging.getLogger(__name__) # åˆ›å»º FastMCP å®ä¾‹mcp = FastMCP(&quot;Math&quot;) @mcp.tool()def add(a: int, b: int) -&gt; int:    &quot;&quot;&quot;Add two numbers&quot;&quot;&quot;    logger.info(&quot;The add method is called: a=%d, b=%d&quot;, a, b)  # è®°å½•åŠ æ³•è°ƒç”¨æ—¥å¿—    return a + b @mcp.tool()def multiply(a: int, b: int) -&gt; int:    &quot;&quot;&quot;Multiply two numbers&quot;&quot;&quot;    logger.info(&quot;The multiply method is called: a=%d, b=%d&quot;, a, b)  # è®°å½•ä¹˜æ³•è°ƒç”¨æ—¥å¿—    return a * b if __name__ == &quot;__main__&quot;:    logger.info(&quot;Start math server through MCP&quot;)  # è®°å½•æœåŠ¡å¯åŠ¨æ—¥å¿—    mcp.run(transport=&quot;stdio&quot;)  # å¯åŠ¨æœåŠ¡å¹¶ä½¿ç”¨æ ‡å‡†è¾“å…¥è¾“å‡ºé€šä¿¡\n\nå¼€å‘å¤©æ°”é¢„æŠ¥MCP Serveré€šè¿‡Pythonå¼€å‘å·¥å…·ï¼Œåˆ›å»ºä¸€ä¸ªpythonæ–‡ä»¶ï¼Œå‘½åä¸ºweather_server.pyï¼Œé€šè¿‡sseä¼ è¾“åè®®å‘å¸ƒã€‚æºä»£ç å¦‚ä¸‹ï¼š\nfrom mcp.server.fastmcp import FastMCPimport logging # é…ç½®æ—¥å¿—è®°å½•å™¨logging.basicConfig(    level=logging.INFO,  # è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º INFO    format=&quot;%(asctime)s - %(levelname)s - %(message)s&quot;  # æ—¥å¿—æ ¼å¼)logger = logging.getLogger(__name__) mcp = FastMCP(&quot;Weather&quot;) @mcp.tool()async def get_weather(location: str) -&gt; str:    &quot;&quot;&quot;Get weather for location.&quot;&quot;&quot;    logger.info(&quot;The get_weather method is called: location=%s&quot;, location)    return &quot;å¤©æ°”é˜³å…‰æ˜åªšï¼Œæ™´ç©ºä¸‡é‡Œã€‚&quot; if __name__ == &quot;__main__&quot;:    logger.info(&quot;Start weather server through MCP&quot;)  # è®°å½•æœåŠ¡å¯åŠ¨æ—¥å¿—    mcp.run(transport=&quot;sse&quot;)\n\nå¼€å‘MCP Clienté€šè¿‡Pythonå¼€å‘å·¥å…·ï¼Œåˆ›å»ºä¸€ä¸ªpythonæ–‡ä»¶ï¼Œå‘½åä¸ºclient.pyã€‚æºä»£ç å¦‚ä¸‹ï¼š\nimport asynciofrom langchain_mcp_adapters.client import MultiServerMCPClientfrom langgraph.prebuilt import create_react_agentfrom langchain_openai import ChatOpenAI  # ä½¿ç”¨å…¼å®¹OpenAIçš„æ¥å£import os# åˆå§‹åŒ– DeepSeek å¤§æ¨¡å‹å®¢æˆ·ç«¯DEEPSEEK_API_KEY = os.getenv(&quot;DEEPSEEK_API_KEY&quot;, &quot;xxx&quot;)llm = ChatOpenAI(    model=&quot;deepseek-r1&quot;,  # æŒ‡å®š DeepSeek çš„æ¨¡å‹åç§°    api_key=DEEPSEEK_API_KEY,  # é˜¿é‡Œäº‘ API Key    base_url=&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;,  # é˜¿é‡Œäº‘å…¼å®¹ç«¯ç‚¹    temperature=0.7,    max_tokens=1024)# è§£æå¹¶è¾“å‡ºç»“æœdef print_optimized_result(agent_response):    &quot;&quot;&quot;    è§£æä»£ç†å“åº”å¹¶è¾“å‡ºä¼˜åŒ–åçš„ç»“æœã€‚    :param agent_response: ä»£ç†è¿”å›çš„å®Œæ•´å“åº”    &quot;&quot;&quot;    messages = agent_response.get(&quot;messages&quot;, [])    steps = []  # ç”¨äºè®°å½•è®¡ç®—æ­¥éª¤    final_answer = None  # æœ€ç»ˆç­”æ¡ˆ    for message in messages:        if hasattr(message, &quot;additional_kwargs&quot;) and &quot;tool_calls&quot; in message.additional_kwargs:            # æå–å·¥å…·è°ƒç”¨ä¿¡æ¯            tool_calls = message.additional_kwargs[&quot;tool_calls&quot;]            for tool_call in tool_calls:                tool_name = tool_call[&quot;function&quot;][&quot;name&quot;]                tool_args = tool_call[&quot;function&quot;][&quot;arguments&quot;]                steps.append(f&quot;è°ƒç”¨å·¥å…·: &#123;tool_name&#125;(&#123;tool_args&#125;)&quot;)        elif message.type == &quot;tool&quot;:            # æå–å·¥å…·æ‰§è¡Œç»“æœ            tool_name = message.name            tool_result = message.content            steps.append(f&quot;&#123;tool_name&#125; çš„ç»“æœæ˜¯: &#123;tool_result&#125;&quot;)        elif message.type == &quot;ai&quot;:            # æå–æœ€ç»ˆç­”æ¡ˆ            final_answer = message.content    # æ‰“å°ä¼˜åŒ–åçš„ç»“æœ    print(&quot;\\nè®¡ç®—è¿‡ç¨‹:&quot;)    for step in steps:        print(f&quot;- &#123;step&#125;&quot;)    if final_answer:        print(f&quot;\\næœ€ç»ˆç­”æ¡ˆ: &#123;final_answer&#125;&quot;)# å®šä¹‰å¼‚æ­¥ä¸»å‡½æ•°async def main():    # åˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹    client = MultiServerMCPClient(        &#123;            &quot;math&quot;: &#123;                &quot;command&quot;: &quot;python&quot;,                &quot;args&quot;: [&quot;./math_server.py&quot;],                &quot;transport&quot;: &quot;stdio&quot;,            &#125;,            &quot;weather&quot;: &#123;                &quot;url&quot;: &quot;http://localhost:8000/sse&quot;,                &quot;transport&quot;: &quot;sse&quot;,            &#125;        &#125;    )    # è·å–å·¥å…·    tools = await client.get_tools()    # åˆ›å»ºä»£ç†    agent = create_react_agent(llm, tools)    # å¾ªç¯æ¥æ”¶ç”¨æˆ·è¾“å…¥    while True:        try:            # æç¤ºç”¨æˆ·è¾“å…¥é—®é¢˜            user_input = input(&quot;\\nè¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ˆæˆ–è¾“å…¥ &#x27;exit&#x27; é€€å‡ºï¼‰ï¼š&quot;)            if user_input.lower() == &quot;exit&quot;:                print(&quot;æ„Ÿè°¢ä½¿ç”¨ï¼å†è§ï¼&quot;)                break            # è°ƒç”¨ä»£ç†å¤„ç†é—®é¢˜            agent_response = await agent.ainvoke(&#123;&quot;messages&quot;: user_input&#125;)            # è°ƒç”¨æŠ½å–çš„æ–¹æ³•å¤„ç†è¾“å‡ºç»“æœ            print_optimized_result(agent_response)        except Exception as e:            print(f&quot;å‘ç”Ÿé”™è¯¯ï¼š&#123;e&#125;&quot;)            continue# ä½¿ç”¨ asyncio è¿è¡Œå¼‚æ­¥ä¸»å‡½æ•°if __name__ == &quot;__main__&quot;:    asyncio.run(main())\n\nå…³é”®ä»£ç è§£é‡Šè¯´æ˜ï¼šlanggraph.prebuilt æ˜¯ LangGraph æ¡†æ¶ä¸­çš„ä¸€ä¸ªæ¨¡å—ï¼Œä¸»è¦ç”¨äºæä¾›é¢„æ„å»ºçš„å·¥å…·å’ŒåŠŸèƒ½ï¼Œä»¥ç®€åŒ–å¤æ‚ä»»åŠ¡çš„å®ç°ã€‚LangGraph æ˜¯ä¸€ä¸ªåŸºäº LangChain çš„æ‰©å±•æ¡†æ¶ï¼Œä¸“æ³¨äºæ„å»ºå¤šæ™ºèƒ½ä½“ï¼ˆmulti-agentï¼‰ç³»ç»Ÿã€å·¥ä½œæµç®¡ç†å’Œä»»åŠ¡ç¼–æ’ã€‚langgraph.prebuilt æä¾›äº†ä¸€äº›ç°æˆçš„ç»„ä»¶å’Œå·¥å…·ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿæ­å»ºç‰¹å®šçš„å·¥ä½œæµæˆ–ä»»åŠ¡é€»è¾‘ï¼Œè€Œæ— éœ€ä»é›¶å¼€å§‹ç¼–å†™ä»£ç ã€‚\nï¼ˆ1ï¼‰from langgraph.prebuilt import create_react_agentæä¾›äº†é¢„å®šä¹‰çš„ä»£ç†ï¼ˆAgentï¼‰æ¨¡æ¿ã€‚langgraph.prebuilt æä¾›äº†ä¸€äº›é¢„å®šä¹‰çš„ä»£ç†ï¼ˆAgentï¼‰æ¨¡æ¿ï¼Œä¾‹å¦‚åŸºäºååº”å¼ï¼ˆreactiveï¼‰é€»è¾‘çš„ä»£ç†ã€‚ è¿™äº›æ¨¡æ¿å¯ä»¥å¿«é€Ÿç”Ÿæˆèƒ½å¤Ÿå¤„ç†ç‰¹å®šä»»åŠ¡çš„ä»£ç†ï¼Œæ¯”å¦‚é—®ç­”ã€ä»»åŠ¡åˆ†è§£ã€å·¥å…·è°ƒç”¨ç­‰ã€‚\nï¼ˆ2ï¼‰agent &#x3D; create_react_agent(llm, client.get_tools())å®ç°äº†å·¥å…·é›†æˆä¸ä»»åŠ¡ç¼–æ’ã€‚æ”¯æŒå°†å¤šä¸ªå·¥å…·ï¼ˆtoolsï¼‰é›†æˆåˆ°å·¥ä½œæµä¸­ï¼Œå¹¶é€šè¿‡é¢„å®šä¹‰çš„é€»è¾‘è¿›è¡Œä»»åŠ¡ç¼–æ’ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°å°†ç®—æœ¯è®¡ç®—å·¥å…·ã€æœç´¢å¼•æ“å·¥å…·æˆ–å…¶ä»–è‡ªå®šä¹‰å·¥å…·é›†æˆåˆ°ä»£ç†çš„å·¥ä½œæµä¸­ã€‚\nè¿è¡Œæµ‹è¯•å…ˆè¿è¡ŒMCP Serverï¼Œå³åˆ†åˆ«è¿è¡Œmath_server.pyå’Œweather_server.pyï¼Œå†è¿è¡Œmath_client.pyï¼Œè¿›è¡ŒAIå¯¹è¯,è§‚å¯Ÿæ—¥å¿—è¾“å‡ºç»“æœï¼Œç¡®å®šæ˜¯å¦ç†è§£äº†ç”¨æˆ·çš„è¾“å…¥ä¿¡æ¯ï¼Œå¹¶åˆ†åˆ«è°ƒç”¨äº†å¯¹åº”çš„MCP ServeræœåŠ¡ã€‚\n\n","categories":["llm/langchain"],"tags":["llm","langchain"]},{"title":"Ldapé€šè¿‡helméƒ¨ç½²","url":"/2025/07/devops/ldap/ldap-tong-guo-helm-bu-shu/","content":"ç®€ä»‹\nâš¡ï¸: OpenLDAPæ˜¯è½»é‡çº§ç›®å½•è®¿é—®åè®®ï¼ˆLDAPï¼‰çš„å¼€æºå®ç°ï¼Œå®ƒæä¾›äº†ä¸€ç§å­˜å‚¨å’Œè®¿é—®å…³äºç”¨æˆ·ã€ç»„ã€è®¡ç®—æœºå’Œå…¶ä»–èµ„æºçš„ä¿¡æ¯çš„ä¸­å¿ƒåŒ–ç›®å½•æœåŠ¡ã€‚\n\nå±æ€§ä»‹ç»\ncnï¼ˆcommon nameï¼‰ï¼šé€šç”¨åç§°ï¼Œè¡¨ç¤ºä¸€ä¸ªå¯¹è±¡çš„åç§°ã€‚åœ¨ç”¨æˆ·æ¡ç›®ä¸­ï¼Œé€šå¸¸ä¸ç”¨æˆ·çš„å§“åç›¸å¯¹åº”ï¼›åœ¨ç»„æ¡ç›®ä¸­ï¼Œåˆ™ä¸ç»„åç›¸å¯¹åº”ã€‚\nouï¼ˆorganizational unitï¼‰ï¼šç»„ç»‡å•ä½ï¼Œè¡¨ç¤ºä¸€ä¸ªç»„ç»‡æˆ–éƒ¨é—¨ã€‚åœ¨LDAPç›®å½•æœåŠ¡ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ouæ¥åˆ›å»ºå¤šçº§ç»„ç»‡ç»“æ„ï¼Œå¹¶å°†ç”¨æˆ·å’Œå…¶ä»–å¯¹è±¡åˆ†é…åˆ°ç›¸åº”çš„ç»„ç»‡å•å…ƒä¸­ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç®¡ç†å®ƒä»¬ã€‚\ndcï¼ˆdomain componentï¼‰ï¼šåŸŸç»„ä»¶ï¼Œè¡¨ç¤ºåŸŸåçš„ä¸€éƒ¨åˆ†ã€‚åœ¨LDAPä¸­ï¼ŒåŸŸåé€šå¸¸æ˜¯æŒ‰ç…§å±‚æ¬¡ç»“æ„ç»„ç»‡çš„ï¼Œä¾‹å¦‚ï¼šexample.comå¯ä»¥è¢«æ‹†åˆ†ä¸ºdc&#x3D;example,dc&#x3D;comã€‚è¿™æ ·åšæœ‰åˆ©äºæœ‰æ•ˆåœ°ç»„ç»‡å’Œç®¡ç†å¤§è§„æ¨¡çš„ç›®å½•æœåŠ¡ã€‚\nsnï¼ˆsurnameï¼‰ï¼šå§“æ°ï¼Œè¡¨ç¤ºä¸€ä¸ªäººçš„å§“æ°ã€‚ä¸cnå±æ€§ä¸åŒï¼Œsnåªè¡¨ç¤ºå§“æ°ï¼Œè€Œä¸”é€šå¸¸ä¸å”¯ä¸€ã€‚\n\nkubernetesé›†ç¾¤éƒ¨ç½²å‚è€ƒå¿«é€Ÿæ­å»ºkindæµ‹è¯•é›†ç¾¤å¿«é€Ÿæ­å»ºä¸€æœ¬åœ°æµ‹ä½¿ç”¨çš„kindé›†ç¾¤ã€‚\nHelméƒ¨ç½²æç®€éƒ¨ç½²helm repo add stable https://charts.helm.sh/stablehelm install openldap stable/openldap\n\nå¸¸è§„éƒ¨ç½²éƒ¨ç½²ååˆ†ç®€å•ï¼Œä½†æ˜¯æˆ‘ä»¬å¯èƒ½éœ€è¦è°ƒæ•´Helm charté…ç½®ï¼Œæ‰€ä»¥å»ºè®®æŠŠåŒ…æ‹‰å–åˆ°æœ¬åœ°è°ƒæ•´ä¹‹åå†è¿›è¡Œéƒ¨ç½²ï¼Œä¸‹é¢æ˜¯è¯¦ç»†æµç¨‹\nå¢åŠ helm repoå¢åŠ helm repoï¼š\nhelm repo add stable https://charts.helm.sh/stable\n\nâœ  ~ helm repo add stable https://charts.helm.sh/stable&quot;stable&quot; has been added to your repositories\n\næ£€ç´¢éªŒè¯repoï¼š\nhelm search repo openldap\nâœ  ~ helm search repo openldapNAME                   CHART VERSION        APP VERSION        DESCRIPTION                                   stable/openldap        1.2.7                2.4.48             DEPRECATED - Community developed LDAP software\næ‹‰å–chartä¸ºäº†èƒ½å¤Ÿè¿›è¡Œé…ç½®ä¿®æ”¹æ“ä½œï¼Œå°†chartæ‹‰åˆ°æœ¬åœ°ï¼š\nhelm pull stable/openldap\n\nè§£å‹chartï¼š\ntar -zxvf openldap-1.2.7.tgz \nâœ  github tar -zxvf openldap-1.2.7.tgz x openldap/Chart.yamlx openldap/values.yamlx openldap/templates/NOTES.txtx openldap/templates/_helpers.tplx openldap/templates/configmap-customldif.yamlx openldap/templates/configmap-env.yamlx openldap/templates/deployment.yamlx openldap/templates/pvc.yamlx openldap/templates/secret.yamlx openldap/templates/service.yamlx openldap/templates/tests/openldap-test-runner.yamlx openldap/templates/tests/openldap-tests.yamlx openldap/.helmignorex openldap/README.md\n\né…ç½®è°ƒæ•´æ‹‰å–çš„ChartåŒ…ï¼Œæ•´ä½“æ¯”è¾ƒå°ï¼Œæ¥çœ‹ä¸‹å¤§æ¦‚çš„ç»“æ„ã€‚\n.â”œâ”€â”€ Chart.yamlâ”œâ”€â”€ README.mdâ”œâ”€â”€ templatesâ”‚Â Â  â”œâ”€â”€ NOTES.txtâ”‚Â Â  â”œâ”€â”€ _helpers.tplâ”‚Â Â  â”œâ”€â”€ configmap-customldif.yamlâ”‚Â Â  â”œâ”€â”€ configmap-env.yamlâ”‚Â Â  â”œâ”€â”€ deployment.yamlâ”‚Â Â  â”œâ”€â”€ pvc.yamlâ”‚Â Â  â”œâ”€â”€ secret.yamlâ”‚Â Â  â”œâ”€â”€ service.yamlâ”‚Â Â  â””â”€â”€ testsâ”‚Â Â      â”œâ”€â”€ openldap-test-runner.yamlâ”‚Â Â      â””â”€â”€ openldap-tests.yamlâ””â”€â”€ values.yaml\n\næˆ‘ä»¬å¦‚æœæœ‰å‚æ•°æ–¹é¢çš„å˜æ›´ï¼Œå¯ä»¥åœ¨values.yamlæ–‡ä»¶å†…è¿›è¡Œå¡«å……é…ç½®ï¼Œæˆ–è€…ä¿®æ”¹é…ç½®ã€‚\ntemplatesç›®å½•ä¸‹å°±æ˜¯æ•´ä¸ªchartçš„æ¨¡æ¿ï¼ŒåŒ…å«äº†éƒ¨ç½²éœ€è¦çš„configmapã€deploymentã€pvcã€secretã€svcç­‰èµ„æºyamlæ¨¡æ¿ã€‚\nåˆšåˆšæˆ‘ä»¬æ‹‰å–çš„ChartåŒ… éƒ¨ç½²openldapï¼Œvalues.yamlæ–‡ä»¶å†…éœ€è¦è°ƒæ•´çš„åœ°æ–¹ä¸æ˜¯å¾ˆå¤š:\nenv:  LDAP_ORGANISATION: &quot;King Inc.&quot;  LDAP_DOMAIN: &quot;king-ldap.net&quot;  LDAP_BACKEND: &quot;hdb&quot;  LDAP_TLS: &quot;false&quot;  LDAP_TLS_ENFORCE: &quot;false&quot;  LDAP_REMOVE_CONFIG_AFTER_SETUP: &quot;false&quot;\n\néƒ¨ç½²åœ¨chartçš„æ ¹ç›®å½•æ‰§è¡Œå®‰è£…ï¼š\nhelm install --kubeconfig=$HOME/.kube/king_test_config ldap ./\n\nPassword:WARNING: This chart is deprecatedNAME: ldapLAST DEPLOYED: Wed Jan 15 21:56:54 2025NAMESPACE: defaultSTATUS: deployedREVISION: 1TEST SUITE: NoneNOTES:OpenLDAP has been installed. You can access the server from within the k8s cluster using:  ldap-openldap.default.svc.cluster.local:389You can access the LDAP adminPassword and configPassword using:  kubectl get secret --namespace default ldap-openldap -o jsonpath=&quot;&#123;.data.LDAP_ADMIN_PASSWORD&#125;&quot; | base64 --decode; echo  kubectl get secret --namespace default ldap-openldap -o jsonpath=&quot;&#123;.data.LDAP_CONFIG_PASSWORD&#125;&quot; | base64 --decode; echoYou can access the LDAP service, from within the cluster (or with kubectl port-forward) with a command like (replace password and domain):  ldapsearch -x -H ldap://ldap-openldap.default.svc.cluster.local:389 -b dc=example,dc=org -D &quot;cn=admin,dc=example,dc=org&quot; -w $LDAP_ADMIN_PASSWORDTest server health using Helm test:  helm test ldapYou can also consider installing the helm chart for phpldapadmin to manage this instance of OpenLDAP, or install Apache Directory Studio, and connect using kubectl port-forward.\n\nHelm æµ‹è¯•helm list ldap\n\næŸ¥çœ‹idapçš„podï¼š\nkubectl --kubeconfig=$HOME/.kube/king_test_config get pod -A|grep ldap\n\nNAMESPACE            NAME                                               READY   STATUS    RESTARTS   AGEdefault              ldap-openldap-6d5cc55fc-vzq5v                      1/1     Running   0          17m\n\nç™»å½•idapçš„podï¼š\nkubectl --kubeconfig=$HOME/.kube/king_test_config exec -it pod/ldap-openldap-6d5cc55fc-vzq5v -- /bin/bash\n\nå¯ä»¥ä½¿ç”¨ldapsearchå‘½ä»¤è¿›è¡ŒæŸ¥è¯¢ï¼š\n$ ldapsearch -x -b &lt;search_base&gt; -H &lt;ldap_host&gt; -D &lt;bind_dn&gt; -W\n\n-xï¼šè¡¨ç¤ºç®€å•çš„èº«ä»½è®¤è¯ã€‚\n-bï¼šæŒ‡å®šæœç´¢çš„ DCã€‚\n-Hï¼šæŒ‡å®šæœç´¢çš„ä¸»æœº URLï¼Œå¦‚æœä½ æ˜¯åœ¨ LDAP æœåŠ¡å™¨ä¸Šï¼Œåˆ™ä¸éœ€è¦å¸¦è¿™ä¸ªå‚æ•°ã€‚æ¯”å¦‚æˆ‘è¿™é‡Œä¸º ldap:&#x2F;&#x2F;192.168.31.76:389\n-Dï¼šç»‘å®šçš„ DNã€‚\n-Wï¼šç»‘å®šçš„ DN çš„å¯†ç ã€‚\n\nä¾‹å¦‚ä¸€ä¸ªå®é™…çš„æŸ¥è¯¢å‘½ä»¤ï¼š\nldapsearch -x -b &quot;dc=king-ldap,dc=net&quot; -D &quot;cn=admin,dc=king-ldap,dc=net&quot;  -W\n\nä¼šè¦æ±‚è¾“å…¥å¯†ç ï¼Œå¯ä»¥å¦‚æ­¤è·å–ï¼š\nenv|grep -i PASSWORD\nLDAP_CONFIG_PASSWORD=M2ulnYD2lZPvM1hKsYP5sCy8meDN8h61LDAP_ADMIN_PASSWORD=a4QL47j3QvQWaTkDolvgLHpbpX8YDTdn\n\næŸ¥è¯¢ç»“æœï¼š\nroot@ldap-openldap-6d5cc55fc-vzq5v:~# ldapsearch -x -b &quot;dc=king-ldap,dc=net&quot; -D &quot;cn=admin,dc=king-ldap,dc=net&quot;  -WEnter LDAP Password: # extended LDIF## LDAPv3# base &lt;dc=king-ldap,dc=net&gt; with scope subtree# filter: (objectclass=*)# requesting: ALL## king-ldap.netdn: dc=king-ldap,dc=netobjectClass: topobjectClass: dcObjectobjectClass: organizationo: King Inc.dc: king-ldap# admin, king-ldap.netdn: cn=admin,dc=king-ldap,dc=netobjectClass: simpleSecurityObjectobjectClass: organizationalRolecn: admindescription: LDAP administratoruserPassword:: e1NTSEF9eEl0d3JvcFN1cTgxelBLSFozVHYzQzJSdmtLcXNXenY=# search resultsearch: 2result: 0 Success# numResponses: 3# numEntries: 2\n\nHelm æ•°æ®æŒä¹…åŒ–ï¼Ÿçœ‹ä¸‹pvcçš„yamlæ¨¡æ¿ï¼š\n&#123;&#123;- if and .Values.persistence.enabled (not .Values.persistence.existingClaim) &#125;&#125;kind: PersistentVolumeClaimapiVersion: v1metadata:  name: &#123;&#123; template &quot;openldap.fullname&quot; . &#125;&#125;  labels:    app: &#123;&#123; template &quot;openldap.name&quot; . &#125;&#125;    chart: &#123;&#123; template &quot;openldap.chart&quot; . &#125;&#125;    release: &#123;&#123; .Release.Name &#125;&#125;    heritage: &#123;&#123; .Release.Service &#125;&#125;&#123;&#123;- if .Values.extraLabels &#125;&#125;&#123;&#123; toYaml .Values.extraLabels | indent 4 &#125;&#125;&#123;&#123;- end &#125;&#125;spec:  accessModes:    - &#123;&#123; .Values.persistence.accessMode | quote &#125;&#125;  resources:    requests:      storage: &#123;&#123; .Values.persistence.size | quote &#125;&#125;&#123;&#123;- if .Values.persistence.storageClass &#125;&#125;&#123;&#123;- if (eq &quot;-&quot; .Values.persistence.storageClass) &#125;&#125;  storageClassName: &quot;&quot;&#123;&#123;- else &#125;&#125;  storageClassName: &quot;&#123;&#123; .Values.persistence.storageClass &#125;&#125;&quot;&#123;&#123;- end &#125;&#125;&#123;&#123;- end &#125;&#125;&#123;&#123;- end &#125;&#125;\n\næ ¹æ®é…ç½®ï¼Œåªè¦åœ¨values.yamlæ–‡ä»¶çš„è¿™éƒ¨åˆ†è¿›è¡Œpvcé…ç½®çš„å¡«å…¥å†è¿›è¡Œå®‰è£…å³å¯ï¼š\n## Persist data to a persistent volumepersistence:  enabled: false  ## database data Persistent Volume Storage Class  ## If defined, storageClassName: &lt;storageClass&gt;  ## If set to &quot;-&quot;, storageClassName: &quot;&quot;, which disables dynamic provisioning  ## If undefined (the default) or set to null, no storageClassName spec is  ##   set, choosing the default provisioner.  (gp2 on AWS, standard on  ##   GKE, AWS &amp; OpenStack)  ##  # storageClass: &quot;-&quot;  accessMode: ReadWriteOnce  size: 8Gi  # existingClaim: &quot;&quot;\n","categories":["devops/ldap"],"tags":["devops","ldap"]},{"title":"gitç¯å¢ƒé…ç½®","url":"/2025/07/devops/environment/git-huan-jing-pei-zhi/","content":"ç¯å¢ƒé…ç½®è®¾ç½®ç”¨æˆ·ç­¾åé…ç½®ç”¨æˆ·åï¼š git config â€“global user.name ä½ çš„ç”¨æˆ·åé…ç½®é‚®ç®±ï¼š git config â€“global user.email æ³¨å†Œçš„é‚®ç®±\né…ç½®å¥½ä¹‹åï¼Œå¯ä»¥ç”¨git config â€“global â€“listå‘½ä»¤æŸ¥çœ‹é…ç½®æ˜¯å¦OK\n$ git config --global --listuser.name=xxxuser.email=xxx@163.com\n\nè®¾ç½®sshKeyç”Ÿæˆæ–°çš„rsaå¯†é’¥ï¼šssh-keygen -t rsa -C â€˜æ³¨å†ŒGitHubçš„é‚®ç®±â€™\nssh-keygen -t rsa -C xxx@163.com\n\nä¸€ç›´å›è½¦å°±å¯ä»¥ï¼Œå³ä¸è®¾ç½®å¯†ç ã€‚\n$ ssh-keygen -t rsa -C xxx@163.comGenerating public/private rsa key pair.Enter file in which to save the key (/home/king/.ssh/id_rsa): Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in /home/king/.ssh/id_rsaYour public key has been saved in /home/king/.ssh/id_rsa.pubThe key fingerprint is:SHA256:n+yyy xxx@163.comThe key&#x27;s randomart image is:+---[RSA 3072]----+|    .*=.+.       ||    = +=o= o     ||     * ++ o .    ||  o . o..  .     || o * .  S o      ||. X o  o = +     || + + .. = *      ||..o .  o E       ||.o==    .        |+----[SHA256]-----+\n\næ­¤æ—¶å·²ç»ç”Ÿæˆäº†ssh rasçš„å¯†é’¥ï¼š\n$ ls $HOME/.sshauthorized_keys  id_rsa  id_rsa.pub  known_hosts\n\nè®¾ç½®githubçš„SSH key\nå°†ä¸Šé¢ç”Ÿæˆçš„sshå…¬é’¥å¤åˆ¶è¿›å»ã€‚\n","categories":["devops/environment"],"tags":["devops","environment"]},{"title":"ä»“åº“forkååŒæ­¥","url":"/2025/07/devops/environment/cang-ku-fork-hou-tong-bu/","content":"forkä»“åº“\næ­¤æ—¶ä¼šå°†è¯¥ä»“åº“åœ¨å¤åˆ¶ä¸€ä»½ï¼Œå¹¶å­˜æ”¾åœ¨ä½ çš„è·¯å¾„ä¸‹ï¼š\nè®¾ç½®ä¸Šæ¸¸ä»£ç åº“è¿›å…¥æœ¬åœ°ä»£ç åº“ï¼š\n# ä»è‡ªå·±ä»“åº“è¿›è¡Œclone(fork)git clone https://github.com/qiqiuyang/bk-ci.git# è¿›å…¥ç›®å½•cd bk-ci/# æŸ¥çœ‹ç›®å½•ç»“æ„$ lsCHANGELOG              CONTRIBUTING.md  README_EN.md  support-filesCODE_OF_CONDUCT.en.md  docker-images    README.md     THIRD-PARTY-NOTICES.txtCODE_OF_CONDUCT.md     docs             scriptsCODEOWNERS             helm-charts      SECURITY.mdCONTRIBUTING.en.md     LICENSE.txt      src\n\næŸ¥çœ‹è¿œç¨‹ä»“åº“çš„è·¯å¾„\n$ git remote -vorigin        https://github.com/qiqiuyang/bk-ci.git (fetch)origin        https://github.com/qiqiuyang/bk-ci.git (push)\n\nè¿™é‡Œå¯ä»¥å‘ç°ä»è‡ªå·±ä»“åº“cloneä¸‹æ¥åï¼Œfetchå’Œpushçš„è·¯å¾„éƒ½æ˜¯è‡ªå·±çš„ã€‚\nè®¾ç½®ä¸Šæ¸¸ä»£ç åº“\n$ git remote add upstream git@github.com:TencentBlueKing/bk-ci.git\n\nå†æ¬¡æŸ¥çœ‹è¿œç¨‹ä»“åº“åœ°å€ï¼š\n$ git remote -vorigin        https://github.com/qiqiuyang/bk-ci.git (fetch)origin        https://github.com/qiqiuyang/bk-ci.git (push)upstream        git@github.com:TencentBlueKing/bk-ci.git (fetch)upstream        git@github.com:TencentBlueKing/bk-ci.git (push)\n\nåŒæ­¥æºä»“åº“çš„æ›´æ–°ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ‹‰å–æºä»“åº“çš„æ›´æ–°ï¼š\n$ git fetch upstreamremote: Enumerating objects: 17643, done.remote: Counting objects: 100% (13492/13492), done.remote: Compressing objects: 100% (3960/3960), done.remote: Total 10070 (delta 4278), reused 8600 (delta 3184), pack-reused 0 (from 0)æ¥æ”¶å¯¹è±¡ä¸­: 100% (10070/10070), 2.44 MiB | 2.05 MiB/s, å®Œæˆ.å¤„ç† delta ä¸­: 100% (4278/4278), å®Œæˆ 657 ä¸ªæœ¬åœ°å¯¹è±¡.æ¥è‡ª github.com:TencentBlueKing/bk-ci * [æ–°åˆ†æ”¯]                master          -&gt; upstream/master * [æ–°åˆ†æ”¯]                release-1.11    -&gt; upstream/release-1.11 * [æ–°åˆ†æ”¯]                release-1.14    -&gt; upstream/release-1.14 * [æ–°åˆ†æ”¯]                release-1.2     -&gt; upstream/release-1.2 * [æ–°åˆ†æ”¯]                release-1.3     -&gt; upstream/release-1.3ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ * [æ–°æ ‡ç­¾]                v1.8.4          -&gt; v1.8.4 * [æ–°æ ‡ç­¾]                v1.8.5          -&gt; v1.8.5\n\nåˆ°è¿™é‡Œå°±æ¯”è¾ƒæ¸…æ™°äº†ï¼Œåœ¨æ›´æ–°æ—¶å°±æ˜¯æŠŠæºä»“åº“çš„æ›´æ–°çš„åˆ†æ”¯æ”¾åœ¨upstreamä¸‹ï¼Œä¾‹å¦‚ï¼šupstream&#x2F;master\næ‰€ä»¥åŒæ­¥è¿œç«¯åˆ†æ”¯æ—¶ï¼Œå°±æ˜¯git fetch upstreamï¼Œç„¶åå°†è‡ªå·±çš„åˆ†æ”¯mergeç›®æ ‡åˆ†æ”¯å†…å®¹ï¼Œä¾‹å¦‚ï¼šgit merge upstream&#x2F;master\nå¦‚æ­¤ä¾¿å¯ä»¥å®ç°è‡ªå·±çš„forkä»“åº“åŒæ­¥æºä»“åº“çš„æ–°å˜æ›´äº†ã€‚\nå‘åŸä»“åº“å‘èµ·PRé¦–å…ˆåœ¨è‡ªå·±çš„ä»“åº“ç‚¹å‡»Pull Request-&gt;New Pull Requestï¼Œè¿›å…¥ä»¥ä¸‹æˆªå›¾é¡µé¢\nbase repositoryä¸ºåŸä»“åº“çš„æŸä¸ªåˆ†æ”¯ï¼Œhead repositoryä¸ºforkä»“åº“å‘æŸä¸ªåˆ†æ”¯, headçš„æŸä¸ªåˆ†æ”¯ä»£ç åˆåˆ°baseçš„æŸä¸ªåˆ†æ”¯\nè¿›å…¥åŸä»“åº“çš„Pull requestså¯çœ‹åˆ°åˆšæ‰å‘èµ·çš„PRï¼Œ è¿™é‡Œå°±ä¸æ¼”ç¤ºäº†\n","categories":["devops/environment"],"tags":["devops","environment"]},{"title":"NPDä»‹ç»","url":"/2025/07/devops/npd/npd-jie-shao/","content":"1 ç®€ä»‹å®˜æ–¹æ–‡æ¡£åº“åœ°å€ï¼šhttps://github.com/kubernetes/node-problem-detector\nnode-problem-detector æ—¨åœ¨ä½¿é›†ç¾¤ç®¡ç†å †æ ˆä¸­çš„ä¸Šæ¸¸å±‚èƒ½å¤Ÿçœ‹åˆ°å„ç§èŠ‚ç‚¹é—®é¢˜ã€‚\nå®ƒæ˜¯ä¸€ä¸ªåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œçš„å®ˆæŠ¤è¿›ç¨‹ï¼Œæ£€æµ‹èŠ‚ç‚¹é—®é¢˜å¹¶å°†å…¶æŠ¥å‘Šç»™apiserverã€‚\nnode-problem-detector å¯ä»¥ä½œä¸º DaemonSet è¿è¡Œï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹è¿è¡Œã€‚\nç°åœ¨å®ƒä½œä¸º GKEé›†ç¾¤ä¸­é»˜è®¤å¯ç”¨çš„Kubernetes Addonè¿è¡Œã€‚å®ƒä¹Ÿä½œä¸ºAKS Linux Extensionçš„ä¸€éƒ¨åˆ†åœ¨ AKS ä¸­é»˜è®¤å¯ç”¨ã€‚\n1.2 èƒŒæ™¯å¤§é‡èŠ‚ç‚¹é—®é¢˜å¯èƒ½ä¼šå½±å“èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ podï¼Œä¾‹å¦‚ï¼š\n\nåŸºç¡€è®¾æ–½å®ˆæŠ¤è¿›ç¨‹é—®é¢˜ï¼šntp æœåŠ¡å…³é—­ï¼›\nç¡¬ä»¶é—®é¢˜ï¼šCPUã€å†…å­˜æˆ–ç£ç›˜æŸåï¼›\nå†…æ ¸é—®é¢˜ï¼šå†…æ ¸æ­»é”ã€æ–‡ä»¶ç³»ç»ŸæŸåï¼›\nå®¹å™¨è¿è¡Œæ—¶é—®é¢˜ï¼šè¿è¡Œæ—¶å®ˆæŠ¤è¿›ç¨‹æ— å“åº”ï¼›\nâ€¦\n\nç›®å‰ï¼Œè¿™äº›é—®é¢˜å¯¹äºé›†ç¾¤ç®¡ç†å †æ ˆä¸­çš„ä¸Šæ¸¸å±‚æ˜¯ä¸å¯è§çš„ï¼Œå› æ­¤ Kubernetes å°†ç»§ç»­å°† pod è°ƒåº¦åˆ°åèŠ‚ç‚¹ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥äº†è¿™ä¸ªæ–°çš„å®ˆæŠ¤è¿›ç¨‹node-problem-detectoræ¥ä»å„ç§å®ˆæŠ¤è¿›ç¨‹æ”¶é›†èŠ‚ç‚¹é—®é¢˜ï¼Œå¹¶å°†å®ƒä»¬æä¾›ç»™ä¸Šæ¸¸å±‚ã€‚ä¸€æ—¦ä¸Šæ¸¸å±‚èƒ½å¤Ÿçœ‹åˆ°è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¨è®º remedy systemsäº†ã€‚\n1.3 Problem APInode-problem-detector ä½¿ç”¨Eventå¹¶å‘NodeConditionapiserver æŠ¥å‘Šé—®é¢˜ã€‚\n\nNodeConditionï¼šå¯¼è‡´èŠ‚ç‚¹æ— æ³•ç”¨äº pod çš„æ°¸ä¹…æ€§é—®é¢˜åº”æŠ¥å‘Šä¸ºNodeConditionã€‚\nEventï¼šå¯¹ pod å½±å“æœ‰é™ä½†å…·æœ‰å‚è€ƒæ„ä¹‰çš„ä¸´æ—¶é—®é¢˜åº”æŠ¥å‘Šä¸ºEventã€‚\n\n1.4 Problem Daemoné—®é¢˜å®ˆæŠ¤è¿›ç¨‹æ˜¯ node-problem-detector çš„ä¸€ä¸ªå­å®ˆæŠ¤è¿›ç¨‹ã€‚å®ƒç›‘è§†ç‰¹å®šç±»å‹çš„èŠ‚ç‚¹é—®é¢˜å¹¶å°†å…¶æŠ¥å‘Šç»™ node-problem-detectorã€‚å®ˆæŠ¤è¿›ç¨‹å¯èƒ½æ˜¯ï¼š\n\nä¸“ä¸º Kubernetes ä¸“ç”¨ç”¨ä¾‹è®¾è®¡çš„å¾®å‹å®ˆæŠ¤è¿›ç¨‹ã€‚\nä¸èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨é›†æˆçš„ç°æœ‰èŠ‚ç‚¹å¥åº·ç›‘æ§å®ˆæŠ¤è¿›ç¨‹ã€‚\n\nç›®å‰ï¼Œé—®é¢˜å®ˆæŠ¤è¿›ç¨‹åœ¨ node-problem-detector äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ä»¥ goroutine çš„å½¢å¼è¿è¡Œã€‚\næœªæ¥ï¼Œæˆ‘ä»¬ä¼šå°† node-problem-detectorå’Œé—®é¢˜å®ˆæŠ¤è¿›ç¨‹åˆ†ç¦»åˆ°ä¸åŒçš„å®¹å™¨ä¸­ï¼Œå¹¶ä½¿ç”¨ pod è§„èŒƒå°†å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·ã€‚\næ¯ç§ç±»å‹çš„é—®é¢˜å®ˆæŠ¤è¿›ç¨‹éƒ½å¯ä»¥é€šè¿‡è®¾ç½®ç›¸åº”çš„æ„å»ºæ ‡ç­¾åœ¨ç¼–è¯‘æ—¶ç¦ç”¨ã€‚\nå¦‚æœåœ¨ç¼–è¯‘æ—¶ç¦ç”¨å®ƒä»¬ï¼Œåˆ™å®ƒä»¬çš„æ‰€æœ‰æ„å»ºä¾èµ–é¡¹ã€å…¨å±€å˜é‡å’Œåå°goroutine éƒ½å°†ä»ç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­å‰”é™¤ã€‚\næ”¯æŒçš„å®ˆæŠ¤è¿›ç¨‹åˆ—è¡¨ï¼š\n\n\n\né—®é¢˜å®ˆæŠ¤è¿›ç¨‹ç±»å‹\nèŠ‚ç‚¹çŠ¶æ€\nè§£é‡Š\né…ç½®\nç¦ç”¨æ„å»ºæ ‡ç­¾\n\n\n\nSystemLogMonitor\nKernelDeadlock ReadonlyFilesystem FrequentKubeletRestart FrequentDockerRestart FrequentContainerdRestart\nç³»ç»Ÿæ—¥å¿—ç›‘è§†å™¨ç›‘è§†ç³»ç»Ÿæ—¥å¿—å¹¶æ ¹æ®é¢„å®šä¹‰çš„è§„åˆ™æŠ¥å‘Šé—®é¢˜å’ŒæŒ‡æ ‡ã€‚\nfilelog, kmsg, kernel, abrt, systemd\ndisable_system_log_monitor\n\n\nSystemStatsMonitor\nNone(Could be added in the future)\nèŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨çš„ç³»ç»Ÿç»Ÿè®¡ç›‘è§†å™¨ï¼Œç”¨äºæ”¶é›†å„ç§ä¸å¥åº·ç›¸å…³çš„ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯ä½œä¸ºæŒ‡æ ‡ã€‚è¯·å‚é˜…æ­¤å¤„çš„ææ¡ˆã€‚\nsystem-stats-monitor\ndisable_system_stats_monitor\n\n\nCustomPluginMonitor\nOn-demand(According to users configuration), existing example: NTPProblem\nä¸€ä¸ªè‡ªå®šä¹‰çš„ node-problem-detector æ’ä»¶ç›‘æ§å™¨ï¼Œç”¨äºè°ƒç”¨å’Œæ£€æŸ¥å„ç§èŠ‚ç‚¹é—®é¢˜ï¼Œå¹¶ä½¿ç”¨ç”¨æˆ·å®šä¹‰çš„æ£€æŸ¥è„šæœ¬ã€‚è¯·å‚é˜…æ­¤å¤„çš„ææ¡ˆã€‚\nexample\ndisable_custom_plugin_monitor\n\n\nHealthChecker\nKubeletUnhealthy ContainerRuntimeUnhealthy\nèŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨çš„å¥åº·æ£€æŸ¥å™¨ç”¨äºæ£€æŸ¥ kubelet å’Œå®¹å™¨è¿è¡Œæ—¶çš„å¥åº·çŠ¶å†µã€‚\n\n\n\n\n1.5 Exporterexporter æ˜¯ node-problem-detector çš„ä¸€ä¸ªç»„ä»¶ã€‚\nå®ƒå‘æŸäº›åç«¯æŠ¥å‘ŠèŠ‚ç‚¹é—®é¢˜ å’Œ&#x2F;æˆ– æŒ‡æ ‡ã€‚\nå…¶ä¸­ä¸€äº›å¯ä»¥åœ¨ç¼–è¯‘æ—¶ä½¿ç”¨æ„å»ºæ ‡è®°ç¦ç”¨ã€‚æ”¯æŒçš„å¯¼å‡ºå™¨åˆ—è¡¨ï¼š\n\n\n\nExporter\nè§£é‡Š\nç¦ç”¨æ„å»ºæ ‡ç­¾\n\n\n\nKubernetes exporter\nKubernetes å¯¼å‡ºå™¨å‘ Kubernetes API æœåŠ¡å™¨æŠ¥å‘ŠèŠ‚ç‚¹é—®é¢˜ï¼šä¸´æ—¶é—®é¢˜æŠ¥å‘Šä¸ºäº‹ä»¶ï¼Œæ°¸ä¹…é—®é¢˜æŠ¥å‘Šä¸ºèŠ‚ç‚¹çŠ¶å†µã€‚\n\n\n\nPrometheus exporter\nPrometheus å¯¼å‡ºå™¨å°†èŠ‚ç‚¹é—®é¢˜å’ŒæŒ‡æ ‡æœ¬åœ°æŠ¥å‘Šä¸º Prometheus æŒ‡æ ‡\n\n\n\nStackdriver exporter\nStackdriver å¯¼å‡ºå™¨å‘ Stackdriver Monitoring API æŠ¥å‘ŠèŠ‚ç‚¹é—®é¢˜å’ŒæŒ‡æ ‡ã€‚\ndisable_stackdriver_exporter\n\n\n1.6 ç”¨æ³•1.6.1 æ ‡å¿—\nâ€“versionï¼šæ‰“å°èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨çš„å½“å‰ç‰ˆæœ¬ã€‚\nâ€“hostname-overrideï¼šnode-problem-detector ç”¨äºæ›´æ–°çŠ¶æ€å’Œå‘å‡ºäº‹ä»¶çš„è‡ªå®šä¹‰èŠ‚ç‚¹åç§°ã€‚node-problem-detector é¦–å…ˆä»hostname-overrideè·å–èŠ‚ç‚¹åç§°ï¼Œç„¶åä»NODE_NAMEç¯å¢ƒå˜é‡ è·å–ï¼Œæœ€åè¿”å›åˆ°os.Hostnameã€‚\n\n1.6.2 å¯¹äºç³»ç»Ÿæ—¥å¿—ç›‘æ§\nâ€“config.system-log-monitorï¼šç³»ç»Ÿæ—¥å¿—ç›‘è§†å™¨é…ç½®æ–‡ä»¶è·¯å¾„åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ config&#x2F;kernel-monitor.jsonã€‚èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨å°†ä¸ºæ¯ä¸ªé…ç½®å¯åŠ¨å•ç‹¬çš„æ—¥å¿—ç›‘è§†å™¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ—¥å¿—ç›‘è§†å™¨æ¥ç›‘è§†ä¸åŒçš„ç³»ç»Ÿæ—¥å¿—ã€‚\n\n1.6.3 å¯¹äºç³»ç»Ÿç»Ÿè®¡ç›‘æ§\nâ€“config.system-stats-monitorï¼šç³»ç»Ÿç»Ÿè®¡ç›‘æ§é…ç½®æ–‡ä»¶çš„è·¯å¾„åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ config&#x2F;system-stats-monitor.jsonã€‚èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨å°†ä¸ºæ¯ä¸ªé…ç½®å¯åŠ¨ä¸€ä¸ªå•ç‹¬çš„ç³»ç»Ÿç»Ÿè®¡ç›‘æ§å™¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä¸åŒçš„ç³»ç»Ÿç»Ÿè®¡ç›‘æ§å™¨æ¥ç›‘æ§ä¸é—®é¢˜ç›¸å…³çš„ä¸åŒç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯ã€‚\n\n1.6.4 å¯¹äºè‡ªå®šä¹‰æ’ä»¶ç›‘è§†å™¨\nâ€“config.custom-plugin-monitorï¼šè‡ªå®šä¹‰æ’ä»¶ç›‘æ§é…ç½®æ–‡ä»¶è·¯å¾„åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ config&#x2F;custom-plugin-monitor.jsonã€‚èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨å°†ä¸ºæ¯ä¸ªé…ç½®å¯åŠ¨ä¸€ä¸ªå•ç‹¬çš„è‡ªå®šä¹‰æ’ä»¶ç›‘æ§ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä¸åŒçš„è‡ªå®šä¹‰æ’ä»¶ç›‘æ§æ¥ç›‘æ§ä¸åŒçš„èŠ‚ç‚¹é—®é¢˜ã€‚\n\n1.6.5 å¯¹äºå¥åº·æ£€æŸ¥è€…\nâ€“enable-k8s-exporterï¼šå¯ç”¨å‘ Kubernetes API æœåŠ¡å™¨æŠ¥å‘Šï¼Œé»˜è®¤ä¸ºtrueã€‚\nâ€“apiserver-overrideï¼šç”¨äºè‡ªå®šä¹‰ node-problem-detector å¦‚ä½•è¿æ¥ apiserver çš„ URI å‚æ•°ã€‚å¦‚æœâ€“enable-k8s-exporteræ˜¯ï¼Œåˆ™å¿½ç•¥æ­¤å‚æ•°ã€‚æ ¼å¼ä¸Heapster çš„æ ‡å¿—falseç›¸åŒã€‚ä¾‹å¦‚ï¼Œè¦æ— éœ€èº«ä»½éªŒè¯å³å¯è¿è¡Œï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼š source\n\nhttp://APISERVER_IP:APISERVER_PORT?inClusterConfig=false\n\nè¯·å‚é˜…heapster æ–‡æ¡£ä»¥è·å–å¯ç”¨é€‰é¡¹çš„å®Œæ•´åˆ—è¡¨ã€‚\n\nâ€“addressï¼šç»‘å®šèŠ‚ç‚¹é—®é¢˜æ£€æµ‹æœåŠ¡å™¨çš„åœ°å€ã€‚\nâ€“portï¼šç»‘å®šèŠ‚ç‚¹é—®é¢˜æ£€æµ‹æœåŠ¡å™¨çš„ç«¯å£ã€‚ä½¿ç”¨ 0 è¡¨ç¤ºç¦ç”¨ã€‚\n\n1.6.6 å¯¹äº Prometheus exporter\nâ€“prometheus-addressï¼šç»‘å®šPrometheusæŠ“å–ç«¯ç‚¹çš„åœ°å€ï¼Œé»˜è®¤ä¸º127.0.0.1ã€‚\nâ€“prometheus-portï¼šç»‘å®š Prometheus æŠ“å–ç«¯ç‚¹çš„ç«¯å£ï¼Œé»˜è®¤ä¸º 20257ã€‚ä½¿ç”¨ 0 è¡¨ç¤ºç¦ç”¨ã€‚\n\n1.6.7 å¯¹äº Stackdriver exporter\nâ€“exporter.stackdriverï¼šStackdriver å¯¼å‡ºå™¨é…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼Œä¾‹å¦‚config&#x2F;exporter&#x2F;stackdriver-exporter.jsonï¼Œé»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²ã€‚è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²å³å¯ç¦ç”¨ã€‚\n\n1.6.8 å·²å¼ƒç”¨çš„æ ‡å¿—\nâ€“system-log-monitorsï¼šç³»ç»Ÿæ—¥å¿—ç›‘æ§é…ç½®æ–‡ä»¶çš„è·¯å¾„åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”ã€‚æ­¤é€‰é¡¹å·²å¼ƒç”¨ï¼Œç”±â€“config.system-log-monitoræ›¿ä»£ï¼Œå¹¶å°†è¢«åˆ é™¤ã€‚å¦‚æœåŒæ—¶è®¾ç½®â€“system-log-monitorså’Œ â€“config.system-log-monitor ï¼Œ NPD å°†å´©æºƒã€‚\nâ€“custom-plugin-monitorsï¼šè‡ªå®šä¹‰æ’ä»¶ç›‘æ§é…ç½®æ–‡ä»¶çš„è·¯å¾„åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”ã€‚æ­¤é€‰é¡¹å·²å¼ƒç”¨ï¼Œç”±â€“config.custom-plugin-monitoræ›¿ä»£ï¼Œå¹¶å°†è¢«åˆ é™¤ã€‚å¦‚æœåŒæ—¶è®¾ç½®â€“custom-plugin-monitorså’Œ â€“config.custom-plugin-monitorï¼ŒNPD å°†å´©æºƒã€‚\n\n1.7 æ„å»ºé•œåƒ\nå®‰è£…libsystemdARM GCC å·¥å…·é“¾çš„å¼€å‘ä¾èµ–é¡¹\nDebian &#x2F; Ubuntuï¼šapt install libsystemd-dev gcc-aarch64-linux-gnu\n\n\ngit clone &#x67;&#105;&#x74;&#x40;&#103;&#105;&#x74;&#104;&#x75;&#98;&#x2e;&#99;&#111;&#x6d;:kubernetes&#x2F;node-problem-detector.git\nåœ¨é¡¶å±‚ç›®å½•ä¸­è¿è¡Œmakeã€‚å®ƒå°†ï¼š\næ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ã€‚\næ„å»ºdockeré•œåƒã€‚äºŒè¿›åˆ¶æ–‡ä»¶å’Œconfig&#x2F;è¢«å¤åˆ¶åˆ°dockeré•œåƒä¸­ã€‚\n\n\n\nå¦‚æœæ‚¨ä¸éœ€è¦æŸäº›ç±»åˆ«çš„é—®é¢˜å®ˆæŠ¤è¿›ç¨‹ï¼Œæ‚¨å¯ä»¥é€‰æ‹©åœ¨ç¼–è¯‘æ—¶ç¦ç”¨å®ƒä»¬ã€‚è¿™æ˜¯ä¿æŒ node-problem-detectorè¿è¡Œæ—¶ç´§å‡‘ä¸”æ²¡æœ‰ä¸å¿…è¦ä»£ç ï¼ˆä¾‹å¦‚å…¨å±€å˜é‡ã€goroutines ç­‰ï¼‰çš„æœ€ä½³æ–¹æ³•ã€‚\næ‚¨å¯ä»¥é€šè¿‡BUILD_TAGSåœ¨è¿è¡Œä¹‹å‰è®¾ç½®ç¯å¢ƒå˜é‡æ¥å®ç°è¿™ä¸€ç‚¹makeã€‚ä¾‹å¦‚ï¼š\nBUILD_TAGS=&quot;disable_custom_plugin_monitor disable_system_stats_monitor&quot; make\n\nä¸Šè¿°å‘½ä»¤å°†åœ¨ä¸ä½¿ç”¨è‡ªå®šä¹‰æ’ä»¶ç›‘è§†å™¨å’Œç³»ç»Ÿç»Ÿè®¡ç›‘è§†å™¨çš„æƒ…å†µä¸‹ç¼–è¯‘node-problem-detector ã€‚æŸ¥çœ‹é—®é¢˜å®ˆæŠ¤è¿›ç¨‹éƒ¨åˆ†ï¼Œäº†è§£å¦‚ä½•åœ¨ç¼–è¯‘æ—¶ç¦ç”¨æ¯ä¸ªé—®é¢˜å®ˆæŠ¤è¿›ç¨‹ã€‚\n1.8 æ¨é€é•œåƒmake pushå°† docker é•œåƒä¸Šä¼ åˆ°æ³¨å†Œè¡¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œé•œåƒå°†ä¸Šä¼ åˆ° staging-k8s.gcr.ioã€‚å¯ä»¥è½»æ¾ä¿®æ”¹Makefileä»¥å°†é•œåƒæ¨é€åˆ°å¦ä¸€ä¸ªæ³¨å†Œè¡¨ã€‚\n1.9 å®‰è£…å°† node-problem-detectorå®‰è£…åˆ°é›†ç¾¤ä¸­çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨Helm å›¾è¡¨ï¼š\nhelm repo add deliveryhero https://charts.deliveryhero.io/helm install --generate-name deliveryhero/node-problem-detector\n\næˆ–è€…ï¼Œæ‰‹åŠ¨å®‰è£… node-problem-detectorï¼š\nç¼–è¾‘node-problem-detector.yamlä»¥é€‚åº”æ‚¨çš„ç¯å¢ƒã€‚å°†logå·è®¾ç½®ä¸ºæ‚¨çš„ç³»ç»Ÿæ—¥å¿—ç›®å½•ï¼ˆç”± SystemLogMonitor ä½¿ç”¨ï¼‰ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ ConfigMap è¦†ç›–config pod å†…çš„ç›®å½•ã€‚\nç¼–è¾‘node-problem-detector-config.yamlæ¥é…ç½® node-problem-detectorã€‚\n\nç¼–è¾‘rbac.yamlä»¥é€‚åˆæ‚¨çš„ç¯å¢ƒã€‚\nä½¿ç”¨ åˆ›å»º ServiceAccount å’Œ ClusterRoleBinding kubectl create -f rbac.yamlã€‚\nä½¿ç”¨ åˆ›å»º ConfigMap kubectl create -f node-problem-detector-config.yamlã€‚\nä½¿ç”¨ åˆ›å»º DaemonSet kubectl create -f node-problem-detector.yamlã€‚\n\n1.10 å¼€å§‹ç‹¬ç«‹è¿è¡Œè¦ç‹¬ç«‹è¿è¡Œ node-problem-detectorï¼Œæ‚¨åº”è¯¥è®¾ç½®inClusterConfigä¸ºfalseï¼Œå¹¶ä¸”æ•™ node-problem-detector å¦‚ä½• è®¿é—® apiserverï¼Œä¹Ÿå°±æ˜¯apiserver-overrideã€‚\nè¦ä½¿ç”¨ä¸å®‰å…¨çš„ apiserver è¿æ¥ç‹¬ç«‹è¿è¡Œ node-problem-detectorï¼š\nnode-problem-detector --apiserver-override=http://APISERVER_IP:APISERVER_INSECURE_PORT?inClusterConfig=false\n\næ›´å¤šåœºæ™¯è¯·è§æ­¤å¤„\n1.11 è¯•ç”¨æ‚¨å¯ä»¥åœ¨æ­£åœ¨è¿è¡Œçš„é›†ç¾¤ä¸­å°è¯•ä½¿ç”¨ node-problem-detectorï¼Œæ–¹æ³•æ˜¯å°†æ¶ˆæ¯æ³¨å…¥åˆ° node-problem-detector æ­£åœ¨ç›‘è§†çš„æ—¥å¿—ä¸­ã€‚\nä¾‹å¦‚ï¼Œå‡è®¾ node-problem-detector æ­£åœ¨ä½¿ç”¨KernelMonitorã€‚\nåœ¨æ‚¨çš„æœºå™¨ä¸Šè¿è¡Œkubectl get events -wã€‚åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œsudo sh -c &quot;echo &#39;kernel: BUG: unable to handle kernel NULL pointer dereference at TESTING&#39; &gt;&gt; /dev/kmsg&quot;ã€‚ç„¶åæ‚¨åº”è¯¥ä¼šçœ‹åˆ°è¯¥KernelOopssäº‹ä»¶ã€‚\næ·»åŠ æ–°è§„åˆ™æˆ–å¼€å‘èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨æ—¶ï¼Œåœ¨ç‹¬ç«‹æ¨¡å¼ä¸‹åœ¨æœ¬åœ°å·¥ä½œç«™ä¸Šè¿›è¡Œæµ‹è¯•å¯èƒ½æ›´å®¹æ˜“ã€‚\nå¯¹äº API æœåŠ¡å™¨ï¼Œä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨kubectl proxyæ­£åœ¨è¿è¡Œçš„é›†ç¾¤çš„ API æœåŠ¡å™¨åœ¨æœ¬åœ°å¯ç”¨ã€‚\næ‚¨ä¼šæ”¶åˆ°ä¸€äº›é”™è¯¯ï¼Œå› ä¸º API æœåŠ¡å™¨æ— æ³•è¯†åˆ«æ‚¨çš„æœ¬åœ°å·¥ä½œç«™ã€‚ä½†æ— è®ºå¦‚ä½•ï¼Œæ‚¨ä»ç„¶åº”è¯¥èƒ½å¤Ÿæµ‹è¯•æ‚¨çš„æ–°è§„åˆ™ã€‚\nä¾‹å¦‚ï¼Œæµ‹è¯•KernelMonitorè§„åˆ™ï¼š\n\nmakeï¼ˆæœ¬åœ°æ„å»ºnode-problem-detectorï¼‰\nkubectl proxy --port=8080ï¼ˆä½¿æ­£åœ¨è¿è¡Œçš„é›†ç¾¤çš„ API æœåŠ¡å™¨åœ¨æœ¬åœ°å¯ç”¨ï¼‰\nå°†KernelMonitoræ›´æ–°åˆ°æ‚¨çš„æœ¬åœ°å†…æ ¸æ—¥å¿—ç›®å½•logPathã€‚ä¾‹å¦‚ï¼Œåœ¨æŸäº› Linux ç³»ç»Ÿä¸Šï¼Œå®ƒæ˜¯/run/log/journal, è€Œä¸æ˜¯/var/log/journalã€‚\n./bin/node-problem-detector --logtostderr --apiserver-override=http://127.0.0.1:8080?inClusterConfig=false --config.system-log-monitor=config/kernel-monitor.json --config.system-stats-monitor=config/system-stats-monitor.json --port=20256 --prometheus-port=2025ï¼ˆæˆ–æŒ‡å‘ä»»ä½• API æœåŠ¡å™¨åœ°å€ï¼šç«¯å£å’Œ Prometheus ç«¯å£ï¼‰\nsudo sh -c &quot;echo &#39;kernel: BUG: unable to handle kernel NULL pointer dereference at TESTING&#39; &gt;&gt; /dev/kmsg&quot;\næ‚¨å¯ä»¥KernelOopsåœ¨èŠ‚ç‚¹é—®é¢˜æ£€æµ‹å™¨æ—¥å¿—ä¸­çœ‹åˆ°äº‹ä»¶ã€‚\nsudo sh -c &quot;echo &#39;kernel: INFO: task docker:20744 blocked for more than 120 seconds.&#39; &gt;&gt; /dev/kmsg&quot;\næ‚¨å¯ä»¥åœ¨node-problem-detector logçœ‹DockerHung eventå’ŒçŠ¶æ€\næ‚¨å¯ä»¥åœ¨http://127.0.0.1:20256/conditionsæŸ¥çœ‹DockerHungçŠ¶æ€\næ‚¨å¯ä»¥åœ¨http://127.0.0.1:20257/metricsä¸ŠæŸ¥çœ‹ Prometheus æ ¼å¼çš„ç£ç›˜ç›¸å…³ç³»ç»ŸæŒ‡æ ‡ã€‚\n\næ³¨ï¼š æ‚¨å¯ä»¥åœ¨test&#x2F;kernel_log_generator&#x2F;problemsä¸‹æŸ¥çœ‹æ›´å¤šè§„åˆ™ç¤ºä¾‹ã€‚\n\nå¯¹äºKernelMonitoræ¶ˆæ¯æ³¨å…¥ï¼Œæ‰€æœ‰æ¶ˆæ¯éƒ½åº”è¯¥æœ‰kernel: å‰ç¼€ï¼ˆå¦è¯·æ³¨æ„ï¼Œåé¢æœ‰ä¸€ä¸ªç©ºæ ¼:ï¼‰ï¼›æˆ–è€…ä½¿ç”¨generator.shã€‚\nè¦å°†å…¶ä»–æ—¥å¿—ï¼ˆå¦‚ systemd æ—¥å¿—ï¼‰æ³¨å…¥ journaldï¼Œè¯·ä½¿ç”¨echo &#39;Some systemd message&#39; | systemd-cat -t systemdã€‚\n\n1.12 Remedy SystemsRemedy Systemsæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæ—¨åœ¨å°è¯•è§£å†³node-problem-detectoræ£€æµ‹åˆ°çš„é—®é¢˜çš„è¿‡ç¨‹ã€‚\nRemedy Systemsä¼šè§‚å¯Ÿnode-problem-detectorå‘å‡ºçš„äº‹ä»¶ å’Œ&#x2F;æˆ– èŠ‚ç‚¹çŠ¶å†µï¼Œå¹¶é‡‡å–æªæ–½ä½¿ Kubernetes é›†ç¾¤æ¢å¤å¥åº·çŠ¶æ€ã€‚\nè¡¥æ•‘ç³»ç»Ÿæœ‰ä»¥ä¸‹å‡ ç§ï¼š\n\nDraino æ ¹æ®æ ‡ç­¾å’ŒèŠ‚ç‚¹æ¡ä»¶è‡ªåŠ¨æ’ç©º KubernetesèŠ‚ç‚¹ã€‚ä¸æ‰€æœ‰æä¾›çš„æ ‡ç­¾å’Œä»»ä½•æä¾›çš„èŠ‚ç‚¹æ¡ä»¶åŒ¹é…çš„èŠ‚ç‚¹å°†è¢«é˜»æ­¢ç«‹å³æ¥å—æ–° podï¼ˆä¹Ÿç§°ä¸ºâ€œå°é”â€ï¼‰ï¼Œå¹¶åœ¨å¯é…ç½®çš„æ—¶é—´åæ’ç©ºã€‚Drainoå¯ä»¥ä¸ Cluster Autoscalerç»“åˆä½¿ç”¨ï¼Œä»¥è‡ªåŠ¨ç»ˆæ­¢æ’ç©ºçš„èŠ‚ç‚¹ã€‚è¯·å‚é˜… æ­¤é—®é¢˜ ï¼Œäº†è§£ Drainoçš„ç¤ºä¾‹ç”Ÿäº§ç”¨ä¾‹ã€‚\nDescheduler å–æ¶ˆè°ƒåº¦ç­–ç•¥RemovePodsViolatingNodeTaintsä¼šé©±é€èŠ‚ç‚¹ä¸Šè¿åNoScheduleæ±¡æŸ“çš„Podã€‚å¿…é¡»å¯ç”¨k8sè°ƒåº¦ç¨‹åºçš„TaintNodesByConditionåŠŸèƒ½ã€‚\nCluster Autoscaler å¯ç”¨äºè‡ªåŠ¨ç»ˆæ­¢è€—å°½çš„èŠ‚ç‚¹ã€‚\nmediK8S æ˜¯ä¸€ä¸ªåŸºäºNode Health Check Operator (NHC)æ„å»ºçš„è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿçš„æ€»ä½“é¡¹ç›®ï¼Œè¯¥ç³»ç»Ÿç›‘æ§èŠ‚ç‚¹çŠ¶å†µå¹¶ä½¿ç”¨ä¿®å¤ APIå°†ä¿®å¤å§”æ‰˜ç»™å¤–éƒ¨ä¿®å¤ç¨‹åºã€‚\nPoison-Pillæ˜¯ä¸€ä¸ªä¿®å¤ç¨‹åºï¼Œå®ƒå°†é‡æ–°å¯åŠ¨èŠ‚ç‚¹å¹¶ç¡®ä¿æ‰€æœ‰æœ‰çŠ¶æ€çš„å·¥ä½œè´Ÿè½½éƒ½å¾—åˆ°é‡æ–°å®‰æ’ã€‚å¦‚æœé›†ç¾¤å…·æœ‰è¶³å¤Ÿçš„å¥åº·å®¹é‡ï¼ŒNHCæ”¯æŒæœ‰æ¡ä»¶åœ°è¿›è¡Œä¿®å¤ï¼Œæˆ–è€…æ‰‹åŠ¨æš‚åœä»»ä½•æ“ä½œä»¥æœ€å¤§é™åº¦åœ°å‡å°‘é›†ç¾¤ä¸­æ–­ã€‚\nCluster API çš„MachineHealthCheckè´Ÿè´£ä¿®å¤ä¸å¥åº·çš„æœºå™¨ã€‚\n\n","categories":["devops/npd"],"tags":["devops","npd"]},{"title":"Npdä»£ç ç»“æ„äº†è§£","url":"/2025/07/devops/npd/npd-dai-ma-jie-gou-liao-jie/","content":"1 pkgç›®å½•ç»“æ„è¿™é‡Œæ˜¯å„ä¸ªmonitorçš„å®ç°ã€‚\n.â”œâ”€â”€ custompluginmonitor             -&gt; ç”¨äºå®ç°è‡ªå®šä¹‰ç›‘è§†æ’ä»¶ã€‚node-problem-detector æ”¯æŒé€šè¿‡æ’ä»¶ç›‘è§†ç‰¹å®šçŠ¶æ€æˆ–äº‹ä»¶ï¼Œæ­¤ç›®å½•ä¸­åŒ…å«ä¸ç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶ç›¸å…³çš„ä»£ç ã€‚â”œâ”€â”€ exporters                       -&gt; ç”¨äºåŒ…å«å¯¼å‡ºå™¨ï¼ˆexportersï¼‰çš„å®ç°ï¼Œå¯¼å‡ºå™¨è´Ÿè´£å°†ç›‘è§†åˆ°çš„æ•°æ®å‘é€åˆ°å¤–éƒ¨ç³»ç»Ÿï¼Œæ¯”å¦‚ç›‘æ§ç³»ç»Ÿï¼ˆä¾‹å¦‚ Prometheusï¼‰ã€‚å¯¼å‡ºå™¨åœ¨æ•°æ®æ”¶é›†å’Œç›‘æ§é›†æˆä¸­èµ·åˆ°å…³é”®ä½œç”¨ã€‚â”œâ”€â”€ healthchecker                   -&gt; å®ç°å¥åº·æ£€æŸ¥é€»è¾‘ï¼Œç¡®ä¿ node-problem-detector æœ¬èº«å’Œå…¶ä»–ä¾èµ–çš„ç»„ä»¶å¤„äºå¥åº·çŠ¶æ€ã€‚è¿™æ˜¯ç›‘æ§å’Œç»´æŠ¤è½¯ä»¶ç¨³å®šæ€§çš„é‡è¦éƒ¨åˆ†ã€‚â”œâ”€â”€ logcounter                      -&gt; å®ç°äº† logcounter çš„åŠŸèƒ½ï¼Œé€šå¸¸ç”¨äºè®¡æ•°å’Œåˆ†æç³»ç»Ÿæ—¥å¿—ï¼Œä»¥æ£€æµ‹å¼‚å¸¸è¡Œä¸ºæˆ–é—®é¢˜ã€‚å®ƒå¯ä»¥ä¸ç³»ç»Ÿæ—¥å¿—ç›‘æ§ç»“åˆä½¿ç”¨ã€‚â”œâ”€â”€ problemdaemon                   -&gt; å®ç°é—®é¢˜å®ˆæŠ¤ç¨‹åºã€‚è¿™ä¸ªå®ˆæŠ¤ç¨‹åºè´Ÿè´£ç›‘æµ‹å’Œè¯†åˆ«èŠ‚ç‚¹ä¸­çš„é—®é¢˜ï¼Œé€šè¿‡é—®é¢˜å‘ç°æœºåˆ¶æ”¶é›†æŒ‡æ ‡å¹¶ç”Ÿæˆå‘Šè­¦ã€‚â”œâ”€â”€ problemdetector                 -&gt; åŒ…å«é—®é¢˜æ£€æµ‹çš„æ ¸å¿ƒé€»è¾‘ã€‚è¿™æ˜¯ node-problem-detector çš„ä¸»è¦åŠŸèƒ½éƒ¨åˆ†ï¼Œè´Ÿè´£ä»ä¸åŒçš„æ¥æºæ”¶é›†ä¿¡æ¯ï¼Œå¹¶æ ¹æ®è¿™äº›ä¿¡æ¯è¯†åˆ«å’ŒæŠ¥å‘ŠèŠ‚ç‚¹é—®é¢˜ã€‚â”œâ”€â”€ problemmetrics                  -&gt; åŒ…å«é—®é¢˜æŒ‡æ ‡çš„å®ç°ï¼Œç”¨äºæ”¶é›†ã€å¤„ç†å’Œå¯¼å‡ºæœ‰å…³èŠ‚ç‚¹çŠ¶æ€å’Œé—®é¢˜çš„æ•°æ®ã€‚è¿™äº›æŒ‡æ ‡å¯ä»¥å±•ç¤ºåœ¨ç›‘æ§ç•Œé¢ä¸Šï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£ç³»ç»Ÿçš„å¥åº·çŠ¶å†µã€‚â”œâ”€â”€ systemlogmonitor                -&gt; å®ç°äº†ç³»ç»Ÿæ—¥å¿—ç›‘æ§çš„åŠŸèƒ½ã€‚å®ƒå¤„ç†ç³»ç»Ÿæ—¥å¿—ï¼Œåˆ†ææ—¥å¿—å†…å®¹ï¼Œä»¥æ£€æµ‹å¯èƒ½å¯¼è‡´é—®é¢˜çš„äº‹ä»¶å’Œé”™è¯¯ã€‚â”œâ”€â”€ systemstatsmonitor              -&gt; ç”¨äºç›‘æ§ç³»ç»Ÿçš„å„ç§ç»Ÿè®¡æ•°æ®ï¼Œä¾‹å¦‚ CPU ä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨æƒ…å†µç­‰ã€‚å®ƒè´Ÿè´£æ”¶é›†å’ŒæŠ¥å‘Šè¿™äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œä»¥å¸®åŠ©éªŒè¯èŠ‚ç‚¹çš„å¥åº·çŠ¶æ€ã€‚â”œâ”€â”€ types                           -&gt; ç”¨äºå®šä¹‰é¡¹ç›®ä¸­ä½¿ç”¨çš„å„ç§ç±»å‹ç»“æ„ä½“å’Œå¸¸é‡ã€‚è¿™äº›ç±»å‹é€šå¸¸ç”¨äºæ•°æ®ä¼ è¾“å’Œå¤„ç†ï¼Œä¸ºæ ¸å¿ƒé€»è¾‘æä¾›æ•°æ®æ¨¡å‹ã€‚â”œâ”€â”€ util                            -&gt; åŒ…å«ä¸€äº›å…¬ç”¨å·¥å…·å‡½æ•°å’Œåº“ï¼Œè¿™äº›å‡½æ•°å¯ä»¥åœ¨å…¶ä»–æ¨¡å—ä¸­å¤ç”¨ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§ã€‚â””â”€â”€ version                         -&gt; ä¿å­˜ä¸ç‰ˆæœ¬ç›¸å…³çš„ä¿¡æ¯å’Œç»“æ„ã€‚å®ƒç”¨äºç®¡ç†ç‰ˆæœ¬å·å¹¶æä¾›ç‰ˆæœ¬ä¿¡æ¯çš„åŠŸèƒ½\n\n2 problemdaemon2.1 Registerpkg&#x2F;problemdaemon&#x2F;problem_daemon.go:32\nvar (        handlers = make(map[types.ProblemDaemonType]types.ProblemDaemonHandler))// Register registers a problem daemon factory method, which will be used to create the problem daemon.func Register(problemDaemonType types.ProblemDaemonType, handler types.ProblemDaemonHandler) &#123;        handlers[problemDaemonType] = handler&#125;\n\næ³¨å†Œä¸€ä¸ªé—®é¢˜å®ˆæŠ¤è¿›ç¨‹å·¥å‚æ–¹æ³•ã€‚å‚æ•°ï¼š\n\nproblemDaemonType: éœ€è¦æ³¨å†Œçš„å®ˆæŠ¤è¿›ç¨‹ç±»å‹ã€‚\nhandler: å¯¹åº”çš„å¤„ç†å™¨ï¼Œå…¶ä¸­åŒ…å«åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹çš„æ–¹æ³•ã€‚ä½œç”¨ï¼šå°†æŒ‡å®šç±»å‹çš„å¤„ç†å™¨æ·»åŠ åˆ° handlers æ˜ å°„ä¸­ï¼Œä»¥ä¾¿åç»­æ ¹æ®ç±»å‹è·å–å¯¹åº”çš„å¤„ç†å™¨ã€‚\n\n2.2 GetProblemDaemonNamespkg&#x2F;problemdaemon&#x2F;problem_daemon.go:37\n// GetProblemDaemonNames retrieves all available problem daemon types.func GetProblemDaemonNames() []types.ProblemDaemonType &#123;        problemDaemonTypes := []types.ProblemDaemonType&#123;&#125;        for problemDaemonType := range handlers &#123;                problemDaemonTypes = append(problemDaemonTypes, problemDaemonType)        &#125;        return problemDaemonTypes&#125;\n\næ£€ç´¢æ‰€æœ‰å¯ç”¨çš„é—®é¢˜å®ˆæŠ¤è¿›ç¨‹ç±»å‹ã€‚\nè¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰æ³¨å†Œçš„å®ˆæŠ¤è¿›ç¨‹ç±»å‹çš„åˆ‡ç‰‡ã€‚\nå®ç°ç»†èŠ‚ï¼šéå† handlers æ˜ å°„ï¼Œå°†æ¯ç§é—®é¢˜å®ˆæŠ¤è¿›ç¨‹ç±»å‹æ·»åŠ åˆ°è¿”å›çš„åˆ‡ç‰‡ä¸­ã€‚\n2.3 GetProblemDaemonHandlerOrDiepkg&#x2F;problemdaemon&#x2F;problem_daemon.go:46\n// GetProblemDaemonHandlerOrDie retrieves the ProblemDaemonHandler for a specific type of problem daemon, panic if error occurs..func GetProblemDaemonHandlerOrDie(problemDaemonType types.ProblemDaemonType) types.ProblemDaemonHandler &#123;        handler, ok := handlers[problemDaemonType]        if !ok &#123;                panic(fmt.Sprintf(&quot;Problem daemon handler for %v does not exist&quot;, problemDaemonType))        &#125;        return handler&#125;\n\nè·å–ç‰¹å®šç±»å‹é—®é¢˜å®ˆæŠ¤è¿›ç¨‹çš„å¤„ç†å™¨ã€‚\nå‚æ•°ï¼šé—®é¢˜å®ˆæŠ¤è¿›ç¨‹ç±»å‹ã€‚\nè¿”å›å€¼ï¼šè¿”å›å¯¹åº”çš„å¤„ç†å™¨ã€‚\nå®ç°ç»†èŠ‚ï¼šå¦‚æœæŒ‡å®šç±»å‹æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å¤„ç†å™¨ï¼Œåˆ™è§¦å‘ææ…Œï¼ˆpanicï¼‰ï¼Œè¿™é€šå¸¸ç”¨äºåœ¨åˆå§‹åŒ–æ—¶ç¡®ä¿é…ç½®çš„æœ‰æ•ˆæ€§ã€‚\n2.4 NewProblemDaemonspkg&#x2F;problemdaemon&#x2F;problem_daemon.go:55\n// NewProblemDaemons creates all problem daemons based on the configurations provided.func NewProblemDaemons(monitorConfigPaths types.ProblemDaemonConfigPathMap) []types.Monitor &#123;        problemDaemonMap := make(map[string]types.Monitor)        for problemDaemonType, configs := range monitorConfigPaths &#123;                for _, config := range *configs &#123;                        if _, ok := problemDaemonMap[config]; ok &#123;                                // Skip the config if it&#x27;s duplicated.                                klog.Warningf(&quot;Duplicated problem daemon configuration %q&quot;, config)                                continue                        &#125;                        problemDaemonMap[config] = handlers[problemDaemonType].CreateProblemDaemonOrDie(config)                &#125;        &#125;        problemDaemons := []types.Monitor&#123;&#125;        for _, problemDaemon := range problemDaemonMap &#123;                problemDaemons = append(problemDaemons, problemDaemon)        &#125;        return problemDaemons&#125;\n\næ ¹æ®æä¾›çš„é…ç½®åˆ›å»ºæ‰€æœ‰é—®é¢˜å®ˆæŠ¤è¿›ç¨‹ã€‚\nå‚æ•°ï¼š\nmonitorConfigPaths: åŒ…å«æ¯ç§é—®é¢˜å®ˆæŠ¤è¿›ç¨‹ç±»å‹åŠå…¶å¯¹åº”é…ç½®è·¯å¾„çš„æ˜ å°„ã€‚è¿”å›å€¼ï¼šè¿”å›åˆ›å»ºçš„æ‰€æœ‰ Monitor å®ä¾‹çš„åˆ‡ç‰‡ã€‚å®ç°ç»†èŠ‚\n\nåˆ›å»ºç©ºæ˜ å°„ï¼šä½¿ç”¨ problemDaemonMap å­˜å‚¨å·²åˆ›å»ºçš„å®ˆæŠ¤è¿›ç¨‹ï¼Œä»¥é¿å…é‡å¤ã€‚\néå†é…ç½®ï¼š\nå¯¹äºé…ç½®ä¸­çš„æ¯ç§é—®é¢˜å®ˆæŠ¤è¿›ç¨‹ç±»å‹åŠå…¶ç›¸åº”çš„é…ç½®è·¯å¾„ï¼Œæ£€æŸ¥æ˜¯å¦å·²ç»åˆ›å»ºã€‚\nå¦‚æœé…ç½®å·²å­˜åœ¨ï¼Œåˆ™è®°å½•è­¦å‘Šå¹¶è·³è¿‡ã€‚\nä½¿ç”¨æ³¨å†Œçš„å¤„ç†å™¨åˆ›å»ºæ–°çš„é—®é¢˜å®ˆæŠ¤è¿›ç¨‹å¹¶å°†å…¶æ·»åŠ åˆ°æ˜ å°„ä¸­ã€‚\n\n\nè¿”å›å€¼æ„å»ºï¼šå°†åœ°å›¾ä¸­çš„æ‰€æœ‰å®ˆæŠ¤è¿›ç¨‹è½¬æ¢ä¸ºåˆ‡ç‰‡å¹¶è¿”å›ã€‚\n\n3 problem_detector3.1 problemDetectorå®šä¹‰pkg&#x2F;problemdetector&#x2F;problem_detector.go:33\n// ProblemDetector collects statuses from all problem daemons and update the node condition and send node event.type ProblemDetector interface &#123;        Run(context.Context) error&#125;type problemDetector struct &#123;        monitors  []types.Monitor        exporters []types.Exporter&#125;\n\nå­—æ®µï¼š\nmonitors: å­˜å‚¨ç›‘æ§å™¨çš„åˆ‡ç‰‡ï¼Œç”¨äºæ”¶é›†é—®é¢˜çŠ¶æ€ã€‚\nexporters: å­˜å‚¨å¯¼å‡ºå™¨çš„åˆ‡ç‰‡ï¼Œç”¨äºå°†æ”¶é›†åˆ°çš„çŠ¶æ€å‘é€åˆ°å¤–éƒ¨ç³»ç»Ÿæˆ–ç”¨æˆ·ã€‚\næ–¹æ³•è¯´æ˜ï¼š Run(context.Context) error å¯åŠ¨é—®é¢˜æ£€æµ‹å™¨ï¼Œå¹¶åœ¨ä¸Šä¸‹æ–‡è¢«å–æ¶ˆæˆ–å‡ºç°é”™è¯¯æ—¶è¿”å›é”™è¯¯ã€‚\n3.2 NewProblemDetectorpkg&#x2F;problemdetector&#x2F;problem_detector.go:40\n// NewProblemDetector creates the problem detector. Currently we just directly passed in the problem daemons, but// in the future we may want to let the problem daemons register themselves.func NewProblemDetector(monitors []types.Monitor, exporters []types.Exporter) ProblemDetector &#123;        return &amp;problemDetector&#123;                monitors:  monitors,                exporters: exporters,        &#125;&#125;\nåˆ›å»ºä¸€ä¸ªæ–°çš„é—®é¢˜æ£€æµ‹å™¨å®ä¾‹ã€‚\nå‚æ•°ï¼š\nmonitors: ç›‘æ§å™¨æ•°ç»„ï¼Œç”¨äºæ£€æµ‹ä¸åŒé—®é¢˜ã€‚\nexporters: å¯¼å‡ºå™¨æ•°ç»„ï¼Œç”¨äºå°†çŠ¶æ€å‘é€ç»™å¤–éƒ¨ç³»ç»Ÿã€‚\nè¿”å›å€¼ï¼šè¿”å›å®ç° ProblemDetector æ¥å£çš„æ–°çš„ problemDetector å®ä¾‹ã€‚\n3.3 Runpkg&#x2F;problemdetector&#x2F;problem_detector.go:48\n// Run starts the problem detector.func (p *problemDetector) Run(ctx context.Context) error &#123;        // Start the log monitors one by one.        var chans []&lt;-chan *types.Status        failureCount := 0        for _, m := range p.monitors &#123;                ch, err := m.Start()                if err != nil &#123;                        // Do not return error and keep on trying the following config files.                        klog.Errorf(&quot;Failed to start problem daemon %v: %v&quot;, m, err)                        failureCount++                        continue                &#125;                if ch != nil &#123;                        chans = append(chans, ch)                &#125;        &#125;        allMonitors := p.monitors        if len(allMonitors) == failureCount &#123;                return fmt.Errorf(&quot;no problem daemon is successfully setup&quot;)        &#125;        defer func() &#123;                for _, m := range allMonitors &#123;                        m.Stop()                &#125;        &#125;()        ch := groupChannel(chans)        klog.Info(&quot;Problem detector started&quot;)        for &#123;                select &#123;                case &lt;-ctx.Done():                        return nil                case status := &lt;-ch:                        for _, exporter := range p.exporters &#123;                                exporter.ExportProblems(status)                        &#125;                &#125;        &#125;&#125;\n\næ‰§è¡Œé—®é¢˜æ£€æµ‹å™¨çš„ä¸»è¦è¿è¡Œé€»è¾‘ã€‚\nå®ç°ç»†èŠ‚ï¼š\n\nå¼€å§‹ç›‘æ§å™¨ï¼šéå†å¹¶å¯åŠ¨æ¯ä¸ªç›‘æ§å™¨ã€‚\nå¦‚æœå¯åŠ¨å¤±è´¥ï¼Œè®°å½•é”™è¯¯å¹¶å¢åŠ å¤±è´¥è®¡æ•°ã€‚\nå¦‚æœæˆåŠŸï¼Œåˆ™å°†è¿”å›çš„é€šé“æ·»åŠ åˆ° chans åˆ‡ç‰‡ã€‚\næ£€æŸ¥å¤±è´¥æƒ…å†µï¼šå¦‚æœæ‰€æœ‰ç›‘æ§å™¨éƒ½å¤±è´¥ï¼Œåˆ™è¿”å›é”™è¯¯ã€‚\nå»¶è¿Ÿå…³é—­ï¼šåœ¨å‡½æ•°ç»“æŸæ—¶åœæ­¢æ‰€æœ‰ç›‘æ§å™¨ã€‚\né€šé“ç»„åˆï¼šè°ƒç”¨ groupChannel å‡½æ•°ï¼Œç”¨äºå°†æ‰€æœ‰ç›‘æ§å™¨çš„çŠ¶æ€é€šé“ç»„åˆæˆå•ä¸€é€šé“ã€‚\nç›‘å¬çŠ¶æ€ï¼šä½¿ç”¨ select ä¸æ–­ç›‘å¬ä¸Šä¸‹æ–‡å’Œç›‘æ§å™¨çš„çŠ¶æ€ã€‚\nå¦‚æœæ”¶åˆ°çŠ¶æ€ï¼Œä»æ‰€æœ‰å¯¼å‡ºå™¨å¯¼å‡ºé—®é¢˜ã€‚\n\n3.4 groupChannelpkg&#x2F;problemdetector&#x2F;problem_detector.go:91\nfunc groupChannel(chans []&lt;-chan *types.Status) &lt;-chan *types.Status &#123;        statuses := make(chan *types.Status)        for _, ch := range chans &#123;                go func(c &lt;-chan *types.Status) &#123;                        for status := range c &#123;                                statuses &lt;- status                        &#125;                &#125;(ch)        &#125;        return statuses&#125;\n\nå°†å¤šä¸ªçŠ¶æ€é€šé“ç»„åˆä¸ºä¸€ä¸ªé€šé“ã€‚\nå‚æ•°ï¼šåˆ‡ç‰‡ chansï¼ŒåŒ…å«å¤šä¸ªçŠ¶æ€é€šé“ã€‚\nè¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ªæ–°çš„é€šé“ statusesï¼Œç”¨äºæ¥æ”¶æ¥è‡ªæ‰€æœ‰ç›‘æ§å™¨çš„çŠ¶æ€ã€‚\nå®ç°ç»†èŠ‚\nå¯åŠ¨å¤šä¸ª goroutineï¼Œæ¯ä¸ª goroutine ä»ä¸€ä¸ªç›‘æ§å™¨çš„é€šé“è¯»å–çŠ¶æ€ï¼Œå¹¶å°†å…¶è½¬å‘åˆ°æ–°çš„ statuses é€šé“ä¸­ã€‚\n4 problemmetrics4.1 ProblemMetricsManagerå®šä¹‰pkg&#x2F;problemmetrics&#x2F;problem_metrics.go:40\n// ProblemMetricsManager manages problem-converted metrics.// ProblemMetricsManager is thread-safe.type ProblemMetricsManager struct &#123;        problemCounter           metrics.Int64MetricInterface        problemGauge             metrics.Int64MetricInterface        problemTypeToReason      map[string]string        problemTypeToReasonMutex sync.Mutex&#125;\n\nå­—æ®µï¼š\n\nproblemCounter: ä¸€ä¸ªæ•´å‹æŒ‡æ ‡æ¥å£ï¼Œç”¨äºè®¡æ•°ç‰¹å®šé—®é¢˜å‘ç”Ÿçš„æ¬¡æ•°ã€‚\nproblemGauge: ä¸€ä¸ªæ•´å‹æŒ‡æ ‡æ¥å£ï¼Œç”¨äºè¡¨ç¤ºç‰¹å®šé—®é¢˜æ˜¯å¦å¯¹èŠ‚ç‚¹äº§ç”Ÿå½±å“ã€‚\nproblemTypeToReason: ä¸€ä¸ªæ˜ å°„ï¼Œä¿å­˜é—®é¢˜ç±»å‹ä¸åŸå› çš„å…³ç³»ã€‚\nproblemTypeToReasonMutex: ä¸€ä¸ªäº’æ–¥é”ï¼Œç”¨äºä¿æŠ¤ problemTypeToReason çš„å¹¶å‘è®¿é—®ã€‚\n\n4.2 initpkg&#x2F;problemmetrics&#x2F;problem_metrics.go:31\n// GlobalProblemMetricsManager is a singleton of ProblemMetricsManager,// which should be used to manage all problem-converted metrics across all// problem daemons.var GlobalProblemMetricsManager *ProblemMetricsManagerfunc init() &#123;        GlobalProblemMetricsManager = NewProblemMetricsManagerOrDie()&#125;\n\nGlobalProblemMetricsManager: å…¨å±€å”¯ä¸€çš„ ProblemMetricsManager å®ä¾‹ï¼Œç”¨äºç®¡ç†æ‰€æœ‰é—®é¢˜ç›¸å…³çš„æŒ‡æ ‡ã€‚\ninit å‡½æ•°: åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆå§‹åŒ– GlobalProblemMetricsManagerï¼Œç¡®ä¿å…¶å¯ç”¨ã€‚\n4.3 NewProblemMetricsManagerOrDiepkg&#x2F;problemmetrics&#x2F;problem_metrics.go:47\nfunc NewProblemMetricsManagerOrDie() *ProblemMetricsManager &#123;        pmm := ProblemMetricsManager&#123;&#125;        var err error        pmm.problemCounter, err = metrics.NewInt64Metric(                metrics.ProblemCounterID,                string(metrics.ProblemCounterID),                &quot;Number of times a specific type of problem have occurred.&quot;,                &quot;1&quot;,                metrics.Sum,                []string&#123;&quot;reason&quot;&#125;)        if err != nil &#123;                klog.Fatalf(&quot;Failed to create problem_counter metric: %v&quot;, err)        &#125;        pmm.problemGauge, err = metrics.NewInt64Metric(                metrics.ProblemGaugeID,                string(metrics.ProblemGaugeID),                &quot;Whether a specific type of problem is affecting the node or not.&quot;,                &quot;1&quot;,                metrics.LastValue,                []string&#123;&quot;type&quot;, &quot;reason&quot;&#125;)        if err != nil &#123;                klog.Fatalf(&quot;Failed to create problem_gauge metric: %v&quot;, err)        &#125;        pmm.problemTypeToReason = make(map[string]string)        return &amp;pmm&#125;\n\nåˆ›å»ºå¹¶åˆå§‹åŒ– ProblemMetricsManager å®ä¾‹ã€‚\nå®ç°ç»†èŠ‚ï¼š\nåˆ›å»º problemCounter æŒ‡æ ‡ï¼Œç”¨äºè®°å½•ç‰¹å®šé—®é¢˜çš„å‘ç”Ÿæ¬¡æ•°ï¼Œæ¥æ”¶æ ‡ç­¾ reasonã€‚\nåˆ›å»º problemGauge æŒ‡æ ‡ï¼Œç”¨äºæŒ‡ç¤ºç‰¹å®šé—®é¢˜æ˜¯å¦æ­£åœ¨å½±å“èŠ‚ç‚¹ï¼Œæ¥æ”¶æ ‡ç­¾ type å’Œ reasonã€‚\nå¦‚æœåˆ›å»ºæŒ‡æ ‡å¤±è´¥ï¼Œåˆ™ç¨‹åºä¼šå´©æºƒï¼ˆFatalfï¼‰ã€‚\nåˆå§‹åŒ–é—®é¢˜ç±»å‹åˆ°åŸå› çš„æ˜ å°„ã€‚\n4.4 IncrementProblemCounterpkg&#x2F;problemmetrics&#x2F;problem_metrics.go:79\n// IncrementProblemCounter increments the value of a problem counter.func (pmm *ProblemMetricsManager) IncrementProblemCounter(reason string, count int64) error &#123;        if pmm.problemCounter == nil &#123;                return errors.New(&quot;problem counter is being incremented before initialized.&quot;)        &#125;        return pmm.problemCounter.Record(map[string]string&#123;&quot;reason&quot;: reason&#125;, count)&#125;\n\nå¢åŠ é—®é¢˜è®¡æ•°å™¨çš„å€¼ï¼Œæ ¹æ® reason æ ‡ç­¾è®°å½•ç»Ÿè®¡æ•°æ®ã€‚\nå‚æ•°ï¼š\nreason: é—®é¢˜å‘ç”Ÿçš„åŸå› ã€‚\ncount: è¦å¢åŠ çš„æ•°é‡ã€‚\nè¿”å›å€¼ï¼šè¿”å›å¯èƒ½çš„é”™è¯¯ã€‚\n4.5 SetProblemGaugepkg&#x2F;problemmetrics&#x2F;problem_metrics.go:88\n// SetProblemGauge sets the value of a problem gauge.func (pmm *ProblemMetricsManager) SetProblemGauge(problemType string, reason string, value bool) error &#123;        if pmm.problemGauge == nil &#123;                return errors.New(&quot;problem gauge is being set before initialized.&quot;)        &#125;        pmm.problemTypeToReasonMutex.Lock()        defer pmm.problemTypeToReasonMutex.Unlock()        // We clear the last reason, because the expected behavior is that at any point of time,        // for each type of permanent problem, there should be at most one reason got set to 1.        // This behavior is consistent with the behavior of node condition in Kubernetes.        // However, problemGauges with different &quot;type&quot; and &quot;reason&quot; are considered as different        // metrics in Prometheus. So we need to clear the previous metrics explicitly.        if lastReason, ok := pmm.problemTypeToReason[problemType]; ok &#123;                err := pmm.problemGauge.Record(map[string]string&#123;&quot;type&quot;: problemType, &quot;reason&quot;: lastReason&#125;, 0)                if err != nil &#123;                        return fmt.Errorf(&quot;failed to clear previous reason %q for type %q: %v&quot;,                                problemType, lastReason, err)                &#125;        &#125;        pmm.problemTypeToReason[problemType] = reason        var valueInt int64        if value &#123;                valueInt = 1        &#125;        return pmm.problemGauge.Record(map[string]string&#123;&quot;type&quot;: problemType, &quot;reason&quot;: reason&#125;, valueInt)&#125;\n\nè®¾ç½®é—®é¢˜é‡è§„çš„å€¼ï¼ŒæŒ‡ç¤ºç‰¹å®šé—®é¢˜å¯¹èŠ‚ç‚¹çš„å½±å“ã€‚\nå‚æ•°ï¼š\n\nproblemType: é—®é¢˜ç±»å‹ï¼ˆä¾‹å¦‚ï¼ŒèŠ‚ç‚¹ä¸å¯ç”¨ï¼‰ã€‚\nreason: å…·ä½“åŸå› ã€‚\nvalue: è¡¨ç¤ºé—®é¢˜çš„çŠ¶æ€ï¼Œtrueè¡¨ç¤ºé—®é¢˜å­˜åœ¨ (1)ï¼Œfalseè¡¨ç¤ºé—®é¢˜æ¶ˆå¤± (0)ã€‚\n\nå®ç°ç»†èŠ‚ï¼š\n\nä½¿ç”¨äº’æ–¥é”ä¿æŠ¤å¯¹ problemTypeToReason çš„å¹¶å‘è®¿é—®ã€‚\næ¸…é™¤ä¹‹å‰çš„åŸå› ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œä¿è¯æ¯ä¸ªé—®é¢˜ç±»å‹åœ¨ä»»ä½•æ—¶åˆ»éƒ½æœ€å¤šåªæœ‰ä¸€ä¸ªåŸå› è¢«è®¾ç½®ä¸º 1ã€‚\nè®°å½•æ–°çš„é‡è§„å€¼ã€‚\n\n5 exportersç›®å½•ç»“æ„ï¼š\n.â”œâ”€â”€ k8sexporterâ”‚   â”œâ”€â”€ conditionâ”‚   â”œâ”€â”€ k8s_exporter.goâ”‚   â””â”€â”€ problemclientâ”œâ”€â”€ prometheusexporterâ”‚   â””â”€â”€ prometheus_exporter.goâ”œâ”€â”€ register.goâ”œâ”€â”€ register_test.goâ””â”€â”€ stackdriver    â”œâ”€â”€ config    â”œâ”€â”€ gce    â”œâ”€â”€ stackdriver_exporter.go    â””â”€â”€ stackdriver_exporter_test.go\nè¿™é‡Œå°±æ¶‰åŠåˆ°äº†ä¸‰ä¸ªexporterï¼Œåˆ†åˆ«æ˜¯k8sexporterã€prometheusexporterã€stackdriver_exporter\nè¿™ä¸‰ä¸ªæ˜¯æ¯”è¾ƒç‹¬ç«‹çš„ï¼Œå› ä¸ºèƒ½åŠ›æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ï¼Œ\n\nexporterï¼šä¸“æ³¨äºå°†types.Statusçš„eventå’Œconditationä¸ŠæŠ¥ï¼Œå¹¶ä¸”ä¼šæœ‰ä¸€äº›httpæœåŠ¡æ¥å£å¼€æ”¾(healthzã€conditionsã€&#x2F;debug&#x2F;pprof)ï¼Œ\nprometheusexporterï¼šç›´æ¥ç”¨çš„prometheuseçš„åº“ï¼Œç®€å•ç†è§£å°±æ˜¯ä¸ºäº†è®©prometheuseå¯ä»¥é‡‡é›†åˆ°æ•°æ®\nstackdriver_exporterï¼šå¤„ç†ä¸ Google Stackdriver çš„é›†æˆï¼ŒStackdriver æ˜¯ Google Cloud æä¾›çš„ç›‘æ§å’Œç®¡ç†å¹³å°ï¼Œè¯¥exporterè´Ÿè´£å°†æŒ‡æ ‡æ•°æ®å‘é€åˆ°Stackdriverï¼Œä»¥ä¾¿åœ¨ Google Cloud ç¯å¢ƒä¸­ç›‘æ§åº”ç”¨ç¨‹åºå’Œé›†ç¾¤çŠ¶æ€ã€‚\n\nè¿™é‡Œæ¥è¯´è¯´æˆ‘çš„ç†è§£å§ï¼Œprometheusexporterå’Œstackdriver_exporterè¿™ä¸¤ä¸ªexporteræ˜¯ä¸ºäº†å°†metricæ•°æ®å‘é€åˆ°å¯¹åº”çš„ç›‘æ§å¹³å°ï¼Œè€Œk8sexporteråˆ™æ˜¯ä¸ºäº†å°†types.Statuså‘é€åˆ°k8sï¼Œç›®å‰å·²ç»å¼€å§‹å‘registerç»§æ‰¿æ–¹å‘å»¶å±•ï¼Œå¦‚stackdriver_exporterå·²ç»ä½¿ç”¨è¯¥æ¨¡å¼å¹¶ä¸”å·²ç»ç»Ÿä¸€äº†structçš„å®ç°æ–¹æ³•ï¼Œä½†æ˜¯prometheusexporterå’Œk8sexporterè¿˜æ²¡å®Œæˆæ¼”å˜ï¼Œç›®å‰è¿˜æ˜¯é€šè¿‡packageç›´æ¥è°ƒç”¨çš„æ–¹å¼ä½¿ç”¨çš„ã€‚\nè¿™ä¸ªæ¨¡å—å°±ä¸è¿›è¡Œä»£ç çº§åˆ«è§£æäº†ï¼Œæ•´ä½“æ˜¯éå¸¸ç®€å•çš„ã€‚\n6 healthcheckerç›®å½•ç»“æ„ï¼š\nâ”œâ”€â”€ health_checker.goâ”œâ”€â”€ health_checker_darwin.goâ”œâ”€â”€ health_checker_linux.goâ”œâ”€â”€ health_checker_test.goâ”œâ”€â”€ health_checker_windows.goâ””â”€â”€ typesâ”œâ”€â”€ types.goâ”œâ”€â”€ types_test.goâ”œâ”€â”€ types_unix.goâ””â”€â”€ types_windows.go\n\n6.1 healthCheckerå®šä¹‰pkg&#x2F;healthchecker&#x2F;health_checker.go:31\ntype healthChecker struct &#123;  component       string  service         string  enableRepair    bool  healthCheckFunc func () (bool, error)  // The repair is &quot;best-effort&quot; and ignores the error from the underlying actions.  // The bash commands to kill the process will fail if the service is down and hence ignore.  repairFunc         func ()  uptimeFunc         func () (time.Duration, error)  crictlPath         string  healthCheckTimeout time.Duration  coolDownTime       time.Duration  loopBackTime       time.Duration  logPatternsToCheck map[string]int&#125;\n\nå­—æ®µå«ä¹‰ï¼š\n\ncomponentï¼šè¢«æ£€æŸ¥çš„ Kubernetes ç»„ä»¶åç§°ï¼ˆå¦‚ Kubeletã€Kube Proxy ç­‰ï¼‰ã€‚\nserviceï¼šæœåŠ¡åç§°æˆ–æ ‡è¯†ç¬¦ã€‚\nenableRepairï¼šå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºæ˜¯å¦åœ¨å‘ç°æœåŠ¡ä¸å¥åº·æ—¶å°è¯•ä¿®å¤å®ƒã€‚\nhealthCheckFuncï¼šä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºæ‰§è¡Œå¥åº·æ£€æŸ¥ï¼Œè¿”å›å¥åº·çŠ¶æ€å’Œå¯èƒ½çš„é”™è¯¯ã€‚\nrepairFuncï¼šä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºå°è¯•ä¿®å¤ä¸å¥åº·çš„æœåŠ¡ã€‚\nuptimeFuncï¼šä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºè·å–æœåŠ¡çš„è¿è¡Œæ—¶é—´ã€‚\ncrictlPathï¼šæŒ‡å‘ CRI å·¥å…·çš„è·¯å¾„ã€‚\nhealthCheckTimeoutï¼šå¥åº·æ£€æŸ¥çš„è¶…æ—¶è®¾ç½®ã€‚\ncoolDownTimeï¼šåœ¨å°è¯•ä¿®å¤ä¹‹å‰è¦æ±‚æœåŠ¡å¿…é¡»æ­£å¸¸è¿è¡Œçš„æ—¶é—´ã€‚\nloopBackTimeï¼šç”¨äºå›æº¯æ£€æŸ¥æ—¥å¿—çš„æ—¶é—´æ®µã€‚\nlogPatternsToCheckï¼šä¸€ä¸ªæ˜ å°„ï¼ŒåŒ…å«è¦æ£€æŸ¥çš„æ—¥å¿—æ¨¡å¼åŠå…¶å‡ºç°æ¬¡æ•°é˜ˆå€¼ã€‚\n\n6.2 NewHealthCheckerpkg&#x2F;healthchecker&#x2F;health_checker.go:48\n// NewHealthChecker returns a new health checker configured with the given options.func NewHealthChecker(hco *options.HealthCheckerOptions) (types.HealthChecker, error) &#123;  hc := &amp;healthChecker&#123;    component:          hco.Component,    enableRepair:       hco.EnableRepair,    crictlPath:         hco.CriCtlPath,    healthCheckTimeout: hco.HealthCheckTimeout,    coolDownTime:       hco.CoolDownTime,    service:            hco.Service,    loopBackTime:       hco.LoopBackTime,    logPatternsToCheck: hco.LogPatterns.GetLogPatternCountMap(),  &#125;  hc.healthCheckFunc = getHealthCheckFunc(hco)  hc.repairFunc = getRepairFunc(hco)  hc.uptimeFunc = getUptimeFunc(hco.Service)  return hc, nil&#125;\nNewHealthCheckerä¼šæ ¹æ®è¾“å…¥çš„options.HealthCheckerOptionsæ¥è¿›è¡Œtypes.HealthCheckerçš„æ„é€ ã€‚\n6.3 CheckHealthpkg&#x2F;healthchecker&#x2F;health_checker.go:67\n// CheckHealth checks for the health of the component and tries to repair if enabled.// Returns true if healthy, false otherwise.func (hc *healthChecker) CheckHealth() (bool, error) &#123;        healthy, err := hc.healthCheckFunc()        if err != nil &#123;                return healthy, err        &#125;        logPatternHealthy, err := logPatternHealthCheck(hc.service, hc.loopBackTime, hc.logPatternsToCheck)        if err != nil &#123;                return logPatternHealthy, err        &#125;        if healthy &amp;&amp; logPatternHealthy &#123;                return true, nil        &#125;        // The service is unhealthy.        // Attempt repair based on flag.        if hc.enableRepair &#123;                // repair if the service has been up for the cool down period.                uptime, err := hc.uptimeFunc()                if err != nil &#123;                        klog.Infof(&quot;error in getting uptime for %v: %v\\n&quot;, hc.component, err)                        return false, nil                &#125;                klog.Infof(&quot;%v is unhealthy, component uptime: %v\\n&quot;, hc.component, uptime)                if uptime &gt; hc.coolDownTime &#123;                        klog.Infof(&quot;%v cooldown period of %v exceeded, repairing&quot;, hc.component, hc.coolDownTime)                        hc.repairFunc()                &#125;        &#125;        return false, nil&#125;\n\næ£€æŸ¥ç»„ä»¶çš„å¥åº·çŠ¶æ€ï¼Œè¿”å›æ˜¯å¦å¥åº·ï¼Œå¹¶åœ¨ä¸å¥åº·çš„æƒ…å†µä¸‹å°è¯•ä¿®å¤ã€‚\né€»è¾‘ï¼š\n\nè°ƒç”¨ healthCheckFunc æ‰§è¡Œå¥åº·æ£€æŸ¥ã€‚\nä½¿ç”¨ logPatternHealthCheck æ£€æŸ¥æ—¥å¿—æ¨¡å¼ã€‚\nå¦‚æœç»„ä»¶ä¸å¥åº·ä¸”å¯ç”¨äº†ä¿®å¤ï¼Œæ£€æŸ¥ç»„ä»¶çš„è¿è¡Œæ—¶é—´å¹¶è°ƒç”¨ä¿®å¤å‡½æ•°ã€‚\n\n6.4 logPatternHealthCheckpkg&#x2F;healthchecker&#x2F;health_checker.go:100\n// logPatternHealthCheck checks for the provided logPattern occurrences in the service logs.// Returns true if the pattern is empty or does not exist logThresholdCount times since start of service, false otherwise.func logPatternHealthCheck(service string, loopBackTime time.Duration, logPatternsToCheck map[string]int) (bool, error) &#123;        if len(logPatternsToCheck) == 0 &#123;                return true, nil        &#125;        uptimeFunc := getUptimeFunc(service)        klog.Infof(&quot;Getting uptime for service: %v\\n&quot;, service)        uptime, err := uptimeFunc()        if err != nil &#123;                klog.Warningf(&quot;Failed to get the uptime: %+v&quot;, err)                return true, err        &#125;        logStartTime := time.Now().Add(-uptime).Format(types.LogParsingTimeLayout)        if loopBackTime &gt; 0 &amp;&amp; uptime &gt; loopBackTime &#123;                logStartTime = time.Now().Add(-loopBackTime).Format(types.LogParsingTimeLayout)        &#125;        for pattern, count := range logPatternsToCheck &#123;                healthy, err := checkForPattern(service, logStartTime, pattern, count)                if err != nil || !healthy &#123;                        return healthy, err                &#125;        &#125;        return true, nil&#125;\næ£€æŸ¥æœåŠ¡æ—¥å¿—ä¸­æŒ‡å®šæ¨¡å¼çš„å‡ºç°æ¬¡æ•°ã€‚\nå‚æ•°ï¼š\n\nserviceï¼šè¢«ç›‘æ§çš„æœåŠ¡åç§°ã€‚\nloopBackTimeï¼šç”¨äºç¡®å®šè¦æ£€æŸ¥çš„æ—¥å¿—æ—¶é—´èŒƒå›´ã€‚\nlogPatternsToCheckï¼šè¦æ£€æŸ¥çš„æ—¥å¿—æ¨¡å¼åŠå…¶å‡ºç°çš„é˜ˆå€¼ã€‚è¿”å›å€¼ï¼šå¸ƒå°”å€¼è¡¨ç¤ºå¥åº·çŠ¶æ€å’Œå¯èƒ½çš„é”™è¯¯ã€‚\n\n6.5 healthCheckEndpointOKFuncpkg&#x2F;healthchecker&#x2F;health_checker.go:126\n// healthCheckEndpointOKFunc returns a function to check the status of an http endpointfunc healthCheckEndpointOKFunc(endpoint string, timeout time.Duration) func() (bool, error) &#123;        return func() (bool, error) &#123;                httpClient := http.Client&#123;Timeout: timeout&#125;                response, err := httpClient.Get(endpoint)                if err != nil || response.StatusCode != http.StatusOK &#123;                        return false, nil                &#125;                return true, nil        &#125;&#125;\n\nè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æ£€æŸ¥ç»™å®š HTTP ç«¯ç‚¹çš„å¥åº·çŠ¶æ€ã€‚\nå‚æ•°ï¼šç«¯ç‚¹ URI å’Œè¶…æ—¶æ—¶é—´ã€‚\nè¿”å›å€¼ï¼šå¥åº·æ£€æŸ¥å‡½æ•°ã€‚\n6.6 getHealthCheckFuncpkg&#x2F;healthchecker&#x2F;health_checker.go:138\n// getHealthCheckFunc returns the health check function based on the component.func getHealthCheckFunc(hco *options.HealthCheckerOptions) func() (bool, error) &#123;        switch hco.Component &#123;        case types.KubeletComponent:                return healthCheckEndpointOKFunc(types.KubeletHealthCheckEndpoint(), hco.HealthCheckTimeout)        case types.KubeProxyComponent:                return healthCheckEndpointOKFunc(types.KubeProxyHealthCheckEndpoint(), hco.HealthCheckTimeout)        case types.DockerComponent:                return func() (bool, error) &#123;                        if _, err := execCommand(hco.HealthCheckTimeout, getDockerPath(), &quot;ps&quot;); err != nil &#123;                                return false, nil                        &#125;                        return true, nil                &#125;        case types.CRIComponent:                return func() (bool, error) &#123;                        _, err := execCommand(                                hco.HealthCheckTimeout,                                hco.CriCtlPath,                                &quot;--timeout=&quot;+hco.CriTimeout.String(),                                &quot;--runtime-endpoint=&quot;+hco.CriSocketPath,                                &quot;pods&quot;,                                &quot;--latest&quot;,                        )                        if err != nil &#123;                                return false, nil                        &#125;                        return true, nil                &#125;        default:                klog.Warningf(&quot;Unsupported component: %v&quot;, hco.Component)        &#125;        return nil&#125;\n\næ ¹æ®ç»„ä»¶ç±»å‹è¿”å›ç›¸åº”çš„å¥åº·æ£€æŸ¥æ–¹æ³•ã€‚\nå‚æ•°ï¼šå¥åº·æ£€æŸ¥é€‰é¡¹ã€‚\nè¿”å›å€¼ï¼šæ‰§è¡Œå¥åº·æ£€æŸ¥çš„å‡½æ•°ã€‚\n6.7 execCommandpkg&#x2F;healthchecker&#x2F;health_checker.go:174\n// execCommand executes the bash command and returns the (output, error) from command, error if timeout occurs.func execCommand(timeout time.Duration, command string, args ...string) (string, error) &#123;        ctx, cancel := context.WithTimeout(context.Background(), timeout)        defer cancel()        cmd := exec.CommandContext(ctx, command, args...)        out, err := cmd.CombinedOutput()        if err != nil &#123;                klog.Infof(&quot;command %v failed: %v, %s\\n&quot;, cmd, err, string(out))                return &quot;&quot;, err        &#125;        return strings.TrimSuffix(string(out), &quot;\\n&quot;), nil&#125;\næ‰§è¡Œç»™å®šçš„å‘½ä»¤ï¼Œå¹¶åœ¨æŒ‡å®šçš„è¶…æ—¶æ—¶é—´å†…è¿”å›è¾“å‡ºå’Œé”™è¯¯ã€‚\nå‚æ•°ï¼šè¶…æ—¶æ—¶é—´ã€å‘½ä»¤å’Œå‚æ•°ã€‚\nè¿”å›å€¼ï¼šå‘½ä»¤çš„è¾“å‡ºå’Œé”™è¯¯ä¿¡æ¯ã€‚\n6.8 getUptimeFuncpkg&#x2F;healthchecker&#x2F;health_checker_linux.go:32\n// getUptimeFunc returns the time for which the given service has been running.func getUptimeFunc(service string) func() (time.Duration, error) &#123;        return func() (time.Duration, error) &#123;                // Using InactiveExitTimestamp to capture the exact time when systemd tried starting the service. The service will                // transition from inactive -&gt; activating and the timestamp is captured.                // Source : https://www.freedesktop.org/wiki/Software/systemd/dbus/                // Using ActiveEnterTimestamp resulted in race condition where the service was repeatedly killed by plugin when                // RestartSec of systemd and invoke interval of plugin got in sync. The service was repeatedly killed in                // activating state and hence ActiveEnterTimestamp was never updated.                out, err := execCommand(types.CmdTimeout, &quot;systemctl&quot;, &quot;show&quot;, service, &quot;--property=InactiveExitTimestamp&quot;)                if err != nil &#123;                        return time.Duration(0), err                &#125;                val := strings.Split(out, &quot;=&quot;)                if len(val) &lt; 2 &#123;                        return time.Duration(0), errors.New(&quot;could not parse the service uptime time correctly&quot;)                &#125;                t, err := time.Parse(types.UptimeTimeLayout, val[1])                if err != nil &#123;                        return time.Duration(0), err                &#125;                return time.Since(t), nil        &#125;&#125;\n\nè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè®¡ç®—æŒ‡å®šæœåŠ¡çš„è¿è¡Œæ—¶é—´ã€‚\nå‚æ•°ï¼š\n\nservice string - è¢«ç›‘æ§æœåŠ¡çš„åç§°ã€‚\n\nè¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›æœåŠ¡è¿è¡Œçš„æŒç»­æ—¶é—´æˆ–é”™è¯¯ã€‚\n\nå®ç°ç»†èŠ‚\n\nä½¿ç”¨ systemctl show å‘½ä»¤è·å– InactiveExitTimestampï¼Œè¿™æ˜¯æœåŠ¡ä» inactive çŠ¶æ€è½¬æ¢æ—¶çš„æ—¶é—´æˆ³ã€‚\n\nè§£æå‘½ä»¤çš„è¾“å‡ºï¼Œå°†æ—¶é—´æˆ³è½¬æ¢ä¸º time.Time ç±»å‹ï¼Œå¹¶è®¡ç®—è‡ªè¯¥æ—¶é—´ä»¥æ¥çš„æŒç»­æ—¶é—´ã€‚\n\næ­¤æ–¹æ³•å¯ç”¨äºè·å–æœåŠ¡çš„å½“å‰è¿è¡Œæ—¶é—´ï¼Œä»¥ä¾¿è¯„ä¼°æ˜¯å¦åœ¨ä¿®å¤ä¹‹å‰è¾¾åˆ°å†·å´æ—¶é—´ã€‚\n\n\n6.9 getRepairFuncpkg&#x2F;healthchecker&#x2F;health_checker_linux.go:58\n// getRepairFunc returns the repair function based on the component.func getRepairFunc(hco *options.HealthCheckerOptions) func() &#123;        // Use `systemctl kill` instead of `systemctl restart` for the repair function.        // We start to rely on the kernel message difference for the two commands to        // indicate if the component restart is due to an administrative plan (restart)        // or a system issue that needs repair (kill).        // See https://github.com/kubernetes/node-problem-detector/issues/847.        switch hco.Component &#123;        case types.DockerComponent:                // Use &quot;docker ps&quot; for docker health check. Not using crictl for docker to remove                // dependency on the kubelet.                return func() &#123;                        execCommand(types.CmdTimeout, &quot;pkill&quot;, &quot;-SIGUSR1&quot;, &quot;dockerd&quot;)                        execCommand(types.CmdTimeout, &quot;systemctl&quot;, &quot;kill&quot;, &quot;--kill-who=main&quot;, hco.Service)                &#125;        default:                // Just kill the service for all other components                return func() &#123;                        execCommand(types.CmdTimeout, &quot;systemctl&quot;, &quot;kill&quot;, &quot;--kill-who=main&quot;, hco.Service)                &#125;        &#125;&#125;\n\næ ¹æ®æœåŠ¡çš„ç»„ä»¶ç±»å‹è¿”å›ä¸€ä¸ªæ¼”ç¤ºä¿®å¤åŠŸèƒ½çš„æ–¹æ³•ã€‚\nå‚æ•°ï¼š\n\nhco *options.HealthCheckerOptions - å¥åº·æ£€æŸ¥çš„é€‰é¡¹ã€‚\nè¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æ‰§è¡Œç›¸åº”ä¿®å¤æ“ä½œã€‚\n\nå®ç°ç»†èŠ‚\n\nå¯¹äº Docker ç»„ä»¶ï¼Œé€šè¿‡ pkill å‘é€ SIGUSR1 ä¿¡å·ä»¥æ›´ä¼˜é›…åœ°åœæ­¢ Docker å®ˆæŠ¤è¿›ç¨‹ã€‚\nå¯¹äºå…¶ä»–ç»„ä»¶ï¼Œè°ƒç”¨ systemctl kill å‘½ä»¤ç»ˆæ­¢ä¸»è¦è¿›ç¨‹ã€‚\nè¿™ç§è®¾è®¡ä½¿å¾—ä¿®å¤åŠŸèƒ½èƒ½å¤Ÿæ ¹æ®ä¸åŒçš„ç»„ä»¶é‡‡å–åˆé€‚çš„å¤„ç†æ–¹å¼ã€‚\n\n6.10 checkForPatternpkg&#x2F;healthchecker&#x2F;health_checker_linux.go:82\n// checkForPattern returns (true, nil) if logPattern occurs less than logCountThreshold number of times since last// service restart. (false, nil) otherwise.func checkForPattern(service, logStartTime, logPattern string, logCountThreshold int) (bool, error) &#123;        out, err := execCommand(types.CmdTimeout, &quot;/bin/sh&quot;, &quot;-c&quot;,                // Query service logs since the logStartTime                `journalctl --unit &quot;`+service+`&quot; --since &quot;`+logStartTime+                        // Grep the pattern                        `&quot; | grep -i &quot;`+logPattern+                        // Get the count of occurrences                        `&quot; | wc -l`)        if err != nil &#123;                return true, err        &#125;        occurrences, err := strconv.Atoi(out)        if err != nil &#123;                return true, err        &#125;        if occurrences &gt;= logCountThreshold &#123;                klog.Infof(&quot;%s failed log pattern check, %s occurrences: %v&quot;, service, logPattern, occurrences)                return false, nil        &#125;        return true, nil&#125;\næ£€æŸ¥æŒ‡å®šæœåŠ¡çš„æ—¥å¿—ä¸­æ˜¯å¦åŒ…å«ç‰¹å®šæ¨¡å¼ï¼Œå¹¶è¿”å›å…¶å‡ºç°æ¬¡æ•°æ˜¯å¦è¾¾åˆ°é˜ˆå€¼ã€‚\nå‚æ•°ï¼š\n\nserviceï¼šè¢«ç›‘æ§æœåŠ¡çš„åç§°ã€‚\nlogStartTimeï¼šèµ·å§‹æ—¶é—´ï¼Œç”¨äºè¿‡æ»¤æ—¥å¿—ã€‚\nlogPatternï¼šéœ€è¦æ£€æŸ¥çš„æ—¥å¿—æ¨¡å¼ã€‚\nlogCountThresholdï¼šæ¨¡å¼å‡ºç°çš„æœ€å¤§æ¬¡æ•°é˜ˆå€¼ã€‚\nè¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºæ˜¯å¦å¥åº·ï¼Œä»¥åŠå¯èƒ½çš„é”™è¯¯ã€‚\n\nå®ç°ç»†èŠ‚\n\nä½¿ç”¨ journalctl å‘½ä»¤è·å–ä»æŒ‡å®šæ—¶é—´å¼€å§‹çš„æœåŠ¡æ—¥å¿—ï¼Œå¹¶é€šè¿‡ grep è¿‡æ»¤ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—æ¨¡å¼ã€‚\nä½¿ç”¨ wc -l è®¡ç®—åŒ¹é…çš„è¡Œæ•°ã€‚\nå¦‚æœæ—¥å¿—æ¨¡å¼å‡ºç°çš„æ¬¡æ•°å¤§äºé˜ˆå€¼ï¼Œè®°å½•ç›¸å…³ä¿¡æ¯å¹¶è¿”å›å¥åº·æ£€æŸ¥å¤±è´¥çš„ç»“æœã€‚\n\n7 logcounter7.1 logCounterå®šä¹‰pkg&#x2F;logcounter&#x2F;log_counter.go:42\ntype logCounter struct &#123;        logCh         &lt;-chan *systemtypes.Log        buffer        systemlogmonitor.LogBuffer        pattern       string        revertPattern string        clock         clock.Clock&#125;\nå­—æ®µè§£é‡Šï¼š\n\nlogChï¼šåªè¯»é€šé“ï¼Œç”¨äºæ¥æ”¶ç³»ç»Ÿæ—¥å¿—ã€‚\nbufferï¼šå­˜å‚¨æ—¥å¿—çš„ç¼“å†²åŒºï¼Œä»¥ä¾¿åˆ†æå’Œè®¡æ•°ã€‚\npatternï¼šå¤„ç†æ—¥å¿—æ—¶ä½¿ç”¨çš„åŒ¹é…æ¨¡å¼ã€‚\nrevertPatternï¼šå¯ç”¨æ¥åå‘è®¡æ•°çš„æ¨¡å¼ã€‚\nclockï¼šç”¨äºè·å–å½“å‰æ—¶é—´çš„æ—¶é’Ÿï¼Œæ”¯æŒæ¨¡æ‹Ÿæ—¶é’ŸåŠŸèƒ½ã€‚\n\n7.2 NewJournaldLogCounterpkg&#x2F;logcounter&#x2F;log_counter.go:50\nfunc NewJournaldLogCounter(options *options.LogCounterOptions) (types.LogCounter, error) &#123;        watcher := journald.NewJournaldWatcher(watchertypes.WatcherConfig&#123;                Plugin:       &quot;journald&quot;,                PluginConfig: map[string]string&#123;journaldSourceKey: options.JournaldSource&#125;,                LogPath:      options.LogPath,                Lookback:     options.Lookback,                Delay:        options.Delay,        &#125;)        logCh, err := watcher.Watch()        if err != nil &#123;                return nil, fmt.Errorf(&quot;error watching journald: %v&quot;, err)        &#125;        return &amp;logCounter&#123;                logCh:         logCh,                buffer:        systemlogmonitor.NewLogBuffer(bufferSize),                pattern:       options.Pattern,                revertPattern: options.RevertPattern,                clock:         clock.RealClock&#123;&#125;,        &#125;, nil&#125;\n\nåˆå§‹åŒ–å¹¶è¿”å›ä¸€ä¸ªæ–°çš„ logCounter å®ä¾‹ã€‚\nå‚æ•°ï¼š\n\noptions *options.LogCounterOptions - åŒ…å«é…ç½®ä¿¡æ¯ï¼ˆä¾‹å¦‚æ—¥å¿—æºã€è·¯å¾„ã€æ¨¡å¼ç­‰ï¼‰ã€‚\nè¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ªå®ç°äº† types.LogCounter æ¥å£çš„ logCounter å®ä¾‹ã€‚\n\nå®ç°ç»†èŠ‚\n\nåˆ›å»ºä¸€ä¸ª journald æ—¥å¿—è§‚å¯Ÿè€…å®ä¾‹æ¥ç›‘æ§æŒ‡å®šçš„æ—¥å¿—è·¯å¾„ã€‚\nå¦‚æœç›‘è§†æ“ä½œæˆåŠŸï¼Œå»ºç«‹æ—¥å¿—é€šé“å¹¶åˆ›å»º logCounter çš„å®ä¾‹ï¼Œè®¾ç½®ç¼“å†²åŒºã€åŒ¹é…æ¨¡å¼ç­‰ã€‚\n\n7.3 Countpkg&#x2F;logcounter&#x2F;log_counter.go:71\nfunc (e *logCounter) Count() (count int, err error) &#123;        start := e.clock.Now()        for &#123;                select &#123;                case log, ok := &lt;-e.logCh:                        if !ok &#123;                                err = fmt.Errorf(&quot;log channel closed unexpectedly&quot;)                                return                        &#125;                        if start.Before(log.Timestamp) &#123;                                return                        &#125;                        e.buffer.Push(log)                        if len(e.buffer.Match(e.pattern)) != 0 &#123;                                count++                        &#125;                        if e.revertPattern != &quot;&quot; &amp;&amp; len(e.buffer.Match(e.revertPattern)) != 0 &#123;                                count--                        &#125;                case &lt;-e.clock.After(timeout):                        return                &#125;        &#125;&#125;\nç»Ÿè®¡åœ¨è¿è¡ŒæœŸé—´åŒ¹é…çš„æ—¥å¿—æ¡ç›®æ•°é‡ã€‚\nè¿”å›å€¼ï¼šè¿”å›ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—è®¡æ•°åŠä»»ä½•æ½œåœ¨çš„é”™è¯¯ã€‚\nå®ç°ç»†èŠ‚\n\nä½¿ç”¨å½“å‰æ—¶é—´ (start) è®°å½•å¼€å§‹æ—¶åˆ»ã€‚\nåœ¨æ— é™å¾ªç¯ä¸­ï¼Œä½¿ç”¨ select è¯­å¥ç›‘å¬æ—¥å¿—é€šé“å’Œè¶…æ—¶äº‹ä»¶ã€‚\nå¦‚æœä» logCh è¯»å–åˆ°æ—¥å¿—ï¼š\næ£€æŸ¥é€šé“æ˜¯å¦å·²ç»å…³é—­ã€‚\nå¦‚æœè¯»å–åˆ°çš„æ—¥å¿—æ—¶é—´æˆ³æ™šäºå¼€å§‹æ—¶é—´ï¼Œåˆ™åœæ­¢è®¡æ•°ã€‚\nå°†æ—¥å¿—æ¡ç›®å‹å…¥ç¼“å†²åŒºã€‚\næ£€æŸ¥å½“å‰æ—¥å¿—æ˜¯å¦ä¸æ¨¡å¼åŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ™è®¡æ•°åŠ ä¸€ï¼›å¦‚æœåŒ¹é…åå‘æ¨¡å¼ï¼Œåˆ™è®¡æ•°å‡ä¸€ã€‚\nå¦‚æœåœ¨è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°æ–°æ—¥å¿—ï¼Œç»“æŸå¾ªç¯å¹¶è¿”å›è®¡æ•°ã€‚\n\n\n\n","categories":["devops/npd"],"tags":["devops","npd"]},{"title":"alicloud_alikafka_instance","url":"/2025/07/devops/terraform/alicloud-alikafka-instance/","content":"å‰è¨€çº¦å®šæ ¼å¼ï¼š\nâ”œâ”€â”€ aliyun                                             # äº‘å‚å•†å®ä¾‹æ–‡ä»¶â”‚   â””â”€â”€ aliyun_ecs_mod_demo                           # æ¨¡å‹åâ”‚       â””â”€â”€ aliyun_china_platform_7111                # äº‘è´¦å·åâ”‚           â””â”€â”€ ecs_instance_name_20241224121212      # å®ä¾‹åâ”‚               â”œâ”€â”€ backend.tf                        # å®ä¾‹stateæ–‡ä»¶ä¿å­˜è¯´æ˜ï¼šossâ”‚               â””â”€â”€ main.tf                           # å®ä¾‹å…·ä½“çš„å‚æ•°â”œâ”€â”€ modules                                            # æ¨¡å‹æ•°æ®æ–‡ä»¶å¤¹â”‚   â”œâ”€â”€ aliyun                                        # äº‘å‚å•†æ¨¡å‹æ–‡ä»¶å¤¹â”‚   â”‚   â””â”€â”€ aliyun_ecs_mod_demo                       # æ¨¡å‹åâ”‚   â”‚       â”œâ”€â”€ main.tf                               # æ¨¡å‹å®šä¹‰ä¸»æ–‡ä»¶â”‚   â”‚       â”œâ”€â”€ outputs.tf                            # æ¨¡å‹å®šä¹‰è¾“å‡ºæ–‡ä»¶â”‚   â”‚       â””â”€â”€ variables.tf                          # æ¨¡å‹å®šä¹‰å‚æ•°æ–‡ä»¶â”‚   â””â”€â”€ tenmod                                         # å¦ä¸€ä¸ªäº‘å‚å•†æ¨¡å‹â””â”€â”€ tenent                                              # å¦ä¸€ä¸ªäº‘å‚å•†å®ä¾‹æ–‡ä»¶\n\né¡¹ç›®ç»“æ„.â”œâ”€â”€ aliyunâ”‚   â””â”€â”€ aliyun_alikafka_demoâ”‚       â””â”€â”€ aliyun_china_pt_7111â”‚           â””â”€â”€ alikafka_demo_202502061910â”‚               â”œâ”€â”€ backend.tfâ”‚               â””â”€â”€ main.tfâ””â”€â”€ modules    â””â”€â”€ aliyun        â””â”€â”€ aliyun_alikafka_mod_demo            â”œâ”€â”€ main.tf            â””â”€â”€ variables.tf\n\nmodules&#x2F;modules&#x2F;aliyun&#x2F;aliyun_alikafka_mod_demo&#x2F;main.tfterraform &#123;  required_providers &#123;    alicloud = &#123;      source  = &quot;aliyun/alicloud&quot;      version = &quot;1.225.0&quot;    &#125;  &#125;&#125;provider &quot;alicloud&quot; &#123;  region = var.region&#125;resource &quot;alicloud_alikafka_instance&quot; &quot;this&quot; &#123;  name          = var.instance_name  deploy_type   = var.deploy_type  disk_size     = var.disk_size  disk_type     = var.disk_type  vswitch_id    = var.vswitch_id  partition_num = var.partition_num  io_max        = var.io_max&#125;\n\n&#x2F;modules&#x2F;aliyun&#x2F;aliyun_alikafka_mod_demo&#x2F;variables.tfvariable &quot;region&quot; &#123;  description = &quot;åœ°åŸŸ&quot;  type        = string&#125;variable &quot;instance_name&quot; &#123;  description = &quot;kafkaå®ä¾‹å&quot;  type        = string&#125;variable &quot;deploy_type&quot; &#123;  // - 4: eip/vpc instanceï¼›- 5: vpc instance.  description = &quot;éƒ¨ç½²ç±»å‹&quot;  type        = number  default = 5  validation &#123;    condition     = contains([4, 5], var.deploy_type)    error_message = &quot;The deploy_type must be one of 4, 5&quot;  &#125;&#125;variable &quot;disk_size&quot; &#123;  description = &quot;kafkaå®ä¾‹ç£ç›˜è§„æ ¼&quot;  type = number  validation &#123;    condition     = contains([500, 1000], var.disk_size)    error_message = &quot;The disk_size must be one of 200, 400&quot;  &#125;&#125;variable &quot;disk_type&quot; &#123;  # 0: efficient cloud disk , 1: SSD.  description = &quot;ç£ç›˜ç±»å‹&quot;  type = number  default = 1  validation &#123;    condition     = contains([0, 1], var.disk_type)    error_message = &quot;The disk_type must be empty, or one of 0, 1&quot;  &#125;&#125;variable &quot;vswitch_id&quot; &#123;  description = &quot;ç»‘å®šè™šæ‹Ÿäº¤æ¢æœºid&quot;  type = string&#125;variable &quot;partition_num&quot; &#123;  description = &quot;åˆ†åŒºæ•°é‡&quot;  type = number&#125;variable &quot;io_max&quot; &#123;  description = &quot;ioçš„æœ€å¤§å€¼&quot;  type = number&#125;\n\nDemo&#x2F;aliyun&#x2F;aliyun_alikafka_demo&#x2F;aliyun_china_pt_7111&#x2F;alikafka_demo_202502061910&#x2F;backend.tfterraform &#123;  backend &quot;oss&quot; &#123;    endpoint = &quot;oss-cn-hangzhou.aliyuncs.com&quot;    bucket   = &quot;dz-devops&quot; # æ›¿æ¢ä¸ºä½ çš„ OSS Bucket åç§°    prefix = &quot;terraform_state//aliyun/aliyun_alikafka_demo/aliyun_china_pt_7111/alikafka_demo_202502061910&quot;    key      = &quot;terraform.tfstate&quot; # å­˜å‚¨çŠ¶æ€æ–‡ä»¶çš„è·¯å¾„å’Œåç§°    region   = &quot;cn-hangzhou&quot;       # OSS çš„åœ°åŸŸï¼ˆæ ¹æ®ä½ çš„å®é™…æƒ…å†µè°ƒæ•´ï¼‰  &#125;&#125;\n\n&#x2F;aliyun&#x2F;aliyun_alikafka_demo&#x2F;aliyun_china_pt_7111&#x2F;alikafka_demo_202502061910&#x2F;main.tfmodule &quot;alikafka_instance&quot; &#123;  source        = &quot;../../../../modules/aliyun/aliyun_alikafka_mod_demo&quot;  region        = &quot;cn-hangzhou&quot;  disk_size     = 500  instance_name = &quot;alikafka-testV2&quot;  deploy_type   = 5  vswitch_id    = &quot;vsw-bp1co65f3q2s0bis9yfkg&quot;  partition_num = 50  io_max        = 20&#125;\n\nè¿è¡Œæµ‹è¯•è·å– AK&#x2F;SKåœ¨é¦–æ¬¡ä½¿ç”¨ Terraform ä¹‹å‰ï¼Œéœ€è¦å‰å¾€è…¾è®¯äº‘çš„äº‘ API å¯†é’¥é¡µé¢ç”³è¯·å®‰å…¨å‡­è¯SecretIdå’ŒSecretKey2ã€‚è‹¥å·²æœ‰å¯ä½¿ç”¨çš„å®‰å…¨å‡­è¯ï¼Œåˆ™è·³è¿‡è¯¥æ­¥éª¤2ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹2ï¼š\n\nç™»å½•è…¾è®¯äº‘è®¿é—®ç®¡ç†æ§åˆ¶å°ï¼Œåœ¨å·¦ä¾§å¯¼èˆªæ ï¼Œé€‰æ‹©è®¿é—®å¯†é’¥&gt;API å¯†é’¥ç®¡ç†ã€‚\nåœ¨API å¯†é’¥ç®¡ç†é¡µé¢ï¼Œå•å‡»æ–°å»ºå¯†é’¥ï¼Œå³å¯ä»¥åˆ›å»ºä¸€å¯¹SecretId&#x2F;SecretKeyã€‚\n\nè®¾ç½®ç¯å¢ƒå˜é‡å°†è·å–åˆ°çš„SecretIdå’ŒSecretKeyè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼š\nexport TENCENTCLOUD_SECRET_ID=your_secret_idexport TENCENTCLOUD_SECRET_KEY=your_secret_key\n\nè¿è¡Œé¡¹ç›®è¿›å…¥é¡¹ç›®æ ¹ç›®å½•ï¼Œalikafka_demo_202502061910ç›®å½•ï¼š\ncd ./aliyun/aliyun_alikafka_demo/aliyun_china_pt_7111/alikafka_demo_202502061910\n\nåˆå§‹åŒ– Terraform é¡¹ç›®:\n# å°†xxxæ›¿æ¢ä¸ºå®é™…backendçš„akï¼Œå°†yyyæ›¿æ¢ä¸ºå®é™…backendçš„skterraform init -backend-config=&quot;access_key=xxx&quot; -backend-config=&quot;secret_key=yyy&quot;\n\nè¯¥å‘½ä»¤ä¼šä¸‹è½½æ‰€éœ€çš„æ’ä»¶å’Œä¾èµ–ï¼Œå¹¶åˆå§‹åŒ–åç«¯é…ç½®ã€‚ç±»ä¼¼çš„è¾“å‡ºï¼ˆé¦–æ¬¡ä½¿ç”¨æŸä¸€ä¸ªprovieræ—¶ï¼Œä¼šå…ˆä¸‹è½½ï¼‰ï¼š\nInitializing the backend...Successfully configured the backend &quot;oss&quot;! Terraform will automaticallyuse this backend unless the backend configuration changes.Initializing modules...Initializing provider plugins...- Reusing previous version of aliyun/alicloud from the dependency lock file- Using previously-installed aliyun/alicloud v1.225.0Terraform has been successfully initialized!You may now begin working with Terraform. Try running &quot;terraform plan&quot; to seeany changes that are required for your infrastructure. All Terraform commandsshould now work.If you ever set or change modules or backend configuration for Terraform,rerun this command to reinitialize your working directory. If you forget, othercommands will detect it and remind you to do so if necessary.\n\né¢„è§ˆè®¡åˆ’å˜æ›´ï¼š\nterraform plan\n\nTerraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:  + createTerraform will perform the following actions:  # module.alikafka_instance.alicloud_alikafka_instance.this will be created  + resource &quot;alicloud_alikafka_instance&quot; &quot;this&quot; &#123;      + config            = (known after apply)      + deploy_type       = 5      + disk_size         = 500      + disk_type         = 1      + eip_max           = (known after apply)      + end_point         = (known after apply)      + group_left        = (known after apply)      + group_used        = (known after apply)      + id                = (known after apply)      + io_max            = 20      + io_max_spec       = (known after apply)      + is_partition_buy  = (known after apply)      + name              = &quot;alikafka-testV2&quot;      + paid_type         = &quot;PostPaid&quot;      + partition_left    = (known after apply)      + partition_num     = 50      + partition_used    = (known after apply)      + resource_group_id = (known after apply)      + security_group    = (known after apply)      + service_version   = (known after apply)      + spec_type         = &quot;normal&quot;      + status            = (known after apply)      + topic_left        = (known after apply)      + topic_num_of_buy  = (known after apply)      + topic_quota       = (known after apply)      + topic_used        = (known after apply)      + vpc_id            = (known after apply)      + vswitch_id        = &quot;vsw-bp1co65f3q2s0bis9yfkg&quot;      + zone_id           = (known after apply)    &#125;Plan: 1 to add, 0 to change, 0 to destroy.â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€Note: You didn&#x27;t use the -out option to save this plan, so Terraform can&#x27;t guarantee to take exactly these actions if you run &quot;terraform apply&quot; now.\n\næ‰§è¡Œå˜æ›´ï¼š\nterraform apply\n\nTerraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:  + createTerraform will perform the following actions:  # module.alikafka_instance.alicloud_alikafka_instance.this will be created  + resource &quot;alicloud_alikafka_instance&quot; &quot;this&quot; &#123;      + config            = (known after apply)      + deploy_type       = 5      + disk_size         = 500      + disk_type         = 1      + eip_max           = (known after apply)      + end_point         = (known after apply)      + group_left        = (known after apply)      + group_used        = (known after apply)      + id                = (known after apply)      + io_max            = 20      + io_max_spec       = (known after apply)      + is_partition_buy  = (known after apply)      + name              = &quot;alikafka-testV2&quot;      + paid_type         = &quot;PostPaid&quot;      + partition_left    = (known after apply)      + partition_num     = 50      + partition_used    = (known after apply)      + resource_group_id = (known after apply)      + security_group    = (known after apply)      + service_version   = (known after apply)      + spec_type         = &quot;normal&quot;      + status            = (known after apply)      + topic_left        = (known after apply)      + topic_num_of_buy  = (known after apply)      + topic_quota       = (known after apply)      + topic_used        = (known after apply)      + vpc_id            = (known after apply)      + vswitch_id        = &quot;vsw-bp1co65f3q2s0bis9yfkg&quot;      + zone_id           = (known after apply)    &#125;Plan: 1 to add, 0 to change, 0 to destroy.Do you want to perform these actions?  Terraform will perform the actions described above.  Only &#x27;yes&#x27; will be accepted to approve.  Enter a value: yesmodule.alikafka_instance.alicloud_alikafka_instance.this: Creating...module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [10s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [20s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [30s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [40s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [50s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [1m0s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [1m10s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [1m20s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [1m30s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [1m40s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [1m50s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [2m0s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [2m10s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [2m20s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [2m30s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [2m40s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [2m50s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [3m0s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [3m10s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [3m20s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [3m30s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [3m40s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [3m50s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [4m0s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [4m10s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [4m20s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [4m30s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still creating... [4m40s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Creation complete after 4m45s [id=alikafka_post-cn-0gx44g6dm006]Apply complete! Resources: 1 added, 0 changed, 0 destroyed.\n\néªŒè¯åˆ›å»ºåœ¨å‰ç«¯æŸ¥çœ‹æ˜¯å¦æˆåŠŸåˆ›å»ºå®ä¾‹ï¼š\né”€æ¯èµ„æºæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿›è¡Œé”€æ¯ï¼š\nterraform destroy\n\nmodule.alikafka_instance.alicloud_alikafka_instance.this: Refreshing state... [id=alikafka_post-cn-0gx44g6dm006]Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:  - destroyTerraform will perform the following actions:  # module.alikafka_instance.alicloud_alikafka_instance.this will be destroyed  - resource &quot;alicloud_alikafka_instance&quot; &quot;this&quot; &#123;      - config            = jsonencode(            &#123;              - &quot;cloud.maxTieredStoreSpace&quot;           = &quot;0&quot;              - &quot;enable.acl&quot;                          = &quot;false&quot;              - &quot;enable.compact&quot;                      = &quot;true&quot;              - &quot;enable.tiered&quot;                       = &quot;false&quot;              - &quot;enable.vpc_sasl_ssl&quot;                 = &quot;false&quot;              - &quot;kafka.log.retention.hours&quot;           = &quot;72&quot;              - &quot;kafka.message.max.bytes&quot;             = &quot;1048576&quot;              - &quot;kafka.offsets.retention.minutes&quot;     = &quot;10080&quot;              - &quot;kafka.ssl.bit&quot;                       = &quot;1024&quot;              - &quot;message.timestamp.difference.max.ms&quot; = &quot;9223372036854775807&quot;              - &quot;message.timestamp.type&quot;              = &quot;CreateTime&quot;            &#125;        ) -&gt; null      - deploy_type       = 5 -&gt; null      - disk_size         = 500 -&gt; null      - disk_type         = 1 -&gt; null      - eip_max           = 0 -&gt; null      - end_point         = &quot;172.31.1.64:9092,172.31.1.66:9092,172.31.1.65:9092&quot; -&gt; null      - group_left        = 2100 -&gt; null      - group_used        = 0 -&gt; null      - id                = &quot;alikafka_post-cn-0gx44g6dm006&quot; -&gt; null      - io_max            = 20 -&gt; null      - io_max_spec       = &quot;alikafka.hw.2xlarge&quot; -&gt; null      - is_partition_buy  = 1 -&gt; null      - name              = &quot;alikafka-testV2&quot; -&gt; null      - paid_type         = &quot;PostPaid&quot; -&gt; null      - partition_left    = 1050 -&gt; null      - partition_num     = 50 -&gt; null      - partition_used    = 0 -&gt; null      - resource_group_id = &quot;rg-acfmzpn54i5ejry&quot; -&gt; null      - security_group    = &quot;sg-bp184o2lwjnssf12wf3w&quot; -&gt; null      - service_version   = &quot;2.2.0&quot; -&gt; null      - spec_type         = &quot;normal&quot; -&gt; null      - status            = 5 -&gt; null      - tags              = &#123;&#125; -&gt; null      - topic_left        = 1050 -&gt; null      - topic_num_of_buy  = 1050 -&gt; null      - topic_quota       = 1050 -&gt; null      - topic_used        = 0 -&gt; null      - vpc_id            = &quot;vpc-bp1sro6pb0sec14x7s05l&quot; -&gt; null      - vswitch_id        = &quot;vsw-bp1co65f3q2s0bis9yfkg&quot; -&gt; null      - zone_id           = &quot;zonei&quot; -&gt; null        # (1 unchanged attribute hidden)    &#125;Plan: 0 to add, 0 to change, 1 to destroy.Do you really want to destroy all resources?  Terraform will destroy all your managed infrastructure, as shown above.  There is no undo. Only &#x27;yes&#x27; will be accepted to confirm.  Enter a value: yesmodule.alikafka_instance.alicloud_alikafka_instance.this: Destroying... [id=alikafka_post-cn-0gx44g6dm006]module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 10s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 20s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 30s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 40s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 50s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 1m1s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 1m11s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 1m21s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 1m31s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 1m41s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 1m51s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 2m1s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 2m11s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 2m21s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Still destroying... [id=alikafka_post-cn-0gx44g6dm006, 2m31s elapsed]module.alikafka_instance.alicloud_alikafka_instance.this: Destruction complete after 2m37sDestroy complete! Resources: 1 destroyed.\n\n\n","categories":["devops/terraform"],"tags":["devops","terraform"]},{"title":"tencentcloud_ckafka_instance","url":"/2025/07/devops/terraform/tencentcloud-ckafka-instance/","content":"å‰è¨€çº¦å®šæ ¼å¼ï¼š\nâ”œâ”€â”€ aliyun                                             # äº‘å‚å•†å®ä¾‹æ–‡ä»¶â”‚   â””â”€â”€ aliyun_ecs_mod_demo                           # æ¨¡å‹åâ”‚       â””â”€â”€ aliyun_china_platform_7111                # äº‘è´¦å·åâ”‚           â””â”€â”€ ecs_instance_name_20241224121212      # å®ä¾‹åâ”‚               â”œâ”€â”€ backend.tf                        # å®ä¾‹stateæ–‡ä»¶ä¿å­˜è¯´æ˜ï¼šossâ”‚               â””â”€â”€ main.tf                           # å®ä¾‹å…·ä½“çš„å‚æ•°â”œâ”€â”€ modules                                            # æ¨¡å‹æ•°æ®æ–‡ä»¶å¤¹â”‚   â”œâ”€â”€ aliyun                                        # äº‘å‚å•†æ¨¡å‹æ–‡ä»¶å¤¹â”‚   â”‚   â””â”€â”€ aliyun_ecs_mod_demo                       # æ¨¡å‹åâ”‚   â”‚       â”œâ”€â”€ main.tf                               # æ¨¡å‹å®šä¹‰ä¸»æ–‡ä»¶â”‚   â”‚       â”œâ”€â”€ outputs.tf                            # æ¨¡å‹å®šä¹‰è¾“å‡ºæ–‡ä»¶â”‚   â”‚       â””â”€â”€ variables.tf                          # æ¨¡å‹å®šä¹‰å‚æ•°æ–‡ä»¶â”‚   â””â”€â”€ tenmod                                         # å¦ä¸€ä¸ªäº‘å‚å•†æ¨¡å‹â””â”€â”€ tenent                                              # å¦ä¸€ä¸ªäº‘å‚å•†å®ä¾‹æ–‡ä»¶\n\né¡¹ç›®ç»“æ„.â”œâ”€â”€ modulesâ”‚   â””â”€â”€ tcloudâ”‚       â””â”€â”€ tcloud_ckafka_mod_demoâ”‚           â”œâ”€â”€ main.tfâ”‚           â”œâ”€â”€ outputs.tfâ”‚           â””â”€â”€ variables.tfâ””â”€â”€ tcloud    â””â”€â”€ tcloud_ckafka_demo        â””â”€â”€ tcloud_china_game_x6            â””â”€â”€ ckafaka_demo_202501221738                â”œâ”€â”€ backend.tf                â””â”€â”€ main.tf\n\nmodules&#x2F;modules&#x2F;tcloud&#x2F;tcloud_ckafka_mod_demo&#x2F;main.tfterraform &#123;  required_providers &#123;    tencentcloud = &#123;      source = &quot;tencentcloudstack/tencentcloud&quot;    &#125;  &#125;&#125;provider &quot;tencentcloud&quot; &#123;  region = var.region&#125;data &quot;tencentcloud_availability_zones_by_product&quot; &quot;zone&quot; &#123;  name    = var.availability_zone  product = &quot;ckafka&quot;&#125;resource &quot;tencentcloud_ckafka_instance&quot; &quot;this&quot; &#123;  instance_name      = var.instance_name  zone_id            = data.tencentcloud_availability_zones_by_product.zone.zones[0].id  vpc_id             = var.vpc_id  subnet_id          = var.vswitch_id  msg_retention_time = var.msg_retention_time  kafka_version      = var.kafka_version  disk_size          = var.disk_size  band_width         = var.band_width  disk_type          = var.disk_type  partition          = var.partition  charge_type        = var.charge_type  config &#123;    auto_create_topic_enable   = var.auto_create_topic_enable    default_num_partitions     = var.num_partitions    default_replication_factor = var.replication_factor  &#125;  dynamic_retention_config &#123;    enable = var.dynamic_retention_config_enable  &#125;&#125;\n\n&#x2F;modules&#x2F;tcloud&#x2F;tcloud_ckafka_mod_demo&#x2F;outputs.tfoutput &quot;ckafka_instance_id&quot; &#123;  value = tencentcloud_ckafka_instance.this.id&#125;\n\n&#x2F;modules&#x2F;tcloud&#x2F;tcloud_ckafka_mod_demo&#x2F;variables.tfvariable &quot;region&quot; &#123;  description = &quot;åœ°åŸŸ&quot;  type        = string  default     = &quot;ap-shanghai&quot;&#125;variable &quot;instance_name&quot; &#123;  description = &quot;kafkaå®ä¾‹å&quot;  type        = string&#125;variable &quot;availability_zone&quot; &#123;  # å¦‚ap-shanghai-2  description = &quot;å¯ç”¨åŒº&quot;  type = string&#125;variable &quot;charge_type&quot; &#123;  # PREPAID(é¢„ä»˜è´¹), POSTPAID_BY_HOUR(æŒ‰é‡ä»˜è´¹)  description = &quot;kafkaå®ä¾‹è®¡è´¹æ–¹å¼&quot;  type = string  validation &#123;    condition     = contains([&quot;PREPAID&quot;, &quot;POSTPAID_BY_HOUR&quot;], var.charge_type)    error_message = &quot;The charge_type must be one of PREPAID, POSTPAID_BY_HOUR&quot;  &#125;&#125;variable &quot;kafka_version&quot; &#123;  # 0.10.2/1.1.1/2.4.1/2.8.1  description = &quot;kafkaå®ä¾‹ç‰ˆæœ¬&quot;  type = string  validation &#123;    condition     = contains([&quot;0.10.2&quot;, &quot;1.1.1&quot;, &quot;2.4.1&quot;, &quot;2.4.2&quot;, &quot;2.8.1&quot;], var.kafka_version)    error_message = &quot;The kafka_version must be one of 0.10.2, 1.1.1, 2.4.1, 2.4.2, 2.8.1&quot;  &#125;&#125;variable &quot;vswitch_id&quot; &#123;  // é˜¿é‡Œäº‘vswitch_id -&gt; è…¾è®¯äº‘subnet_id  description = &quot;ç»‘å®šå­ç½‘id&quot;  type = string&#125;variable &quot;vpc_id&quot; &#123;  description = &quot;ç»‘å®švpc_id&quot;  type = string&#125;variable &quot;disk_size&quot; &#123;  # éœ€æ»¡è¶³å½“å‰å®ä¾‹çš„è®¡è´¹è§„æ ¼ï¼Œæ­¤å¤„é¢„è®¾200å’Œ400ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹  description = &quot;kafkaå®ä¾‹ç£ç›˜è§„æ ¼&quot;  type = number  validation &#123;    condition     = contains([200, 400], var.disk_size)    error_message = &quot;The disk_size must be one of 200, 400&quot;  &#125;&#125;variable &quot;disk_type&quot; &#123;  # ä¸“ä¸šç‰ˆå®ä¾‹ç£ç›˜ç±»å‹ï¼Œæ ‡å‡†ç‰ˆå®ä¾‹ä¸éœ€è¦å¡«å†™ï¼ŒCLOUD_SSD(SSDäº‘ç¡¬ç›˜), CLOUD_BASIC(é«˜æ€§èƒ½äº‘ç¡¬ç›˜)  description = &quot;kafkaä¸“ä¸šç‰ˆå®ä¾‹ç£ç›˜ç±»å‹&quot;  type = string  default = &quot;&quot;  validation &#123;    condition     = contains([&quot;&quot;, &quot;CLOUD_SSD&quot;, &quot;CLOUD_BASIC&quot;], var.disk_type)    error_message = &quot;The disk_type must be empty, or one of CLOUD_SSD, CLOUD_BASIC&quot;  &#125;&#125;variable &quot;band_width&quot; &#123;  # å•ä½ä¸ºMBps.  description = &quot;kafkaå®ä¾‹å¸¦å®½&quot;  type = number&#125;variable &quot;auto_create_topic_enable&quot; &#123;  description = &quot;æ˜¯å¦è‡ªåŠ¨åˆ›å»ºtopic&quot;  type = bool  default = true  validation &#123;    condition     = contains([true, false], var.auto_create_topic_enable)    error_message = &quot;The auto_create_topic_enable must be one of true, false&quot;  &#125;&#125;variable &quot;num_partitions&quot; &#123;  description = &quot;kafkaå®ä¾‹é»˜è®¤åˆ†åŒºæ•°&quot;  type = number  default = 3&#125;variable &quot;replication_factor&quot; &#123;  description = &quot;kafkaå®ä¾‹é»˜è®¤å‰¯æœ¬æ•°&quot;  type = number  default = 2&#125;variable &quot;dynamic_retention_config_enable&quot; &#123;  description = &quot;æ˜¯å¦å¯ç”¨åŠ¨æ€æ¶ˆæ¯ä¿ç•™æ—¶é—´é…ç½®&quot;  type = number  default = 0  validation &#123;    condition     = contains([0, 1], var.dynamic_retention_config_enable)    error_message = &quot;The dynamic_retention_config_enable must be one of 0, 1&quot;  &#125;&#125;variable &quot;msg_retention_time&quot; &#123;  # ä»¥åˆ†é’Ÿä¸ºå•ä½  description = &quot;kafkaå®ä¾‹æ—¥å¿—çš„æœ€å¤§ä¿ç•™æ—¶é—´&quot;  type = number  default = 10080&#125;variable &quot;partition&quot; &#123;  description = &quot;kafkaå®ä¾‹åˆ†åŒºå¤§å°&quot;  type = number  default = 3&#125;\n\nDemo&#x2F;tcloud&#x2F;tcloud_ckafka_demo&#x2F;tcloud_china_game_x6&#x2F;ckafaka_demo_202501221738&#x2F;backend.tfterraform &#123;  backend &quot;oss&quot; &#123;    endpoint = &quot;oss-cn-hangzhou.aliyuncs.com&quot;    bucket   = &quot;dz-devops&quot; # æ›¿æ¢ä¸ºä½ çš„ OSS Bucket åç§°    prefix = &quot;terraform_state/tcloud/tcloud_ckafka_demo/tcloud_china_game_x6/ckafka_demo_202501221738&quot;    key      = &quot;terraform.tfstate&quot; # å­˜å‚¨çŠ¶æ€æ–‡ä»¶çš„è·¯å¾„å’Œåç§°    region   = &quot;cn-hangzhou&quot;       # OSS çš„åœ°åŸŸï¼ˆæ ¹æ®ä½ çš„å®é™…æƒ…å†µè°ƒæ•´ï¼‰  &#125;&#125;\n\n&#x2F;tcloud&#x2F;tcloud_ckafka_demo&#x2F;tcloud_china_game_x6&#x2F;ckafaka_demo_202501221738&#x2F;main.tfmodule &quot;ckafka_instance&quot; &#123;  source              = &quot;../../../../modules/tcloud/tcloud_ckafka_mod_demo&quot;  region              = &quot;ap-shanghai&quot;  instance_name       = &quot;ckafka-test&quot;  availability_zone   = &quot;ap-shanghai-2&quot;  charge_type         = &quot;POSTPAID_BY_HOUR&quot;  kafka_version       = &quot;2.4.2&quot;  vpc_id              = &quot;vpc-4tkroxts&quot;  vswitch_id          = &quot;subnet-oy1pqvzv&quot;  disk_size           = 200  # disk_type           = &quot;CLOUD_BASIC&quot;  band_width          = 20  auto_create_topic_enable = true  num_partitions     = 3  replication_factor = 3  dynamic_retention_config_enable = 1  msg_retention_time = 1300  partition = 400&#125;\n\nè¿è¡Œæµ‹è¯•è·å– AK&#x2F;SKåœ¨é¦–æ¬¡ä½¿ç”¨ Terraform ä¹‹å‰ï¼Œéœ€è¦å‰å¾€è…¾è®¯äº‘çš„äº‘ API å¯†é’¥é¡µé¢ç”³è¯·å®‰å…¨å‡­è¯SecretIdå’ŒSecretKey2ã€‚è‹¥å·²æœ‰å¯ä½¿ç”¨çš„å®‰å…¨å‡­è¯ï¼Œåˆ™è·³è¿‡è¯¥æ­¥éª¤2ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹2ï¼š\n\nç™»å½•è…¾è®¯äº‘è®¿é—®ç®¡ç†æ§åˆ¶å°ï¼Œåœ¨å·¦ä¾§å¯¼èˆªæ ï¼Œé€‰æ‹©è®¿é—®å¯†é’¥&gt;API å¯†é’¥ç®¡ç†ã€‚\nåœ¨API å¯†é’¥ç®¡ç†é¡µé¢ï¼Œå•å‡»æ–°å»ºå¯†é’¥ï¼Œå³å¯ä»¥åˆ›å»ºä¸€å¯¹SecretId&#x2F;SecretKeyã€‚\n\nè®¾ç½®ç¯å¢ƒå˜é‡å°†è·å–åˆ°çš„SecretIdå’ŒSecretKeyè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼š\nexport TENCENTCLOUD_SECRET_ID=your_secret_idexport TENCENTCLOUD_SECRET_KEY=your_secret_key\n\nè¿è¡Œé¡¹ç›®è¿›å…¥é¡¹ç›®æ ¹ç›®å½•ï¼Œè¿™é‡Œæ˜¯ckafaka_demo_202501221738ç›®å½•ï¼š\ncd ./tcloud/tcloud_ckafka_demo/tcloud_china_game_x6/ckafaka_demo_202501221738/\n\nåˆå§‹åŒ– Terraform é¡¹ç›®:\n# å°†xxxæ›¿æ¢ä¸ºå®é™…backendçš„akï¼Œå°†yyyæ›¿æ¢ä¸ºå®é™…backendçš„skterraform init -backend-config=&quot;access_key=xxx&quot; -backend-config=&quot;secret_key=yyy&quot;\n\nè¯¥å‘½ä»¤ä¼šä¸‹è½½æ‰€éœ€çš„æ’ä»¶å’Œä¾èµ–ï¼Œå¹¶åˆå§‹åŒ–åç«¯é…ç½®ã€‚ç±»ä¼¼çš„è¾“å‡ºï¼ˆé¦–æ¬¡ä½¿ç”¨æŸä¸€ä¸ªprovieræ—¶ï¼Œä¼šå…ˆä¸‹è½½ï¼‰ï¼š\nInitializing the backend...Successfully configured the backend &quot;oss&quot;! Terraform will automaticallyuse this backend unless the backend configuration changes.Initializing modules...- ckafka_instance in ../../../../modules/tcloud/tcloud_ckafka_mod_demoInitializing provider plugins...- Finding latest version of tencentcloudstack/tencentcloud...- Installing tencentcloudstack/tencentcloud v1.81.162...- Installed tencentcloudstack/tencentcloud v1.81.162 (signed by a HashiCorp partner, key ID 84F69E1C1BECF459)Partner and community providers are signed by their developers.If you&#x27;d like to know more about provider signing, you can read about it here:https://www.terraform.io/docs/cli/plugins/signing.htmlTerraform has created a lock file .terraform.lock.hcl to record the providerselections it made above. Include this file in your version control repositoryso that Terraform can guarantee to make the same selections by default whenyou run &quot;terraform init&quot; in the future.Terraform has been successfully initialized!You may now begin working with Terraform. Try running &quot;terraform plan&quot; to seeany changes that are required for your infrastructure. All Terraform commandsshould now work.If you ever set or change modules or backend configuration for Terraform,rerun this command to reinitialize your working directory. If you forget, othercommands will detect it and remind you to do so if necessary.\n\né¢„è§ˆè®¡åˆ’å˜æ›´ï¼šterraform plan\nmodule.ckafka_instance.data.tencentcloud_availability_zones_by_product.zone: Reading...module.ckafka_instance.data.tencentcloud_availability_zones_by_product.zone: Read complete after 0s [id=2066006299]Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:  + createTerraform will perform the following actions:  # module.ckafka_instance.tencentcloud_ckafka_instance.this will be created  + resource &quot;tencentcloud_ckafka_instance&quot; &quot;this&quot; &#123;      + band_width          = 20      + charge_type         = &quot;POSTPAID_BY_HOUR&quot;      + disk_size           = 200      + disk_type           = &quot;CLOUD_BASIC&quot;      + id                  = (known after apply)      + instance_name       = &quot;ckafka-test&quot;      + instance_type       = (known after apply)      + kafka_version       = &quot;kafka_version&quot;      + max_message_byte    = (known after apply)      + msg_retention_time  = 1300      + partition           = 400      + public_network      = (known after apply)      + renew_flag          = (known after apply)      + specifications_type = &quot;profession&quot;      + subnet_id           = &quot;subnet-oy1pqvzv&quot;      + tag_set             = (known after apply)      + upgrade_strategy    = 1      + vip                 = (known after apply)      + vpc_id              = &quot;vpc-4tkroxts&quot;      + vport               = (known after apply)      + zone_id             = 200002      + config &#123;          + auto_create_topic_enable   = true          + default_num_partitions     = 3          + default_replication_factor = 3        &#125;      + dynamic_retention_config &#123;          + bottom_retention        = (known after apply)          + disk_quota_percentage   = (known after apply)          + enable                  = 1          + step_forward_percentage = (known after apply)        &#125;      + tags (known after apply)    &#125;Plan: 1 to add, 0 to change, 0 to destroy.â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€Note: You didn&#x27;t use the -out option to save this plan, so Terraform can&#x27;t guarantee to take exactly these actions if you run &quot;terraform apply&quot; now.\n\næ‰§è¡Œå˜æ›´ï¼š\nterraform apply\nmodule.ckafka_instance.data.tencentcloud_availability_zones_by_product.zone: Reading...module.ckafka_instance.data.tencentcloud_availability_zones_by_product.zone: Read complete after 1s [id=2066006299]Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:  + createTerraform will perform the following actions:  # module.ckafka_instance.tencentcloud_ckafka_instance.this will be created  + resource &quot;tencentcloud_ckafka_instance&quot; &quot;this&quot; &#123;      + band_width          = 20      + charge_type         = &quot;POSTPAID_BY_HOUR&quot;      + disk_size           = 200      + disk_type           = &quot;CLOUD_BASIC&quot;      + id                  = (known after apply)      + instance_name       = &quot;ckafka-test&quot;      + instance_type       = (known after apply)      + kafka_version       = &quot;kafka_version&quot;      + max_message_byte    = (known after apply)      + msg_retention_time  = 1300      + partition           = 400      + public_network      = (known after apply)      + renew_flag          = (known after apply)      + specifications_type = &quot;profession&quot;      + subnet_id           = &quot;subnet-oy1pqvzv&quot;      + tag_set             = (known after apply)      + upgrade_strategy    = 1      + vip                 = (known after apply)      + vpc_id              = &quot;vpc-4tkroxts&quot;      + vport               = (known after apply)      + zone_id             = 200002      + config &#123;          + auto_create_topic_enable   = true          + default_num_partitions     = 3          + default_replication_factor = 3        &#125;      + dynamic_retention_config &#123;          + bottom_retention        = (known after apply)          + disk_quota_percentage   = (known after apply)          + enable                  = 1          + step_forward_percentage = (known after apply)        &#125;      + tags (known after apply)    &#125;Plan: 1 to add, 0 to change, 0 to destroy.Do you want to perform these actions?  Terraform will perform the actions described above.  Only &#x27;yes&#x27; will be accepted to approve.  Enter a value: yesmodule.ckafka_instance.tencentcloud_ckafka_instance.this: Creating...module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [10s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [20s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [30s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [40s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [50s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [1m0s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [1m10s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [1m20s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [1m30s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [1m40s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [1m50s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [2m0s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [2m10s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [2m20s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [2m30s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [2m40s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [2m50s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Still creating... [3m0s elapsed]module.ckafka_instance.tencentcloud_ckafka_instance.this: Creation complete after 3m7s [id=ckafka-9jnda3jn]Apply complete! Resources: 1 added, 0 changed, 0 destroyed.\n\néªŒè¯åˆ›å»ºåœ¨å‰ç«¯æŸ¥çœ‹æ˜¯å¦æˆåŠŸåˆ›å»ºå®ä¾‹ï¼š\né”€æ¯èµ„æºæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿›è¡Œé”€æ¯ï¼š\nterraform destroy\nmodule.ckafka_instance.data.tencentcloud_availability_zones_by_product.zone: Reading...module.ckafka_instance.data.tencentcloud_availability_zones_by_product.zone: Read complete after 1s [id=2066006299]module.ckafka_instance.tencentcloud_ckafka_instance.this: Refreshing state... [id=ckafka-9jnda3jn]Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:  - destroyTerraform will perform the following actions:  # module.ckafka_instance.tencentcloud_ckafka_instance.this will be destroyed  - resource &quot;tencentcloud_ckafka_instance&quot; &quot;this&quot; &#123;      - band_width          = 20 -&gt; null      - charge_type         = &quot;POSTPAID_BY_HOUR&quot; -&gt; null      - disk_size           = 200 -&gt; null      - disk_type           = &quot;CLOUD_BASIC&quot; -&gt; null      - id                  = &quot;ckafka-9jnda3jn&quot; -&gt; null      - instance_name       = &quot;ckafka-test&quot; -&gt; null      - instance_type       = 1 -&gt; null      - kafka_version       = &quot;0.10.2.1&quot; -&gt; null      - msg_retention_time  = 1300 -&gt; null      - partition           = 400 -&gt; null      - public_network      = 3 -&gt; null      - renew_flag          = 0 -&gt; null      - specifications_type = &quot;profession&quot; -&gt; null      - subnet_id           = &quot;subnet-oy1pqvzv&quot; -&gt; null      - tag_set             = &#123;&#125; -&gt; null      - upgrade_strategy    = 1 -&gt; null      - vip                 = &quot;172.17.0.3&quot; -&gt; null      - vpc_id              = &quot;vpc-4tkroxts&quot; -&gt; null      - vport               = &quot;9092&quot; -&gt; null      - zone_id             = 200002 -&gt; null      - config &#123;          - auto_create_topic_enable   = true -&gt; null          - default_num_partitions     = 3 -&gt; null          - default_replication_factor = 3 -&gt; null        &#125;      - dynamic_retention_config &#123;          - bottom_retention        = 0 -&gt; null          - disk_quota_percentage   = 0 -&gt; null          - enable                  = 1 -&gt; null          - step_forward_percentage = 0 -&gt; null        &#125;    &#125;Plan: 0 to add, 0 to change, 1 to destroy.Do you really want to destroy all resources?  Terraform will destroy all your managed infrastructure, as shown above.  There is no undo. Only &#x27;yes&#x27; will be accepted to confirm.  Enter a value: yesmodule.ckafka_instance.tencentcloud_ckafka_instance.this: Destroying... [id=ckafka-9jnda3jn]module.ckafka_instance.tencentcloud_ckafka_instance.this: Destruction complete after 5sDestroy complete! Resources: 1 destroyed.\n\néªŒè¯é”€æ¯\n","categories":["devops/terraform"],"tags":["devops","terraform"]},{"title":"Kustomizeä¸Helmå¯¹æ¯”","url":"/2025/07/kubernetes/operator-kai-fa/kustomize-yu-helm-dui-bi/","content":"0ã€å‰è¨€K8s æ˜¯ä¸€ä¸ªå¼€æºå®¹å™¨ç¼–æ’å¹³å°ï¼Œå¯è‡ªåŠ¨æ‰§è¡Œå®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†ã€‚è¿‘å¹´æ¥ï¼ŒK8s å·²æˆä¸ºé‡‡ç”¨äº‘åŸç”Ÿæ¶æ„å’Œå®¹å™¨åŒ–æŠ€æœ¯çš„ç»„ç»‡çš„æ ‡å‡†ã€‚\nä½†æ˜¯ç”±äºK8sçš„å¤æ‚æ€§ï¼Œæ‰€ä»¥å¾ˆå¤šå…¬å¸ä»¥åŠå¼€æºç»„ç»‡éƒ½åœ¨å¼€å‘ç›¸å…³çš„å·¥å…·æ¥ç®€åŒ–k8sçš„ä½¿ç”¨é—¨æ§›ï¼Œè¿™å…¶ä¸­å°±åŒ…æ‹¬ä¸¤ä¸ªå¾ˆä¼˜ç§€çš„å¼€æºå·¥å…·ï¼ŒKustomizeï¼ˆK8s çš„é…ç½®ç®¡ç†å™¨ï¼‰å’ŒHelm ï¼ˆK8s çš„åŒ…ç®¡ç†å™¨ï¼‰ã€‚\næœ¬æ–‡å°†é’ˆå¯¹äºŒè€…æ¥è¿›è¡Œå¯¹æ¯”ã€‚\n\n\n\n\nKustomize\nHelm\n\n\n\næ“ä½œæ–¹æ³•\noverlays\ntemplating\n\n\nä½¿ç”¨æˆæœ¬\nç®€å•\nå¤æ‚\n\n\næ˜¯å¦æ”¯æŒå°è£…\nç®€å•\næ˜¯\n\n\nkubectlé›†æˆ\næ˜¯\nå¦\n\n\nkubectlé›†æˆ\nå£°æ˜å¼\nå‘½ä»¤å¼\n\n\n1ã€KustomizeKustomize æ˜¯ k8sé›†ç¾¤çš„é…ç½®å®šåˆ¶å·¥å…·ã€‚å®ƒå…è®¸ç®¡ç†å‘˜ä½¿ç”¨éæ¨¡æ¿æ–‡ä»¶è¿›è¡Œå£°æ˜æ€§æ›´æ”¹ï¼Œè€Œä¸å½±å“åŸå§‹æ¸…å•æ–‡ä»¶ã€‚\næ¥çœ‹ä¸€ä¸‹kubebuilderç”Ÿæˆé¡¹ç›®çš„Kustomizeé…ç½®ï¼Œä»¥&#x2F;config&#x2F;crdç›®å½•ä¸ºä¾‹ï¼š\nâ”œâ”€â”€ crdâ”‚   â”œâ”€â”€ basesâ”‚   â”‚   â””â”€â”€ apps.kubenode.alibaba-inc.com_myapps.yamlâ”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”œâ”€â”€ kustomizeconfig.yamlâ”‚   â””â”€â”€ patchesâ”‚       â”œâ”€â”€ cainjection_in_myapps.yamlâ”‚       â””â”€â”€ webhook_in_myapps.yaml\n\nå…¶ä¸­config&#x2F;crdç›®å½•æ˜¯æ‰§è¡Œkubebuilder create apiåç”Ÿæˆçš„ï¼Œæœ€åŸå§‹çš„ç›®å½•ç»“æ„æ˜¯ï¼š\nâ”œâ”€â”€ crdâ”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â””â”€â”€ kustomizeconfig.yaml\n\næ‰€ä»¥baseså­ç›®å½•å’Œpatcheså­ç›®å½•éƒ½æ˜¯æ‰§è¡Œmake manifestsåç”Ÿæˆçš„ã€‚\næ‰§è¡Œkubebuilder create apiå¯ä»¥å‚è€ƒï¼šhttps://blog.csdn.net/qq_41004932/article/details/142702284\næ‰§è¡Œmake manifestså¯ä»¥å‚è€ƒï¼šhttps://blog.csdn.net/qq_41004932/article/details/142703870\nåœ¨ Kubebuilder ç”Ÿæˆçš„é¡¹ç›®ä¸­ï¼Œconfig&#x2F;crd ç›®å½•ä¸‹çš„æ–‡ä»¶ä¸»è¦ç”¨äºç®¡ç†å’Œé…ç½®è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCustom Resource Definitions, CRDsï¼‰ã€‚è¿™äº›æ–‡ä»¶é€šè¿‡ Kustomize å·¥å…·è¿›è¡Œç®¡ç†ï¼Œä»¥ä¾¿äºåœ¨ä¸åŒçš„ç¯å¢ƒä¸­éƒ¨ç½²å’Œç®¡ç† CRDsã€‚ä¸‹é¢æ˜¯æ¯ä¸ªæ–‡ä»¶çš„ä½œç”¨è§£é‡Šï¼š\n\nbases ç›®å½•bases&#x2F;apps.kubenode.alibaba-inc.com_myapps.yaml:è¿™ä¸ªæ–‡ä»¶åŒ…å«äº†è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCRDï¼‰çš„ YAML æè¿°ã€‚å®ƒå®šä¹‰äº†ä½ çš„è‡ªå®šä¹‰èµ„æºï¼ˆCustom Resource, CRï¼‰çš„ç»“æ„å’Œå…ƒæ•°æ®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º MyApp çš„è‡ªå®šä¹‰èµ„æºï¼Œè¿™ä¸ªæ–‡ä»¶å°†æè¿° MyApp çš„ API ç‰ˆæœ¬ã€èµ„æºåç§°ã€å­—æ®µç­‰ã€‚\nkustomization.yaml:è¿™ä¸ªæ–‡ä»¶æ˜¯ Kustomize çš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰å¦‚ä½•ç»„åˆå’Œä¿®æ”¹ Kubernetes èµ„æºæ–‡ä»¶ã€‚å®ƒæŒ‡å®šäº†å“ªäº›èµ„æºæ–‡ä»¶ï¼ˆå¦‚ CRD æ–‡ä»¶ï¼‰éœ€è¦è¢«åº”ç”¨ï¼Œå¹¶ä¸”å¯ä»¥åŒ…å«è¡¥ä¸æ–‡ä»¶å’Œå…¶ä»–é…ç½®é€‰é¡¹ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥æŒ‡å®š bases ç›®å½•ä¸­çš„ CRD æ–‡ä»¶ï¼Œä»¥åŠ patches ç›®å½•ä¸­çš„è¡¥ä¸æ–‡ä»¶ã€‚\nkustomizeconfig.yaml:è¿™ä¸ªæ–‡ä»¶é€šå¸¸ç”¨äºé…ç½® Kustomize çš„ä¸€äº›é«˜çº§é€‰é¡¹ï¼Œä½†åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­å¯èƒ½ä¸æ˜¯å¿…éœ€çš„ã€‚å®ƒå¯èƒ½ä¼šåŒ…å«ä¸€äº›ç‰¹å®šçš„é…ç½®é¡¹ï¼Œç”¨äºå®šåˆ¶ Kustomize çš„è¡Œä¸ºã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ–‡ä»¶å¯èƒ½ä¸éœ€è¦æ‰‹åŠ¨ç¼–è¾‘ã€‚\npatches&#x2F;cainjection_in_myapps.yaml:è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ªè¡¥ä¸æ–‡ä»¶ï¼Œç”¨äºåœ¨ CRD ä¸Šåº”ç”¨ Webhook æ³¨å…¥ï¼ˆä¾‹å¦‚ï¼Œè¯ä¹¦æ³¨å…¥ï¼‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ çš„ CRD éœ€è¦ä¸ mutating æˆ– validating webhooks ä¸€èµ·å·¥ä½œï¼Œè¿™ä¸ªè¡¥ä¸æ–‡ä»¶ä¼šç¡®ä¿ Webhook é…ç½®æ­£ç¡®åœ°æ³¨å…¥åˆ° CRD ä¸­ã€‚\npatches&#x2F;webhook_in_myapps.yaml:è¿™ä¸ªæ–‡ä»¶ä¹Ÿæ˜¯ä¸€ä¸ªè¡¥ä¸æ–‡ä»¶ï¼Œç”¨äºåœ¨ CRD ä¸Šåº”ç”¨ Webhook é…ç½®ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½ä¼šæ·»åŠ æˆ–ä¿®æ”¹ Webhook çš„é…ç½®ï¼Œä»¥ä¾¿åœ¨åˆ›å»ºæˆ–æ›´æ–°è‡ªå®šä¹‰èµ„æºæ—¶è§¦å‘ç‰¹å®šçš„è¡Œä¸ºã€‚\n\næ€»ç»“\nbases ç›®å½•ï¼šåŒ…å« CRD çš„åŸºæœ¬å®šä¹‰æ–‡ä»¶ã€‚\nkustomization.yamlï¼šKustomize çš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰å¦‚ä½•ç»„åˆå’Œä¿®æ”¹èµ„æºæ–‡ä»¶ã€‚\nkustomizeconfig.yamlï¼šKustomize çš„é«˜çº§é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰ã€‚\npatches ç›®å½•ï¼šåŒ…å«ç”¨äºä¿®æ”¹ CRD çš„è¡¥ä¸æ–‡ä»¶ï¼Œé€šå¸¸ç”¨äºæ³¨å…¥ Webhook é…ç½®ã€‚\nå¦‚æœæˆ‘ä»¬åƒè®©è¿™ä¸ªcrdæ ¹æ®ä¸åŒçš„ç¯å¢ƒåšé’ˆå¯¹æ€§éƒ¨ç½²çš„ï¼Œä¾‹å¦‚ä¸‹é¢çš„ç›®å½•ç»“æ„:\nâ”œâ”€â”€ crdâ”‚   â”œâ”€â”€ basesâ”‚   â”‚   â””â”€â”€ apps.kubenode.alibaba-inc.com_myapps.yamlâ”‚   â”œâ”€â”€ developmentâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ patchesâ”‚   â”‚       â””â”€â”€ webhook_in_myapps.yamlâ”‚   â”œâ”€â”€ testingâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ patchesâ”‚   â”‚       â””â”€â”€ webhook_in_myapps.yamlâ”‚   â”œâ”€â”€ productionâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ patchesâ”‚   â”‚       â””â”€â”€ webhook_in_myapps.yamlâ”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”œâ”€â”€ kustomizeconfig.yamlâ”‚   â””â”€â”€ patchesâ”‚       â”œâ”€â”€ cainjection_in_myapps.yamlâ”‚       â””â”€â”€ webhook_in_myapps.yaml\n\næ‰€æœ‰è‡ªå®šä¹‰è§„èŒƒéƒ½åŒ…å«åœ¨ kustomization.yaml æ–‡ä»¶ä¸­ï¼Œè¯¥æ–‡ä»¶å°†è§„èŒƒå åŠ åœ¨ç°æœ‰æ¸…å•ä¹‹ä¸Šä»¥ç”Ÿæˆèµ„æºçš„è‡ªå®šä¹‰ç‰ˆæœ¬ã€‚\næ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸€ç‰¹æ€§ï¼Œé’ˆå¯¹ä¸åŒçš„ç¯å¢ƒï¼Œå¯¹crdè¿›è¡Œå®šåˆ¶ã€‚\n2ã€HelmHelm æ˜¯ä¸€ä¸ªèƒ½å¤Ÿåœ¨ K8s ä¸Šæ‰“åŒ…ã€éƒ¨ç½²å’Œç®¡ç†åº”ç”¨ç¨‹åºçš„å·¥å…·ï¼Œå³ä½¿æ˜¯æœ€å¤æ‚çš„ K8s åº”ç”¨ç¨‹åºå®ƒéƒ½å¯ä»¥å¸®åŠ©å®šä¹‰ï¼Œå®‰è£…å’Œå‡çº§ï¼ŒåŒæ—¶Helm ä¹Ÿæ˜¯ CNCF çš„æ¯•ä¸šé¡¹ç›®ã€‚è¿™é‡Œæ¶‰åŠåˆ°äº†ä»¥åŠå…³äºhelmçš„é‡è¦æ¦‚å¿µï¼š\n\nHelm Chartsï¼šé¢„å…ˆé…ç½®yamlçš„æ¨¡æ¿ï¼Œåœ¨è¿™é‡Œå«Chartï¼Œç”¨äºæè¿° K8s åº”ç”¨ç¨‹åºçš„yamlå’Œé…ç½®\nHelm Clientï¼šç”¨äºä¸ Helm äº¤äº’å¹¶ç®¡ç†è¿™äº›Chartç‰ˆæœ¬çš„å‘½ä»¤è¡Œç•Œé¢\nChart ä»“åº“ï¼šç®¡ç†Chartçš„ä»“åº“ï¼Œè·ŸMavençš„Nexusä¸€ä¸ªæ„æ€ï¼Œæ¯”å¦‚åœ¨å…¬å¸ç¯å¢ƒæ„å»ºä¸Šä¼ ï¼Œåœ¨å®¢æˆ·çš„æœºæˆ¿è¿æ¥åˆ°è¿™Chart ä»“åº“ä¸‹è½½Chartï¼Œå¹¶éƒ¨ç½²åˆ°k8sä¸­ã€‚\n\n2.1 helmç¤ºä¾‹helmçš„ç¤ºä¾‹éœ€è¦ç”¨åˆ°kubectlã€helmä»¥åŠk8sé›†ç¾¤ï¼Œç›¸åº”çš„å®‰è£…å‚è€ƒï¼š\n\nmacç¯å¢ƒï¼šhttps://blog.csdn.net/qq_41004932/article/details/142684319\nubuntuç¯å¢ƒï¼šhttps://blog.csdn.net/qq_41004932/article/details/142691490\nkindé›†ç¾¤ï¼šhttps://blog.csdn.net/qq_41004932/article/details/142691490\n\nHelm Charts æ˜¯é¢„å…ˆé…ç½®çš„ K8s èµ„æºåŒ…ã€‚Helm Chart åŒ…å«éƒ¨ç½²ç‰¹å®šåº”ç”¨ç¨‹åºæˆ–æœåŠ¡æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬ K8s æ¸…å•ã€ç¯å¢ƒå˜é‡å’Œå…¶ä»–é…ç½®\nç›®å½•åç§°æ˜¯Chartçš„åç§°ï¼Œå¦‚Helm æ–‡æ¡£æ‰€ç¤ºï¼Œæˆ‘ä»¬é€šè¿‡helm create demoå‘½ä»¤åˆ›å»ºä¸€ä¸ªChartï¼Œæ‰§è¡Œå®Œä»¥åï¼Œé»˜è®¤ä¼šç”Ÿæˆä¸€ä¸ª nginx çš„Chartã€‚\nhelm create demo\n\nç»“æœï¼š\n$ helm create demo                                                                                                                      [10:33:35]Creating demo\n\næŸ¥çœ‹ç›®å½•ç»“æ„ï¼š\n.â”œâ”€â”€ Chart.yamlâ”œâ”€â”€ chartsâ”œâ”€â”€ templatesâ”‚   â”œâ”€â”€ NOTES.txtâ”‚   â”œâ”€â”€ _helpers.tplâ”‚   â”œâ”€â”€ deployment.yamlâ”‚   â”œâ”€â”€ hpa.yamlâ”‚   â”œâ”€â”€ ingress.yamlâ”‚   â”œâ”€â”€ service.yamlâ”‚   â”œâ”€â”€ serviceaccount.yamlâ”‚   â””â”€â”€ testsâ”‚       â””â”€â”€ test-connection.yamlâ””â”€â”€ values.yaml3 directories, 10 files\n\n2.2 Chart.yamlå®šä¹‰äº†å½“å‰ chartç‰ˆæœ¬ï¼Œä»¥åŠæè¿°å½“å‰chartç”¨é€”ï¼Œå…¶ä¸­ name å‚æ•°è¡¨ç¤º chart åç§°ï¼ŒåæœŸä¸Šä¼ ä¸‹è½½éƒ½ä¼šç”¨æ­¤åç§°\napiVersion: v2name: demodescription: A Helm chart for Kubernetes# A chart can be either an &#x27;application&#x27; or a &#x27;library&#x27; chart.## Application charts are a collection of templates that can be packaged into versioned archives# to be deployed.## Library charts provide useful utilities or functions for the chart developer. They&#x27;re included as# a dependency of application charts to inject those utilities and functions into the rendering# pipeline. Library charts do not define any templates and therefore cannot be deployed.type: application# This is the chart version. This version number should be incremented each time you make changes# to the chart and its templates, including the app version.# Versions are expected to follow Semantic Versioning (https://semver.org/)version: 0.1.0# This is the version number of the application being deployed. This version number should be# incremented each time you make changes to the application. Versions are not expected to# follow Semantic Versioning. They should reflect the version the application is using.# It is recommended to use it with quotes.appVersion: &quot;1.16.0&quot;\n\n2.3 values.yamlå¯å˜å‚æ•°ï¼Œéƒ½æ˜¯åœ¨æ­¤æ–‡ä»¶ä¸­å®šä¹‰ï¼Œåœ¨yamlæ¨¡æ¿ä¸­å¼•ç”¨ï¼Œæ¯”å¦‚ï¼šimage.repositoryï¼Œè€Œå¼•ç”¨åˆ™é€šè¿‡.Values+å˜é‡çš„åè¿›è¡Œå¼•ç”¨\n# Default values for demo.# This is a YAML-formatted file.# Declare variables to be passed into your templates.replicaCount: 1image:  repository: nginx  pullPolicy: IfNotPresent  # Overrides the image tag whose default is the chart appVersion.  tag: &quot;&quot;imagePullSecrets: []nameOverride: &quot;&quot;fullnameOverride: &quot;&quot;serviceAccount:  # Specifies whether a service account should be created  create: true  # Annotations to add to the service account  annotations: &#123;&#125;  # The name of the service account to use.  # If not set and create is true, a name is generated using the fullname template  name: &quot;&quot;podAnnotations: &#123;&#125;podSecurityContext: &#123;&#125;  # fsGroup: 2000securityContext: &#123;&#125;  # capabilities:  #   drop:  #   - ALL  # readOnlyRootFilesystem: true  # runAsNonRoot: true  # runAsUser: 1000service:  type: ClusterIP  port: 80ingress:  enabled: false  className: &quot;&quot;  annotations: &#123;&#125;    # kubernetes.io/ingress.class: nginx    # kubernetes.io/tls-acme: &quot;true&quot;  hosts:    - host: chart-example.local      paths:        - path: /          pathType: ImplementationSpecific  tls: []  #  - secretName: chart-example-tls  #    hosts:  #      - chart-example.localresources: &#123;&#125;  # We usually recommend not to specify default resources and to leave this as a conscious  # choice for the user. This also increases chances charts run on environments with little  # resources, such as Minikube. If you do want to specify resources, uncomment the following  # lines, adjust them as necessary, and remove the curly braces after &#x27;resources:&#x27;.  # limits:  #   cpu: 100m  #   memory: 128Mi  # requests:  #   cpu: 100m  #   memory: 128Miautoscaling:  enabled: false  minReplicas: 1  maxReplicas: 100  targetCPUUtilizationPercentage: 80  # targetMemoryUtilizationPercentage: 80nodeSelector: &#123;&#125;tolerations: []affinity: &#123;&#125;\n\n2.4 _helpers.tplå®šä¹‰é€šç”¨ä»£ç å—ï¼Œç„¶åyaml æ–‡ä»¶ä¼šé€šè¿‡ include å¼•ç”¨\nå®šä¹‰:\n&#123;&#123;- define &quot;demo.name&quot; -&#125;&#125;&#123;&#123;- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix &quot;-&quot; &#125;&#125;&#123;&#123;- end &#125;&#125;\n\nå¼•ç”¨:\n&#123;&#123; include &quot;demo.fullname&quot; . &#125;&#125;\n2.5 templatesæ­¤ç›®å½•ä¸»è¦å­˜æ”¾çš„æ˜¯è¦éƒ¨ç½²çš„ yamlæ–‡ä»¶æ¨¡æ¿ï¼ŒåŒæ—¶ä¹ŸåŒ…å«_helpers.tplæ–‡ä»¶ï¼Œæ¨¡æ¿ä¼šå¼•ç”¨values.yamlã€Chart.yamlå®šä¹‰çš„å‚æ•°ï¼Œä»¥åŠ_helpers.tplå®šä¹‰çš„é€šç”¨ä»£ç å—\napiVersion: apps/v1kind: Deploymentmetadata:  name: &#123;&#123; include &quot;demo.fullname&quot; . &#125;&#125;  labels:    &#123;&#123;- include &quot;demo.labels&quot; . | nindent 4 &#125;&#125;spec:  &#123;&#123;- if not .Values.autoscaling.enabled &#125;&#125;  replicas: &#123;&#123; .Values.replicaCount &#125;&#125;  &#123;&#123;- end &#125;&#125;  selector:    matchLabels:      &#123;&#123;- include &quot;demo.selectorLabels&quot; . | nindent 6 &#125;&#125;  template:    metadata:      &#123;&#123;- with .Values.podAnnotations &#125;&#125;      annotations:        &#123;&#123;- toYaml . | nindent 8 &#125;&#125;      &#123;&#123;- end &#125;&#125;      labels:        &#123;&#123;- include &quot;demo.selectorLabels&quot; . | nindent 8 &#125;&#125;    spec:      &#123;&#123;- with .Values.imagePullSecrets &#125;&#125;      imagePullSecrets:        &#123;&#123;- toYaml . | nindent 8 &#125;&#125;      &#123;&#123;- end &#125;&#125;      serviceAccountName: &#123;&#123; include &quot;demo.serviceAccountName&quot; . &#125;&#125;      securityContext:        &#123;&#123;- toYaml .Values.podSecurityContext | nindent 8 &#125;&#125;      containers:        - name: &#123;&#123; .Chart.Name &#125;&#125;          securityContext:            &#123;&#123;- toYaml .Values.securityContext | nindent 12 &#125;&#125;          image: &quot;&#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag | default .Chart.AppVersion &#125;&#125;&quot;          imagePullPolicy: &#123;&#123; .Values.image.pullPolicy &#125;&#125;          ports:            - name: http              containerPort: &#123;&#123; .Values.service.port &#125;&#125;              protocol: TCP          livenessProbe:            httpGet:              path: /              port: http          readinessProbe:            httpGet:              path: /              port: http          resources:            &#123;&#123;- toYaml .Values.resources | nindent 12 &#125;&#125;      &#123;&#123;- with .Values.nodeSelector &#125;&#125;      nodeSelector:        &#123;&#123;- toYaml . | nindent 8 &#125;&#125;      &#123;&#123;- end &#125;&#125;      &#123;&#123;- with .Values.affinity &#125;&#125;      affinity:        &#123;&#123;- toYaml . | nindent 8 &#125;&#125;      &#123;&#123;- end &#125;&#125;      &#123;&#123;- with .Values.tolerations &#125;&#125;      tolerations:        &#123;&#123;- toYaml . | nindent 8 &#125;&#125;      &#123;&#123;- end &#125;&#125;\n\nimage: &quot;&#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag | default .Chart.AppVersion &#125;&#125;&quot;\n\n2.5 éƒ¨ç½²å¦‚æœæƒ³éƒ¨ç½²çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤è¿›è¡Œ\nhelm package helm-demo\n\nå¯ä»¥å‘ç°ï¼Œè¿™é‡Œhelmæ˜¯å°†è¦éƒ¨ç½²çš„èµ„æºå½“ä½œä¸€ä¸ªæ•´ä½“æ¥è¿›è¡Œæ“ä½œçš„ï¼Œä¹Ÿå°±æ˜¯è®²ä¸€ä¸ªèµ„æºçš„æ‰€æœ‰yamlé…ç½®ä½œä¸ºä¸€ä¸ªæ•´ä½“çš„å½¢å¼æ¥è¿›è¡Œæ“ä½œã€‚\n3ã€ä¸»è¦å·®å¼‚3.1 æ“ä½œæ–¹æ³•Kustomize ä¾èµ–ç‰¹å®šäºç›®å½•çš„kustomization.yamlæ–‡ä»¶æ¥æ„å»ºå„ä¸ªèµ„æºå¹¶å¯¹å…¶è¿›è¡Œæ›´æ”¹ã€‚è¿™äº›æ–‡ä»¶å°†è¡¥ä¸å’Œè¦†ç›–åº”ç”¨åˆ°å…±äº«åŸºæ–‡ä»¶å¤¹ä¸­å£°æ˜çš„èµ„æºï¼Œä»¥æä¾›è‡ªåŠ¨åŒ–çš„å¤šç¯å¢ƒé…ç½®ã€‚\nHelm é€šè¿‡å¼•ç”¨value.yamlæ–‡ä»¶ä½œä¸ºå˜é‡æºï¼Œä½¿ç”¨æ¨¡æ¿ç”Ÿæˆæœ‰æ•ˆçš„ K8s é…ç½®ã€‚æ¨¡æ¿ç›®å½•æ‰˜ç®¡ Helm Chartåœ¨éƒ¨ç½²æœŸé—´ç”¨äºåˆ›å»ºèµ„æºçš„æ–‡ä»¶ã€‚\n3.2 ä¾¿æ·æ€§ä»K8s ç‰ˆæœ¬ 1.14 å¼€å§‹ï¼ŒKustomize ä¸ kubectl CLI æ†ç»‘åœ¨ä¸€èµ·ï¼Œå› æ­¤ä¸éœ€è¦æŒæ¡ä»»ä½•å…¶ä»–å·¥å…·ã€‚Kustomize æ”¯æŒå£°æ˜å¼éƒ¨ç½²ï¼Œå¹¶å¯¹æ¯ä¸ªæ–‡ä»¶ä½¿ç”¨çº¯ YAMLï¼Œä»è€Œæ›´å®¹æ˜“ä½¿ç”¨ã€‚\nHelm ä¸ºK8såŒ…ç®¡ç†ä»»åŠ¡æ·»åŠ äº†é¢å¤–çš„æŠ½è±¡å±‚ï¼Œä»è€ŒåŠ å¿«äº†å¸Œæœ›ç®€åŒ–é›†ç¾¤é…ç½®å’Œå‘å¸ƒè‡ªåŠ¨åŒ–çš„å›¢é˜Ÿçš„å­¦ä¹ æ›²çº¿ã€‚Helm Chart ç›¸å¯¹Kustomizeå¤æ‚ï¼Œä¸è¿‡åŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚\n3.3 æ‰“åŒ…Kustomize ç¼ºä¹çš„æ‰“åŒ…åŠŸèƒ½ï¼Œå¹¶ä¸”æ¯ä¸ªèµ„æºéƒ½å¿…é¡»åœ¨åŸºæœ¬æ–‡ä»¶å¤¹ä¸­å£°æ˜ï¼Œå¹¶åœ¨è¦†ç›–kustomization.yamlæ–‡ä»¶ä¸­å•ç‹¬å£°æ˜å˜ä½“ã€‚\nè€ŒHelmå°†æ‰€æœ‰å¿…éœ€çš„K8sèµ„æºéƒ½æ‰“åŒ…åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œè¯¥æ–‡ä»¶å¤¹å¯ä»¥æ ¹æ®éœ€è¦é‡å¤ä½¿ç”¨ã€‚Helm è¿˜å…è®¸è®¾ç½®åº”ç”¨ç¨‹åºé»˜è®¤å€¼ï¼Œå¹¶ä¸”ä½¿ç”¨values.yamlæ–‡ä»¶ä¿®æ”¹å‚æ•°ï¼Œä»è€Œæ³¨å…¥å¼•ç”¨çš„ yaml æ–‡ä»¶ä¸­ã€‚\n3.4 åŸç”Ÿ kubectl é›†æˆä» K8s 1.14 ç‰ˆå¼€å§‹ï¼ŒKustomize å°±é¢„è£…äº† kubectlï¼ŒHelm å¹¶æœªä¸ K8s é¢„å…ˆé›†æˆï¼Œå› æ­¤å¿…é¡»æ‰‹åŠ¨å®‰è£… Helmã€‚\n3.5 Kustomize ä¸ Helm - ä½•æ—¶ä½¿ç”¨3.5.1 ä½•æ—¶ä½¿ç”¨ KustomizeKustomizeå…è®¸åœ¨ä¸æ”¹å˜åŸå§‹æ–‡ä»¶çš„æƒ…å†µä¸‹è¿›è¡Œç²¾ç¡®æ›´æ”¹ã€‚ å› æ­¤å¯ä»¥æœ‰ä»¥ä¸‹åœºæ™¯\n\nåº”ç”¨é…ç½®çš„å˜ä½“ç®¡ç†ï¼šå½“ä½ éœ€è¦ç®¡ç†å¤šä¸ªç¯å¢ƒï¼ˆä¾‹å¦‚å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰ä¸­åº”ç”¨çš„å˜ä½“æ—¶ï¼ŒKustomize æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚å®ƒå…è®¸ä½ ä¸ºä¸åŒçš„ç¯å¢ƒåˆ›å»ºä¸åŒçš„é…ç½®ï¼Œå¹¶ä½¿ç”¨ä¸€å¥—åŸºç¡€é…ç½®æ¥å®šä¹‰é€šç”¨éƒ¨åˆ†ã€‚\næŒç»­é›†æˆå’ŒæŒç»­éƒ¨ç½²ï¼ˆCI&#x2F;CDï¼‰æµæ°´çº¿ï¼šKustomize å¯ä»¥ä¸ CI&#x2F;CD å·¥å…·é›†æˆï¼Œå¸®åŠ©ä½ å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚é€šè¿‡åœ¨æµæ°´çº¿ä¸­ä½¿ç”¨ Kustomizeï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦ç”Ÿæˆç‰¹å®šç¯å¢ƒçš„é…ç½®ï¼Œå¹¶å°†å…¶åº”ç”¨åˆ°é›†ç¾¤ä¸­ã€‚\n\n3.5.2 ä½•æ—¶ä½¿ç”¨ HelmHelm å°†æ‰€æœ‰ K8s å¯¹è±¡å°è£…åˆ°ä¸€ä¸ªåŒ…ä¸­ï¼Œå‡å°‘äº†ä¸å„ä¸ªyaml æ–‡ä»¶çš„äº¤äº’ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¤§å¤šæ•°ç¬¬ä¸‰æ–¹ä¾›åº”å•†è¿˜æä¾›é¢„æ„å»ºçš„ Helm å›¾è¡¨ï¼Œä»¥ç®€åŒ–å°†å…¶äº§å“éƒ¨ç½²åˆ° K8s ä¸­çš„è¿‡ç¨‹ã€‚å› æ­¤ï¼ŒHelm é€šå¸¸æ˜¯å®‰è£…ç°æˆè§£å†³æ–¹æ¡ˆï¼ˆä¾‹å¦‚ç›‘æ§ã€æ•°æ®åº“å’Œæ¶ˆæ¯ä¸­é—´ä»¶ç­‰ï¼‰çš„é¦–é€‰\n","categories":["kubernetes/operator"],"tags":["kubernetes","operator"]},{"title":"kubebuilderçš„makefileæ–‡ä»¶","url":"/2025/07/kubernetes/operator-kai-fa/kubebuilder-de-makefile-wen-jian/","content":"1ã€Makefileç®€ä»‹Makefile æ˜¯ä¸€ç§ç”¨äºè‡ªåŠ¨åŒ–æ„å»ºè½¯ä»¶é¡¹ç›®çš„æ–‡ä»¶ã€‚å®ƒé€šå¸¸ç”¨äºç®¡ç†å’Œæ‰§è¡Œç¼–è¯‘ã€é“¾æ¥ã€æµ‹è¯•ç­‰ä¸€ç³»åˆ—ä»»åŠ¡ï¼Œä»¥æé«˜å¼€å‘æ•ˆç‡ã€‚\n1.1 ç›®æ ‡ä¸ä¾èµ–1.1.1ç›®æ ‡ï¼ˆTargetsï¼‰\nä»£è¡¨ä¸€ä¸ªä»»åŠ¡æˆ–ä¸€ä¸ªæ–‡ä»¶çš„ç”Ÿæˆç»“æœã€‚ä¾‹å¦‚ï¼Œç¼–è¯‘ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€åº“æ–‡ä»¶ç­‰éƒ½å¯ä»¥æ˜¯ç›®æ ‡ã€‚\nå¸¸è§çš„ç›®æ ‡æœ‰ â€œallâ€ï¼ˆè¡¨ç¤ºæ„å»ºæ•´ä¸ªé¡¹ç›®ï¼‰ã€â€œcleanâ€ï¼ˆç”¨äºæ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶ï¼‰ç­‰ã€‚\n\n1.1.2 ä¾èµ–ï¼ˆDependenciesï¼‰\nç›®æ ‡æ‰€ä¾èµ–çš„å…¶ä»–æ–‡ä»¶æˆ–ç›®æ ‡ã€‚åªæœ‰å½“ä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡æ–°æ‰§è¡Œç”Ÿæˆç›®æ ‡çš„å‘½ä»¤ã€‚\nä¾‹å¦‚ï¼Œä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¯èƒ½ä¾èµ–äºå¤šä¸ªæºæ–‡ä»¶å’Œåº“æ–‡ä»¶ã€‚\n\n1.2 è§„åˆ™ä¸å‘½ä»¤1.2.1 è§„åˆ™ï¼ˆRulesï¼‰\næè¿°äº†å¦‚ä½•ä»ä¾èµ–ç”Ÿæˆç›®æ ‡ã€‚é€šå¸¸ç”±ç›®æ ‡ã€ä¾èµ–å’Œå‘½ä»¤ä¸‰éƒ¨åˆ†ç»„æˆã€‚\næ ¼å¼ä¸€èˆ¬ä¸ºï¼štarget: dependenciesï¼Œæ¥ç€æ˜¯å‘½ä»¤éƒ¨åˆ†ï¼Œæ¯è¡Œå‘½ä»¤å‰é¢å¿…é¡»ä»¥åˆ¶è¡¨ç¬¦ï¼ˆTabï¼‰å¼€å¤´ã€‚\n\n1.2.2 å‘½ä»¤ï¼ˆCommandsï¼‰\nç”¨äºæ‰§è¡Œç”Ÿæˆç›®æ ‡çš„å…·ä½“æ“ä½œã€‚å¯ä»¥æ˜¯ç¼–è¯‘å™¨å‘½ä»¤ã€é“¾æ¥å™¨å‘½ä»¤ã€æ–‡ä»¶å¤åˆ¶å‘½ä»¤ç­‰ã€‚\nä¾‹å¦‚ï¼Œç¼–è¯‘ C è¯­è¨€æºæ–‡ä»¶çš„å‘½ä»¤å¯èƒ½æ˜¯gcc -o target source.cã€‚\n\n1.3 å˜é‡ä¸å‡½æ•°1.3.1 å˜é‡ï¼ˆVariablesï¼‰\nå¯ä»¥å®šä¹‰å’Œä½¿ç”¨å˜é‡æ¥å­˜å‚¨å¸¸ç”¨çš„å€¼ï¼Œå¦‚ç¼–è¯‘å™¨åç§°ã€ç¼–è¯‘é€‰é¡¹ã€æºæ–‡ä»¶åˆ—è¡¨ç­‰ã€‚\nå˜é‡å®šä¹‰æ–¹å¼ä¸ºVARIABLE &#x3D; valueï¼Œä½¿ç”¨æ—¶ç”¨$(VARIABLE)ã€‚\n\n1.3.2 å‡½æ•°ï¼ˆFunctionsï¼‰\nMakefile æä¾›äº†ä¸€äº›å†…ç½®å‡½æ•°ï¼Œå¯ä»¥è¿›è¡Œå­—ç¬¦ä¸²å¤„ç†ã€æ–‡ä»¶æ“ä½œç­‰ã€‚\nä¾‹å¦‚ï¼Œ$(wildcard *.c)å¯ä»¥è·å–å½“å‰ç›®å½•ä¸‹æ‰€æœ‰çš„ C è¯­è¨€æºæ–‡ä»¶ã€‚\n\n1.4 ä¼˜åŠ¿1.4.1 è‡ªåŠ¨åŒ–æ„å»º\nå¯ä»¥è‡ªåŠ¨æ‰§è¡Œä¸€ç³»åˆ—æ„å»ºæ­¥éª¤ï¼Œå‡å°‘æ‰‹åŠ¨æ“ä½œå’Œé”™è¯¯ã€‚\nå½“æºæ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåªé‡æ–°æ„å»ºå—å½±å“çš„éƒ¨åˆ†ï¼Œæé«˜æ„å»ºæ•ˆç‡ã€‚\n\n1.4.2 å¯é‡å¤æ€§ç¡®ä¿åœ¨ä¸åŒçš„ç¯å¢ƒä¸­éƒ½èƒ½ä»¥ç›¸åŒçš„æ–¹å¼æ„å»ºé¡¹ç›®ã€‚\n1.4.3 æ˜“äºç»´æŠ¤é¡¹ç›®çš„æ„å»ºè¿‡ç¨‹é›†ä¸­åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä¾¿äºä¿®æ”¹å’Œç®¡ç†ã€‚\n2ã€kubebuilder makefile2.1 kubebuilder é¡¹ç›®makefileä¸€ä¸ªkubebuilderåˆ›å»ºçš„operatoré¡¹ç›®çš„makefileæ–‡ä»¶å†…å®¹ï¼š\n# Image URL to use all building/pushing image targetsIMG ?= controller:latest# ENVTEST_K8S_VERSION refers to the version of kubebuilder assets to be downloaded by envtest binary.ENVTEST_K8S_VERSION = 1.31.0# Get the currently used golang install path (in GOPATH/bin, unless GOBIN is set)ifeq (,$(shell go env GOBIN))GOBIN=$(shell go env GOPATH)/binelseGOBIN=$(shell go env GOBIN)endif# CONTAINER_TOOL defines the container tool to be used for building images.# Be aware that the target commands are only tested with Docker which is# scaffolded by default. However, you might want to replace it to use other# tools. (i.e. podman)CONTAINER_TOOL ?= docker# Setting SHELL to bash allows bash commands to be executed by recipes.# Options are set to exit when a recipe line exits non-zero or a piped command fails.SHELL = /usr/bin/env bash -o pipefail.SHELLFLAGS = -ec.PHONY: allall: build##@ General# The help target prints out all targets with their descriptions organized# beneath their categories. The categories are represented by &#x27;##@&#x27; and the# target descriptions by &#x27;##&#x27;. The awk command is responsible for reading the# entire set of makefiles included in this invocation, looking for lines of the# file as xyz: ## something, and then pretty-format the target and help. Then,# if there&#x27;s a line with ##@ something, that gets pretty-printed as a category.# More info on the usage of ANSI control characters for terminal formatting:# https://en.wikipedia.org/wiki/ANSI_escape_code#SGR_parameters# More info on the awk command:# http://linuxcommand.org/lc3_adv_awk.php.PHONY: helphelp: ## Display this help.        @awk &#x27;BEGIN &#123;FS = &quot;:.*##&quot;; printf &quot;\\nUsage:\\n  make \\033[36m&lt;target&gt;\\033[0m\\n&quot;&#125; /^[a-zA-Z_0-9-]+:.*?##/ &#123; printf &quot;  \\033[36m%-15s\\033[0m %s\\n&quot;, $$1, $$2 &#125; /^##@/ &#123; printf &quot;\\n\\033[1m%s\\033[0m\\n&quot;, substr($$0, 5) &#125; &#x27; $(MAKEFILE_LIST)##@ Development.PHONY: manifestsmanifests: controller-gen ## Generate WebhookConfiguration, ClusterRole and CustomResourceDefinition objects.        $(CONTROLLER_GEN) rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases.PHONY: generategenerate: controller-gen ## Generate code containing DeepCopy, DeepCopyInto, and DeepCopyObject method implementations.        $(CONTROLLER_GEN) object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;.PHONY: fmtfmt: ## Run go fmt against code.        go fmt ./....PHONY: vetvet: ## Run go vet against code.        go vet ./....PHONY: testtest: manifests generate fmt vet envtest ## Run tests.        KUBEBUILDER_ASSETS=&quot;$(shell $(ENVTEST) use $(ENVTEST_K8S_VERSION) --bin-dir $(LOCALBIN) -p path)&quot; go test $$(go list ./... | grep -v /e2e) -coverprofile cover.out# Utilize Kind or modify the e2e tests to load the image locally, enabling compatibility with other vendors..PHONY: test-e2e  # Run the e2e tests against a Kind k8s instance that is spun up.test-e2e:        go test ./test/e2e/ -v -ginkgo.v.PHONY: lintlint: golangci-lint ## Run golangci-lint linter        $(GOLANGCI_LINT) run.PHONY: lint-fixlint-fix: golangci-lint ## Run golangci-lint linter and perform fixes        $(GOLANGCI_LINT) run --fix##@ Build.PHONY: buildbuild: manifests generate fmt vet ## Build manager binary.        go build -o bin/manager cmd/main.go.PHONY: runrun: manifests generate fmt vet ## Run a controller from your host.        go run ./cmd/main.go# If you wish to build the manager image targeting other platforms you can use the --platform flag.# (i.e. docker build --platform linux/arm64). However, you must enable docker buildKit for it.# More info: https://docs.docker.com/develop/develop-images/build_enhancements/.PHONY: docker-builddocker-build: ## Build docker image with the manager.        $(CONTAINER_TOOL) build -t $&#123;IMG&#125; ..PHONY: docker-pushdocker-push: ## Push docker image with the manager.        $(CONTAINER_TOOL) push $&#123;IMG&#125;# PLATFORMS defines the target platforms for the manager image be built to provide support to multiple# architectures. (i.e. make docker-buildx IMG=myregistry/mypoperator:0.0.1). To use this option you need to:# - be able to use docker buildx. More info: https://docs.docker.com/build/buildx/# - have enabled BuildKit. More info: https://docs.docker.com/develop/develop-images/build_enhancements/# - be able to push the image to your registry (i.e. if you do not set a valid value via IMG=&lt;myregistry/image:&lt;tag&gt;&gt; then the export will fail)# To adequately provide solutions that are compatible with multiple platforms, you should consider using this option.PLATFORMS ?= linux/arm64,linux/amd64,linux/s390x,linux/ppc64le.PHONY: docker-buildxdocker-buildx: ## Build and push docker image for the manager for cross-platform support        # copy existing Dockerfile and insert --platform=$&#123;BUILDPLATFORM&#125; into Dockerfile.cross, and preserve the original Dockerfile        sed -e &#x27;1 s/\\(^FROM\\)/FROM --platform=\\$$\\&#123;BUILDPLATFORM\\&#125;/; t&#x27; -e &#x27; 1,// s//FROM --platform=\\$$\\&#123;BUILDPLATFORM\\&#125;/&#x27; Dockerfile &gt; Dockerfile.cross        - $(CONTAINER_TOOL) buildx create --name myapp-operator-builder        $(CONTAINER_TOOL) buildx use myapp-operator-builder        - $(CONTAINER_TOOL) buildx build --push --platform=$(PLATFORMS) --tag $&#123;IMG&#125; -f Dockerfile.cross .        - $(CONTAINER_TOOL) buildx rm myapp-operator-builder        rm Dockerfile.cross.PHONY: build-installerbuild-installer: manifests generate kustomize ## Generate a consolidated YAML with CRDs and deployment.        mkdir -p dist        cd config/manager &amp;&amp; $(KUSTOMIZE) edit set image controller=$&#123;IMG&#125;        $(KUSTOMIZE) build config/default &gt; dist/install.yaml##@ Deploymentifndef ignore-not-found  ignore-not-found = falseendif.PHONY: installinstall: manifests kustomize ## Install CRDs into the K8s cluster specified in ~/.kube/config.        $(KUSTOMIZE) build config/crd | $(KUBECTL) apply -f -.PHONY: uninstalluninstall: manifests kustomize ## Uninstall CRDs from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.        $(KUSTOMIZE) build config/crd | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -.PHONY: deploydeploy: manifests kustomize ## Deploy controller to the K8s cluster specified in ~/.kube/config.        cd config/manager &amp;&amp; $(KUSTOMIZE) edit set image controller=$&#123;IMG&#125;        $(KUSTOMIZE) build config/default | $(KUBECTL) apply -f -.PHONY: undeployundeploy: kustomize ## Undeploy controller from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.        $(KUSTOMIZE) build config/default | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -##@ Dependencies## Location to install dependencies toLOCALBIN ?= $(shell pwd)/bin$(LOCALBIN):        mkdir -p $(LOCALBIN)## Tool BinariesKUBECTL ?= kubectlKUSTOMIZE ?= $(LOCALBIN)/kustomizeCONTROLLER_GEN ?= $(LOCALBIN)/controller-genENVTEST ?= $(LOCALBIN)/setup-envtestGOLANGCI_LINT = $(LOCALBIN)/golangci-lint## Tool VersionsKUSTOMIZE_VERSION ?= v5.4.3CONTROLLER_TOOLS_VERSION ?= v0.16.1ENVTEST_VERSION ?= release-0.19GOLANGCI_LINT_VERSION ?= v1.59.1.PHONY: kustomizekustomize: $(KUSTOMIZE) ## Download kustomize locally if necessary.$(KUSTOMIZE): $(LOCALBIN)        $(call go-install-tool,$(KUSTOMIZE),sigs.k8s.io/kustomize/kustomize/v5,$(KUSTOMIZE_VERSION)).PHONY: controller-gencontroller-gen: $(CONTROLLER_GEN) ## Download controller-gen locally if necessary.$(CONTROLLER_GEN): $(LOCALBIN)        $(call go-install-tool,$(CONTROLLER_GEN),sigs.k8s.io/controller-tools/cmd/controller-gen,$(CONTROLLER_TOOLS_VERSION)).PHONY: envtestenvtest: $(ENVTEST) ## Download setup-envtest locally if necessary.$(ENVTEST): $(LOCALBIN)        $(call go-install-tool,$(ENVTEST),sigs.k8s.io/controller-runtime/tools/setup-envtest,$(ENVTEST_VERSION)).PHONY: golangci-lintgolangci-lint: $(GOLANGCI_LINT) ## Download golangci-lint locally if necessary.$(GOLANGCI_LINT): $(LOCALBIN)        $(call go-install-tool,$(GOLANGCI_LINT),github.com/golangci/golangci-lint/cmd/golangci-lint,$(GOLANGCI_LINT_VERSION))# go-install-tool will &#x27;go install&#x27; any package with custom target and name of binary, if it doesn&#x27;t exist# $1 - target path with name of binary# $2 - package url which can be installed# $3 - specific version of packagedefine go-install-tool@[ -f &quot;$(1)-$(3)&quot; ] || &#123; \\set -e; \\package=$(2)@$(3) ;\\echo &quot;Downloading $$&#123;package&#125;&quot; ;\\rm -f $(1) || true ;\\GOBIN=$(LOCALBIN) go install $$&#123;package&#125; ;\\mv $(1) $(1)-$(3) ;\\&#125; ;\\ln -sf $(1)-$(3) $(1)endef\n\n2.2 å˜é‡å®šä¹‰éƒ¨åˆ†2.2.1 IMGï¼ˆå®šä¹‰æ„å»ºå’Œæ¨é€Dockeré•œåƒçš„ç›®æ ‡é•œåƒURLï¼‰# Image URL to use all building/pushing image targetsIMG ?= controller:latest\nä½œç”¨ï¼šå®šä¹‰æ„å»ºå’Œæ¨é€Dockeré•œåƒçš„ç›®æ ‡é•œåƒURLè§£é‡Šï¼šå¦‚æœæ²¡æœ‰åœ¨å‘½ä»¤ä¸­æŒ‡å®šIMGï¼Œåˆ™é»˜è®¤å€¼ä¸ºcontroller:latest\n2.2.2 ENVTEST_K8S_VERSIONï¼ˆå®šä¹‰envtestå·¥å…·ä¸‹è½½çš„Kubernetesèµ„äº§ç‰ˆæœ¬ï¼‰# ENVTEST_K8S_VERSION refers to the version of kubebuilder assets to be downloaded by envtest binary.ENVTEST_K8S_VERSION = 1.31.0\nä½œç”¨ï¼šå®šä¹‰envtestå·¥å…·ä¸‹è½½çš„Kubernetesèµ„äº§ç‰ˆæœ¬è§£é‡Šï¼šenvtestæ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•çš„å·¥å…·ï¼Œè¿™ä¸ªå˜é‡åˆ¶å®šäº†è¦ä¸‹è½½çš„Kubernetesç‰ˆæœ¬ã€‚\n2.2.3 GOBINï¼ˆå½“å‰ä½¿ç”¨çš„Goçš„å®‰è£…è·¯å¾„ï¼‰# Get the currently used golang install path (in GOPATH/bin, unless GOBIN is set)ifeq (,$(shell go env GOBIN))GOBIN=$(shell go env GOPATH)/binelseGOBIN=$(shell go env GOBIN)endif\n\nä½œç”¨ï¼šè·å–å½“å‰ä½¿ç”¨çš„Goçš„å®‰è£…è·¯å¾„è§£é‡Šï¼šå¦‚æœGONBINç¯å¢ƒå˜é‡æœªè®¾ç½®ï¼Œåˆ™ä½¿ç”¨GOPATCH&#x2F;binä½œä¸ºé»˜è®¤è·¯å¾„ï¼›å¦åˆ™ä½¿ç”¨GOBINçš„å€¼ã€‚\n2.2.4 CONTAINER_TOOLï¼ˆç”¨äºæ„å»ºé•œåƒçš„å®¹å™¨å·¥å…·ï¼‰# CONTAINER_TOOL defines the container tool to be used for building images.# Be aware that the target commands are only tested with Docker which is# scaffolded by default. However, you might want to replace it to use other# tools. (i.e. podman)CONTAINER_TOOL ?= docker\n\nä½œç”¨ï¼šå®šä¹‰ç”¨äºæ„å»ºé•œåƒçš„å®¹å™¨å·¥å…·è§£é‡Šï¼šé»˜è®¤å€¼ä¸ºdockerï¼Œä½†æ˜¯å¯ä»¥æ›¿æ¢ä¸ºå…¶ä»–å·¥å…·ï¼Œä¾‹å¦‚podman\n2.2.5 SHELL å’Œ .SHELLFLAGSï¼ˆè®¾ç½®Makefileä½¿ç”¨çš„shellå’Œshellé€‰é¡¹ï¼‰# Setting SHELL to bash allows bash commands to be executed by recipes.# Options are set to exit when a recipe line exits non-zero or a piped command fails.SHELL = /usr/bin/env bash -o pipefail.SHELLFLAGS = -ec\n\nä½œç”¨ï¼šè®¾ç½®Makefileä½¿ç”¨çš„shellå’Œshellé€‰é¡¹è§£é‡Šï¼š\n\nSHELLè®¾ç½®ä¸º&#x2F;usr&#x2F;bin&#x2F;env bash -o pipefail\n.SHELLFLAGS è®¾ç½®ä¸º-ecï¼Œè¡¨ç¤ºshellåº”è¯¥ç«‹å³é€€å‡ºå¹¶åœ¨ä»»ä½•å‘½ä»¤å¤±è´¥æ—¶æŠ¥å‘Šé”™è¯¯\n\n2.3 ç›®æ ‡å®šä¹‰éƒ¨åˆ†2.3.1 é€šç”¨ç›®æ ‡2.3.1.1 allï¼ˆå®šä¹‰é»˜è®¤ç›®æ ‡ï¼Œè°ƒç”¨buildç›®æ ‡ï¼‰.PHONY: allall: build\nä½œç”¨ï¼šå®šä¹‰é»˜è®¤ç›®æ ‡ï¼Œè°ƒç”¨buildç›®æ ‡è§£é‡Šï¼šå½“è¿è¡Œmakeæ—¶ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šç›®æ ‡ã€‚é»˜è®¤ä¼šæ‰§è¡Œbuildç›®æ ‡ã€‚\n2.3.1.2 helpï¼ˆæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼‰.PHONY: helphelp: ## Display this help.        @awk &#x27;BEGIN &#123;FS = &quot;:.*##&quot;; printf &quot;\\nUsage:\\n  make \\033[36m&lt;target&gt;\\033[0m\\n&quot;&#125; /^[a-zA-Z_0-9-]+:.*?##/ &#123; printf &quot;  \\033[36m%-15s\\033[0m %s\\n&quot;, $$1, $$2 &#125; /^##@/ &#123; printf &quot;\\n\\033[1m%s\\033[0m\\n&quot;, substr($$0, 5) &#125; &#x27; $(MAKEFILE_LIST)\nä½œç”¨ï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯è§£é‡Šï¼šä½¿ç”¨awkå‘½ä»¤è§£æMakefile,æå–æ¯ä¸ªç›®æ ‡çš„æè¿°ï¼Œå¹¶æŒ‰ç±»åˆ«ç»„ç»‡æ˜¾ç¤ºã€‚##@è¡¨ç¤ºç±»åˆ«ï¼Œ##è¡¨ç¤ºç›®æ ‡æè¿°\n2.3.2 å¼€å‘ç›®æ ‡2.3.2.1 manifestsï¼ˆç”ŸæˆWebhookConfigurationã€ClusterRoleå’ŒCustomResourceDefinition å¯¹è±¡ï¼‰.PHONY: manifestsmanifests: controller-gen ## Generate WebhookConfiguration, ClusterRole and CustomResourceDefinition objects.        $(CONTROLLER_GEN) rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases\nä½œç”¨ï¼šç”ŸæˆWebhookConfigurationã€ClusterRoleå’ŒCustomResourceDefinition å¯¹è±¡è§£é‡Šï¼šä½¿ç”¨controller-genå·¥å…·ç”Ÿæˆå¿…è¦çš„Kubernetesèµ„æºæ–‡ä»¶ï¼Œå¹¶ä¿å­˜åˆ°config&#x2F;crd&#x2F;basesç›®å½•\n2.3.2.2 generateï¼ˆç”ŸæˆåŒ…å«DeepCopyã€DeepCopyInto, å’ŒDeepCopyObjectæ–¹æ³•å®ç°çš„ä»£ç ã€‚ï¼‰.PHONY: generategenerate: controller-gen ## Generate code containing DeepCopy, DeepCopyInto, and DeepCopyObject method implementations.        $(CONTROLLER_GEN) object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;\nä½œç”¨ï¼šç”ŸæˆåŒ…å«DeepCopyã€DeepCopyInto, å’ŒDeepCopyObjectæ–¹æ³•å®ç°çš„ä»£ç ã€‚è§£é‡Šï¼šä½¿ç”¨controller-genå·¥å…·ç”ŸæˆGOä»£ç ï¼Œè¿™äº›ä»£ç è‡ªåŠ¨ç”Ÿæˆå¯¹è±¡çš„æ·±æ‹·è´æ–¹æ³•ã€‚\n2.3.2.3 fmtï¼ˆæ ¼å¼åŒ–ä»£ç ï¼‰.PHONY: fmtfmt: ## Run go fmt against code.        go fmt ./...\nä½œç”¨ï¼šæ ¼å¼åŒ–ä»£ç è§£é‡Šï¼šä½¿ç”¨go fmtå‘½ä»¤æ ¼å¼åŒ–é¡¹ç›®ä¸­çš„æ‰€æœ‰Goä»£ç \n2.3.2.4 vetï¼ˆæ£€æŸ¥ä»£ç ä¸­çš„æ½œåœ¨é—®é¢˜ï¼‰.PHONY: vetvet: ## Run go vet against code.        go vet ./...\nä½œç”¨ï¼šæ£€æŸ¥ä»£ç ä¸­çš„æ½œåœ¨é—®é¢˜è§£é‡Šï¼šä½¿ç”¨go vetå‘½ä»¤æ£€æŸ¥é¡¹ç›®ä¸­çš„æ‰€æœ‰Goä»£ç ï¼ŒæŸ¥æ‰¾å¯èƒ½çš„é—®é¢˜ã€‚\n2.3.2.5 testï¼ˆè¿è¡Œæµ‹è¯•ï¼‰.PHONY: testtest: manifests generate fmt vet envtest ## Run tests.        KUBEBUILDER_ASSETS=&quot;$(shell $(ENVTEST) use $(ENVTEST_K8S_VERSION) --bin-dir $(LOCALBIN) -p path)&quot; go test $$(go list ./... | grep -v /e2e) -coverprofile cover.out\nä½œç”¨ï¼šè¿è¡Œæµ‹è¯•è§£é‡Šï¼š\n\nå…ˆè¿è¡Œmanifestsã€generateã€fmtå’Œvetç›®æ ‡\nä½¿ç”¨envtestå·¥å…·è®¾ç½®ç¯å¢ƒå˜é‡KUBEBUILDER_ASSETSï¼Œç„¶åè¿è¡Œé¡¹ç›®ä¸­çš„æ‰€æœ‰æµ‹è¯•(æ’é™¤e2eæµ‹è¯•)\n\n2.3.2.6 test-e2eï¼ˆè¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼‰# Utilize Kind or modify the e2e tests to load the image locally, enabling compatibility with other vendors..PHONY: test-e2e  # Run the e2e tests against a Kind k8s instance that is spun up.test-e2e:        go test ./test/e2e/ -v -ginkgo.v\nä½œç”¨ï¼šè¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•è§£é‡Šï¼šä½¿ç”¨go testå‘½ä»¤è¿è¡Œtest&#x2F;e2eç›®å½•ä¸­çš„ç«¯åˆ°ç«¯æµ‹è¯•ï¼Œå¹¶å¯åŠ¨è¯¦ç»†è¾“å‡ºã€‚\n2.3.2.7 lintï¼ˆè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥ï¼‰.PHONY: lintlint: golangci-lint ## Run golangci-lint linter        $(GOLANGCI_LINT) run\nä½œç”¨ï¼šè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥è§£é‡Šï¼šä½¿ç”¨golangci-lintå·¥å…·è¿è¡Œä»£ç é£æ ¼æ£€æŸ¥\n2.3.2.8 lint-fix ï¼ˆè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥å¹¶è‡ªåŠ¨ä¿®å¤é—®é¢˜ï¼‰.PHONY: lint-fixlint-fix: golangci-lint ## Run golangci-lint linter and perform fixes        $(GOLANGCI_LINT) run --fix\nä½œç”¨ï¼šè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥å¹¶è‡ªåŠ¨ä¿®å¤é—®é¢˜è§£é‡Šï¼šä½¿ç”¨golangci-lintå·¥å…·è¿è¡Œä»£ç é£æ ¼æ£€æŸ¥ï¼Œå¹¶ä½¿ç”¨â€“fixé€‰é¡¹è‡ªåŠ¨ä¿®å¤å‘ç°çš„é—®é¢˜ã€‚\n2.3.3 æ„å»ºç›®æ ‡2.3.3.1 buildï¼ˆæ„å»ºcontrollerçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰.PHONY: buildbuild: manifests generate fmt vet ## Build manager binary.        go build -o bin/manager cmd/main.go\nä½œç”¨ï¼šæ„å»ºcontrollerçš„äºŒè¿›åˆ¶æ–‡ä»¶è§£é‡Šï¼š\n\nå…ˆè¿è¡Œmanifestsã€generateã€fmtå’Œvetç›®æ ‡\nä½¿ç”¨go buildå‘½ä»¤ç¼–è¯‘cmd&#x2F;main.goæ–‡ä»¶ï¼Œå¹¶å°†ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¿å­˜åˆ°bin&#x2F;managerã€‚\n\n2.3.3.2 runï¼ˆåœ¨ä¸»æœºä¸Šè¿è¡Œcontrollerï¼‰.PHONY: runrun: manifests generate fmt vet ## Run a controller from your host.        go run ./cmd/main.go\nä½œç”¨ï¼šåœ¨ä¸»æœºä¸Šè¿è¡Œcontrollerè§£é‡Šï¼š\n\nå…ˆè¿è¡Œmanifestsã€generateã€fmtå’Œvetç›®æ ‡\nä½¿ç”¨go runå‘½ä»¤è¿è¡Œcmd&#x2F;main.goæ–‡ä»¶\n\n2.3.3.3 docker-buildï¼ˆæ„å»ºDockeré•œåƒï¼‰# If you wish to build the manager image targeting other platforms you can use the --platform flag.# (i.e. docker build --platform linux/arm64). However, you must enable docker buildKit for it.# More info: https://docs.docker.com/develop/develop-images/build_enhancements/.PHONY: docker-builddocker-build: ## Build docker image with the manager.        $(CONTAINER_TOOL) build -t $&#123;IMG&#125; .\nä½œç”¨ï¼šæ„å»ºDockeré•œåƒè§£é‡Šï¼šä½¿ç”¨CONTAINER_TOOL(é»˜è®¤ä¸ºdocker)æ„å»ºdockeré•œåƒï¼Œå¹¶ä½¿ç”¨IMGå˜é‡æŒ‡å®šé•œåƒåç§°å’Œæ ‡ç­¾\n2.3.3.4 docker-pushï¼ˆæ¨é€Dockeré•œåƒï¼‰.PHONY: docker-pushdocker-push: ## Push docker image with the manager.        $(CONTAINER_TOOL) push $&#123;IMG&#125;\nä½œç”¨ï¼šæ¨é€Dockeré•œåƒè§£é‡Šï¼šä½¿ç”¨CONTAINER_TOOL(é»˜è®¤ä¸ºdocker)æ¨é€æ„å»ºå¥½çš„Dockeré•œåƒåˆ°æŒ‡å®šçš„ä»“åº“\n2.3.3.5 docker-buildxï¼ˆæ„å»ºå¹¶æ¨é€å¤šå¹³å°æ”¯æŒçš„Dockeré•œåƒï¼‰# PLATFORMS defines the target platforms for the manager image be built to provide support to multiple# architectures. (i.e. make docker-buildx IMG=myregistry/mypoperator:0.0.1). To use this option you need to:# - be able to use docker buildx. More info: https://docs.docker.com/build/buildx/# - have enabled BuildKit. More info: https://docs.docker.com/develop/develop-images/build_enhancements/# - be able to push the image to your registry (i.e. if you do not set a valid value via IMG=&lt;myregistry/image:&lt;tag&gt;&gt; then the export will fail)# To adequately provide solutions that are compatible with multiple platforms, you should consider using this option.PLATFORMS ?= linux/arm64,linux/amd64,linux/s390x,linux/ppc64le.PHONY: docker-buildxdocker-buildx: ## Build and push docker image for the manager for cross-platform support        # copy existing Dockerfile and insert --platform=$&#123;BUILDPLATFORM&#125; into Dockerfile.cross, and preserve the original Dockerfile        sed -e &#x27;1 s/\\(^FROM\\)/FROM --platform=\\$$\\&#123;BUILDPLATFORM\\&#125;/; t&#x27; -e &#x27; 1,// s//FROM --platform=\\$$\\&#123;BUILDPLATFORM\\&#125;/&#x27; Dockerfile &gt; Dockerfile.cross        - $(CONTAINER_TOOL) buildx create --name myapp-operator-builder        $(CONTAINER_TOOL) buildx use myapp-operator-builder        - $(CONTAINER_TOOL) buildx build --push --platform=$(PLATFORMS) --tag $&#123;IMG&#125; -f Dockerfile.cross .        - $(CONTAINER_TOOL) buildx rm myapp-operator-builder        rm Dockerfile.cross\n\nä½œç”¨ï¼šæ„å»ºå¹¶æ¨é€å¤šå¹³å°æ”¯æŒçš„Dockeré•œåƒè§£é‡Šï¼š\n\nä½¿ç”¨sedå‘½ä»¤å¤åˆ¶ç°æœ‰çš„Dockerfileå¹¶æ’å…¥â€“platform&#x3D;${BUILDPLATFORM}é€‰é¡¹,ç”ŸæˆDockerfile.cross\nåˆ›å»ºä¸€ä¸ªåä¸ºmyapp-builderçš„æ„å»ºå™¨\nä½¿ç”¨buildxæ„å»ºå¹¶æ¨é€å¤šå¹³å°é•œåƒ\nåˆ é™¤æ„å»ºå™¨å’Œä¸´æ—¶ç”Ÿæˆçš„Dockerfile.cross\n\n2.3.3.6 docker-installerï¼ˆç”ŸæˆåŒ…å«CRDså’Œéƒ¨ç½²çš„åˆå¹¶YAMLæ–‡ä»¶ï¼‰.PHONY: build-installerbuild-installer: manifests generate kustomize ## Generate a consolidated YAML with CRDs and deployment.        mkdir -p dist        cd config/manager &amp;&amp; $(KUSTOMIZE) edit set image controller=$&#123;IMG&#125;        $(KUSTOMIZE) build config/default &gt; dist/install.yaml\nä½œç”¨ï¼šç”ŸæˆåŒ…å«CRDså’Œéƒ¨ç½²çš„åˆå¹¶YAMLæ–‡ä»¶è§£é‡Šï¼š\n\nåˆ›å»ºdistç›®å½•\nä½¿ç”¨kustomizeå·¥å…·è®¾ç½®controlleré•œåƒä¸ºIMG\nä½¿ç”¨kustomizeæ„å»ºconfig&#x2F;defaultç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä¿å­˜åˆ°dist&#x2F;install.yaml\n\n2.3.4 éƒ¨ç½²ç›®æ ‡2.3.4.1 installï¼ˆå®‰è£…CRDsåˆ°Kubernetesé›†ç¾¤ï¼‰.PHONY: installinstall: manifests kustomize ## Install CRDs into the K8s cluster specified in ~/.kube/config.        $(KUSTOMIZE) build config/crd | $(KUBECTL) apply -f -\nä½œç”¨ï¼šå®‰è£…CRDsåˆ°Kubernetesé›†ç¾¤è§£é‡Šï¼š\n\nå…ˆè¿è¡Œmanifestså’Œkustomizeç›®æ ‡\nä½¿ç”¨kustomize æ„å»ºconfig&#x2F;crdç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶åº”ç”¨åˆ°é›†ç¾¤ã€‚\n\n2.3.4.2 uninstallï¼ˆä»Kubernetesé›†ç¾¤å¸è½½CRDsï¼‰.PHONY: uninstalluninstall: manifests kustomize ## Uninstall CRDs from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.        $(KUSTOMIZE) build config/crd | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -\n\nä½œç”¨ï¼šä»Kubernetesé›†ç¾¤å¸è½½CRDsè§£é‡Šï¼š\n\nå…ˆè¿è¡Œmanifestså’Œkustomizeç›®æ ‡\nä½¿ç”¨kustomize æ„å»ºconfig&#x2F;crdç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶ä»é›†ç¾¤ä¸­åˆ é™¤ï¼Œå¯ä»¥é€šè¿‡ignore-not-found&#x3D;trueå¿½ç•¥èµ„æºæœªæ‰¾åˆ°çš„é”™è¯¯\n\n2.3.4.3 deployï¼ˆéƒ¨ç½²controlleråˆ°Kubernetesé›†ç¾¤ï¼‰.PHONY: deploydeploy: manifests kustomize ## Deploy controller to the K8s cluster specified in ~/.kube/config.        cd config/manager &amp;&amp; $(KUSTOMIZE) edit set image controller=$&#123;IMG&#125;        $(KUSTOMIZE) build config/default | $(KUBECTL) apply -f -\nä½œç”¨ï¼šéƒ¨ç½²controlleråˆ°Kubernetesé›†ç¾¤è§£é‡Šï¼š\n\nå…ˆè¿è¡Œmanifestså’Œkustomizeç›®æ ‡\nä½¿ç”¨kustomizeè®¾ç½®controlleré•œåƒä¸ºIMG\nä½¿ç”¨kustomizeæ„å»ºconfig&#x2F;defaultç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶åº”ç”¨åˆ°é›†ç¾¤\n\n2.3.4.4 undeployï¼ˆä»Kubernetesé›†ç¾¤ä¸­å¸è½½Controllerï¼‰.PHONY: undeployundeploy: kustomize ## Undeploy controller from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.        $(KUSTOMIZE) build config/default | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -\nä½œç”¨ï¼šä»Kubernetesé›†ç¾¤ä¸­å¸è½½Controllerè§£é‡Šï¼šä½¿ç”¨kustomize æ„å»ºconfig&#x2F;defaultç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶ä»é›†ç¾¤ä¸­åˆ é™¤ã€‚å¯ä»¥é€šè¿‡ignore-not-found&#x3D;trueå¿½ç•¥èµ„æºæœªæ‰¾åˆ°çš„é”™è¯¯\n2.3.5 ä¾èµ–ç›®æ ‡2.3.5.1 ignore-not-foundï¼ˆå®šä¹‰ignore-not-foundå˜é‡ï¼Œé»˜è®¤å€¼ä¸ºfalseï¼‰ifndef ignore-not-found  ignore-not-found = falseendif\nä½œç”¨ï¼šå®šä¹‰ignore-not-foundå˜é‡ï¼Œé»˜è®¤å€¼ä¸ºfalseè§£é‡Šï¼šå¦‚æœå‘½ä»¤è¡Œä¸­æœªæŒ‡å®šignore-not-foundï¼Œåˆ™é»˜è®¤å€¼ä¸ºfalse\n2.3.5.2 LOCALBINï¼ˆå®šä¹‰æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶çš„å®‰è£…ç›®å½•ï¼‰## Location to install dependencies toLOCALBIN ?= $(shell pwd)/bin$(LOCALBIN):        mkdir -p $(LOCALBIN)\nä½œç”¨ï¼šå®šä¹‰æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶çš„å®‰è£…ç›®å½•ï¼Œé»˜è®¤ä¸ºå½“å‰ç›®å½•ä¸‹çš„binç›®å½•è§£é‡Šï¼šå¦‚æœLOCALBINæœªè®¾ç½®ï¼Œåˆ™é»˜è®¤ä¸º$(shell pwd)&#x2F;binã€‚å¦‚æœLOCALBINç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå®ƒã€‚\n2.3.5.3 å·¥å…·äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå®šä¹‰å„ç§å·¥å…·çš„è·¯å¾„å’Œé»˜è®¤å€¼ï¼‰## Tool BinariesKUBECTL ?= kubectlKUSTOMIZE ?= $(LOCALBIN)/kustomizeCONTROLLER_GEN ?= $(LOCALBIN)/controller-genENVTEST ?= $(LOCALBIN)/setup-envtestGOLANGCI_LINT = $(LOCALBIN)/golangci-lint\nä½œç”¨ï¼šå®šä¹‰å„ç§å·¥å…·çš„è·¯å¾„å’Œé»˜è®¤å€¼è§£é‡Šï¼š\n\nKUBECTLï¼šé»˜è®¤ä¸ºkubectl\nKUSTOMIZEï¼šé»˜è®¤ä¸º$(LOCALBIN)&#x2F;kustomize\nCONTROLLER_GENï¼šé»˜è®¤ä¸º$(LOCALBIN)&#x2F;controller-gen\nENVTESTï¼šé»˜è®¤ä¸º$(LOCALBIN)&#x2F;setup-envtest\nGOLANGCI_LINTï¼š é»˜è®¤ä¸º$(LOCALBIN)&#x2F;golangci-lint\n\n2.3.5.4 å·¥å…·ç‰ˆæœ¬ï¼ˆå®šä¹‰å„ä¸ªå·¥å…·çš„ç‰ˆæœ¬ï¼‰## Tool VersionsKUSTOMIZE_VERSION ?= v5.4.3CONTROLLER_TOOLS_VERSION ?= v0.16.1ENVTEST_VERSION ?= release-0.19GOLANGCI_LINT_VERSION ?= v1.59.1\nä½œç”¨ï¼šå®šä¹‰å„ä¸ªå·¥å…·çš„ç‰ˆæœ¬è§£é‡Šï¼š\n\nKUSTOMIZE_VERSIONï¼šé»˜è®¤ä¸ºv5.4.3\nCONTROLLER_TOOLS_VERSIONï¼šé»˜è®¤ä¸ºv0.16.1\nENVTEST_VERSIONï¼šé»˜è®¤ä¸ºrelease-0.19\nGOLANGCI_LINT_VERSIONï¼šé»˜è®¤ä¸ºv1.59.1\n\n2.3.5.5 kustomizeï¼ˆä¸‹è½½kustomizeå·¥å…·ï¼‰.PHONY: kustomizekustomize: $(KUSTOMIZE) ## Download kustomize locally if necessary.$(KUSTOMIZE): $(LOCALBIN)        $(call go-install-tool,$(KUSTOMIZE),sigs.k8s.io/kustomize/kustomize/v5,$(KUSTOMIZE_VERSION))\nä½œç”¨ï¼šä¸‹è½½kustomizeå·¥å…·(å¦‚æœ‰å¿…è¦)è§£é‡Šï¼šå¦‚æœkustomizeæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ go-install-toolå‡½æ•°ä¸‹è½½kustomizeå·¥å…·\n2.3.5.6 controller-genï¼ˆä¸‹è½½controller-genå·¥å…·ï¼‰.PHONY: controller-gencontroller-gen: $(CONTROLLER_GEN) ## Download controller-gen locally if necessary.$(CONTROLLER_GEN): $(LOCALBIN)        $(call go-install-tool,$(CONTROLLER_GEN),sigs.k8s.io/controller-tools/cmd/controller-gen,$(CONTROLLER_TOOLS_VERSION))\nä½œç”¨ï¼šä¸‹è½½controller-genå·¥å…·(å¦‚æœ‰å¿…è¦)è§£é‡Šï¼šå¦‚æœ$(CONTROLLER_GEN)æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ go-install-toolå‡½æ•°ä¸‹è½½controller-genå·¥å…·\n2.3.5.7 envtestï¼ˆä¸‹è½½setup-envtestå·¥å…·ï¼‰.PHONY: envtestenvtest: $(ENVTEST) ## Download setup-envtest locally if necessary.$(ENVTEST): $(LOCALBIN)        $(call go-install-tool,$(ENVTEST),sigs.k8s.io/controller-runtime/tools/setup-envtest,$(ENVTEST_VERSION))\nä½œç”¨ï¼šä¸‹è½½setup-envtestå·¥å…·(å¦‚æœ‰å¿…è¦)è§£é‡Šï¼šå¦‚æœ$(ENVTEST)æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨go-install-toolå‡½æ•°ä¸‹è½½setup-envteså·¥å…·\n2.3.5.8 golangci-lintï¼ˆä¸‹è½½golangci-lintå·¥å…·ï¼‰.PHONY: golangci-lintgolangci-lint: $(GOLANGCI_LINT) ## Download golangci-lint locally if necessary.$(GOLANGCI_LINT): $(LOCALBIN)        $(call go-install-tool,$(GOLANGCI_LINT),github.com/golangci/golangci-lint/cmd/golangci-lint,$(GOLANGCI_LINT_VERSION))\nä½œç”¨ï¼šä¸‹è½½golangci-lintå·¥å…·(å¦‚æœ‰å¿…è¦)è§£é‡Šï¼šå¦‚æœ$(GOLANGCI_LINT)æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨go-install-toolå‡½æ•°ä¸‹è½½golangci-lintå·¥å…·ã€‚\n2.4 è‡ªå®šä¹‰å‡½æ•°2.4.1 go-install-toolï¼ˆä¸‹è½½å¹¶å®‰è£…æŒ‡å®šçš„GoåŒ…ï¼‰# go-install-tool will &#x27;go install&#x27; any package with custom target and name of binary, if it doesn&#x27;t exist# $1 - target path with name of binary# $2 - package url which can be installed# $3 - specific version of packagedefine go-install-tool@[ -f &quot;$(1)-$(3)&quot; ] || &#123; \\set -e; \\package=$(2)@$(3) ;\\echo &quot;Downloading $$&#123;package&#125;&quot; ;\\rm -f $(1) || true ;\\GOBIN=$(LOCALBIN) go install $$&#123;package&#125; ;\\mv $(1) $(1)-$(3) ;\\&#125; ;\\ln -sf $(1)-$(3) $(1)endef\nä½œç”¨ï¼šä¸‹è½½å¹¶å®‰è£…æŒ‡å®šçš„GoåŒ…è§£é‡Šï¼š\n\n$1ï¼šç›®æ ‡è·¯å¾„å’ŒäºŒè¿›åˆ¶æ–‡ä»¶å\n$2ï¼šåŒ…çš„URL\n$3:åŒ…çš„å…·ä½“ç‰ˆæœ¬\nå¦‚æœç›®æ ‡æ–‡ä»¶$(1)~$(3)ä¸å­˜åœ¨ï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ­¥éª¤\nè®¾ç½®set -eï¼Œç¡®ä¿ä»»ä½•å‘½ä»¤æ‰§è¡Œå¤±è´¥ç«‹å³é€€å‡º\nè®¾ç½®packageå˜é‡ä¸ºåŒ…çš„URLå’Œç‰ˆæœ¬\nè¾“å‡ºä¸‹è½½ä¿¡æ¯\nåˆ é™¤æ—§çš„äºŒè¿›åˆ¶æ–‡ä»¶(å¦‚æœå­˜åœ¨)\nä½¿ç”¨go installå‘½ä»¤å®‰è£…åŒ…ï¼Œå¹¶å°†äºŒè¿›åˆ¶æ–‡ä»¶ä¿å­˜åœ¨LOCALBINç›®å½•\nå°†ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶é‡å‘½ä»¤ä¸º$(1)-$(3)\næœ€ååˆ›å»ºä¸€ä¸ªç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘$(1)-$(3)\n\n","categories":["kubernetes/operator"],"tags":["kubernetes","operator"]},{"title":"operatorå¼€å‘è„šæ‰‹æ¶","url":"/2025/07/kubernetes/operator-kai-fa/operator-kai-fa-jiao-shou-jia/","content":"1ã€è„šæ‰‹æ¶å·¥å…·Operatorçš„å®ç°æ–¹å¼ä¸»è¦åŒ…æ‹¬OperatorSDKå’ŒKubeBuilderï¼Œç›®å‰KubeBuilderåœ¨é˜¿é‡Œä½¿ç”¨çš„æ¯”è¾ƒå¤šã€‚\nKubeBuilder\nOperatorSDK\næˆ‘ä»¬è¿™é‡Œä¸»è¦æ˜¯ç”¨KubeBuilderæ¥è¿›è¡Œï¼Œå…¶ä¸­OperatorSDKå…¶å®ä¹Ÿæ˜¯åº”ç”¨äº†KubeBuilderã€‚\n2ã€åˆ›å»ºOperatorå·¥ç¨‹åˆ›å»ºè„šæ‰‹æ¶å·¥ç¨‹ï¼š\nmkdir myapp-operatorcd myapp-operator/go env -w GO111MODULE=ongo env -w GOPROXY=https://goproxy.cn,directkubebuilder init --domain kubenode.kingtest.com\n\nåˆ›å»ºè„šæ‰‹æ¶ç»“æœï¼š\nkubebuilder init --domain kubenode.kingtest.comINFO Writing kustomize manifests for you to edit... INFO Writing scaffold for you to edit...          INFO Get controller runtime:$ go get sigs.k8s.io/controller-runtime@v0.19.0 go: downloading sigs.k8s.io/controller-runtime v0.19.0go: downloading k8s.io/apimachinery v0.31.0go: downloading k8s.io/api v0.31.0go: downloading k8s.io/client-go v0.31.0go: downloading k8s.io/utils v0.0.0-20240711033017-18e509b52bc8go: downloading github.com/go-logr/logr v1.4.2go: downloading k8s.io/klog/v2 v2.130.1go: downloading golang.org/x/exp v0.0.0-20230515195305-f3d0a9c9a5ccgo: downloading github.com/evanphx/json-patch/v5 v5.9.0go: downloading github.com/prometheus/client_golang v1.19.1go: downloading gomodules.xyz/jsonpatch/v2 v2.4.0go: downloading github.com/gogo/protobuf v1.3.2go: downloading github.com/google/gofuzz v1.2.0go: downloading sigs.k8s.io/structured-merge-diff/v4 v4.4.1go: downloading k8s.io/apiextensions-apiserver v0.31.0go: downloading sigs.k8s.io/json v0.0.0-20221116044647-bc3834ca7abdgo: downloading k8s.io/kube-openapi v0.0.0-20240228011516-70dd3763d340go: downloading github.com/google/uuid v1.6.0go: downloading github.com/prometheus/client_model v0.6.1go: downloading github.com/prometheus/common v0.55.0go: downloading github.com/fsnotify/fsnotify v1.7.0go: downloading golang.org/x/net v0.26.0go: downloading gopkg.in/inf.v0 v0.9.1go: downloading github.com/golang/groupcache v0.0.0-20210331224755-41bb18bfe9dago: downloading github.com/imdario/mergo v0.3.6go: downloading github.com/spf13/pflag v1.0.5go: downloading golang.org/x/term v0.21.0go: downloading github.com/golang/protobuf v1.5.4go: downloading github.com/google/gnostic-models v0.6.8go: downloading golang.org/x/time v0.3.0go: downloading sigs.k8s.io/yaml v1.4.0go: downloading github.com/beorn7/perks v1.0.1go: downloading github.com/cespare/xxhash/v2 v2.3.0go: downloading github.com/prometheus/procfs v0.15.1go: downloading golang.org/x/sys v0.21.0go: downloading google.golang.org/protobuf v1.34.2go: downloading golang.org/x/oauth2 v0.21.0go: downloading github.com/json-iterator/go v1.1.12go: downloading gopkg.in/yaml.v2 v2.4.0go: downloading github.com/fxamacker/cbor/v2 v2.7.0go: downloading github.com/google/go-cmp v0.6.0go: downloading gopkg.in/yaml.v3 v3.0.1go: downloading github.com/davecgh/go-spew v1.1.2-0.20180830191138-d8f796af33ccgo: downloading github.com/munnerz/goautoneg v0.0.0-20191010083416-a7dc8b61c822go: downloading github.com/modern-go/concurrent v0.0.0-20180306012644-bacd9c7ef1ddgo: downloading github.com/modern-go/reflect2 v1.0.2go: downloading github.com/go-openapi/jsonreference v0.20.2go: downloading github.com/go-openapi/swag v0.22.4go: downloading golang.org/x/text v0.16.0go: downloading github.com/go-openapi/jsonpointer v0.19.6go: downloading github.com/emicklei/go-restful/v3 v3.11.0go: downloading github.com/mailru/easyjson v0.7.7go: downloading github.com/josharian/intern v1.0.0go: downloading github.com/x448/float16 v0.8.4go: downloading github.com/pkg/errors v0.9.1INFO Update dependencies:$ go mod tidy           go: downloading github.com/onsi/ginkgo/v2 v2.19.0go: downloading github.com/stretchr/testify v1.9.0go: downloading github.com/onsi/gomega v1.33.1go: downloading github.com/go-logr/zapr v1.3.0go: downloading go.uber.org/zap v1.26.0go: downloading k8s.io/apiserver v0.31.0go: downloading go.uber.org/goleak v1.3.0go: downloading github.com/evanphx/json-patch v0.5.2go: downloading gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6cgo: downloading gopkg.in/evanphx/json-patch.v4 v4.12.0go: downloading github.com/kr/pretty v0.3.1go: downloading go.uber.org/multierr v1.11.0go: downloading github.com/go-task/slim-sprig/v3 v3.0.0go: downloading golang.org/x/tools v0.21.1-0.20240508182429-e35e4ccd0d2dgo: downloading github.com/google/pprof v0.0.0-20240525223248-4bfdf5a9a2afgo: downloading github.com/pmezard/go-difflib v1.0.1-0.20181226105442-5d4384ee4fb2go: downloading github.com/rogpeppe/go-internal v1.12.0go: downloading github.com/kr/text v0.2.0go: downloading k8s.io/component-base v0.31.0go: downloading go.opentelemetry.io/otel v1.28.0go: downloading go.opentelemetry.io/otel/trace v1.28.0go: downloading google.golang.org/grpc v1.65.0go: downloading sigs.k8s.io/apiserver-network-proxy/konnectivity-client v0.30.3go: downloading golang.org/x/sync v0.7.0go: downloading github.com/google/cel-go v0.20.1go: downloading github.com/blang/semver/v4 v4.0.0go: downloading go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp v0.53.0go: downloading go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc v1.27.0go: downloading go.opentelemetry.io/otel/sdk v1.28.0go: downloading google.golang.org/genproto/googleapis/api v0.0.0-20240528184218-531527333157go: downloading github.com/felixge/httpsnoop v1.0.4go: downloading go.opentelemetry.io/otel/metric v1.28.0go: downloading github.com/asaskevich/govalidator v0.0.0-20190424111038-f61b66f89f4ago: downloading github.com/go-logr/stdr v1.2.2go: downloading google.golang.org/genproto/googleapis/rpc v0.0.0-20240701130421-f6361c86f094go: downloading github.com/antlr4-go/antlr/v4 v4.13.0go: downloading google.golang.org/genproto v0.0.0-20230822172742-b8732ec3820dgo: downloading github.com/spf13/cobra v1.8.1go: downloading github.com/stoewer/go-strcase v1.2.0go: downloading github.com/inconshreveable/mousetrap v1.1.0go: downloading go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.28.0go: downloading github.com/cenkalti/backoff/v4 v4.3.0go: downloading go.opentelemetry.io/proto/otlp v1.3.1go: downloading github.com/grpc-ecosystem/grpc-gateway/v2 v2.20.0go: downloading github.com/grpc-ecosystem/grpc-gateway v1.16.0Next: define a resource with:$ kubebuilder create api\n\næœ¬æ­¥éª¤åˆ›å»ºäº† Go module å·¥ç¨‹çš„æ¨¡æ¿æ–‡ä»¶ï¼Œå¼•å…¥äº†å¿…è¦çš„ä¾èµ–ã€‚è¿™é‡Œå…ˆè®¾ç½®äº†goçš„ä»£ç†ï¼Œä¸ç„¶ä¼šæ— æ³•ä¸‹è½½ä¾èµ–ã€‚ç¬¬ä¸€æ¬¡æ–°å»ºå·¥ç¨‹æ—¶ï¼Œä¼šä¸‹è½½ä¸€äº›ä¾èµ–(go: downloading ã€‚ã€‚ã€‚)æŸ¥çœ‹æ­¤æ—¶çš„é¡¹ç›®ç»“æ„:\n.â”œâ”€â”€ cmdâ”‚   â””â”€â”€ main.goâ”œâ”€â”€ configâ”‚   â”œâ”€â”€ defaultâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â”œâ”€â”€ manager_metrics_patch.yamlâ”‚   â”‚   â””â”€â”€ metrics_service.yamlâ”‚   â”œâ”€â”€ managerâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ manager.yamlâ”‚   â”œâ”€â”€ network-policyâ”‚   â”‚   â”œâ”€â”€ allow-metrics-traffic.yamlâ”‚   â”‚   â””â”€â”€ kustomization.yamlâ”‚   â”œâ”€â”€ prometheusâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ monitor.yamlâ”‚   â””â”€â”€ rbacâ”‚       â”œâ”€â”€ kustomization.yamlâ”‚       â”œâ”€â”€ leader_election_role_binding.yamlâ”‚       â”œâ”€â”€ leader_election_role.yamlâ”‚       â”œâ”€â”€ metrics_auth_role_binding.yamlâ”‚       â”œâ”€â”€ metrics_auth_role.yamlâ”‚       â”œâ”€â”€ metrics_reader_role.yamlâ”‚       â”œâ”€â”€ role_binding.yamlâ”‚       â”œâ”€â”€ role.yamlâ”‚       â””â”€â”€ service_account.yamlâ”œâ”€â”€ Dockerfileâ”œâ”€â”€ go.modâ”œâ”€â”€ go.sumâ”œâ”€â”€ hackâ”‚   â””â”€â”€ boilerplate.go.txtâ”œâ”€â”€ Makefileâ”œâ”€â”€ PROJECTâ”œâ”€â”€ README.mdâ””â”€â”€ test    â”œâ”€â”€ e2e    â”‚   â”œâ”€â”€ e2e_suite_test.go    â”‚   â””â”€â”€ e2e_test.go    â””â”€â”€ utils        â””â”€â”€ utils.go12 directories, 29 files\n\nåˆ›å»ºAPIï¼Œç”ŸæˆCRDå’ŒController:\nkubebuilder create api --group apps --version v1 --kind Myapp\n\nå‚æ•°å«ä¹‰ï¼š\n\ngroupå‚æ•°è¡¨ç¤ºç»„çš„æ¦‚å¿µ\nversionå®šä¹‰ç‰ˆæœ¬\nkindå®šä¹‰è‡ªå®šä¹‰èµ„æºç±»å‹\nä»¥ä¸Šå‚æ•°ç»„æˆ è‡ªå®šä¹‰yaml çš„ apiVersionå’Œkind\næ‰§è¡Œkubebuilder create apiæ—¶ç›´æ¥å¸¦ä¸Šâ€“namespaced&#x3D;falseå¯ä»¥å°†è¯¥å¯¹è±¡è®¾è®¡ä¸ºé›†ç¾¤çº§åˆ«ï¼ˆç±»ä¼¼nodeã€pvï¼‰\n\nåˆ›å»ºAPIç»“æœï¼š\nkubebuilder create api --group apps --version v1 --kind MyappINFO Create Resource [y/n]                        yINFO Create Controller [y/n]                      yINFO Writing kustomize manifests for you to edit... INFO Writing scaffold for you to edit...          INFO api/v1/myapp_types.go                        INFO api/v1/groupversion_info.go                  INFO internal/controller/suite_test.go            INFO internal/controller/myapp_controller.go      INFO internal/controller/myapp_controller_test.go INFO Update dependencies:$ go mod tidy           INFO Running make:$ make generate                mkdir -p /home/king/workspace/king-devops/operator/myapp-operator/binDownloading sigs.k8s.io/controller-tools/cmd/controller-gen@v0.16.1go: downloading sigs.k8s.io/controller-tools v0.16.1go: downloading github.com/fatih/color v1.17.0go: downloading golang.org/x/tools v0.24.0go: downloading github.com/gobuffalo/flect v1.0.2go: downloading golang.org/x/net v0.28.0go: downloading github.com/mattn/go-isatty v0.0.20go: downloading github.com/mattn/go-colorable v0.1.13go: downloading golang.org/x/sys v0.23.0go: downloading golang.org/x/sync v0.8.0go: downloading golang.org/x/mod v0.20.0go: downloading golang.org/x/text v0.17.0/home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;Next: implement your new API and generate the manifests (e.g. CRDs,CRs) with:$ make manifests\n\næ­¤æ—¶çš„ç›®å½•ç»“æ„ï¼š\n.â”œâ”€â”€ apiâ”‚   â””â”€â”€ v1â”‚       â”œâ”€â”€ groupversion_info.goâ”‚       â”œâ”€â”€ myapp_types.goâ”‚       â””â”€â”€ zz_generated.deepcopy.goâ”œâ”€â”€ binâ”‚   â”œâ”€â”€ controller-gen -&gt; /home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen-v0.16.1â”‚   â””â”€â”€ controller-gen-v0.16.1â”œâ”€â”€ cmdâ”‚   â””â”€â”€ main.goâ”œâ”€â”€ configâ”‚   â”œâ”€â”€ crdâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ kustomizeconfig.yamlâ”‚   â”œâ”€â”€ defaultâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â”œâ”€â”€ manager_metrics_patch.yamlâ”‚   â”‚   â””â”€â”€ metrics_service.yamlâ”‚   â”œâ”€â”€ managerâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ manager.yamlâ”‚   â”œâ”€â”€ network-policyâ”‚   â”‚   â”œâ”€â”€ allow-metrics-traffic.yamlâ”‚   â”‚   â””â”€â”€ kustomization.yamlâ”‚   â”œâ”€â”€ prometheusâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ monitor.yamlâ”‚   â”œâ”€â”€ rbacâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â”œâ”€â”€ leader_election_role_binding.yamlâ”‚   â”‚   â”œâ”€â”€ leader_election_role.yamlâ”‚   â”‚   â”œâ”€â”€ metrics_auth_role_binding.yamlâ”‚   â”‚   â”œâ”€â”€ metrics_auth_role.yamlâ”‚   â”‚   â”œâ”€â”€ metrics_reader_role.yamlâ”‚   â”‚   â”œâ”€â”€ myapp_editor_role.yamlâ”‚   â”‚   â”œâ”€â”€ myapp_viewer_role.yamlâ”‚   â”‚   â”œâ”€â”€ role_binding.yamlâ”‚   â”‚   â”œâ”€â”€ role.yamlâ”‚   â”‚   â””â”€â”€ service_account.yamlâ”‚   â””â”€â”€ samplesâ”‚       â”œâ”€â”€ apps_v1_myapp.yamlâ”‚       â””â”€â”€ kustomization.yamlâ”œâ”€â”€ Dockerfileâ”œâ”€â”€ go.modâ”œâ”€â”€ go.sumâ”œâ”€â”€ hackâ”‚   â””â”€â”€ boilerplate.go.txtâ”œâ”€â”€ internalâ”‚   â””â”€â”€ controllerâ”‚       â”œâ”€â”€ myapp_controller.goâ”‚       â”œâ”€â”€ myapp_controller_test.goâ”‚       â””â”€â”€ suite_test.goâ”œâ”€â”€ Makefileâ”œâ”€â”€ PROJECTâ”œâ”€â”€ README.mdâ””â”€â”€ test    â”œâ”€â”€ e2e    â”‚   â”œâ”€â”€ e2e_suite_test.go    â”‚   â””â”€â”€ e2e_test.go    â””â”€â”€ utils        â””â”€â”€ utils.go19 directories, 43 files\n\nå¦‚æœéœ€è¦åœ¨Nginx CRUD æ—¶è¿›è¡Œåˆæ³•æ€§æ£€æŸ¥ï¼Œ å¯ä»¥ç”Ÿæˆwebhook:\nkubebuilder create webhook --group apps --version v1 --kind Myapp --conversion --defaulting --programmatic-validation\n\nå‚æ•°å«ä¹‰ï¼š\n\ngroupå‚æ•°è¡¨ç¤ºç»„çš„æ¦‚å¿µ\nversionå®šä¹‰ç‰ˆæœ¬\nkindå®šä¹‰è‡ªå®šä¹‰èµ„æºç±»å‹\nä»¥ä¸Šå‚æ•°ç»„æˆ è‡ªå®šä¹‰yaml çš„ apiVersionå’Œkind\ndefaultingï¼šé»˜è®¤å€¼è®¾ç½®ï¼ˆDefaultingï¼‰ çš„ç›®çš„æ˜¯åœ¨CRDå¯¹è±¡åˆ›å»ºæˆ–æ›´æ–°æ—¶ï¼Œå¦‚æœæŸäº›å­—æ®µæ²¡æœ‰è¢«æ˜¾å¼è®¾ç½®å€¼ï¼Œè‡ªåŠ¨ä¸ºå…¶å¡«å……ä¸€ä¸ªåˆç†çš„é»˜è®¤å€¼ã€‚è¿™å¯¹äºç¡®ä¿èµ„æºå®ä¾‹æœ‰ä¸€å¥—ç»Ÿä¸€çš„ã€é¢„å…ˆå®šä¹‰çš„é…ç½®éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥å‡å°‘ç”¨æˆ·çš„é…ç½®è´Ÿæ‹…ï¼Œå¹¶ä¿è¯èµ„æºçš„ä¸€è‡´æ€§ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ å®šä¹‰äº†ä¸€ä¸ªç›‘æ§åº”ç”¨çš„CRDï¼Œå¯èƒ½å¸Œæœ›é»˜è®¤å¼€å¯æ—¥å¿—è®°å½•åŠŸèƒ½ï¼Œé™¤éç”¨æˆ·æ˜ç¡®å…³é—­å®ƒã€‚\nprogrammatic-validationï¼šç¨‹åºåŒ–éªŒè¯ï¼ˆProgrammatic Validationï¼‰ åˆ™æ˜¯åœ¨CRDå¯¹è±¡åˆ›å»ºæˆ–æ›´æ–°å‰ï¼Œå¯¹æäº¤çš„æ•°æ®è¿›è¡Œé€»è¾‘éªŒè¯çš„æœºåˆ¶ã€‚ä¸CRD schemaæä¾›çš„é™æ€éªŒè¯ç›¸æ¯”ï¼Œç¨‹åºåŒ–éªŒè¯å¯ä»¥å®ç°æ›´åŠ å¤æ‚çš„ä¸šåŠ¡é€»è¾‘éªŒè¯ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥åœ¨webhookæœåŠ¡ä¸­ç¼–å†™ä»£ç æ¥æ£€æŸ¥CRDå®ä¾‹çš„æ•°æ®æ˜¯å¦æ»¡è¶³ç‰¹å®šçš„ä¸šåŠ¡è§„åˆ™æˆ–çº¦æŸæ¡ä»¶ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥éªŒè¯ä¸€ä¸ªèµ„æºè¯·æ±‚çš„å†…å­˜é…é¢æ˜¯å¦è¶…è¿‡äº†é›†ç¾¤çš„æœ€å¤§å…è®¸å€¼ï¼Œæˆ–è€…ç¡®ä¿å¼•ç”¨çš„å…¶ä»–èµ„æºç¡®å®å­˜åœ¨ã€‚\nconversionï¼šè‡ªåŠ¨æ•°æ®è¿ç§»ï¼šconversion webhookå¯ä»¥åœ¨åå°è‡ªåŠ¨å°†CRDçš„ä¸€ä¸ªç‰ˆæœ¬è½¬æ¢ä¸ºå¦ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ— éœ€äººå·¥å¹²é¢„ï¼Œä»è€Œç®€åŒ–äº†ç‰ˆæœ¬å‡çº§è¿‡ç¨‹ã€‚\nå…¼å®¹æ€§ä¿éšœï¼šå³ä½¿APIå‘ç”Ÿå˜åŒ–ï¼Œä¹Ÿèƒ½ç¡®ä¿æ—§å®¢æˆ·ç«¯å’Œæ–°å®¢æˆ·ç«¯éƒ½èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œæé«˜äº†ç³»ç»Ÿçš„å‘åå’Œå‘å‰å…¼å®¹æ€§ã€‚\nå¤æ‚é€»è¾‘å¤„ç†ï¼šå¯¹äºç®€å•çš„å­—æ®µæ·»åŠ æˆ–åˆ é™¤ï¼ŒKubernetesçš„è‡ªåŠ¨è½¬æ¢å™¨å¯èƒ½è¶³å¤Ÿç”¨ã€‚ä½†æ¶‰åŠåˆ°å¤æ‚çš„æ•°æ®ç»“æ„è°ƒæ•´æˆ–é€»è¾‘å˜æ¢æ—¶ï¼Œå°±éœ€è¦è‡ªå®šä¹‰conversion webhookæ¥ç²¾ç¡®æ§åˆ¶è½¬æ¢è¿‡ç¨‹ã€‚\n\n\n\næ‰§è¡Œç»“æœï¼š\nkubebuilder create webhook --group apps --version v1 --kind Myapp --conversion --defaulting --programmatic-validationINFO Writing kustomize manifests for you to edit... INFO Writing scaffold for you to edit...          INFO api/v1/myapp_webhook.go                      INFO api/v1/myapp_webhook_test.go                 INFO Webhook server has been set up for you.You need to implement the conversion.Hub and conversion.Convertible interfaces for your CRD types. INFO api/v1/webhook_suite_test.go                 INFO Update dependencies:$ go mod tidy           INFO Running make:$ make generate                /home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;Next: implement your new Webhook and generate the manifests with:$ make manifests\n\næ­¤æ—¶ç›®å½•ç»“æ„ï¼š\n.â”œâ”€â”€ apiâ”‚   â””â”€â”€ v1â”‚       â”œâ”€â”€ groupversion_info.goâ”‚       â”œâ”€â”€ myapp_types.goâ”‚       â”œâ”€â”€ myapp_webhook.goâ”‚       â”œâ”€â”€ myapp_webhook_test.goâ”‚       â”œâ”€â”€ webhook_suite_test.goâ”‚       â””â”€â”€ zz_generated.deepcopy.goâ”œâ”€â”€ binâ”‚   â”œâ”€â”€ controller-gen -&gt; /home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen-v0.16.1â”‚   â””â”€â”€ controller-gen-v0.16.1â”œâ”€â”€ cmdâ”‚   â””â”€â”€ main.goâ”œâ”€â”€ configâ”‚   â”œâ”€â”€ certmanagerâ”‚   â”‚   â”œâ”€â”€ certificate.yamlâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ kustomizeconfig.yamlâ”‚   â”œâ”€â”€ crdâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â”œâ”€â”€ kustomizeconfig.yamlâ”‚   â”‚   â””â”€â”€ patchesâ”‚   â”‚       â”œâ”€â”€ cainjection_in_myapps.yamlâ”‚   â”‚       â””â”€â”€ webhook_in_myapps.yamlâ”‚   â”œâ”€â”€ defaultâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â”œâ”€â”€ manager_metrics_patch.yamlâ”‚   â”‚   â”œâ”€â”€ manager_webhook_patch.yamlâ”‚   â”‚   â”œâ”€â”€ metrics_service.yamlâ”‚   â”‚   â””â”€â”€ webhookcainjection_patch.yamlâ”‚   â”œâ”€â”€ managerâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ manager.yamlâ”‚   â”œâ”€â”€ network-policyâ”‚   â”‚   â”œâ”€â”€ allow-metrics-traffic.yamlâ”‚   â”‚   â”œâ”€â”€ allow-webhook-traffic.yamlâ”‚   â”‚   â””â”€â”€ kustomization.yamlâ”‚   â”œâ”€â”€ prometheusâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ monitor.yamlâ”‚   â”œâ”€â”€ rbacâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â”œâ”€â”€ leader_election_role_binding.yamlâ”‚   â”‚   â”œâ”€â”€ leader_election_role.yamlâ”‚   â”‚   â”œâ”€â”€ metrics_auth_role_binding.yamlâ”‚   â”‚   â”œâ”€â”€ metrics_auth_role.yamlâ”‚   â”‚   â”œâ”€â”€ metrics_reader_role.yamlâ”‚   â”‚   â”œâ”€â”€ myapp_editor_role.yamlâ”‚   â”‚   â”œâ”€â”€ myapp_viewer_role.yamlâ”‚   â”‚   â”œâ”€â”€ role_binding.yamlâ”‚   â”‚   â”œâ”€â”€ role.yamlâ”‚   â”‚   â””â”€â”€ service_account.yamlâ”‚   â”œâ”€â”€ samplesâ”‚   â”‚   â”œâ”€â”€ apps_v1_myapp.yamlâ”‚   â”‚   â””â”€â”€ kustomization.yamlâ”‚   â””â”€â”€ webhookâ”‚       â”œâ”€â”€ kustomization.yamlâ”‚       â”œâ”€â”€ kustomizeconfig.yamlâ”‚       â””â”€â”€ service.yamlâ”œâ”€â”€ Dockerfileâ”œâ”€â”€ go.modâ”œâ”€â”€ go.sumâ”œâ”€â”€ hackâ”‚   â””â”€â”€ boilerplate.go.txtâ”œâ”€â”€ internalâ”‚   â””â”€â”€ controllerâ”‚       â”œâ”€â”€ myapp_controller.goâ”‚       â”œâ”€â”€ myapp_controller_test.goâ”‚       â””â”€â”€ suite_test.goâ”œâ”€â”€ Makefileâ”œâ”€â”€ PROJECTâ”œâ”€â”€ README.mdâ””â”€â”€ test    â”œâ”€â”€ e2e    â”‚   â”œâ”€â”€ e2e_suite_test.go    â”‚   â””â”€â”€ e2e_test.go    â””â”€â”€ utils        â””â”€â”€ utils.go22 directories, 57 files\n\næœ€ç»ˆçš„å·¥ç¨‹ç»“æ„ï¼š\n.â”œâ”€â”€ apiâ”‚   â””â”€â”€ v1â”‚       â”œâ”€â”€ groupversion_info.goâ”‚       â”œâ”€â”€ myapp_types.goâ”‚       â”œâ”€â”€ myapp_webhook.goâ”‚       â”œâ”€â”€ myapp_webhook_test.goâ”‚       â”œâ”€â”€ webhook_suite_test.goâ”‚       â””â”€â”€ zz_generated.deepcopy.goâ”œâ”€â”€ binâ”‚   â”œâ”€â”€ controller-gen -&gt; /home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen-v0.16.1â”‚   â””â”€â”€ controller-gen-v0.16.1â”œâ”€â”€ cmdâ”‚   â””â”€â”€ main.goâ”œâ”€â”€ configâ”‚   â”œâ”€â”€ certmanagerâ”‚   â”‚   â”œâ”€â”€ certificate.yamlâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ kustomizeconfig.yamlâ”‚   â”œâ”€â”€ crdâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â”œâ”€â”€ kustomizeconfig.yamlâ”‚   â”‚   â””â”€â”€ patchesâ”‚   â”‚       â”œâ”€â”€ cainjection_in_myapps.yamlâ”‚   â”‚       â””â”€â”€ webhook_in_myapps.yamlâ”‚   â”œâ”€â”€ defaultâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â”œâ”€â”€ manager_metrics_patch.yamlâ”‚   â”‚   â”œâ”€â”€ manager_webhook_patch.yamlâ”‚   â”‚   â”œâ”€â”€ metrics_service.yamlâ”‚   â”‚   â””â”€â”€ webhookcainjection_patch.yamlâ”‚   â”œâ”€â”€ managerâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ manager.yamlâ”‚   â”œâ”€â”€ network-policyâ”‚   â”‚   â”œâ”€â”€ allow-metrics-traffic.yamlâ”‚   â”‚   â”œâ”€â”€ allow-webhook-traffic.yamlâ”‚   â”‚   â””â”€â”€ kustomization.yamlâ”‚   â”œâ”€â”€ prometheusâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ monitor.yamlâ”‚   â”œâ”€â”€ rbacâ”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â”œâ”€â”€ leader_election_role_binding.yamlâ”‚   â”‚   â”œâ”€â”€ leader_election_role.yamlâ”‚   â”‚   â”œâ”€â”€ metrics_auth_role_binding.yamlâ”‚   â”‚   â”œâ”€â”€ metrics_auth_role.yamlâ”‚   â”‚   â”œâ”€â”€ metrics_reader_role.yamlâ”‚   â”‚   â”œâ”€â”€ myapp_editor_role.yamlâ”‚   â”‚   â”œâ”€â”€ myapp_viewer_role.yamlâ”‚   â”‚   â”œâ”€â”€ role_binding.yamlâ”‚   â”‚   â”œâ”€â”€ role.yamlâ”‚   â”‚   â””â”€â”€ service_account.yamlâ”‚   â”œâ”€â”€ samplesâ”‚   â”‚   â”œâ”€â”€ apps_v1_myapp.yamlâ”‚   â”‚   â””â”€â”€ kustomization.yamlâ”‚   â””â”€â”€ webhookâ”‚       â”œâ”€â”€ kustomization.yamlâ”‚       â”œâ”€â”€ kustomizeconfig.yamlâ”‚       â””â”€â”€ service.yamlâ”œâ”€â”€ Dockerfileâ”œâ”€â”€ go.modâ”œâ”€â”€ go.sumâ”œâ”€â”€ hackâ”‚   â””â”€â”€ boilerplate.go.txtâ”œâ”€â”€ internalâ”‚   â””â”€â”€ controllerâ”‚       â”œâ”€â”€ myapp_controller.goâ”‚       â”œâ”€â”€ myapp_controller_test.goâ”‚       â””â”€â”€ suite_test.goâ”œâ”€â”€ Makefileâ”œâ”€â”€ PROJECTâ”œâ”€â”€ README.mdâ””â”€â”€ test    â”œâ”€â”€ e2e    â”‚   â”œâ”€â”€ e2e_suite_test.go    â”‚   â””â”€â”€ e2e_test.go    â””â”€â”€ utils        â””â”€â”€ utils.go22 directories, 57 files\n\nå…³é”®ç›®å½•åŠå…¶å†…å®¹çš„æ¦‚è¿°ï¼š\n\nDockerfile: å®šä¹‰äº†ç”¨äºæ„å»ºOperatorå®¹å™¨é•œåƒçš„Dockeré…ç½®æ–‡ä»¶ã€‚\nMakefile: åŒ…å«äº†ä¸€ç³»åˆ—é¢„å®šä¹‰çš„Makeä»»åŠ¡ï¼Œç”¨äºæ„å»ºã€æµ‹è¯•ã€è¿è¡Œå’Œéƒ¨ç½²Operatorã€‚\nPROJECT: å­˜å‚¨é¡¹ç›®å…ƒæ•°æ®çš„æ–‡ä»¶ï¼ŒKubebuilderä½¿ç”¨å®ƒæ¥è·Ÿè¸ªé¡¹ç›®çš„çŠ¶æ€å’Œé…ç½®ã€‚\nREADME.md: é¡¹ç›®çš„ä¸»è¦è¯´æ˜æ–‡æ¡£ï¼Œé€šå¸¸åŒ…å«é¡¹ç›®ç®€ä»‹ã€å®‰è£…æŒ‡å—ã€å¼€å‘æµç¨‹ç­‰ä¿¡æ¯ã€‚\napi&#x2F;v1: å®šä¹‰äº†è‡ªå®šä¹‰èµ„æºå®šä¹‰(CRD)çš„ç›®å½•ï¼Œå…¶ä¸­åŒ…å«äº†èµ„æºçš„Goç±»å‹å®šä¹‰åŠDeepCopyç”Ÿæˆæ–‡ä»¶ã€‚\nmyapp_types.go: èµ„æºç±»å‹çš„å®šä¹‰(myapp_types.go)\nmyapp_webhook.go: webhooké€»è¾‘\nzz_generated.deepcopy.go: æ·±æ‹·è´ç”Ÿæˆä»£ç \ngroupversion_info.go: å®šä¹‰äº†APIç»„å’Œç‰ˆæœ¬ä¿¡æ¯ã€‚\n\n\nbin: å­˜æ”¾é¡¹ç›®ä¾èµ–çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¦‚controller-genï¼Œç”¨äºCRDä»£ç ç”Ÿæˆã€‚\ncmd&#x2F;main.go: Operatorçš„å…¥å£ç‚¹ï¼Œè´Ÿè´£åˆå§‹åŒ–å’Œè¿è¡Œæ§åˆ¶å™¨ã€‚\nconfig: é…ç½®ç›®å½•ï¼ŒåŒ…å«ç”¨äºKubernetesèµ„æºéƒ¨ç½²çš„å„ç§Kustomizeé…ç½®ã€‚\ncrd&#x2F;: ç”¨äºCRDèµ„æºçš„Kustomizeé…ç½®ã€‚\ndefault&#x2F;: åº”ç”¨é»˜è®¤çš„RBACã€æœåŠ¡ç­‰é…ç½®ã€‚\nmanager&#x2F;: Operator Managerçš„éƒ¨ç½²é…ç½®ã€‚\nnetwork-policy&#x2F;, prometheus&#x2F;, rbac&#x2F;, samples&#x2F;: åˆ†åˆ«åŒ…å«ç½‘ç»œç­–ç•¥ã€Prometheusç›‘æ§é…ç½®ã€RBACè§„åˆ™å’Œç¤ºä¾‹èµ„æºçš„é…ç½®ã€‚\n\n\ngo.mod, go.sum: Goæ¨¡å—ç®¡ç†æ–‡ä»¶ï¼Œè®°å½•é¡¹ç›®ä¾èµ–ã€‚\nhack&#x2F;boilerplate.go.txt: ç”¨äºä»£ç ç”Ÿæˆçš„æ¨¡æ¿æ–‡ä»¶ï¼Œä¿æŒç‰ˆæƒå¤´éƒ¨ä¸€è‡´æ€§ã€‚\ninternal&#x2F;controller: Operatoræ§åˆ¶å™¨çš„æ ¸å¿ƒé€»è¾‘æ‰€åœ¨ï¼ŒåŒ…å«ç›‘æ§èµ„æº(Myapp)çš„æ§åˆ¶å™¨å®ç°ã€‚\ntest: æµ‹è¯•ç›¸å…³ç›®å½•ã€‚\ne2e&#x2F;: ç«¯åˆ°ç«¯æµ‹è¯•ä»£ç ï¼ŒéªŒè¯æ•´ä¸ªOperatoråœ¨Kubernetesé›†ç¾¤ä¸Šçš„è¡Œä¸ºã€‚\nutils&#x2F;: æµ‹è¯•è¾…åŠ©å·¥å…·å’Œå‡½æ•°ã€‚\n\n\n\n3ã€ç¼–å†™ä»£ç ä¸‹é¢ä¸»è¦ä»¥Deploymentä¸ºä¾‹ï¼Œæ ¸å¿ƒé€»è¾‘æ˜¯æŠŠè‡ªå®šä¹‰CRï¼ˆMyappï¼‰å½“åšç»ˆæ€ï¼ŒæŠŠDeploymentå½“åšè¿è¡Œæ€ï¼Œé€šè¿‡æ¯”å¯¹å±æ€§çš„ä¸ä¸€è‡´ï¼Œç¼–å†™ç›¸å…³çš„Reconcileé€»è¾‘ã€‚\nä¸€å¼ å›¾è§£é‡Šå„ç§èµ„æºå’Œ Controller çš„å…³ç³»ï¼š\n3.1 å®šä¹‰ CRDåœ¨api&#x2F;v1&#x2F;myapp_type.goä¸­å®šä¹‰ Spec å’Œ Status\n// MyappSpec defines the desired state of Myapptype MyappSpec struct &#123;        // INSERT ADDITIONAL SPEC FIELDS - desired state of cluster        // Important: Run &quot;make&quot; to regenerate code after modifying this file        // Foo is an example field of Myapp. Edit myapp_types.go to remove/update        Foo                   string `json:&quot;foo,omitempty&quot;`        appsv1.DeploymentSpec `json:&quot;,inline&quot;`&#125;// MyappStatus defines the observed state of Myapptype MyappStatus struct &#123;        // INSERT ADDITIONAL STATUS FIELD - define observed state of cluster        // Important: Run &quot;make&quot; to regenerate code after modifying this file        appsv1.DeploymentSpec `json:&quot;,inline&quot;`&#125;// +kubebuilder:object:root=true// +kubebuilder:subresource:status// Myapp is the Schema for the myapps APItype Myapp struct &#123;        metav1.TypeMeta   `json:&quot;,inline&quot;`        metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`        Spec   MyappSpec   `json:&quot;spec,omitempty&quot;`        Status MyappStatus `json:&quot;status,omitempty&quot;`&#125;\n\næ³¨æ„+kubebuilderå¹¶éæ™®é€šæ³¨é‡Šï¼Œä¸èƒ½éšæ„åˆ é™¤ã€‚\n3.2 ç¼–å†™Reconcileé€»è¾‘åœ¨internal&#x2F;controller&#x2F;myapp_controller.goä¸­å®ç° Reconcile é€»è¾‘\nfunc (r *MyappReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) &#123;        logger := log.FromContext(ctx)        // TODO(user): your logic here        logger.Info(&quot;start Reconcile&quot; + req.Name)        return ctrl.Result&#123;&#125;, nil&#125;\n3.3 ä¿®æ”¹Webhookåœ¨api&#x2F;v1&#x2F;myapp_webhook.goä¸­æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹\nfunc (r *Myapp) ValidateCreate() error func (r *Myapp) ValidateUpdate(old runtime.Object) errorfunc (r *Myapp) Default()\n\n3.4 ä¿®æ”¹mainå…¥å£ä»¥å‰çš„è€ç‰ˆæœ¬kubebuilderç”Ÿæˆçš„é¡¹ç›®ï¼Œéœ€è¦åœ¨cmd&#x2F;main.goæ·»åŠ ç›‘å¬çš„namespaceä½†æ˜¯æ–°ç‰ˆæœ¬æ²¡æœ‰è¿™ä¸ªä¿¡æ¯ï¼Œä»¥ä¸‹æ˜¯ç¤ºä¾‹ï¼š\nmgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options&#123;                Scheme:                 scheme,                Metrics:                metricsServerOptions,                WebhookServer:          webhookServer,                HealthProbeBindAddress: probeAddr,                LeaderElection:         enableLeaderElection,                LeaderElectionID:       &quot;6a511ed4.kubenode.kingtest.com&quot;,                // LeaderElectionReleaseOnCancel defines if the leader should step down voluntarily                // when the Manager ends. This requires the binary to immediately end when the                // Manager is stopped, otherwise, this setting is unsafe. Setting this significantly                // speeds up voluntary leader transitions as the new leader don&#x27;t have to wait                // LeaseDuration time first.                //                // In the default scaffold provided, the program ends immediately after                // the manager stops, so would be fine to enable this option. However,                // if you are doing or is intended to do any operation such as perform cleanups                // after the manager stops then its usage might be unsafe.                // LeaderElectionReleaseOnCancel: true,\n\nå¦‚æœæƒ³ç›‘å¬å›ºå®šçš„namespaceä¿¡æ¯ï¼Œå¯ä»¥åœ¨Reconcileå†…å®ç°ã€‚\n","categories":["kubernetes/operator"],"tags":["kubernetes","operator"]},{"title":"operatorç®€ä»‹","url":"/2025/07/kubernetes/operator-kai-fa/operator-jian-jie/","content":"1 kubernetesèƒŒæ™¯1.1 Controlleræ¨¡å¼controlleré€šè¿‡æ ¹æ®è¢«æ§åˆ¶å¯¹è±¡çš„å±æ€§å’Œå­—æ®µæ¥å®ç°ç¼–æ’ï¼Œå¯¹äºæ¯ä¸€ä¸ªbuild-inçš„èµ„æºç±»å‹ï¼Œéƒ½æœ‰å¯¹åº”çš„controllerã€‚\næ¯”å¦‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„Deploymentçš„yamlç¤ºä¾‹ï¼š\nå…¶å¯¹åº”çš„Deployment Controllerç¼–æ’åŠ¨ä½œæ˜¯ç¡®ä¿app&#x3D;testçš„Podæ•°é‡ä¸º2ï¼ŒPodçš„å±æ€§å’Œå­—æ®µç”±spec.templateå®šä¹‰\napiVersion: apps/v1kind: Deploymentmetadata:  name: testspec:  selector:    matchLabels:      app: test  replicas: 2  template:    metadata:      labels:        app: test    spec:      containers:      - name: nginx        image: nginx:1.7.9        ports:        - containerPort: 80\n\næ‰€æœ‰æ§åˆ¶å™¨çš„ä¸»è¦æ“ä½œéƒ½æ˜¯ä¸€ä¸ªè°ƒè°å¾ªç¯ï¼ˆReconcile loopï¼‰ã€‚ä¸»è¦æœ‰ä¸‰æ­¥ï¼š\n\nè§‚å¯ŸæœŸæœ›çš„çŠ¶æ€ã€‚\nè§‚å¯Ÿæ‰€ç®¡ç†èµ„æºçš„å½“å‰çŠ¶æ€ã€‚\né‡‡å–è¡ŒåŠ¨ï¼Œä½¿æ‰˜ç®¡çš„èµ„æºå¤„åœ¨æœŸæœ›çš„çŠ¶æ€ã€‚for &#123;    actualState := GetResourceActualState(rsvc)    expectState := GetResourceExpectState(rsvc)    if actualState == expectState &#123;        // do nothing    &#125; else &#123;        Reconcile(rsvc)    &#125;&#125;\n\n1.2 å£°æ˜å¼APIå£°æ˜å¼APIï¼šå‘Šè¯‰K8Sä½ è¦ä»€ä¹ˆï¼Œè€Œä¸æ˜¯å‘Šè¯‰å®ƒä½ æ€ä¹ˆåšã€‚\nå£°æ˜å¼APIçš„æ“ä½œä½“ç°åœ¨kubectl applyå‘½ä»¤ä¸Šï¼Œåœ¨å¯¹è±¡åˆ›å»ºå’Œåç»­ä¿®æ”¹æ›´æ–°éƒ½ä½¿ç”¨applyå‘½ä»¤ï¼Œå‘Šè¯‰k8så¯¹è±¡çš„ç»ˆæ€å³å¯ï¼Œåº•å±‚çš„å®ç°æ˜¯ä¸€ä¸ªå¯¹åŸæœ‰APIå¯¹è±¡çš„PATCHæ“ä½œå®ç°çš„ï¼Œå¯ä»¥ä¸€æ¬¡æ€§å¤„ç†å¤šä¸ªå†™æ“ä½œï¼Œç›¸å¯¹äºå‘½ä»¤æ—¶ä¸€ä¸ªä¸ªçš„å‘½ä»¤å¤§å¤§æé«˜äº†æ“ä½œæ•ˆç‡ã€‚\næ¯”å¦‚ä¸Šé¢çš„deployment.yamlæ–‡ä»¶ï¼Œåœ¨æäº¤åä¼šé€šè¿‡Group&#x2F;Version&#x2F;Resourceçš„åˆ†çº§æ¥æ‰¾åˆ°deploymentåœ¨GOè¯­è¨€ä¸­çš„ç»“æ„ä½“å®šä¹‰ï¼Œä»è€Œå°†YAMLæè¿°è½¬æ¢æˆä¸€ä¸ªåºåˆ—åŒ–çš„deploymentå¯¹è±¡ï¼Œå¹¶é€šè¿‡etcdçš„APIå°†å…¶ä¿å­˜èµ·æ¥ã€‚\n1.3 â€œåŸç”Ÿçš„èµ„æº-Controllerâ€çš„é—®é¢˜\nåŸç”Ÿèµ„æºä¸å¤Ÿç”¨\nK8Så†…éƒ¨çš„åŸºç¡€èµ„æºï¼Œå¦‚Podã€Statefulsetã€Serviceï¼Œèƒ½å¤Ÿè¦†ç›–å¤§éƒ¨åˆ†åº”ç”¨çš„å·¥ä½œæ¨¡å¼ã€‚\nä½†å¯¹ä»¥ä¸‹æƒ…å†µä¸å‹å¥½ï¼š\næœ‰äº›åº”ç”¨ç»„ä»¶æ— æ³•æ‰¾åˆ°åˆé€‚çš„åŸºç¡€èµ„æºä½œä¸ºæ¨¡æ¿ï¼Œæ¯”å¦‚GPUèµ„æºã€è®­ç»ƒæ•°æ®é›†ã€è®­ç»ƒä»»åŠ¡ç­‰ï¼›\næœ‰äº›åº”ç”¨ç»„ä»¶éœ€è¦å¤šä¸ªåŸºç¡€èµ„æºå…±åŒè¾“å‡ºä¸€é¡¹èƒ½åŠ›ï¼Œä¼šå˜å¾—å¾ˆå¤æ‚ï¼›\n\n\n\n\nç»†ç²’åº¦æ“ä½œç¹ç\néœ€è¦å¯¹äº‘åŸç”ŸK8Sçš„ç»†ç²’åº¦èµ„æºçš„ç§ç±»æ¯”è¾ƒç†Ÿæ‚‰ï¼›\nåº”ç”¨åœ¨æä¾›æœåŠ¡æ—¶ï¼Œå­˜åœ¨é€šè¿‡Labelç­‰æ ‡ç­¾ä¿¡æ¯å¯¹åº”çš„é€»è¾‘ã€‚\n\n\nç¼ºä¹å®šåˆ¶åŒ–èƒ½åŠ›ï¼Œå¦‚ï¼š\nä¸€äº›ç®€å•çš„ä¸­é—´ä»¶é›†æˆ\nå¯¹ä¸åŒèµ„æºçš„æ“ä½œæ—¶åºçš„æµæ°´çº¿ç®¡ç†ã€‚\n\n\n\n1.4 æ‹“å±•è‡ªå®šä¹‰èµ„æºä¸æ§åˆ¶å™¨ä¸»è¦åšä¸¤ä»¶äº‹ï¼š\n\nç¼–å†™è‡ªå®šä¹‰èµ„æºï¼Œå¹¶å°†å…¶éƒ¨ç½²åˆ°K8Sé›†ç¾¤ä¸­: é€šè¿‡ç¼–å†™ç¬¦åˆK8Sèµ„æºå’Œç»“æ„å±æ€§çš„æ–‡ä»¶ï¼Œä½¿å¾—K8Sèƒ½å¤Ÿæ ¡éªŒè¯¥èµ„æºå¹¶è¿›è¡ŒæŒä¹…åŒ–ã€‚\nç¼–å†™å…¶å¯¹åº”çš„æ§åˆ¶å™¨ï¼Œå¹¶å°†å…¶éƒ¨ç½²åˆ°K8Sé›†ç¾¤ä¸­: é€šè¿‡å®ç°è°ƒè°é€»è¾‘ï¼Œæ¥å®Œæˆèµ„æºç¼–æ’çš„å®é™…éœ€æ±‚ã€‚\n\n2ã€Operator ä»‹ç»2.1 Operatorå€ŸåŠ© Kubernetes çš„æ§åˆ¶å™¨æ¨¡å¼ï¼Œç¼–å†™è‡ªå®šä¹‰çš„ç¼–æ’è§„åˆ™ï¼Œå®Œæˆå¯¹è‡ªå®šä¹‰èµ„æºçš„æ“ä½œï¼Œæ¯”å¦‚å¢åˆ æ”¹æŸ¥ç­‰ã€‚\nä¸€èˆ¬æ¥è¯´ï¼ŒOperator&#x3D;CRD(è‡ªå®šä¹‰èµ„æº)+Controller(è‡ªå®šä¹‰æ§åˆ¶å™¨)+Webhook(Admissionæ ¹æ®å®é™…æƒ…å†µé€‰æ‹©æ˜¯å¦æ·»åŠ )\n2.2 è‡ªå®šä¹‰èµ„æº CRDCRDï¼ˆCustom Resource Definitionï¼‰æ˜¯ç”¨æˆ·çš„è‡ªå®šä¹‰èµ„æºç±»å‹ï¼Œå¯ä»¥åŸºäºKubernetesçš„API Serverè¿›è¡Œç®¡ç†ã€‚å…¶å®ä¾‹ä¸ºCRï¼ˆCustom Resourceï¼‰ã€‚\napiVersion: apiextensions.k8s.io/v1kind: CustomResourceDefinitionmetadata:  name: test ## CRDåç§°spec:  conversion:    strategy: None  group: tq   # REST API: /apis/&lt;group&gt;/&lt;version&gt;  names:    kind: App    listKind: AppList    plural: apps    singular: app  scope: Namespaced  # èµ„æºæ˜¯å¦åŒºåˆ†namespace  versions: [] # èµ„æºçš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šv1beta1ã€v1ç­‰\n\n2.3 è‡ªå®šä¹‰æ§åˆ¶å™¨ ControllerKubernetesæ§åˆ¶å™¨ä¼šç›‘è§†èµ„æºçš„åˆ›å»º&#x2F;æ›´æ–°&#x2F;åˆ é™¤äº‹ä»¶ï¼Œå¹¶è§¦å‘ Reconcile å‡½æ•°ä½œä¸ºå“åº”ã€‚Reconcile æ˜¯ä¸€ä¸ªä½¿ç”¨ objectï¼ˆResource çš„å®ä¾‹ï¼‰çš„å‘½åç©ºé—´å’Œå®ä¾‹åæ¥è°ƒç”¨çš„å‡½æ•°ï¼Œä½¿objectçš„å®é™…çŠ¶æ€ä¸objectçš„Specä¸­å®šä¹‰çš„çŠ¶æ€ä¿æŒä¸€è‡´ã€‚ è°ƒç”¨å®Œæˆåï¼ŒReconcile ä¼šå°†objectçš„çŠ¶æ€æ›´æ–°ä¸ºå½“å‰å®é™…çŠ¶æ€ã€‚\nåœ¨å®é™…ç¯å¢ƒä¸­ï¼ŒControllerä¼šè¢«æ‰“åŒ…æˆé•œåƒï¼Œä»¥Deploymentæ‹‰èµ·çš„Podçš„å½¢å¼åº”ç”¨åœ¨é›†ç¾¤ä¸­ï¼Œå¹¶ç”¨serviceä¸­çš„ClusterIPæ–¹å¼è¿›è¡ŒæœåŠ¡æš´éœ²å‘ç°ã€‚\n2.4 åè¯è§£é‡Š\nCRDï¼ˆCustom Resource Definitionï¼‰: CRDå…è®¸ç”¨æˆ·åœ¨Kubernetes APIä¸­å®šä¹‰æ–°çš„èµ„æºç±»å‹ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥åˆ›å»ºç¬¦åˆè‡ªå·±åº”ç”¨æˆ–æœåŠ¡ç‰¹æ€§çš„èµ„æºï¼Œè¿™äº›èµ„æºèƒ½å¤Ÿè¢«Kubernetesä»¥ç±»ä¼¼äºå†…ç½®èµ„æºï¼ˆå¦‚Podsã€Servicesï¼‰çš„æ–¹å¼æ¥ç®¡ç†å’Œæ“ä½œã€‚CRDå®è´¨ä¸Šæ˜¯æ‰©å±•äº†Kubernetes APIçš„åŠŸèƒ½ï¼Œå…è®¸ä½ å®šä¹‰èµ„æºçš„åç§°ã€å­—æ®µç»“æ„ã€éªŒè¯è§„åˆ™ç­‰å…ƒæ•°æ®ã€‚é€šè¿‡YAMLæˆ–JSONæ–‡ä»¶å®šä¹‰CRDåï¼ŒKubernetesä¼šå°†å…¶æ³¨å†Œåˆ°APIæœåŠ¡å™¨ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥é€šè¿‡Kubernetes APIæ¥åˆ›å»ºã€è¯»å–ã€æ›´æ–°å’Œåˆ é™¤è¿™äº›è‡ªå®šä¹‰èµ„æºã€‚\nCRï¼ˆCustom Resourceï¼‰: CRæ˜¯åŸºäºCRDå®šä¹‰çš„å…·ä½“å®ä¾‹ã€‚ä¸€æ—¦å®šä¹‰äº†CRDï¼Œç”¨æˆ·å°±å¯ä»¥åˆ›å»ºè¯¥ç±»å‹çš„èµ„æºå®ä¾‹ï¼Œè¿™äº›å®ä¾‹å°±æ˜¯CRã€‚æ¯ä¸ªCRä»£è¡¨äº†ç‰¹å®šçš„é…ç½®æˆ–çŠ¶æ€ï¼Œæ¯”å¦‚ä¸€ä¸ªç‰¹å®šæ•°æ®åº“å®ä¾‹çš„é…ç½®ã€ä¸€ä¸ªå¤æ‚åº”ç”¨çš„éƒ¨ç½²é…ç½®ç­‰ã€‚CRçš„å·¥ä½œåŸç†ç±»ä¼¼äºKubernetesä¸­çš„å…¶ä»–å¯¹è±¡ï¼ˆå¦‚Deploymentã€Serviceï¼‰ï¼Œä½†å®ƒä»¬æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°é€‚åº”ç‰¹å®šåº”ç”¨çš„éœ€æ±‚ã€‚å¼€å‘è€…æˆ–è¿ç»´äººå‘˜é€šè¿‡åˆ›å»ºCRæ¥å£°æ˜ä»–ä»¬å¸Œæœ›åœ¨é›†ç¾¤ä¸­éƒ¨ç½²æˆ–ç®¡ç†çš„èµ„æºçŠ¶æ€ï¼Œè€Œä¸ä¹‹å…³è”çš„Operatorä¼šæ ¹æ®è¿™äº›å£°æ˜æ¥åˆ›å»ºã€ç»´æŠ¤å’Œæ›´æ–°å®é™…çš„Kuberneteså¯¹è±¡ã€‚\nGVKï¼ˆGroup, Version, Kindï¼‰: GVKä»£è¡¨äº†èµ„æºçš„ç»„ï¼ˆGroupï¼‰ã€ç‰ˆæœ¬ï¼ˆVersionï¼‰å’Œç§ç±»ï¼ˆKindï¼‰ã€‚å®ƒæ˜¯ä»èµ„æºçš„APIå±‚é¢æè¿°èµ„æºçš„ä¸€ç§æ–¹å¼ã€‚\nGroupï¼šæŒ‡èµ„æºæ‰€å±çš„APIç»„ï¼Œç”¨äºåŒºåˆ†ä¸åŒåŠŸèƒ½é¢†åŸŸçš„APIã€‚ä¾‹å¦‚ï¼Œapps&#x2F;v1ä¸­çš„appså°±æ˜¯ç»„åï¼Œå®ƒé€šå¸¸å¯¹åº”ç€Kubernetesçš„ä¸€ä¸ªç‰¹å®šåŠŸèƒ½é¢†åŸŸï¼Œå¦‚åº”ç”¨ç¨‹åºç®¡ç†ã€‚\nVersionï¼šèµ„æºçš„APIç‰ˆæœ¬ï¼Œè¡¨æ˜èµ„æºå®šä¹‰éµå¾ªçš„ç‰¹å®šAPIç‰ˆæœ¬è§„èŒƒã€‚éšç€Kubernetesçš„å‘å±•ï¼Œèµ„æºçš„APIå¯èƒ½ä¼šæœ‰å˜åŒ–ï¼Œç‰ˆæœ¬å·å¸®åŠ©åŒºåˆ†è¿™äº›ä¸åŒçš„è§„èŒƒã€‚\nKindï¼šèµ„æºçš„ç±»å‹ï¼Œå¦‚Podã€Serviceã€Deploymentç­‰ï¼Œå®ƒå®šä¹‰äº†ä¸€ç±»èµ„æºçš„åŸºæœ¬ç»“æ„å’Œç”¨é€”ã€‚\n\n\nGVR (Group, Version, Resource): GVRä¸GVKç±»ä¼¼ï¼Œä½†ç”¨Resourceæ›¿æ¢äº†Kindï¼Œå®ƒä»èµ„æºçš„è®¿é—®è·¯å¾„è§’åº¦æè¿°èµ„æºã€‚\nGroupï¼šæŒ‡èµ„æºæ‰€å±çš„APIç»„ï¼Œç”¨äºåŒºåˆ†ä¸åŒåŠŸèƒ½é¢†åŸŸçš„APIã€‚ä¾‹å¦‚ï¼Œapps&#x2F;v1ä¸­çš„appså°±æ˜¯ç»„åï¼Œå®ƒé€šå¸¸å¯¹åº”ç€Kubernetesçš„ä¸€ä¸ªç‰¹å®šåŠŸèƒ½é¢†åŸŸï¼Œå¦‚åº”ç”¨ç¨‹åºç®¡ç†ã€‚\nVersionï¼šèµ„æºçš„APIç‰ˆæœ¬ï¼Œè¡¨æ˜èµ„æºå®šä¹‰éµå¾ªçš„ç‰¹å®šAPIç‰ˆæœ¬è§„èŒƒã€‚éšç€Kubernetesçš„å‘å±•ï¼Œèµ„æºçš„APIå¯èƒ½ä¼šæœ‰å˜åŒ–ï¼Œç‰ˆæœ¬å·å¸®åŠ©åŒºåˆ†è¿™äº›ä¸åŒçš„è§„èŒƒã€‚\nResource: æŒ‡çš„æ˜¯èµ„æºåœ¨APIè·¯å¾„ä¸­çš„åç§°ï¼Œå®ƒç›´æ¥å…³è”åˆ°APIç«¯ç‚¹ï¼Œæ˜¯ç”¨äºä¸APIæœåŠ¡å™¨äº¤äº’æ—¶çš„URLè·¯å¾„ç»„æˆéƒ¨åˆ†ã€‚Resourceé€šå¸¸ä¸Kindç›¸ä¼¼æˆ–ç›¸åŒï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½æœ‰ç»†å¾®å·®åˆ«ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCRDsï¼‰æ—¶ã€‚\n\n\nScheme: è´Ÿè´£ç®¡ç†å’Œæ³¨å†ŒAPIç±»å‹ï¼ˆå¦‚å„ç§èµ„æºå¯¹è±¡ï¼‰ä»¥åŠå®ƒä»¬ä¹‹é—´çš„è½¬æ¢å…³ç³»ã€‚ç®€å•æ¥è¯´ï¼ŒSchemeæ˜¯ç†è§£å’Œæ“ä½œKuberneteså¯¹è±¡çš„åŸºç¡€æ¡†æ¶ï¼Œå®ƒç¡®ä¿äº†å¯¹è±¡çš„åºåˆ—åŒ–ã€ååºåˆ—åŒ–ä»¥åŠç±»å‹è½¬æ¢èƒ½å¤Ÿæ­£ç¡®è¿›è¡Œ\nç±»å‹æ³¨å†Œï¼šSchemeå…è®¸ä½ æ³¨å†Œè‡ªå®šä¹‰æˆ–å†…ç½®çš„APIç±»å‹ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥å‘Šè¯‰Schemeå¦‚ä½•è¯†åˆ«å’Œå¤„ç†ç‰¹å®šçš„Goç»“æ„ä½“ç±»å‹ï¼Œæ¯”å¦‚Podã€Serviceã€æˆ–è€…è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCRDsï¼‰ç­‰ã€‚\nå¯¹è±¡è½¬æ¢ï¼šå®ƒæä¾›äº†ç±»å‹è½¬æ¢åŠŸèƒ½ï¼Œå…è®¸åœ¨ä¸åŒçš„APIç‰ˆæœ¬ä¹‹é—´è½¬æ¢å¯¹è±¡ã€‚è¿™å¯¹äºå¤„ç†APIçš„ç‰ˆæœ¬å…¼å®¹æ€§å’Œå‡çº§éå¸¸é‡è¦ã€‚\né»˜è®¤åŒ–ï¼šSchemeæ”¯æŒä¸ºå¯¹è±¡è®¾ç½®é»˜è®¤å€¼ã€‚å½“åˆ›å»ºæˆ–æ›´æ–°èµ„æºæ—¶ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å®šæŸäº›å­—æ®µï¼ŒSchemeå¯ä»¥æ ¹æ®é¢„è®¾è§„åˆ™è‡ªåŠ¨å¡«å……é»˜è®¤å€¼\nåºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼šSchemeçŸ¥é“å¦‚ä½•å°†Goç»“æ„ä½“è½¬æ¢ä¸ºJSONæˆ–YAMLæ ¼å¼çš„æ•°æ®ï¼ˆåºåˆ—åŒ–ï¼‰ï¼Œä»¥åŠå¦‚ä½•å°†è¿™äº›æ•°æ®ååºåˆ—åŒ–å›Goç»“æ„ä½“ã€‚è¿™å¯¹äºä¸Kubernetes APIæœåŠ¡å™¨é€šä¿¡è‡³å…³é‡è¦ã€‚\nå…ƒæ•°æ®å¤„ç†ï¼šå®ƒè¿˜è´Ÿè´£å¤„ç†å¯¹è±¡çš„å…ƒæ•°æ®ï¼Œå¦‚APIç‰ˆæœ¬ä¿¡æ¯å’ŒKindä¿¡æ¯ï¼Œç¡®ä¿è¿™äº›ä¿¡æ¯åœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿‡ç¨‹ä¸­å¾—åˆ°å¦¥å–„å¤„ç†ã€‚\n\n\nManagerï¼šManageræ•´åˆäº†ä¸€ç³»åˆ—åŠŸèƒ½ï¼Œä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿæ›´å®¹æ˜“åœ°åˆ›å»ºå’Œç®¡ç†è‡ªå®šä¹‰èµ„æºï¼ˆCRDsï¼‰åŠå…¶å¯¹åº”çš„æ§åˆ¶å™¨é€»è¾‘ã€‚ä»¥ä¸‹æ˜¯Managerçš„ä¸€äº›å…³é”®èŒè´£å’ŒåŠŸèƒ½\nè‡ªå®šä¹‰èµ„æºç®¡ç†ï¼šManagerè´Ÿè´£ç›‘å¬å’Œç®¡ç†è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCRDsï¼‰çš„å˜åŒ–ï¼Œå½“CRå®ä¾‹è¢«åˆ›å»ºã€æ›´æ–°æˆ–åˆ é™¤æ—¶ï¼Œå®ƒèƒ½ç¡®ä¿ç›¸åº”çš„æ§åˆ¶å™¨é€»è¾‘å¾—åˆ°æ‰§è¡Œã€‚\næ§åˆ¶å™¨æ³¨å†Œï¼šå®ƒæä¾›äº†ä¸€ä¸ªä¸­å¿ƒç‚¹æ¥æ³¨å†Œå’Œç®¡ç†ä¸åŒçš„æ§åˆ¶å™¨ï¼ˆControllersï¼‰ã€‚æ§åˆ¶å™¨æ˜¯æ‰§è¡Œå…·ä½“ä¸šåŠ¡é€»è¾‘çš„ç»„ä»¶ï¼Œè´Ÿè´£ç»´æŠ¤æœŸæœ›çŠ¶æ€ä¸å®é™…é›†ç¾¤çŠ¶æ€çš„ä¸€è‡´æ€§ã€‚\nä¾èµ–æ³¨å…¥ï¼šManageræ¡†æ¶é€šå¸¸æ”¯æŒä¾èµ–æ³¨å…¥ï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥è½»æ¾åœ°å¤ç”¨å’Œå…±äº«æœåŠ¡ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯é›†ï¼ˆClientSetsï¼‰ç”¨äºä¸Kubernetes APIäº¤äº’ã€æ—¥å¿—è®°å½•å™¨ã€äº‹ä»¶è®°å½•å™¨ç­‰ã€‚\né¢†å¯¼è€…é€‰ä¸¾ï¼šåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼ŒManagerå¯ä»¥å®ç°é¢†å¯¼è€…é€‰ä¸¾é€»è¾‘ï¼Œç¡®ä¿åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ªæ´»è·ƒçš„å®ä¾‹åœ¨æ‰§è¡Œæ“ä½œï¼Œé¿å…å†²çªå’Œé‡å¤å¤„ç†ã€‚\nWebhookæ³¨å†Œï¼šå®ƒè¿˜å¯èƒ½æ”¯æŒæ³¨å†Œå’Œç®¡ç†è‡ªå®šä¹‰çš„Admission Webhooksï¼Œå…è®¸åœ¨èµ„æºåˆ›å»ºæˆ–ä¿®æ”¹æ—¶æ’å…¥è‡ªå®šä¹‰éªŒè¯æˆ–ä¿®æ”¹é€»è¾‘ã€‚\nç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šManagerè´Ÿè´£å¯åŠ¨ã€åœæ­¢æ§åˆ¶å™¨ï¼Œä»¥åŠå¤„ç†å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œç¡®ä¿èµ„æºçš„æœ‰æ•ˆç®¡ç†å’Œæ¸…ç†ã€‚\n\n\nControllerï¼šKubebuilderä¸ºæˆ‘ä»¬ç”Ÿæˆçš„è„šæ‰‹æ¶æ–‡ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°Reconcileæ–¹æ³•å³å¯ã€‚\nInformersï¼šåœ¨Kubernetesä¸­ï¼ŒInformersæ˜¯å®¢æˆ·ç«¯åº“ï¼ˆclient-goï¼‰æä¾›çš„ä¸€ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œç”¨äºé«˜æ•ˆåœ°ç›‘å¬å’ŒåŒæ­¥Kubernetes APIèµ„æºçš„å˜åŒ–ã€‚å®ƒæ˜¯å®ç°æ§åˆ¶å™¨æ¨¡å¼çš„å…³é”®æŠ€æœ¯ä¹‹ä¸€ï¼Œå°¤å…¶æ˜¯å¯¹äºé‚£äº›éœ€è¦æ ¹æ®èµ„æºçŠ¶æ€å˜åŒ–åšå‡ºååº”çš„ç»„ä»¶ï¼Œå¦‚è‡ªå®šä¹‰æ§åˆ¶å™¨ã€Operatorç­‰\nèµ„æºç›‘å¬ï¼šInformersæŒç»­ç›‘å¬Kubernetes APIæœåŠ¡å™¨ä¸­æŒ‡å®šèµ„æºç±»å‹ï¼ˆå¦‚Podsã€Deploymentsç­‰ï¼‰çš„å¢åˆ æ”¹äº‹ä»¶ï¼Œé€šè¿‡watch APIæœºåˆ¶å®ç°è¿‘ä¹å®æ—¶çš„èµ„æºå˜åŒ–æ„ŸçŸ¥ã€‚\nç¼“å­˜åŒæ­¥ï¼šå®ƒåœ¨æœ¬åœ°ç»´æŠ¤ä¸€ä¸ªèµ„æºå¯¹è±¡çš„ç¼“å­˜å‰¯æœ¬ï¼Œè¿™ä¸ªç¼“å­˜ä¼šéšç€APIæœåŠ¡å™¨çš„äº‹ä»¶æ›´æ–°è€Œè‡ªåŠ¨ä¿æŒæœ€æ–°çŠ¶æ€ã€‚è¿™æ ·ï¼Œæ§åˆ¶å™¨æˆ–å…¶ä»–ç»„ä»¶å¯ä»¥ç›´æ¥æŸ¥è¯¢æœ¬åœ°ç¼“å­˜è·å–èµ„æºåˆ—è¡¨æˆ–è¯¦æƒ…ï¼Œè€Œä¸éœ€è¦é¢‘ç¹åœ°ç›´æ¥æŸ¥è¯¢APIæœåŠ¡å™¨ï¼Œå¤§å¤§æé«˜äº†æ•ˆç‡ã€‚\näº‹ä»¶å¤„ç†ï¼šInformersæä¾›å›è°ƒæœºåˆ¶ï¼Œå…è®¸ç”¨æˆ·æ³¨å†Œå¤„ç†å‡½æ•°ï¼ˆå¦‚EventHandleræˆ–Informerçš„äº‹ä»¶å¤„ç†å™¨ï¼‰ï¼Œå½“èµ„æºå‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨è§¦å‘è¿™äº›å‡½æ•°ï¼Œæ‰§è¡Œç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ã€‚\nåˆ—è¡¨å’Œè¯¦ç»†ä¿¡æ¯çš„ç»Ÿä¸€ç®¡ç†ï¼šé€šè¿‡Listeræ¥å£ï¼ŒInformersä¸ä»…èƒ½å¤Ÿæä¾›èµ„æºåˆ—è¡¨ï¼Œè¿˜èƒ½é«˜æ•ˆåœ°è·å–å•ä¸ªèµ„æºçš„è¯¦ç»†ä¿¡æ¯ï¼Œè¿›ä¸€æ­¥ç®€åŒ–äº†èµ„æºçš„ç®¡ç†å’ŒæŸ¥è¯¢è¿‡ç¨‹ã€‚\n\n\nIndexï¼šç”±äºControllerç»å¸¸è¦å¯¹Cacheè¿›è¡ŒæŸ¥è¯¢ï¼ŒKubebuilderæä¾›Index utilityç»™CacheåŠ ç´¢å¼•æå‡æŸ¥è¯¢æ•ˆç‡ã€‚\nFinalizerï¼šåœ¨Kubernetesä¸­ï¼ŒFinalizer æ˜¯ä¸€ç§é«˜çº§ç‰¹æ€§ï¼Œç”¨äºç¡®ä¿èµ„æºåœ¨å…¶è¢«åˆ é™¤ä¹‹å‰èƒ½å®Œæˆå¿…è¦çš„æ¸…ç†å·¥ä½œã€‚å®ƒä½œä¸ºä¸€ç§ä¿éšœæœºåˆ¶ï¼Œå¯ä»¥è®©æ§åˆ¶å™¨æˆ–æ“ä½œè€…æœ‰æœºä¼šåœ¨å¯¹è±¡è¢«æ°¸ä¹…åˆ é™¤å‰æ‰§è¡Œä¸€äº›æ¸…ç†ã€å¤‡ä»½æˆ–å…¶ä»–å¿…è¦çš„æ“ä½œï¼Œç¡®ä¿èµ„æºçš„ä¼˜é›…åˆ é™¤å’Œèµ„æºä½¿ç”¨çš„å®Œæ•´æ€§ã€‚\né˜»æ­¢åˆ é™¤ï¼šåˆ é™¤æ“ä½œä¼šè¢«æš‚åœï¼Œç›´åˆ°æ‰€æœ‰åˆ—å‡ºçš„finalizeréƒ½è¢«å¤„ç†å®Œæ¯•ã€‚\né€šçŸ¥å¤„ç†è€…ï¼šKubernetesä¼šé€šçŸ¥æˆ–ç­‰å¾…è´Ÿè´£è¯¥finalizerçš„æ§åˆ¶å™¨ï¼ˆæˆ–å¤–éƒ¨ç³»ç»Ÿï¼‰å®Œæˆç›¸åº”çš„æ¸…ç†æ“ä½œã€‚\næ¸…é™¤Finalizerï¼šä¸€æ—¦å¤„ç†è€…å®Œæˆäº†å…¶ä»»åŠ¡ï¼Œå®ƒä¼šé€šè¿‡APIæ›´æ–°è¯¥å¯¹è±¡ï¼Œä»metadata.finalizerså­—æ®µä¸­ç§»é™¤ç›¸åº”çš„finalizeré¡¹ã€‚\nç»§ç»­åˆ é™¤æµç¨‹ï¼šå½“æ‰€æœ‰finalizeréƒ½è¢«ç§»é™¤åï¼ŒKubernetesæ‰ä¼šæœ€ç»ˆä»APIæœåŠ¡å™¨ä¸­åˆ é™¤è¯¥å¯¹è±¡ã€‚\né…ç½®Finalizerï¼šFinalizeré€šå¸¸æ˜¯é€šè¿‡è‡ªå®šä¹‰æ§åˆ¶å™¨ï¼ˆå¦‚Operatorï¼‰åŠ¨æ€æ·»åŠ å’Œç®¡ç†çš„ã€‚æ§åˆ¶å™¨å¯ä»¥åœ¨åˆ›å»ºæˆ–æ›´æ–°èµ„æºæ—¶å‘å¯¹è±¡çš„metadata.finalizerså­—æ®µæ·»åŠ è‡ªå®šä¹‰çš„finalizeråç§°ï¼ŒåŒæ ·ï¼Œåœ¨å®Œæˆæ¸…ç†å·¥ä½œåï¼Œéœ€è¦é€šè¿‡APIè°ƒç”¨æ¥ç§»é™¤è¿™ä¸ªfinalizerï¼Œä»¥å…è®¸èµ„æºè¢«å½»åº•åˆ é™¤ã€‚\n\n\nOwnerReferenceå·¥ä½œåŸç†ï¼šåœ¨Kubernetesä¸­ï¼ŒOwnerReference æ˜¯ä¸€ç§æœºåˆ¶ï¼Œç”¨äºå»ºç«‹èµ„æºå¯¹è±¡ä¹‹é—´çš„æ‰€æœ‰æƒå…³ç³»ã€‚è¿™ç§å…³ç³»å®šä¹‰äº†èµ„æºçš„ç”Ÿå‘½å‘¨æœŸä¾èµ–æ€§ï¼Œå³â€œæ‹¥æœ‰è€…â€èµ„æºï¼ˆownerï¼‰æ§åˆ¶ç€â€œè¢«æ‹¥æœ‰â€èµ„æºï¼ˆowned resourceï¼‰çš„ç”Ÿå‘½å‘¨æœŸã€‚å½“ä¸€ä¸ªèµ„æºä½œä¸ºå¦ä¸€ä¸ªèµ„æºçš„Owneræ—¶ï¼Œå®ƒä¼šå¯¹è¢«æ‹¥æœ‰èµ„æºçš„åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤äº§ç”Ÿå½±å“ï¼Œç¡®ä¿èµ„æºä¹‹é—´çš„ä¸€è‡´æ€§å’Œè‡ªåŠ¨åŒ–ç®¡ç†ã€‚\nè‡ªåŠ¨æ¸…ç†ï¼ˆGarbage Collectionï¼‰ï¼šå½“ä¸€ä¸ªèµ„æºå¯¹è±¡è¢«åˆ é™¤ï¼Œå¹¶ä¸”å®ƒæ‹¥æœ‰å…¶ä»–èµ„æºæ—¶ï¼ŒKubernetesçš„åƒåœ¾æ”¶é›†æœºåˆ¶ä¼šè‡ªåŠ¨åˆ é™¤è¿™äº›è¢«æ‹¥æœ‰çš„èµ„æºï¼Œç¡®ä¿èµ„æºä¾èµ–å…³ç³»è¢«æ­£ç¡®æ¸…ç†ï¼Œé¿å…å­¤å„¿èµ„æºçš„äº§ç”Ÿã€‚\nç”Ÿå‘½å‘¨æœŸè€¦åˆï¼šè¢«æ‹¥æœ‰èµ„æºçš„ç”Ÿå‘½å‘¨æœŸä¸æ‹¥æœ‰è€…èµ„æºç´§å¯†ç›¸è¿ã€‚å¦‚æœæ‹¥æœ‰è€…èµ„æºè¢«ä¿®æ”¹æˆ–åˆ é™¤ï¼ŒKubernetesä¼šç›¸åº”åœ°æ›´æ–°æˆ–æ¸…ç†è¢«æ‹¥æœ‰èµ„æºã€‚\né˜²æ­¢å¾ªç¯ä¾èµ–ï¼šKubernetesç¦æ­¢åˆ›å»ºä¼šå¯¼è‡´å¾ªç¯OwnerReferenceå…³ç³»çš„èµ„æºï¼Œä»¥é˜²æ­¢èµ„æºç®¡ç†æ··ä¹±å’Œæ½œåœ¨çš„æ­»é”æƒ…å†µã€‚\n\n\nOwnerReferenceç»“æ„å®šä¹‰ï¼šOwnerReferenceæ˜¯ä»¥APIå¯¹è±¡çš„ä¸€ä¸ªå­—æ®µå½¢å¼å­˜åœ¨çš„ï¼Œé€šå¸¸ä½äºè¢«æ‹¥æœ‰èµ„æºçš„metadata.ownerReferenceså­—æ®µä¸­ã€‚å®ƒåŒ…å«å‡ ä¸ªå…³é”®å±æ€§ï¼š\nAPIVersionï¼šæ‹¥æœ‰è€…çš„APIç‰ˆæœ¬ã€‚\nKindï¼šæ‹¥æœ‰è€…çš„èµ„æºç±»å‹ã€‚\nNameï¼šæ‹¥æœ‰è€…çš„åç§°ã€‚\nUIDï¼šæ‹¥æœ‰è€…çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUIDï¼‰ï¼Œè¿™æ˜¯åŒºåˆ†ä¸åŒèµ„æºå®ä¾‹çš„å…³é”®ã€‚\nControllerï¼ˆå¯é€‰ï¼‰ï¼šå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦ç”±ä¸€ä¸ªæ§åˆ¶å™¨ï¼ˆå¦‚Deploymentæˆ–StatefulSetï¼‰ç®¡ç†è¿™ä¸ªå…³ç³»ã€‚å¦‚æœæ˜¯æ§åˆ¶å™¨ï¼ŒKubernetesä¼šåœ¨é€‚å½“çš„æ—¶å€™è‡ªåŠ¨ç®¡ç†è¢«æ‹¥æœ‰èµ„æºã€‚\n\n\n\n2.5 CRDå‘½åè§„èŒƒCRDçš„å…¨åå¿…é¡»æ˜¯ç¬¦åˆå¦‚ä¸‹çš„å‘½åè§„èŒƒï¼š${Kind}.${Group}.${Organization}.kubenode.alibaba-inc.com.\n\n${Organization}ï¼šä¸€èˆ¬ä¸ºä»“åº“çš„git groupï¼Œå³å›¢é˜Ÿè‹±æ–‡ç®€ç§°\n${Group}ï¼šå¿…é¡»æ˜¯ä¸€ç§åŠŸèƒ½ç±»åˆ«ï¼Œå¦‚opsã€appsã€authç­‰ï¼Œå°½é‡ç”¨ç²¾ç®€çš„å•ä¸ªè‹±æ–‡å•è¯çš„æ–¹å¼ä¼ è¾¾ä½ çš„CRDå±äºçš„â€ç±»åˆ«â€ã€‚ç»„æˆçš„å­—æ¯å¿…é¡»å°å†™\n${Kind}ï¼šå³ä¸ºCRDçœŸæ­£çš„çŸ­åå­—ï¼Œç”¨ç²¾ç®€çš„å•ä¸ªæˆ–å¤šä¸ªè‹±æ–‡å•è¯çš„æ‹¼æ¥æ¥æ˜æ˜çœŸæ­£çš„CRDçŸ­åå­—ã€‚å¦‚AdvanceDeploymentï¼ŒNetBookç­‰ã€‚ä½¿ç”¨å¤§é©¼å³°å‘½åæ³•(é¦–å­—æ¯ä¹Ÿæ˜¯ç­”è°¢ï¼Œå³UpperCamelCase)ã€‚\nalipay.comï¼šæ ¹æ®è‡ªå·±çš„å…¬å¸åç§°è¿›è¡Œç¡®å®šï¼Œå³Company Name Domain\nç›®å‰å¯¹äºCRDçš„ç‰ˆæœ¬è½¬æ¢ä¸å¤ªå‹å¥½ï¼Œä¸€èˆ¬ç»Ÿä¸€ä½¿ç”¨v1.\n\n2.6 Specï¼ŒStatus è§„èŒƒ\nç”¨å‘½ä»¤åœ¨apisåŒ…ä¸‹ç”ŸæˆCRD Typesåï¼Œè¯·ä¸è¦éšæ„ä¿®æ”¹apisé‡Œçš„ç»“æ„ä½“ã€å‘½åè§„åˆ™ã€ä»¥åŠæ³¨é‡Šã€‚\nåªèƒ½ï¼Œä¹Ÿåªä¿®æ”¹${Kind}_types.goæ–‡ä»¶é‡Œçš„Specå’ŒStatusSpecç»“æ„ä½“é‡Œçš„å†…å®¹ã€‚\nSpecå’ŒStatusSpecé‡Œçš„å­—æ®µéƒ½å¿…é¡»æ˜¯Publicçš„ï¼Œä¹Ÿå°±æ˜¯å­—æ®µåé¦–å­—æ¯æ˜¯å¤§å†™ã€‚\næ¯ä¸ªå­—æ®µï¼Œéƒ½åº”è¯¥å†™ä¸ŠJSON Tagï¼ŒJSON Tagå¿…é¡»ä½¿ç”¨å°é©¼å³°å‘½åæ³•ï¼Œå³LowerCamelCaseã€‚\nå¦‚æœå­—æ®µå…è®¸ä¸ºç©ºï¼ŒJSON Tagè®°å¾—å¸¦ä¸Šomitemptyã€‚StatusSpecçš„å­—æ®µä¸€èˆ¬éƒ½æ˜¯å…è®¸ä¸ºç©ºçš„ã€‚ä¾‹å­ï¼š\n\ntype DemoSpecs struct &#123;        // FiledA å…è®¸ä¸ºç©º        FieldA string `json&quot;fieldA,omitempty&quot;`                // FieldB ä¸å…è®¸ä¸ºç©º        FieldB string `json&quot;fieldB&quot;`&#125;\n\n3 Operator å·¥ä½œæµç¨‹\n3.1 æ ¸å¿ƒç»„ä»¶\nInformerï¼šä¸€ä¸ªä¾èµ– Kubernetes List&#x2F;Watch API ã€å¯ç›‘å¬äº‹ä»¶å¹¶è§¦å‘å›è°ƒå‡½æ•°çš„äºŒçº§ç¼“å­˜å·¥å…·åŒ…ã€‚\nåœ¨å¯åŠ¨æ—¶Reflectorè°ƒç”¨List APIè·å¾—crdçš„å…¨éƒ¨Objectå®ä¾‹ï¼Œå¹¶ç¼“å­˜åœ¨Local Storeä¸­ã€‚\nç„¶åReflectorè°ƒç”¨Watch APIæ¥è·å–å’Œç›‘å¬å¯¹è±¡å®ä¾‹çš„å˜åŒ–ï¼Œç»´æŠ¤ç¼“å­˜çš„å˜åŒ–ã€‚\næ¯å½“æ”¶åˆ°add&#x2F;deleteç­‰å®ä¾‹è¯·æ±‚æ—¶ï¼ŒReflectorä¼šå°†å˜æ›´çš„äº‹ä»¶+å¯¹è±¡æ¨é€åˆ°deltaFIFOçš„é˜Ÿåˆ—ä¸­ã€‚\næ ¹æ®delttaFIFOä¸­çš„å†…å®¹ï¼Œå…ˆåˆ°Local Storeä¸­æ›´æ–°å¯¹è±¡çš„ä¿¡æ¯ä¸çŠ¶æ€ï¼Œä¹‹åç»è¿‡eventHandlerè¿›å…¥WorkQueueï¼Œè¿›è€Œè§¦å‘controllerçš„reconciletè°ƒè°é€»è¾‘ã€‚\n\n\nWorkQueueï¼šéœ€è¦å¤„ç†çš„äº‹ä»¶é˜Ÿåˆ—ï¼Œä¾›controlleræ¥è¿›è¡ŒçœŸæ­£çš„ä¸šåŠ¡å¤„ç†ã€‚\nControl Loopï¼šå®é™…çš„æ§åˆ¶å™¨è§’è‰²ï¼Œé€šè¿‡å®ç°è°ƒè°é€»è¾‘ï¼Œç¡®ä¿æœŸæœ›å’Œå®é™…è¿è¡ŒçŠ¶æ€æ˜¯ä¸€è‡´çš„ã€‚é€šè¿‡Listerå‘Local Storeä¸­è¯»Objectå®ä¾‹ï¼Œé€šè¿‡Clientå‘API Serverå†™å…·ä½“çš„æ“ä½œé€»è¾‘ã€‚\n\n3.2 å®ç°ç»†èŠ‚\næ¶ˆæ¯å¯é æ€§ï¼šListçŸ­é“¾æ¥æŸ¥è¯¢å½“å‰å…¨é‡çš„èµ„æºåŠçŠ¶æ€ï¼›Watché•¿é“¾æ¥æ¥å—å¢é‡çš„èµ„æºå˜æ›´äº‹ä»¶å¹¶åšç›¸åº”å¤„ç†ã€‚ä¸¤è€…äº’ç›¸å¸®åŠ©ï¼Œè¾¾åˆ°æ¶ˆæ¯çš„å¯é æ€§å’Œæ•°æ®çš„ä¸€è‡´æ€§ã€‚\nå…±äº«Informerï¼šå¯¹åŒä¸€ç±»å‹çš„èµ„æºåªå»ºç«‹ä¸€ä¸ªé“¾æ¥ï¼Œä¸ºå¤šä¸ªcontrolleræä¾›å…±äº«cacheçš„èƒ½åŠ›ã€‚\nè‹¥è¯·æ±‚ä¸ºæ·»åŠ æ“ä½œï¼ŒIndexeræŠŠAPIå¯¹è±¡ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ä¸­ï¼Œå¹¶ä¸ºå®ƒåˆ›å»ºç´¢å¼•ï¼›è‹¥ä¸ºåˆ é™¤æ“ä½œï¼Œåˆ™åœ¨æœ¬åœ°ç¼“å­˜ä¸­åˆ é™¤è¯¥å¯¹è±¡ã€‚\nLocalStore ä¼šå‘¨æœŸæ€§åœ°æŠŠæ‰€æœ‰èµ„æºçš„ä¿¡æ¯é‡æ–°æ”¾åˆ° DeltaFIFO ä¸­ï¼Œç¡®ä¿äºŒçº§ç¼“å­˜é—´çš„åŒæ­¥ï¼Œè®©å¤±è´¥çš„äº‹ä»¶å¾—åˆ°é‡æ–°å¤„ç†ã€‚è‹¥åœ¨å…¥é˜Ÿå‰å‘ç°DeltaFIFOä¸­å·²ç»æœ‰æ–°ç‰ˆæœ¬çš„Objectå®ä¾‹ï¼Œåˆ™ä¸å…¥é˜Ÿã€‚\nReconcilersæ˜¯æ ¸å¿ƒå¤„ç†é€»è¾‘ï¼Œä½†å…¶åªè·å–èµ„æºçš„åç§°å’Œå‘½åç©ºé—´ï¼Œå¹¶ä¸çŸ¥é“èµ„æºçš„æ“ä½œ(å¢åˆ æ”¹)æ˜¯ä»€ä¹ˆï¼Œä¹Ÿä¸çŸ¥é“èµ„æºçš„å…¶ä»–ä¿¡æ¯ã€‚ç›®çš„å°±æ˜¯åœ¨æ”¶åˆ°èµ„æºå˜æ›´æ—¶ï¼Œæ ¹æ®objectçš„æœŸæœ›çŠ¶æ€ç›´æ¥è°ƒæ•´èµ„æºçš„çŠ¶æ€ã€‚\n\n3.3 ä»¥Podä¸ºå¯¹è±¡çš„æµç¨‹ç¤ºä¾‹\n\nInformer åœ¨åˆå§‹åŒ–æ—¶ï¼ŒReflector ä¼šå…ˆé€šè¿‡ List API å‘ API Server è·å¾—æ‰€æœ‰çš„ Pod å®ä¾‹ã€‚\nReflector æ‹¿åˆ°å…¨éƒ¨ Pod å®ä¾‹åï¼Œä¼šå°†å…¨éƒ¨ Pod å®ä¾‹æ”¾åˆ° Local Store ä¸­\nå¦‚æœåé¢ Controller è°ƒç”¨ Lister çš„ List&#x2F;Get æ–¹æ³•è·å– Pod å®ä¾‹æ—¶ï¼Œ é‚£ä¹ˆ Lister ä¼šç›´æ¥ä» Local Store ä¸­æ‹¿æ•°æ®ã€‚\nInformer åˆå§‹åŒ–å®Œæˆä¹‹åï¼ŒReflectorå¼€å§‹é€šè¿‡Watch APIç›‘å¬Podç›¸å…³çš„æ‰€æœ‰äº‹ä»¶ï¼›å¦‚æœæ­¤æ—¶ pod_1 è¢«åˆ é™¤ï¼Œé‚£ä¹ˆ Reflector ä¼šç›‘å¬åˆ°è¿™ä¸ªäº‹ä»¶ã€‚\nReflector å°† pod_1 è¢«åˆ é™¤çš„è¿™ä¸ªäº‹ä»¶å‘é€åˆ° DeltaFIFO\nDeltaFIFO é¦–å…ˆä¼šå°†è¿™ä¸ªäº‹ä»¶ï¼ˆä¸€èˆ¬ä¸ºkey : valueçš„å½¢å¼ï¼‰å­˜å‚¨åœ¨è‡ªå·±çš„WorkQueueï¼Œç„¶åä¼šç›´æ¥æ“ä½œ Local Store ä¸­çš„æ•°æ®ï¼Œåˆ é™¤ Local Store ä¸­çš„ pod_1ã€‚\nWorkQueue ä¼š Pop è¿™ä¸ªäº‹ä»¶åˆ° Controller ä¸­ã€‚\nController æ”¶åˆ°è¿™ä¸ªäº‹ä»¶ï¼Œé€šè¿‡ Lister ä»æœ¬åœ° Local Store ä¸­è·å–çœŸæ­£çš„å¯¹è±¡å®ä¾‹ï¼Œæ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ã€‚\nè‹¥æœ‰å…³è”èµ„æºï¼ˆownerReferenceä¸ºè¯¥å¯¹è±¡çš„èµ„æºï¼‰ï¼Œåˆ™åˆ é™¤å…³è”èµ„æºã€‚\nè‹¥æ— å…³è”èµ„æºï¼Œåˆ™ç­‰å¾…è¯»å–ä¸‹ä¸€ä¸ªäº‹ä»¶ã€‚\n\n\n\n4 åŸç”Ÿå®ç°\nCRDå®ç°ï¼š é¦–å…ˆåˆ©ç”¨CRDçš„å®šä¹‰æ–‡ä»¶types.goï¼Œé€šè¿‡å®˜æ–¹çš„code-generatorç”ŸæˆCRDçš„ç›¸å…³ä»£ç ï¼ŒåŒ…æ‹¬æ ‡å‡†clientï¼Œdeepcopyï¼Œinformerå’Œlisterã€‚\ncontrollerå®ç°ï¼š ç„¶ååŸºäºå®˜æ–¹çš„sample-controllerçš„å®è·µç¤ºä¾‹ï¼Œè¿›è¡Œè‡ªå®šä¹‰çš„ç¼–æ’é€»è¾‘ç¼–å†™ï¼ŒåŒ…æ‹¬å¯¹äºä¸åŒadd &#x2F; update &#x2F;delete ç­‰æ“ä½œçš„å“åº”ç­‰ç»†èŠ‚æ“ä½œã€‚\nYAMLæ–‡ä»¶ç¼–å†™ï¼š æ‰‹åŠ¨ç¼–å†™CRDå®šä¹‰å’ŒDeploymentå®šä¹‰YAMLæ–‡ä»¶ï¼Œé€šè¿‡kubectl applyå®Œæˆk8sèµ„æºçš„æ‰©å±•å’Œæ§åˆ¶å™¨çš„éƒ¨ç½²ã€‚\nå…¶ä»–å¼€å‘å·¥ä½œï¼š æ¯”å¦‚å¯¹Controllerè¿›è¡ŒäºŒè¿›åˆ¶ç¼–è¯‘ã€é•œåƒæ‰“åŒ…ä¸Šä¼ ã€ä»¥Deploymentä¸­çš„Podçš„å½¢å¼éƒ¨ç½²åˆ°K8sä¸­ç­‰ã€‚\n\nç­‰åé¢æ¥çœ‹ä¸‹ï¼Œè¿™äº›å·¥ä½œä¸­ï¼Œè„šæ‰‹æ¶èƒ½å¸®å¿™å®ç°å¤šå°‘ã€‚\n","categories":["kubernetes/operator"],"tags":["kubernetes","operator"]},{"title":"operatoréƒ¨ç½²éªŒè¯","url":"/2025/07/kubernetes/operator-kai-fa/operator-bu-shu-yan-zheng/","content":"1ã€éƒ¨ç½²å‘½ä»¤è¿™ä¸ªæ˜¯å¾ˆå¤šåšå®¢æ•™ç¨‹éƒ½åœ¨ä½¿ç”¨çš„éƒ¨ç½²å‘½ä»¤ï¼š\nmake manifestsmake installexport ENABLE_WEBHOOKS=falsemake run\næˆ‘ä»¬ä½¿ç”¨ä¹‹å‰çš„demoæ¥è¿›è¡Œéƒ¨ç½²éªŒè¯ï¼šKubernetes-Operatorç¯‡-02-è„šæ‰‹æ¶ç†Ÿæ‚‰\nè¿™é‡Œé¢æ¶‰åŠåˆ°çš„makefileçš„é…ç½®å¯ä»¥å‚è€ƒï¼šKubernetes-Operatorç¯‡-03-kubebuilderçš„Makefileæ–‡ä»¶ç†Ÿæ‚‰\nä¸‹é¢è®©æˆ‘æ¥çœ‹çœ‹è¿™äº›å‘½ä»¤çš„å«ä¹‰ï¼Œå¹¶ä¸”éƒ½æ˜¯åœ¨å¹²ä»€ä¹ˆ\n1.1 make manifestsmake manifestsï¼š\n.PHONY: manifestsmanifests: controller-gen ## Generate WebhookConfiguration, ClusterRole and CustomResourceDefinition objects.        $(CONTROLLER_GEN) rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases\nè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†ç”ŸæˆWebhookConfigurationã€ClusterRoleå’ŒCustomResourceDefinition å¯¹è±¡ã€‚\nåœ¨ç”Ÿæˆäº†WebhookConfigurationã€ClusterRoleå’ŒCustomResourceDefinition å¯¹è±¡åï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡ŒæŸ¥çœ‹ï¼Œä½†æ˜¯ä¸è¦æ‰‹åŠ¨å»ä¿®æ”¹ï¼Œå› ä¸ºåé¢çš„make installå’Œmake runç­‰å‘½ä»¤ï¼Œéƒ½ä¾èµ–è¯¥ç›®æ ‡ï¼Œå¹¶ä¸”å› ä¸ºéƒ½æ˜¯ä½¿ç”¨çš„.PHONYå…³é”®å­—æ¥ç”³æ˜çš„ä¼ªç›®æ ‡ï¼Œæ‰€ä»¥æ¯æ¬¡æ‰§è¡Œmake installå’Œmake runéƒ½ä¼šæ‰§è¡Œmanifestsä¾èµ–ã€‚\næ‰€ä»¥å•ç‹¬æ‰§è¡Œmake manifestsçš„æ„ä¹‰æ˜¯ä»€ä¹ˆå‘¢ï¼Œä¸ªäººè§‚ç‚¹ï¼Œåœ¨ä¸€ä¸ªå®Œæ•´éƒ¨ç½²åŠ¨ä½œä¸­ï¼Œå®Œæˆäº†ä»£ç å˜æ›´åï¼Œæ˜¯éœ€è¦é€šè¿‡make manifestsæ¥è¿›è¡Œé…ç½®çš„ç”ŸæˆæŸ¥çœ‹çš„ã€‚ä½†æ˜¯å¦‚æœåœ¨æœ¬éƒ¨ç½²åŠ¨ä½œä¸­ï¼Œä¸å…³å¿ƒç”Ÿæˆé…ç½®çš„å…·ä½“æƒ…å†µï¼Œåªæƒ³èµ°ä¸€éæµç¨‹ï¼Œæˆ–è€…ç›´æ¥æµ‹è¯•ï¼Œé‚£å…¶å®å¿½ç•¥ä¸æ‰§è¡Œä¹Ÿokï¼Œæ¯•ç«Ÿåé¢æ¯ä¸€æ­¥éƒ½ä¼šé‡æ–°ç”Ÿæˆä¸”è¦†ç›–ã€‚\n1.2 make installmake installï¼š\n.PHONY: installinstall: manifests kustomize ## Install CRDs into the K8s cluster specified in ~/.kube/config.        $(KUSTOMIZE) build config/crd | $(KUBECTL) apply -f -\n\nå…ˆè¿è¡Œmanifestså’Œkustomizeç›®æ ‡ï¼Œç„¶åä½¿ç”¨kustomize æ„å»ºconfig&#x2F;crdç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶åº”ç”¨åˆ°é›†ç¾¤ã€‚\nè¿™é‡Œmanifestsç›®æ ‡ä¼šç”ŸæˆWebhookConfigurationã€ClusterRoleå’ŒCustomResourceDefinition å¯¹è±¡ï¼Œå¹¶ä¿å­˜åœ¨config&#x2F;crd&#x2F;basesç›®å½•ä¸‹ã€‚\nè€Œkustomizeç›®æ ‡æ˜¯è¿›è¡Œkustomizeå·¥å…·çš„ä¸‹è½½ï¼Œå¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨åˆ™ä¸‹è½½ï¼Œç„¶åç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶çš„è½¯é“¾ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶åªåœ¨é¦–æ¬¡ä¸‹è½½ï¼Œåç»­éƒ½æ˜¯ä»…æ›´æ–°è½¯é“¾ã€‚\nä¸‹é¢çš„å‘½ä»¤æ˜¯installå®é™…æ‰§è¡Œçš„åŠ¨ä½œï¼š\n$(KUSTOMIZE) build config/crd | $(KUBECTL) apply -f -\n\n1.3 make runmake runï¼š\n.PHONY: runrun: manifests generate fmt vet ## Run a controller from your host.        go run ./cmd/main.go\nå…ˆè¿è¡Œmanifestsã€generateã€fmtå’Œvetç›®æ ‡ï¼Œç„¶åä½¿ç”¨go runå‘½ä»¤è¿è¡Œcmd&#x2F;main.goæ–‡ä»¶\nè¿™é‡Œmanifestsç›®æ ‡ä¼šç”ŸæˆWebhookConfigurationã€ClusterRoleå’ŒCustomResourceDefinition å¯¹è±¡ï¼Œå¹¶ä¿å­˜åœ¨config&#x2F;crd&#x2F;basesç›®å½•ä¸‹ã€‚\nè€Œgenerate ç›®æ ‡æ˜¯ä½¿ç”¨controller-genå·¥å…·ç”ŸæˆåŒ…å«DeepCopyã€DeepCopyInto, å’ŒDeepCopyObjectæ–¹æ³•å®ç°çš„ä»£ç ã€‚\nè‡³äºfmtå’Œvetç›®æ ‡å°±æ˜¯æ‰§è¡Œgoçš„å‘½ä»¤ï¼šfmt ./...å’Œgo vet ./...\nä¸‹é¢çš„å‘½ä»¤æ˜¯installå®é™…æ‰§è¡Œçš„åŠ¨ä½œï¼š\ngo run ./cmd/main.go\n\n1.4 ç¯å¢ƒå˜é‡ENABLE_WEBHOOKSç¯å¢ƒå˜é‡ENABLE_WEBHOOKSæ§åˆ¶ç€webhookçš„å¯ç”¨ä¸å¦ã€‚\nè¿™æ®µä»£ç æ˜¯kubectlç”Ÿæˆçš„operatoré¡¹ç›®çš„mainå‡½æ•°ä¸­å¯ç”¨webhooké€»è¾‘çš„éƒ¨åˆ†ï¼š\nif os.Getenv(&quot;ENABLE_WEBHOOKS&quot;) != &quot;false&quot; &#123;                if err = (&amp;appsv1.Myapp&#123;&#125;).SetupWebhookWithManager(mgr); err != nil &#123;                        setupLog.Error(err, &quot;unable to create webhook&quot;, &quot;webhook&quot;, &quot;Myapp&quot;)                        os.Exit(1)                &#125;        &#125;\n\nè¿™é‡Œå¾ˆç®€å•ç²—æš´çš„æ ¹æ®ç¯å¢ƒå˜é‡ENABLE_WEBHOOKSæ¥å†³å®šæ˜¯å¦å¯ç”¨webhookï¼Œos.Getenvçš„å®šä¹‰:\nfunc Getenv(key string) string &#123;        testlog.Getenv(key)        v, _ := syscall.Getenv(key)        return v&#125;func Getenv(key string) (value string, found bool) &#123;        envOnce.Do(copyenv)        if len(key) == 0 &#123;                return &quot;&quot;, false        &#125;        envLock.RLock()        defer envLock.RUnlock()        i, ok := env[key]        if !ok &#123;                return &quot;&quot;, false        &#125;        s := envs[i]        for i := 0; i &lt; len(s); i++ &#123;                if s[i] == &#x27;=&#x27; &#123;                        return s[i+1:], true                &#125;        &#125;        return &quot;&quot;, false&#125;\nè¿™é‡Œè¿”å›çš„å€¼ï¼Œå¯èƒ½æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯èƒ½æ˜¯boolç±»å‹å€¼çš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯åªè¦å€¼ä¸æ˜¯falseï¼Œå°±ä¼šå¼€å¯webhookã€‚\nè‡³äºè¿™é‡Œä¸ºä»€ä¹ˆè¦ä¸´æ—¶å…³é—­webhookï¼Œå› ä¸ºå¯ç”¨webhookæ˜¯éœ€è¦è¯ä¹¦çš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦åœ¨æœ¬åœ°å®‰è£…cert-managerï¼Œå¹¶ä¸”è¿˜éœ€è¦é…ç½®ï¼Œåœ¨æœ¬å®éªŒé¡¹ç›®å°±ä¸æå¤ªå¤æ‚äº†ã€‚\n2ã€CRD è°ƒè¯•2.1 make manifestsmake manifests/home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/basesls -lh config/crd/bases/æ€»è®¡ 1.1M-rw-rw-r-- 1 king king 1.1M 10æœˆ  5 16:17 apps.kubenode.kingtest.com_myapps.yaml\n\n2.2 make installå‘½ä»¤ï¼š\nmake install\n\n2.2.1 make installé”™è¯¯ï¼šdial tcp 127.0.0.1:8080: connect: connection refusedmake install/home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases/home/king/workspace/king-devops/operator/myapp-operator/bin/kustomize build config/crd | kubectl apply -f -error: error validating &quot;STDIN&quot;: error validating data: failed to download openapi: Get &quot;http://localhost:8080/openapi/v2?timeout=32s&quot;: dial tcp 127.0.0.1:8080: connect: connection refused; if you choose to ignore these errors, turn validation off with --validate=falsemake: *** [Makefile:131ï¼šinstall] é”™è¯¯ 1\n\nè¿™ä¸ªé”™è¯¯å¾ˆè¯¡å¼‚ï¼š dial tcp 127.0.0.1:8080: connect: connection refused\né¦–å…ˆé›†ç¾¤æ˜¯å­˜åœ¨çš„ï¼š\nsudo kind get clustersmyk8s-test\n\nå…¶æ¬¡å·²ç»ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å°†é›†ç¾¤ä¿¡æ¯ï¼Œè®¾ç½®è¿›å»kubectlçš„ä¸Šä¸‹æ–‡é‡Œï¼š\nsudo kubectl cluster-info --context kind-myk8s-test\n\nsudo kubectl cluster-info â€“context kind-myk8s-test\nsudo kubectl get nodesNAME                       STATUS   ROLES           AGE   VERSIONmyk8s-test-control-plane   Ready    control-plane   43h   v1.31.0myk8s-test-worker          Ready    &lt;none&gt;          43h   v1.31.0myk8s-test-worker2         Ready    &lt;none&gt;          43h   v1.31.0\n\nè¿›ä¸€æ­¥æµ‹è¯•ï¼Œåˆ†åˆ«æ‰§è¡Œkubectl versionå’Œkubectl cluster-info dumpéƒ½é‡è§äº†ç±»ä¼¼çš„é”™è¯¯ï¼š\nkubectl versionï¼š\nkubectl versionClient Version: v1.31.1Kustomize Version: v5.4.2The connection to the server localhost:8080 was refused - did you specify the right host or port?\n\nkubectl cluster-info dumpï¼š\nkubectl cluster-info dumpThe connection to the server localhost:8080 was refused - did you specify the right host or port?\n\nä½†æ˜¯å¾ˆæ‚²å‚¬çš„æ˜¯ï¼Œå¿˜è®°å°†kindé›†ç¾¤çš„kubeconfigå¯¼å‡ºåˆ°æœ¬åœ°ï¼Œæˆ‘çš„ç†è§£æ˜¯ï¼Œè™½ç„¶kubectlä¸Šä¸‹æ–‡æ˜¯æœ‰é›†ç¾¤kubeconfigçš„ï¼Œä½†æ˜¯æœ¬åœ°å¹¶æ²¡æœ‰ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯è¿™ä¸ªä¿¡æ¯æ˜¯kubectlè‡ªèº«ä¿å­˜çš„ï¼Œä¸æ˜¯ç›´æ¥ä½¿ç”¨çš„ç³»ç»Ÿä¸Šå­˜å‚¨çš„kubeconfig\nä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œå°†kubeconfigä¿¡æ¯ä¿å­˜åœ¨$HOME/.kube/configå†…ï¼š\nsudo kind export kubeconfig --name=myk8s-test --kubeconfig=$HOME/.kube/config\n\nå†æ‰§è¡Œmake installå‘½ä»¤ï¼Œæœ¬é—®é¢˜å·²ç»è§£å†³ï¼Œä½†æ˜¯æ–°çš„é—®é¢˜å‡ºç°äº†ï¼š\nmake install/home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases/home/king/workspace/king-devops/operator/myapp-operator/bin/kustomize build config/crd | kubectl apply -f -The CustomResourceDefinition &quot;myapps.apps.kubenode.kingtest.com&quot; is invalid: metadata.annotations: Too long: must have at most 262144 bytesmake: *** [Makefile:131ï¼šinstall] é”™è¯¯ 1\n\n2.2.2 make installé”™è¯¯ï¼šmetadata.annotations: Too long: must have at most 262144 byteskubebuilderçš„github issuesä¸­ï¼Œä¿®å¤è¿‡è¿™ä¸ªé—®é¢˜: https://github.com/kubernetes-sigs/kubebuilder/pull/2862/commits/2c5b9edf614444acd43ae5f65af1702a5ed63ed6\nä¿®å¤æ–¹æ³•ï¼šæ‰“å¼€Makefileï¼Œåœ¨ manifests å‘½ä»¤å¤„ï¼Œä¿®æ”¹ crd ä¸º crd:maxDescLen&#x3D;0\nåŸå§‹çš„ï¼š\n.PHONY: manifestsmanifests: controller-gen ## Generate WebhookConfiguration, ClusterRole and CustomResourceDefinition objects.        $(CONTROLLER_GEN) rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases\n\nä¿®å¤åçš„ï¼š\n.PHONY: manifestsmanifests: controller-gen ## Generate WebhookConfiguration, ClusterRole and CustomResourceDefinition objects.        $(CONTROLLER_GEN) rbac:roleName=manager-role crd:maxDescLen=0 webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases\n\né—®é¢˜è§£å†³ï¼š\nmake install/home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen rbac:roleName=manager-role crd:maxDescLen=0 webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases/home/king/workspace/king-devops/operator/myapp-operator/bin/kustomize build config/crd | kubectl apply -f -customresourcedefinition.apiextensions.k8s.io/my\n\n2.2.3 make installéªŒè¯æŸ¥çœ‹å®‰è£…ç»“æœï¼š\nkubectl get crdNAME                                CREATED ATmyapps.apps.kubenode.kingtest.com   2024-10-05T11:56:22Z\nå·²ç»å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å®šä¹‰çš„crdäº†ã€‚\n2.3 make runå‘½ä»¤ï¼š\nexport ENABLE_WEBHOOKS=falsemake run\n\næ‰§è¡Œç»“æœï¼š\nmake run/home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen rbac:roleName=manager-role crd:maxDescLen=0 webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases/home/king/workspace/king-devops/operator/myapp-operator/bin/controller-gen object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;go fmt ./...go vet ./...go run ./cmd/main.go2024-10-05T20:29:02+08:00       INFO    setup   starting manager2024-10-05T20:29:02+08:00       INFO    starting server &#123;&quot;name&quot;: &quot;health probe&quot;, &quot;addr&quot;: &quot;[::]:8081&quot;&#125;2024-10-05T20:29:02+08:00       INFO    Starting EventSource    &#123;&quot;controller&quot;: &quot;myapp&quot;, &quot;controllerGroup&quot;: &quot;apps.kubenode.kingtest.com&quot;, &quot;controllerKind&quot;: &quot;Myapp&quot;, &quot;source&quot;: &quot;kind source: *v1.Myapp&quot;&#125;2024-10-05T20:29:02+08:00       INFO    Starting Controller     &#123;&quot;controller&quot;: &quot;myapp&quot;, &quot;controllerGroup&quot;: &quot;apps.kubenode.kingtest.com&quot;, &quot;controllerKind&quot;: &quot;Myapp&quot;&#125;2024-10-05T20:29:02+08:00       INFO    Starting workers        &#123;&quot;controller&quot;: &quot;myapp&quot;, &quot;controllerGroup&quot;: &quot;apps.kubenode.kingtest.com&quot;, &quot;controllerKind&quot;: &quot;Myapp&quot;, &quot;worker count&quot;: 1&#125;\n\nå·²ç»æˆåŠŸå¯åŠ¨ï¼ï¼ï¼\n2.4 æ‰§è¡Œdebug2.4.1 å¯åŠ¨debugåœ¨ä¸Šé¢æ‰§è¡Œäº†ä»¥ä¸‹æ­¥éª¤ï¼š\nmake manifestsmake installexport ENABLE_WEBHOOKS=falsemake run\næˆ‘ä»¬å…ˆå°†make runè¿è¡Œçš„controlleråœæ­¢ï¼Œç„¶åæ‰“å¼€operatoré¡¹ç›®ï¼Œåœ¨é¡¹ç›®çš„è°ƒè°å‡½æ•°å†…æ‰“ä¸Šæ–­ç‚¹ï¼Œç„¶åç›´æ¥ä»¥debugæ¨¡å¼å¯åŠ¨ã€‚\næ‰“æ–­ç‚¹\nåˆ«å¿˜äº†è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå…³é—­webhook\nä»¥debugæ–¹å¼å¯åŠ¨ï¼š\næ‰§è¡Œç»“æœ\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥applyä¸€ä¸ªèµ„æºï¼Œæµ‹è¯•ä¸€ä¸‹ã€‚\n2.4.2 crdæµ‹è¯•ç¼–å†™ä¸€ä¸ªæµ‹è¯•çš„yamlï¼š\napiVersion: apps.kubenode.kingtest.com/v1kind: Myappmetadata:  name: myapp-samplespec:  foo: &quot;test value&quot;  replicas: 3  selector:    matchLabels:      app: myapp  template:    metadata:      labels:        app: myapp    spec:      containers:      - name: myapp-container        image: nginx:latest        ports:        - containerPort: 80\n\nå°†æµ‹è¯•yamlé€šè¿‡kubectl applyè¿›å»é›†ç¾¤:\nsudo kubectl apply -f myapptest.yamlmyapp.apps.kubenode.kingtest.com/myapp-sample created\n\nç„¶åcontrollerçš„è°ƒè°å‡½æ•°æˆåŠŸæ–­ä½\nå†å‘ä¸‹æ‰§è¡Œä¸€æ­¥\nåœ¨ç»ˆç«¯é‡Œå·²ç»æˆåŠŸæ‰“å°å‡ºæ¥ä»£ç é‡Œçš„æ—¥å¿—ï¼š\né€šè¿‡kubectlæŸ¥çœ‹crdçŠ¶æ€ï¼š\nsudo kubectl get Myapp -A -owideNAMESPACE   NAME           AGEdefault     myapp-sample   14m\nåˆ°æ­¤éƒ½æ˜¯ç¬¦åˆé¢„æœŸçš„ã€‚\n4 æ„å»ºCRDé•œåƒå¹¶éƒ¨ç½²è¿›k8sä¸Šé¢æˆ‘ä»¬æ˜¯åœ¨æœ¬åœ°è¿è¡Œçš„controllerï¼Œé‚£ä¹ˆåœ¨å®é™…ä¸­è¯¥æ€ä¹ˆåŠå‘¢ã€‚\nç­”æ¡ˆæ˜¯å°†controlleræ‰“åŒ…æˆdockeré•œåƒï¼Œç„¶åéƒ¨ç½²è¿›é›†ç¾¤ã€‚\næ„å»ºé•œåƒå¹¶æ¨é€è‡³ä½ çš„é•œåƒä»“åº“\nmake docker-build docker-push IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag\n\nçœ‹ä¸‹makefileçš„å®šä¹‰ï¼š\n.PHONY: docker-builddocker-build: ## Build docker image with the manager.        $(CONTAINER_TOOL) build -t $&#123;IMG&#125; ..PHONY: docker-pushdocker-push: ## Push docker image with the manager.        $(CONTAINER_TOOL) push $&#123;IMG&#125;\n\nè¿™é‡Œå°±æ˜¯ä½¿ç”¨CONTAINER_TOOL(é»˜è®¤ä¸ºdocker)æ„å»ºå¹¶æ¨é€dockeré•œåƒï¼Œå¹¶ä½¿ç”¨IMGå˜é‡æŒ‡å®šé•œåƒåç§°å’Œæ ‡ç­¾æŒ‡å®šé•œåƒå°†controlleréƒ¨ç½²è¿›ä½ çš„é›†ç¾¤\nmake deploy IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag\n\næŸ¥çœ‹makefileå®šä¹‰ï¼š\n.PHONY: deploydeploy: manifests kustomize ## Deploy controller to the K8s cluster specified in ~/.kube/config.        cd config/manager &amp;&amp; $(KUSTOMIZE) edit set image controller=$&#123;IMG&#125;        $(KUSTOMIZE) build config/default | $(KUBECTL) apply -f -\n\n\nå…ˆè¿è¡Œmanifestså’Œkustomizeç›®æ ‡\nä½¿ç”¨kustomizeè®¾ç½®controlleré•œåƒä¸ºIMG\nä½¿ç”¨kustomizeæ„å»ºconfig&#x2F;defaultç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶åº”ç”¨åˆ°é›†ç¾¤\n\n5 åˆ é™¤controlleréƒ¨ç½²å’Œå¸è½½CRDåˆ é™¤controlleréƒ¨ç½²ï¼š\nmake undeploy\n\næŸ¥çœ‹makefileå®šä¹‰ï¼š\n.PHONY: undeployundeploy: kustomize ## Undeploy controller from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.        $(KUSTOMIZE) build config/default | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -\n\nä½¿ç”¨kustomize æ„å»ºconfig&#x2F;defaultç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶ä»é›†ç¾¤ä¸­åˆ é™¤ã€‚å¯ä»¥é€šè¿‡ignore-not-found&#x3D;trueå¿½ç•¥èµ„æºæœªæ‰¾åˆ°çš„é”™è¯¯\nä»é›†ç¾¤å¸è½½CRDï¼š\nmake uninstall\n\næŸ¥çœ‹makefileå®šä¹‰ï¼š\n.PHONY: uninstalluninstall: manifests kustomize ## Uninstall CRDs from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.        $(KUSTOMIZE) build config/crd | $(KUBECTL) delete --ignore-not-found=$(ignore-not-found) -f -\n\nå…ˆè¿è¡Œmanifestså’Œkustomizeç›®æ ‡\nä½¿ç”¨kustomize æ„å»ºconfig&#x2F;crdç›®å½•ä¸­çš„èµ„æºï¼Œå¹¶ä½¿ç”¨kubectlå°†å…¶ä»é›†ç¾¤ä¸­åˆ é™¤ï¼Œå¯ä»¥é€šè¿‡ignore-not-found&#x3D;trueå¿½ç•¥èµ„æºæœªæ‰¾åˆ°çš„é”™è¯¯\n\n6 å…¶ä»–è¿™æ˜¯åœ¨æˆ‘ä»¬æœ¬åœ°è¿è¡Œçš„controllerï¼Œæˆ‘åœ¨æœ€åˆä¸€ç›´æƒ³ä¸é€šæ˜¯æ€ä¹ˆè¿æ¥çš„é›†ç¾¤çš„ï¼ŒçŸ¥é“æƒ³èµ·äº†æœ€åˆçš„client-goçš„ä½¿ç”¨ã€‚\nåœ¨çœ‹æœ¬æ–‡çš„åŒå­¦ï¼Œè‚¯å®šæ˜¯å¬è¯´è¿‡ï¼Œç”šè‡³ä½¿ç”¨è¿‡client-goçš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨client-goå»å®ç°ä¸€äº›å°å·¥å…·ï¼Œæ¯”å¦‚è¯´æŸä¸ªnamespaceä¸‹podçš„æŸ¥è¯¢ï¼Œç”šè‡³å¯ä»¥è·å–nodeçš„åˆ—è¡¨ï¼Œpodçš„å…¨éƒ¨ä¿¡æ¯ç­‰ç­‰ï¼Œåªè¦æ˜¯kubectlå¯ä»¥åšçš„ï¼Œéƒ½å¯ä»¥é€šè¿‡client-goæ¥å®ç°ï¼Œå¹¶ä¸”å¯ä»¥åšæ›´å¤æ‚çš„åœºæ™¯ã€‚\næˆ‘ä»¬æ˜¯å¯ä»¥åœ¨å·¥å…·é‡ŒæŒ‡å®škubeconfigçš„è·¯å¾„çš„ï¼Œè®©client-goå»è¯»å–ï¼Œå¹¶æ¸²æŸ“å¯¹åº”çš„clientï¼Œç„¶åå’Œå¯¹åº”é›†ç¾¤çš„apiserveråšäº¤äº’ã€‚\nçŸ¥é“äº†è¿™ç‚¹ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œoperatoræ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Œoperatorå…¶å®æ˜¯ä½¿ç”¨çš„controller-runtimeåº“ï¼Œä»–å’Œclient-goæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Œä»–æ˜¯client-goä»¥åŠå…¶ä»–åº“çš„æ›´ä¸Šä¸€å±‚å°è£…ã€‚\næ‰€ä»¥è™½ç„¶æ²¡å…·ä½“çœ‹ï¼Œä½†æ˜¯controller-runtimeè‚¯å®šæ˜¯é»˜è®¤è¯»å–çš„$HOME&#x2F;.kube&#x2F;configæ–‡ä»¶çš„kubeconfigï¼Œè‡³äºå¯ä¸å¯ä»¥æŒ‡å®šå…¶ä»–çš„kubeconfigï¼Œç†è®ºä¸Šæ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºå°±æ˜¯æŒ‡å®šä¸‹kubeconfigçš„è·¯å¾„ï¼Œç„¶åå»è¯»å–æ¸²æŸ“clientï¼Œè¿™é‡Œå’Œè‡ªå·±ç›´æ¥ä½¿ç”¨client-goå»å®ç°æ˜¯ä¸€æ ·çš„é€»è¾‘ã€‚\nä½†æ˜¯ï¼Œcontroller-runtimeç©¶ç«Ÿæ”¯ä¸æ”¯æŒï¼Œè¿˜éœ€è¦è‡ªå·±å»æ‰¾ä¸€ä¸‹æºç æˆ–è€…èµ„æ–™ï¼Œå› ä¸ºæœ¬åœ°è¿è¡Œcontrollerè¿™æœ¬èº«è‚¯å®šæ˜¯ä¸å»ºè®®çš„ï¼Œæ‰€ä»¥ä¸æ”¯æŒä¹Ÿæ˜¯è¯´å¾—è¿‡å»çš„ã€‚\n","categories":["kubernetes/operator"],"tags":["kubernetes","operator"]}]